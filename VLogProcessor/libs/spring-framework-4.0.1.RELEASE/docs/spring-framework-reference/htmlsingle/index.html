<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Framework Reference Documentation</title><link rel="stylesheet" href="css/manual-singlepage.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book" title="Spring Framework Reference Documentation"><div class="titlepage"><div><div><h1 class="title"><a name="d4e1"></a>Spring Framework Reference Documentation</h1></div><div><div class="authorgroup"><h2>Authors</h2>
<span class="author"><span class="firstname">Rod</span> <span class="surname">Johnson</span></span>

, <span class="author"><span class="firstname">Juergen</span> <span class="surname">Hoeller</span></span>

, <span class="author"><span class="firstname">Keith</span> <span class="surname">Donald</span></span>

, <span class="author"><span class="firstname">Colin</span> <span class="surname">Sampaleanu</span></span>

, <span class="author"><span class="firstname">Rob</span> <span class="surname">Harrop</span></span>

, <span class="author"><span class="firstname">Thomas</span> <span class="surname">Risberg</span></span>

, <span class="author"><span class="firstname">Alef</span> <span class="surname">Arendsen</span></span>

, <span class="author"><span class="firstname">Darren</span> <span class="surname">Davison</span></span>

, <span class="author"><span class="firstname">Dmitriy</span> <span class="surname">Kopylenko</span></span>

, <span class="author"><span class="firstname">Mark</span> <span class="surname">Pollack</span></span>

, <span class="author"><span class="firstname">Thierry</span> <span class="surname">Templier</span></span>

, <span class="author"><span class="firstname">Erwin</span> <span class="surname">Vervaet</span></span>

, <span class="author"><span class="firstname">Portia</span> <span class="surname">Tung</span></span>

, <span class="author"><span class="firstname">Ben</span> <span class="surname">Hale</span></span>

, <span class="author"><span class="firstname">Adrian</span> <span class="surname">Colyer</span></span>

, <span class="author"><span class="firstname">John</span> <span class="surname">Lewis</span></span>

, <span class="author"><span class="firstname">Costin</span> <span class="surname">Leau</span></span>

, <span class="author"><span class="firstname">Mark</span> <span class="surname">Fisher</span></span>

, <span class="author"><span class="firstname">Sam</span> <span class="surname">Brannen</span></span>

, <span class="author"><span class="firstname">Ramnivas</span> <span class="surname">Laddad</span></span>

, <span class="author"><span class="firstname">Arjen</span> <span class="surname">Poutsma</span></span>

, <span class="author"><span class="firstname">Chris</span> <span class="surname">Beams</span></span>

, <span class="author"><span class="firstname">Tareq</span> <span class="surname">Abedrabbo</span></span>

, <span class="author"><span class="firstname">Andy</span> <span class="surname">Clement</span></span>

, <span class="author"><span class="firstname">Dave</span> <span class="surname">Syer</span></span>

, <span class="author"><span class="firstname">Oliver</span> <span class="surname">Gierke</span></span>

, <span class="author"><span class="firstname">Rossen</span> <span class="surname">Stoyanchev</span></span>

, <span class="author"><span class="firstname">Phillip</span> <span class="surname">Webb</span></span>

, <span class="author"><span class="firstname">Rob</span> <span class="surname">Winch</span></span>

, <span class="author"><span class="firstname">Brian</span> <span class="surname">Clozel</span></span>
</div></div><div><p class="releaseinfo">4.0.1.RELEASE</p></div><div><p class="copyright">Copyright &copy; 2004-2013 </p></div><div><div class="legalnotice" title="Legal Notice"><a name="d4e134"></a>
	<p>Copies of this document may be made for your own use and for distribution to
	others, provided that you do not charge any fee for such copies and further provided
	that each copy contains this Copyright Notice, whether distributed in print or
	electronically.</p>
</div></div><div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="part"><a href="#spring-introduction">I. Overview of Spring Framework</a></span></dt><dd><dl><dt><span class="chapter"><a href="#overview-getting-started-with-spring">1. Getting Started With Spring</a></span></dt><dt><span class="chapter"><a href="#overview">2. Introduction to Spring Framework</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-dependency-injection">2.1. Dependency Injection and Inversion of Control</a></span></dt><dt><span class="section"><a href="#overview-modules">2.2. Modules</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-core-container">2.2.1. Core Container</a></span></dt><dt><span class="section"><a href="#overview-data-access">2.2.2. Data Access/Integration</a></span></dt><dt><span class="section"><a href="#overview-web">2.2.3. Web</a></span></dt><dt><span class="section"><a href="#overview-aop-instrumentation">2.2.4. AOP and Instrumentation</a></span></dt><dt><span class="section"><a href="#overview-testing">2.2.5. Test</a></span></dt></dl></dd><dt><span class="section"><a href="#overview-usagescenarios">2.3. Usage scenarios</a></span></dt><dd><dl><dt><span class="section"><a href="#dependency-management">2.3.1. Dependency Management and Naming Conventions</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-spring-dependencies">Spring Dependencies and Depending on Spring</a></span></dt><dt><span class="section"><a href="#overview-maven-dependency-management">Maven Dependency Management</a></span></dt><dt><span class="section"><a href="#overview-maven-bom">Maven "Bill Of Materials" Dependency</a></span></dt><dt><span class="section"><a href="#overview-gradle-dependency-management">Gradle Dependency Management</a></span></dt><dt><span class="section"><a href="#overview-ivy-dependency-management">Ivy Dependency Management</a></span></dt><dt><span class="section"><a href="#overview-distribution-zip">Distribution Zip Files</a></span></dt></dl></dd><dt><span class="section"><a href="#overview-logging">2.3.2. Logging</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-not-using-commons-logging">Not Using Commons Logging</a></span></dt><dt><span class="section"><a href="#overview-logging-slf4j">Using SLF4J</a></span></dt><dt><span class="section"><a href="#overview-logging-log4j">Using Log4J</a></span></dt></dl></dd></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#spring-whats-new">II. What&#8217;s New in Spring Framework 4.x</a></span></dt><dd><dl><dt><span class="chapter"><a href="#new-in-4.0">3. New Features and Enhancements in Spring Framework 4.0</a></span></dt><dd><dl><dt><span class="section"><a href="#_improved_getting_started_experience">3.1. Improved Getting Started Experience</a></span></dt><dt><span class="section"><a href="#_removed_deprecated_packages_and_methods">3.2. Removed Deprecated Packages and Methods</a></span></dt><dt><span class="section"><a href="#_java_8_as_well_as_6_and_7">3.3. Java 8 (as well as 6 and 7)</a></span></dt><dt><span class="section"><a href="#_java_ee_6_and_7">3.4. Java EE 6 and 7</a></span></dt><dt><span class="section"><a href="#_groovy_bean_definition_dsl">3.5. Groovy Bean Definition DSL</a></span></dt><dt><span class="section"><a href="#_core_container_improvements">3.6. Core Container Improvements</a></span></dt><dt><span class="section"><a href="#_general_web_improvements">3.7. General Web Improvements</a></span></dt><dt><span class="section"><a href="#_websocket_sockjs_and_stomp_messaging">3.8. WebSocket, SockJS, and STOMP Messaging</a></span></dt><dt><span class="section"><a href="#_testing_improvements">3.9. Testing Improvements</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-core">III. Core Technologies</a></span></dt><dd><dl><dt><span class="chapter"><a href="#beans">4. The IoC container</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-introduction">4.1. Introduction to the Spring IoC container and beans</a></span></dt><dt><span class="section"><a href="#beans-basics">4.2. Container overview</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-metadata">4.2.1. Configuration metadata</a></span></dt><dt><span class="section"><a href="#beans-factory-instantiation">4.2.2. Instantiating a container</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-xml-import">Composing XML-based configuration metadata</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-client">4.2.3. Using the container</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-definition">4.3. Bean overview</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-beanname">4.3.1. Naming beans</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-beanname-alias">Aliasing a bean outside the bean definition</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-class">4.3.2. Instantiating beans</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-class-ctor">Instantiation with a constructor</a></span></dt><dt><span class="section"><a href="#beans-factory-class-static-factory-method">Instantiation with a static factory method</a></span></dt><dt><span class="section"><a href="#beans-factory-class-instance-factory-method">Instantiation using an instance factory method</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#beans-dependencies">4.4. Dependencies</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-collaborators">4.4.1. Dependency injection</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-constructor-injection">Constructor-based dependency injection</a></span></dt><dt><span class="section"><a href="#beans-setter-injection">Setter-based dependency injection</a></span></dt><dt><span class="section"><a href="#beans-dependency-resolution">Dependency resolution process</a></span></dt><dt><span class="section"><a href="#beans-some-examples">Examples of dependency injection</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-properties-detailed">4.4.2. Dependencies and configuration in detail</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-value-element">Straight values (primitives, Strings, and so on)</a></span></dt><dt><span class="section"><a href="#beans-ref-element">References to other beans (collaborators)</a></span></dt><dt><span class="section"><a href="#beans-inner-beans">Inner beans</a></span></dt><dt><span class="section"><a href="#beans-collection-elements">Collections</a></span></dt><dt><span class="section"><a href="#beans-null-element">Null and empty string values</a></span></dt><dt><span class="section"><a href="#beans-p-namespace">XML shortcut with the p-namespace</a></span></dt><dt><span class="section"><a href="#beans-c-namespace">XML shortcut with the c-namespace</a></span></dt><dt><span class="section"><a href="#beans-compound-property-names">Compound property names</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-dependson">4.4.3. Using depends-on</a></span></dt><dt><span class="section"><a href="#beans-factory-lazy-init">4.4.4. Lazy-initialized beans</a></span></dt><dt><span class="section"><a href="#beans-factory-autowire">4.4.5. Autowiring collaborators</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-autowired-exceptions">Limitations and disadvantages of autowiring</a></span></dt><dt><span class="section"><a href="#beans-factory-autowire-candidate">Excluding a bean from autowiring</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-method-injection">4.4.6. Method injection</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-lookup-method-injection">Lookup method injection</a></span></dt><dt><span class="section"><a href="#beans-factory-arbitrary-method-replacement">Arbitrary method replacement</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#beans-factory-scopes">4.5. Bean scopes</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-scopes-singleton">4.5.1. The singleton scope</a></span></dt><dt><span class="section"><a href="#beans-factory-scopes-prototype">4.5.2. The prototype scope</a></span></dt><dt><span class="section"><a href="#beans-factory-scopes-sing-prot-interaction">4.5.3. Singleton beans with prototype-bean dependencies</a></span></dt><dt><span class="section"><a href="#beans-factory-scopes-other">4.5.4. Request, session, and global session scopes</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-scopes-other-web-configuration">Initial web configuration</a></span></dt><dt><span class="section"><a href="#beans-factory-scopes-request">Request scope</a></span></dt><dt><span class="section"><a href="#beans-factory-scopes-session">Session scope</a></span></dt><dt><span class="section"><a href="#beans-factory-scopes-global-session">Global session scope</a></span></dt><dt><span class="section"><a href="#beans-factory-scopes-other-injection">Scoped beans as dependencies</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-scopes-custom">4.5.5. Custom scopes</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-scopes-custom-creating">Creating a custom scope</a></span></dt><dt><span class="section"><a href="#beans-factory-scopes-custom-using">Using a custom scope</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#beans-factory-nature">4.6. Customizing the nature of a bean</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-lifecycle">4.6.1. Lifecycle callbacks</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-lifecycle-initializingbean">Initialization callbacks</a></span></dt><dt><span class="section"><a href="#beans-factory-lifecycle-disposablebean">Destruction callbacks</a></span></dt><dt><span class="section"><a href="#beans-factory-lifecycle-default-init-destroy-methods">Default initialization and destroy methods</a></span></dt><dt><span class="section"><a href="#beans-factory-lifecycle-combined-effects">Combining lifecycle mechanisms</a></span></dt><dt><span class="section"><a href="#beans-factory-lifecycle-processor">Startup and shutdown callbacks</a></span></dt><dt><span class="section"><a href="#beans-factory-shutdown">Shutting down the Spring IoC container gracefully in non-web applications</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-aware">4.6.2. ApplicationContextAware and BeanNameAware</a></span></dt><dt><span class="section"><a href="#aware-list">4.6.3. Other Aware interfaces</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-child-bean-definitions">4.7. Bean definition inheritance</a></span></dt><dt><span class="section"><a href="#beans-factory-extension">4.8. Container Extension Points</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-extension-bpp">4.8.1. Customizing beans using a BeanPostProcessor</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-extension-bpp-examples-hw">Example: Hello World, BeanPostProcessor-style</a></span></dt><dt><span class="section"><a href="#beans-factory-extension-bpp-examples-rabpp">Example: The RequiredAnnotationBeanPostProcessor</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-extension-factory-postprocessors">4.8.2. Customizing configuration metadata with a BeanFactoryPostProcessor</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-factory-placeholderconfigurer">Example: the Class name substitution PropertyPlaceholderConfigurer</a></span></dt><dt><span class="section"><a href="#beans-factory-overrideconfigurer">Example: the PropertyOverrideConfigurer</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-factory-extension-factorybean">4.8.3. Customizing instantiation logic with a FactoryBean</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-annotation-config">4.9. Annotation-based container configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-required-annotation">4.9.1. @Required</a></span></dt><dt><span class="section"><a href="#beans-autowired-annotation">4.9.2. @Autowired</a></span></dt><dt><span class="section"><a href="#beans-autowired-annotation-qualifiers">4.9.3. Fine-tuning annotation-based autowiring with qualifiers</a></span></dt><dt><span class="section"><a href="#beans-generics-as-qualifiers">4.9.4. Using generics as autowiring qualifiers</a></span></dt><dt><span class="section"><a href="#beans-custom-autowire-configurer">4.9.5. CustomAutowireConfigurer</a></span></dt><dt><span class="section"><a href="#beans-resource-annotation">4.9.6. @Resource</a></span></dt><dt><span class="section"><a href="#beans-postconstruct-and-predestroy-annotations">4.9.7. @PostConstruct and @PreDestroy</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-classpath-scanning">4.10. Classpath scanning and managed components</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-stereotype-annotations">4.10.1. @Component and further stereotype annotations</a></span></dt><dt><span class="section"><a href="#beans-meta-annotations">4.10.2. Meta-annotations</a></span></dt><dt><span class="section"><a href="#beans-scanning-autodetection">4.10.3. Automatically detecting classes and registering bean definitions</a></span></dt><dt><span class="section"><a href="#beans-scanning-filters">4.10.4. Using filters to customize scanning</a></span></dt><dt><span class="section"><a href="#beans-factorybeans-annotations">4.10.5. Defining bean metadata within components</a></span></dt><dt><span class="section"><a href="#beans-scanning-name-generator">4.10.6. Naming autodetected components</a></span></dt><dt><span class="section"><a href="#beans-scanning-scope-resolver">4.10.7. Providing a scope for autodetected components</a></span></dt><dt><span class="section"><a href="#beans-scanning-qualifiers">4.10.8. Providing qualifier metadata with annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-standard-annotations">4.11. Using JSR 330 Standard Annotations</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-inject-named">4.11.1. Dependency Injection with @Inject and @Named</a></span></dt><dt><span class="section"><a href="#beans-named">4.11.2. @Named: a standard equivalent to the @Component annotation</a></span></dt><dt><span class="section"><a href="#beans-standard-annotations-limitations">4.11.3. Limitations of the standard approach</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-java">4.12. Java-based container configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-java-basic-concepts">4.12.1. Basic concepts: @Bean and @Configuration</a></span></dt><dt><span class="section"><a href="#beans-java-instantiating-container">4.12.2. Instantiating the Spring container using AnnotationConfigApplicationContext</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-java-instantiating-container-contstructor">Simple construction</a></span></dt><dt><span class="section"><a href="#beans-java-instantiating-container-register">Building the container programmatically using register(Class&lt;?&gt;&#8230;)</a></span></dt><dt><span class="section"><a href="#beans-java-instantiating-container-scan">Enabling component scanning with scan(String&#8230;)</a></span></dt><dt><span class="section"><a href="#beans-java-instantiating-container-web">Support for web applications with AnnotationConfigWebApplicationContext</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-java-bean-annotation">4.12.3. Using the @Bean annotation</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-java-declaring-a-bean">Declaring a bean</a></span></dt><dt><span class="section"><a href="#beans-java-lifecycle-callbacks">Receiving lifecycle callbacks</a></span></dt><dt><span class="section"><a href="#beans-java-specifying-bean-scope">Specifying bean scope</a></span></dt><dt><span class="section"><a href="#beans-java-customizing-bean-naming">Customizing bean naming</a></span></dt><dt><span class="section"><a href="#beans-java-bean-aliasing">Bean aliasing</a></span></dt><dt><span class="section"><a href="#beans-java-bean-description">Bean description</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-java-configuration-annotation">4.12.4. Using the @Configuration annotation</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-java-injecting-dependencies">Injecting inter-bean dependencies</a></span></dt><dt><span class="section"><a href="#beans-java-method-injection">Lookup method injection</a></span></dt><dt><span class="section"><a href="#beans-java-further-information-java-config">Further information about how Java-based configuration works internally</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-java-composing-configuration-classes">4.12.5. Composing Java-based configurations</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-java-using-import">Using the @Import annotation</a></span></dt><dt><span class="section"><a href="#beans-java-conditional">Conditionally including @Configuration classes or @Beans</a></span></dt><dt><span class="section"><a href="#beans-java-combining">Combining Java and XML configuration</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#beans-definition-profiles">4.13. Bean definition profiles and environment abstraction</a></span></dt><dt><span class="section"><a href="#beans-property-source-abstraction">4.14. PropertySource Abstraction</a></span></dt><dt><span class="section"><a href="#context-load-time-weaver">4.15. Registering a LoadTimeWeaver</a></span></dt><dt><span class="section"><a href="#context-introduction">4.16. Additional Capabilities of the ApplicationContext</a></span></dt><dd><dl><dt><span class="section"><a href="#context-functionality-messagesource">4.16.1. Internationalization using MessageSource</a></span></dt><dt><span class="section"><a href="#context-functionality-events">4.16.2. Standard and Custom Events</a></span></dt><dt><span class="section"><a href="#context-functionality-resources">4.16.3. Convenient access to low-level resources</a></span></dt><dt><span class="section"><a href="#context-create">4.16.4. Convenient ApplicationContext instantiation for web applications</a></span></dt><dt><span class="section"><a href="#context-deploy-rar">4.16.5. Deploying a Spring ApplicationContext as a J2EE RAR file</a></span></dt></dl></dd><dt><span class="section"><a href="#beans-beanfactory">4.17. The BeanFactory</a></span></dt><dd><dl><dt><span class="section"><a href="#context-introduction-ctx-vs-beanfactory">4.17.1. BeanFactory or ApplicationContext?</a></span></dt><dt><span class="section"><a href="#beans-servicelocator">4.17.2. Glue code and the evil singleton</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#resources">5. Resources</a></span></dt><dd><dl><dt><span class="section"><a href="#resources-introduction">5.1. Introduction</a></span></dt><dt><span class="section"><a href="#resources-resource">5.2. The Resource interface</a></span></dt><dt><span class="section"><a href="#resources-implementations">5.3. Built-in Resource implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#resources-implementations-urlresource">5.3.1. UrlResource</a></span></dt><dt><span class="section"><a href="#resources-implementations-classpathresource">5.3.2. ClassPathResource</a></span></dt><dt><span class="section"><a href="#resources-implementations-filesystemresource">5.3.3. FileSystemResource</a></span></dt><dt><span class="section"><a href="#resources-implementations-servletcontextresource">5.3.4. ServletContextResource</a></span></dt><dt><span class="section"><a href="#resources-implementations-inputstreamresource">5.3.5. InputStreamResource</a></span></dt><dt><span class="section"><a href="#resources-implementations-bytearrayresource">5.3.6. ByteArrayResource</a></span></dt></dl></dd><dt><span class="section"><a href="#resources-resourceloader">5.4. The ResourceLoader</a></span></dt><dt><span class="section"><a href="#resources-resourceloaderaware">5.5. The ResourceLoaderAware interface</a></span></dt><dt><span class="section"><a href="#resources-as-dependencies">5.6. Resources as dependencies</a></span></dt><dt><span class="section"><a href="#resources-app-ctx">5.7. Application contexts and Resource paths</a></span></dt><dd><dl><dt><span class="section"><a href="#resources-app-ctx-construction">5.7.1. Constructing application contexts</a></span></dt><dd><dl><dt><span class="section"><a href="#resources-app-ctx-classpathxml">Constructing ClassPathXmlApplicationContext instances - shortcuts</a></span></dt></dl></dd><dt><span class="section"><a href="#resources-app-ctx-wildcards-in-resource-paths">5.7.2. Wildcards in application context constructor resource paths</a></span></dt><dd><dl><dt><span class="section"><a href="#resources-app-ctx-ant-patterns-in-paths">Ant-style Patterns</a></span></dt><dt><span class="section"><a href="#resources-classpath-wildcards">The Classpath*: portability classpath*: prefix</a></span></dt><dt><span class="section"><a href="#resources-wildcards-in-path-other-stuff">Other notes relating to wildcards</a></span></dt></dl></dd><dt><span class="section"><a href="#resources-filesystemresource-caveats">5.7.3. FileSystemResource caveats</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#validation">6. Validation, Data Binding, and Type Conversion</a></span></dt><dd><dl><dt><span class="section"><a href="#validation-introduction">6.1. Introduction</a></span></dt><dt><span class="section"><a href="#validator">6.2. Validation using Spring&#8217;s Validator interface</a></span></dt><dt><span class="section"><a href="#validation-conversion">6.3. Resolving codes to error messages</a></span></dt><dt><span class="section"><a href="#beans-beans">6.4. Bean manipulation and the BeanWrapper</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-beans-conventions">6.4.1. Setting and getting basic and nested properties</a></span></dt><dt><span class="section"><a href="#beans-beans-conversion">6.4.2. Built-in PropertyEditor implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#beans-beans-conversion-customeditor-registration">Registering additional custom PropertyEditors</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#core-convert">6.5. Spring Type Conversion</a></span></dt><dd><dl><dt><span class="section"><a href="#core-convert-Converter-API">6.5.1. Converter SPI</a></span></dt><dt><span class="section"><a href="#core-convert-ConverterFactory-SPI">6.5.2. ConverterFactory</a></span></dt><dt><span class="section"><a href="#core-convert-GenericConverter-SPI">6.5.3. GenericConverter</a></span></dt><dd><dl><dt><span class="section"><a href="#core-convert-ConditionalGenericConverter-SPI">ConditionalGenericConverter</a></span></dt></dl></dd><dt><span class="section"><a href="#core-convert-ConversionService-API">6.5.4. ConversionService API</a></span></dt><dt><span class="section"><a href="#core-convert-Spring-config">6.5.5. Configuring a ConversionService</a></span></dt><dt><span class="section"><a href="#core-convert-programmatic-usage">6.5.6. Using a ConversionService programmatically</a></span></dt></dl></dd><dt><span class="section"><a href="#format">6.6. Spring Field Formatting</a></span></dt><dd><dl><dt><span class="section"><a href="#format-Formatter-SPI">6.6.1. Formatter SPI</a></span></dt><dt><span class="section"><a href="#format-CustomFormatAnnotations">6.6.2. Annotation-driven Formatting</a></span></dt><dd><dl><dt><span class="section"><a href="#format-annotations-api">Format Annotation API</a></span></dt></dl></dd><dt><span class="section"><a href="#format-FormatterRegistry-SPI">6.6.3. FormatterRegistry SPI</a></span></dt><dt><span class="section"><a href="#format-FormatterRegistrar-SPI">6.6.4. FormatterRegistrar SPI</a></span></dt><dt><span class="section"><a href="#format-configuring-formatting-mvc">6.6.5. Configuring Formatting in Spring MVC</a></span></dt></dl></dd><dt><span class="section"><a href="#format-configuring-formatting-globaldatetimeformat">6.7. Configuring a global date &amp; time format</a></span></dt><dt><span class="section"><a href="#validation-beanvalidation">6.8. Spring Validation</a></span></dt><dd><dl><dt><span class="section"><a href="#validation-beanvalidation-overview">6.8.1. Overview of the JSR-303 Bean Validation API</a></span></dt><dt><span class="section"><a href="#validation-beanvalidation-spring">6.8.2. Configuring a Bean Validation Provider</a></span></dt><dd><dl><dt><span class="section"><a href="#validation-beanvalidation-spring-inject">Injecting a Validator</a></span></dt><dt><span class="section"><a href="#validation-beanvalidation-spring-constraints">Configuring Custom Constraints</a></span></dt><dt><span class="section"><a href="#validation-beanvalidation-spring-other">Additional Configuration Options</a></span></dt></dl></dd><dt><span class="section"><a href="#validation-binder">6.8.3. Configuring a DataBinder</a></span></dt><dt><span class="section"><a href="#validation-mvc">6.8.4. Spring MVC 3 Validation</a></span></dt><dd><dl><dt><span class="section"><a href="#validation-mvc-triggering">Triggering @Controller Input Validation</a></span></dt><dt><span class="section"><a href="#validation-mvc-configuring">Configuring a Validator for use by Spring MVC</a></span></dt><dt><span class="section"><a href="#validation-mvc-jsr303">Configuring a JSR-303/JSR-349 Validator for use by Spring MVC</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="#expressions">7. Spring Expression Language (SpEL)</a></span></dt><dd><dl><dt><span class="section"><a href="#expressions-intro">7.1. Introduction</a></span></dt><dt><span class="section"><a href="#expressions-features">7.2. Feature Overview</a></span></dt><dt><span class="section"><a href="#expressions-evaluation">7.3. Expression Evaluation using Spring&#8217;s Expression Interface</a></span></dt><dd><dl><dt><span class="section"><a href="#expressions-evaluation-context">7.3.1. The EvaluationContext interface</a></span></dt><dd><dl><dt><span class="section"><a href="#expressions-type-conversion">Type Conversion</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#expressions-beandef">7.4. Expression support for defining bean definitions</a></span></dt><dd><dl><dt><span class="section"><a href="#expressions-beandef-xml-based">7.4.1. XML based configuration</a></span></dt><dt><span class="section"><a href="#expressions-beandef-annotation-based">7.4.2. Annotation-based configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#expressions-language-ref">7.5. Language Reference</a></span></dt><dd><dl><dt><span class="section"><a href="#expressions-ref-literal">7.5.1. Literal expressions</a></span></dt><dt><span class="section"><a href="#expressions-properties-arrays">7.5.2. Properties, Arrays, Lists, Maps, Indexers</a></span></dt><dt><span class="section"><a href="#expressions-inline-lists">7.5.3. Inline lists</a></span></dt><dt><span class="section"><a href="#expressions-array-construction">7.5.4. Array construction</a></span></dt><dt><span class="section"><a href="#expressions-methods">7.5.5. Methods</a></span></dt><dt><span class="section"><a href="#expressions-operators">7.5.6. Operators</a></span></dt><dd><dl><dt><span class="section"><a href="#expressions-operators-relational">Relational operators</a></span></dt><dt><span class="section"><a href="#expressions-operators-logical">Logical operators</a></span></dt><dt><span class="section"><a href="#expressions-operators-mathematical">Mathematical operators</a></span></dt></dl></dd><dt><span class="section"><a href="#expressions-assignment">7.5.7. Assignment</a></span></dt><dt><span class="section"><a href="#expressions-types">7.5.8. Types</a></span></dt><dt><span class="section"><a href="#expressions-constructors">7.5.9. Constructors</a></span></dt><dt><span class="section"><a href="#expressions-ref-variables">7.5.10. Variables</a></span></dt><dd><dl><dt><span class="section"><a href="#expressions-this-root">The #this and #root variables</a></span></dt></dl></dd><dt><span class="section"><a href="#expressions-ref-functions">7.5.11. Functions</a></span></dt><dt><span class="section"><a href="#expressions-bean-references">7.5.12. Bean references</a></span></dt><dt><span class="section"><a href="#expressions-operator-ternary">7.5.13. Ternary Operator (If-Then-Else)</a></span></dt><dt><span class="section"><a href="#expressions-operator-elvis">7.5.14. The Elvis Operator</a></span></dt><dt><span class="section"><a href="#expressions-operator-safe-navigation">7.5.15. Safe Navigation operator</a></span></dt><dt><span class="section"><a href="#expressions-collection-selection">7.5.16. Collection Selection</a></span></dt><dt><span class="section"><a href="#expressions-collection-projection">7.5.17. Collection Projection</a></span></dt><dt><span class="section"><a href="#expressions-templating">7.5.18. Expression templating</a></span></dt></dl></dd><dt><span class="section"><a href="#expressions-example-classes">7.6. Classes used in the examples</a></span></dt></dl></dd><dt><span class="chapter"><a href="#aop">8. Aspect Oriented Programming with Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-introduction">8.1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-introduction-defn">8.1.1. AOP concepts</a></span></dt><dt><span class="section"><a href="#aop-introduction-spring-defn">8.1.2. Spring AOP capabilities and goals</a></span></dt><dt><span class="section"><a href="#aop-introduction-proxies">8.1.3. AOP Proxies</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-ataspectj">8.2. @AspectJ support</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-aspectj-support">8.2.1. Enabling @AspectJ Support</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-enable-aspectj-java">Enabling @AspectJ Support with Java configuration</a></span></dt><dt><span class="section"><a href="#aop-enable-aspectj-xml">Enabling @AspectJ Support with XML configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-at-aspectj">8.2.2. Declaring an aspect</a></span></dt><dt><span class="section"><a href="#aop-pointcuts">8.2.3. Declaring a pointcut</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-pointcuts-designators">Supported Pointcut Designators</a></span></dt><dt><span class="section"><a href="#aop-pointcuts-combining">Combining pointcut expressions</a></span></dt><dt><span class="section"><a href="#aop-common-pointcuts">Sharing common pointcut definitions</a></span></dt><dt><span class="section"><a href="#aop-pointcuts-examples">Examples</a></span></dt><dt><span class="section"><a href="#writing-good-pointcuts">Writing good pointcuts</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-advice">8.2.4. Declaring advice</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-advice-before">Before advice</a></span></dt><dt><span class="section"><a href="#aop-advice-after-returning">After returning advice</a></span></dt><dt><span class="section"><a href="#aop-advice-after-throwing">After throwing advice</a></span></dt><dt><span class="section"><a href="#aop-advice-after-finally">After (finally) advice</a></span></dt><dt><span class="section"><a href="#aop-ataspectj-around-advice">Around advice</a></span></dt><dt><span class="section"><a href="#aop-ataspectj-advice-params">Advice parameters</a></span></dt><dt><span class="section"><a href="#aop-ataspectj-advice-ordering">Advice ordering</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-introductions">8.2.5. Introductions</a></span></dt><dt><span class="section"><a href="#aop-instantiation-models">8.2.6. Aspect instantiation models</a></span></dt><dt><span class="section"><a href="#aop-ataspectj-example">8.2.7. Example</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-schema">8.3. Schema-based AOP support</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-schema-declaring-an-aspect">8.3.1. Declaring an aspect</a></span></dt><dt><span class="section"><a href="#aop-schema-pointcuts">8.3.2. Declaring a pointcut</a></span></dt><dt><span class="section"><a href="#aop-schema-advice">8.3.3. Declaring advice</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-schema-advice-before">Before advice</a></span></dt><dt><span class="section"><a href="#aop-schema-advice-after-returning">After returning advice</a></span></dt><dt><span class="section"><a href="#aop-schema-advice-after-throwing">After throwing advice</a></span></dt><dt><span class="section"><a href="#aop-schema-advice-after-finally">After (finally) advice</a></span></dt><dt><span class="section"><a href="#aop-schema-advice-around">Around advice</a></span></dt><dt><span class="section"><a href="#aop-schema-params">Advice parameters</a></span></dt><dt><span class="section"><a href="#aop-ordering">Advice ordering</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-schema-introductions">8.3.4. Introductions</a></span></dt><dt><span class="section"><a href="#aop-schema-instatiation-models">8.3.5. Aspect instantiation models</a></span></dt><dt><span class="section"><a href="#aop-schema-advisors">8.3.6. Advisors</a></span></dt><dt><span class="section"><a href="#aop-schema-example">8.3.7. Example</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-choosing">8.4. Choosing which AOP declaration style to use</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-spring-or-aspectj">8.4.1. Spring AOP or full AspectJ?</a></span></dt><dt><span class="section"><a href="#aop-ataspectj-or-xml">8.4.2. @AspectJ or XML for Spring AOP?</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-mixing-styles">8.5. Mixing aspect types</a></span></dt><dt><span class="section"><a href="#aop-proxying">8.6. Proxying mechanisms</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-understanding-aop-proxies">8.6.1. Understanding AOP proxies</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-aspectj-programmatic">8.7. Programmatic creation of @AspectJ Proxies</a></span></dt><dt><span class="section"><a href="#aop-using-aspectj">8.8. Using AspectJ with Spring applications</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-atconfigurable">8.8.1. Using AspectJ to dependency inject domain objects with Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-configurable-testing">Unit testing @Configurable objects</a></span></dt><dt><span class="section"><a href="#aop-configurable-container">Working with multiple application contexts</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-ajlib-other">8.8.2. Other Spring aspects for AspectJ</a></span></dt><dt><span class="section"><a href="#aop-aj-configure">8.8.3. Configuring AspectJ aspects using Spring IoC</a></span></dt><dt><span class="section"><a href="#aop-aj-ltw">8.8.4. Load-time weaving with AspectJ in the Spring Framework</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-aj-ltw-first-example">A first example</a></span></dt><dt><span class="section"><a href="#aop-aj-ltw-the-aspects">Aspects</a></span></dt><dt><span class="section"><a href="#aop-aj-ltw-aop_dot_xml">' META-INF/aop.xml'</a></span></dt><dt><span class="section"><a href="#aop-aj-ltw-libraries">Required libraries (JARS)</a></span></dt><dt><span class="section"><a href="#aop-aj-ltw-spring">Spring configuration</a></span></dt><dt><span class="section"><a href="#aop-aj-ltw-environments">Environment-specific configuration</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#aop-resources">8.9. Further Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#aop-api">9. Spring AOP APIs</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-api-introduction">9.1. Introduction</a></span></dt><dt><span class="section"><a href="#aop-api-pointcuts">9.2. Pointcut API in Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-api-concepts">9.2.1. Concepts</a></span></dt><dt><span class="section"><a href="#aop-api-pointcut-ops">9.2.2. Operations on pointcuts</a></span></dt><dt><span class="section"><a href="#aop-api-pointcuts-aspectj">9.2.3. AspectJ expression pointcuts</a></span></dt><dt><span class="section"><a href="#aop-api-pointcuts-impls">9.2.4. Convenience pointcut implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-api-pointcuts-static">Static pointcuts</a></span></dt><dt><span class="section"><a href="#aop-api-pointcuts-dynamic">Dynamic pointcuts</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-api-pointcuts-superclasses">9.2.5. Pointcut superclasses</a></span></dt><dt><span class="section"><a href="#aop-api-pointcuts-custom">9.2.6. Custom pointcuts</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-api-advice">9.3. Advice API in Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-api-advice-lifecycle">9.3.1. Advice lifecycles</a></span></dt><dt><span class="section"><a href="#aop-api-advice-types">9.3.2. Advice types in Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-api-advice-around">Interception around advice</a></span></dt><dt><span class="section"><a href="#aop-api-advice-before">Before advice</a></span></dt><dt><span class="section"><a href="#aop-api-advice-throws">Throws advice</a></span></dt><dt><span class="section"><a href="#aop-api-advice-after-returning">After Returning advice</a></span></dt><dt><span class="section"><a href="#aop-api-advice-introduction">Introduction advice</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#aop-api-advisor">9.4. Advisor API in Spring</a></span></dt><dt><span class="section"><a href="#aop-pfb">9.5. Using the ProxyFactoryBean to create AOP proxies</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-pfb-1">9.5.1. Basics</a></span></dt><dt><span class="section"><a href="#aop-pfb-2">9.5.2. JavaBean properties</a></span></dt><dt><span class="section"><a href="#aop-pfb-proxy-types">9.5.3. JDK- and CGLIB-based proxies</a></span></dt><dt><span class="section"><a href="#aop-api-proxying-intf">9.5.4. Proxying interfaces</a></span></dt><dt><span class="section"><a href="#aop-api-proxying-class">9.5.5. Proxying classes</a></span></dt><dt><span class="section"><a href="#aop-global-advisors">9.5.6. Using <span class="emphasis"><em>global</em></span> advisors</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-concise-proxy">9.6. Concise proxy definitions</a></span></dt><dt><span class="section"><a href="#aop-prog">9.7. Creating AOP proxies programmatically with the ProxyFactory</a></span></dt><dt><span class="section"><a href="#aop-api-advised">9.8. Manipulating advised objects</a></span></dt><dt><span class="section"><a href="#aop-autoproxy">9.9. Using the "auto-proxy" facility</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-autoproxy-choices">9.9.1. Autoproxy bean definitions</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-api-autoproxy">BeanNameAutoProxyCreator</a></span></dt><dt><span class="section"><a href="#aop-api-autoproxy-default">DefaultAdvisorAutoProxyCreator</a></span></dt><dt><span class="section"><a href="#aop-api-autoproxy-abstract">AbstractAdvisorAutoProxyCreator</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-autoproxy-metadata">9.9.2. Using metadata-driven auto-proxying</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-targetsource">9.10. Using TargetSources</a></span></dt><dd><dl><dt><span class="section"><a href="#aop-ts-swap">9.10.1. Hot swappable target sources</a></span></dt><dt><span class="section"><a href="#aop-ts-pool">9.10.2. Pooling target sources</a></span></dt><dt><span class="section"><a href="#aop-ts-prototype">9.10.3. Prototype target sources</a></span></dt><dt><span class="section"><a href="#aop-ts-threadlocal">9.10.4. ThreadLocal target sources</a></span></dt></dl></dd><dt><span class="section"><a href="#aop-extensibility">9.11. Defining new Advice types</a></span></dt><dt><span class="section"><a href="#aop-api-resources">9.12. Further resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#testing">10. Testing</a></span></dt><dd><dl><dt><span class="section"><a href="#testing-introduction">10.1. Introduction to Spring Testing</a></span></dt><dt><span class="section"><a href="#unit-testing">10.2. Unit Testing</a></span></dt><dd><dl><dt><span class="section"><a href="#mock-objects">10.2.1. Mock Objects</a></span></dt><dd><dl><dt><span class="section"><a href="#mock-objects-env">Environment</a></span></dt><dt><span class="section"><a href="#mock-objects-jndi">JNDI</a></span></dt><dt><span class="section"><a href="#mock-objects-servlet">Servlet API</a></span></dt><dt><span class="section"><a href="#mock-objects-portlet">Portlet API</a></span></dt></dl></dd><dt><span class="section"><a href="#unit-testing-support-classes">10.2.2. Unit Testing support Classes</a></span></dt><dd><dl><dt><span class="section"><a href="#unit-testing-utilities">General utilities</a></span></dt><dt><span class="section"><a href="#unit-testing-spring-mvc">Spring MVC</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#integration-testing">10.3. Integration Testing</a></span></dt><dd><dl><dt><span class="section"><a href="#integration-testing-overview">10.3.1. Overview</a></span></dt><dt><span class="section"><a href="#integration-testing-goals">10.3.2. Goals of Integration Testing</a></span></dt><dd><dl><dt><span class="section"><a href="#testing-ctx-management">Context management and caching</a></span></dt><dt><span class="section"><a href="#testing-fixture-di">Dependency Injection of test fixtures</a></span></dt><dt><span class="section"><a href="#testing-tx">Transaction management</a></span></dt><dt><span class="section"><a href="#testing-support-classes">Support classes for integration testing</a></span></dt></dl></dd><dt><span class="section"><a href="#integration-testing-support-jdbc">10.3.3. JDBC Testing Support</a></span></dt><dt><span class="section"><a href="#integration-testing-annotations">10.3.4. Annotations</a></span></dt><dd><dl><dt><span class="section"><a href="#integration-testing-annotations-spring">Spring Testing Annotations</a></span></dt><dt><span class="section"><a href="#integration-testing-annotations-standard">Standard Annotation Support</a></span></dt><dt><span class="section"><a href="#integration-testing-annotations-junit">Spring JUnit Testing Annotations</a></span></dt><dt><span class="section"><a href="#integration-testing-annotations-meta">Meta-Annotation Support for Testing</a></span></dt></dl></dd><dt><span class="section"><a href="#testcontext-framework">10.3.5. Spring TestContext Framework</a></span></dt><dd><dl><dt><span class="section"><a href="#testcontext-key-abstractions">Key abstractions</a></span></dt><dt><span class="section"><a href="#testcontext-ctx-management">Context management</a></span></dt><dt><span class="section"><a href="#testcontext-fixture-di">Dependency injection of test fixtures</a></span></dt><dt><span class="section"><a href="#testcontext-web-scoped-beans">Testing request and session scoped beans</a></span></dt><dt><span class="section"><a href="#testcontext-tx">Transaction management</a></span></dt><dt><span class="section"><a href="#testcontext-support-classes">TestContext Framework support classes</a></span></dt></dl></dd><dt><span class="section"><a href="#spring-mvc-test-framework">10.3.6. Spring MVC Test Framework</a></span></dt><dd><dl><dt><span class="section"><a href="#spring-mvc-test-server">Server-Side Tests</a></span></dt><dt><span class="section"><a href="#spring-mvc-test-client">Client-Side REST Tests</a></span></dt></dl></dd><dt><span class="section"><a href="#testing-examples-petclinic">10.3.7. PetClinic Example</a></span></dt></dl></dd><dt><span class="section"><a href="#testing-resources">10.4. Further Resources</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-data-tier">IV. Data Access</a></span></dt><dd><dl><dt><span class="chapter"><a href="#transaction">11. Transaction Management</a></span></dt><dd><dl><dt><span class="section"><a href="#transaction-intro">11.1. Introduction to Spring Framework transaction management</a></span></dt><dt><span class="section"><a href="#transaction-motivation">11.2. Advantages of the Spring Framework&#8217;s transaction support model</a></span></dt><dd><dl><dt><span class="section"><a href="#transaction-global">11.2.1. Global transactions</a></span></dt><dt><span class="section"><a href="#transaction-local">11.2.2. Local transactions</a></span></dt><dt><span class="section"><a href="#transaction-programming-model">11.2.3. Spring Framework&#8217;s consistent programming model</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-strategies">11.3. Understanding the Spring Framework transaction abstraction</a></span></dt><dt><span class="section"><a href="#tx-resource-synchronization">11.4. Synchronizing resources with transactions</a></span></dt><dd><dl><dt><span class="section"><a href="#tx-resource-synchronization-high">11.4.1. High-level synchronization approach</a></span></dt><dt><span class="section"><a href="#tx-resource-synchronization-low">11.4.2. Low-level synchronization approach</a></span></dt><dt><span class="section"><a href="#tx-resource-synchronization-tadsp">11.4.3. TransactionAwareDataSourceProxy</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-declarative">11.5. Declarative transaction management</a></span></dt><dd><dl><dt><span class="section"><a href="#tx-decl-explained">11.5.1. Understanding the Spring Framework&#8217;s declarative transaction implementation</a></span></dt><dt><span class="section"><a href="#transaction-declarative-first-example">11.5.2. Example of declarative transaction implementation</a></span></dt><dt><span class="section"><a href="#transaction-declarative-rolling-back">11.5.3. Rolling back a declarative transaction</a></span></dt><dt><span class="section"><a href="#transaction-declarative-diff-tx">11.5.4. Configuring different transactional semantics for different beans</a></span></dt><dt><span class="section"><a href="#transaction-declarative-txadvice-settings">11.5.5. &lt;tx:advice/&gt; settings</a></span></dt><dt><span class="section"><a href="#transaction-declarative-annotations">11.5.6. Using @Transactional</a></span></dt><dd><dl><dt><span class="section"><a href="#transaction-declarative-attransactional-settings">@Transactional settings</a></span></dt><dt><span class="section"><a href="#tx-multiple-tx-mgrs-with-attransactional">Multiple Transaction Managers with @Transactional</a></span></dt><dt><span class="section"><a href="#tx-custom-attributes">Custom shortcut annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#tx-propagation">11.5.7. Transaction propagation</a></span></dt><dd><dl><dt><span class="section"><a href="#tx-propagation-required">Required</a></span></dt><dt><span class="section"><a href="#tx-propagation-requires_new">RequiresNew</a></span></dt><dt><span class="section"><a href="#tx-propagation-nested">Nested</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-declarative-applying-more-than-just-tx-advice">11.5.8. Advising transactional operations</a></span></dt><dt><span class="section"><a href="#transaction-declarative-aspectj">11.5.9. Using @Transactional with AspectJ</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-programmatic">11.6. Programmatic transaction management</a></span></dt><dd><dl><dt><span class="section"><a href="#tx-prog-template">11.6.1. Using the TransactionTemplate</a></span></dt><dd><dl><dt><span class="section"><a href="#tx-prog-template-settings">Specifying transaction settings</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-programmatic-ptm">11.6.2. Using the PlatformTransactionManager</a></span></dt></dl></dd><dt><span class="section"><a href="#tx-decl-vs-prog">11.7. Choosing between programmatic and declarative transaction management</a></span></dt><dt><span class="section"><a href="#transaction-application-server-integration">11.8. Application server-specific integration</a></span></dt><dd><dl><dt><span class="section"><a href="#transaction-application-server-integration-websphere">11.8.1. IBM WebSphere</a></span></dt><dt><span class="section"><a href="#transaction-application-server-integration-weblogic">11.8.2. Oracle WebLogic Server</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-solutions-to-common-problems">11.9. Solutions to common problems</a></span></dt><dd><dl><dt><span class="section"><a href="#transaction-solutions-to-common-problems-wrong-ptm">11.9.1. Use of the wrong transaction manager for a specific DataSource</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-resources">11.10. Further Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#dao">12. DAO support</a></span></dt><dd><dl><dt><span class="section"><a href="#dao-introduction">12.1. Introduction</a></span></dt><dt><span class="section"><a href="#dao-exceptions">12.2. Consistent exception hierarchy</a></span></dt><dt><span class="section"><a href="#dao-annotations">12.3. Annotations used for configuring DAO or Repository classes</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jdbc">13. Data access with JDBC</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-introduction">13.1. Introduction to Spring Framework JDBC</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-choose-style">13.1.1. Choosing an approach for JDBC database access</a></span></dt><dt><span class="section"><a href="#jdbc-packages">13.1.2. Package hierarchy</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-core">13.2. Using the JDBC core classes to control basic JDBC processing and error handling</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-JdbcTemplate">13.2.1. JdbcTemplate</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-JdbcTemplate-examples">Examples of JdbcTemplate class usage</a></span></dt><dt><span class="section"><a href="#jdbc-JdbcTemplate-idioms">JdbcTemplate best practices</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-NamedParameterJdbcTemplate">13.2.2. NamedParameterJdbcTemplate</a></span></dt><dt><span class="section"><a href="#jdbc-SQLExceptionTranslator">13.2.3. SQLExceptionTranslator</a></span></dt><dt><span class="section"><a href="#jdbc-statements-executing">13.2.4. Executing statements</a></span></dt><dt><span class="section"><a href="#jdbc-statements-querying">13.2.5. Running queries</a></span></dt><dt><span class="section"><a href="#jdbc-updates">13.2.6. Updating the database</a></span></dt><dt><span class="section"><a href="#jdbc-auto-genereted-keys">13.2.7. Retrieving auto-generated keys</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-connections">13.3. Controlling database connections</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-datasource">13.3.1. DataSource</a></span></dt><dt><span class="section"><a href="#jdbc-DataSourceUtils">13.3.2. DataSourceUtils</a></span></dt><dt><span class="section"><a href="#jdbc-SmartDataSource">13.3.3. SmartDataSource</a></span></dt><dt><span class="section"><a href="#jdbc-AbstractDataSource">13.3.4. AbstractDataSource</a></span></dt><dt><span class="section"><a href="#jdbc-SingleConnectionDataSource">13.3.5. SingleConnectionDataSource</a></span></dt><dt><span class="section"><a href="#jdbc-DriverManagerDataSource">13.3.6. DriverManagerDataSource</a></span></dt><dt><span class="section"><a href="#jdbc-TransactionAwareDataSourceProxy">13.3.7. TransactionAwareDataSourceProxy</a></span></dt><dt><span class="section"><a href="#jdbc-DataSourceTransactionManager">13.3.8. DataSourceTransactionManager</a></span></dt><dt><span class="section"><a href="#jdbc-NativeJdbcExtractor">13.3.9. NativeJdbcExtractor</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-advanced-jdbc">13.4. JDBC batch operations</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-batch-classic">13.4.1. Basic batch operations with the JdbcTemplate</a></span></dt><dt><span class="section"><a href="#jdbc-batch-list">13.4.2. Batch operations with a List of objects</a></span></dt><dt><span class="section"><a href="#jdbc-batch-multi">13.4.3. Batch operations with multiple batches</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-simple-jdbc">13.5. Simplifying JDBC operations with the SimpleJdbc classes</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-simple-jdbc-insert-1">13.5.1. Inserting data using SimpleJdbcInsert</a></span></dt><dt><span class="section"><a href="#jdbc-simple-jdbc-insert-2">13.5.2. Retrieving auto-generated keys using SimpleJdbcInsert</a></span></dt><dt><span class="section"><a href="#jdbc-simple-jdbc-insert-3">13.5.3. Specifying columns for a SimpleJdbcInsert</a></span></dt><dt><span class="section"><a href="#jdbc-simple-jdbc-parameters">13.5.4. Using SqlParameterSource to provide parameter values</a></span></dt><dt><span class="section"><a href="#jdbc-simple-jdbc-call-1">13.5.5. Calling a stored procedure with SimpleJdbcCall</a></span></dt><dt><span class="section"><a href="#jdbc-simple-jdbc-call-2">13.5.6. Explicitly declaring parameters to use for a SimpleJdbcCall</a></span></dt><dt><span class="section"><a href="#jdbc-params">13.5.7. How to define SqlParameters</a></span></dt><dt><span class="section"><a href="#jdbc-simple-jdbc-call-3">13.5.8. Calling a stored function using SimpleJdbcCall</a></span></dt><dt><span class="section"><a href="#jdbc-simple-jdbc-call-4">13.5.9. Returning ResultSet/REF Cursor from a SimpleJdbcCall</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-object">13.6. Modeling JDBC operations as Java objects</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-SqlQuery">13.6.1. SqlQuery</a></span></dt><dt><span class="section"><a href="#jdbc-MappingSqlQuery">13.6.2. MappingSqlQuery</a></span></dt><dt><span class="section"><a href="#jdbc-SqlUpdate">13.6.3. SqlUpdate</a></span></dt><dt><span class="section"><a href="#jdbc-StoredProcedure">13.6.4. StoredProcedure</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-parameter-handling">13.7. Common problems with parameter and data value handling</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-type-information">13.7.1. Providing SQL type information for parameters</a></span></dt><dt><span class="section"><a href="#jdbc-lob">13.7.2. Handling BLOB and CLOB objects</a></span></dt><dt><span class="section"><a href="#jdbc-in-clause">13.7.3. Passing in lists of values for IN clause</a></span></dt><dt><span class="section"><a href="#jdbc-complex-types">13.7.4. Handling complex types for stored procedure calls</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-embedded-database-support">13.8. Embedded database support</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-why-embedded-database">13.8.1. Why use an embedded database?</a></span></dt><dt><span class="section"><a href="#jdbc-embedded-database-xml">13.8.2. Creating an embedded database instance using Spring XML</a></span></dt><dt><span class="section"><a href="#jdbc-embedded-database-java">13.8.3. Creating an embedded database instance programmatically</a></span></dt><dt><span class="section"><a href="#jdbc-embedded-database-extension">13.8.4. Extending the embedded database support</a></span></dt><dt><span class="section"><a href="#jdbc-embedded-database-using-HSQL">13.8.5. Using HSQL</a></span></dt><dt><span class="section"><a href="#jdbc-embedded-database-using-H2">13.8.6. Using H2</a></span></dt><dt><span class="section"><a href="#jdbc-embedded-database-using-Derby">13.8.7. Using Derby</a></span></dt><dt><span class="section"><a href="#jdbc-embedded-database-dao-testing">13.8.8. Testing data access logic with an embedded database</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-intializing-datasource">13.9. Initializing a DataSource</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-initializing-datasource-xml">13.9.1. Initializing a database instance using Spring XML</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-client-component-initialization">Initialization of Other Components that Depend on the Database</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="#orm">14. Object Relational Mapping (ORM) Data Access</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-introduction">14.1. Introduction to ORM with Spring</a></span></dt><dt><span class="section"><a href="#orm-general">14.2. General ORM integration considerations</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-resource-mngmnt">14.2.1. Resource and transaction management</a></span></dt><dt><span class="section"><a href="#orm-exception-translation">14.2.2. Exception translation</a></span></dt></dl></dd><dt><span class="section"><a href="#orm-hibernate">14.3. Hibernate</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-session-factory-setup">14.3.1. SessionFactory setup in a Spring container</a></span></dt><dt><span class="section"><a href="#orm-hibernate-straight">14.3.2. Implementing DAOs based on plain Hibernate 3 API</a></span></dt><dt><span class="section"><a href="#orm-hibernate-tx-declarative">14.3.3. Declarative transaction demarcation</a></span></dt><dt><span class="section"><a href="#orm-hibernate-tx-programmatic">14.3.4. Programmatic transaction demarcation</a></span></dt><dt><span class="section"><a href="#orm-hibernate-tx-strategies">14.3.5. Transaction management strategies</a></span></dt><dt><span class="section"><a href="#orm-hibernate-resources">14.3.6. Comparing container-managed and locally defined resources</a></span></dt><dt><span class="section"><a href="#orm-hibernate-invalid-jdbc-access-error">14.3.7. Spurious application server warnings with Hibernate</a></span></dt></dl></dd><dt><span class="section"><a href="#orm-jdo">14.4. JDO</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-jdo-setup">14.4.1. PersistenceManagerFactory setup</a></span></dt><dt><span class="section"><a href="#orm-jdo-daos-straight">14.4.2. Implementing DAOs based on the plain JDO API</a></span></dt><dt><span class="section"><a href="#orm-jdo-tx">14.4.3. Transaction management</a></span></dt><dt><span class="section"><a href="#orm-jdo-dialect">14.4.4. JdoDialect</a></span></dt></dl></dd><dt><span class="section"><a href="#orm-jpa">14.5. JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-jpa-setup">14.5.1. Three options for JPA setup in a Spring environment</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-jpa-setup-lemfb">LocalEntityManagerFactoryBean</a></span></dt><dt><span class="section"><a href="#orm-jpa-setup-jndi">Obtaining an EntityManagerFactory from JNDI</a></span></dt><dt><span class="section"><a href="#orm-jpa-setup-lcemfb">LocalContainerEntityManagerFactoryBean</a></span></dt><dt><span class="section"><a href="#orm-jpa-multiple-pu">Dealing with multiple persistence units</a></span></dt></dl></dd><dt><span class="section"><a href="#orm-jpa-straight">14.5.2. Implementing DAOs based on plain JPA</a></span></dt><dt><span class="section"><a href="#orm-jpa-tx">14.5.3. Transaction Management</a></span></dt><dt><span class="section"><a href="#orm-jpa-dialect">14.5.4. JpaDialect</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#oxm">15. Marshalling XML using O/X Mappers</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-introduction">15.1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#_ease_of_configuration">15.1.1. Ease of configuration</a></span></dt><dt><span class="section"><a href="#_consistent_interfaces">15.1.2. Consistent Interfaces</a></span></dt><dt><span class="section"><a href="#_consistent_exception_hierarchy">15.1.3. Consistent Exception Hierarchy</a></span></dt></dl></dd><dt><span class="section"><a href="#oxm-marshaller-unmarshaller">15.2. Marshaller and Unmarshaller</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-marshaller">15.2.1. Marshaller</a></span></dt><dt><span class="section"><a href="#oxm-unmarshaller">15.2.2. Unmarshaller</a></span></dt><dt><span class="section"><a href="#oxm-xmlmappingexception">15.2.3. XmlMappingException</a></span></dt></dl></dd><dt><span class="section"><a href="#oxm-usage">15.3. Using Marshaller and Unmarshaller</a></span></dt><dt><span class="section"><a href="#oxm-schema-based-config">15.4. XML Schema-based Configuration</a></span></dt><dt><span class="section"><a href="#oxm-jaxb">15.5. JAXB</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-jaxb2">15.5.1. Jaxb2Marshaller</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-jaxb2-xsd">XML Schema-based Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#oxm-castor">15.6. Castor</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-castor-marshaller">15.6.1. CastorMarshaller</a></span></dt><dt><span class="section"><a href="#oxm-castor-mapping">15.6.2. Mapping</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-castor-xsd">XML Schema-based Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#oxm-xmlbeans">15.7. XMLBeans</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-xmlbeans-marshaller">15.7.1. XmlBeansMarshaller</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-xmlbeans-xsd">XML Schema-based Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#oxm-jibx">15.8. JiBX</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-jibx-marshaller">15.8.1. JibxMarshaller</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-jibx-xsd">XML Schema-based Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#oxm-xstream">15.9. XStream</a></span></dt><dd><dl><dt><span class="section"><a href="#oxm-xstream-marshaller">15.9.1. XStreamMarshaller</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#spring-web">V. The Web</a></span></dt><dd><dl><dt><span class="chapter"><a href="#mvc">16. Web MVC framework</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-introduction">16.1. Introduction to Spring Web MVC framework</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-features">16.1.1. Features of Spring Web MVC</a></span></dt><dt><span class="section"><a href="#mvc-introduction-pluggability">16.1.2. Pluggability of other MVC implementations</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-servlet">16.2. The DispatcherServlet</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-servlet-special-bean-types">16.2.1. Special Bean Types In the WebApplicationContext</a></span></dt><dt><span class="section"><a href="#mvc-servlet-config">16.2.2. Default DispatcherServlet Configuration</a></span></dt><dt><span class="section"><a href="#mvc-servlet-sequence">16.2.3. DispatcherServlet Processing Sequence</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-controller">16.3. Implementing Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-ann-controller">16.3.1. Defining a controller with @Controller</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestmapping">16.3.2. Mapping Requests With Using @RequestMapping</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-ann-requestmapping-31-vs-30">New Support Classes for @RequestMapping methods in Spring MVC 3.1</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestmapping-uri-templates">URI Template Patterns</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestmapping-uri-templates-regex">URI Template Patterns with Regular Expressions</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestmapping-patterns">Path Patterns</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestmapping-placeholders">Patterns with Placeholders</a></span></dt><dt><span class="section"><a href="#mvc-ann-matrix-variables">Matrix Variables</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestmapping-consumes">Consumable Media Types</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestmapping-produces">Producible Media Types</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestmapping-params-and-headers">Request Parameters and Header Values</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-ann-methods">16.3.3. Defining @RequestMapping handler methods</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-ann-arguments">Supported method argument types</a></span></dt><dt><span class="section"><a href="#mvc-ann-return-types">Supported method return types</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestparam">Binding request parameters to method parameters with @RequestParam</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestbody">Mapping the request body with the @RequestBody annotation</a></span></dt><dt><span class="section"><a href="#mvc-ann-responsebody">Mapping the response body with the @ResponseBody annotation</a></span></dt><dt><span class="section"><a href="#mvc-ann-restcontroller">Creating REST Controllers with the @RestController annotation</a></span></dt><dt><span class="section"><a href="#mvc-ann-httpentity">Using HttpEntity</a></span></dt><dt><span class="section"><a href="#mvc-ann-modelattrib-methods">Using @ModelAttribute on a method</a></span></dt><dt><span class="section"><a href="#mvc-ann-modelattrib-method-args">Using @ModelAttribute on a method argument</a></span></dt><dt><span class="section"><a href="#mvc-ann-sessionattrib">Using @SessionAttributes to store model attributes in the HTTP session between requests</a></span></dt><dt><span class="section"><a href="#mvc-ann-redirect-attributes">Specifying redirect and flash attributes</a></span></dt><dt><span class="section"><a href="#mvc-ann-form-urlencoded-data">Working with "application/x-www-form-urlencoded" data</a></span></dt><dt><span class="section"><a href="#mvc-ann-cookievalue">Mapping cookie values with the @CookieValue annotation</a></span></dt><dt><span class="section"><a href="#mvc-ann-requestheader">Mapping request header attributes with the @RequestHeader annotation</a></span></dt><dt><span class="section"><a href="#mvc-ann-typeconversion">Method Parameters And Type Conversion</a></span></dt><dt><span class="section"><a href="#mvc-ann-webdatabinder">Customizing WebDataBinder initialization</a></span></dt><dt><span class="section"><a href="#mvc-ann-lastmodified">Support for the Last-Modified Response Header To Facilitate Content Caching</a></span></dt><dt><span class="section"><a href="#mvc-ann-controller-advice">Assisting Controllers with the @ControllerAdvice annotation</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-ann-async">16.3.4. Asynchronous Request Processing</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-ann-async-exceptions">Exception Handling for Async Requests</a></span></dt><dt><span class="section"><a href="#mvc-ann-async-interception">Intercepting Async Requests</a></span></dt><dt><span class="section"><a href="#mvc-ann-async-configuration">Configuration for Async Request Processing</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-ann-tests">16.3.5. Testing Controllers</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-handlermapping">16.4. Handler mappings</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-handlermapping-interceptor">16.4.1. Intercepting requests with a HandlerInterceptor</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-viewresolver">16.5. Resolving views</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-viewresolver-resolver">16.5.1. Resolving views with the ViewResolver interface</a></span></dt><dt><span class="section"><a href="#mvc-viewresolver-chaining">16.5.2. Chaining ViewResolvers</a></span></dt><dt><span class="section"><a href="#mvc-redirecting">16.5.3. Redirecting to views</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-redirecting-redirect-view">RedirectView</a></span></dt><dt><span class="section"><a href="#mvc-redirecting-redirect-prefix">The redirect: prefix</a></span></dt><dt><span class="section"><a href="#mvc-redirecting-forward-prefix">The forward: prefix</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-multiple-representations">16.5.4. ContentNegotiatingViewResolver</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-flash-attributes">16.6. Using flash attributes</a></span></dt><dt><span class="section"><a href="#mvc-construct-encode-uri">16.7. Building URIs</a></span></dt><dt><span class="section"><a href="#mvc-construct-uri-controllers">16.8. Building URIs to Controllers and methods</a></span></dt><dt><span class="section"><a href="#mvc-localeresolver">16.9. Using locales</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-timezone">16.9.1. Obtaining Time Zone Information</a></span></dt><dt><span class="section"><a href="#mvc-localeresolver-acceptheader">16.9.2. AcceptHeaderLocaleResolver</a></span></dt><dt><span class="section"><a href="#mvc-localeresolver-cookie">16.9.3. CookieLocaleResolver</a></span></dt><dt><span class="section"><a href="#mvc-localeresolver-session">16.9.4. SessionLocaleResolver</a></span></dt><dt><span class="section"><a href="#mvc-localeresolver-interceptor">16.9.5. LocaleChangeInterceptor</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-themeresolver">16.10. Using themes</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-themeresolver-introduction">16.10.1. Overview of themes</a></span></dt><dt><span class="section"><a href="#mvc-themeresolver-defining">16.10.2. Defining themes</a></span></dt><dt><span class="section"><a href="#mvc-themeresolver-resolving">16.10.3. Theme resolvers</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-multipart">16.11. Spring&#8217;s multipart (file upload) support</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-multipart-introduction">16.11.1. Introduction</a></span></dt><dt><span class="section"><a href="#mvc-multipart-resolver-commons">16.11.2. Using a MultipartResolver with <span class="emphasis"><em>Commons FileUpload</em></span></a></span></dt><dt><span class="section"><a href="#mvc-multipart-resolver-standard">16.11.3. Using a MultipartResolver with <span class="emphasis"><em>Servlet 3.0</em></span></a></span></dt><dt><span class="section"><a href="#mvc-multipart-forms">16.11.4. Handling a file upload in a form</a></span></dt><dt><span class="section"><a href="#mvc-multipart-forms-non-browsers">16.11.5. Handling a file upload request from programmatic clients</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-exceptionhandlers">16.12. Handling exceptions</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-exceptionhandlers-resolver">16.12.1. HandlerExceptionResolver</a></span></dt><dt><span class="section"><a href="#mvc-ann-exceptionhandler">16.12.2. @ExceptionHandler</a></span></dt><dt><span class="section"><a href="#mvc-ann-rest-spring-mvc-exceptions">16.12.3. Handling Standard Spring MVC Exceptions</a></span></dt><dt><span class="section"><a href="#mvc-ann-annotated-exceptions">16.12.4. Annotating Business Exceptions With @ResponseStatus</a></span></dt><dt><span class="section"><a href="#mvc-ann-customer-servlet-container-error-page">16.12.5. Customizing the Default Servlet Container Error Page</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-coc">16.13. Convention over configuration support</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-coc-ccnhm">16.13.1. The Controller ControllerClassNameHandlerMapping</a></span></dt><dt><span class="section"><a href="#mvc-coc-modelmap">16.13.2. The Model ModelMap (ModelAndView)</a></span></dt><dt><span class="section"><a href="#mvc-coc-r2vnt">16.13.3. The View - RequestToViewNameTranslator</a></span></dt></dl></dd><dt><span class="section"><a href="#mvc-etag">16.14. ETag support</a></span></dt><dt><span class="section"><a href="#mvc-container-config">16.15. Code-based Servlet container initialization</a></span></dt><dt><span class="section"><a href="#mvc-config">16.16. Configuring Spring MVC</a></span></dt><dd><dl><dt><span class="section"><a href="#mvc-config-enable">16.16.1. Enabling the MVC Java Config or the MVC XML Namespace</a></span></dt><dt><span class="section"><a href="#mvc-config-customize">16.16.2. Customizing the Provided Configuration</a></span></dt><dt><span class="section"><a href="#mvc-config-interceptors">16.16.3. Configuring Interceptors</a></span></dt><dt><span class="section"><a href="#mvc-config-content-negotiation">16.16.4. Configuring Content Negotiation</a></span></dt><dt><span class="section"><a href="#mvc-config-view-controller">16.16.5. Configuring View Controllers</a></span></dt><dt><span class="section"><a href="#mvc-config-static-resources">16.16.6. Configuring Serving of Resources</a></span></dt><dt><span class="section"><a href="#mvc-default-servlet-handler">16.16.7. mvc:default-servlet-handler</a></span></dt><dt><span class="section"><a href="#mvc-resources">16.16.8. More Spring Web MVC Resources</a></span></dt><dt><span class="section"><a href="#mvc-config-advanced-java">16.16.9. Advanced Customizations with MVC Java Config</a></span></dt><dt><span class="section"><a href="#mvc-config-advanced-xml">16.16.10. Advanced Customizations with the MVC Namespace</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#view">17. View technologies</a></span></dt><dd><dl><dt><span class="section"><a href="#view-introduction">17.1. Introduction</a></span></dt><dt><span class="section"><a href="#view-jsp">17.2. JSP &amp; JSTL</a></span></dt><dd><dl><dt><span class="section"><a href="#view-jsp-resolver">17.2.1. View resolvers</a></span></dt><dt><span class="section"><a href="#view-jsp-jstl">17.2.2. <span class="emphasis"><em>Plain-old</em></span> JSPs versus JSTL</a></span></dt><dt><span class="section"><a href="#view-jsp-tags">17.2.3. Additional tags facilitating development</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib">17.2.4. Using Spring&#8217;s form tag library</a></span></dt><dd><dl><dt><span class="section"><a href="#view-jsp-formtaglib-configuration">Configuration</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-formtag">The form tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-inputtag">The input tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-checkboxtag">The checkbox tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-checkboxestag">The checkboxes tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-radiobuttontag">The radiobutton tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-radiobuttonstag">The radiobuttons tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-passwordtag">The password tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-selecttag">The select tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-optiontag">The option tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-optionstag">The options tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-textAreatag">The textarea tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-hiddeninputtag">The hidden tag</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-errorstag">The errors tag</a></span></dt><dt><span class="section"><a href="#rest-method-conversion">HTTP Method Conversion</a></span></dt><dt><span class="section"><a href="#view-jsp-formtaglib-html5">HTML5 Tags</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#view-tiles">17.3. Tiles</a></span></dt><dd><dl><dt><span class="section"><a href="#view-tiles-dependencies">17.3.1. Dependencies</a></span></dt><dt><span class="section"><a href="#view-tiles-integrate">17.3.2. How to integrate Tiles</a></span></dt><dd><dl><dt><span class="section"><a href="#view-tiles-url">UrlBasedViewResolver</a></span></dt><dt><span class="section"><a href="#view-tiles-resource">ResourceBundleViewResolver</a></span></dt><dt><span class="section"><a href="#view-tiles-preparer">SimpleSpringPreparerFactory and SpringBeanPreparerFactory</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#view-velocity">17.4. Velocity &amp; FreeMarker</a></span></dt><dd><dl><dt><span class="section"><a href="#view-velocity-dependencies">17.4.1. Dependencies</a></span></dt><dt><span class="section"><a href="#view-velocity-contextconfig">17.4.2. Context configuration</a></span></dt><dt><span class="section"><a href="#view-velocity-createtemplates">17.4.3. Creating templates</a></span></dt><dt><span class="section"><a href="#view-velocity-advancedconfig">17.4.4. Advanced configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#view-velocity-example-velocityproperties">velocity.properties</a></span></dt><dt><span class="section"><a href="#views-freemarker">FreeMarker</a></span></dt></dl></dd><dt><span class="section"><a href="#view-velocity-forms">17.4.5. Bind support and form handling</a></span></dt><dd><dl><dt><span class="section"><a href="#view-bind-macros">The bind macros</a></span></dt><dt><span class="section"><a href="#view-simple-binding">Simple binding</a></span></dt><dt><span class="section"><a href="#views-form-macros">Form input generation macros</a></span></dt><dt><span class="section"><a href="#views-form-macros-html-escaping">HTML escaping and XHTML compliance</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#view-xslt">17.5. XSLT</a></span></dt><dd><dl><dt><span class="section"><a href="#view-xslt-firstwords">17.5.1. My First Words</a></span></dt><dd><dl><dt><span class="section"><a href="#view-xslt-beandefs">Bean definitions</a></span></dt><dt><span class="section"><a href="#view-xslt-controllercode">Standard MVC controller code</a></span></dt><dt><span class="section"><a href="#view-xslt-subclassing">Convert the model data to XML</a></span></dt><dt><span class="section"><a href="#view-xslt-viewdefinitions">Defining the view properties</a></span></dt><dt><span class="section"><a href="#view-xslt-transforming">Document transformation</a></span></dt></dl></dd><dt><span class="section"><a href="#view-xslt-summary">17.5.2. Summary</a></span></dt></dl></dd><dt><span class="section"><a href="#view-document">17.6. Document views (PDF/Excel)</a></span></dt><dd><dl><dt><span class="section"><a href="#view-document-intro">17.6.1. Introduction</a></span></dt><dt><span class="section"><a href="#view-document-config">17.6.2. Configuration and setup</a></span></dt><dd><dl><dt><span class="section"><a href="#view-document-configviews">Document view definitions</a></span></dt><dt><span class="section"><a href="#view-document-configcontroller">Controller code</a></span></dt><dt><span class="section"><a href="#view-document-configsubclasses">Subclassing for Excel views</a></span></dt><dt><span class="section"><a href="#view-document-configsubclasspdf">Subclassing for PDF views</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#view-jasper-reports">17.7. JasperReports</a></span></dt><dd><dl><dt><span class="section"><a href="#view-jasper-reports-dependencies">17.7.1. Dependencies</a></span></dt><dt><span class="section"><a href="#view-jasper-reports-configuration">17.7.2. Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#view-jasper-reports-configuration-resolver">Configuring the ViewResolver</a></span></dt><dt><span class="section"><a href="#view-jasper-reports-configuration-views">Configuring the Views</a></span></dt><dt><span class="section"><a href="#view-jasper-reports-configuration-report-files">About Report Files</a></span></dt><dt><span class="section"><a href="#view-jasper-reports-configuration-multiformat-view">Using JasperReportsMultiFormatView</a></span></dt></dl></dd><dt><span class="section"><a href="#view-jasper-reports-model">17.7.3. Populating the ModelAndView</a></span></dt><dt><span class="section"><a href="#view-jasper-reports-subreports">17.7.4. Working with Sub-Reports</a></span></dt><dd><dl><dt><span class="section"><a href="#view-jasper-reports-subreports-config-reports">Configuring Sub-Report Files</a></span></dt><dt><span class="section"><a href="#view-jasper-reports-subreports-config-datasources">Configuring Sub-Report Data Sources</a></span></dt></dl></dd><dt><span class="section"><a href="#view-jasper-reports-exporter-parameters">17.7.5. Configuring Exporter Parameters</a></span></dt></dl></dd><dt><span class="section"><a href="#view-feeds">17.8. Feed Views</a></span></dt><dt><span class="section"><a href="#view-xml-marshalling">17.9. XML Marshalling View</a></span></dt><dt><span class="section"><a href="#view-json-mapping">17.10. JSON Mapping View</a></span></dt></dl></dd><dt><span class="chapter"><a href="#web-integration">18. Integrating with other web frameworks</a></span></dt><dd><dl><dt><span class="section"><a href="#intro">18.1. Introduction</a></span></dt><dt><span class="section"><a href="#web-integration-common">18.2. Common configuration</a></span></dt><dt><span class="section"><a href="#jsf">18.3. JavaServer Faces 1.2</a></span></dt><dd><dl><dt><span class="section"><a href="#jsf-springbeanfaceselresolver">18.3.1. SpringBeanFacesELResolver (JSF 1.2+)</a></span></dt><dt><span class="section"><a href="#jsf-facescontextutils">18.3.2. FacesContextUtils</a></span></dt></dl></dd><dt><span class="section"><a href="#struts">18.4. Apache Struts 2.x</a></span></dt><dt><span class="section"><a href="#tapestry">18.5. Tapestry 5.x</a></span></dt><dt><span class="section"><a href="#web-integration-resources">18.6. Further Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#portlet">19. Portlet MVC Framework</a></span></dt><dd><dl><dt><span class="section"><a href="#portlet-introduction">19.1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#portlet-introduction-controller">19.1.1. Controllers - The C in MVC</a></span></dt><dt><span class="section"><a href="#portlet-introduction-view">19.1.2. Views - The V in MVC</a></span></dt><dt><span class="section"><a href="#portlet-introduction-scope">19.1.3. Web-scoped beans</a></span></dt></dl></dd><dt><span class="section"><a href="#portlet-dispatcher">19.2. The DispatcherPortlet</a></span></dt><dt><span class="section"><a href="#portlet-viewservlet">19.3. The ViewRendererServlet</a></span></dt><dt><span class="section"><a href="#portlet-controller">19.4. Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#portlet-controller-abstractcontroller">19.4.1. AbstractController and PortletContentGenerator</a></span></dt><dt><span class="section"><a href="#portlet-controller-simple">19.4.2. Other simple controllers</a></span></dt><dt><span class="section"><a href="#portlet-controller-command">19.4.3. Command Controllers</a></span></dt><dt><span class="section"><a href="#portlet-controller-wrapping">19.4.4. PortletWrappingController</a></span></dt></dl></dd><dt><span class="section"><a href="#portlet-handlermapping">19.5. Handler mappings</a></span></dt><dd><dl><dt><span class="section"><a href="#portlet-handlermapping-portletmode">19.5.1. PortletModeHandlerMapping</a></span></dt><dt><span class="section"><a href="#portlet-handlermapping-parameter">19.5.2. ParameterHandlerMapping</a></span></dt><dt><span class="section"><a href="#portlet-handlermapping-portletmodeparameter">19.5.3. PortletModeParameterHandlerMapping</a></span></dt><dt><span class="section"><a href="#portlet-handlermapping-interceptor">19.5.4. Adding HandlerInterceptors</a></span></dt><dt><span class="section"><a href="#portlet-handlermapping-interceptoradapter">19.5.5. HandlerInterceptorAdapter</a></span></dt><dt><span class="section"><a href="#portlet-handlermapping-parameterinterceptor">19.5.6. ParameterMappingInterceptor</a></span></dt></dl></dd><dt><span class="section"><a href="#portlet-viewresolver">19.6. Views and resolving them</a></span></dt><dt><span class="section"><a href="#portlet-multipart">19.7. Multipart (file upload) support</a></span></dt><dd><dl><dt><span class="section"><a href="#portlet-multipart-resolver">19.7.1. Using the PortletMultipartResolver</a></span></dt><dt><span class="section"><a href="#portlet-multipart-forms">19.7.2. Handling a file upload in a form</a></span></dt></dl></dd><dt><span class="section"><a href="#portlet-exceptionresolver">19.8. Handling exceptions</a></span></dt><dt><span class="section"><a href="#portlet-annotation">19.9. Annotation-based controller configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#portlet-ann-setup">19.9.1. Setting up the dispatcher for annotation support</a></span></dt><dt><span class="section"><a href="#portlet-ann-controller">19.9.2. Defining a controller with @Controller</a></span></dt><dt><span class="section"><a href="#portlet-ann-requestmapping">19.9.3. Mapping requests with @RequestMapping</a></span></dt><dt><span class="section"><a href="#portlet-ann-requestmapping-arguments">19.9.4. Supported handler method arguments</a></span></dt><dt><span class="section"><a href="#portlet-ann-requestparam">19.9.5. Binding request parameters to method parameters with @RequestParam</a></span></dt><dt><span class="section"><a href="#portlet-ann-modelattrib">19.9.6. Providing a link to data from the model with @ModelAttribute</a></span></dt><dt><span class="section"><a href="#portlet-ann-sessionattrib">19.9.7. Specifying attributes to store in a Session with @SessionAttributes</a></span></dt><dt><span class="section"><a href="#portlet-ann-webdatabinder">19.9.8. Customizing WebDataBinder initialization</a></span></dt><dd><dl><dt><span class="section"><a href="#portlet-ann-initbinder">Customizing data binding with @InitBinder</a></span></dt><dt><span class="section"><a href="#portlet-ann-webbindinginitializer">Configuring a custom WebBindingInitializer</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#portlet-deployment">19.10. Portlet application deployment</a></span></dt></dl></dd><dt><span class="chapter"><a href="#websocket">20. WebSocket Support</a></span></dt><dd><dl><dt><span class="section"><a href="#websocket-intro">20.1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#websocket-into-fallback-options">20.1.1. Fallback Options</a></span></dt><dt><span class="section"><a href="#websocket-intro-architecture">20.1.2. Messaging Architecture</a></span></dt><dt><span class="section"><a href="#websocket-intro-sub-protocol">20.1.3. Sub-Protocol Support</a></span></dt><dt><span class="section"><a href="#websocket-intro-when-to-use">20.1.4. When To Use WebSocket?</a></span></dt></dl></dd><dt><span class="section"><a href="#websocket-server">20.2. WebSocket Server</a></span></dt><dd><dl><dt><span class="section"><a href="#websocket-server-handler">20.2.1. Create and Configure a WebSocketHandler</a></span></dt><dt><span class="section"><a href="#websocket-server-handshake">20.2.2. Customizing the WebSocket Handshake</a></span></dt><dt><span class="section"><a href="#websocket-server-decorators">20.2.3. WebSocketHandler Decoration</a></span></dt><dt><span class="section"><a href="#websocket-server-deployment">20.2.4. Deployment Considerations</a></span></dt><dt><span class="section"><a href="#websocket-server-runtime-configuration">20.2.5. Configuring the WebSocket Engine</a></span></dt></dl></dd><dt><span class="section"><a href="#websocket-fallback">20.3. Fallback Options</a></span></dt><dd><dl><dt><span class="section"><a href="#websocket-fallback-sockjs-enable">20.3.1. Enable SockJS</a></span></dt><dt><span class="section"><a href="#websocket-fallback-sockjs-explained">20.3.2. How SockJS Works</a></span></dt><dt><span class="section"><a href="#websocket-fallback-sockjs-spring">20.3.3. Spring&#8217;s SockJS Support</a></span></dt></dl></dd><dt><span class="section"><a href="#websocket-stomp">20.4. STOMP Messaging</a></span></dt><dd><dl><dt><span class="section"><a href="#websocket-stomp-overview">20.4.1. Overview of STOMP</a></span></dt><dt><span class="section"><a href="#websocket-stomp-enable">20.4.2. Enable STOMP (over WebSocket)</a></span></dt><dt><span class="section"><a href="#websocket-stomp-handle">20.4.3. Overview of STOMP Message Handling</a></span></dt><dd><dl><dt><span class="section"><a href="#websocket-stomp-handle-annotations">Annotation-based Message Handling</a></span></dt><dt><span class="section"><a href="#websocket-stomp-handle-send">Sending Messages From Anywhere</a></span></dt><dt><span class="section"><a href="#websocket-stomp-handle-simple-broker">Simple Message Broker</a></span></dt><dt><span class="section"><a href="#websocket-stomp-handle-broker-relay">Using a Full-Featured Message Broker</a></span></dt><dt><span class="section"><a href="#websocket-stomp-handle-user">Handling Messages to User Destinations</a></span></dt><dt><span class="section"><a href="#websocket-stomp-testing">Testing Message Handling Controllers</a></span></dt></dl></dd></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration">VI. Integration</a></span></dt><dd><dl><dt><span class="chapter"><a href="#remoting">21. Remoting and web services using Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#remoting-introduction">21.1. Introduction</a></span></dt><dt><span class="section"><a href="#remoting-rmi">21.2. Exposing services using RMI</a></span></dt><dd><dl><dt><span class="section"><a href="#remoting-rmi-server">21.2.1. Exporting the service using the RmiServiceExporter</a></span></dt><dt><span class="section"><a href="#remoting-rmi-client">21.2.2. Linking in the service at the client</a></span></dt></dl></dd><dt><span class="section"><a href="#remoting-caucho-protocols">21.3. Using Hessian or Burlap to remotely call services via HTTP</a></span></dt><dd><dl><dt><span class="section"><a href="#remoting-caucho-protocols-hessian">21.3.1. Wiring up the DispatcherServlet for Hessian and co.</a></span></dt><dt><span class="section"><a href="#remoting-caucho-protocols-hessian-server">21.3.2. Exposing your beans by using the HessianServiceExporter</a></span></dt><dt><span class="section"><a href="#remoting-caucho-protocols-hessian-client">21.3.3. Linking in the service on the client</a></span></dt><dt><span class="section"><a href="#remoting-caucho-protocols-burlap">21.3.4. Using Burlap</a></span></dt><dt><span class="section"><a href="#remoting-caucho-protocols-security">21.3.5. Applying HTTP basic authentication to a service exposed through Hessian or Burlap</a></span></dt></dl></dd><dt><span class="section"><a href="#remoting-httpinvoker">21.4. Exposing services using HTTP invokers</a></span></dt><dd><dl><dt><span class="section"><a href="#remoting-httpinvoker-server">21.4.1. Exposing the service object</a></span></dt><dt><span class="section"><a href="#remoting-httpinvoker-client">21.4.2. Linking in the service at the client</a></span></dt></dl></dd><dt><span class="section"><a href="#remoting-web-services">21.5. Web services</a></span></dt><dd><dl><dt><span class="section"><a href="#remoting-web-services-jaxws-export-servlet">21.5.1. Exposing servlet-based web services using JAX-WS</a></span></dt><dt><span class="section"><a href="#remoting-web-services-jaxws-export-standalone">21.5.2. Exporting standalone web services using JAX-WS</a></span></dt><dt><span class="section"><a href="#remoting-web-services-jaxws-export-ri">21.5.3. Exporting web services using the JAX-WS RI&#8217;s Spring support</a></span></dt><dt><span class="section"><a href="#remoting-web-services-jaxws-access">21.5.4. Accessing web services using JAX-WS</a></span></dt></dl></dd><dt><span class="section"><a href="#remoting-jms">21.6. JMS</a></span></dt><dd><dl><dt><span class="section"><a href="#remoting-jms-server">21.6.1. Server-side configuration</a></span></dt><dt><span class="section"><a href="#remoting-jms-client">21.6.2. Client-side configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#remoting-amqp">21.7. AMQP</a></span></dt><dt><span class="section"><a href="#remoting-autodection-remote-interfaces">21.8. Auto-detection is not implemented for remote interfaces</a></span></dt><dt><span class="section"><a href="#remoting-considerations">21.9. Considerations when choosing a technology</a></span></dt><dt><span class="section"><a href="#rest-client-access">21.10. Accessing RESTful services on the Client</a></span></dt><dd><dl><dt><span class="section"><a href="#rest-resttemplate">21.10.1. RestTemplate</a></span></dt><dd><dl><dt><span class="section"><a href="#rest-resttemplate-uri">Working with the URI</a></span></dt><dt><span class="section"><a href="#rest-template-headers">Dealing with request and response headers</a></span></dt></dl></dd><dt><span class="section"><a href="#rest-message-conversion">21.10.2. HTTP Message Conversion</a></span></dt><dd><dl><dt><span class="section"><a href="#rest-string-converter">StringHttpMessageConverter</a></span></dt><dt><span class="section"><a href="#rest-form-converter">FormHttpMessageConverter</a></span></dt><dt><span class="section"><a href="#rest-byte-converter">ByteArrayHttpMessageConverter</a></span></dt><dt><span class="section"><a href="#rest-marhsalling-converter">MarshallingHttpMessageConverter</a></span></dt><dt><span class="section"><a href="#rest-mapping-json-converter">MappingJackson2HttpMessageConverter (or MappingJacksonHttpMessageConverter with Jackson 1.x)</a></span></dt><dt><span class="section"><a href="#rest-source-converter">SourceHttpMessageConverter</a></span></dt><dt><span class="section"><a href="#rest-buffered-image-converter">BufferedImageHttpMessageConverter</a></span></dt></dl></dd><dt><span class="section"><a href="#rest-async-resttemplate">21.10.3. Async RestTemplate</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ejb">22. Enterprise JavaBeans (EJB) integration</a></span></dt><dd><dl><dt><span class="section"><a href="#ejb-introduction">22.1. Introduction</a></span></dt><dt><span class="section"><a href="#ejb-access">22.2. Accessing EJBs</a></span></dt><dd><dl><dt><span class="section"><a href="#ejb-access-concepts">22.2.1. Concepts</a></span></dt><dt><span class="section"><a href="#ejb-access-local">22.2.2. Accessing local SLSBs</a></span></dt><dt><span class="section"><a href="#ejb-access-remote">22.2.3. Accessing remote SLSBs</a></span></dt><dt><span class="section"><a href="#ejb-access-ejb2-ejb3">22.2.4. Accessing EJB 2.x SLSBs versus EJB 3 SLSBs</a></span></dt></dl></dd><dt><span class="section"><a href="#ejb-implementation">22.3. Using Spring&#8217;s EJB implementation support classes</a></span></dt><dd><dl><dt><span class="section"><a href="#ejb-implementation-ejb3">22.3.1. EJB 3 injection interceptor</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#jms">23. JMS (Java Message Service)</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-introduction">23.1. Introduction</a></span></dt><dt><span class="section"><a href="#jms-using">23.2. Using Spring JMS</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-jmstemplate">23.2.1. JmsTemplate</a></span></dt><dt><span class="section"><a href="#jms-connections">23.2.2. Connections</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-caching-resources">Caching Messaging Resources</a></span></dt><dt><span class="section"><a href="#jms-connection-factory">SingleConnectionFactory</a></span></dt><dt><span class="section"><a href="#jdbc-connection-factory-caching">CachingConnectionFactory</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-destinations">23.2.3. Destination Management</a></span></dt><dt><span class="section"><a href="#jms-mdp">23.2.4. Message Listener Containers</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-mdp-simple">SimpleMessageListenerContainer</a></span></dt><dt><span class="section"><a href="#jms-mdp-default">DefaultMessageListenerContainer</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-tx">23.2.5. Transaction management</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-sending">23.3. Sending a Message</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-msg-conversion">23.3.1. Using Message Converters</a></span></dt><dt><span class="section"><a href="#jms-callbacks">23.3.2. SessionCallback and ProducerCallback</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-receiving">23.4. Receiving a message</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-receiving-sync">23.4.1. Synchronous Reception</a></span></dt><dt><span class="section"><a href="#jms-asynchronousMessageReception">23.4.2. Asynchronous Reception - Message-Driven POJOs</a></span></dt><dt><span class="section"><a href="#jms-receiving-async-session-aware-message-listener">23.4.3. the SessionAwareMessageListener interface</a></span></dt><dt><span class="section"><a href="#jms-receiving-async-message-listener-adapter">23.4.4. the MessageListenerAdapter</a></span></dt><dt><span class="section"><a href="#jms-tx-participation">23.4.5. Processing messages within transactions</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-jca-message-endpoint-manager">23.5. Support for JCA Message Endpoints</a></span></dt><dt><span class="section"><a href="#jms-namespace">23.6. JMS Namespace Support</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jmx">24. JMX</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-introduction">24.1. Introduction</a></span></dt><dt><span class="section"><a href="#jmx-exporting">24.2. Exporting your beans to JMX</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-exporting-mbeanserver">24.2.1. Creating an MBeanServer</a></span></dt><dt><span class="section"><a href="#jmx-mbean-server">24.2.2. Reusing an existing MBeanServer</a></span></dt><dt><span class="section"><a href="#jmx-exporting-lazy">24.2.3. Lazy-initialized MBeans</a></span></dt><dt><span class="section"><a href="#jmx-exporting-auto">24.2.4. Automatic registration of MBeans</a></span></dt><dt><span class="section"><a href="#jmx-exporting-registration-behavior">24.2.5. Controlling the registration behavior</a></span></dt></dl></dd><dt><span class="section"><a href="#jmx-interface">24.3. Controlling the management interface of your beans</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-interface-assembler">24.3.1. the MBeanInfoAssembler Interface</a></span></dt><dt><span class="section"><a href="#jmx-interface-metadata">24.3.2. Using Source-Level Metadata (JDK 5.0 annotations)</a></span></dt><dt><span class="section"><a href="#jmx-interface-metadata-types">24.3.3. Source-Level Metadata Types</a></span></dt><dt><span class="section"><a href="#jmx-interface-autodetect">24.3.4. the AutodetectCapableMBeanInfoAssembler interface</a></span></dt><dt><span class="section"><a href="#jmx-interface-java">24.3.5. Defining management interfaces using Java interfaces</a></span></dt><dt><span class="section"><a href="#jmx-interface-methodnames">24.3.6. Using MethodNameBasedMBeanInfoAssembler</a></span></dt></dl></dd><dt><span class="section"><a href="#jmx-naming">24.4. Controlling the ObjectNames for your beans</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-naming-properties">24.4.1. Reading ObjectNames from Properties</a></span></dt><dt><span class="section"><a href="#jmx-naming-metadata">24.4.2. Using the MetadataNamingStrategy</a></span></dt><dt><span class="section"><a href="#jmx-context-mbeanexport">24.4.3. Configuring annotation based MBean export</a></span></dt></dl></dd><dt><span class="section"><a href="#jmx-jsr160">24.5. JSR-160 Connectors</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-jsr160-server">24.5.1. Server-side Connectors</a></span></dt><dt><span class="section"><a href="#jmx-jsr160-client">24.5.2. Client-side Connectors</a></span></dt><dt><span class="section"><a href="#jmx-jsr160-protocols">24.5.3. JMX over Burlap/Hessian/SOAP</a></span></dt></dl></dd><dt><span class="section"><a href="#jmx-proxy">24.6. Accessing MBeans via Proxies</a></span></dt><dt><span class="section"><a href="#jmx-notifications">24.7. Notifications</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-notifications-listeners">24.7.1. Registering Listeners for Notifications</a></span></dt><dt><span class="section"><a href="#jmx-notifications-publishing">24.7.2. Publishing Notifications</a></span></dt></dl></dd><dt><span class="section"><a href="#jmx-resources">24.8. Further Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#cci">25. JCA CCI</a></span></dt><dd><dl><dt><span class="section"><a href="#cci-introduction">25.1. Introduction</a></span></dt><dt><span class="section"><a href="#cci-config">25.2. Configuring CCI</a></span></dt><dd><dl><dt><span class="section"><a href="#cci-config-connector">25.2.1. Connector configuration</a></span></dt><dt><span class="section"><a href="#cci-config-connectionfactory">25.2.2. ConnectionFactory configuration in Spring</a></span></dt><dt><span class="section"><a href="#cci-config-cci-connections">25.2.3. Configuring CCI connections</a></span></dt><dt><span class="section"><a href="#cci-config-single-connection">25.2.4. Using a single CCI connection</a></span></dt></dl></dd><dt><span class="section"><a href="#cci-using">25.3. Using Spring&#8217;s CCI access support</a></span></dt><dd><dl><dt><span class="section"><a href="#cci-record-creator">25.3.1. Record conversion</a></span></dt><dt><span class="section"><a href="#cci-using-template">25.3.2. the CciTemplate</a></span></dt><dt><span class="section"><a href="#cci-using-dao">25.3.3. DAO support</a></span></dt><dt><span class="section"><a href="#automatic-output-generation">25.3.4. Automatic output record generation</a></span></dt><dt><span class="section"><a href="#template-summary">25.3.5. Summary</a></span></dt><dt><span class="section"><a href="#cci-straight">25.3.6. Using a CCI Connection and Interaction directly</a></span></dt><dt><span class="section"><a href="#cci-template-example">25.3.7. Example for CciTemplate usage</a></span></dt></dl></dd><dt><span class="section"><a href="#cci-object">25.4. Modeling CCI access as operation objects</a></span></dt><dd><dl><dt><span class="section"><a href="#cci-object-mapping-record">25.4.1. MappingRecordOperation</a></span></dt><dt><span class="section"><a href="#cci-object-mapping-comm-area">25.4.2. MappingCommAreaOperation</a></span></dt><dt><span class="section"><a href="#cci-automatic-record-gen">25.4.3. Automatic output record generation</a></span></dt><dt><span class="section"><a href="#cci-object-summary">25.4.4. Summary</a></span></dt><dt><span class="section"><a href="#cci-objects-mappring-record-example">25.4.5. Example for MappingRecordOperation usage</a></span></dt><dt><span class="section"><a href="#cci-objects-mapping-comm-area-example">25.4.6. Example for MappingCommAreaOperation usage</a></span></dt></dl></dd><dt><span class="section"><a href="#cci-tx">25.5. Transactions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mail">26. Email</a></span></dt><dd><dl><dt><span class="section"><a href="#mail-introduction">26.1. Introduction</a></span></dt><dt><span class="section"><a href="#mail-usage">26.2. Usage</a></span></dt><dd><dl><dt><span class="section"><a href="#mail-usage-simple">26.2.1. Basic MailSender and SimpleMailMessage usage</a></span></dt><dt><span class="section"><a href="#mail-usage-mime">26.2.2. Using the JavaMailSender and the MimeMessagePreparator</a></span></dt></dl></dd><dt><span class="section"><a href="#mail-javamail-mime">26.3. Using the JavaMail MimeMessageHelper</a></span></dt><dd><dl><dt><span class="section"><a href="#mail-javamail-mime-attachments">26.3.1. Sending attachments and inline resources</a></span></dt><dd><dl><dt><span class="section"><a href="#mail-javamail-mime-attachments-attachment">Attachments</a></span></dt><dt><span class="section"><a href="#mail-javamail-mime-attachments-inline">Inline resources</a></span></dt></dl></dd><dt><span class="section"><a href="#mail-templates">26.3.2. Creating email content using a templating library</a></span></dt><dd><dl><dt><span class="section"><a href="#mail-templates-example">A Velocity-based example</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="#scheduling">27. Task Execution and Scheduling</a></span></dt><dd><dl><dt><span class="section"><a href="#scheduling-introduction">27.1. Introduction</a></span></dt><dt><span class="section"><a href="#scheduling-task-executor">27.2. The Spring TaskExecutor abstraction</a></span></dt><dd><dl><dt><span class="section"><a href="#scheduling-task-executor-types">27.2.1. TaskExecutor types</a></span></dt><dt><span class="section"><a href="#scheduling-task-executor-usage">27.2.2. Using a TaskExecutor</a></span></dt></dl></dd><dt><span class="section"><a href="#scheduling-task-scheduler">27.3. The Spring TaskScheduler abstraction</a></span></dt><dd><dl><dt><span class="section"><a href="#scheduling-trigger-interface">27.3.1. the Trigger interface</a></span></dt><dt><span class="section"><a href="#scheduling-trigger-implementations">27.3.2. Trigger implementations</a></span></dt><dt><span class="section"><a href="#scheduling-task-scheduler-implementations">27.3.3. TaskScheduler implementations</a></span></dt></dl></dd><dt><span class="section"><a href="#scheduling-annotation-support">27.4. Annotation Support for Scheduling and Asynchronous Execution</a></span></dt><dd><dl><dt><span class="section"><a href="#scheduling-enable-annotation-support">27.4.1. Enable scheduling annotations</a></span></dt><dt><span class="section"><a href="#scheduling-annotation-support-scheduled">27.4.2. The @Scheduled Annotation</a></span></dt><dt><span class="section"><a href="#scheduling-annotation-support-async">27.4.3. The @Async Annotation</a></span></dt><dt><span class="section"><a href="#scheduling-annotation-support-qualification">27.4.4. Executor qualification with @Async</a></span></dt></dl></dd><dt><span class="section"><a href="#scheduling-task-namespace">27.5. The Task Namespace</a></span></dt><dd><dl><dt><span class="section"><a href="#scheduling-task-namespace-scheduler">27.5.1. The <span class="emphasis"><em>scheduler</em></span> element</a></span></dt><dt><span class="section"><a href="#scheduling-task-namespace-executor">27.5.2. The <span class="emphasis"><em>executor</em></span> element</a></span></dt><dt><span class="section"><a href="#scheduling-task-namespace-scheduled-tasks">27.5.3. The <span class="emphasis"><em>scheduled-tasks</em></span> element</a></span></dt></dl></dd><dt><span class="section"><a href="#scheduling-quartz">27.6. Using the Quartz Scheduler</a></span></dt><dd><dl><dt><span class="section"><a href="#scheduling-quartz-jobdetail">27.6.1. Using the JobDetailBean</a></span></dt><dt><span class="section"><a href="#scheduling-quartz-method-invoking-job">27.6.2. Using the MethodInvokingJobDetailFactoryBean</a></span></dt><dt><span class="section"><a href="#scheduling-quartz-cron">27.6.3. Wiring up jobs using triggers and the SchedulerFactoryBean</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#dynamic-language">28. Dynamic language support</a></span></dt><dd><dl><dt><span class="section"><a href="#dynamic-language-introduction">28.1. Introduction</a></span></dt><dt><span class="section"><a href="#dynamic-language-a-first-example">28.2. A first example</a></span></dt><dt><span class="section"><a href="#dynamic-language-beans">28.3. Defining beans that are backed by dynamic languages</a></span></dt><dd><dl><dt><span class="section"><a href="#dynamic-language-beans-concepts">28.3.1. Common concepts</a></span></dt><dd><dl><dt><span class="section"><a href="#dynamic-language-beans-concepts-xml-language-element">The &lt;lang:language/&gt; element</a></span></dt><dt><span class="section"><a href="#dynamic-language-refreshable-beans">Refreshable beans</a></span></dt><dt><span class="section"><a href="#dynamic-language-beans-inline">Inline dynamic language source files</a></span></dt><dt><span class="section"><a href="#dynamic-language-beans-ctor-injection">Understanding Constructor Injection in the context of dynamic-language-backed beans</a></span></dt></dl></dd><dt><span class="section"><a href="#dynamic-language-beans-jruby">28.3.2. JRuby beans</a></span></dt><dt><span class="section"><a href="#dynamic-language-beans-groovy">28.3.3. Groovy beans</a></span></dt><dd><dl><dt><span class="section"><a href="#dynamic-language-beans-groovy-customizer">Customising Groovy objects via a callback</a></span></dt></dl></dd><dt><span class="section"><a href="#dynamic-language-beans-bsh">28.3.4. BeanShell beans</a></span></dt></dl></dd><dt><span class="section"><a href="#dynamic-language-scenarios">28.4. Scenarios</a></span></dt><dd><dl><dt><span class="section"><a href="#dynamic-language-scenarios-controllers">28.4.1. Scripted Spring MVC Controllers</a></span></dt><dt><span class="section"><a href="#dynamic-language-scenarios-validators">28.4.2. Scripted Validators</a></span></dt></dl></dd><dt><span class="section"><a href="#dynamic-language-final-notes">28.5. Bits and bobs</a></span></dt><dd><dl><dt><span class="section"><a href="#dynamic-language-final-notes-aop">28.5.1. AOP - advising scripted beans</a></span></dt><dt><span class="section"><a href="#dynamic-language-final-notes-scopes">28.5.2. Scoping</a></span></dt></dl></dd><dt><span class="section"><a href="#dynamic-language-resources">28.6. Further Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#cache">29. Cache Abstraction</a></span></dt><dd><dl><dt><span class="section"><a href="#cache-introduction">29.1. Introduction</a></span></dt><dt><span class="section"><a href="#cache-strategies">29.2. Understanding the cache abstraction</a></span></dt><dt><span class="section"><a href="#cache-annotations">29.3. Declarative annotation-based caching</a></span></dt><dd><dl><dt><span class="section"><a href="#cache-annotations-cacheable">29.3.1. @Cacheable annotation</a></span></dt><dd><dl><dt><span class="section"><a href="#cache-annotations-cacheable-default-key">Default Key Generation</a></span></dt><dt><span class="section"><a href="#cache-annotations-cacheable-key">Custom Key Generation Declaration</a></span></dt><dt><span class="section"><a href="#cache-annotations-cacheable-condition">Conditional caching</a></span></dt><dt><span class="section"><a href="#cache-spel-context">Available caching SpEL evaluation context</a></span></dt></dl></dd><dt><span class="section"><a href="#cache-annotations-put">29.3.2. @CachePut annotation</a></span></dt><dt><span class="section"><a href="#cache-annotations-evict">29.3.3. @CacheEvict annotation</a></span></dt><dt><span class="section"><a href="#cache-annotations-caching">29.3.4. @Caching annotation</a></span></dt><dt><span class="section"><a href="#cache-annotation-enable">29.3.5. Enable caching annotations</a></span></dt><dt><span class="section"><a href="#cache-annotation-stereotype">29.3.6. Using custom annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#cache-declarative-xml">29.4. Declarative XML-based caching</a></span></dt><dt><span class="section"><a href="#cache-store-configuration">29.5. Configuring the cache storage</a></span></dt><dd><dl><dt><span class="section"><a href="#cache-store-configuration-jdk">29.5.1. JDK ConcurrentMap-based Cache</a></span></dt><dt><span class="section"><a href="#cache-store-configuration-ehcache">29.5.2. EhCache-based Cache</a></span></dt><dt><span class="section"><a href="#cache-store-configuration-gemfire">29.5.3. GemFire-based Cache</a></span></dt><dt><span class="section"><a href="#cache-store-configuration-noop">29.5.4. Dealing with caches without a backing store</a></span></dt></dl></dd><dt><span class="section"><a href="#cache-plug">29.6. Plugging-in different back-end caches</a></span></dt><dt><span class="section"><a href="#cache-specific-config">29.7. How can I set the TTL/TTI/Eviction policy/XXX feature?</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-appendices">VII. Appendices</a></span></dt><dd><dl><dt><span class="chapter"><a href="#migration-4.0">30. Migrating to Spring Framework 4.0</a></span></dt><dt><span class="chapter"><a href="#classic-spring">31. Classic Spring Usage</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-spring-orm">31.1. Classic ORM usage</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-spring-hibernate">31.1.1. Hibernate</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-hibernate-template">the HibernateTemplate</a></span></dt><dt><span class="section"><a href="#orm-hibernate-daos">Implementing Spring-based DAOs without callbacks</a></span></dt></dl></dd><dt><span class="section"><a href="#classic-spring-jdo">31.1.2. JDO</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-jdo-template">JdoTemplate and <code class="literal">JdoDaoSupport</code></a></span></dt></dl></dd><dt><span class="section"><a href="#classic-spring-jpa">31.1.3. JPA</a></span></dt><dd><dl><dt><span class="section"><a href="#orm-jpa-template">JpaTemplate and <code class="literal">JpaDaoSupport</code></a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#clasic-spring-mvc">31.2. Classic Spring MVC</a></span></dt><dt><span class="section"><a href="#classic-spring-jms">31.3. JMS Usage</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-spring-jms-template">31.3.1. JmsTemplate</a></span></dt><dt><span class="section"><a href="#classic-spring-aysnc-messages">31.3.2. Asynchronous Message Reception</a></span></dt><dt><span class="section"><a href="#classic-spring-jms-connections">31.3.3. Connections</a></span></dt><dt><span class="section"><a href="#classic-spring-jms-tx-management">31.3.4. Transaction Management</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#classic-aop-spring">32. Classic Spring AOP Usage</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-api-pointcuts">32.1. Pointcut API in Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-api-concepts">32.1.1. Concepts</a></span></dt><dt><span class="section"><a href="#classic-aop-api-pointcut-ops">32.1.2. Operations on pointcuts</a></span></dt><dt><span class="section"><a href="#classic-aop-api-pointcuts-aspectj">32.1.3. AspectJ expression pointcuts</a></span></dt><dt><span class="section"><a href="#classic-aop-api-pointcuts-impls">32.1.4. Convenience pointcut implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-api-pointcuts-static">Static pointcuts</a></span></dt><dt><span class="section"><a href="#classic-aop-api-pointcuts-dynamic">Dynamic pointcuts</a></span></dt></dl></dd><dt><span class="section"><a href="#classic-aop-api-pointcuts-superclasses">32.1.5. Pointcut superclasses</a></span></dt><dt><span class="section"><a href="#classic-aop-api-pointcuts-custom">32.1.6. Custom pointcuts</a></span></dt></dl></dd><dt><span class="section"><a href="#classic-aop-api-advice">32.2. Advice API in Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-api-advice-lifecycle">32.2.1. Advice lifecycles</a></span></dt><dt><span class="section"><a href="#classic-aop-api-advice-types">32.2.2. Advice types in Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-api-advice-around">Interception around advice</a></span></dt><dt><span class="section"><a href="#classic-aop-api-advice-before">Before advice</a></span></dt><dt><span class="section"><a href="#classic-aop-api-advice-throws">Throws advice</a></span></dt><dt><span class="section"><a href="#classic-aop-api-advice-after-returning">After Returning advice</a></span></dt><dt><span class="section"><a href="#classic-aop-api-advice-introduction">Introduction advice</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#classic-aop-api-advisor">32.3. Advisor API in Spring</a></span></dt><dt><span class="section"><a href="#classic-aop-pfb">32.4. Using the ProxyFactoryBean to create AOP proxies</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-pfb-1">32.4.1. Basics</a></span></dt><dt><span class="section"><a href="#classic-aop-pfb-2">32.4.2. JavaBean properties</a></span></dt><dt><span class="section"><a href="#classic-aop-pfb-proxy-types">32.4.3. JDK- and CGLIB-based proxies</a></span></dt><dt><span class="section"><a href="#classic-aop-api-proxying-intf">32.4.4. Proxying interfaces</a></span></dt><dt><span class="section"><a href="#classic-aop-api-proxying-class">32.4.5. Proxying classes</a></span></dt><dt><span class="section"><a href="#classic-aop-global-advisors">32.4.6. Using <span class="emphasis"><em>global</em></span> advisors</a></span></dt></dl></dd><dt><span class="section"><a href="#classic-aop-concise-proxy">32.5. Concise proxy definitions</a></span></dt><dt><span class="section"><a href="#classic-aop-prog">32.6. Creating AOP proxies programmatically with the ProxyFactory</a></span></dt><dt><span class="section"><a href="#classic-aop-api-advised">32.7. Manipulating advised objects</a></span></dt><dt><span class="section"><a href="#classic-aop-autoproxy">32.8. Using the "autoproxy" facility</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-autoproxy-choices">32.8.1. Autoproxy bean definitions</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-api-autoproxy">BeanNameAutoProxyCreator</a></span></dt><dt><span class="section"><a href="#classic-aop-api-autoproxy-default">DefaultAdvisorAutoProxyCreator</a></span></dt><dt><span class="section"><a href="#classic-aop-api-autoproxy-abstract">AbstractAdvisorAutoProxyCreator</a></span></dt></dl></dd><dt><span class="section"><a href="#classic-aop-autoproxy-metadata">32.8.2. Using metadata-driven auto-proxying</a></span></dt></dl></dd><dt><span class="section"><a href="#classic-aop-targetsource">32.9. Using TargetSources</a></span></dt><dd><dl><dt><span class="section"><a href="#classic-aop-ts-swap">32.9.1. Hot swappable target sources</a></span></dt><dt><span class="section"><a href="#classic-aop-ts-pool">32.9.2. Pooling target sources</a></span></dt><dt><span class="section"><a href="#classic-aop-ts-prototype">32.9.3. Prototype target sources</a></span></dt><dt><span class="section"><a href="#classic-aop-ts-threadlocal">32.9.4. ThreadLocal target sources</a></span></dt></dl></dd><dt><span class="section"><a href="#classic-aop-extensibility">32.10. Defining new Advice types</a></span></dt><dt><span class="section"><a href="#classic-aop-api-resources">32.11. Further resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xsd-config">33. XML Schema-based configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#xsd-config-introduction">33.1. Introduction</a></span></dt><dt><span class="section"><a href="#xsd-config-body">33.2. XML Schema-based configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#xsd-config-body-referencing">33.2.1. Referencing the schemas</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-util">33.2.2. the util schema</a></span></dt><dd><dl><dt><span class="section"><a href="#xsd-config-body-schemas-util-constant">&lt;util:constant/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-util-property-path">&lt;util:property-path/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-util-properties">&lt;util:properties/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-util-list">&lt;util:list/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-util-map">&lt;util:map/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-util-set">&lt;util:set/&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="#xsd-config-body-schemas-jee">33.2.3. the jee schema</a></span></dt><dd><dl><dt><span class="section"><a href="#xsd-config-body-schemas-jee-jndi-lookup">&lt;jee:jndi-lookup/&gt; (simple)</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-jee-jndi-lookup-environment-single">&lt;jee:jndi-lookup/&gt; (with single JNDI environment setting)</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-jee-jndi-lookup-evironment-multiple">&lt;jee:jndi-lookup/&gt; (with multiple JNDI environment settings)</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-jee-jndi-lookup-complex">&lt;jee:jndi-lookup/&gt; (complex)</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-jee-local-slsb">&lt;jee:local-slsb/&gt; (simple)</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-jee-local-slsb-complex">&lt;jee:local-slsb/&gt; (complex)</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-jee-remote-slsb">&lt;jee:remote-slsb/&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="#xsd-config-body-schemas-lang">33.2.4. the lang schema</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-jms">33.2.5. the jms schema</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-tx">33.2.6. the tx (transaction) schema</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-aop">33.2.7. the aop schema</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-context">33.2.8. the context schema</a></span></dt><dd><dl><dt><span class="section"><a href="#xsd-config-body-schemas-context-pphc">&lt;property-placeholder/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-context-ac">&lt;annotation-config/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-context-component-scan">&lt;component-scan/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-context-ltw">&lt;load-time-weaver/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-context-sc">&lt;spring-configured/&gt;</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-context-mbe">&lt;mbean-export/&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="#xsd-config-body-schemas-tool">33.2.9. the tool schema</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-jdbc">33.2.10. the jdbc schema</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-cache">33.2.11. the cache schema</a></span></dt><dt><span class="section"><a href="#xsd-config-body-schemas-beans">33.2.12. the beans schema</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#extensible-xml">34. Extensible XML authoring</a></span></dt><dd><dl><dt><span class="section"><a href="#extensible-xml-introduction">34.1. Introduction</a></span></dt><dt><span class="section"><a href="#extensible-xml-schema">34.2. Authoring the schema</a></span></dt><dt><span class="section"><a href="#extensible-xml-namespacehandler">34.3. Coding a NamespaceHandler</a></span></dt><dt><span class="section"><a href="#extensible-xml-parser">34.4. nDefinitionParser</a></span></dt><dt><span class="section"><a href="#extensible-xml-registration">34.5. Registering the handler and the schema</a></span></dt><dd><dl><dt><span class="section"><a href="#extensible-xml-registration-spring-handlers">34.5.1. <span class="emphasis"><em>META-INF/spring.handlers</em></span></a></span></dt><dt><span class="section"><a href="#extensible-xml-registration-spring-schemas">34.5.2. <span class="emphasis"><em>META-INF/spring.schemas</em></span></a></span></dt></dl></dd><dt><span class="section"><a href="#extensible-xml-using">34.6. Using a custom extension in your Spring XML configuration</a></span></dt><dt><span class="section"><a href="#extensible-xml-meat">34.7. Meatier examples</a></span></dt><dd><dl><dt><span class="section"><a href="#extensible-xml-custom-nested">34.7.1. Nesting custom tags within custom tags</a></span></dt><dt><span class="section"><a href="#extensible-xml-custom-just-attributes">34.7.2. Custom attributes on <span class="emphasis"><em>normal</em></span> elements</a></span></dt></dl></dd><dt><span class="section"><a href="#extensible-xml-resources">34.8. Further Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#spring.tld">35. spring.tld</a></span></dt><dd><dl><dt><span class="section"><a href="#spring.tld-intro">35.1. Introduction</a></span></dt><dt><span class="section"><a href="#spring.tld.bind">35.2. the bind tag</a></span></dt><dt><span class="section"><a href="#spring.tld.escapeBody">35.3. the escapeBody tag</a></span></dt><dt><span class="section"><a href="#spring.tld.hasBindErrors">35.4. the hasBindErrors tag</a></span></dt><dt><span class="section"><a href="#spring.tld.htmlEscape">35.5. the htmlEscape tag</a></span></dt><dt><span class="section"><a href="#spring.tld.message">35.6. the message tag</a></span></dt><dt><span class="section"><a href="#spring.tld.nestedPath">35.7. the nestedPath tag</a></span></dt><dt><span class="section"><a href="#spring.tld.theme">35.8. the theme tag</a></span></dt><dt><span class="section"><a href="#spring.tld.transform">35.9. the transform tag</a></span></dt><dt><span class="section"><a href="#spring.tld.url">35.10. the url tag</a></span></dt><dt><span class="section"><a href="#spring.tld.eval">35.11. the eval tag</a></span></dt></dl></dd><dt><span class="chapter"><a href="#spring-form.tld">36. spring-form.tld</a></span></dt><dd><dl><dt><span class="section"><a href="#spring-form.tld-intro">36.1. Introduction</a></span></dt><dt><span class="section"><a href="#spring-form.tld.checkbox">36.2. the checkbox tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.checkboxes">36.3. the checkboxes tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.errors">36.4. the errors tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.form">36.5. the form tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.hidden">36.6. the hidden tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.input">36.7. the input tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.label">36.8. the label tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.option">36.9. the option tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.options">36.10. the options tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.password">36.11. the password tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.radiobutton">36.12. the radiobutton tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.radiobuttons">36.13. the radiobuttons tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.select">36.14. the select tag</a></span></dt><dt><span class="section"><a href="#spring-form.tld.textarea">36.15. the textarea tag</a></span></dt></dl></dd></dl></dd></dl></div>

<div class="part" title="Part&nbsp;I.&nbsp;Overview of Spring Framework"><div class="titlepage"><div><div><h1 class="title"><a name="spring-introduction"></a>Part&nbsp;I.&nbsp;Overview of Spring Framework</h1></div></div></div>

<div class="partintro" title="Overview of Spring Framework"><div></div>
<p>The Spring Framework is a lightweight solution and a potential one-stop-shop for
building your enterprise-ready applications. However, Spring is modular, allowing you to
use only those parts that you need, without having to bring in the rest. You can use the
IoC container, with Struts on top, but you can also use only the
<a class="link" href="#orm-hibernate" title="14.3&nbsp;Hibernate">Hibernate integration code</a> or the <a class="link" href="#jdbc-introduction" title="13.1&nbsp;Introduction to Spring Framework JDBC">JDBC abstraction
layer</a>. The Spring Framework supports declarative transaction management, remote access
to your logic through RMI or web services, and various options for persisting your data.
It offers a full-featured <a class="link" href="#mvc-introduction" title="16.1&nbsp;Introduction to Spring Web MVC framework">MVC framework</a>, and enables you to
integrate <a class="link" href="#aop-introduction" title="8.1&nbsp;Introduction">AOP</a> transparently into your software.</p>
<p>Spring is designed to be non-intrusive, meaning that your domain logic code generally
has no dependencies on the framework itself. In your integration layer (such as the data
access layer), some dependencies on the data access technology and the Spring libraries
will exist. However, it should be easy to isolate these dependencies from the rest of
your code base.</p>
<p>This document is a reference guide to Spring Framework features. If you have any
requests, comments, or questions on this document, please post them on the user mailing
list or on the support forums at <a class="ulink" href="http://forum.spring.io/" target="_top">http://forum.spring.io/</a>.</p>
</div>
<div class="chapter" title="1.&nbsp;Getting Started With Spring"><div class="titlepage"><div><div><h2 class="title"><a name="overview-getting-started-with-spring"></a>1.&nbsp;Getting Started With Spring</h2></div></div></div>

<p>This reference guide provides detailed information about the Spring Framework.
It provides comprehensive documentation for all features, as well as some background
about the underlying concepts (such as <span class="emphasis"><em>"Dependency Injection"</em></span>) that Spring has
embraced.</p>
<p>If you are just getting started with Spring, you may want to begin with the lighter
<a class="ulink" href="https://spring.io/guides" target="_top">"Getting Started"</a> guides that are available from
<a class="ulink" href="http://spring.io" target="_top">http://spring.io</a>. As well as being easier to digest, these guide are very
<span class="emphasis"><em>task focused</em></span>. They also cover other projects from the Spring portfolio that you might
 want to consider when solving a particular problem.</p>
<p><a class="ulink" href="https://spring.io/guides/gs/rest-service/" target="_top">Getting Started Building a RESTful Web Service</a>
would be an excellent first choice to get your feet wet.</p>
</div>
<div class="chapter" title="2.&nbsp;Introduction to Spring Framework"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>2.&nbsp;Introduction to Spring Framework</h2></div></div></div>

<p>Spring Framework is a Java platform that provides comprehensive infrastructure support
for developing Java applications. Spring handles the infrastructure so you can focus on
your application.</p>
<p>Spring enables you to build applications from "plain old Java objects" (POJOs) and to
apply enterprise services non-invasively to POJOs. This capability applies to the Java
SE programming model and to full and partial Java EE.</p>
<p>Examples of how you, as an application developer, can use the Spring platform advantage:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Make a Java method execute in a database transaction without having to deal with
transaction APIs.
</li><li class="listitem">
Make a local Java method a remote procedure without having to deal with remote APIs.
</li><li class="listitem">
Make a local Java method a management operation without having to deal with JMX APIs.
</li><li class="listitem">
Make a local Java method a message handler without having to deal with JMS APIs.
</li></ul></div>

<div class="section" title="2.1&nbsp;Dependency Injection and Inversion of Control"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-dependency-injection"></a>2.1&nbsp;Dependency Injection and Inversion of Control</h2></div></div></div>

<div class="sidebar" title="Background"><a name="background-ioc"></a><p class="title"><b>Background</b></p>

<p>"<span class="emphasis"><em>The question is, what aspect of control are [they] inverting?</em></span>" Martin Fowler posed
this question about Inversion of Control (IoC) on his site in 2004. Fowler suggested
renaming the principle to make it more self-explanatory and came up with <span class="emphasis"><em>Dependency
Injection</em></span>.</p>
<p>For insight into IoC and DI, refer to Fowler&#8217;s article at
<a class="ulink" href="http://martinfowler.com/articles/injection.html" target="_top">http://martinfowler.com/articles/injection.html</a>.</p>
</div>

<p>Java applications&#8201;&#8212;&#8201;a loose term that runs the gamut from constrained applets to n-tier
server-side enterprise applications&#8201;&#8212;&#8201;typically consist of objects that collaborate to
form the application proper. Thus the objects in an application have <span class="emphasis"><em>dependencies</em></span> on
each other.</p>
<p>Although the Java platform provides a wealth of application development functionality,
it lacks the means to organize the basic building blocks into a coherent whole, leaving
that task to architects and developers. True, you can use design patterns such
as <span class="emphasis"><em>Factory</em></span>, <span class="emphasis"><em>Abstract Factory</em></span>, <span class="emphasis"><em>Builder</em></span>, <span class="emphasis"><em>Decorator</em></span>, and <span class="emphasis"><em>Service Locator</em></span>
to compose the various classes and object instances that make up an application.
However, these patterns are simply that: best practices given a name, with a description
of what the pattern does, where to apply it, the problems it addresses, and so forth.
Patterns are formalized best practices that <span class="emphasis"><em>you must implement yourself</em></span> in your
application.</p>
<p>The Spring Framework <span class="emphasis"><em>Inversion of Control</em></span> (IoC) component addresses this concern by
providing a formalized means of composing disparate components into a fully working
application ready for use. The Spring Framework codifies formalized design patterns as
first-class objects that you can integrate into your own application(s). Numerous
organizations and institutions use the Spring Framework in this manner to engineer
robust, <span class="emphasis"><em>maintainable</em></span> applications.</p>
</div>
<div class="section" title="2.2&nbsp;Modules"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-modules"></a>2.2&nbsp;Modules</h2></div></div></div>

<p>The Spring Framework consists of features organized into about 20 modules. These modules
are grouped into Core Container, Data Access/Integration, Web, AOP (Aspect Oriented
Programming), Instrumentation, and Test, as shown in the following diagram.</p>
<div class="figure"><a name="d4e195"></a><p class="title"><b>Figure&nbsp;2.1.&nbsp;Overview of the Spring Framework</b></p><div class="figure-contents">

  <div class="mediaobject"><img src="images/spring-overview.png" alt="spring overview"></div>
</div></div><br class="figure-break">

<div class="section" title="2.2.1&nbsp;Core Container"><div class="titlepage"><div><div><h3 class="title"><a name="overview-core-container"></a>2.2.1&nbsp;Core Container</h3></div></div></div>

<p>The <a class="link" href="#beans-introduction" title="4.1&nbsp;Introduction to the Spring IoC container and beans"><span class="emphasis"><em>Core Container</em></span></a> consists of the Core, Beans, Context, and
Expression Language modules.</p>
<p>The <a class="link" href="#beans-introduction" title="4.1&nbsp;Introduction to the Spring IoC container and beans"><span class="emphasis"><em>Core and Beans</em></span></a> modules provide the fundamental parts of
the framework, including the IoC and Dependency Injection features. The <code class="literal">BeanFactory</code> is
a sophisticated implementation of the factory pattern. It removes the need for
programmatic singletons and allows you to decouple the configuration and specification
of dependencies from your actual program logic.</p>
<p>The <a class="link" href="#context-introduction" title="4.16&nbsp;Additional Capabilities of the ApplicationContext"><span class="emphasis"><em>Context</em></span></a> module builds on the solid base provided by the
<a class="link" href="#beans-introduction" title="4.1&nbsp;Introduction to the Spring IoC container and beans"><span class="emphasis"><em>Core and Beans</em></span></a> modules: it is a means to access objects in a
framework-style manner that is similar to a JNDI registry. The Context module inherits
its features from the Beans module and adds support for internationalization (using, for
example, resource bundles), event-propagation, resource-loading, and the transparent
creation of contexts by, for example, a servlet container. The Context module also
supports Java EE features such as EJB, JMX ,and basic remoting. The <code class="literal">ApplicationContext</code>
interface is the focal point of the Context module.</p>
<p>The <a class="link" href="#expressions" title="7.&nbsp;Spring Expression Language (SpEL)"><span class="emphasis"><em>Expression Language</em></span></a> module provides a powerful expression
language for querying and manipulating an object graph at runtime. It is an extension of
the unified expression language (unified EL) as specified in the JSP 2.1 specification.
The language supports setting and getting property values, property assignment, method
invocation, accessing the context of arrays, collections and indexers, logical and
arithmetic operators, named variables, and retrieval of objects by name from Spring&#8217;s
IoC container. It also supports list projection and selection as well as common list
aggregations.</p>
</div>
<div class="section" title="2.2.2&nbsp;Data Access/Integration"><div class="titlepage"><div><div><h3 class="title"><a name="overview-data-access"></a>2.2.2&nbsp;Data Access/Integration</h3></div></div></div>

<p>The <span class="emphasis"><em>Data Access/Integration</em></span> layer consists of the JDBC, ORM, OXM, JMS and
Transaction modules.</p>
<p>The <a class="link" href="#jdbc-introduction" title="13.1&nbsp;Introduction to Spring Framework JDBC">JDBC</a> module provides a JDBC-abstraction layer that removes the
need to do tedious JDBC coding and parsing of database-vendor specific error codes.</p>
<p>The <a class="link" href="#orm-introduction" title="14.1&nbsp;Introduction to ORM with Spring"><span class="emphasis"><em>ORM</em></span></a> module provides integration layers for popular
object-relational mapping APIs, including <a class="link" href="#orm-jpa" title="14.5&nbsp;JPA">JPA</a>, <a class="link" href="#orm-jdo" title="14.4&nbsp;JDO">JDO</a>, and
<a class="link" href="#orm-hibernate" title="14.3&nbsp;Hibernate">Hibernate</a>. Using the ORM package you can use all of these O/R-mapping
frameworks in combination with all of the other features Spring offers, such as the simple
declarative transaction management feature mentioned previously.</p>
<p>The <a class="link" href="#oxm" title="15.&nbsp;Marshalling XML using O/X Mappers">OXM</a> module provides an abstraction layer that supports Object/XML mapping
implementations for JAXB, Castor, XMLBeans, JiBX and XStream.</p>
<p>The Java Messaging Service (<a class="link" href="#jms" title="23.&nbsp;JMS (Java Message Service)">JMS</a>) module contains features for producing and
consuming messages.</p>
<p>The <a class="link" href="#transaction" title="11.&nbsp;Transaction Management">Transaction</a> module supports programmatic and declarative transaction
management for classes that implement special interfaces and for <span class="emphasis"><em>all your POJOs (plain
old Java objects)</em></span>.</p>
</div>
<div class="section" title="2.2.3&nbsp;Web"><div class="titlepage"><div><div><h3 class="title"><a name="overview-web"></a>2.2.3&nbsp;Web</h3></div></div></div>

<p>The <span class="emphasis"><em>Web</em></span> layer consists of the Web, Web-Servlet, WebSocket and Web-Portlet modules.</p>
<p>Spring&#8217;s <span class="emphasis"><em>Web</em></span> module provides basic web-oriented integration features such as
multipart file-upload functionality and the initialization of the IoC container using
servlet listeners and a web-oriented application context. It also contains the
web-related parts of Spring&#8217;s remoting support.</p>
<p>The <span class="emphasis"><em>Web-Servlet</em></span> module contains Spring&#8217;s model-view-controller
(<a class="link" href="#mvc-introduction" title="16.1&nbsp;Introduction to Spring Web MVC framework"><span class="emphasis"><em>MVC</em></span></a>) implementation for web applications. Spring&#8217;s MVC
framework provides a clean separation between domain model code and web forms, and
integrates with all the other features of the Spring Framework.</p>
<p>The <span class="emphasis"><em>Web-Portlet</em></span> module provides the MVC implementation to be used in a portlet
environment and mirrors the functionality of Web-Servlet module.</p>
</div>
<div class="section" title="2.2.4&nbsp;AOP and Instrumentation"><div class="titlepage"><div><div><h3 class="title"><a name="overview-aop-instrumentation"></a>2.2.4&nbsp;AOP and Instrumentation</h3></div></div></div>

<p>Spring&#8217;s <a class="link" href="#aop-introduction" title="8.1&nbsp;Introduction"><span class="emphasis"><em>AOP</em></span></a> module provides an <span class="emphasis"><em>AOP Alliance</em></span>-compliant
aspect-oriented programming implementation allowing you to define, for example,
method-interceptors and pointcuts to cleanly decouple code that implements functionality
that should be separated. Using source-level metadata functionality, you can also
incorporate behavioral information into your code, in a manner similar to that of .NET
attributes.</p>
<p>The separate <span class="emphasis"><em>Aspects</em></span> module provides integration with AspectJ.</p>
<p>The <span class="emphasis"><em>Instrumentation</em></span> module provides class instrumentation support and classloader
implementations to be used in certain application servers.</p>
</div>
<div class="section" title="2.2.5&nbsp;Test"><div class="titlepage"><div><div><h3 class="title"><a name="overview-testing"></a>2.2.5&nbsp;Test</h3></div></div></div>

<p>The <span class="emphasis"><em>Test</em></span> module supports the testing of Spring components with JUnit or TestNG. It
provides consistent loading of Spring ApplicationContexts and caching of those contexts.
It also provides mock objects that you can use to test your code in isolation.</p>
</div>
</div>
<div class="section" title="2.3&nbsp;Usage scenarios"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-usagescenarios"></a>2.3&nbsp;Usage scenarios</h2></div></div></div>

<p>The building blocks described previously make Spring a logical choice in many scenarios,
from applets to full-fledged enterprise applications that use Spring&#8217;s transaction
management functionality and web framework integration.</p>
<div class="figure"><a name="d4e268"></a><p class="title"><b>Figure&nbsp;2.2.&nbsp;Typical full-fledged Spring web application</b></p><div class="figure-contents">

  <div class="mediaobject"><img src="images/overview-full.png" alt="overview full"></div>
</div></div><br class="figure-break">

<p>Spring&#8217;s <a class="link" href="#transaction-declarative" title="11.5&nbsp;Declarative transaction management">declarative transaction management features</a> make
the web application fully transactional, just as it would be if you used EJB
container-managed transactions. All your custom business logic can be implemented with
simple POJOs and managed by Spring&#8217;s IoC container. Additional services include support
for sending email and validation that is independent of the web layer, which lets you
choose where to execute validation rules. Spring&#8217;s ORM support is integrated with JPA,
Hibernate and and JDO; for example, when using Hibernate, you can continue to use
your existing mapping files and standard Hibernate <code class="literal">SessionFactory</code> configuration. Form
controllers seamlessly integrate the web-layer with the domain model, removing the need
for <code class="literal">ActionForms</code> or other classes that transform HTTP parameters to values for your
domain model.</p>
<div class="figure"><a name="d4e279"></a><p class="title"><b>Figure&nbsp;2.3.&nbsp;Spring middle-tier using a third-party web framework</b></p><div class="figure-contents">

  <div class="mediaobject"><img src="images/overview-thirdparty-web.png" alt="overview thirdparty web"></div>
</div></div><br class="figure-break">

<p>Sometimes circumstances do not allow you to completely switch to a different framework.
The Spring Framework does <span class="emphasis"><em>not</em></span> force you to use everything within it; it is not an
<span class="emphasis"><em>all-or-nothing</em></span> solution. Existing front-ends built with Struts, Tapestry, JSF
or other UI frameworks can be integrated with a Spring-based middle-tier, which allows
you to use Spring transaction features. You simply need to wire up your business logic
using an <code class="literal">ApplicationContext</code> and use a <code class="literal">WebApplicationContext</code> to integrate your web
layer.</p>
<div class="figure"><a name="d4e291"></a><p class="title"><b>Figure&nbsp;2.4.&nbsp;Remoting usage scenario</b></p><div class="figure-contents">

  <div class="mediaobject"><img src="images/overview-remoting.png" alt="overview remoting"></div>
</div></div><br class="figure-break">

<p>When you need to access existing code through web services, you can use Spring&#8217;s
<code class="literal">Hessian-</code>, <code class="literal">Burlap-</code>, <code class="literal">Rmi-</code> or <code class="literal">JaxRpcProxyFactory</code> classes. Enabling remote access to
existing applications is not difficult.</p>
<div class="figure"><a name="d4e303"></a><p class="title"><b>Figure&nbsp;2.5.&nbsp;EJBs - Wrapping existing POJOs</b></p><div class="figure-contents">

  <div class="mediaobject"><img src="images/overview-ejb.png" alt="overview ejb"></div>
</div></div><br class="figure-break">

<p>The Spring Framework also provides an <a class="link" href="#ejb" title="22.&nbsp;Enterprise JavaBeans (EJB) integration">access and abstraction layer</a> for
Enterprise JavaBeans, enabling you to reuse your existing POJOs and wrap them in
stateless session beans for use in scalable, fail-safe web applications that might need
declarative security.</p>
<div class="section" title="2.3.1&nbsp;Dependency Management and Naming Conventions"><div class="titlepage"><div><div><h3 class="title"><a name="dependency-management"></a>2.3.1&nbsp;Dependency Management and Naming Conventions</h3></div></div></div>

<p>Dependency management and dependency injection are different things. To get those nice
features of Spring into your application (like dependency injection) you need to
assemble all the libraries needed (jar files) and get them onto your classpath at
runtime, and possibly at compile time. These dependencies are not virtual components
that are injected, but physical resources in a file system (typically). The process of
dependency management involves locating those resources, storing them and adding them to
classpaths. Dependencies can be direct (e.g. my application depends on Spring at
runtime), or indirect (e.g. my application depends on <code class="literal">commons-dbcp</code> which depends on
<code class="literal">commons-pool</code>). The indirect dependencies are also known as "transitive" and it is
those dependencies that are hardest to identify and manage.</p>
<p>If you are going to use Spring you need to get a copy of the jar libraries that comprise
the pieces of Spring that you need. To make this easier Spring is packaged as a set of
modules that separate the dependencies as much as possible, so for example if you don&#8217;t
want to write a web application you don&#8217;t need the spring-web modules. To refer to
Spring library modules in this guide we use a shorthand naming convention <code class="literal">spring-*</code> or
<code class="literal">spring-*.jar,</code> where <code class="literal">*</code> represents the short name for the module (e.g. <code class="literal">spring-core</code>,
<code class="literal">spring-webmvc</code>, <code class="literal">spring-jms</code>, etc.). The actual jar file name that you use is normally
the module name concatenated with the version number
(e.g. <span class="emphasis"><em>spring-core-4.0.1.RELEASE.jar</em></span>).</p>
<p>Each release of the Spring Framework will publish artifacts to the following places:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Maven Central, which is the default repository that Maven queries, and does not
require any special configuration to use. Many of the common libraries that Spring
depends on also are available from Maven Central and a large section of the Spring
community uses Maven for dependency management, so this is convenient for them. The
names of the jars here are in the form <code class="literal">spring-*-&lt;version&gt;.jar</code> and the Maven groupId
is <code class="literal">org.springframework</code>.
</li><li class="listitem">
In a public Maven repository hosted specifically for Spring. In addition to the final
GA releases, this repository also hosts development snapshots and milestones. The jar
file names are in the same form as Maven Central, so this is a useful place to get
development versions of Spring to use with other libraries deployed in Maven Central.
This repository also contains a bundle distribution zip file that contains all Spring
jars  bundled together for easy download.
</li></ul></div>

<p>So the first thing you need to decide is how to manage your dependencies: we generally
recommend the use of an automated system like Maven, Gradle or Ivy, but you can also do
it manually by downloading all the jars yourself. We provide detailed instructions later
in this chapter.</p>
<div class="section" title="Spring Dependencies and Depending on Spring"><div class="titlepage"><div><div><h4 class="title"><a name="overview-spring-dependencies"></a>Spring Dependencies and Depending on Spring</h4></div></div></div>

<p>Although Spring provides integration and support for a huge range of enterprise and
other external tools, it intentionally keeps its mandatory dependencies to an absolute
minimum: you shouldn&#8217;t have to locate and download (even automatically) a large number
of jar libraries in order to use Spring for simple use cases. For basic dependency
injection there is only one mandatory external dependency, and that is for logging (see
below for a more detailed description of logging options).</p>
<p>Next we outline the basic steps needed to configure an application that depends on
Spring, first with Maven and then with Gradle and finally using Ivy. In all cases, if
anything is unclear, refer to the documentation of your dependency management system, or
look at some sample code - Spring itself uses Gradle to manage dependencies when it is
building, and our samples mostly use Gradle or Maven.</p>
</div>
<div class="section" title="Maven Dependency Management"><div class="titlepage"><div><div><h4 class="title"><a name="overview-maven-dependency-management"></a>Maven Dependency Management</h4></div></div></div>

<p>If you are using <a class="ulink" href="http://maven.apache.org/" target="_top">Maven</a> for dependency management you don&#8217;t even
need to supply the logging dependency explicitly. For example, to create an application
context and use dependency injection to configure an application, your Maven dependencies
will look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;dependencies&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.springframework<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>spring-context<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>4.0.1.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
        <span class="hl-tag">&lt;scope&gt;</span>runtime<span class="hl-tag">&lt;/scope&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
<span class="hl-tag">&lt;/dependencies&gt;</span></pre>

<p>That&#8217;s it. Note the scope can be declared as runtime if you don&#8217;t need to compile
against Spring APIs, which is typically the case for basic dependency injection use
cases.</p>
<p>The example above works with the Maven Central repository. To use the Spring Maven
repository (e.g. for milestones or developer snapshots), you need to specify the
repository location in your Maven configuration. For full releases:</p>
<pre class="programlisting"><span class="hl-tag">&lt;repositories&gt;</span>
    <span class="hl-tag">&lt;repository&gt;</span>
        <span class="hl-tag">&lt;id&gt;</span>io.spring.repo.maven.release<span class="hl-tag">&lt;/id&gt;</span>
        <span class="hl-tag">&lt;url&gt;</span>http://repo.spring.io/release/<span class="hl-tag">&lt;/url&gt;</span>
        <span class="hl-tag">&lt;snapshots&gt;</span><span class="hl-tag">&lt;enabled&gt;</span>false<span class="hl-tag">&lt;/enabled&gt;</span><span class="hl-tag">&lt;/snapshots&gt;</span>
    <span class="hl-tag">&lt;/repository&gt;</span>
<span class="hl-tag">&lt;/repositories&gt;</span></pre>

<p>For milestones:</p>
<pre class="programlisting"><span class="hl-tag">&lt;repositories&gt;</span>
    <span class="hl-tag">&lt;repository&gt;</span>
        <span class="hl-tag">&lt;id&gt;</span>io.spring.repo.maven.milestone<span class="hl-tag">&lt;/id&gt;</span>
        <span class="hl-tag">&lt;url&gt;</span>http://repo.spring.io/milestone/<span class="hl-tag">&lt;/url&gt;</span>
        <span class="hl-tag">&lt;snapshots&gt;</span><span class="hl-tag">&lt;enabled&gt;</span>false<span class="hl-tag">&lt;/enabled&gt;</span><span class="hl-tag">&lt;/snapshots&gt;</span>
    <span class="hl-tag">&lt;/repository&gt;</span>
<span class="hl-tag">&lt;/repositories&gt;</span></pre>

<p>And for snapshots:</p>
<pre class="programlisting"><span class="hl-tag">&lt;repositories&gt;</span>
    <span class="hl-tag">&lt;repository&gt;</span>
        <span class="hl-tag">&lt;id&gt;</span>io.spring.repo.maven.snapshot<span class="hl-tag">&lt;/id&gt;</span>
        <span class="hl-tag">&lt;url&gt;</span>http://repo.spring.io/snapshot/<span class="hl-tag">&lt;/url&gt;</span>
        <span class="hl-tag">&lt;snapshots&gt;</span><span class="hl-tag">&lt;enabled&gt;</span>true<span class="hl-tag">&lt;/enabled&gt;</span><span class="hl-tag">&lt;/snapshots&gt;</span>
    <span class="hl-tag">&lt;/repository&gt;</span>
<span class="hl-tag">&lt;/repositories&gt;</span></pre>

</div>
<div class="section" title="Maven &#34;Bill Of Materials&#34; Dependency"><div class="titlepage"><div><div><h4 class="title"><a name="overview-maven-bom"></a>Maven "Bill Of Materials" Dependency</h4></div></div></div>

<p>It is possible to accidentally mix different versions of Spring JARs when using Maven.
For example, you may find that a third-party library, or another Spring project,
pulls in a transitive dependency to an older release. If you forget to explicitly declare
a direct dependency yourself, all sorts of unexpected issues can arise.</p>
<p>To overcome such problems Maven supports the concept of a "bill of materials" (BOM)
dependency. You can import the <code class="literal">spring-framework-bom</code> in your <code class="literal">dependencyManagement</code>
section to ensure that all spring dependencies (both direct and transitive) are at
the same version.</p>
<pre class="programlisting"><span class="hl-tag">&lt;dependencyManagement&gt;</span>
    <span class="hl-tag">&lt;dependencies&gt;</span>
        <span class="hl-tag">&lt;dependency&gt;</span>
            <span class="hl-tag">&lt;groupId&gt;</span>org.springframework<span class="hl-tag">&lt;/groupId&gt;</span>
            <span class="hl-tag">&lt;artifactId&gt;</span>spring-framework-bom<span class="hl-tag">&lt;/artifactId&gt;</span>
            <span class="hl-tag">&lt;version&gt;</span>4.0.1.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
            <span class="hl-tag">&lt;type&gt;</span>pom<span class="hl-tag">&lt;/type&gt;</span>
            <span class="hl-tag">&lt;scope&gt;</span>import<span class="hl-tag">&lt;/scope&gt;</span>
        <span class="hl-tag">&lt;/dependency&gt;</span>
    <span class="hl-tag">&lt;/dependencies&gt;</span>
<span class="hl-tag">&lt;/dependencyManagement&gt;</span></pre>

<p>An added benefit of using the BOM is that you no longer need to specify the <code class="literal">&lt;version&gt;</code>
attribute when depending on Spring Framework artifacts:</p>
<pre class="programlisting"><span class="hl-tag">&lt;dependencies&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.springframework<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>spring-context<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.springframework<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>spring-web<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
<span class="hl-tag">&lt;dependencies&gt;</span></pre>

</div>
<div class="section" title="Gradle Dependency Management"><div class="titlepage"><div><div><h4 class="title"><a name="overview-gradle-dependency-management"></a>Gradle Dependency Management</h4></div></div></div>

<p>To use the Spring repository with the <a class="ulink" href="http://www.gradle.org/" target="_top">Gradle</a> build system,
include the appropriate URL in the <code class="literal">repositories</code> section:</p>
<pre class="programlisting">repositories {
    mavenCentral()
    // and optionally...
    maven { url "http://repo.spring.io/release" }
}</pre>

<p>You can change the <code class="literal">repositories</code> URL from <code class="literal">/release</code> to <code class="literal">/milestone</code> or <code class="literal">/snapshot</code> as
appropriate. Once a repository has been configured, you can declare dependencies in the
usual Gradle way:</p>
<pre class="programlisting">dependencies {
    compile("org.springframework:spring-context:4.0.1.RELEASE")
    testCompile("org.springframework:spring-test:4.0.1.RELEASE")
}</pre>

</div>
<div class="section" title="Ivy Dependency Management"><div class="titlepage"><div><div><h4 class="title"><a name="overview-ivy-dependency-management"></a>Ivy Dependency Management</h4></div></div></div>

<p>If you prefer to use <a class="ulink" href="http://ant.apache.org/ivy" target="_top">Ivy</a> to manage dependencies then there
are similar configuration options.</p>
<p>To configure Ivy to point to the Spring repository add the following resolver to your
<code class="literal">ivysettings.xml</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;resolvers&gt;</span>
    <span class="hl-tag">&lt;ibiblio</span> <span class="hl-attribute">name</span>=<span class="hl-value">"io.spring.repo.maven.release"</span>
            <span class="hl-attribute">m2compatible</span>=<span class="hl-value">"true"</span>
            <span class="hl-attribute">root</span>=<span class="hl-value">"http://repo.spring.io/release/"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/resolvers&gt;</span></pre>

<p>You can change the <code class="literal">root</code> URL from <code class="literal">/release/</code> to <code class="literal">/milestone/</code> or <code class="literal">/snapshot/</code> as
appropriate.</p>
<p>Once configured, you can add dependencies in the usual way. For example (in <code class="literal">ivy.xml</code>):</p>
<pre class="programlisting"><span class="hl-tag">&lt;dependency</span> <span class="hl-attribute">org</span>=<span class="hl-value">"org.springframework"</span>
    <span class="hl-attribute">name</span>=<span class="hl-value">"spring-core"</span> <span class="hl-attribute">rev</span>=<span class="hl-value">"4.0.1.RELEASE"</span> <span class="hl-attribute">conf</span>=<span class="hl-value">"compile-&gt;runtime"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="Distribution Zip Files"><div class="titlepage"><div><div><h4 class="title"><a name="overview-distribution-zip"></a>Distribution Zip Files</h4></div></div></div>

<p>Although using a build system that supports dependency management is the recommended
way to obtain the Spring Framework, it is still possible to download a distribution
zip file.</p>
<p>Distribution zips are published to the Spring Maven Repository (this is just for our
convenience, you don&#8217;t need Maven or any other build system in order to download them).</p>
<p>To download a distribution zip open a web browser to
<a class="ulink" href="http://repo.spring.io/release/org/springframework/spring" target="_top">http://repo.spring.io/release/org/springframework/spring</a> and select the appropriate
subfolder for the version that you want. Distribution files end <code class="literal">-dist.zip</code>, for example
<code class="literal">spring-framework-4.0.1.RELEASE-RELEASE-dist.zip</code>. Distributions are also published
for <a class="ulink" href="http://repo.spring.io/milestone/org/springframework/spring" target="_top">milestones</a> and
<a class="ulink" href="http://repo.spring.io/snapshot/org/springframework/spring" target="_top">snapshots</a>.</p>
</div>
</div>
<div class="section" title="2.3.2&nbsp;Logging"><div class="titlepage"><div><div><h3 class="title"><a name="overview-logging"></a>2.3.2&nbsp;Logging</h3></div></div></div>

<p>Logging is a very important dependency for Spring because <span class="emphasis"><em>a)</em></span> it is the only mandatory
external dependency, <span class="emphasis"><em>b)</em></span> everyone likes to see some output from the tools they are
using, and <span class="emphasis"><em>c)</em></span> Spring integrates with lots of other tools all of which have also made
a choice of logging dependency. One of the goals of an application developer is often to
have unified logging configured in a central place for the whole application, including
all external components. This is more difficult than it might have been since there are so
many choices of logging framework.</p>
<p>The mandatory logging dependency in Spring is the Jakarta Commons Logging API (JCL). We
compile against JCL and we also make JCL <code class="literal">Log</code> objects visible for classes that extend
the Spring Framework. It&#8217;s important to users that all versions of Spring use the same
logging library: migration is easy because backwards compatibility is preserved even
with applications that extend Spring. The way we do this is to make one of the modules
in Spring depend explicitly on <code class="literal">commons-logging</code> (the canonical implementation of JCL),
and then make all the other modules depend on that at compile time. If you are using
Maven for example, and wondering where you picked up the dependency on
<code class="literal">commons-logging</code>, then it is from Spring and specifically from the central module
called <code class="literal">spring-core</code>.</p>
<p>The nice thing about <code class="literal">commons-logging</code> is that you don&#8217;t need anything else to make your
application work. It has a runtime discovery algorithm that looks for other logging
frameworks in well known places on the classpath and uses one that it thinks is
appropriate (or you can tell it which one if you need to). If nothing else is available
you get pretty nice looking logs just from the JDK (java.util.logging or JUL for short).
You should find that your Spring application works and logs happily to the console out
of the box in most situations, and that&#8217;s important.</p>
<div class="section" title="Not Using Commons Logging"><div class="titlepage"><div><div><h4 class="title"><a name="overview-not-using-commons-logging"></a>Not Using Commons Logging</h4></div></div></div>

<p>Unfortunately, the runtime discovery algorithm in <code class="literal">commons-logging</code>, while convenient
for the end-user, is problematic. If we could turn back the clock and start Spring now
as a new project it would use a different logging dependency. The first choice would
probably be the Simple Logging Facade for Java ( <a class="ulink" href="http://www.slf4j.org" target="_top">SLF4J</a>), which is
also used by a lot of other tools that people use with Spring inside their applications.</p>
<p>There are basically two ways to switch off <code class="literal">commons-logging</code>:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Exclude the dependency from the <code class="literal">spring-core</code> module (as it is the only module that
explicitly depends on <code class="literal">commons-logging</code>)
</li><li class="listitem">
Depend on a special <code class="literal">commons-logging</code> dependency that replaces the library with
an empty jar (more details can be found in the
<a class="ulink" href="http://slf4j.org/faq.html#excludingJCL" target="_top">SLF4J FAQ</a>)
</li></ol></div>

<p>To exclude commons-logging, add the following to your <code class="literal">dependencyManagement</code> section:</p>
<pre class="programlisting"><span class="hl-tag">&lt;dependencies&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.springframework<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>spring-core<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>4.0.1.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
        <span class="hl-tag">&lt;exclusions&gt;</span>
            <span class="hl-tag">&lt;exclusion&gt;</span>
                <span class="hl-tag">&lt;groupId&gt;</span>commons-logging<span class="hl-tag">&lt;/groupId&gt;</span>
                <span class="hl-tag">&lt;artifactId&gt;</span>commons-logging<span class="hl-tag">&lt;/artifactId&gt;</span>
            <span class="hl-tag">&lt;/exclusion&gt;</span>
        <span class="hl-tag">&lt;/exclusions&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
<span class="hl-tag">&lt;/dependencies&gt;</span></pre>

<p>Now this application is probably broken because there is no implementation of the JCL
API on the classpath, so to fix it a new one has to be provided. In the next section we
show you how to provide an alternative implementation of JCL using SLF4J as an example.</p>
</div>
<div class="section" title="Using SLF4J"><div class="titlepage"><div><div><h4 class="title"><a name="overview-logging-slf4j"></a>Using SLF4J</h4></div></div></div>

<p>SLF4J is a cleaner dependency and more efficient at runtime than <code class="literal">commons-logging</code>
because it uses compile-time bindings instead of runtime discovery of the other logging
frameworks it integrates. This also means that you have to be more explicit about what
you want to happen at runtime, and declare it or configure it accordingly. SLF4J
provides bindings to many common logging frameworks, so you can usually choose one that
you already use, and bind to that for configuration and management.</p>
<p>SLF4J provides bindings to many common logging frameworks, including JCL, and it also
does the reverse: bridges between other logging frameworks and itself. So to use SLF4J
with Spring you need to replace the <code class="literal">commons-logging</code> dependency with the SLF4J-JCL
bridge. Once you have done that then logging calls from within Spring will be translated
into logging calls to the SLF4J API, so if other libraries in your application use that
API, then you have a single place to configure and manage logging.</p>
<p>A common choice might be to bridge Spring to SLF4J, and then provide explicit binding
from SLF4J to Log4J. You need to supply 4 dependencies (and exclude the existing
<code class="literal">commons-logging</code>): the bridge, the SLF4J API, the binding to Log4J, and the Log4J
implementation itself. In Maven you would do that like this</p>
<pre class="programlisting"><span class="hl-tag">&lt;dependencies&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.springframework<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>spring-core<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>4.0.1.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
        <span class="hl-tag">&lt;exclusions&gt;</span>
            <span class="hl-tag">&lt;exclusion&gt;</span>
                <span class="hl-tag">&lt;groupId&gt;</span>commons-logging<span class="hl-tag">&lt;/groupId&gt;</span>
                <span class="hl-tag">&lt;artifactId&gt;</span>commons-logging<span class="hl-tag">&lt;/artifactId&gt;</span>
            <span class="hl-tag">&lt;/exclusion&gt;</span>
        <span class="hl-tag">&lt;/exclusions&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.slf4j<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>jcl-over-slf4j<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>1.5.8<span class="hl-tag">&lt;/version&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.slf4j<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>slf4j-api<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>1.5.8<span class="hl-tag">&lt;/version&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.slf4j<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>slf4j-log4j12<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>1.5.8<span class="hl-tag">&lt;/version&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>log4j<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>log4j<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>1.2.14<span class="hl-tag">&lt;/version&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
<span class="hl-tag">&lt;/dependencies&gt;</span></pre>

<p>That might seem like a lot of dependencies just to get some logging. Well it is, but it
<span class="emphasis"><em>is</em></span> optional, and it should behave better than the vanilla <code class="literal">commons-logging</code> with
respect to classloader issues, notably if you are in a strict container like an OSGi
platform. Allegedly there is also a performance benefit because the bindings are at
compile-time not runtime.</p>
<p>A more common choice amongst SLF4J users, which uses fewer steps and generates fewer
dependencies, is to bind directly to <a class="ulink" href="http://logback.qos.ch" target="_top">Logback</a>. This removes the
extra binding step because Logback implements SLF4J directly, so you only need to depend
on two libraries not four ( <code class="literal">jcl-over-slf4j</code> and <code class="literal">logback</code>). If you do that you might
also need to exclude the slf4j-api dependency from other external dependencies (not
Spring), because you only want one version of that API on the classpath.</p>
</div>
<div class="section" title="Using Log4J"><div class="titlepage"><div><div><h4 class="title"><a name="overview-logging-log4j"></a>Using Log4J</h4></div></div></div>

<p>Many people use <a class="ulink" href="http://logging.apache.org/log4j" target="_top">Log4j</a> as a logging framework for
configuration and management purposes. It&#8217;s efficient and well-established, and in fact
it&#8217;s what we use at runtime when we build and test Spring. Spring also provides some
utilities for configuring and initializing Log4j, so it has an optional compile-time
dependency on Log4j in some modules.</p>
<p>To make Log4j work with the default JCL dependency ( <code class="literal">commons-logging</code>) all you need to
do is put Log4j on the classpath, and provide it with a configuration file (
<code class="literal">log4j.properties</code> or <code class="literal">log4j.xml</code> in the root of the classpath). So for Maven users this
is your dependency declaration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;dependencies&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>org.springframework<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>spring-core<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>4.0.1.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
    <span class="hl-tag">&lt;dependency&gt;</span>
        <span class="hl-tag">&lt;groupId&gt;</span>log4j<span class="hl-tag">&lt;/groupId&gt;</span>
        <span class="hl-tag">&lt;artifactId&gt;</span>log4j<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;version&gt;</span>1.2.14<span class="hl-tag">&lt;/version&gt;</span>
    <span class="hl-tag">&lt;/dependency&gt;</span>
<span class="hl-tag">&lt;/dependencies&gt;</span></pre>

<p>And here&#8217;s a sample log4j.properties for logging to the console:</p>

<pre class="literallayout">log4j.rootCategory=INFO, stdout

log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d{ABSOLUTE} %5p %t %c{2}:%L - %m%n

log4j.category.org.springframework.beans.factory=DEBUG</pre>

<div class="section" title="Runtime Containers with Native JCL"><div class="titlepage"><div><div><h5 class="title"><a name="overview-native-jcl"></a>Runtime Containers with Native JCL</h5></div></div></div>

<p>Many people run their Spring applications in a container that itself provides an
implementation of JCL. IBM Websphere Application Server (WAS) is the archetype. This
often causes problems, and unfortunately there is no silver bullet solution; simply
excluding <code class="literal">commons-logging</code> from your application is not enough in most situations.</p>
<p>To be clear about this: the problems reported are usually not with JCL per se, or even
with <code class="literal">commons-logging</code>: rather they are to do with binding <code class="literal">commons-logging</code> to another
framework (often Log4J). This can fail because <code class="literal">commons-logging</code> changed the way they do
the runtime discovery in between the older versions (1.0) found in some containers and
the modern versions that most people use now (1.1). Spring does not use any unusual
parts of the JCL API, so nothing breaks there, but as soon as Spring or your application
tries to do any logging you can find that the bindings to Log4J are not working.</p>
<p>In such cases with WAS the easiest thing to do is to invert the class loader hierarchy
(IBM calls it "parent last") so that the application controls the JCL dependency, not
the container. That option isn&#8217;t always open, but there are plenty of other suggestions
in the public domain for alternative approaches, and your mileage may vary depending on
the exact version and feature set of the container.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="part" title="Part&nbsp;II.&nbsp;What&#8217;s New in Spring Framework 4.x"><div class="titlepage"><div><div><h1 class="title"><a name="spring-whats-new"></a>Part&nbsp;II.&nbsp;What&#8217;s New in Spring Framework 4.x</h1></div></div></div>

<div class="chapter" title="3.&nbsp;New Features and Enhancements in Spring Framework 4.0"><div class="titlepage"><div><div><h2 class="title"><a name="new-in-4.0"></a>3.&nbsp;New Features and Enhancements in Spring Framework 4.0</h2></div></div></div>

<p>The Spring Framework was first released in 2004; since then there have been significant
major revisions: Spring 2.0 provided XML namespaces and AspectJ support; Spring 2.5
embraced annotation-driven configuration; Spring 3.0 introduced a strong Java 5+ foundation
across the framework codebase, and features such as the Java-based <code class="literal">@Configuration</code> model.</p>
<p>Version 4.0 is the latest major release of the Spring Framework and the first to fully
support Java 8 features. You can still use Spring with older versions of Java, however,
the minimum requirement has now been raised to Java SE 6. We have also taken the
opportunity of a major release to remove many deprecated classes and methods.</p>
<p>A <a class="ulink" href="https://github.com/spring-projects/spring-framework/wiki/Migrating-from-earlier-versions-of-the-spring-framework" target="_top">migration guide for upgrading to Spring 4.0</a>
is available on the <a class="ulink" href="https://github.com/spring-projects/spring-framework/wiki" target="_top">Spring Framework GitHub Wiki</a>.</p>
<div class="section" title="3.1&nbsp;Improved Getting Started Experience"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_improved_getting_started_experience"></a>3.1&nbsp;Improved Getting Started Experience</h2></div></div></div>

<p>The new <a class="ulink" href="http://spring.io" target="_top">spring.io</a> website provides a whole series of
<a class="ulink" href="http://spring.io/guides" target="_top">"Getting Started"</a> guides to help you learn Spring. You
can read more about the guides in the <a class="xref" href="#overview-getting-started-with-spring" title="1.&nbsp;Getting Started With Spring">Chapter&nbsp;1, <i>Getting Started With Spring</i></a> section
in this document. The new website also provides a comprehensive overview of the many
additional projects that are released under the Spring umbrella.</p>
<p>If you are a Maven user you may also be interested in the helpful
<a class="link" href="#overview-maven-bom" title="Maven &#34;Bill Of Materials&#34; Dependency">bill of materials</a> POM file that is now published with each Spring
Framework release.</p>
</div>
<div class="section" title="3.2&nbsp;Removed Deprecated Packages and Methods"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_removed_deprecated_packages_and_methods"></a>3.2&nbsp;Removed Deprecated Packages and Methods</h2></div></div></div>

<p>All deprecated packages, and many deprecated classes and methods have been removed with
version 4.0. If you are upgrading from a previous release of Spring, you should ensure
that you have fixed any deprecated calls that you were making to outdated APIs.</p>
<p>For a complete set of changes, check out the
<a class="ulink" href="http://docs.spring.io/spring-framework/docs/3.2.4.RELEASE_to_4.0.0.RELEASE/" target="_top">API
Differences Report</a>.</p>
<p>Note that optional third-party dependencies have been raised to a 2010/2011 minimum
(i.e. Spring 4 generally only supports versions released in late 2010 or later now):
notably, Hibernate 3.6+, EhCache 2.1+, Quartz 1.8+, Groovy 1.8+, and Joda-Time 2.0+.
As an exception to the rule, Spring 4 requires the recent Hibernate Validator 4.3+,
and support for Jackson has been focused on 2.0+ now (with Jackson 1.8/1.9 support
retained for the time being where Spring 3.2 had it; now just in deprecated form).</p>
</div>
<div class="section" title="3.3&nbsp;Java 8 (as well as 6 and 7)"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_java_8_as_well_as_6_and_7"></a>3.3&nbsp;Java 8 (as well as 6 and 7)</h2></div></div></div>

<p>Spring Framework 4.0 provides support for several Java 8 features. You can make use of
<span class="emphasis"><em>lambda expressions</em></span> and <span class="emphasis"><em>method references</em></span> with Spring&#8217;s callback interfaces. There
is first-class support for <code class="literal">java.time</code> (<a class="ulink" href="http://jcp.org/en/jsr/detail?id=310" target="_top">JSR-310</a>),
and several existing annotations have been retrofitted as <code class="literal">@Repeatable</code>. You can also
use Java 8&#8217;s parameter name discovery (based on the <code class="literal">-parameters</code> compiler flag) as an
alternative to compiling your code with debug information enabled.</p>
<p>Spring remains compatible with older versions of Java and the JDK: concretely, Java SE 6
(specifically, a minimum level equivalent to JDK 6 update 18, as released in January 2010)
and above are still fully supported. However, for newly started development projects
based on Spring 4, we recommend the use of Java 7 or 8.</p>
<p>Note that the Java 8 bytecode level (<code class="literal">-target 1.8</code>, as required by <code class="literal">-source 1.8</code>) is only
fully supported as of Spring Framework 4.0. In particular, Spring 3.2 based applications
need to be compiled with a maximum of Java 7 as the target, even if they happen to be
deployed onto a Java 8 runtime. Please upgrade to Spring 4 for Java 8 based applications.</p>
</div>
<div class="section" title="3.4&nbsp;Java EE 6 and 7"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_java_ee_6_and_7"></a>3.4&nbsp;Java EE 6 and 7</h2></div></div></div>

<p>Java EE version 6 or above is now considered the baseline for Spring Framework 4, with
the JPA 2.0 and Servlet 3.0 specifications being of particular relevance. In order to
remain compatible with Google App Engine and older application servers, it is possible
to deploy a Spring 4 application into a Servlet 2.5 environment. However, Servlet 3.0+
is strongly recommended and a prerequisite in Spring&#8217;s test and mock packages for test
setups in development environments.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are a WebSphere 7 user, be sure to install the JPA 2.0 feature pack. On
WebLogic 10.3.4 or higher, install the JPA 2.0 patch that comes with it. This turns
both of those server generations into Spring 4 compatible deployment environments.</p>
</td></tr></table></div>

<p>On a more forward-looking note, Spring Framework 4.0 supports the Java EE 7 level of
applicable specifications now: in particular, JMS 2.0, JTA 1.2, JPA 2.1, Bean Validation
1.1, and JSR-236 Concurrency Utilities. As usual, this support focuses on individual
use of those specifications, e.g. on Tomcat or in standalone environments. However,
it works equally well when a Spring application is deployed to a Java EE 7 server.</p>
<p>Note that Hibernate 4.3 is a JPA 2.1 provider and therefore only supported as of
Spring Framework 4.0. The same applies to Hibernate Validator 5.0 as a Bean Validation
1.1 provider. Neither of the two are officially supported with Spring Framework 3.2.</p>
</div>
<div class="section" title="3.5&nbsp;Groovy Bean Definition DSL"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_groovy_bean_definition_dsl"></a>3.5&nbsp;Groovy Bean Definition DSL</h2></div></div></div>

<p>With Spring Framework 4.0 it is now possible to define external bean configuration using
a Groovy DSL. This is similar in concept to using XML bean definitions, but allows for
a more concise syntax. Using Groovy also allows you to easily embed bean definitions
directly in your bootstrap code. For example:</p>
<pre class="programlisting">def reader = new GroovyBeanDefinitionReader(myApplicationContext)
reader.beans {
    dataSource(BasicDataSource) {
        driverClassName = "org.hsqldb.jdbcDriver"
        url = "jdbc:hsqldb:mem:grailsDB"
        username = "sa"
        password = ""
        settings = [mynew:"setting"]
    }
    sessionFactory(SessionFactory) {
        dataSource = dataSource
    }
    myService(MyService) {
        nestedBean = { AnotherBean bean -&gt;
            dataSource = dataSource
        }
    }
}</pre>

<p>For more information consult the <code class="literal">GroovyBeanDefinitionReader</code>
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/groovy/GroovyBeanDefinitionReader.html" target="_top">Javadoc</a>.</p>
</div>
<div class="section" title="3.6&nbsp;Core Container Improvements"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_core_container_improvements"></a>3.6&nbsp;Core Container Improvements</h2></div></div></div>

<p>There have been several general improvements to the core container:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Spring now treats <a class="link" href="#beans-generics-as-qualifiers" title="4.9.4&nbsp;Using generics as autowiring qualifiers"><span class="emphasis"><em>generic types</em></span> as a form of
<span class="emphasis"><em>qualifier</em></span></a> when injecting Beans. For example, if you are using a Spring Data
<code class="literal">Repository</code> you can now easily inject a specific implementation:
<code class="literal">@Autowired Repository&lt;Customer&gt; customerRepository</code>.
</li><li class="listitem">
If you use Spring&#8217;s meta-annotation support, you can now develop custom annotations that
<a class="link" href="#beans-meta-annotations" title="4.10.2&nbsp;Meta-annotations">expose specific attributes from the source annotation</a>.
</li><li class="listitem">
Beans can now be <span class="emphasis"><em>ordered</em></span> when they are <a class="link" href="#beans-autowired-annotation" title="4.9.2&nbsp;@Autowired">autowired into
lists and arrays</a>. Both the <code class="literal">@Ordered</code> annotation and <code class="literal">Ordered</code> interface are
supported.
</li><li class="listitem">
The <code class="literal">@Lazy</code> annotation can now be used on injection points, as well as on <code class="literal">@Bean</code>
definitions.
</li><li class="listitem">
The <a class="link" href="#beans-java-bean-description" title="Bean description"><code class="literal">@Description</code> annotation has been introduced</a> for
developers using Java-based configuration.
</li><li class="listitem">
A generalized model for <a class="link" href="#beans-java-conditional" title="Conditionally including @Configuration classes or @Beans">conditionally filtering beans</a> has
been added via the <code class="literal">@Conditional</code> annotation. This is similar to <code class="literal">@Profile</code> support but
allows for user-defined strategies to be developed programmatically.
</li><li class="listitem">
<a class="link" href="#aop-pfb-proxy-types" title="9.5.3&nbsp;JDK- and CGLIB-based proxies">CGLIB-based proxy classes</a> no longer require a default
constructor. Support is provided via the <a class="ulink" href="http://code.google.com/p/objenesis/" target="_top">objenesis</a>
library which is repackaged <span class="emphasis"><em>inline</em></span> and distributed as part of the Spring Framework.
With this strategy, no constructor at all is being invoked for proxy instances anymore.
</li><li class="listitem">
There is managed time zone support across the framework now, e.g. on <code class="literal">LocaleContext</code>.
</li></ul></div>

</div>
<div class="section" title="3.7&nbsp;General Web Improvements"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_general_web_improvements"></a>3.7&nbsp;General Web Improvements</h2></div></div></div>

<p>Deployment to Servlet 2.5 servers remains an option, but Spring Framework 4.0 is now
focused primarily on Servlet 3.0+ environments. If you are using the
<a class="link" href="#spring-mvc-test-framework" title="10.3.6&nbsp;Spring MVC Test Framework">Spring MVC Test Framework</a> you
will need to ensure that a Servlet 3.0 compatible JAR is in your <span class="emphasis"><em>test classpath</em></span>.</p>
<p>In addition to the WebSocket support mentioned later, the following general improvements
have been made to Spring&#8217;s Web modules:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
You can use the <a class="link" href="#mvc-ann-restcontroller" title="Creating REST Controllers with the @RestController annotation">new <code class="literal">@RestController</code> annotation</a> with Spring
MVC applications, removing the need to add <code class="literal">@ResponseBody</code> to each of your
<code class="literal">@RequestMapping</code> methods.
</li><li class="listitem">
The <code class="literal">AsyncRestTemplate</code> class has been added, <a class="link" href="#rest-async-resttemplate" title="21.10.3&nbsp;Async RestTemplate">allowing
non-blocking asynchronous support</a> when developing REST clients.
</li><li class="listitem">
Spring now offers <a class="link" href="#mvc-timezone" title="16.9.1&nbsp;Obtaining Time Zone Information">comprehensive timezone support</a> when developing
Spring MVC applications.
</li></ul></div>

</div>
<div class="section" title="3.8&nbsp;WebSocket, SockJS, and STOMP Messaging"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_websocket_sockjs_and_stomp_messaging"></a>3.8&nbsp;WebSocket, SockJS, and STOMP Messaging</h2></div></div></div>

<p>A new <code class="literal">spring-websocket</code> module provides comprehensive support for WebSocket-based,
two-way communication between client and server in web applications. It is compatible with
<a class="ulink" href="http://jcp.org/en/jsr/detail?id=356" target="_top">JSR-356</a>, the Java WebSocket API, and in addition
provides SockJS-based fallback options (i.e. WebSocket emulation) for use in browsers
that don&#8217;t yet support the WebSocket protocol (e.g. Internet Explorer &lt; 10).</p>
<p>A new <code class="literal">spring-messaging</code> module adds support for STOMP as the WebSocket sub-protocol
to use in applications along with an annotation programming model for routing and
processing STOMP messages from WebSocket clients. As a result an <code class="literal">@Controller</code>
can now contain both <code class="literal">@RequestMapping</code> and <code class="literal">@MessageMapping</code> methods for handling
HTTP requests and messages from WebSocket-connected clients. The new <code class="literal">spring-messaging</code>
module also contains key abstractions from the
<a class="ulink" href="http://projects.spring.io/spring-integration/" target="_top">Spring Integration</a> project such as
<code class="literal">Message</code>, <code class="literal">MessageChannel</code>, <code class="literal">MessageHandler</code>, and others to serve as a foundation
for messaging-based applications.</p>
<p>For further details, including a more thorough introduction, see the <a class="xref" href="#websocket" title="20.&nbsp;WebSocket Support">Chapter&nbsp;20, <i>WebSocket Support</i></a> section.</p>
</div>
<div class="section" title="3.9&nbsp;Testing Improvements"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_testing_improvements"></a>3.9&nbsp;Testing Improvements</h2></div></div></div>

<p>In addition to pruning of deprecated code within the <code class="literal">spring-test</code> module, Spring
Framework 4.0 introduces several new features for use in unit and integration testing.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Almost all annotations in the <code class="literal">spring-test</code> module (e.g., <code class="literal">@ContextConfiguration</code>,
<code class="literal">@WebAppConfiguration</code>, <code class="literal">@ContextHierarchy</code>, <code class="literal">@ActiveProfiles</code>, etc.) can now be used
as <a class="link" href="#integration-testing-annotations-meta" title="Meta-Annotation Support for Testing">meta-annotations</a> to create custom
<span class="emphasis"><em>composed annotations</em></span> and reduce configuration duplication across a test suite.
</li><li class="listitem">
Active bean definition profiles can now be resolved programmatically, simply by
implementing a custom <a class="link" href="#testcontext-ctx-management-env-profiles-ActiveProfilesResolver"><code class="literal">ActiveProfilesResolver</code></a>
and registering it via the <code class="literal">resolver</code> attribute of <code class="literal">@ActiveProfiles</code>.
</li><li class="listitem">
A new <code class="literal">SocketUtils</code> class has been introduced in the <code class="literal">spring-core</code> module
which enables you to scan for free TCP and UDP server ports on localhost. This
functionality is not specific to testing but can prove very useful when writing
integration tests that require the use of sockets, for example tests that start
an in-memory SMTP server, FTP server, Servlet container, etc.
</li><li class="listitem">
As of Spring 4.0, the set of mocks in the <code class="literal">org.springframework.mock.web</code> package is
now based on the Servlet 3.0 API. Furthermore, several of the Servlet API mocks
(e.g., <code class="literal">MockHttpServletRequest</code>, <code class="literal">MockServletContext</code>, etc.) have been updated with
minor enhancements and improved configurability.
</li></ul></div>

</div>
</div>
</div>
<div class="part" title="Part&nbsp;III.&nbsp;Core Technologies"><div class="titlepage"><div><div><h1 class="title"><a name="spring-core"></a>Part&nbsp;III.&nbsp;Core Technologies</h1></div></div></div>

<div class="partintro" title="Core Technologies"><div></div>
<p>This part of the reference documentation covers all of those technologies that are
absolutely integral to the Spring Framework.</p>
<p>Foremost amongst these is the Spring Framework&#8217;s Inversion of Control (IoC) container. A
thorough treatment of the Spring Framework&#8217;s IoC container is closely followed by
comprehensive coverage of Spring&#8217;s Aspect-Oriented Programming (AOP) technologies. The
Spring Framework has its own AOP framework, which is conceptually easy to understand,
and which successfully addresses the 80% sweet spot of AOP requirements in Java
enterprise programming.</p>
<p>Coverage of Spring&#8217;s integration with AspectJ (currently the richest - in terms of
features - and certainly most mature AOP implementation in the Java enterprise space) is
also provided.</p>
<p>Finally, the adoption of the test-driven-development (TDD) approach to software
development is certainly advocated by the Spring team, and so coverage of Spring&#8217;s
support for integration testing is covered (alongside best practices for unit testing).
The Spring team has found that the correct use of IoC certainly does make both unit and
integration testing easier (in that the presence of setter methods and appropriate
constructors on classes makes them easier to wire together in a test without having to
set up service locator registries and suchlike)&#8230; the chapter dedicated solely to
testing will hopefully convince you of this as well.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#beans" title="4.&nbsp;The IoC container">Chapter&nbsp;4, <i>The IoC container</i></a>
</li><li class="listitem">
<a class="xref" href="#resources" title="5.&nbsp;Resources">Chapter&nbsp;5, <i>Resources</i></a>
</li><li class="listitem">
<a class="xref" href="#validation" title="6.&nbsp;Validation, Data Binding, and Type Conversion">Chapter&nbsp;6, <i>Validation, Data Binding, and Type Conversion</i></a>
</li><li class="listitem">
<a class="xref" href="#expressions" title="7.&nbsp;Spring Expression Language (SpEL)">Chapter&nbsp;7, <i>Spring Expression Language (SpEL)</i></a>
</li><li class="listitem">
<a class="xref" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">Chapter&nbsp;8, <i>Aspect Oriented Programming with Spring</i></a>
</li><li class="listitem">
<a class="xref" href="#aop-api" title="9.&nbsp;Spring AOP APIs">Chapter&nbsp;9, <i>Spring AOP APIs</i></a>
</li><li class="listitem">
<a class="xref" href="#testing" title="10.&nbsp;Testing">Chapter&nbsp;10, <i>Testing</i></a>
</li></ul></div>

</div>
<div class="chapter" title="4.&nbsp;The IoC container"><div class="titlepage"><div><div><h2 class="title"><a name="beans"></a>4.&nbsp;The IoC container</h2></div></div></div>

<div class="section" title="4.1&nbsp;Introduction to the Spring IoC container and beans"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-introduction"></a>4.1&nbsp;Introduction to the Spring IoC container and beans</h2></div></div></div>

<p>This chapter covers the Spring Framework implementation of the Inversion of Control
(IoC) <sup>[<a name="d4e658" href="#ftn.d4e658" class="footnote">1</a>]</sup> principle. IoC
is also known as <span class="emphasis"><em>dependency injection</em></span> (DI). It is a process whereby objects define
their dependencies, that is, the other objects they work with, only through constructor
arguments, arguments to a factory method, or properties that are set on the object
instance after it is constructed or returned from a factory method. The container then
<span class="emphasis"><em>injects</em></span> those dependencies when it creates the bean. This process is fundamentally
the inverse, hence the name <span class="emphasis"><em>Inversion of Control</em></span> (IoC), of the bean itself
controlling the instantiation or location of its dependencies by using direct
construction of classes, or a mechanism such as the <span class="emphasis"><em>Service Locator</em></span> pattern.</p>
<p>The <code class="literal">org.springframework.beans</code> and <code class="literal">org.springframework.context</code> packages are the basis
for Spring Framework&#8217;s IoC container. The
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/BeanFactory.html" target="_top"><code class="literal">BeanFactory</code></a>
interface provides an advanced configuration mechanism capable of managing any type of
object.
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/ApplicationContext.html" target="_top"><code class="literal">ApplicationContext</code></a>
is a sub-interface of <code class="literal">BeanFactory</code>. It adds easier integration with Spring&#8217;s AOP
features; message resource handling (for use in internationalization), event
publication; and application-layer specific contexts such as the <code class="literal">WebApplicationContext</code>
for use in web applications.</p>
<p>In short, the <code class="literal">BeanFactory</code> provides the configuration framework and basic
functionality, and the <code class="literal">ApplicationContext</code> adds more enterprise-specific functionality.
The <code class="literal">ApplicationContext</code> is a complete superset of the <code class="literal">BeanFactory</code>, and is used
exclusively in this chapter in descriptions of Spring&#8217;s IoC container. For more
information on using the <code class="literal">BeanFactory</code> instead of the <code class="literal">ApplicationContext,</code> refer to
<a class="xref" href="#beans-beanfactory" title="4.17&nbsp;The BeanFactory">Section&nbsp;4.17, &#8220;The BeanFactory&#8221;</a>.</p>
<p>In Spring, the objects that form the backbone of your application and that are managed
by the Spring IoC <span class="emphasis"><em>container</em></span> are called <span class="emphasis"><em>beans</em></span>. A bean is an object that is
instantiated, assembled, and otherwise managed by a Spring IoC container. Otherwise, a
bean is simply one of many objects in your application. Beans, and the <span class="emphasis"><em>dependencies</em></span>
among them, are reflected in the <span class="emphasis"><em>configuration metadata</em></span> used by a container.</p>
</div>
<div class="section" title="4.2&nbsp;Container overview"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-basics"></a>4.2&nbsp;Container overview</h2></div></div></div>

<p>The interface <code class="literal">org.springframework.context.ApplicationContext</code> represents the Spring IoC
container and is responsible for instantiating, configuring, and assembling the
aforementioned beans. The container gets its instructions on what objects to
instantiate, configure, and assemble by reading configuration metadata. The
configuration metadata is represented in XML, Java annotations, or Java code. It allows
you to express the objects that compose your application and the rich interdependencies
between such objects.</p>
<p>Several implementations of the <code class="literal">ApplicationContext</code> interface are supplied
out-of-the-box with Spring. In standalone applications it is common to create an
instance of
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/support/ClassPathXmlApplicationContext.html" target="_top"><code class="literal">ClassPathXmlApplicationContext</code></a>
or <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/support/FileSystemXmlApplicationContext.html" target="_top"><code class="literal">FileSystemXmlApplicationContext</code></a>.
 While XML has been the traditional format for defining configuration metadata you can
instruct the container to use Java annotations or code as the metadata format by
providing a small amount of XML configuration to declaratively enable support for these
additional metadata formats.</p>
<p>In most application scenarios, explicit user code is not required to instantiate one or
more instances of a Spring IoC container. For example, in a web application scenario, a
simple eight (or so) lines of boilerplate web descriptor XML in the <code class="literal">web.xml</code> file
of the application will typically suffice (see <a class="xref" href="#context-create" title="4.16.4&nbsp;Convenient ApplicationContext instantiation for web applications">Section&nbsp;4.16.4, &#8220;Convenient ApplicationContext instantiation for web applications&#8221;</a>). If you are using the
<a class="ulink" href="http://spring.io/tools/sts" target="_top">SpringSource Tool Suite</a> Eclipse-powered development
environment this boilerplate configuration can be easily created with few mouse clicks or
keystrokes.</p>
<p>The following diagram is a high-level view of how Spring works. Your application classes
are combined with configuration metadata so that after the <code class="literal">ApplicationContext</code> is
created and initialized, you have a fully configured and executable system or
application.</p>
<div class="figure"><a name="d4e703"></a><p class="title"><b>Figure&nbsp;4.1.&nbsp;The Spring IoC container</b></p><div class="figure-contents">

  <div class="mediaobject"><img src="images/container-magic.png" alt="container magic"></div>
</div></div><br class="figure-break">

<div class="section" title="4.2.1&nbsp;Configuration metadata"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-metadata"></a>4.2.1&nbsp;Configuration metadata</h3></div></div></div>

<p>As the preceding diagram shows, the Spring IoC container consumes a form of
<span class="emphasis"><em>configuration metadata</em></span>; this configuration metadata represents how you as an
application developer tell the Spring container to instantiate, configure, and assemble
the objects in your application.</p>
<p>Configuration metadata is traditionally supplied in a simple and intuitive XML format,
which is what most of this chapter uses to convey key concepts and features of the
Spring IoC container.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>XML-based metadata is <span class="emphasis"><em>not</em></span> the only allowed form of configuration metadata. The
Spring IoC container itself is <span class="emphasis"><em>totally</em></span> decoupled from the format in which this
configuration metadata is actually written. These days many developers choose
<a class="link" href="#beans-java" title="4.12&nbsp;Java-based container configuration">Java-based configuration</a> for their Spring applications.</p>
</td></tr></table></div>

<p>For information about using other forms of metadata with the Spring container, see:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="link" href="#beans-annotation-config" title="4.9&nbsp;Annotation-based container configuration">Annotation-based configuration</a>: Spring 2.5 introduced
support for annotation-based configuration metadata.
</li><li class="listitem">
<a class="link" href="#beans-java" title="4.12&nbsp;Java-based container configuration">Java-based configuration</a>: Starting with Spring 3.0, many features
provided by the Spring JavaConfig project became part of the core Spring Framework.
Thus you can define beans external to your application classes by using Java rather
than XML files. To use these new features, see the <code class="literal">@Configuration</code>, <code class="literal">@Bean</code>, <code class="literal">@Import</code>
and <code class="literal">@DependsOn</code> annotations.
</li></ul></div>

<p>Spring configuration consists of at least one and typically more than one bean
definition that the container must manage. XML-based configuration metadata shows these
beans configured as <code class="literal">&lt;bean/&gt;</code> elements inside a top-level <code class="literal">&lt;beans/&gt;</code> element. Java
configuration typically uses <code class="literal">@Bean</code> annotated methods within a <code class="literal">@Configuration</code> class.</p>
<p>These bean definitions correspond to the actual objects that make up your application.
Typically you define service layer objects, data access objects (DAOs), presentation
objects such as Struts <code class="literal">Action</code> instances, infrastructure objects such as Hibernate
<code class="literal">SessionFactories</code>, JMS <code class="literal">Queues</code>, and so forth. Typically one does not configure
fine-grained domain objects in the container, because it is usually the responsibility
of DAOs and business logic to create and load domain objects. However, you can use
Spring&#8217;s integration with AspectJ to configure objects that have been created outside
the control of an IoC container. See <a class="link" href="#aop-atconfigurable" title="8.8.1&nbsp;Using AspectJ to dependency inject domain objects with Spring">Using AspectJ to
dependency-inject domain objects with Spring</a>.</p>
<p>The following example shows the basic structure of XML-based configuration metadata:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"..."</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- collaborators and configuration for this bean go here --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"..."</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- collaborators and configuration for this bean go here --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- more bean definitions go here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The <code class="literal">id</code> attribute is a string that you use to identify the individual bean definition.
The <code class="literal">class</code> attribute defines the type of the bean and uses the fully qualified
classname. The value of the id attribute refers to collaborating objects. The XML for
referring to collaborating objects is not shown in this example; see
<a class="link" href="#beans-dependencies" title="4.4&nbsp;Dependencies">Dependencies</a> for more information.</p>
</div>
<div class="section" title="4.2.2&nbsp;Instantiating a container"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-instantiation"></a>4.2.2&nbsp;Instantiating a container</h3></div></div></div>

<p>Instantiating a Spring IoC container is straightforward. The location path or paths
supplied to an <code class="literal">ApplicationContext</code> constructor are actually resource strings that allow
the container to load configuration metadata from a variety of external resources such
as the local file system, from the Java <code class="literal">CLASSPATH</code>, and so on.</p>
<pre class="programlisting">ApplicationContext context =
    <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-keyword">new</span> String[] {<span class="hl-string">"services.xml"</span>, <span class="hl-string">"daos.xml"</span>});</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>After you learn about Spring&#8217;s IoC container, you may want to know more about Spring&#8217;s
<code class="literal">Resource</code> abstraction, as described in <a class="xref" href="#resources" title="5.&nbsp;Resources">Chapter&nbsp;5, <i>Resources</i></a>, which provides a convenient
mechanism for reading an InputStream from locations defined in a URI syntax. In
particular, <code class="literal">Resource</code> paths are used to construct applications contexts as described in
<a class="xref" href="#resources-app-ctx" title="5.7&nbsp;Application contexts and Resource paths">Section&nbsp;5.7, &#8220;Application contexts and Resource paths&#8221;</a>.</p>
</td></tr></table></div>

<p>The following example shows the service layer objects <code class="literal">(services.xml)</code> configuration file:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- services --&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"petStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.jpetstore.services.PetStoreServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accountDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountDao"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"itemDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"itemDao"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-comment">&lt;!-- additional collaborators and configuration for this bean go here --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- more bean definitions for services go here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The following example shows the data access objects <code class="literal">daos.xml</code> file:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountDao"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.jpetstore.dao.jpa.JpaAccountDao"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- additional collaborators and configuration for this bean go here --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"itemDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.jpetstore.dao.jpa.JapItemDao"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- additional collaborators and configuration for this bean go here --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- more bean definitions for data access objects go here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>In the preceding example, the service layer consists of the class <code class="literal">PetStoreServiceImpl</code>,
and two data access objects of the type <code class="literal">JpaAccountDao</code> and <code class="literal">JpaItemDao</code> (based
on the JPA Object/Relational mapping standard). The <code class="literal">property name</code> element refers to the
name of the JavaBean property, and the <code class="literal">ref</code> element refers to the name of another bean
definition. This linkage between <code class="literal">id</code> and <code class="literal">ref</code> elements expresses the dependency between
collaborating objects. For details of configuring an object&#8217;s dependencies, see
<a class="link" href="#beans-dependencies" title="4.4&nbsp;Dependencies">Dependencies</a>.</p>
<div class="section" title="Composing XML-based configuration metadata"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-xml-import"></a>Composing XML-based configuration metadata</h4></div></div></div>

<p>It can be useful to have bean definitions span multiple XML files. Often each individual
XML configuration file represents a logical layer or module in your architecture.</p>
<p>You can use the application context constructor to load bean definitions from all these
XML fragments. This constructor takes multiple <code class="literal">Resource</code> locations, as was shown in the
previous section. Alternatively, use one or more occurrences of the <code class="literal">&lt;import/&gt;</code> element
to load bean definitions from another file or files. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;import</span> <span class="hl-attribute">resource</span>=<span class="hl-value">"services.xml"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;import</span> <span class="hl-attribute">resource</span>=<span class="hl-value">"resources/messageSource.xml"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;import</span> <span class="hl-attribute">resource</span>=<span class="hl-value">"/resources/themeSource.xml"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bean1"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bean2"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>In the preceding example, external bean definitions are loaded from three files,
<code class="literal">services.xml</code>, <code class="literal">messageSource.xml</code>, and <code class="literal">themeSource.xml</code>. All location paths are
relative to the definition file doing the importing, so <code class="literal">services.xml</code> must be in the
same directory or classpath location as the file doing the importing, while
<code class="literal">messageSource.xml</code> and <code class="literal">themeSource.xml</code> must be in a <code class="literal">resources</code> location below the
location of the importing file. As you can see, a leading slash is ignored, but given
that these paths are relative, it is better form not to use the slash at all. The
contents of the files being imported, including the top level <code class="literal">&lt;beans/&gt;</code> element, must
be valid XML bean definitions according to the Spring Schema.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is possible, but not recommended, to reference files in parent directories using a
relative "../" path. Doing so creates a dependency on a file that is outside the current
application. In particular, this reference is not recommended for "classpath:" URLs (for
example, "classpath:../services.xml"), where the runtime resolution process chooses the
"nearest" classpath root and then looks into its parent directory. Classpath
configuration changes may lead to the choice of a different, incorrect directory.</p>
<p>You can always use fully qualified resource locations instead of relative paths: for
example, "file:C:/config/services.xml" or "classpath:/config/services.xml". However, be
aware that you are coupling your application&#8217;s configuration to specific absolute
locations. It is generally preferable to keep an indirection for such absolute
locations, for example, through "${&#8230;}" placeholders that are resolved against JVM
system properties at runtime.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="4.2.3&nbsp;Using the container"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-client"></a>4.2.3&nbsp;Using the container</h3></div></div></div>

<p>The <code class="literal">ApplicationContext</code> is the interface for an advanced factory capable of maintaining
a registry of different beans and their dependencies. Using the method <code class="literal">T getBean(String
name, Class&lt;T&gt; requiredType)</code> you can retrieve instances of your beans.</p>
<p>The <code class="literal">ApplicationContext</code> enables you to read bean definitions and access them as follows:</p>
<pre class="programlisting"><span class="hl-comment">// create and configure beans</span>
ApplicationContext context =
    <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-keyword">new</span> String[] {<span class="hl-string">"services.xml"</span>, <span class="hl-string">"daos.xml"</span>});

<span class="hl-comment">// retrieve configured instance</span>
PetStoreService service = context.getBean(<span class="hl-string">"petStore"</span>, PetStoreService.<span class="hl-keyword">class</span>);

<span class="hl-comment">// use configured instance</span>
List&lt;String&gt; userList = service.getUsernameList();</pre>

<p>You use <code class="literal">getBean()</code> to retrieve instances of your beans. The <code class="literal">ApplicationContext</code>
interface has a few other methods for retrieving beans, but ideally your application
code should never use them. Indeed, your application code should have no calls to the
<code class="literal">getBean()</code> method at all, and thus no dependency on Spring APIs at all. For example,
Spring&#8217;s integration with web frameworks provides for dependency injection for various
web framework classes such as controllers and JSF-managed beans.</p>
</div>
</div>
<div class="section" title="4.3&nbsp;Bean overview"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-definition"></a>4.3&nbsp;Bean overview</h2></div></div></div>

<p>A Spring IoC container manages one or more <span class="emphasis"><em>beans</em></span>. These beans are created with the
configuration metadata that you supply to the container, for example, in the form of XML
<code class="literal">&lt;bean/&gt;</code> definitions.</p>
<p>Within the container itself, these bean definitions are represented as <code class="literal">BeanDefinition</code>
objects, which contain (among other information) the following metadata:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>A package-qualified class name:</em></span> typically the actual implementation class of the
bean being defined.
</li><li class="listitem">
Bean behavioral configuration elements, which state how the bean should behave in the
container (scope, lifecycle callbacks, and so forth).
</li><li class="listitem">
References to other beans that are needed for the bean to do its work; these
references are also called <span class="emphasis"><em>collaborators</em></span> or <span class="emphasis"><em>dependencies</em></span>.
</li><li class="listitem">
Other configuration settings to set in the newly created object, for example, the
number of connections to use in a bean that manages a connection pool, or the size
limit of the pool.
</li></ul></div>

<p>This metadata translates to a set of properties that make up each bean definition.</p>
<div class="table"><a name="beans-factory-bean-definition-tbl"></a><p class="title"><b>Table&nbsp;4.1.&nbsp;The bean definition</b></p><div class="table-contents">

  <table summary="The bean definition" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explained in&#8230;</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>class</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-class" title="4.3.2&nbsp;Instantiating beans">Section&nbsp;4.3.2, &#8220;Instantiating beans&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>name</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-beanname" title="4.3.1&nbsp;Naming beans">Section&nbsp;4.3.1, &#8220;Naming beans&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scope</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-scopes" title="4.5&nbsp;Bean scopes">Section&nbsp;4.5, &#8220;Bean scopes&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>constructor arguments</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-collaborators" title="4.4.1&nbsp;Dependency injection">Section&nbsp;4.4.1, &#8220;Dependency injection&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>properties</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-collaborators" title="4.4.1&nbsp;Dependency injection">Section&nbsp;4.4.1, &#8220;Dependency injection&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>autowiring mode</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-autowire" title="4.4.5&nbsp;Autowiring collaborators">Section&nbsp;4.4.5, &#8220;Autowiring collaborators&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lazy-initialization mode</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-lazy-init" title="4.4.4&nbsp;Lazy-initialized beans">Section&nbsp;4.4.4, &#8220;Lazy-initialized beans&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>initialization method</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-lifecycle-initializingbean" title="Initialization callbacks">the section called &#8220;Initialization callbacks&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>destruction method</p></td><td style="" align="left" valign="top"><p><a class="xref" href="#beans-factory-lifecycle-disposablebean" title="Destruction callbacks">the section called &#8220;Destruction callbacks&#8221;</a></p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>In addition to bean definitions that contain information on how to create a specific
bean, the <code class="literal">ApplicationContext</code> implementations also permit the registration of existing
objects that are created outside the container, by users. This is done by accessing the
ApplicationContext&#8217;s BeanFactory via the method <code class="literal">getBeanFactory()</code> which returns the
BeanFactory implementation <code class="literal">DefaultListableBeanFactory</code>. <code class="literal">DefaultListableBeanFactory</code>
supports this registration through the methods <code class="literal">registerSingleton(..)</code> and
<code class="literal">registerBeanDefinition(..)</code>. However, typical applications work solely with beans
defined through metadata bean definitions.</p>
<div class="section" title="4.3.1&nbsp;Naming beans"><div class="titlepage"><div><div><h3 class="title"><a name="beans-beanname"></a>4.3.1&nbsp;Naming beans</h3></div></div></div>

<p>Every bean has one or more identifiers. These identifiers must be unique within the
container that hosts the bean. A bean usually has only one identifier, but if it
requires more than one, the extra ones can be considered aliases.</p>
<p>In XML-based configuration metadata, you use the <code class="literal">id</code> and/or <code class="literal">name</code> attributes
to specify the bean identifier(s). The <code class="literal">id</code> attribute allows you to specify
exactly one id. Conventionally these names are alphanumeric (<span class="emphasis"><em>myBean</em></span>,
<span class="emphasis"><em>fooService</em></span>, etc.), but may contain special characters as well. If you want to
introduce other aliases to the bean, you can also specify them in the <code class="literal">name</code>
attribute, separated by a comma (<code class="literal">,</code>), semicolon (<code class="literal">;</code>), or white space. As a
historical note, in versions prior to Spring 3.1, the <code class="literal">id</code> attribute was
defined as an <code class="literal">xsd:ID</code> type, which constrained possible characters. As of 3.1,
it is defined as an <code class="literal">xsd:string</code> type. Note that bean <code class="literal">id</code> uniqueness is still
enforced by the container, though no longer by XML parsers.</p>
<p>You are not required to supply a name or id for a bean. If no name or id is supplied
explicitly, the container generates a unique name for that bean. However, if you want to
refer to that bean by name, through the use of the <code class="literal">ref</code> element or
<a class="link" href="#beans-servicelocator" title="4.17.2&nbsp;Glue code and the evil singleton">Service Locator</a> style lookup, you must provide a name.
Motivations for not supplying a name are related to using <a class="link" href="#beans-inner-beans" title="Inner beans">inner
beans</a> and <a class="link" href="#beans-factory-autowire" title="4.4.5&nbsp;Autowiring collaborators">autowiring collaborators</a>.</p>
<div class="sidebar" title="Bean Naming Conventions"><p class="title"><b>Bean Naming Conventions</b></p>

<p>The convention is to use the standard Java convention for instance field names when
naming beans. That is, bean names start with a lowercase letter, and are camel-cased
from then on. Examples of such names would be (without quotes) <code class="literal">'accountManager'</code>,
<code class="literal">'accountService'</code>, <code class="literal">'userDao'</code>, <code class="literal">'loginController'</code>, and so forth.</p>
<p>Naming beans consistently makes your configuration easier to read and understand, and if
you are using Spring AOP it helps a lot when applying advice to a set of beans related
by name.</p>
</div>

<div class="section" title="Aliasing a bean outside the bean definition"><div class="titlepage"><div><div><h4 class="title"><a name="beans-beanname-alias"></a>Aliasing a bean outside the bean definition</h4></div></div></div>

<p>In a bean definition itself, you can supply more than one name for the bean, by using a
combination of up to one name specified by the <code class="literal">id</code> attribute, and any number of other
names in the <code class="literal">name</code> attribute. These names can be equivalent aliases to the same bean,
and are useful for some situations, such as allowing each component in an application to
refer to a common dependency by using a bean name that is specific to that component
itself.</p>
<p>Specifying all aliases where the bean is actually defined is not always adequate,
however. It is sometimes desirable to introduce an alias for a bean that is defined
elsewhere. This is commonly the case in large systems where configuration is split
amongst each subsystem, each subsystem having its own set of object definitions. In
XML-based configuration metadata, you can use the <code class="literal">&lt;alias/&gt;</code> element to accomplish this.</p>
<pre class="programlisting"><span class="hl-tag">&lt;alias</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fromName"</span> <span class="hl-attribute">alias</span>=<span class="hl-value">"toName"</span><span class="hl-tag">/&gt;</span></pre>

<p>In this case, a bean in the same container which is named <code class="literal">fromName</code>, may also,
after the use of this alias definition, be referred to as <code class="literal">toName</code>.</p>
<p>For example, the configuration metadata for subsystem A may refer to a DataSource via
the name <code class="literal">subsystemA-dataSource</code>. The configuration metadata for subsystem B may refer to
a DataSource via the name <code class="literal">subsystemB-dataSource</code>. When composing the main application
that uses both these subsystems the main application refers to the DataSource via the
name <code class="literal">myApp-dataSource</code>. To have all three names refer to the same object you add to the
MyApp configuration metadata the following aliases definitions:</p>
<pre class="programlisting"><span class="hl-tag">&lt;alias</span> <span class="hl-attribute">name</span>=<span class="hl-value">"subsystemA-dataSource"</span> <span class="hl-attribute">alias</span>=<span class="hl-value">"subsystemB-dataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;alias</span> <span class="hl-attribute">name</span>=<span class="hl-value">"subsystemA-dataSource"</span> <span class="hl-attribute">alias</span>=<span class="hl-value">"myApp-dataSource"</span><span class="hl-tag"> /&gt;</span></pre>

<p>Now each component and the main application can refer to the dataSource through a name
that is unique and guaranteed not to clash with any other definition (effectively
creating a namespace), yet they refer to the same bean.</p>
<div class="sidebar" title="Java-configuration"><p class="title"><b>Java-configuration</b></p>

<p>If you are using Java-configuration, the <code class="literal">@Bean</code> annotation can be used to provide aliases
see <a class="xref" href="#beans-java-bean-annotation" title="4.12.3&nbsp;Using the @Bean annotation">Section&nbsp;4.12.3, &#8220;Using the @Bean annotation&#8221;</a> for details.</p>
</div>

</div>
</div>
<div class="section" title="4.3.2&nbsp;Instantiating beans"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-class"></a>4.3.2&nbsp;Instantiating beans</h3></div></div></div>

<p>A bean definition essentially is a recipe for creating one or more objects. The
container looks at the recipe for a named bean when asked, and uses the configuration
metadata encapsulated by that bean definition to create (or acquire) an actual object.</p>
<p>If you use XML-based configuration metadata, you specify the type (or class) of object
that is to be instantiated in the <code class="literal">class</code> attribute of the <code class="literal">&lt;bean/&gt;</code> element. This
<code class="literal">class</code> attribute, which internally is a <code class="literal">Class</code> property on a <code class="literal">BeanDefinition</code>
instance, is usually mandatory. (For exceptions, see
<a class="xref" href="#beans-factory-class-instance-factory-method" title="Instantiation using an instance factory method">the section called &#8220;Instantiation using an instance factory method&#8221;</a> and <a class="xref" href="#beans-child-bean-definitions" title="4.7&nbsp;Bean definition inheritance">Section&nbsp;4.7, &#8220;Bean definition inheritance&#8221;</a>.)
You use the <code class="literal">Class</code> property in one of two ways:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Typically, to specify the bean class to be constructed in the case where the container
itself directly creates the bean by calling its constructor reflectively, somewhat
equivalent to Java code using the <code class="literal">new</code> operator.
</li><li class="listitem">
To specify the actual class containing the <code class="literal">static</code> factory method that will be
invoked to create the object, in the less common case where the container invokes a
<code class="literal">static</code>, <span class="emphasis"><em>factory</em></span> method on a class to create the bean. The object type returned
from the invocation of the <code class="literal">static</code> factory method may be the same class or another
class entirely.
</li></ul></div>

<div class="sidebar"><p class="title"><b></b></p>
<p title="Inner class names">
<b>Inner class names.&nbsp;</b>
If you want to configure a bean definition for a <code class="literal">static</code> nested class, you have to use
the <span class="emphasis"><em>binary</em></span> name of the inner class.
</p>
<p>For example, if you have a class called <code class="literal">Foo</code> in the <code class="literal">com.example</code> package, and this
<code class="literal">Foo</code> class has a <code class="literal">static</code> inner class called <code class="literal">Bar</code>, the value of the <code class="literal">'class'</code>
attribute on a bean definition would be&#8230;</p>
<p><code class="literal">com.example.Foo$Bar</code></p>
<p>Notice the use of the <code class="literal">$</code> character in the name to separate the inner class name from
the outer class name.</p>
</div>

<div class="section" title="Instantiation with a constructor"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-class-ctor"></a>Instantiation with a constructor</h4></div></div></div>

<p>When you create a bean by the constructor approach, all normal classes are usable by and
compatible with Spring. That is, the class being developed does not need to implement
any specific interfaces or to be coded in a specific fashion. Simply specifying the bean
class should suffice. However, depending on what type of IoC you use for that specific
bean, you may need a default (empty) constructor.</p>
<p>The Spring IoC container can manage virtually <span class="emphasis"><em>any</em></span> class you want it to manage; it is
not limited to managing true JavaBeans. Most Spring users prefer actual JavaBeans with
only a default (no-argument) constructor and appropriate setters and getters modeled
after the properties in the container. You can also have more exotic non-bean-style
classes in your container. If, for example, you need to use a legacy connection pool
that absolutely does not adhere to the JavaBean specification, Spring can manage it as
well.</p>
<p>With XML-based configuration metadata you can specify your bean class as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"anotherExample"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBeanTwo"</span><span class="hl-tag">/&gt;</span></pre>

<p>For details about the mechanism for supplying arguments to the constructor (if required)
and setting object instance properties after the object is constructed, see
<a class="link" href="#beans-factory-collaborators" title="4.4.1&nbsp;Dependency injection">Injecting Dependencies</a>.</p>
</div>
<div class="section" title="Instantiation with a static factory method"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-class-static-factory-method"></a>Instantiation with a static factory method</h4></div></div></div>

<p>When defining a bean that you create with a static factory method, you use the <code class="literal">class</code>
attribute to specify the class containing the <code class="literal">static</code> factory method and an attribute
named <code class="literal">factory-method</code> to specify the name of the factory method itself. You should be
able to call this method (with optional arguments as described later) and return a live
object, which subsequently is treated as if it had been created through a constructor.
One use for such a bean definition is to call <code class="literal">static</code> factories in legacy code.</p>
<p>The following bean definition specifies that the bean will be created by calling a
factory-method. The definition does not specify the type (class) of the returned object,
only the class containing the factory method. In this example, the <code class="literal">createInstance()</code>
method must be a <span class="emphasis"><em>static</em></span> method.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientService"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ClientService"</span>
    <span class="hl-attribute">factory-method</span>=<span class="hl-value">"createInstance"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ClientService {
    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> ClientService clientService = <span class="hl-keyword">new</span> ClientService();
    <span class="hl-keyword">private</span> ClientService() {}

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> ClientService createInstance() {
        <span class="hl-keyword">return</span> clientService;
    }
}</pre>

<p>For details about the mechanism for supplying (optional) arguments to the factory method
and setting object instance properties after the object is returned from the factory,
see <a class="link" href="#beans-factory-properties-detailed" title="4.4.2&nbsp;Dependencies and configuration in detail">Dependencies and configuration in detail</a>.</p>
</div>
<div class="section" title="Instantiation using an instance factory method"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-class-instance-factory-method"></a>Instantiation using an instance factory method</h4></div></div></div>

<p>Similar to instantiation through a <a class="link" href="#beans-factory-class-static-factory-method" title="Instantiation with a static factory method">static
factory method</a>, instantiation with an instance factory method invokes a non-static
method of an existing bean from the container to create a new bean. To use this
mechanism, leave the <code class="literal">class</code> attribute empty, and in the <code class="literal">factory-bean</code> attribute,
specify the name of a bean in the current (or parent/ancestor) container that contains
the instance method that is to be invoked to create the object. Set the name of the
factory method itself with the <code class="literal">factory-method</code> attribute.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- the factory bean, which contains a method called createInstance() --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serviceLocator"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.DefaultServiceLocator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-comment">&lt;!-- the bean to be created via the factory bean --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientService"</span>
    <span class="hl-attribute">factory-bean</span>=<span class="hl-value">"serviceLocator"</span>
    <span class="hl-attribute">factory-method</span>=<span class="hl-value">"createClientServiceInstance"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultServiceLocator {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> ClientService clientService = <span class="hl-keyword">new</span> ClientServiceImpl();
    <span class="hl-keyword">private</span> DefaultServiceLocator() {}

    <span class="hl-keyword">public</span> ClientService createClientServiceInstance() {
        <span class="hl-keyword">return</span> clientService;
    }
}</pre>

<p>One factory class can also hold more than one factory method as shown here:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serviceLocator"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.DefaultServiceLocator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientService"</span>
    <span class="hl-attribute">factory-bean</span>=<span class="hl-value">"serviceLocator"</span>
    <span class="hl-attribute">factory-method</span>=<span class="hl-value">"createClientServiceInstance"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span>
    <span class="hl-attribute">factory-bean</span>=<span class="hl-value">"serviceLocator"</span>
    <span class="hl-attribute">factory-method</span>=<span class="hl-value">"createAccountServiceInstance"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultServiceLocator {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> ClientService clientService = <span class="hl-keyword">new</span> ClientServiceImpl();
    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> AccountService accountService = <span class="hl-keyword">new</span> AccountServiceImpl();

    <span class="hl-keyword">private</span> DefaultServiceLocator() {}

    <span class="hl-keyword">public</span> ClientService createClientServiceInstance() {
        <span class="hl-keyword">return</span> clientService;
    }

    <span class="hl-keyword">public</span> AccountService createAccountServiceInstance() {
        <span class="hl-keyword">return</span> accountService;
    }

}</pre>

<p>This approach shows that the factory bean itself can be managed and configured through
dependency injection (DI). See <a class="link" href="#beans-factory-properties-detailed" title="4.4.2&nbsp;Dependencies and configuration in detail">Dependencies and
configuration in detail</a>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In Spring documentation,<span class="emphasis"><em> factory bean</em></span> refers to a bean that is configured in the
Spring container that will create objects through an
<a class="link" href="#beans-factory-class-instance-factory-method" title="Instantiation using an instance factory method">instance</a> or
<a class="link" href="#beans-factory-class-static-factory-method" title="Instantiation with a static factory method">static</a> factory method. By contrast,
<code class="literal">FactoryBean</code> (notice the capitalization) refers to a Spring-specific
<a class="link" href="#beans-factory-extension-factorybean" title="4.8.3&nbsp;Customizing instantiation logic with a FactoryBean"><code class="literal">FactoryBean</code></a>.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section" title="4.4&nbsp;Dependencies"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-dependencies"></a>4.4&nbsp;Dependencies</h2></div></div></div>

<p>A typical enterprise application does not consist of a single object (or bean in the
Spring parlance). Even the simplest application has a few objects that work together to
present what the end-user sees as a coherent application. This next section explains how
you go from defining a number of bean definitions that stand alone to a fully realized
application where objects collaborate to achieve a goal.</p>
<div class="section" title="4.4.1&nbsp;Dependency injection"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-collaborators"></a>4.4.1&nbsp;Dependency injection</h3></div></div></div>

<p><span class="emphasis"><em>Dependency injection</em></span> (DI) is a process whereby objects define their dependencies,
that is, the other objects they work with, only through constructor arguments, arguments
to a factory method, or properties that are set on the object instance after it is
constructed or returned from a factory method. The container then <span class="emphasis"><em>injects</em></span> those
dependencies when it creates the bean. This process is fundamentally the inverse, hence
the name <span class="emphasis"><em>Inversion of Control</em></span> (IoC), of the bean itself controlling the instantiation
or location of its dependencies on its own by using direct construction of classes, or
the <span class="emphasis"><em>Service Locator</em></span> pattern.</p>
<p>Code is cleaner with the DI principle and decoupling is more effective when objects are
provided with their dependencies. The object does not look up its dependencies, and does
not know the location or class of the dependencies. As such, your classes become easier
to test, in particular when the dependencies are on interfaces or abstract base classes,
which allow for stub or mock implementations to be used in unit tests.</p>
<p>DI exists in two major variants, <a class="link" href="#beans-constructor-injection" title="Constructor-based dependency injection">Constructor-based
dependency injection</a> and <a class="link" href="#beans-setter-injection" title="Setter-based dependency injection">Setter-based dependency injection</a>.</p>
<div class="section" title="Constructor-based dependency injection"><div class="titlepage"><div><div><h4 class="title"><a name="beans-constructor-injection"></a>Constructor-based dependency injection</h4></div></div></div>

<p><span class="emphasis"><em>Constructor-based</em></span> DI is accomplished by the container invoking a constructor with a
number of arguments, each representing a dependency. Calling a <code class="literal">static</code> factory method
with specific arguments to construct the bean is nearly equivalent, and this discussion
treats arguments to a constructor and to a <code class="literal">static</code> factory method similarly. The
following example shows a class that can only be dependency-injected with constructor
injection. Notice that there is nothing <span class="emphasis"><em>special</em></span> about this class, it is a POJO that
has no dependencies on container specific interfaces, base classes or annotations.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-comment">// the SimpleMovieLister has a dependency on a MovieFinder</span>
    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <span class="hl-comment">// a constructor so that the Spring container can inject a MovieFinder</span>
    <span class="hl-keyword">public</span> SimpleMovieLister(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// business logic that actually uses the injected MovieFinder is omitted...</span>

}</pre>

<div class="section" title="Constructor argument resolution"><div class="titlepage"><div><div><h5 class="title"><a name="beans-factory-ctor-arguments-resolution"></a>Constructor argument resolution</h5></div></div></div>

<p>Constructor argument resolution matching occurs using the argument&#8217;s type. If no
potential ambiguity exists in the constructor arguments of a bean definition, then the
order in which the constructor arguments are defined in a bean definition is the order
in which those arguments are supplied to the appropriate constructor when the bean is
being instantiated. Consider the following class:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> x.y;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Foo {

    <span class="hl-keyword">public</span> Foo(Bar bar, Baz baz) {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<p>No potential ambiguity exists, assuming that <code class="literal">Bar</code> and <code class="literal">Baz</code> classes are not related by
inheritance. Thus the following configuration works fine, and you do not need to specify
the constructor argument indexes and/or types explicitly in the <code class="literal">&lt;constructor-arg/&gt;</code>
element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.Foo"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"baz"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.Bar"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"baz"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.Baz"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>When another bean is referenced, the type is known, and matching can occur (as was the
case with the preceding example). When a simple type is used, such as
<code class="literal">&lt;value&gt;true&lt;/value&gt;</code>, Spring cannot determine the type of the value, and so cannot match
by type without help. Consider the following class:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> examples;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBean {

    <span class="hl-comment">// Number of years to calculate the Ultimate Answer</span>
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> years;

    <span class="hl-comment">// The Answer to Life, the Universe, and Everything</span>
    <span class="hl-keyword">private</span> String ultimateAnswer;

    <span class="hl-keyword">public</span> ExampleBean(<span class="hl-keyword">int</span> years, String ultimateAnswer) {
        <span class="hl-keyword">this</span>.years = years;
        <span class="hl-keyword">this</span>.ultimateAnswer = ultimateAnswer;
    }

}</pre>

<p>In the preceding scenario, the container <span class="emphasis"><em>can</em></span> use type matching with simple types if
you explicitly specify the type of the constructor argument using the <code class="literal">type</code> attribute.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">type</span>=<span class="hl-value">"int"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7500000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"42"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Use the <code class="literal">index</code> attribute to specify explicitly the index of constructor arguments. For
example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">index</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7500000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">index</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"42"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In addition to resolving the ambiguity of multiple simple values, specifying an index
resolves ambiguity where a constructor has two arguments of the same type. Note that the
<span class="emphasis"><em>index is 0 based</em></span>.</p>
<p>You can also use the constructor parameter name for value disambiguation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"years"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7500000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ultimateanswer"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"42"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Keep in mind that to make this work out of the box your code must be compiled with the
debug flag enabled so that Spring can look up the parameter name from the constructor.
If you can&#8217;t compile your code with debug flag (or don&#8217;t want to) you can use
<a class="ulink" href="http://download.oracle.com/javase/6/docs/api/java/beans/ConstructorProperties.html" target="_top">@ConstructorProperties</a>
JDK annotation to explicitly name your constructor arguments. The sample class would
then have to look as follows:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> examples;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBean {

    <span class="hl-comment">// Fields omitted</span>

    <i><span class="hl-annotation" style="color: gray">@ConstructorProperties({"years", "ultimateAnswer"})</span></i>
    <span class="hl-keyword">public</span> ExampleBean(<span class="hl-keyword">int</span> years, String ultimateAnswer) {
        <span class="hl-keyword">this</span>.years = years;
        <span class="hl-keyword">this</span>.ultimateAnswer = ultimateAnswer;
    }

}</pre>

</div>
</div>
<div class="section" title="Setter-based dependency injection"><div class="titlepage"><div><div><h4 class="title"><a name="beans-setter-injection"></a>Setter-based dependency injection</h4></div></div></div>

<p><span class="emphasis"><em>Setter-based</em></span> DI is accomplished by the container calling setter methods on your
beans after invoking a no-argument constructor or no-argument <code class="literal">static</code> factory method to
instantiate your bean.</p>
<p>The following example shows a class that can only be dependency-injected using pure
setter injection. This class is conventional Java. It is a POJO that has no dependencies
on container specific interfaces, base classes or annotations.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-comment">// the SimpleMovieLister has a dependency on the MovieFinder</span>
    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <span class="hl-comment">// a setter method so that the Spring container can inject a MovieFinder</span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// business logic that actually uses the injected MovieFinder is omitted...</span>

}</pre>

<p>The <code class="literal">ApplicationContext</code> supports constructor- and setter-based DI for the beans it
manages. It also supports setter-based DI after some dependencies are already injected
through the constructor approach. You configure the dependencies in the form of a
<code class="literal">BeanDefinition</code>, which you use with <code class="literal">PropertyEditor</code> instances to convert properties
from one format to another. However, most Spring users do not work with these classes
directly (programmatically), but rather with an XML definition file that is then
converted internally into instances of these classes, and used to load an entire Spring
IoC container instance.</p>
<div class="sidebar" title="Constructor-based or setter-based DI?"><p class="title"><b>Constructor-based or setter-based DI?</b></p>

<p>Since you can mix both, Constructor- and Setter-based DI, it is a good rule of thumb to
use constructor arguments for mandatory dependencies and setters for optional
dependencies. Note that the use of a <a class="link" href="#beans-required-annotation" title="4.9.1&nbsp;@Required">@Required</a> annotation
on a setter can be used to make setters required dependencies.</p>
<p>The Spring team generally advocates setter injection, because large numbers of
constructor arguments can get unwieldy, especially when properties are optional. Setter
methods also make objects of that class amenable to reconfiguration or re-injection
later. Management through <a class="link" href="#jmx" title="24.&nbsp;JMX">JMX MBeans</a> is a compelling use case.</p>
<p>Some purists favor constructor-based injection. Supplying all object dependencies means
that the object is always returned to client (calling) code in a totally initialized
state. The disadvantage is that the object becomes less amenable to reconfiguration and
re-injection.</p>
<p>Use the DI that makes the most sense for a particular class. Sometimes, when dealing
with third-party classes to which you do not have the source, the choice is made for
you. A legacy class may not expose any setter methods, and so constructor injection is
the only available DI.</p>
</div>

</div>
<div class="section" title="Dependency resolution process"><div class="titlepage"><div><div><h4 class="title"><a name="beans-dependency-resolution"></a>Dependency resolution process</h4></div></div></div>

<p>The container performs bean dependency resolution as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <code class="literal">ApplicationContext</code> is created and initialized with configuration metadata that
describes all the beans. Configuration metadata can be specified via XML, Java code or
annotations.
</li><li class="listitem">
For each bean, its dependencies are expressed in the form of properties, constructor
arguments, or arguments to the static-factory method if you are using that instead of
a normal constructor. These dependencies are provided to the bean, <span class="emphasis"><em>when the bean is
actually created</em></span>.
</li><li class="listitem">
Each property or constructor argument is an actual definition of the value to set, or
a reference to another bean in the container.
</li><li class="listitem">
Each property or constructor argument which is a value is converted from its specified
format to the actual type of that property or constructor argument. By default Spring
can convert a value supplied in string format to all built-in types, such as <code class="literal">int</code>,
<code class="literal">long</code>, <code class="literal">String</code>, <code class="literal">boolean</code>, etc.
</li></ul></div>

<p>The Spring container validates the configuration of each bean as the container is
created, including the validation of whether bean reference properties refer to valid
beans. However, the bean properties themselves are not set until the bean <span class="emphasis"><em>is actually
created</em></span>. Beans that are singleton-scoped and set to be pre-instantiated (the default)
are created when the container is created. Scopes are defined in
<a class="xref" href="#beans-factory-scopes" title="4.5&nbsp;Bean scopes">Section&nbsp;4.5, &#8220;Bean scopes&#8221;</a>. Otherwise, the bean is created only when it is requested.
Creation of a bean potentially causes a graph of beans to be created, as the bean&#8217;s
dependencies and its dependencies' dependencies (and so on) are created and assigned.</p>
<div class="sidebar" title="Circular dependencies"><p class="title"><b>Circular dependencies</b></p>

<p>If you use predominantly constructor injection, it is possible to create an unresolvable
circular dependency scenario.</p>
<p>For example: Class A requires an instance of class B through constructor injection, and
class B requires an instance of class A through constructor injection. If you configure
beans for classes A and B to be injected into each other, the Spring IoC container
detects this circular reference at runtime, and throws a
<code class="literal">BeanCurrentlyInCreationException</code>.</p>
<p>One possible solution is to edit the source code of some classes to be configured by
setters rather than constructors. Alternatively, avoid constructor injection and use
setter injection only. In other words, although it is not recommended, you can configure
circular dependencies with setter injection.</p>
<p>Unlike the <span class="emphasis"><em>typical</em></span> case (with no circular dependencies), a circular dependency
between bean A and bean B forces one of the beans to be injected into the other prior to
being fully initialized itself (a classic chicken/egg scenario).</p>
</div>

<p>You can generally trust Spring to do the right thing. It detects configuration problems,
such as references to non-existent beans and circular dependencies, at container
load-time. Spring sets properties and resolves dependencies as late as possible, when
the bean is actually created. This means that a Spring container which has loaded
correctly can later generate an exception when you request an object if there is a
problem creating that object or one of its dependencies. For example, the bean throws an
exception as a result of a missing or invalid property. This potentially delayed
visibility of some configuration issues is why <code class="literal">ApplicationContext</code> implementations by
default pre-instantiate singleton beans. At the cost of some upfront time and memory to
create these beans before they are actually needed, you discover configuration issues
when the <code class="literal">ApplicationContext</code> is created, not later. You can still override this default
behavior so that singleton beans will lazy-initialize, rather than be pre-instantiated.</p>
<p>If no circular dependencies exist, when one or more collaborating beans are being
injected into a dependent bean, each collaborating bean is <span class="emphasis"><em>totally</em></span> configured prior
to being injected into the dependent bean. This means that if bean A has a dependency on
bean B, the Spring IoC container completely configures bean B prior to invoking the
setter method on bean A. In other words, the bean is instantiated (if not a
pre-instantiated singleton), its dependencies are set, and the relevant lifecycle
methods (such as a <a class="link" href="#beans-factory-lifecycle-initializingbean" title="Initialization callbacks">configured init method</a>
or the <a class="link" href="#beans-factory-lifecycle-initializingbean" title="Initialization callbacks">InitializingBean callback method</a>)
are invoked.</p>
</div>
<div class="section" title="Examples of dependency injection"><div class="titlepage"><div><div><h4 class="title"><a name="beans-some-examples"></a>Examples of dependency injection</h4></div></div></div>

<p>The following example uses XML-based configuration metadata for setter-based DI. A small
part of a Spring XML configuration file specifies some bean definitions:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- setter injection using the nested &lt;ref/&gt; element --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beanOne"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"anotherExampleBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>

    <span class="hl-comment">&lt;!-- setter injection using the neater </span><span class="emphasis"><em>ref</em></span> attribute --&gt;
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beanTwo"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"yetAnotherBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"integerProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anotherExampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.AnotherBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"yetAnotherBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.YetAnotherBean"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBean {

    <span class="hl-keyword">private</span> AnotherBean beanOne;
    <span class="hl-keyword">private</span> YetAnotherBean beanTwo;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> i;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setBeanOne(AnotherBean beanOne) {
        <span class="hl-keyword">this</span>.beanOne = beanOne;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setBeanTwo(YetAnotherBean beanTwo) {
        <span class="hl-keyword">this</span>.beanTwo = beanTwo;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setIntegerProperty(<span class="hl-keyword">int</span> i) {
        <span class="hl-keyword">this</span>.i = i;
    }

}</pre>

<p>In the preceding example, setters are declared to match against the properties specified
in the XML file. The following example uses constructor-based DI:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- constructor injection using the nested &lt;ref/&gt; element --&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"anotherExampleBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>

    <span class="hl-comment">&lt;!-- constructor injection using the neater </span><span class="emphasis"><em>ref</em></span> attribute --&gt;
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"yetAnotherBean"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">type</span>=<span class="hl-value">"int"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anotherExampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.AnotherBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"yetAnotherBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.YetAnotherBean"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBean {

    <span class="hl-keyword">private</span> AnotherBean beanOne;
    <span class="hl-keyword">private</span> YetAnotherBean beanTwo;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> i;

    <span class="hl-keyword">public</span> ExampleBean(
        AnotherBean anotherBean, YetAnotherBean yetAnotherBean, <span class="hl-keyword">int</span> i) {
        <span class="hl-keyword">this</span>.beanOne = anotherBean;
        <span class="hl-keyword">this</span>.beanTwo = yetAnotherBean;
        <span class="hl-keyword">this</span>.i = i;
    }

}</pre>

<p>The constructor arguments specified in the bean definition will be used as arguments to
the constructor of the <code class="literal">ExampleBean</code>.</p>
<p>Now consider a variant of this example, where instead of using a constructor, Spring is
told to call a <code class="literal">static</code> factory method to return an instance of the object:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span> <span class="hl-attribute">factory-method</span>=<span class="hl-value">"createInstance"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"anotherExampleBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"yetAnotherBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anotherExampleBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.AnotherBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"yetAnotherBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.YetAnotherBean"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBean {

    <span class="hl-comment">// a private constructor</span>
    <span class="hl-keyword">private</span> ExampleBean(...) {
        ...
    }

    <span class="hl-comment">// a static factory method; the arguments to this method can be</span>
    <span class="hl-comment">// considered the dependencies of the bean that is returned,</span>
    <span class="hl-comment">// regardless of how those arguments are actually used.</span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> ExampleBean createInstance (
        AnotherBean anotherBean, YetAnotherBean yetAnotherBean, <span class="hl-keyword">int</span> i) {

        ExampleBean eb = <span class="hl-keyword">new</span> ExampleBean (...);
        <span class="hl-comment">// some other operations...</span>
        <span class="hl-keyword">return</span> eb;
    }

}</pre>

<p>Arguments to the <code class="literal">static</code> factory method are supplied via <code class="literal">&lt;constructor-arg/&gt;</code> elements,
exactly the same as if a constructor had actually been used. The type of the class being
returned by the factory method does not have to be of the same type as the class that
contains the <code class="literal">static</code> factory method, although in this example it is. An instance
(non-static) factory method would be used in an essentially identical fashion (aside
from the use of the <code class="literal">factory-bean</code> attribute instead of the <code class="literal">class</code> attribute), so
details will not be discussed here.</p>
</div>
</div>
<div class="section" title="4.4.2&nbsp;Dependencies and configuration in detail"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-properties-detailed"></a>4.4.2&nbsp;Dependencies and configuration in detail</h3></div></div></div>

<p>As mentioned in the previous section, you can define bean properties and constructor
arguments as references to other managed beans (collaborators), or as values defined
inline. Spring&#8217;s XML-based configuration metadata supports sub-element types within its
<code class="literal">&lt;property/&gt;</code> and <code class="literal">&lt;constructor-arg/&gt;</code> elements for this purpose.</p>
<div class="section" title="Straight values (primitives, Strings, and so on)"><div class="titlepage"><div><div><h4 class="title"><a name="beans-value-element"></a>Straight values (primitives, Strings, and so on)</h4></div></div></div>

<p>The <code class="literal">value</code> attribute of the <code class="literal">&lt;property/&gt;</code> element specifies a property or constructor
argument as a human-readable string representation. Spring&#8217;s
<a class="link" href="#core-convert-ConversionService-API" title="6.5.4&nbsp;ConversionService API">conversion service</a> is used to convert these
values from a <code class="literal">String</code> to the actual type of the property or argument.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myDataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- results in a setDriverClassName(String) call --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.mysql.jdbc.Driver"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc:mysql://localhost:3306/mydb"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"root"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"masterkaoli"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The following example uses the <a class="link" href="#beans-p-namespace" title="XML shortcut with the p-namespace">p-namespace</a> for even more succinct
XML configuration.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:p</span>=<span class="hl-value">"http://www.springframework.org/schema/p"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myDataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span>
        <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span>
        <span class="hl-attribute">p:driverClassName</span>=<span class="hl-value">"com.mysql.jdbc.Driver"</span>
        <span class="hl-attribute">p:url</span>=<span class="hl-value">"jdbc:mysql://localhost:3306/mydb"</span>
        <span class="hl-attribute">p:username</span>=<span class="hl-value">"root"</span>
        <span class="hl-attribute">p:password</span>=<span class="hl-value">"masterkaoli"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The preceding XML is more succinct; however, typos are discovered at runtime rather than
design time, unless you use an IDE such as <a class="ulink" href="http://www.jetbrains.com/idea/" target="_top">IntelliJ
IDEA</a> or the <a class="ulink" href="http://www.springsource.com/products/sts" target="_top">SpringSource Tool Suite</a> (STS)
that support automatic property completion when you create bean definitions. Such IDE
assistance is highly recommended.</p>
<p>You can also configure a <code class="literal">java.util.Properties</code> instance as:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mappings"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- typed as a java.util.Properties --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"properties"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;value&gt;</span>
            jdbc.driver.className=com.mysql.jdbc.Driver
            jdbc.url=jdbc:mysql://localhost:3306/mydb
        <span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The Spring container converts the text inside the <code class="literal">&lt;value/&gt;</code> element into a
<code class="literal">java.util.Properties</code> instance by using the JavaBeans <code class="literal">PropertyEditor</code> mechanism. This
is a nice shortcut, and is one of a few places where the Spring team do favor the use of
the nested <code class="literal">&lt;value/&gt;</code> element over the <code class="literal">value</code> attribute style.</p>
<div class="section" title="The idref element"><div class="titlepage"><div><div><h5 class="title"><a name="beans-idref-element"></a>The idref element</h5></div></div></div>

<p>The <code class="literal">idref</code> element is simply an error-proof way to pass the <span class="emphasis"><em>id</em></span> (string value - not
a reference) of another bean in the container to a <code class="literal">&lt;constructor-arg/&gt;</code> or <code class="literal">&lt;property/&gt;</code>
element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"theTargetBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"theClientBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetName"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;idref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"theTargetBean"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above bean definition snippet is <span class="emphasis"><em>exactly</em></span> equivalent (at runtime) to the
following snippet:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"theTargetBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"theTargetBean"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The first form is preferable to the second, because using the <code class="literal">idref</code> tag allows the
container to validate <span class="emphasis"><em>at deployment time</em></span> that the referenced, named bean actually
exists. In the second variation, no validation is performed on the value that is passed
to the <code class="literal">targetName</code> property of the <code class="literal">client</code> bean. Typos are only discovered (with most
likely fatal results) when the <code class="literal">client</code> bean is actually instantiated. If the <code class="literal">client</code>
bean is a <a class="link" href="#beans-factory-scopes" title="4.5&nbsp;Bean scopes">prototype</a> bean, this typo and the resulting exception
may only be discovered long after the container is deployed.</p>
<p>Additionally, if the referenced bean is in the same XML unit, and the bean name is the
bean <span class="emphasis"><em>id</em></span>, you can use the <code class="literal">local</code> attribute, which allows the XML parser itself to
validate the bean id earlier, at XML document parse time.</p>
<pre class="programlisting"><span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetName"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- a bean with id theTargetBean must exist; otherwise an exception will be thrown --&gt;</span>
    <span class="hl-tag">&lt;idref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"theTargetBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span></pre>

<p>A common place (at least in versions earlier than Spring 2.0) where the <code class="literal">&lt;idref/&gt;</code> element
brings value is in the configuration of <a class="link" href="#aop-pfb-1" title="9.5.1&nbsp;Basics">AOP interceptors</a> in a
<code class="literal">ProxyFactoryBean</code> bean definition. Using <code class="literal">&lt;idref/&gt;</code> elements when you specify the
interceptor names prevents you from misspelling an interceptor id.</p>
</div>
</div>
<div class="section" title="References to other beans (collaborators)"><div class="titlepage"><div><div><h4 class="title"><a name="beans-ref-element"></a>References to other beans (collaborators)</h4></div></div></div>

<p>The <code class="literal">ref</code> element is the final element inside a <code class="literal">&lt;constructor-arg/&gt;</code> or <code class="literal">&lt;property/&gt;</code>
definition element. Here you set the value of the specified property of a bean to be a
reference to another bean (a collaborator) managed by the container. The referenced bean
is a dependency of the bean whose property will be set, and it is initialized on demand
as needed before the property is set. (If the collaborator is a singleton bean, it may
be initialized already by the container.) All references are ultimately a reference to
another object. Scoping and validation depend on whether you specify the id/name of the
other object through the <code class="literal">bean</code>, <code class="literal">local,</code> or <code class="literal">parent</code> attributes.</p>
<p>Specifying the target bean through the <code class="literal">bean</code> attribute of the <code class="literal">&lt;ref/&gt;</code> tag is the most
general form, and allows creation of a reference to any bean in the same container or
parent container, regardless of whether it is in the same XML file. The value of the
<code class="literal">bean</code> attribute may be the same as the <code class="literal">id</code> attribute of the target bean, or as one of
the values in the <code class="literal">name</code> attribute of the target bean.</p>
<pre class="programlisting"><span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"someBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>Specifying the target bean through the <code class="literal">parent</code> attribute creates a reference to a bean
that is in a parent container of the current container. The value of the <code class="literal">parent</code>
attribute may be the same as either the <code class="literal">id</code> attribute of the target bean, or one of the
values in the <code class="literal">name</code> attribute of the target bean, and the target bean must be in a
parent container of the current one. You use this bean reference variant mainly when you
have a hierarchy of containers and you want to wrap an existing bean in a parent
container with a proxy that will have the same name as the parent bean.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- in the parent context --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.SimpleAccountService"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- insert dependencies as required as here --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<pre class="programlisting"><span class="hl-comment">&lt;!-- in the child (descendant) context --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">&lt;--</span> <span class="hl-attribute">bean</span> <span class="hl-attribute">name</span> <span class="hl-attribute">is</span> <span class="hl-attribute">the</span> <span class="hl-attribute">same</span> <span class="hl-attribute">as</span> <span class="hl-attribute">the</span> <span class="hl-attribute">parent</span> <span class="hl-attribute">bean</span> <span class="hl-attribute">--&gt;</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- notice how we refer to the parent bean --&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-comment">&lt;!-- insert other configuration and dependencies as required here --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">local</code> attribute on the <code class="literal">ref</code> element is no longer supported in the 4.0 beans xsd
since it does not provide value over a regular <code class="literal">bean</code> reference anymore. Simply change
your existing <code class="literal">ref local</code> references to <code class="literal">ref bean</code> when upgrading to the 4.0 schema.</p>
</td></tr></table></div>

</div>
<div class="section" title="Inner beans"><div class="titlepage"><div><div><h4 class="title"><a name="beans-inner-beans"></a>Inner beans</h4></div></div></div>

<p>A <code class="literal">&lt;bean/&gt;</code> element inside the <code class="literal">&lt;property/&gt;</code> or <code class="literal">&lt;constructor-arg/&gt;</code> elements defines a
so-called <span class="emphasis"><em>inner bean</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- instead of using a reference to a target bean, simply define the target bean inline --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.Person"</span><span class="hl-tag">&gt;</span> <span class="hl-comment">&lt;!-- this is the inner bean --&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Fiona Apple"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"25"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>An inner bean definition does not require a defined id or name; the container ignores
these values. It also ignores the <code class="literal">scope</code> flag. Inner beans are <span class="emphasis"><em>always</em></span> anonymous and
they are <span class="emphasis"><em>always</em></span> created with the outer bean. It is <span class="emphasis"><em>not</em></span> possible to inject inner
beans into collaborating beans other than into the enclosing bean.</p>
</div>
<div class="section" title="Collections"><div class="titlepage"><div><div><h4 class="title"><a name="beans-collection-elements"></a>Collections</h4></div></div></div>

<p>In the <code class="literal">&lt;list/&gt;</code>, <code class="literal">&lt;set/&gt;</code>, <code class="literal">&lt;map/&gt;</code>, and <code class="literal">&lt;props/&gt;</code> elements, you set the properties
and arguments of the Java <code class="literal">Collection</code> types <code class="literal">List</code>, <code class="literal">Set</code>, <code class="literal">Map</code>, and <code class="literal">Properties</code>,
respectively.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"moreComplexObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.ComplexObject"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- results in a setAdminEmails(java.util.Properties) call --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"adminEmails"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"administrator"</span><span class="hl-tag">&gt;</span>administrator@example.org<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"support"</span><span class="hl-tag">&gt;</span>support@example.org<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"development"</span><span class="hl-tag">&gt;</span>development@example.org<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-comment">&lt;!-- results in a setSomeList(java.util.List) call --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someList"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>a list element followed by a reference<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"myDataSource"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-comment">&lt;!-- results in a setSomeMap(java.util.Map) call --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someMap"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"an entry"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"just some string"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span> =<span class="hl-value">"a ref"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"myDataSource"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-comment">&lt;!-- results in a setSomeSet(java.util.Set) call --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someSet"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;set&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>just some string<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"myDataSource"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/set&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p><span class="emphasis"><em>The value of a map key or value, or a set value, can also again be any of the
following elements:</em></span></p>
<pre class="programlisting">bean | ref | idref | list | set | map | props | value | null</pre>

<div class="section" title="Collection merging"><div class="titlepage"><div><div><h5 class="title"><a name="beans-collection-elements-merging"></a>Collection merging</h5></div></div></div>

<p>The Spring container also supports the <span class="emphasis"><em>merging</em></span> of collections. An application
developer can define a parent-style <code class="literal">&lt;list/&gt;</code>, <code class="literal">&lt;map/&gt;</code>, <code class="literal">&lt;set/&gt;</code> or <code class="literal">&lt;props/&gt;</code> element,
and have child-style <code class="literal">&lt;list/&gt;</code>, <code class="literal">&lt;map/&gt;</code>, <code class="literal">&lt;set/&gt;</code> or <code class="literal">&lt;props/&gt;</code> elements inherit and
override values from the parent collection. That is, the child collection&#8217;s values are
the result of merging the elements of the parent and child collections, with the child&#8217;s
collection elements overriding values specified in the parent collection.</p>
<p><span class="emphasis"><em>This section on merging discusses the parent-child bean mechanism. Readers unfamiliar
with parent and child bean definitions may wish to read the
<a class="link" href="#beans-child-bean-definitions" title="4.7&nbsp;Bean definition inheritance">relevant section</a> before continuing.</em></span></p>
<p>The following example demonstrates collection merging:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"parent"</span> <span class="hl-attribute">abstract</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.ComplexObject"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"adminEmails"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;props&gt;</span>
                <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"administrator"</span><span class="hl-tag">&gt;</span>administrator@example.com<span class="hl-tag">&lt;/prop&gt;</span>
                <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"support"</span><span class="hl-tag">&gt;</span>support@example.com<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;/props&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"child"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"adminEmails"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- the merge is specified on the child collection definition --&gt;</span>
            <span class="hl-tag">&lt;props</span> <span class="hl-attribute">merge</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sales"</span><span class="hl-tag">&gt;</span>sales@example.com<span class="hl-tag">&lt;/prop&gt;</span>
                <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"support"</span><span class="hl-tag">&gt;</span>support@example.co.uk<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;/props&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;beans&gt;</span></pre>

<p>Notice the use of the <code class="literal">merge=true</code> attribute on the <code class="literal">&lt;props/&gt;</code> element of the
<code class="literal">adminEmails</code> property of the <code class="literal">child</code> bean definition. When the <code class="literal">child</code> bean is resolved
and instantiated by the container, the resulting instance has an <code class="literal">adminEmails</code>
<code class="literal">Properties</code> collection that contains the result of the merging of the child&#8217;s
<code class="literal">adminEmails</code> collection with the parent&#8217;s <code class="literal">adminEmails</code> collection.</p>

<pre class="literallayout">administrator=administrator@example.com
sales=sales@example.com
support=support@example.co.uk</pre>

<p>The child <code class="literal">Properties</code> collection&#8217;s value set inherits all property elements from the
parent <code class="literal">&lt;props/&gt;</code>, and the child&#8217;s value for the <code class="literal">support</code> value overrides the value in
the parent collection.</p>
<p>This merging behavior applies similarly to the <code class="literal">&lt;list/&gt;</code>, <code class="literal">&lt;map/&gt;</code>, and <code class="literal">&lt;set/&gt;</code>
collection types. In the specific case of the <code class="literal">&lt;list/&gt;</code> element, the semantics
associated with the <code class="literal">List</code> collection type, that is, the notion of an <code class="literal">ordered</code>
collection of values, is maintained; the parent&#8217;s values precede all of the child list&#8217;s
values. In the case of the <code class="literal">Map</code>, <code class="literal">Set</code>, and <code class="literal">Properties</code> collection types, no ordering
exists. Hence no ordering semantics are in effect for the collection types that underlie
the associated <code class="literal">Map</code>, <code class="literal">Set</code>, and <code class="literal">Properties</code> implementation types that the container
uses internally.</p>
</div>
<div class="section" title="Limitations of collection merging"><div class="titlepage"><div><div><h5 class="title"><a name="beans-collection-merge-limitations"></a>Limitations of collection merging</h5></div></div></div>

<p>You cannot merge different collection types (such as a <code class="literal">Map</code> and a <code class="literal">List</code>), and if you
do attempt to do so an appropriate <code class="literal">Exception</code> is thrown. The <code class="literal">merge</code> attribute must be
specified on the lower, inherited, child definition; specifying the <code class="literal">merge</code> attribute on
a parent collection definition is redundant and will not result in the desired merging.</p>
</div>
<div class="section" title="Strongly-typed collection"><div class="titlepage"><div><div><h5 class="title"><a name="beans-collection-elements-strongly-typed"></a>Strongly-typed collection</h5></div></div></div>

<p>With the introduction of generic types in Java 5, you can use strongly typed collections.
That is, it is possible to declare a <code class="literal">Collection</code> type such that it can only contain
<code class="literal">String</code> elements (for example). If you are using Spring to dependency-inject a
strongly-typed <code class="literal">Collection</code> into a bean, you can take advantage of Spring&#8217;s
type-conversion support such that the elements of your strongly-typed <code class="literal">Collection</code>
instances are converted to the appropriate type prior to being added to the <code class="literal">Collection</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Foo {

    <span class="hl-keyword">private</span> Map&lt;String, Float&gt; accounts;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setAccounts(Map&lt;String, Float&gt; accounts) {
        <span class="hl-keyword">this</span>.accounts = accounts;
    }
}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.Foo"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accounts"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"one"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"9.99"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"two"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2.75"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"six"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"3.99"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>When the <code class="literal">accounts</code> property of the <code class="literal">foo</code> bean is prepared for injection, the generics
information about the element type of the strongly-typed <code class="literal">Map&lt;String, Float&gt;</code> is
available by reflection. Thus Spring&#8217;s type conversion infrastructure recognizes the
various value elements as being of type <code class="literal">Float</code>, and the string values <code class="literal">9.99, 2.75</code>, and
<code class="literal">3.99</code> are converted into an actual <code class="literal">Float</code> type.</p>
</div>
</div>
<div class="section" title="Null and empty string values"><div class="titlepage"><div><div><h4 class="title"><a name="beans-null-element"></a>Null and empty string values</h4></div></div></div>

<p>Spring treats empty arguments for properties and the like as empty <code class="literal">Strings</code>. The
following XML-based configuration metadata snippet sets the email property to the empty
<code class="literal">String</code> value ("").</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"ExampleBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"email"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The preceding example is equivalent to the following Java code:
<code class="literal">exampleBean.setEmail("")</code>. The <code class="literal">&lt;null/&gt;</code> element handles <code class="literal">null</code> values. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"ExampleBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"email"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;null/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above configuration is equivalent to the following Java code:
<code class="literal">exampleBean.setEmail(null)</code>.</p>
</div>
<div class="section" title="XML shortcut with the p-namespace"><div class="titlepage"><div><div><h4 class="title"><a name="beans-p-namespace"></a>XML shortcut with the p-namespace</h4></div></div></div>

<p>The p-namespace enables you to use the <code class="literal">bean</code> element&#8217;s attributes, instead of nested
<code class="literal">&lt;property/&gt;</code> elements, to describe your property values and/or collaborating beans.</p>
<p>Spring supports extensible configuration formats <a class="link" href="#xsd-config" title="33.&nbsp;XML Schema-based configuration">with namespaces</a>, which are
based on an XML Schema definition. The <code class="literal">beans</code> configuration format discussed in this
chapter is defined in an XML Schema document. However, the p-namespace is not defined in
an XSD file and exists only in the core of Spring.</p>
<p>The following example shows two XML snippets that resolve to the same result: The first
uses standard XML format and the second uses the p-namespace.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:p</span>=<span class="hl-value">"http://www.springframework.org/schema/p"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"classic"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.ExampleBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"email"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo@bar.com"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"p-namespace"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.ExampleBean"</span>
        <span class="hl-attribute">p:email</span>=<span class="hl-value">"foo@bar.com"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The example shows an attribute in the p-namespace called email in the bean definition.
This tells Spring to include a property declaration. As previously mentioned, the
p-namespace does not have a schema definition, so you can set the name of the attribute
to the property name.</p>
<p>This next example includes two more bean definitions that both have a reference to
another bean:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:p</span>=<span class="hl-value">"http://www.springframework.org/schema/p"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"john-classic"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.Person"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"John Doe"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"spouse"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"jane"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"john-modern"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.Person"</span>
        <span class="hl-attribute">p:name</span>=<span class="hl-value">"John Doe"</span>
        <span class="hl-attribute">p:spouse-ref</span>=<span class="hl-value">"jane"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jane"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.Person"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Jane Doe"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>As you can see, this example includes not only a property value using the p-namespace,
but also uses a special format to declare property references. Whereas the first bean
definition uses <code class="literal">&lt;property name="spouse" ref="jane"/&gt;</code> to create a reference from bean
<code class="literal">john</code> to bean <code class="literal">jane</code>, the second bean definition uses <code class="literal">p:spouse-ref="jane"</code> as an
attribute to do the exact same thing. In this case <code class="literal">spouse</code> is the property name,
whereas the <code class="literal">-ref</code> part indicates that this is not a straight value but rather a
reference to another bean.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The p-namespace is not as flexible as the standard XML format. For example, the format
for declaring property references clashes with properties that end in <code class="literal">Ref</code>, whereas the
standard XML format does not. We recommend that you choose your approach carefully and
communicate this to your team members, to avoid producing XML documents that use all
three approaches at the same time.</p>
</td></tr></table></div>

</div>
<div class="section" title="XML shortcut with the c-namespace"><div class="titlepage"><div><div><h4 class="title"><a name="beans-c-namespace"></a>XML shortcut with the c-namespace</h4></div></div></div>

<p>Similar to the <a class="xref" href="#beans-p-namespace" title="XML shortcut with the p-namespace">the section called &#8220;XML shortcut with the p-namespace&#8221;</a>, the <span class="emphasis"><em>c-namespace</em></span>, newly introduced in Spring
3.1, allows usage of inlined attributes for configuring the constructor arguments rather
then nested <code class="literal">constructor-arg</code> elements.</p>
<p>Let&#8217;s review the examples from <a class="xref" href="#beans-constructor-injection" title="Constructor-based dependency injection">the section called &#8220;Constructor-based dependency injection&#8221;</a> with the <code class="literal">c:</code> namespace:</p>
<pre class="programlisting">&lt;beans xmlns=<span class="hl-string">"http://www.springframework.org/schema/beans"</span>
    xmlns:xsi=<span class="hl-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    xmlns:c=<span class="hl-string">"http://www.springframework.org/schema/c"</span>
    xsi:schemaLocation=<span class="hl-string">"http://www.springframework.org/schema/beans
</span>        http:<span class="hl-comment">//www.springframework.org/schema/beans/spring-beans.xsd"&gt;</span>

    &lt;bean id=<span class="hl-string">"bar"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"x.y.Bar"</span>/&gt;
    &lt;bean id=<span class="hl-string">"baz"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"x.y.Baz"</span>/&gt;

    &lt;!-- traditional declaration --&gt;
    &lt;bean id=<span class="hl-string">"foo"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"x.y.Foo"</span>&gt;
        &lt;constructor-arg ref=<span class="hl-string">"bar"</span>/&gt;
        &lt;constructor-arg ref=<span class="hl-string">"baz"</span>/&gt;
        &lt;constructor-arg value=<span class="hl-string">"foo@bar.com"</span>/&gt;
    &lt;/bean&gt;

    &lt;!-- c-namespace declaration --&gt;
    &lt;bean id=<span class="hl-string">"foo"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"x.y.Foo"</span> c:bar-ref=<span class="hl-string">"bar"</span> c:baz-ref=<span class="hl-string">"baz"</span> c:email=<span class="hl-string">"foo@bar.com"</span>/&gt;

&lt;/beans&gt;</pre>

<p>The <code class="literal">c:</code> namespace uses the same conventions as the <code class="literal">p:</code> one (trailing <code class="literal">-ref</code> for bean
references) for setting the constructor arguments by their names. And just as well, it
needs to be declared even though it is not defined in an XSD schema (but it exists
inside the Spring core).</p>
<p>For the rare cases where the constructor argument names are not available (usually if
the bytecode was compiled without debugging information), one can use fallback to the
argument indexes:</p>
<pre class="programlisting">&lt;!-- c-namespace index declaration --&gt;
&lt;bean id=<span class="hl-string">"foo"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"x.y.Foo"</span> c:_<span class="hl-number">0</span>-ref=<span class="hl-string">"bar"</span> c:_<span class="hl-number">1</span>-ref=<span class="hl-string">"baz"</span>/&gt;</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Due to the XML grammar, the index notation requires the presence of the leading <code class="literal">_</code> as
XML attribute names cannot start with a number (even though some IDE allow it).</p>
</td></tr></table></div>

<p>In practice, the constructor resolution
<a class="link" href="#beans-factory-ctor-arguments-resolution" title="Constructor argument resolution">mechanism</a> is quite efficient in matching
arguments so unless one really needs to, we recommend using the name notation
through-out your configuration.</p>
</div>
<div class="section" title="Compound property names"><div class="titlepage"><div><div><h4 class="title"><a name="beans-compound-property-names"></a>Compound property names</h4></div></div></div>

<p>You can use compound or nested property names when you set bean properties, as long as
all components of the path except the final property name are not <code class="literal">null</code>. Consider the
following bean definition.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.Bar"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fred.bob.sammy"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"123"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">foo</code> bean has a <code class="literal">fred</code> property, which has a <code class="literal">bob</code> property, which has a <code class="literal">sammy</code>
property, and that final <code class="literal">sammy</code> property is being set to the value <code class="literal">123</code>. In order for
this to work, the <code class="literal">fred</code> property of <code class="literal">foo</code>, and the <code class="literal">bob</code> property of <code class="literal">fred</code> must not be
<code class="literal">null</code> after the bean is constructed, or a <code class="literal">NullPointerException</code> is thrown.</p>
</div>
</div>
<div class="section" title="4.4.3&nbsp;Using depends-on"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-dependson"></a>4.4.3&nbsp;Using depends-on</h3></div></div></div>

<p>If a bean is a dependency of another that usually means that one bean is set as a
property of another. Typically you accomplish this with the <a class="link" href="#beans-ref-element" title="References to other beans (collaborators)"><code class="literal">&lt;ref/&gt;</code>
element</a> in XML-based configuration metadata. However, sometimes dependencies between
beans are less direct; for example, a static initializer in a class needs to be
triggered, such as database driver registration. The <code class="literal">depends-on</code> attribute can
explicitly force one or more beans to be initialized before the bean using this element
is initialized. The following example uses the <code class="literal">depends-on</code> attribute to express a
dependency on a single bean:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"beanOne"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"ExampleBean"</span> <span class="hl-attribute">depends-on</span>=<span class="hl-value">"manager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"manager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"ManagerBean"</span><span class="hl-tag"> /&gt;</span></pre>

<p>To express a dependency on multiple beans, supply a list of bean names as the value of
the <code class="literal">depends-on</code> attribute, with commas, whitespace and semicolons, used as valid
delimiters:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"beanOne"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"ExampleBean"</span> <span class="hl-attribute">depends-on</span>=<span class="hl-value">"manager,accountDao"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"manager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"manager"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"manager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"ManagerBean"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.jdbc.JdbcAccountDao"</span><span class="hl-tag"> /&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">depends-on</code> attribute in the bean definition can specify both an initialization
time dependency and, in the case of <a class="link" href="#beans-factory-scopes-singleton" title="4.5.1&nbsp;The singleton scope">singleton</a> beans
only, a corresponding destroy time dependency. Dependent beans that define a
<code class="literal">depends-on</code> relationship with a given bean are destroyed first, prior to the given bean
itself being destroyed. Thus <code class="literal">depends-on</code> can also control shutdown order.</p>
</td></tr></table></div>

</div>
<div class="section" title="4.4.4&nbsp;Lazy-initialized beans"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-lazy-init"></a>4.4.4&nbsp;Lazy-initialized beans</h3></div></div></div>

<p>By default, <code class="literal">ApplicationContext</code> implementations eagerly create and configure all
<a class="link" href="#beans-factory-scopes-singleton" title="4.5.1&nbsp;The singleton scope">singleton</a> beans as part of the initialization
process. Generally, this pre-instantiation is desirable, because errors in the
configuration or surrounding environment are discovered immediately, as opposed to hours
or even days later. When this behavior is <span class="emphasis"><em>not</em></span> desirable, you can prevent
pre-instantiation of a singleton bean by marking the bean definition as
lazy-initialized. A lazy-initialized bean tells the IoC container to create a bean
instance when it is first requested, rather than at startup.</p>
<p>In XML, this behavior is controlled by the <code class="literal">lazy-init</code> attribute on the <code class="literal">&lt;bean/&gt;</code>
element; for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lazy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.ExpensiveToCreateBean"</span> <span class="hl-attribute">lazy-init</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"not.lazy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.AnotherBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>When the preceding configuration is consumed by an <code class="literal">ApplicationContext</code>, the bean named
<code class="literal">lazy</code> is not eagerly pre-instantiated when the <code class="literal">ApplicationContext</code> is starting up,
whereas the <code class="literal">not.lazy</code> bean is eagerly pre-instantiated.</p>
<p>However, when a lazy-initialized bean is a dependency of a singleton bean that is
<span class="emphasis"><em>not</em></span> lazy-initialized, the <code class="literal">ApplicationContext</code> creates the lazy-initialized bean at
startup, because it must satisfy the singleton&#8217;s dependencies. The lazy-initialized bean
is injected into a singleton bean elsewhere that is not lazy-initialized.</p>
<p>You can also control lazy-initialization at the container level by using the
<code class="literal">default-lazy-init</code> attribute on the <code class="literal">&lt;beans/&gt;</code> element; for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">default-lazy-init</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- no beans will be pre-instantiated... --&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="4.4.5&nbsp;Autowiring collaborators"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-autowire"></a>4.4.5&nbsp;Autowiring collaborators</h3></div></div></div>

<p>The Spring container can <span class="emphasis"><em>autowire</em></span> relationships between collaborating beans. You can
allow Spring to resolve collaborators (other beans) automatically for your bean by
inspecting the contents of the <code class="literal">ApplicationContext</code>. Autowiring has the following
advantages:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Autowiring can significantly reduce the need to specify properties or constructor
arguments. (Other mechanisms such as a bean template
<a class="link" href="#beans-child-bean-definitions" title="4.7&nbsp;Bean definition inheritance">discussed elsewhere in this chapter</a> are also valuable
in this regard.)
</li><li class="listitem">
Autowiring can update a configuration as your objects evolve. For example, if you need
to add a dependency to a class, that dependency can be satisfied automatically without
you needing to modify the configuration. Thus autowiring can be especially useful
during development, without negating the option of switching to explicit wiring when
the code base becomes more stable.
</li></ul></div>

<p>When using XML-based configuration metadata <sup>[<a name="d4e1469" href="#ftn.d4e1469" class="footnote">2</a>]</sup>, you specify autowire
mode for a bean definition with the <code class="literal">autowire</code> attribute of the <code class="literal">&lt;bean/&gt;</code> element. The
autowiring functionality has five modes. You specify autowiring <span class="emphasis"><em>per</em></span> bean and thus
can choose which ones to autowire.</p>
<div class="table"><a name="beans-factory-autowiring-modes-tbl"></a><p class="title"><b>Table&nbsp;4.2.&nbsp;Autowiring modes</b></p><div class="table-contents">

  <table summary="Autowiring modes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Mode</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>(Default) No autowiring. Bean references must be defined via a <code class="literal">ref</code> element. Changing
  the default setting is not recommended for larger deployments, because specifying
  collaborators explicitly gives greater control and clarity. To some extent, it
  documents the structure of a system.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>byName</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Autowiring by property name. Spring looks for a bean with the same name as the
  property that needs to be autowired. For example, if a bean definition is set to
  autowire by name, and it contains a <span class="emphasis"><em>master</em></span> property (that is, it has a
  <span class="emphasis"><em>setMaster(..)</em></span> method), Spring looks for a bean definition named <code class="literal">master</code>, and uses
  it to set the property.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>byType</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Allows a property to be autowired if exactly one bean of the property type exists in
  the container. If more than one exists, a fatal exception is thrown, which indicates
  that you may not use <span class="emphasis"><em>byType</em></span> autowiring for that bean. If there are no matching
  beans, nothing happens; the property is not set.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>constructor</p></td><td style="" align="left" valign="top"><p>Analogous to <span class="emphasis"><em>byType</em></span>, but applies to constructor arguments. If there is not exactly
  one bean of the constructor argument type in the container, a fatal error is raised.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>With <span class="emphasis"><em>byType</em></span> or <span class="emphasis"><em>constructor</em></span> autowiring mode, you can wire arrays and
typed-collections. In such cases <span class="emphasis"><em>all</em></span> autowire candidates within the container that
match the expected type are provided to satisfy the dependency. You can autowire
strongly-typed Maps if the expected key type is <code class="literal">String</code>. An autowired Maps values will
consist of all bean instances that match the expected type, and the Maps keys will
contain the corresponding bean names.</p>
<p>You can combine autowire behavior with dependency checking, which is performed after
autowiring completes.</p>
<div class="section" title="Limitations and disadvantages of autowiring"><div class="titlepage"><div><div><h4 class="title"><a name="beans-autowired-exceptions"></a>Limitations and disadvantages of autowiring</h4></div></div></div>

<p>Autowiring works best when it is used consistently across a project. If autowiring is
not used in general, it might be confusing to developers to use it to wire only one or
two bean definitions.</p>
<p>Consider the limitations and disadvantages of autowiring:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Explicit dependencies in <code class="literal">property</code> and <code class="literal">constructor-arg</code> settings always override
autowiring. You cannot autowire so-called <span class="emphasis"><em>simple</em></span> properties such as primitives,
<code class="literal">Strings</code>, and <code class="literal">Classes</code> (and arrays of such simple properties). This limitation is
by-design.
</li><li class="listitem">
Autowiring is less exact than explicit wiring. Although, as noted in the above table,
Spring is careful to avoid guessing in case of ambiguity that might have unexpected
results, the relationships between your Spring-managed objects are no longer
documented explicitly.
</li><li class="listitem">
Wiring information may not be available to tools that may generate documentation from
a Spring container.
</li><li class="listitem">
Multiple bean definitions within the container may match the type specified by the
setter method or constructor argument to be autowired. For arrays, collections, or
Maps, this is not necessarily a problem. However for dependencies that expect a single
value, this ambiguity is not arbitrarily resolved. If no unique bean definition is
available, an exception is thrown.
</li></ul></div>

<p>In the latter scenario, you have several options:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Abandon autowiring in favor of explicit wiring.
</li><li class="listitem">
Avoid autowiring for a bean definition by setting its <code class="literal">autowire-candidate</code> attributes
to <code class="literal">false</code> as described in the next section.
</li><li class="listitem">
Designate a single bean definition as the <span class="emphasis"><em>primary</em></span> candidate by setting the
<code class="literal">primary</code> attribute of its <code class="literal">&lt;bean/&gt;</code> element to <code class="literal">true</code>.
</li><li class="listitem">
Implement the more fine-grained control available
with annotation-based configuration, as described in <a class="xref" href="#beans-annotation-config" title="4.9&nbsp;Annotation-based container configuration">Section&nbsp;4.9, &#8220;Annotation-based container configuration&#8221;</a>.
</li></ul></div>

</div>
<div class="section" title="Excluding a bean from autowiring"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-autowire-candidate"></a>Excluding a bean from autowiring</h4></div></div></div>

<p>On a per-bean basis, you can exclude a bean from autowiring. In Spring&#8217;s XML format, set
the <code class="literal">autowire-candidate</code> attribute of the <code class="literal">&lt;bean/&gt;</code> element to <code class="literal">false</code>; the container
makes that specific bean definition unavailable to the autowiring infrastructure
(including annotation style configurations such as <a class="link" href="#beans-autowired-annotation" title="4.9.2&nbsp;@Autowired"><code class="literal">@Autowired</code></a>).</p>
<p>You can also limit autowire candidates based on pattern-matching against bean names. The
top-level <code class="literal">&lt;beans/&gt;</code> element accepts one or more patterns within its
<code class="literal">default-autowire-candidates</code> attribute. For example, to limit autowire candidate status
to any bean whose name ends with <span class="emphasis"><em>Repository,</em></span> provide a value of *Repository. To
provide multiple patterns, define them in a comma-separated list. An explicit value of
<code class="literal">true</code> or <code class="literal">false</code> for a bean definitions <code class="literal">autowire-candidate</code> attribute always takes
precedence, and for such beans, the pattern matching rules do not apply.</p>
<p>These techniques are useful for beans that you never want to be injected into other
beans by autowiring. It does not mean that an excluded bean cannot itself be configured
using autowiring. Rather, the bean itself is not a candidate for autowiring other beans.</p>
</div>
</div>
<div class="section" title="4.4.6&nbsp;Method injection"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-method-injection"></a>4.4.6&nbsp;Method injection</h3></div></div></div>

<p>In most application scenarios, most beans in the container are
<a class="link" href="#beans-factory-scopes-singleton" title="4.5.1&nbsp;The singleton scope">singletons</a>. When a singleton bean needs to
collaborate with another singleton bean, or a non-singleton bean needs to collaborate
with another non-singleton bean, you typically handle the dependency by defining one
bean as a property of the other. A problem arises when the bean lifecycles are
different. Suppose singleton bean A needs to use non-singleton (prototype) bean B,
perhaps on each method invocation on A. The container only creates the singleton bean A
once, and thus only gets one opportunity to set the properties. The container cannot
provide bean A with a new instance of bean B every time one is needed.</p>
<p>A solution is to forego some inversion of control. You can <a class="link" href="#beans-factory-aware" title="4.6.2&nbsp;ApplicationContextAware and BeanNameAware">make
bean A aware of the container</a> by implementing the <code class="literal">ApplicationContextAware</code> interface,
and by <a class="link" href="#beans-factory-client" title="4.2.3&nbsp;Using the container">making a getBean("B") call to the container</a> ask for (a
typically new) bean B instance every time bean A needs it. The following is an example
of this approach:</p>
<pre class="programlisting"><span class="hl-comment">// a class that uses a stateful Command-style class to perform some processing</span>
<span class="hl-keyword">package</span> fiona.apple;

<span class="hl-comment">// Spring-API imports</span>
<span class="hl-keyword">import</span> org.springframework.beans.BeansException;
<span class="hl-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hl-keyword">import</span> org.springframework.context.ApplicationContextAware;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CommandManager <span class="hl-keyword">implements</span> ApplicationContextAware {

    <span class="hl-keyword">private</span> ApplicationContext applicationContext;

    <span class="hl-keyword">public</span> Object process(Map commandState) {
        <span class="hl-comment">// grab a new instance of the appropriate Command</span>
        Command command = createCommand();
        <span class="hl-comment">// set the state on the (hopefully brand new) Command instance</span>
        command.setState(commandState);
        <span class="hl-keyword">return</span> command.execute();
    }

    <span class="hl-keyword">protected</span> Command createCommand() {
        <span class="hl-comment">// notice the Spring API dependency!</span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.applicationContext.getBean(<span class="hl-string">"command"</span>, Command.<span class="hl-keyword">class</span>);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setApplicationContext(
            ApplicationContext applicationContext) <span class="hl-keyword">throws</span> BeansException {
        <span class="hl-keyword">this</span>.applicationContext = applicationContext;
    }
}</pre>

<p>The preceding is not desirable, because the business code is aware of and coupled to the
Spring Framework. Method Injection, a somewhat advanced feature of the Spring IoC
container, allows this use case to be handled in a clean fashion.</p>
<div class="sidebar"><p class="title"><b></b></p>
<p>You can read more about the motivation for Method Injection in
<a class="ulink" href="http://blog.springsource.com/2004/08/06/method-injection/" target="_top">this blog entry</a>.</p>
</div>

<div class="section" title="Lookup method injection"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-lookup-method-injection"></a>Lookup method injection</h4></div></div></div>

<p>Lookup method injection is the ability of the container to override methods on
<span class="emphasis"><em>container managed beans</em></span>, to return the lookup result for another named bean in the
container. The lookup typically involves a prototype bean as in the scenario described
in the preceding section. The Spring Framework implements this method injection by using
bytecode generation from the CGLIB library to generate dynamically a subclass that
overrides the method.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For this dynamic subclassing to work, the class that the Spring container will subclass
cannot be <code class="literal">final</code>, and the method to be overridden cannot be <code class="literal">final</code> either. Also,
testing a class that has an <code class="literal">abstract</code> method requires you to subclass the class
yourself and to supply a stub implementation of the <code class="literal">abstract</code> method. Finally, objects
that have been the target of method injection cannot be serialized. As of Spring 3.2 it
is no longer necessary to add CGLIB to your classpath, because CGLIB classes are
repackaged under org.springframework and distributed within the spring-core JAR. This is
done both for convenience as well as to avoid potential conflicts with other projects
that use differing versions of CGLIB.</p>
</td></tr></table></div>

<p>Looking at the <code class="literal">CommandManager</code> class in the previous code snippet, you see that the
Spring container will dynamically override the implementation of the <code class="literal">createCommand()</code>
method. Your <code class="literal">CommandManager</code> class will not have any Spring dependencies, as can be
seen in the reworked example:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> fiona.apple;

<span class="hl-comment">// no more Spring imports!</span>

<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> CommandManager {

    <span class="hl-keyword">public</span> Object process(Object commandState) {
        <span class="hl-comment">// grab a new instance of the appropriate Command interface</span>
        Command command = createCommand();
        <span class="hl-comment">// set the state on the (hopefully brand new) Command instance</span>
        command.setState(commandState);
        <span class="hl-keyword">return</span> command.execute();
    }

    <span class="hl-comment">// okay... but where is the implementation of this method?</span>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Command createCommand();
}</pre>

<p>In the client class containing the method to be injected (the <code class="literal">CommandManager</code> in this
case), the method to be injected requires a signature of the following form:</p>
<pre class="programlisting"><span class="hl-tag">&lt;public|protected&gt;</span> [abstract] <span class="hl-tag">&lt;return-type&gt;</span> theMethodName(no-arguments);</pre>

<p>If the method is <code class="literal">abstract</code>, the dynamically-generated subclass implements the method.
Otherwise, the dynamically-generated subclass overrides the concrete method defined in
the original class. For example:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- a stateful bean deployed as a prototype (non-singleton) --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"command"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"fiona.apple.AsyncCommand"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- inject dependencies here as required --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-comment">&lt;!-- commandProcessor uses statefulCommandHelper --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"commandManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"fiona.apple.CommandManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;lookup-method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"createCommand"</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"command"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The bean identified as <span class="emphasis"><em>commandManager</em></span> calls its own method <code class="literal">createCommand()</code>
whenever it needs a new instance of the <span class="emphasis"><em>command</em></span> bean. You must be careful to deploy
the <code class="literal">command</code> bean as a prototype, if that is actually what is needed. If it is deployed
as a <a class="link" href="#beans-factory-scopes-singleton" title="4.5.1&nbsp;The singleton scope">singleton</a>, the same instance of the <code class="literal">command</code>
bean is returned each time.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The interested reader may also find the <code class="literal">ServiceLocatorFactoryBean</code> (in the
<code class="literal">org.springframework.beans.factory.config</code> package) to be of use. The approach used in
ServiceLocatorFactoryBean is similar to that of another utility class,
<code class="literal">ObjectFactoryCreatingFactoryBean</code>, but it allows you to specify your own lookup
interface as opposed to a Spring-specific lookup interface. Consult the JavaDocs for
these classes for additional information.</p>
</td></tr></table></div>

</div>
<div class="section" title="Arbitrary method replacement"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-arbitrary-method-replacement"></a>Arbitrary method replacement</h4></div></div></div>

<p>A less useful form of method injection than lookup method Injection is the ability to
replace arbitrary methods in a managed bean with another method implementation. Users
may safely skip the rest of this section until the functionality is actually needed.</p>
<p>With XML-based configuration metadata, you can use the <code class="literal">replaced-method</code> element to
replace an existing method implementation with another, for a deployed bean. Consider
the following class, with a method computeValue, which we want to override:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyValueCalculator {

    <span class="hl-keyword">public</span> String computeValue(String input) {
        <span class="hl-comment">// some real code...</span>
    }

    <span class="hl-comment">// some other methods...</span>

}</pre>

<p>A class implementing the <code class="literal">org.springframework.beans.factory.support.MethodReplacer</code>
interface provides the new method definition.</p>
<pre class="programlisting"><b class="hl-tag" style="color: blue">/**
 * meant to be used to override the existing computeValue(String)
 * implementation in MyValueCalculator
 */</b>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ReplacementComputeValue <span class="hl-keyword">implements</span> MethodReplacer {

    <span class="hl-keyword">public</span> Object reimplement(Object o, Method m, Object[] args) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// get the input value, work with it, and return a computed result</span>
        String input = (String) args[<span class="hl-number">0</span>];
        ...
        <span class="hl-keyword">return</span> ...;
    }
}</pre>

<p>The bean definition to deploy the original class and specify the method override would
look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myValueCalculator"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.z.MyValueCalculator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- arbitrary method replacement --&gt;</span>
    <span class="hl-tag">&lt;replaced-method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"computeValue"</span> <span class="hl-attribute">replacer</span>=<span class="hl-value">"replacementComputeValue"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;arg-type&gt;</span>String<span class="hl-tag">&lt;/arg-type&gt;</span>
    <span class="hl-tag">&lt;/replaced-method&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"replacementComputeValue"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"a.b.c.ReplacementComputeValue"</span><span class="hl-tag">/&gt;</span></pre>

<p>You can use one or more contained <code class="literal">&lt;arg-type/&gt;</code> elements within the <code class="literal">&lt;replaced-method/&gt;</code>
element to indicate the method signature of the method being overridden. The signature
for the arguments is necessary only if the method is overloaded and multiple variants
exist within the class. For convenience, the type string for an argument may be a
substring of the fully qualified type name. For example, the following all match
<code class="literal">java.lang.String</code>:</p>
<pre class="programlisting">java.lang.String
String
Str</pre>

<p>Because the number of arguments is often enough to distinguish between each possible
choice, this shortcut can save a lot of typing, by allowing you to type only the
shortest string that will match an argument type.</p>
</div>
</div>
</div>
<div class="section" title="4.5&nbsp;Bean scopes"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-factory-scopes"></a>4.5&nbsp;Bean scopes</h2></div></div></div>

<p>When you create a bean definition, you create a <span class="emphasis"><em>recipe</em></span> for creating actual instances
of the class defined by that bean definition. The idea that a bean definition is a
recipe is important, because it means that, as with a class, you can create many object
instances from a single recipe.</p>
<p>You can control not only the various dependencies and configuration values that are to
be plugged into an object that is created from a particular bean definition, but also
the <span class="emphasis"><em>scope</em></span> of the objects created from a particular bean definition. This approach is
powerful and flexible in that you can <span class="emphasis"><em>choose</em></span> the scope of the objects you create
through configuration instead of having to bake in the scope of an object at the Java
class level. Beans can be defined to be deployed in one of a number of scopes: out of
the box, the Spring Framework supports five scopes, three of which are available only if
you use a web-aware <code class="literal">ApplicationContext</code>.</p>
<p>The following scopes are supported out of the box. You can also create
<a class="link" href="#beans-factory-scopes-custom" title="4.5.5&nbsp;Custom scopes">a custom scope.</a></p>
<div class="table"><a name="beans-factory-scopes-tbl"></a><p class="title"><b>Table&nbsp;4.3.&nbsp;Bean scopesThread-scoped beans</b></p><div class="table-contents">

  <table summary="Bean scopesThread-scoped beans" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Scope</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#beans-factory-scopes-singleton" title="4.5.1&nbsp;The singleton scope">singleton</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>(Default) Scopes a single bean definition to a single object instance per Spring IoC
  container.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#beans-factory-scopes-prototype" title="4.5.2&nbsp;The prototype scope">prototype</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Scopes a single bean definition to any number of object instances.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#beans-factory-scopes-request" title="Request scope">request</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Scopes a single bean definition to the lifecycle of a single HTTP request; that is,
  each HTTP request has its own instance of a bean created off the back of a single bean
  definition. Only valid in the context of a web-aware Spring <code class="literal">ApplicationContext</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#beans-factory-scopes-session" title="Session scope">session</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Scopes a single bean definition to the lifecycle of an HTTP <code class="literal">Session</code>. Only valid in
  the context of a web-aware Spring <code class="literal">ApplicationContext</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#beans-factory-scopes-global-session" title="Global session scope">global session</a></p></td><td style="" align="left" valign="top"><p>Scopes a single bean definition to the lifecycle of a global HTTP <code class="literal">Session</code>. Typically
  only valid when used in a portlet context. Only valid in the context of a web-aware
  Spring <code class="literal">ApplicationContext</code>.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As of Spring 3.0, a <span class="emphasis"><em>thread scope</em></span> is available, but is not registered by default. For
more information, see the documentation for
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/support/SimpleThreadScope.html" target="_top"><code class="literal">SimpleThreadScope</code></a>.
For instructions on how to register this or any other custom scope, see
<a class="xref" href="#beans-factory-scopes-custom-using" title="Using a custom scope">the section called &#8220;Using a custom scope&#8221;</a>.</p>
</td></tr></table></div>

<div class="section" title="4.5.1&nbsp;The singleton scope"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-scopes-singleton"></a>4.5.1&nbsp;The singleton scope</h3></div></div></div>

<p>Only one <span class="emphasis"><em>shared</em></span> instance of a singleton bean is managed, and all requests for beans
with an id or ids matching that bean definition result in that one specific bean
instance being returned by the Spring container.</p>
<p>To put it another way, when you define a bean definition and it is scoped as a
singleton, the Spring IoC container creates <span class="emphasis"><em>exactly one</em></span> instance of the object
defined by that bean definition. This single instance is stored in a cache of such
singleton beans, and <span class="emphasis"><em>all subsequent requests and references</em></span> for that named bean
return the cached object.</p>
<div class="figure"><a name="d4e1699"></a><p class="title"><b>Figure&nbsp;4.2.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/singleton.png" alt="singleton"></div>
</div></div><br class="figure-break">

<p>Spring&#8217;s concept of a singleton bean differs from the Singleton pattern as defined in
the Gang of Four (GoF) patterns book. The GoF Singleton hard-codes the scope of an
object such that one <span class="emphasis"><em>and only one</em></span> instance of a particular class is created <span class="emphasis"><em>per
ClassLoader</em></span>. The scope of the Spring singleton is best described as <span class="emphasis"><em>per container
and per bean</em></span>. This means that if you define one bean for a particular class in a
single Spring container, then the Spring container creates one <span class="emphasis"><em>and only one</em></span> instance
of the class defined by that bean definition. <span class="emphasis"><em>The singleton scope is the default scope
in Spring</em></span>. To define a bean as a singleton in XML, you would write, for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.DefaultAccountService"</span><span class="hl-tag">/&gt;</span>

<span class="hl-comment">&lt;!-- the following is equivalent, though redundant (singleton scope is the default) --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.DefaultAccountService"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"singleton"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="4.5.2&nbsp;The prototype scope"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-scopes-prototype"></a>4.5.2&nbsp;The prototype scope</h3></div></div></div>

<p>The non-singleton, prototype scope of bean deployment results in the <span class="emphasis"><em>creation of a new
bean instance</em></span> every time a request for that specific bean is made. That is, the bean
is injected into another bean or you request it through a <code class="literal">getBean()</code> method call on the
container. As a rule, use the prototype scope for all stateful beans and the singleton
scope for stateless beans.</p>
<p>The following diagram illustrates the Spring prototype scope. <span class="emphasis"><em>A data access object
(DAO) is not typically configured as a prototype, because a typical DAO does not hold
any conversational state; it was just easier for this author to reuse the core of the
singleton diagram.</em></span></p>
<div class="figure"><a name="d4e1719"></a><p class="title"><b>Figure&nbsp;4.3.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/prototype.png" alt="prototype"></div>
</div></div><br class="figure-break">

<p>The following example defines a bean as a prototype in XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.DefaultAccountService"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span></pre>

<p>In contrast to the other scopes, Spring does not manage the complete lifecycle of a
prototype bean: the container instantiates, configures, and otherwise assembles a
prototype object, and hands it to the client, with no further record of that prototype
instance. Thus, although<span class="emphasis"><em> initialization</em></span> lifecycle callback methods are called on all
objects regardless of scope, in the case of prototypes, configured <span class="emphasis"><em>destruction</em></span>
lifecycle callbacks are <span class="emphasis"><em>not</em></span> called. The client code must clean up prototype-scoped
objects and release expensive resources that the prototype bean(s) are holding. To get
the Spring container to release resources held by prototype-scoped beans, try using a
custom <a class="link" href="#beans-factory-extension-bpp" title="4.8.1&nbsp;Customizing beans using a BeanPostProcessor">bean post-processor</a>, which holds a reference to
beans that need to be cleaned up.</p>
<p>In some respects, the Spring container&#8217;s role in regard to a prototype-scoped bean is a
replacement for the Java <code class="literal">new</code> operator. All lifecycle management past that point must
be handled by the client. (For details on the lifecycle of a bean in the Spring
container, see <a class="xref" href="#beans-factory-lifecycle" title="4.6.1&nbsp;Lifecycle callbacks">Section&nbsp;4.6.1, &#8220;Lifecycle callbacks&#8221;</a>.)</p>
</div>
<div class="section" title="4.5.3&nbsp;Singleton beans with prototype-bean dependencies"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-scopes-sing-prot-interaction"></a>4.5.3&nbsp;Singleton beans with prototype-bean dependencies</h3></div></div></div>

<p>When you use singleton-scoped beans with dependencies on prototype beans, be aware that
<span class="emphasis"><em>dependencies are resolved at instantiation time</em></span>. Thus if you dependency-inject a
prototype-scoped bean into a singleton-scoped bean, a new prototype bean is instantiated
and then dependency-injected into the singleton bean. The prototype instance is the sole
instance that is ever supplied to the singleton-scoped bean.</p>
<p>However, suppose you want the singleton-scoped bean to acquire a new instance of the
prototype-scoped bean repeatedly at runtime. You cannot dependency-inject a
prototype-scoped bean into your singleton bean, because that injection occurs only
<span class="emphasis"><em>once</em></span>, when the Spring container is instantiating the singleton bean and resolving
and injecting its dependencies. If you need a new instance of a prototype bean at
runtime more than once, see <a class="xref" href="#beans-factory-method-injection" title="4.4.6&nbsp;Method injection">Section&nbsp;4.4.6, &#8220;Method injection&#8221;</a></p>
</div>
<div class="section" title="4.5.4&nbsp;Request, session, and global session scopes"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-scopes-other"></a>4.5.4&nbsp;Request, session, and global session scopes</h3></div></div></div>

<p>The <code class="literal">request</code>, <code class="literal">session</code>, and <code class="literal">global session</code> scopes are <span class="emphasis"><em>only</em></span> available if you use
a web-aware Spring <code class="literal">ApplicationContext</code> implementation (such as
<code class="literal">XmlWebApplicationContext</code>). If you use these scopes with regular Spring IoC containers
such as the <code class="literal">ClassPathXmlApplicationContext</code>, you get an <code class="literal">IllegalStateException</code>
complaining about an unknown bean scope.</p>
<div class="section" title="Initial web configuration"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-scopes-other-web-configuration"></a>Initial web configuration</h4></div></div></div>

<p>To support the scoping of beans at the <code class="literal">request</code>, <code class="literal">session</code>, and <code class="literal">global session</code> levels
(web-scoped beans), some minor initial configuration is required before you define your
beans. (This initial setup is <span class="emphasis"><em>not</em></span> required for the standard scopes, singleton and
prototype.)</p>
<p>How you accomplish this initial setup depends on your particular Servlet environment..</p>
<p>If you access scoped beans within Spring Web MVC, in effect, within a request that is
processed by the Spring <code class="literal">DispatcherServlet</code>, or <code class="literal">DispatcherPortlet</code>, then no special
setup is necessary: <code class="literal">DispatcherServlet</code> and <code class="literal">DispatcherPortlet</code> already expose all
relevant state.</p>
<p>If you use a Servlet 2.5 web container, with requests processed outside of Spring&#8217;s
DispatcherServlet (for example, when using JSF or Struts), you need to register the
<code class="literal">org.springframework.web.context.request.RequestContextListener</code> <code class="literal">ServletRequestListener</code>.
For Servlet 3.0+, this can done programmatically via the <code class="literal">WebApplicationInitializer</code>
interface. Alternatively, or for older containers, add the following declaration to
your web application&#8217;s <code class="literal">web.xml</code> file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app&gt;</span>
    ...
    <span class="hl-tag">&lt;listener&gt;</span>
        <span class="hl-tag">&lt;listener-class&gt;</span>
            org.springframework.web.context.request.RequestContextListener
        <span class="hl-tag">&lt;/listener-class&gt;</span>
    <span class="hl-tag">&lt;/listener&gt;</span>
    ...
<span class="hl-tag">&lt;/web-app&gt;</span></pre>

<p>Alternatively, if there are issues with your listener setup, consider the provided
<code class="literal">RequestContextFilter</code>. The filter mapping depends on the surrounding web
application configuration, so you have to change it as appropriate.</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app&gt;</span>
    ...
    <span class="hl-tag">&lt;filter&gt;</span>
        <span class="hl-tag">&lt;filter-name&gt;</span>requestContextFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
        <span class="hl-tag">&lt;filter-class&gt;</span>org.springframework.web.filter.RequestContextFilter<span class="hl-tag">&lt;/filter-class&gt;</span>
    <span class="hl-tag">&lt;/filter&gt;</span>
    <span class="hl-tag">&lt;filter-mapping&gt;</span>
        <span class="hl-tag">&lt;filter-name&gt;</span>requestContextFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
        <span class="hl-tag">&lt;url-pattern&gt;</span>/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
    <span class="hl-tag">&lt;/filter-mapping&gt;</span>
    ...
<span class="hl-tag">&lt;/web-app&gt;</span></pre>

<p><code class="literal">DispatcherServlet</code>, <code class="literal">RequestContextListener</code> and <code class="literal">RequestContextFilter</code> all do exactly
the same thing, namely bind the HTTP request object to the <code class="literal">Thread</code> that is servicing
that request. This makes beans that are request- and session-scoped available further
down the call chain.</p>
</div>
<div class="section" title="Request scope"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-scopes-request"></a>Request scope</h4></div></div></div>

<p>Consider the following bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loginAction"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.LoginAction"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"request"</span><span class="hl-tag">/&gt;</span></pre>

<p>The Spring container creates a new instance of the <code class="literal">LoginAction</code> bean by using the
<code class="literal">loginAction</code> bean definition for each and every HTTP request. That is, the
<code class="literal">loginAction</code> bean is scoped at the HTTP request level. You can change the internal
state of the instance that is created as much as you want, because other instances
created from the same <code class="literal">loginAction</code> bean definition will not see these changes in state;
they are particular to an individual request. When the request completes processing, the
bean that is scoped to the request is discarded.</p>
</div>
<div class="section" title="Session scope"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-scopes-session"></a>Session scope</h4></div></div></div>

<p>Consider the following bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.UserPreferences"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"session"</span><span class="hl-tag">/&gt;</span></pre>

<p>The Spring container creates a new instance of the <code class="literal">UserPreferences</code> bean by using the
<code class="literal">userPreferences</code> bean definition for the lifetime of a single HTTP <code class="literal">Session</code>. In other
words, the <code class="literal">userPreferences</code> bean is effectively scoped at the HTTP <code class="literal">Session</code> level. As
with <code class="literal">request-scoped</code> beans, you can change the internal state of the instance that is
created as much as you want, knowing that other HTTP <code class="literal">Session</code> instances that are also
using instances created from the same <code class="literal">userPreferences</code> bean definition do not see these
changes in state, because they are particular to an individual HTTP <code class="literal">Session</code>. When the
HTTP <code class="literal">Session</code> is eventually discarded, the bean that is scoped to that particular HTTP
<code class="literal">Session</code> is also discarded.</p>
</div>
<div class="section" title="Global session scope"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-scopes-global-session"></a>Global session scope</h4></div></div></div>

<p>Consider the following bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.UserPreferences"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"globalSession"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">global session</code> scope is similar to the standard HTTP <code class="literal">Session</code> scope
(<a class="link" href="#beans-factory-scopes-session" title="Session scope">described above</a>), and applies only in the context of
portlet-based web applications. The portlet specification defines the notion of a global
<code class="literal">Session</code> that is shared among all portlets that make up a single portlet web
application. Beans defined at the <code class="literal">global session</code> scope are scoped (or bound) to the
lifetime of the global portlet <code class="literal">Session</code>.</p>
<p>If you write a standard Servlet-based web application and you define one or more beans
as having <code class="literal">global session</code> scope, the standard HTTP <code class="literal">Session</code> scope is used, and no
error is raised.</p>
</div>
<div class="section" title="Scoped beans as dependencies"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-scopes-other-injection"></a>Scoped beans as dependencies</h4></div></div></div>

<p>The Spring IoC container manages not only the instantiation of your objects (beans), but
also the wiring up of collaborators (or dependencies). If you want to inject (for
example) an HTTP request scoped bean into another bean, you must inject an AOP proxy in
place of the scoped bean. That is, you need to inject a proxy object that exposes the
same public interface as the scoped object but that can also retrieve the real, target
object from the relevant scope (for example, an HTTP request) and delegate method calls
onto the real object.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You <span class="emphasis"><em>do not</em></span> need to use the <code class="literal">&lt;aop:scoped-proxy/&gt;</code> in conjunction with beans that are
scoped as <code class="literal">singletons</code> or <code class="literal">prototypes</code>.</p>
</td></tr></table></div>

<p>The configuration in the following example is only one line, but it is important to
understand the "why" as well as the "how" behind it.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- an HTTP Session-scoped bean exposed as a proxy --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.UserPreferences"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"session"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- instructs the container to proxy the surrounding bean --&gt;</span>
        <span class="hl-tag">&lt;aop:scoped-proxy/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- a singleton-scoped bean injected with a proxy to the above bean --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.SimpleUserService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- a reference to the proxied userPreferences bean --&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"userPreferences"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>To create such a proxy, you insert a child <code class="literal">&lt;aop:scoped-proxy/&gt;</code> element into a scoped
bean definition. See <a class="xref" href="#beans-factory-scopes-other-injection-proxies" title="Choosing the type of proxy to create">the section called &#8220;Choosing the type of proxy to create&#8221;</a> and
<a class="xref" href="#xsd-config" title="33.&nbsp;XML Schema-based configuration">Chapter&nbsp;33, <i>XML Schema-based configuration</i></a>.) Why do definitions of beans scoped at the <code class="literal">request</code>, <code class="literal">session</code>,
<code class="literal">globalSession</code> and custom-scope levels require the <code class="literal">&lt;aop:scoped-proxy/&gt;</code> element ?
Let&#8217;s examine the following singleton bean definition and contrast it with what you need
to define for the aforementioned scopes. (The following <code class="literal">userPreferences</code> bean
definition as it stands is <span class="emphasis"><em>incomplete.)</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.UserPreferences"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"session"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.UserManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"userPreferences"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In the preceding example, the singleton bean <code class="literal">userManager</code> is injected with a reference
to the HTTP <code class="literal">Session</code>-scoped bean <code class="literal">userPreferences</code>. The salient point here is that the
<code class="literal">userManager</code> bean is a singleton: it will be instantiated <span class="emphasis"><em>exactly once</em></span> per
container, and its dependencies (in this case only one, the <code class="literal">userPreferences</code> bean) are
also injected only once. This means that the <code class="literal">userManager</code> bean will only operate on the
exact same <code class="literal">userPreferences</code> object, that is, the one that it was originally injected
with.</p>
<p>This is <span class="emphasis"><em>not</em></span> the behavior you want when injecting a shorter-lived scoped bean into a
longer-lived scoped bean, for example injecting an HTTP <code class="literal">Session</code>-scoped collaborating
bean as a dependency into singleton bean. Rather, you need a single <code class="literal">userManager</code>
object, and for the lifetime of an HTTP <code class="literal">Session</code>, you need a <code class="literal">userPreferences</code> object
that is specific to said HTTP <code class="literal">Session</code>. Thus the container creates an object that
exposes the exact same public interface as the <code class="literal">UserPreferences</code> class (ideally an
object that <span class="emphasis"><em>is a</em></span> <code class="literal">UserPreferences</code> instance) which can fetch the real
<code class="literal">UserPreferences</code> object from the scoping mechanism (HTTP request, <code class="literal">Session</code>, etc.). The
container injects this proxy object into the <code class="literal">userManager</code> bean, which is unaware that
this <code class="literal">UserPreferences</code> reference is a proxy. In this example, when a <code class="literal">UserManager</code>
instance invokes a method on the dependency-injected <code class="literal">UserPreferences</code> object, it
actually is invoking a method on the proxy. The proxy then fetches the real
<code class="literal">UserPreferences</code> object from (in this case) the HTTP <code class="literal">Session</code>, and delegates the
method invocation onto the retrieved real <code class="literal">UserPreferences</code> object.</p>
<p>Thus you need the following, correct and complete, configuration when injecting
<code class="literal">request-</code>, <code class="literal">session-</code>, and <code class="literal">globalSession-scoped</code> beans into collaborating objects:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.UserPreferences"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"session"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;aop:scoped-proxy/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.UserManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"userPreferences"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="section" title="Choosing the type of proxy to create"><div class="titlepage"><div><div><h5 class="title"><a name="beans-factory-scopes-other-injection-proxies"></a>Choosing the type of proxy to create</h5></div></div></div>

<p>By default, when the Spring container creates a proxy for a bean that is marked up with
the <code class="literal">&lt;aop:scoped-proxy/&gt;</code> element, <span class="emphasis"><em>a CGLIB-based class proxy is created</em></span>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>CGLIB proxies only intercept public method calls! Do not call non-public
methods on such a proxy; they will not be delegated to the scoped target object.</p>
</td></tr></table></div>

<p>Alternatively, you can configure the Spring container to create standard JDK
interface-based proxies for such scoped beans, by specifying <code class="literal">false</code> for the value of
the <code class="literal">proxy-target-class</code> attribute of the <code class="literal">&lt;aop:scoped-proxy/&gt;</code> element. Using JDK
interface-based proxies means that you do not need additional libraries in your
application classpath to effect such proxying. However, it also means that the class of
the scoped bean must implement at least one interface, and <span class="emphasis"><em>that all</em></span> collaborators
into which the scoped bean is injected must reference the bean through one of its
interfaces.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- DefaultUserPreferences implements the UserPreferences interface --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.DefaultUserPreferences"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"session"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;aop:scoped-proxy</span> <span class="hl-attribute">proxy-target-class</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.UserManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userPreferences"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"userPreferences"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>For more detailed information about choosing class-based or interface-based proxying,
see <a class="xref" href="#aop-proxying" title="8.6&nbsp;Proxying mechanisms">Section&nbsp;8.6, &#8220;Proxying mechanisms&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section" title="4.5.5&nbsp;Custom scopes"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-scopes-custom"></a>4.5.5&nbsp;Custom scopes</h3></div></div></div>

<p>The bean scoping mechanism is extensible; You can define your own
scopes, or even redefine existing scopes, although the latter is considered bad practice
and you <span class="emphasis"><em>cannot</em></span> override the built-in <code class="literal">singleton</code> and <code class="literal">prototype</code> scopes.</p>
<div class="section" title="Creating a custom scope"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-scopes-custom-creating"></a>Creating a custom scope</h4></div></div></div>

<p>To integrate your custom scope(s) into the Spring container, you need to implement the
<code class="literal">org.springframework.beans.factory.config.Scope</code> interface, which is described in this
section. For an idea of how to implement your own scopes, see the <code class="literal">Scope</code>
implementations that are supplied with the Spring Framework itself and the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/config/Scope.html" target="_top"><code class="literal">Scope</code>
Javadoc</a>, which explains the methods you need to implement in more detail.</p>
<p>The <code class="literal">Scope</code> interface has four methods to get objects from the scope, remove them from
the scope, and allow them to be destroyed.</p>
<p>The following method returns the object from the underlying scope. The session scope
implementation, for example, returns the session-scoped bean (and if it does not exist,
the method returns a new instance of the bean, after having bound it to the session for
future reference).</p>
<pre class="programlisting">Object get(String name, ObjectFactory objectFactory)</pre>

<p>The following method removes the object from the underlying scope. The session scope
implementation for example, removes the session-scoped bean from the underlying session.
The object should be returned, but you can return null if the object with the specified
name is not found.</p>
<pre class="programlisting">Object remove(String name)</pre>

<p>The following method registers the callbacks the scope should execute when it is
destroyed or when the specified object in the scope is destroyed. Refer to the Javadoc
or a Spring scope implementation for more information on destruction callbacks.</p>
<pre class="programlisting"><span class="hl-keyword">void</span> registerDestructionCallback(String name, Runnable destructionCallback)</pre>

<p>The following method obtains the conversation identifier for the underlying scope. This
identifier is different for each scope. For a session scoped implementation, this
identifier can be the session identifier.</p>
<pre class="programlisting">String getConversationId()</pre>

</div>
<div class="section" title="Using a custom scope"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-scopes-custom-using"></a>Using a custom scope</h4></div></div></div>

<p>After you write and test one or more custom <code class="literal">Scope</code> implementations, you need to make
the Spring container aware of your new scope(s). The following method is the central
method to register a new <code class="literal">Scope</code> with the Spring container:</p>
<pre class="programlisting"><span class="hl-keyword">void</span> registerScope(String scopeName, Scope scope);</pre>

<p>This method is declared on the <code class="literal">ConfigurableBeanFactory</code> interface, which is available
on most of the concrete <code class="literal">ApplicationContext</code> implementations that ship with Spring via
the BeanFactory property.</p>
<p>The first argument to the <code class="literal">registerScope(..)</code> method is the unique name associated with
a scope; examples of such names in the Spring container itself are <code class="literal">singleton</code> and
<code class="literal">prototype</code>. The second argument to the <code class="literal">registerScope(..)</code> method is an actual instance
of the custom <code class="literal">Scope</code> implementation that you wish to register and use.</p>
<p>Suppose that you write your custom <code class="literal">Scope</code> implementation, and then register it as below.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The example below uses <code class="literal">SimpleThreadScope</code> which is included with Spring, but not
registered by default. The instructions would be the same for your own custom <code class="literal">Scope</code>
implementations.</p>
</td></tr></table></div>

<pre class="programlisting">Scope threadScope = <span class="hl-keyword">new</span> SimpleThreadScope();
beanFactory.registerScope(<span class="hl-string">"thread"</span>, threadScope);</pre>

<p>You then create bean definitions that adhere to the scoping rules of your custom <code class="literal">Scope</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"..."</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"thread"</span><span class="hl-tag">&gt;</span></pre>

<p>With a custom <code class="literal">Scope</code> implementation, you are not limited to programmatic registration
of the scope. You can also do the <code class="literal">Scope</code> registration declaratively, using the
<code class="literal">CustomScopeConfigurer</code> class:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.CustomScopeConfigurer"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"scopes"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"thread"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.context.support.SimpleThreadScope"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/entry&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.Bar"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"thread"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Rick"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;aop:scoped-proxy/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.Foo"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When you place &lt;aop:scoped-proxy/&gt; in a <code class="literal">FactoryBean</code> implementation, it is the factory
bean itself that is scoped, not the object returned from <code class="literal">getObject()</code>.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section" title="4.6&nbsp;Customizing the nature of a bean"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-factory-nature"></a>4.6&nbsp;Customizing the nature of a bean</h2></div></div></div>

<div class="section" title="4.6.1&nbsp;Lifecycle callbacks"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-lifecycle"></a>4.6.1&nbsp;Lifecycle callbacks</h3></div></div></div>

<p>To interact with the container&#8217;s management of the bean lifecycle, you can implement the
Spring <code class="literal">InitializingBean</code> and <code class="literal">DisposableBean</code> interfaces. The container calls
<code class="literal">afterPropertiesSet()</code> for the former and <code class="literal">destroy()</code> for the latter to allow the bean
to perform certain actions upon initialization and destruction of your beans.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The JSR-250 <code class="literal">@PostConstruct</code> and <code class="literal">@PreDestroy</code> annotations are generally considered best
practice for receiving lifecycle callbacks in a modern Spring application. Using these
annotations means that your beans are not coupled to Spring specific interfaces. For
details see <a class="xref" href="#beans-postconstruct-and-predestroy-annotations" title="4.9.7&nbsp;@PostConstruct and @PreDestroy">Section&nbsp;4.9.7, &#8220;@PostConstruct and @PreDestroy&#8221;</a>.</p>
<p>If you don&#8217;t want to use the JSR-250 annotations but you are still looking to remove
coupling consider the use of init-method and destroy-method object definition metadata.</p>
</td></tr></table></div>

<p>Internally, the Spring Framework uses <code class="literal">BeanPostProcessor</code> implementations to process any
callback interfaces it can find and call the appropriate methods. If you need custom
features or other lifecycle behavior Spring does not offer out-of-the-box, you can
implement a <code class="literal">BeanPostProcessor</code> yourself. For more information, see
<a class="xref" href="#beans-factory-extension" title="4.8&nbsp;Container Extension Points">Section&nbsp;4.8, &#8220;Container Extension Points&#8221;</a>.</p>
<p>In addition to the initialization and destruction callbacks, Spring-managed objects may
also implement the <code class="literal">Lifecycle</code> interface so that those objects can participate in the
startup and shutdown process as driven by the container&#8217;s own lifecycle.</p>
<p>The lifecycle callback interfaces are described in this section.</p>
<div class="section" title="Initialization callbacks"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-lifecycle-initializingbean"></a>Initialization callbacks</h4></div></div></div>

<p>The <code class="literal">org.springframework.beans.factory.InitializingBean</code> interface allows a bean to
perform initialization work after all necessary properties on the bean have been set by
the container. The <code class="literal">InitializingBean</code> interface specifies a single method:</p>
<pre class="programlisting"><span class="hl-keyword">void</span> afterPropertiesSet() <span class="hl-keyword">throws</span> Exception;</pre>

<p>It is recommended that you do not use the <code class="literal">InitializingBean</code> interface because it
unnecessarily couples the code to Spring. Alternatively, use
the <a class="link" href="#beans-postconstruct-and-predestroy-annotations" title="4.9.7&nbsp;@PostConstruct and @PreDestroy"><code class="literal">@PostConstruct</code></a> annotation or
specify a POJO initialization method. In the case of XML-based configuration metadata,
you use the <code class="literal">init-method</code> attribute to specify the name of the method that has a void
no-argument signature. For example, the following definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleInitBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span> <span class="hl-attribute">init-method</span>=<span class="hl-value">"init"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBean {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() {
        <span class="hl-comment">// do some initialization work</span>
    }

}</pre>

<p>&#8230;is exactly the same as&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleInitBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.AnotherExampleBean"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnotherExampleBean <span class="hl-keyword">implements</span> InitializingBean {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterPropertiesSet() {
        <span class="hl-comment">// do some initialization work</span>
    }

}</pre>

<p>but does not couple the code to Spring.</p>
</div>
<div class="section" title="Destruction callbacks"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-lifecycle-disposablebean"></a>Destruction callbacks</h4></div></div></div>

<p>Implementing the <code class="literal">org.springframework.beans.factory.DisposableBean</code> interface allows a
bean to get a callback when the container containing it is destroyed. The
<code class="literal">DisposableBean</code> interface specifies a single method:</p>
<pre class="programlisting"><span class="hl-keyword">void</span> destroy() <span class="hl-keyword">throws</span> Exception;</pre>

<p>It is recommended that you do not use the <code class="literal">DisposableBean</code> callback interface because it
unnecessarily couples the code to Spring. Alternatively, use
the <a class="link" href="#beans-postconstruct-and-predestroy-annotations" title="4.9.7&nbsp;@PostConstruct and @PreDestroy"><code class="literal">@PreDestroy</code></a> annotation or
specify a generic method that is supported by bean definitions. With XML-based
configuration metadata, you use the <code class="literal">destroy-method</code> attribute on the <code class="literal">&lt;bean/&gt;</code>. For
example, the following definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleInitBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBean"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"cleanup"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBean {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> cleanup() {
        <span class="hl-comment">// do some destruction work (like releasing pooled connections)</span>
    }

}</pre>

<p>is exactly the same as:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleInitBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.AnotherExampleBean"</span><span class="hl-tag">/&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnotherExampleBean <span class="hl-keyword">implements</span> DisposableBean {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> destroy() {
        <span class="hl-comment">// do some destruction work (like releasing pooled connections)</span>
    }

}</pre>

<p>but does not couple the code to Spring.</p>
</div>
<div class="section" title="Default initialization and destroy methods"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-lifecycle-default-init-destroy-methods"></a>Default initialization and destroy methods</h4></div></div></div>

<p>When you write initialization and destroy method callbacks that do not use the
Spring-specific <code class="literal">InitializingBean</code> and <code class="literal">DisposableBean</code> callback interfaces, you
typically write methods with names such as <code class="literal">init()</code>, <code class="literal">initialize()</code>, <code class="literal">dispose()</code>, and so
on. Ideally, the names of such lifecycle callback methods are standardized across a
project so that all developers use the same method names and ensure consistency.</p>
<p>You can configure the Spring container to <code class="literal">look</code> for named initialization and destroy
callback method names on <span class="emphasis"><em>every</em></span> bean. This means that you, as an application
developer, can write your application classes and use an initialization callback called
<code class="literal">init()</code>, without having to configure an <code class="literal">init-method="init"</code> attribute with each bean
definition. The Spring IoC container calls that method when the bean is created (and in
accordance with the standard lifecycle callback contract described previously). This
feature also enforces a consistent naming convention for initialization and destroy
method callbacks.</p>
<p>Suppose that your initialization callback methods are named <code class="literal">init()</code> and destroy
callback methods are named <code class="literal">destroy()</code>. Your class will resemble the class in the
following example.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultBlogService <span class="hl-keyword">implements</span> BlogService {

    <span class="hl-keyword">private</span> BlogDao blogDao;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setBlogDao(BlogDao blogDao) {
        <span class="hl-keyword">this</span>.blogDao = blogDao;
    }

    <span class="hl-comment">// this is (unsurprisingly) the initialization callback method</span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() {
        <span class="hl-keyword">if</span> (<span class="hl-keyword">this</span>.blogDao == null) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> IllegalStateException(<span class="hl-string">"The [blogDao] property must be set."</span>);
        }
    }

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">default-init-method</span>=<span class="hl-value">"init"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"blogService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.DefaultBlogService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"blogDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"blogDao"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The presence of the <code class="literal">default-init-method</code> attribute on the top-level <code class="literal">&lt;beans/&gt;</code> element
attribute causes the Spring IoC container to recognize a method called <code class="literal">init</code> on beans
as the initialization method callback. When a bean is created and assembled, if the bean
class has such a method, it is invoked at the appropriate time.</p>
<p>You configure destroy method callbacks similarly (in XML, that is) by using the
<code class="literal">default-destroy-method</code> attribute on the top-level <code class="literal">&lt;beans/&gt;</code> element.</p>
<p>Where existing bean classes already have callback methods that are named at variance
with the convention, you can override the default by specifying (in XML, that is) the
method name using the <code class="literal">init-method</code> and <code class="literal">destroy-method</code> attributes of the &lt;bean/&gt;
itself.</p>
<p>The Spring container guarantees that a configured initialization callback is called
immediately after a bean is supplied with all dependencies. Thus the initialization
callback is called on the raw bean reference, which means that AOP interceptors and so
forth are not yet applied to the bean. A target bean is fully created <span class="emphasis"><em>first</em></span>,
<span class="emphasis"><em>then</em></span> an AOP proxy (for example) with its interceptor chain is applied. If the target
bean and the proxy are defined separately, your code can even interact with the raw
target bean, bypassing the proxy. Hence, it would be inconsistent to apply the
interceptors to the init method, because doing so would couple the lifecycle of the
target bean with its proxy/interceptors and leave strange semantics when your code
interacts directly to the raw target bean.</p>
</div>
<div class="section" title="Combining lifecycle mechanisms"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-lifecycle-combined-effects"></a>Combining lifecycle mechanisms</h4></div></div></div>

<p>As of Spring 2.5, you have three options for controlling bean lifecycle behavior: the
<a class="link" href="#beans-factory-lifecycle-initializingbean" title="Initialization callbacks"><code class="literal">InitializingBean</code></a> and
<a class="link" href="#beans-factory-lifecycle-disposablebean" title="Destruction callbacks"><code class="literal">DisposableBean</code></a> callback interfaces; custom
<code class="literal">init()</code> and <code class="literal">destroy()</code> methods; and the
<a class="link" href="#beans-postconstruct-and-predestroy-annotations" title="4.9.7&nbsp;@PostConstruct and @PreDestroy"><code class="literal">@PostConstruct</code> and <code class="literal">@PreDestroy</code>
annotations</a>. You can combine these mechanisms to control a given bean.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If multiple lifecycle mechanisms are configured for a bean, and each mechanism is
configured with a different method name, then each configured method is executed in the
order listed below. However, if the same method name is configured - for example,
<code class="literal">init()</code> for an initialization method - for more than one of these lifecycle mechanisms,
that method is executed once, as explained in the preceding section.</p>
</td></tr></table></div>

<p>Multiple lifecycle mechanisms configured for the same bean, with different
initialization methods, are called as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Methods annotated with <code class="literal">@PostConstruct</code>
</li><li class="listitem">
<code class="literal">afterPropertiesSet()</code> as defined by the <code class="literal">InitializingBean</code> callback interface
</li><li class="listitem">
A custom configured <code class="literal">init()</code> method
</li></ul></div>

<p>Destroy methods are called in the same order:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Methods annotated with <code class="literal">@PreDestroy</code>
</li><li class="listitem">
<code class="literal">destroy()</code> as defined by the <code class="literal">DisposableBean</code> callback interface
</li><li class="listitem">
A custom configured <code class="literal">destroy()</code> method
</li></ul></div>

</div>
<div class="section" title="Startup and shutdown callbacks"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-lifecycle-processor"></a>Startup and shutdown callbacks</h4></div></div></div>

<p>The <code class="literal">Lifecycle</code> interface defines the essential methods for any object that has its own
lifecycle requirements (e.g. starts and stops some background process):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Lifecycle {

    <span class="hl-keyword">void</span> start();

    <span class="hl-keyword">void</span> stop();

    <span class="hl-keyword">boolean</span> isRunning();

}</pre>

<p>Any Spring-managed object may implement that interface. Then, when the
ApplicationContext itself starts and stops, it will cascade those calls to all Lifecycle
implementations defined within that context. It does this by delegating to a
<code class="literal">LifecycleProcessor</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> LifecycleProcessor <span class="hl-keyword">extends</span> Lifecycle {

    <span class="hl-keyword">void</span> onRefresh();

    <span class="hl-keyword">void</span> onClose();

}</pre>

<p>Notice that the <code class="literal">LifecycleProcessor</code> is itself an extension of the <code class="literal">Lifecycle</code>
interface. It also adds two other methods for reacting to the context being refreshed
and closed.</p>
<p>The order of startup and shutdown invocations can be important. If a "depends-on"
relationship exists between any two objects, the dependent side will start <span class="emphasis"><em>after</em></span> its
dependency, and it will stop <span class="emphasis"><em>before</em></span> its dependency. However, at times the direct
dependencies are unknown. You may only know that objects of a certain type should start
prior to objects of another type. In those cases, the <code class="literal">SmartLifecycle</code> interface defines
another option, namely the <code class="literal">getPhase()</code> method as defined on its super-interface,
<code class="literal">Phased</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Phased {

    <span class="hl-keyword">int</span> getPhase();

}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SmartLifecycle <span class="hl-keyword">extends</span> Lifecycle, Phased {

    <span class="hl-keyword">boolean</span> isAutoStartup();

    <span class="hl-keyword">void</span> stop(Runnable callback);

}</pre>

<p>When starting, the objects with the lowest phase start first, and when stopping, the
reverse order is followed. Therefore, an object that implements <code class="literal">SmartLifecycle</code> and
whose getPhase() method returns <code class="literal">Integer.MIN_VALUE</code> would be among the first to start
and the last to stop. At the other end of the spectrum, a phase value of
<code class="literal">Integer.MAX_VALUE</code> would indicate that the object should be started last and stopped
first (likely because it depends on other processes to be running). When considering the
phase value, it&#8217;s also important to know that the default phase for any "normal"
<code class="literal">Lifecycle</code> object that does not implement <code class="literal">SmartLifecycle</code> would be 0. Therefore, any
negative phase value would indicate that an object should start before those standard
components (and stop after them), and vice versa for any positive phase value.</p>
<p>As you can see the stop method defined by <code class="literal">SmartLifecycle</code> accepts a callback. Any
implementation <span class="emphasis"><em>must</em></span> invoke that callback&#8217;s run() method after that implementation&#8217;s
shutdown process is complete. That enables asynchronous shutdown where necessary since
the default implementation of the <code class="literal">LifecycleProcessor</code> interface,
<code class="literal">DefaultLifecycleProcessor</code>, will wait up to its timeout value for the group of objects
within each phase to invoke that callback. The default per-phase timeout is 30 seconds.
You can override the default lifecycle processor instance by defining a bean named
"lifecycleProcessor" within the context. If you only want to modify the timeout, then
defining the following would be sufficient:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lifecycleProcessor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.context.support.DefaultLifecycleProcessor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- timeout value in milliseconds --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeoutPerShutdownPhase"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>As mentioned, the <code class="literal">LifecycleProcessor</code> interface defines callback methods for the
refreshing and closing of the context as well. The latter will simply drive the shutdown
process as if stop() had been called explicitly, but it will happen when the context is
closing. The <span class="emphasis"><em>refresh</em></span> callback on the other hand enables another feature of
<code class="literal">SmartLifecycle</code> beans. When the context is refreshed (after all objects have been
instantiated and initialized), that callback will be invoked, and at that point the
default lifecycle processor will check the boolean value returned by each
<code class="literal">SmartLifecycle</code> object&#8217;s <code class="literal">isAutoStartup()</code> method. If "true", then that object will be
started at that point rather than waiting for an explicit invocation of the context&#8217;s or
its own start() method (unlike the context refresh, the context start does not happen
automatically for a standard context implementation). The "phase" value as well as any
"depends-on" relationships will determine the startup order in the same way as described
above.</p>
</div>
<div class="section" title="Shutting down the Spring IoC container gracefully in non-web applications"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-shutdown"></a>Shutting down the Spring IoC container gracefully in non-web applications</h4></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This section applies only to non-web applications. Spring&#8217;s web-based
<code class="literal">ApplicationContext</code> implementations already have code in place to shut down the Spring
IoC container gracefully when the relevant web application is shut down.</p>
</td></tr></table></div>

<p>If you are using Spring&#8217;s IoC container in a non-web application environment; for
example, in a rich client desktop environment; you register a shutdown hook with the
JVM. Doing so ensures a graceful shutdown and calls the relevant destroy methods on your
singleton beans so that all resources are released. Of course, you must still configure
and implement these destroy callbacks correctly.</p>
<p>To register a shutdown hook, you call the <code class="literal">registerShutdownHook()</code> method that is
declared on the <code class="literal">AbstractApplicationContext</code> class:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.context.support.AbstractApplicationContext;
<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> Boot {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(<span class="hl-keyword">final</span> String[] args) <span class="hl-keyword">throws</span> Exception {

        AbstractApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(
                <span class="hl-keyword">new</span> String []{<span class="hl-string">"beans.xml"</span>});

        <span class="hl-comment">// add a shutdown hook for the above context...</span>
        ctx.registerShutdownHook();

        <span class="hl-comment">// app runs here...</span>

        <span class="hl-comment">// main method exits, hook is called prior to the app shutting down...</span>

    }
}</pre>

</div>
</div>
<div class="section" title="4.6.2&nbsp;ApplicationContextAware and BeanNameAware"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-aware"></a>4.6.2&nbsp;ApplicationContextAware and BeanNameAware</h3></div></div></div>

<p>When an <code class="literal">ApplicationContext</code> creates a class that implements the
<code class="literal">org.springframework.context.ApplicationContextAware</code> interface, the class is provided
with a reference to that <code class="literal">ApplicationContext</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ApplicationContextAware {

    <span class="hl-keyword">void</span> setApplicationContext(ApplicationContext applicationContext) <span class="hl-keyword">throws</span> BeansException;

}</pre>

<p>Thus beans can manipulate programmatically the <code class="literal">ApplicationContext</code> that created them,
through the <code class="literal">ApplicationContext</code> interface, or by casting the reference to a known
subclass of this interface, such as <code class="literal">ConfigurableApplicationContext</code>, which exposes
additional functionality. One use would be the programmatic retrieval of other beans.
Sometimes this capability is useful; however, in general you should avoid it, because it
couples the code to Spring and does not follow the Inversion of Control style, where
collaborators are provided to beans as properties. Other methods of the
ApplicationContext provide access to file resources, publishing application events, and
accessing a MessageSource. These additional features are described in
<a class="xref" href="#context-introduction" title="4.16&nbsp;Additional Capabilities of the ApplicationContext">Section&nbsp;4.16, &#8220;Additional Capabilities of the ApplicationContext&#8221;</a></p>
<p>As of Spring 2.5, autowiring is another alternative to obtain reference to the
<code class="literal">ApplicationContext</code>. The "traditional" <code class="literal">constructor</code> and <code class="literal">byType</code> autowiring modes (as
described in <a class="xref" href="#beans-factory-autowire" title="4.4.5&nbsp;Autowiring collaborators">Section&nbsp;4.4.5, &#8220;Autowiring collaborators&#8221;</a>) can provide a dependency of type
<code class="literal">ApplicationContext</code> for a constructor argument or setter method parameter,
respectively. For more flexibility, including the ability to autowire fields and
multiple parameter methods, use the new annotation-based autowiring features. If you do,
the <code class="literal">ApplicationContext</code> is autowired into a field, constructor argument, or method
parameter that is expecting the <code class="literal">ApplicationContext</code> type if the field, constructor, or
method in question carries the <code class="literal">@Autowired</code> annotation. For more information, see
<a class="xref" href="#beans-autowired-annotation" title="4.9.2&nbsp;@Autowired">Section&nbsp;4.9.2, &#8220;@Autowired&#8221;</a>.</p>
<p>When an ApplicationContext creates a class that implements the
<code class="literal">org.springframework.beans.factory.BeanNameAware</code> interface, the class is provided with
a reference to the name defined in its associated object definition.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> BeanNameAware {

    <span class="hl-keyword">void</span> setBeanName(string name) <span class="hl-keyword">throws</span> BeansException;

}</pre>

<p>The callback is invoked after population of normal bean properties but before an
initialization callback such as <code class="literal">InitializingBean</code> <span class="emphasis"><em>afterPropertiesSet</em></span> or a custom
init-method.</p>
</div>
<div class="section" title="4.6.3&nbsp;Other Aware interfaces"><div class="titlepage"><div><div><h3 class="title"><a name="aware-list"></a>4.6.3&nbsp;Other Aware interfaces</h3></div></div></div>

<p>Besides <code class="literal">ApplicationContextAware</code> and <code class="literal">BeanNameAware</code> discussed above, Spring offers a
range of <code class="literal">Aware</code> interfaces that allow beans to indicate to the container that they
require a certain <span class="emphasis"><em>infrastructure</em></span> dependency. The most important <code class="literal">Aware</code> interfaces
are summarized below - as a general rule, the name is a good indication of the
dependency type:</p>
<div class="table"><a name="beans-factory-nature-aware-list"></a><p class="title"><b>Table&nbsp;4.4.&nbsp;Aware interfaces</b></p><div class="table-contents">

  <table summary="Aware interfaces" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Injected Dependency</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explained in&#8230;</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ApplicationContextAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Declaring <code class="literal">ApplicationContext</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-aware" title="4.6.2&nbsp;ApplicationContextAware and BeanNameAware">Section&nbsp;4.6.2, &#8220;ApplicationContextAware and BeanNameAware&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ApplicationEventPublisherAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Event publisher of the enclosing <code class="literal">ApplicationContext</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#context-introduction" title="4.16&nbsp;Additional Capabilities of the ApplicationContext">Section&nbsp;4.16, &#8220;Additional Capabilities of the ApplicationContext&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BeanClassLoaderAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Class loader used to load the bean classes.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-class" title="4.3.2&nbsp;Instantiating beans">Section&nbsp;4.3.2, &#8220;Instantiating beans&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BeanFactoryAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Declaring <code class="literal">BeanFactory</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-aware" title="4.6.2&nbsp;ApplicationContextAware and BeanNameAware">Section&nbsp;4.6.2, &#8220;ApplicationContextAware and BeanNameAware&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BeanNameAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the declaring bean</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#beans-factory-aware" title="4.6.2&nbsp;ApplicationContextAware and BeanNameAware">Section&nbsp;4.6.2, &#8220;ApplicationContextAware and BeanNameAware&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BootstrapContextAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Resource adapter <code class="literal">BootstrapContext</code> the container runs in. Typically available only in
  JCA aware <code class="literal">ApplicationContext</code> s</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#cci" title="25.&nbsp;JCA CCI">Chapter&nbsp;25, <i>JCA CCI</i></a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">LoadTimeWeaverAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Defined <span class="emphasis"><em>weaver</em></span> for processing class definition at load time</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#aop-aj-ltw" title="8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework">Section&nbsp;8.8.4, &#8220;Load-time weaving with AspectJ in the Spring Framework&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">MessageSourceAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Configured strategy for resolving messages (with support for parametrization and
  internationalization)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#context-introduction" title="4.16&nbsp;Additional Capabilities of the ApplicationContext">Section&nbsp;4.16, &#8220;Additional Capabilities of the ApplicationContext&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">NotificationPublisherAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Spring JMX notification publisher</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jmx-notifications" title="24.7&nbsp;Notifications">Section&nbsp;24.7, &#8220;Notifications&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PortletConfigAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Current <code class="literal">PortletConfig</code> the container runs in. Valid only in a web-aware Spring
  <code class="literal">ApplicationContext</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#portlet" title="19.&nbsp;Portlet MVC Framework">Chapter&nbsp;19, <i>Portlet MVC Framework</i></a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PortletContextAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Current <code class="literal">PortletContext</code> the container runs in. Valid only in a web-aware Spring
  <code class="literal">ApplicationContext</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#portlet" title="19.&nbsp;Portlet MVC Framework">Chapter&nbsp;19, <i>Portlet MVC Framework</i></a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ResourceLoaderAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Configured loader for low-level access to resources</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#resources" title="5.&nbsp;Resources">Chapter&nbsp;5, <i>Resources</i></a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ServletConfigAware</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Current <code class="literal">ServletConfig</code> the container runs in. Valid only in a web-aware Spring
  <code class="literal">ApplicationContext</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mvc" title="16.&nbsp;Web MVC framework">Chapter&nbsp;16, <i>Web MVC framework</i></a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ServletContextAware</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Current <code class="literal">ServletContext</code> the container runs in. Valid only in a web-aware Spring
  <code class="literal">ApplicationContext</code></p></td><td style="" align="left" valign="top"><p><a class="xref" href="#mvc" title="16.&nbsp;Web MVC framework">Chapter&nbsp;16, <i>Web MVC framework</i></a></p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>Note again that usage of these interfaces ties your code to the Spring API and does not
follow the Inversion of Control style. As such, they are recommended for infrastructure
beans that require programmatic access to the container.</p>
</div>
</div>
<div class="section" title="4.7&nbsp;Bean definition inheritance"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-child-bean-definitions"></a>4.7&nbsp;Bean definition inheritance</h2></div></div></div>

<p>A bean definition can contain a lot of configuration information, including constructor
arguments, property values, and container-specific information such as initialization
method, static factory method name, and so on. A child bean definition inherits
configuration data from a parent definition. The child definition can override some
values, or add others, as needed. Using parent and child bean definitions can save a lot
of typing. Effectively, this is a form of templating.</p>
<p>If you work with an <code class="literal">ApplicationContext</code> interface programmatically, child bean
definitions are represented by the <code class="literal">ChildBeanDefinition</code> class. Most users do not work
with them on this level, instead configuring bean definitions declaratively in something
like the <code class="literal">ClassPathXmlApplicationContext</code>. When you use XML-based configuration
metadata, you indicate a child bean definition by using the <code class="literal">parent</code> attribute,
specifying the parent bean as the value of this attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inheritedTestBean"</span> <span class="hl-attribute">abstract</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.TestBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"parent"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inheritsWithDifferentClass"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.DerivedTestBean"</span>
        <span class="strong"><strong>parent="inheritedTestBean"</strong></span> init-method="initialize"&gt;
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"override"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-comment">&lt;!-- the age property value of 1 will be inherited from parent --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>A child bean definition uses the bean class from the parent definition if none is
specified, but can also override it. In the latter case, the child bean class must be
compatible with the parent, that is, it must accept the parent&#8217;s property values.</p>
<p>A child bean definition inherits constructor argument values, property values, and
method overrides from the parent, with the option to add new values. Any initialization
method, destroy method, and/or <code class="literal">static</code> factory method settings that you specify will
override the corresponding parent settings.</p>
<p>The remaining settings are <span class="emphasis"><em>always</em></span> taken from the child definition: <span class="emphasis"><em>depends on</em></span>,
<span class="emphasis"><em>autowire mode</em></span>, <span class="emphasis"><em>dependency check</em></span>, <span class="emphasis"><em>singleton</em></span>, <span class="emphasis"><em>scope</em></span>, <span class="emphasis"><em>lazy init</em></span>.</p>
<p>The preceding example explicitly marks the parent bean definition as abstract by using
the <code class="literal">abstract</code> attribute. If the parent definition does not specify a class, explicitly
marking the parent bean definition as <code class="literal">abstract</code> is required, as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inheritedTestBeanWithoutClass"</span> <span class="hl-attribute">abstract</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"parent"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inheritsWithClass"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.DerivedTestBean"</span>
        <span class="hl-attribute">parent</span>=<span class="hl-value">"inheritedTestBeanWithoutClass"</span> <span class="hl-attribute">init-method</span>=<span class="hl-value">"initialize"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"override"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-comment">&lt;!-- age will inherit the value of 1 from the parent bean definition--&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The parent bean cannot be instantiated on its own because it is incomplete, and it is
also explicitly marked as <code class="literal">abstract</code>. When a definition is <code class="literal">abstract</code> like this, it is
usable only as a pure template bean definition that serves as a parent definition for
child definitions. Trying to use such an <code class="literal">abstract</code> parent bean on its own, by referring
to it as a ref property of another bean or doing an explicit <code class="literal">getBean()</code> call with the
parent bean id, returns an error. Similarly, the container&#8217;s internal
<code class="literal">preInstantiateSingletons()</code> method ignores bean definitions that are defined as
abstract.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">ApplicationContext</code> pre-instantiates all singletons by default. Therefore, it is
important (at least for singleton beans) that if you have a (parent) bean definition
which you intend to use only as a template, and this definition specifies a class, you
must make sure to set the <span class="emphasis"><em>abstract</em></span> attribute to <span class="emphasis"><em>true</em></span>, otherwise the application
context will actually (attempt to) pre-instantiate the <code class="literal">abstract</code> bean.</p>
</td></tr></table></div>

</div>
<div class="section" title="4.8&nbsp;Container Extension Points"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-factory-extension"></a>4.8&nbsp;Container Extension Points</h2></div></div></div>

<p>Typically, an application developer does not need to subclass <code class="literal">ApplicationContext</code>
implementation classes. Instead, the Spring IoC container can be extended by plugging in
implementations of special integration interfaces. The next few sections describe these
integration interfaces.</p>
<div class="section" title="4.8.1&nbsp;Customizing beans using a BeanPostProcessor"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-extension-bpp"></a>4.8.1&nbsp;Customizing beans using a BeanPostProcessor</h3></div></div></div>

<p>The <code class="literal">BeanPostProcessor</code> interface defines <span class="emphasis"><em>callback methods</em></span> that you can implement to
provide your own (or override the container&#8217;s default) instantiation logic,
dependency-resolution logic, and so forth. If you want to implement some custom logic
after the Spring container finishes instantiating, configuring, and initializing a bean,
you can plug in one or more <code class="literal">BeanPostProcessor</code> implementations.</p>
<p>You can configure multiple <code class="literal">BeanPostProcessor</code> instances, and you can control the order
in which these <code class="literal">BeanPostProcessor</code> s execute by setting the <code class="literal">order</code> property. You can
set this property only if the <code class="literal">BeanPostProcessor</code> implements the <code class="literal">Ordered</code> interface; if
you write your own <code class="literal">BeanPostProcessor</code> you should consider implementing the <code class="literal">Ordered</code>
interface too. For further details, consult the Javadoc for the <code class="literal">BeanPostProcessor</code> and
<code class="literal">Ordered</code> interfaces. See also the note below on
<a class="link" href="#">programmatic
registration of <code class="literal">BeanPostProcessors</code></a></p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">BeanPostProcessor</code> s operate on bean (or object) <span class="emphasis"><em>instances</em></span>; that is to say, the
Spring IoC container instantiates a bean instance and <span class="emphasis"><em>then</em></span> <code class="literal">BeanPostProcessor</code> s do
their work.</p>
<p><code class="literal">BeanPostProcessor</code> s are scoped <span class="emphasis"><em>per-container</em></span>. This is only relevant if you are
using container hierarchies. If you define a <code class="literal">BeanPostProcessor</code> in one container, it
will <span class="emphasis"><em>only</em></span> post-process the beans in that container. In other words, beans that are
defined in one container are not post-processed by a <code class="literal">BeanPostProcessor</code> defined in
another container, even if both containers are part of the same hierarchy.</p>
<p>To change the actual bean definition (i.e., the <span class="emphasis"><em>blueprint</em></span> that defines the bean),
you instead need to use a <code class="literal">BeanFactoryPostProcessor</code> as described in
<a class="xref" href="#beans-factory-extension-factory-postprocessors" title="4.8.2&nbsp;Customizing configuration metadata with a BeanFactoryPostProcessor">Section&nbsp;4.8.2, &#8220;Customizing configuration metadata with a BeanFactoryPostProcessor&#8221;</a>.</p>
</td></tr></table></div>

<p>The <code class="literal">org.springframework.beans.factory.config.BeanPostProcessor</code> interface consists of
exactly two callback methods. When such a class is registered as a post-processor with
the container, for each bean instance that is created by the container, the
post-processor gets a callback from the container both <span class="emphasis"><em>before</em></span> container
initialization methods (such as InitializingBean&#8217;s <span class="emphasis"><em>afterPropertiesSet()</em></span> and any
declared init method) are called as well as <span class="emphasis"><em>after</em></span> any bean initialization callbacks.
The post-processor can take any action with the bean instance, including ignoring the
callback completely. A bean post-processor typically checks for callback interfaces or
may wrap a bean with a proxy. Some Spring AOP infrastructure classes are implemented as
bean post-processors in order to provide proxy-wrapping logic.</p>
<p>An <code class="literal">ApplicationContext</code> <span class="emphasis"><em>automatically detects</em></span> any beans that are defined in the
configuration metadata which implement the <code class="literal">BeanPostProcessor</code> interface. The
<code class="literal">ApplicationContext</code> registers these beans as post-processors so that they can be called
later upon bean creation. Bean post-processors can be deployed in the container just
like any other beans.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="strong"><strong>Programmatically registering BeanPostProcessors</strong></span></p>
<p>While the recommended approach for <code class="literal">BeanPostProcessor</code> registration is through
<code class="literal">ApplicationContext</code> auto-detection (as described above), it is also possible to
register them <span class="emphasis"><em>programmatically</em></span> against a <code class="literal">ConfigurableBeanFactory</code> using the
<code class="literal">addBeanPostProcessor</code> method. This can be useful when needing to evaluate conditional
logic before registration, or even for copying bean post processors across contexts in a
hierarchy. Note however that <code class="literal">BeanPostProcessors</code> added programmatically <span class="emphasis"><em>do not
respect the <code class="literal">Ordered</code> interface</em></span>. Here it is the <span class="emphasis"><em>order of registration</em></span> that
dictates the order of execution. Note also that <code class="literal">BeanPostProcessors</code> registered
programmatically are always processed before those registered through auto-detection,
regardless of any explicit ordering.</p>
</td></tr></table></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="strong"><strong>BeanPostProcessors and AOP auto-proxying</strong></span></p>
<p>Classes that implement the <code class="literal">BeanPostProcessor</code> interface are <span class="emphasis"><em>special</em></span> and are treated
differently by the container. All <code class="literal">BeanPostProcessors</code> <span class="emphasis"><em>and beans that they reference
directly</em></span> are instantiated on startup, as part of the special startup phase of the
<code class="literal">ApplicationContext</code>. Next, all <code class="literal">BeanPostProcessors</code> are registered in a sorted fashion
and applied to all further beans in the container. Because AOP auto-proxying is
implemented as a <code class="literal">BeanPostProcessor</code> itself, neither <code class="literal">BeanPostProcessors</code> nor the beans
they reference directly are eligible for auto-proxying, and thus do not have aspects
woven into them.</p>
<p>For any such bean, you should see an informational log message: "<span class="emphasis"><em>Bean foo is not
eligible for getting processed by all BeanPostProcessor interfaces (for example: not
eligible for auto-proxying)</em></span>".</p>
<p>Note that if you have beans wired into your <code class="literal">BeanPostProcessor</code> using autowiring or
<code class="literal">@Resource</code> (which may fall back to autowiring), Spring might access unexpected beans
when searching for type-matching dependency candidates, and therefore make them
ineligible for auto-proxying or other kinds of bean post-processing. For example, if you
have a dependency annotated with <code class="literal">@Resource</code> where the field/setter name does not
directly correspond to the declared name of a bean and no name attribute is used, then
Spring will access other beans for matching them by type.</p>
</td></tr></table></div>

<p>The following examples show how to write, register, and use <code class="literal">BeanPostProcessors</code> in an
<code class="literal">ApplicationContext</code>.</p>
<div class="section" title="Example: Hello World, BeanPostProcessor-style"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-extension-bpp-examples-hw"></a>Example: Hello World, BeanPostProcessor-style</h4></div></div></div>

<p>This first example illustrates basic usage. The example shows a custom
<code class="literal">BeanPostProcessor</code> implementation that invokes the <code class="literal">toString()</code> method of each bean as
it is created by the container and prints the resulting string to the system console.</p>
<p>Find below the custom <code class="literal">BeanPostProcessor</code> implementation class definition:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> scripting;

<span class="hl-keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;
<span class="hl-keyword">import</span> org.springframework.beans.BeansException;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InstantiationTracingBeanPostProcessor <span class="hl-keyword">implements</span> BeanPostProcessor {

    <span class="hl-comment">// simply return the instantiated bean as-is</span>
    <span class="hl-keyword">public</span> Object postProcessBeforeInitialization(Object bean,
            String beanName) <span class="hl-keyword">throws</span> BeansException {
        <span class="hl-keyword">return</span> bean; <span class="hl-comment">// we could potentially return any object reference here...</span>
    }

    <span class="hl-keyword">public</span> Object postProcessAfterInitialization(Object bean,
            String beanName) <span class="hl-keyword">throws</span> BeansException {
        System.out.println(<span class="hl-string">"Bean </span><span class="emphasis"><em>" + beanName + "</em></span> created : <span class="hl-string">" + bean.toString());
</span>        <span class="hl-keyword">return</span> bean;
    }

}</pre>

<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:lang</span>=<span class="hl-value">"http://www.springframework.org/schema/lang"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/lang
        http://www.springframework.org/schema/lang/spring-lang.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messenger"</span>
            <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:org/springframework/scripting/groovy/Messenger.groovy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"message"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Fiona Apple Is Just So Dreamy."</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/lang:groovy&gt;</span>

    <span class="hl-comment">&lt;!--
    when the above bean (messenger) is instantiated, this custom
    BeanPostProcessor implementation will output the fact to the system console
    --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"scripting.InstantiationTracingBeanPostProcessor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Notice how the <code class="literal">InstantiationTracingBeanPostProcessor</code> is simply defined. It does not
even have a name, and because it is a bean it can be dependency-injected just like any
other bean. (The preceding configuration also defines a bean that is backed by a Groovy
script. The Spring dynamic language support is detailed in the chapter entitled
<a class="xref" href="#dynamic-language" title="28.&nbsp;Dynamic language support">Chapter&nbsp;28, <i>Dynamic language support</i></a>.)</p>
<p>The following simple Java application executes the preceding code and configuration:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;
<span class="hl-keyword">import</span> org.springframework.scripting.Messenger;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> Boot {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(<span class="hl-keyword">final</span> String[] args) <span class="hl-keyword">throws</span> Exception {
        ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"scripting/beans.xml"</span>);
        Messenger messenger = (Messenger) ctx.getBean(<span class="hl-string">"messenger"</span>);
        System.out.println(messenger);
    }

}</pre>

<p>The output of the preceding application resembles the following:</p>

<pre class="literallayout">Bean <span class="emphasis"><em>messenger</em></span> created : org.springframework.scripting.groovy.GroovyMessenger@272961
org.springframework.scripting.groovy.GroovyMessenger@272961</pre>

</div>
<div class="section" title="Example: The RequiredAnnotationBeanPostProcessor"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-extension-bpp-examples-rabpp"></a>Example: The RequiredAnnotationBeanPostProcessor</h4></div></div></div>

<p>Using callback interfaces or annotations in conjunction with a custom
<code class="literal">BeanPostProcessor</code> implementation is a common means of extending the Spring IoC
container. An example is Spring&#8217;s <code class="literal">RequiredAnnotationBeanPostProcessor</code> - a
<code class="literal">BeanPostProcessor</code> implementation that ships with the Spring distribution which ensures
that JavaBean properties on beans that are marked with an (arbitrary) annotation are
actually (configured to be) dependency-injected with a value.</p>
</div>
</div>
<div class="section" title="4.8.2&nbsp;Customizing configuration metadata with a BeanFactoryPostProcessor"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-extension-factory-postprocessors"></a>4.8.2&nbsp;Customizing configuration metadata with a BeanFactoryPostProcessor</h3></div></div></div>

<p>The next extension point that we will look at is the
<code class="literal">org.springframework.beans.factory.config.BeanFactoryPostProcessor</code>. The semantics of
this interface are similar to those of the <code class="literal">BeanPostProcessor</code>, with one major
difference: <code class="literal">BeanFactoryPostProcessor</code> operates on the <span class="emphasis"><em>bean configuration metadata</em></span>;
that is, the Spring IoC container allows a <code class="literal">BeanFactoryPostProcessor</code> to read the
configuration metadata and potentially change it <span class="emphasis"><em>before</em></span> the container instantiates
any beans other than <code class="literal">BeanFactoryPostProcessors</code>.</p>
<p>You can configure multiple <code class="literal">BeanFactoryPostProcessors</code>, and you can control the order in
which these <code class="literal">BeanFactoryPostProcessors</code> execute by setting the <code class="literal">order</code> property.
However, you can only set this property if the <code class="literal">BeanFactoryPostProcessor</code> implements the
<code class="literal">Ordered</code> interface. If you write your own <code class="literal">BeanFactoryPostProcessor</code>, you should
consider implementing the <code class="literal">Ordered</code> interface too. Consult the Javadoc for the
<code class="literal">BeanFactoryPostProcessor</code> and <code class="literal">Ordered</code> interfaces for more details.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you want to change the actual bean <span class="emphasis"><em>instances</em></span> (i.e., the objects that are created
from the configuration metadata), then you instead need to use a <code class="literal">BeanPostProcessor</code>
(described above in <a class="xref" href="#beans-factory-extension-bpp" title="4.8.1&nbsp;Customizing beans using a BeanPostProcessor">Section&nbsp;4.8.1, &#8220;Customizing beans using a BeanPostProcessor&#8221;</a>). While it is technically possible
to work with bean instances within a <code class="literal">BeanFactoryPostProcessor</code> (e.g., using
<code class="literal">BeanFactory.getBean()</code>), doing so causes premature bean instantiation, violating the
standard container lifecycle. This may cause negative side effects such as bypassing
bean post processing.</p>
<p>Also, <code class="literal">BeanFactoryPostProcessors</code> are scoped <span class="emphasis"><em>per-container</em></span>. This is only relevant if
you are using container hierarchies. If you define a <code class="literal">BeanFactoryPostProcessor</code> in one
container, it will <span class="emphasis"><em>only</em></span> be applied to the bean definitions in that container. Bean
definitions in one container will not be post-processed by <code class="literal">BeanFactoryPostProcessors</code>
in another container, even if both containers are part of the same hierarchy.</p>
</td></tr></table></div>

<p>A bean factory post-processor is executed automatically when it is declared inside an
<code class="literal">ApplicationContext</code>, in order to apply changes to the configuration metadata that
define the container. Spring includes a number of predefined bean factory
post-processors, such as <code class="literal">PropertyOverrideConfigurer</code> and
<code class="literal">PropertyPlaceholderConfigurer</code>. A custom <code class="literal">BeanFactoryPostProcessor</code> can also be used,
for example, to register custom property editors.</p>
<p><a name="null"></a>An <code class="literal">ApplicationContext</code> automatically detects any beans that are deployed into it that
implement the <code class="literal">BeanFactoryPostProcessor</code> interface. It uses these beans as bean factory
post-processors, at the appropriate time. You can deploy these post-processor beans as
you would any other bean.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As with <code class="literal">BeanPostProcessor</code> s , you typically do not want to configure
<code class="literal">BeanFactoryPostProcessor</code> s for lazy initialization. If no other bean references a
<code class="literal">Bean(Factory)PostProcessor</code>, that post-processor will not get instantiated at all.
Thus, marking it for lazy initialization will be ignored, and the
<code class="literal">Bean(Factory)PostProcessor</code> will be instantiated eagerly even if you set the
<code class="literal">default-lazy-init</code> attribute to <code class="literal">true</code> on the declaration of your <code class="literal">&lt;beans /&gt;</code> element.</p>
</td></tr></table></div>

<div class="section" title="Example: the Class name substitution PropertyPlaceholderConfigurer"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-placeholderconfigurer"></a>Example: the Class name substitution PropertyPlaceholderConfigurer</h4></div></div></div>

<p>You use the <code class="literal">PropertyPlaceholderConfigurer</code> to externalize property values from a bean
definition in a separate file using the standard Java <code class="literal">Properties</code> format. Doing so
enables the person deploying an application to customize environment-specific properties
such as database URLs and passwords, without the complexity or risk of modifying the
main XML definition file or files for the container.</p>
<p>Consider the following XML-based configuration metadata fragment, where a <code class="literal">DataSource</code>
with placeholder values is defined. The example shows properties configured from an
external <code class="literal">Properties</code> file. At runtime, a <code class="literal">PropertyPlaceholderConfigurer</code> is applied to
the metadata that will replace some properties of the DataSource. The values to replace
are specified as <span class="emphasis"><em>placeholders</em></span> of the form <code class="literal">${property-name}</code> which follows the Ant /
log4j / JSP EL style.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"locations"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:com/foo/jdbc.properties"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.driverClassName}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.url}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.username}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.password}"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The actual values come from another file in the standard Java <code class="literal">Properties</code> format:</p>

<pre class="literallayout">jdbc.driverClassName=org.hsqldb.jdbcDriver
jdbc.url=jdbc:hsqldb:hsql://production:9002
jdbc.username=sa
jdbc.password=root</pre>

<p>Therefore, the string <code class="literal">${jdbc.username}</code> is replaced at runtime with the value <span class="emphasis"><em>sa</em></span>, and
the same applies for other placeholder values that match keys in the properties file.
The <code class="literal">PropertyPlaceholderConfigurer</code> checks for placeholders in most properties and
attributes of a bean definition. Furthermore, the placeholder prefix and suffix can be
customized.</p>
<p>With the <code class="literal">context</code> namespace introduced in Spring 2.5, it is possible to configure
property placeholders with a dedicated configuration element. One or more locations can
be provided as a comma-separated list in the <code class="literal">location</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/foo/jdbc.properties"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">PropertyPlaceholderConfigurer</code> not only looks for properties in the <code class="literal">Properties</code>
file you specify. By default it also checks against the Java <code class="literal">System</code> properties if it
cannot find a property in the specified properties files. You can customize this
behavior by setting the <code class="literal">systemPropertiesMode</code> property of the configurer with one of
the following three supported integer values:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>never</em></span> (0): Never check system properties
</li><li class="listitem">
<span class="emphasis"><em>fallback</em></span> (1): Check system properties if not resolvable in the specified
properties files. This is the default.
</li><li class="listitem">
<span class="emphasis"><em>override</em></span> (2): Check system properties first, before trying the specified
properties files. This allows system properties to override any other property source.
</li></ul></div>

<p>Consult the Javadoc for the <code class="literal">PropertyPlaceholderConfigurer</code> for more information.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>You can use the <code class="literal">PropertyPlaceholderConfigurer</code> to substitute class names, which is
sometimes useful when you have to pick a particular implementation class at runtime. For
example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"locations"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;value&gt;</span>classpath:com/foo/strategy.properties<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"properties"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;value&gt;</span>custom.strategy.class=com.foo.DefaultStrategy<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serviceStrategy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"${custom.strategy.class}"</span><span class="hl-tag">/&gt;</span></pre>

<p>If the class cannot be resolved at runtime to a valid class, resolution of the bean
fails when it is about to be created, which is during the <code class="literal">preInstantiateSingletons()</code>
phase of an <code class="literal">ApplicationContext</code> for a non-lazy-init bean.</p>
</td></tr></table></div>

</div>
<div class="section" title="Example: the PropertyOverrideConfigurer"><div class="titlepage"><div><div><h4 class="title"><a name="beans-factory-overrideconfigurer"></a>Example: the PropertyOverrideConfigurer</h4></div></div></div>

<p>The <code class="literal">PropertyOverrideConfigurer</code>, another bean factory post-processor, resembles the
<code class="literal">PropertyPlaceholderConfigurer</code>, but unlike the latter, the original definitions can
have default values or no values at all for bean properties. If an overriding
<code class="literal">Properties</code> file does not have an entry for a certain bean property, the default
context definition is used.</p>
<p>Note that the bean definition is <span class="emphasis"><em>not</em></span> aware of being overridden, so it is not
immediately obvious from the XML definition file that the override configurer is being
used. In case of multiple <code class="literal">PropertyOverrideConfigurer</code> instances that define different
values for the same bean property, the last one wins, due to the overriding mechanism.</p>
<p>Properties file configuration lines take this format:</p>

<pre class="literallayout">beanName.property=value</pre>

<p>For example:</p>

<pre class="literallayout">dataSource.driverClassName=com.mysql.jdbc.Driver
dataSource.url=jdbc:mysql:mydb</pre>

<p>This example file can be used with a container definition that contains a bean called
<span class="emphasis"><em>dataSource</em></span>, which has <span class="emphasis"><em>driver</em></span> and <span class="emphasis"><em>url</em></span> properties.</p>
<p>Compound property names are also supported, as long as every component of the path
except the final property being overridden is already non-null (presumably initialized
by the constructors). In this example&#8230;</p>

<pre class="literallayout">foo.fred.bob.sammy=123</pre>

<div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem">
the <code class="literal">sammy</code> property of the <code class="literal">bob</code> property of the <code class="literal">fred</code> property of the <code class="literal">foo</code> bean
is set to the scalar value <code class="literal">123</code>.
</li></ol></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Specified override values are always <span class="emphasis"><em>literal</em></span> values; they are not translated into
bean references. This convention also applies when the original value in the XML bean
definition specifies a bean reference.</p>
</td></tr></table></div>

<p>With the <code class="literal">context</code> namespace introduced in Spring 2.5, it is possible to configure
property overriding with a dedicated configuration element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:property-override</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:override.properties"</span><span class="hl-tag">/&gt;</span></pre>

</div>
</div>
<div class="section" title="4.8.3&nbsp;Customizing instantiation logic with a FactoryBean"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factory-extension-factorybean"></a>4.8.3&nbsp;Customizing instantiation logic with a FactoryBean</h3></div></div></div>

<p>Implement the <code class="literal">org.springframework.beans.factory.FactoryBean</code> interface for objects that
<span class="emphasis"><em>are themselves factories</em></span>.</p>
<p>The <code class="literal">FactoryBean</code> interface is a point of pluggability into the Spring IoC container&#8217;s
instantiation logic. If you have complex initialization code that is better expressed in
Java as opposed to a (potentially) verbose amount of XML, you can create your own
<code class="literal">FactoryBean</code>, write the complex initialization inside that class, and then plug your
custom <code class="literal">FactoryBean</code> into the container.</p>
<p>The <code class="literal">FactoryBean</code> interface provides three methods:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">Object getObject()</code>: returns an instance of the object this factory creates. The
instance can possibly be shared, depending on whether this factory returns singletons
or prototypes.
</li><li class="listitem">
<code class="literal">boolean isSingleton()</code>: returns <code class="literal">true</code> if this <code class="literal">FactoryBean</code> returns singletons,
<code class="literal">false</code> otherwise.
</li><li class="listitem">
<code class="literal">Class getObjectType()</code>: returns the object type returned by the <code class="literal">getObject()</code> method
or <code class="literal">null</code> if the type is not known in advance.
</li></ul></div>

<p>The <code class="literal">FactoryBean</code> concept and interface is used in a number of places within the Spring
Framework; more than 50 implementations of the <code class="literal">FactoryBean</code> interface ship with Spring
itself.</p>
<p>When you need to ask a container for an actual <code class="literal">FactoryBean</code> instance itself instead of
the bean it produces, preface the bean&#8217;s id with the ampersand symbol ( <code class="literal">&amp;</code>) when
calling the <code class="literal">getBean()</code> method of the <code class="literal">ApplicationContext</code>. So for a given <code class="literal">FactoryBean</code>
with an id of <code class="literal">myBean</code>, invoking <code class="literal">getBean("myBean")</code> on the container returns the
product of the <code class="literal">FactoryBean</code>; whereas, invoking <code class="literal">getBean("&amp;myBean")</code> returns the
<code class="literal">FactoryBean</code> instance itself.</p>
</div>
</div>
<div class="section" title="4.9&nbsp;Annotation-based container configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-annotation-config"></a>4.9&nbsp;Annotation-based container configuration</h2></div></div></div>

<div class="sidebar" title="Are annotations better than XML for configuring Spring?"><p class="title"><b>Are annotations better than XML for configuring Spring?</b></p>

<p>The introduction of annotation-based configurations raised the question of whether this
approach is <span class="emphasis"><em>better</em></span> than XML. The short answer is <span class="emphasis"><em>it depends</em></span>. The long answer is
that each approach has its pros and cons, and usually it is up to the developer to
decide which strategy suits them better. Due to the way they are defined, annotations
provide a lot of context in their declaration, leading to shorter and more concise
configuration. However, XML excels at wiring up components without touching their source
code or recompiling them. Some developers prefer having the wiring close to the source
while others argue that annotated classes are no longer POJOs and, furthermore, that the
configuration becomes decentralized and harder to control.</p>
<p>No matter the choice, Spring can accommodate both styles and even mix them together.
It&#8217;s worth pointing out that through its <a class="link" href="#beans-java" title="4.12&nbsp;Java-based container configuration">JavaConfig</a> option, Spring allows
annotations to be used in a non-invasive way, without touching the target components
source code and that in terms of tooling, all configuration styles are supported by the
<a class="ulink" href="http://www.springsource.com/products/sts" target="_top">SpringSource Tool Suite</a>.</p>
</div>

<p>An alternative to XML setups is provided by annotation-based configuration which rely on
the bytecode metadata for wiring up components instead of angle-bracket declarations.
Instead of using XML to describe a bean wiring, the developer moves the configuration
into the component class itself by using annotations on the relevant class, method, or
field declaration. As mentioned in <a class="xref" href="#beans-factory-extension-bpp-examples-rabpp" title="Example: The RequiredAnnotationBeanPostProcessor">the section called &#8220;Example: The RequiredAnnotationBeanPostProcessor&#8221;</a>, using
a <code class="literal">BeanPostProcessor</code> in conjunction with annotations is a common means of extending the
Spring IoC container. For example, Spring 2.0 introduced the possibility of enforcing
required properties with the <a class="link" href="#beans-required-annotation" title="4.9.1&nbsp;@Required">@Required</a> annotation. Spring
2.5 made it possible to follow that same general approach to drive Spring&#8217;s dependency
injection. Essentially, the <code class="literal">@Autowired</code> annotation provides the same capabilities as
described in <a class="xref" href="#beans-factory-autowire" title="4.4.5&nbsp;Autowiring collaborators">Section&nbsp;4.4.5, &#8220;Autowiring collaborators&#8221;</a> but with more fine-grained control and wider
applicability. Spring 2.5 also added support for JSR-250 annotations such as
<code class="literal">@PostConstruct</code>, and <code class="literal">@PreDestroy</code>. Spring 3.0 added support for JSR-330 (Dependency
Injection for Java) annotations contained in the javax.inject package such as <code class="literal">@Inject</code>
and <code class="literal">@Named</code>. Details about those annotations can be found in the
<a class="link" href="#beans-standard-annotations" title="4.11&nbsp;Using JSR 330 Standard Annotations">relevant section</a>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Annotation injection is performed <span class="emphasis"><em>before</em></span> XML injection, thus the latter
configuration will override the former for properties wired through both approaches.</p>
</td></tr></table></div>

<p>As always, you can register them as individual bean definitions, but they can also be
implicitly registered by including the following tag in an XML-based Spring
configuration (notice the inclusion of the <code class="literal">context</code> namespace):</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:annotation-config/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>(The implicitly registered post-processors include
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/annotation/AutowiredAnnotationBeanPostProcessor.html" target="_top"><code class="literal">AutowiredAnnotationBeanPostProcessor</code></a>,
 <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/CommonAnnotationBeanPostProcessor.html" target="_top"><code class="literal">CommonAnnotationBeanPostProcessor</code></a>,
 <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/orm/jpa/support/PersistenceAnnotationBeanPostProcessor.html" target="_top"><code class="literal">PersistenceAnnotationBeanPostProcessor</code></a>,
as well as the aforementioned
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/annotation/RequiredAnnotationBeanPostProcessor.html" target="_top"><code class="literal">RequiredAnnotationBeanPostProcessor</code></a>.)</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">&lt;context:annotation-config/&gt;</code> only looks for annotations on beans in the same
application context in which it is defined. This means that, if you put
<code class="literal">&lt;context:annotation-config/&gt;</code> in a <code class="literal">WebApplicationContext</code> for a <code class="literal">DispatcherServlet</code>,
it only checks for <code class="literal">@Autowired</code> beans in your controllers, and not your services. See
<a class="xref" href="#mvc-servlet" title="16.2&nbsp;The DispatcherServlet">Section&nbsp;16.2, &#8220;The DispatcherServlet&#8221;</a> for more information.</p>
</td></tr></table></div>

<div class="section" title="4.9.1&nbsp;@Required"><div class="titlepage"><div><div><h3 class="title"><a name="beans-required-annotation"></a>4.9.1&nbsp;@Required</h3></div></div></div>

<p>The <code class="literal">@Required</code> annotation applies to bean property setter methods, as in the following
example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <i><span class="hl-annotation" style="color: gray">@Required</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>This annotation simply indicates that the affected bean property must be populated at
configuration time, through an explicit property value in a bean definition or through
autowiring. The container throws an exception if the affected bean property has not been
populated; this allows for eager and explicit failure, avoiding <code class="literal">NullPointerException</code> s
or the like later on. It is still recommended that you put assertions into the bean
class itself, for example, into an init method. Doing so enforces those required
references and values even when you use the class outside of a container.</p>
</div>
<div class="section" title="4.9.2&nbsp;@Autowired"><div class="titlepage"><div><div><h3 class="title"><a name="beans-autowired-annotation"></a>4.9.2&nbsp;@Autowired</h3></div></div></div>

<p>As expected, you can apply the <code class="literal">@Autowired</code> annotation to "traditional" setter methods:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>JSR 330&#8217;s @Inject annotation can be used in place of Spring&#8217;s <code class="literal">@Autowired</code> annotation in
the examples below. See <a class="link" href="#beans-standard-annotations" title="4.11&nbsp;Using JSR 330 Standard Annotations">here</a> for more details</p>
</td></tr></table></div>

<p>You can also apply the annotation to methods with arbitrary names and/or multiple
arguments:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <span class="hl-keyword">private</span> MovieCatalog movieCatalog;

    <span class="hl-keyword">private</span> CustomerPreferenceDao customerPreferenceDao;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> prepare(MovieCatalog movieCatalog,
            CustomerPreferenceDao customerPreferenceDao) {
        <span class="hl-keyword">this</span>.movieCatalog = movieCatalog;
        <span class="hl-keyword">this</span>.customerPreferenceDao = customerPreferenceDao;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>You can apply <code class="literal">@Autowired</code> to constructors and fields:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> MovieCatalog movieCatalog;

    <span class="hl-keyword">private</span> CustomerPreferenceDao customerPreferenceDao;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> MovieRecommender(CustomerPreferenceDao customerPreferenceDao) {
        <span class="hl-keyword">this</span>.customerPreferenceDao = customerPreferenceDao;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>It is also possible to provide <span class="emphasis"><em>all</em></span> beans of a particular type from the
<code class="literal">ApplicationContext</code> by adding the annotation to a field or method that expects an array
of that type:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> MovieCatalog[] movieCatalogs;

    <span class="hl-comment">// ...</span>

}</pre>

<p>The same applies for typed collections:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <span class="hl-keyword">private</span> Set&lt;MovieCatalog&gt; movieCatalogs;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieCatalogs(Set&lt;MovieCatalog&gt; movieCatalogs) {
        <span class="hl-keyword">this</span>.movieCatalogs = movieCatalogs;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Your beans can implement the <code class="literal">org.springframework.core.Ordered</code> interface or use the
the <code class="literal">@Ordered</code> annotation if you want items in the array or list to be sorted into a
specific order.</p>
</td></tr></table></div>

<p>Even typed Maps can be autowired as long as the expected key type is <code class="literal">String</code>. The Map
values will contain all beans of the expected type, and the keys will contain the
corresponding bean names:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <span class="hl-keyword">private</span> Map&lt;String, MovieCatalog&gt; movieCatalogs;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieCatalogs(Map&lt;String, MovieCatalog&gt; movieCatalogs) {
        <span class="hl-keyword">this</span>.movieCatalogs = movieCatalogs;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>By default, the autowiring fails whenever <span class="emphasis"><em>zero</em></span> candidate beans are available; the
default behavior is to treat annotated methods, constructors, and fields as
indicating <span class="emphasis"><em>required</em></span> dependencies. This behavior can be changed as demonstrated below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <i><span class="hl-annotation" style="color: gray">@Autowired(required=false)</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Only <span class="emphasis"><em>one annotated constructor per-class</em></span> can be marked as <span class="emphasis"><em>required</em></span>, but multiple
non-required constructors can be annotated. In that case, each is considered among the
candidates and Spring uses the <span class="emphasis"><em>greediest</em></span> constructor whose dependencies can be
satisfied, that is the constructor that has the largest number of arguments.</p>
<p><code class="literal">@Autowired</code>'s <span class="emphasis"><em>required</em></span> attribute is recommended over the <code class="literal">@Required</code> annotation.
The <span class="emphasis"><em>required</em></span> attribute indicates that the property is not required for autowiring
purposes, the property is ignored if it cannot be autowired. <code class="literal">@Required</code>, on the other
hand, is stronger in that it enforces the property that was set by any means supported
by the container. If no value is injected, a corresponding exception is raised.</p>
</td></tr></table></div>

<p>You can also use <code class="literal">@Autowired</code> for interfaces that are well-known resolvable
dependencies: <code class="literal">BeanFactory</code>, <code class="literal">ApplicationContext</code>, <code class="literal">Environment</code>, <code class="literal">ResourceLoader</code>,
<code class="literal">ApplicationEventPublisher</code>, and <code class="literal">MessageSource</code>. These interfaces and their extended
interfaces, such as <code class="literal">ConfigurableApplicationContext</code> or <code class="literal">ResourcePatternResolver</code>, are
automatically resolved, with no special setup necessary.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> ApplicationContext context;

    <span class="hl-keyword">public</span> MovieRecommender() {
    }

    <span class="hl-comment">// ...</span>

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@Autowired</code>, <code class="literal">@Inject</code>, <code class="literal">@Resource</code>, and <code class="literal">@Value</code> annotations are handled by a Spring
<code class="literal">BeanPostProcessor</code> implementations which in turn means that you <span class="emphasis"><em>cannot</em></span> apply these
annotations within your own <code class="literal">BeanPostProcessor</code> or <code class="literal">BeanFactoryPostProcessor</code> types (if
any). These types must be <span class="emphasis"><em>wired up</em></span> explicitly via XML or using a Spring <code class="literal">@Bean</code> method.</p>
</td></tr></table></div>

</div>
<div class="section" title="4.9.3&nbsp;Fine-tuning annotation-based autowiring with qualifiers"><div class="titlepage"><div><div><h3 class="title"><a name="beans-autowired-annotation-qualifiers"></a>4.9.3&nbsp;Fine-tuning annotation-based autowiring with qualifiers</h3></div></div></div>

<p>Because autowiring by type may lead to multiple candidates, it is often necessary to
have more control over the selection process. One way to accomplish this is with
Spring&#8217;s <code class="literal">@Qualifier</code> annotation. You can associate qualifier values with specific
arguments, narrowing the set of type matches so that a specific bean is chosen for each
argument. In the simplest case, this can be a plain descriptive value:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="strong"><strong>@Qualifier("main")</strong></span>
    <span class="hl-keyword">private</span> MovieCatalog movieCatalog;

    <span class="hl-comment">// ...</span>

}</pre>

<p>The <code class="literal">@Qualifier</code> annotation can also be specified on individual constructor arguments or
method parameters:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <span class="hl-keyword">private</span> MovieCatalog movieCatalog;

    <span class="hl-keyword">private</span> CustomerPreferenceDao customerPreferenceDao;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> prepare(<span class="strong"><strong>@Qualifier("main")</strong></span>MovieCatalog movieCatalog,
            CustomerPreferenceDao customerPreferenceDao) {
        <span class="hl-keyword">this</span>.movieCatalog = movieCatalog;
        <span class="hl-keyword">this</span>.customerPreferenceDao = customerPreferenceDao;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>The corresponding bean definitions appear as follows. The bean with qualifier value
"main" is wired with the constructor argument that is qualified with the same value.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:annotation-config/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
        <span class="strong"><strong>&lt;qualifier value="main"/&gt;</strong></span>

        <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
        <span class="strong"><strong>&lt;qualifier value="action"/&gt;</strong></span>

        <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"movieRecommender"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.MovieRecommender"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>For a fallback match, the bean name is considered a default qualifier value. Thus you
can define the bean with an id "main" instead of the nested qualifier element, leading
to the same matching result. However, although you can use this convention to refer to
specific beans by name, <code class="literal">@Autowired</code> is fundamentally about type-driven injection with
optional semantic qualifiers. This means that qualifier values, even with the bean name
fallback, always have narrowing semantics within the set of type matches; they do not
semantically express a reference to a unique bean id. Good qualifier values are "main"
or "EMEA" or "persistent", expressing characteristics of a specific component that are
independent from the bean id, which may be auto-generated in case of an anonymous bean
definition like the one in the preceding example.</p>
<p>Qualifiers also apply to typed collections, as discussed above, for example, to
<code class="literal">Set&lt;MovieCatalog&gt;</code>. In this case, all matching beans according to the declared
qualifiers are injected as a collection. This implies that qualifiers do not have to be
unique; they rather simply constitute filtering criteria. For example, you can define
multiple <code class="literal">MovieCatalog</code> beans with the same qualifier value "action"; all of which would
be injected into a <code class="literal">Set&lt;MovieCatalog&gt;</code> annotated with <code class="literal">@Qualifier("action")</code>.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you intend to express annotation-driven injection by name, do not primarily use
<code class="literal">@Autowired</code>, even if is technically capable of referring to a bean name through
<code class="literal">@Qualifier</code> values. Instead, use the JSR-250 <code class="literal">@Resource</code> annotation, which is
semantically defined to identify a specific target component by its unique name, with
the declared type being irrelevant for the matching process.</p>
<p>As a specific consequence of this semantic difference, beans that are themselves defined
as a collection or map type cannot be injected through <code class="literal">@Autowired</code>, because type
matching is not properly applicable to them. Use <code class="literal">@Resource</code> for such beans, referring
to the specific collection or map bean by unique name.</p>
<p><code class="literal">@Autowired</code> applies to fields, constructors, and multi-argument methods, allowing for
narrowing through qualifier annotations at the parameter level. By contrast, <code class="literal">@Resource</code>
is supported only for fields and bean property setter methods with a single argument. As
a consequence, stick with qualifiers if your injection target is a constructor or a
multi-argument method.</p>
</td></tr></table></div>

<p>You can create your own custom qualifier annotations. Simply define an annotation and
provide the <code class="literal">@Qualifier</code> annotation within your definition:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Target({ElementType.FIELD, ElementType.PARAMETER})</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<span class="strong"><strong>@Qualifier</strong></span>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> Genre {

    String value();
}</pre>

<p>Then you can provide the custom qualifier on autowired fields and parameters:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="strong"><strong>@Genre("Action")</strong></span>
    <span class="hl-keyword">private</span> MovieCatalog actionCatalog;
    <span class="hl-keyword">private</span> MovieCatalog comedyCatalog;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setComedyCatalog(<span class="strong"><strong>@Genre("Comedy")</strong></span> MovieCatalog comedyCatalog) {
        <span class="hl-keyword">this</span>.comedyCatalog = comedyCatalog;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>Next, provide the information for the candidate bean definitions. You can add
<code class="literal">&lt;qualifier/&gt;</code> tags as sub-elements of the <code class="literal">&lt;bean/&gt;</code> tag and then specify the <code class="literal">type</code> and
<code class="literal">value</code> to match your custom qualifier annotations. The type is matched against the
fully-qualified class name of the annotation. Or, as a convenience if no risk of
conflicting names exists, you can use the short class name. Both approaches are
demonstrated in the following example.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:annotation-config/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
        <span class="strong"><strong>&lt;qualifier type="Genre" value="Action"/&gt;</strong></span>
        <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
        <span class="strong"><strong>_&lt;qualifier type="example.Genre" value="Comedy"/&gt;</strong></span>
        <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"movieRecommender"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.MovieRecommender"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>In <a class="xref" href="#beans-classpath-scanning" title="4.10&nbsp;Classpath scanning and managed components">Section&nbsp;4.10, &#8220;Classpath scanning and managed components&#8221;</a>, you will see an annotation-based alternative to
providing the qualifier metadata in XML. Specifically, see <a class="xref" href="#beans-scanning-qualifiers" title="4.10.8&nbsp;Providing qualifier metadata with annotations">Section&nbsp;4.10.8, &#8220;Providing qualifier metadata with annotations&#8221;</a>.</p>
<p>In some cases, it may be sufficient to use an annotation without a value. This may be
useful when the annotation serves a more generic purpose and can be applied across
several different types of dependencies. For example, you may provide an <span class="emphasis"><em>offline</em></span>
catalog that would be searched when no Internet connection is available. First define
the simple annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Target({ElementType.FIELD, ElementType.PARAMETER})</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Qualifier</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> Offline {

}</pre>

<p>Then add the annotation to the field or property to be autowired:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="strong"><strong>@Offline</strong></span>
    <span class="hl-keyword">private</span> MovieCatalog offlineCatalog;

    <span class="hl-comment">// ...</span>

}</pre>

<p>Now the bean definition only needs a qualifier <code class="literal">type</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
    <span class="strong"><strong>&lt;qualifier type="Offline"/&gt;</strong></span>
    <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>You can also define custom qualifier annotations that accept named attributes in
addition to or instead of the simple <code class="literal">value</code> attribute. If multiple attribute values are
then specified on a field or parameter to be autowired, a bean definition must match
<span class="emphasis"><em>all</em></span> such attribute values to be considered an autowire candidate. As an example,
consider the following annotation definition:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Target({ElementType.FIELD, ElementType.PARAMETER})</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Qualifier</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> MovieQualifier {

    String genre();

    Format format();

}</pre>

<p>In this case <code class="literal">Format</code> is an enum:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> enum Format {
    VHS, DVD, BLURAY
}</pre>

<p>The fields to be autowired are annotated with the custom qualifier and include values
for both attributes: <code class="literal">genre</code> and <code class="literal">format</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <i><span class="hl-annotation" style="color: gray">@MovieQualifier(format=Format.VHS, genre="Action")</span></i>
    <span class="hl-keyword">private</span> MovieCatalog actionVhsCatalog;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <i><span class="hl-annotation" style="color: gray">@MovieQualifier(format=Format.VHS, genre="Comedy")</span></i>
    <span class="hl-keyword">private</span> MovieCatalog comedyVhsCatalog;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <i><span class="hl-annotation" style="color: gray">@MovieQualifier(format=Format.DVD, genre="Action")</span></i>
    <span class="hl-keyword">private</span> MovieCatalog actionDvdCatalog;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <i><span class="hl-annotation" style="color: gray">@MovieQualifier(format=Format.BLURAY, genre="Comedy")</span></i>
    <span class="hl-keyword">private</span> MovieCatalog comedyBluRayCatalog;

    <span class="hl-comment">// ...</span>

}</pre>

<p>Finally, the bean definitions should contain matching qualifier values. This example
also demonstrates that bean <span class="emphasis"><em>meta</em></span> attributes may be used instead of the
<code class="literal">&lt;qualifier/&gt;</code> sub-elements. If available, the <code class="literal">&lt;qualifier/&gt;</code> and its attributes take
precedence, but the autowiring mechanism falls back on the values provided within the
<code class="literal">&lt;meta/&gt;</code> tags if no such qualifier is present, as in the last two bean definitions in
the following example.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:annotation-config/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;qualifier</span> <span class="hl-attribute">type</span>=<span class="hl-value">"MovieQualifier"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;attribute</span> <span class="hl-attribute">key</span>=<span class="hl-value">"format"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"VHS"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;attribute</span> <span class="hl-attribute">key</span>=<span class="hl-value">"genre"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Action"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/qualifier&gt;</span>
        <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;qualifier</span> <span class="hl-attribute">type</span>=<span class="hl-value">"MovieQualifier"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;attribute</span> <span class="hl-attribute">key</span>=<span class="hl-value">"format"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"VHS"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;attribute</span> <span class="hl-attribute">key</span>=<span class="hl-value">"genre"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Comedy"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/qualifier&gt;</span>
        <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;meta</span> <span class="hl-attribute">key</span>=<span class="hl-value">"format"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"DVD"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;meta</span> <span class="hl-attribute">key</span>=<span class="hl-value">"genre"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Action"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMovieCatalog"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;meta</span> <span class="hl-attribute">key</span>=<span class="hl-value">"format"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BLURAY"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;meta</span> <span class="hl-attribute">key</span>=<span class="hl-value">"genre"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Comedy"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-comment">&lt;!-- inject any dependencies required by this bean --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="4.9.4&nbsp;Using generics as autowiring qualifiers"><div class="titlepage"><div><div><h3 class="title"><a name="beans-generics-as-qualifiers"></a>4.9.4&nbsp;Using generics as autowiring qualifiers</h3></div></div></div>

<p>In addition to the <code class="literal">@Qualifier</code> annotation, it is also possible to use Java generic types
as an implicit form of qualification. For example, suppose you have the following
configuration:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyConfiguration {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> StringStore stringStore() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StringStore();
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> IntegerStore integerStore() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> IntegerStore();
    }

}</pre>

<p>Assuming that beans above implement a generic interface, i.e. <code class="literal">Store&lt;String&gt;</code> and
<code class="literal">Store&lt;Integer&gt;</code>, you can <code class="literal">@Autowire</code> the <code class="literal">Store</code> interface and the <span class="emphasis"><em>generic</em></span> will
be used as a qualifier:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
<span class="hl-keyword">private</span> Store&lt;String&gt; s1; <span class="hl-comment">// &lt;String&gt; qualifier, injects the stringStore bean</span>

<i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
<span class="hl-keyword">private</span> Store&lt;Integer&gt; s2; <span class="hl-comment">// &lt;Integer&gt; qualifier, injects the integerStore bean</span></pre>

<p>Generic qualifiers also apply when autowiring Lists, Maps and Arrays:</p>
<pre class="programlisting"><span class="hl-comment">// Inject all Store beans as long as they have an &lt;Integer&gt; generic</span>
<span class="hl-comment">// Store&lt;String&gt; beans will not appear in this list</span>
<i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
<span class="hl-keyword">private</span> List&lt;Store&lt;Integer&gt;&gt; s;</pre>

</div>
<div class="section" title="4.9.5&nbsp;CustomAutowireConfigurer"><div class="titlepage"><div><div><h3 class="title"><a name="beans-custom-autowire-configurer"></a>4.9.5&nbsp;CustomAutowireConfigurer</h3></div></div></div>

<p>The
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/annotation/CustomAutowireConfigurer.html" target="_top"><code class="literal">CustomAutowireConfigurer</code></a>
is a <code class="literal">BeanFactoryPostProcessor</code> that enables you to register your own custom qualifier
annotation types even if they are not annotated with Spring&#8217;s <code class="literal">@Qualifier</code> annotation.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAutowireConfigurer"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.annotation.CustomAutowireConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"customQualifierTypes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;set&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>example.CustomQualifier<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/set&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">AutowireCandidateResolver</code> determines autowire candidates by:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
the <code class="literal">autowire-candidate</code> value of each bean definition
</li><li class="listitem">
any <code class="literal">default-autowire-candidates</code> pattern(s) available on the <code class="literal">&lt;beans/&gt;</code> element
</li><li class="listitem">
the presence of <code class="literal">@Qualifier</code> annotations and any custom annotations registered
with the <code class="literal">CustomAutowireConfigurer</code>
</li></ul></div>

<p>When multiple beans qualify as autowire candidates, the determination of a "primary" is
the following: if exactly one bean definition among the candidates has a <code class="literal">primary</code>
attribute set to <code class="literal">true</code>, it will be selected.</p>
</div>
<div class="section" title="4.9.6&nbsp;@Resource"><div class="titlepage"><div><div><h3 class="title"><a name="beans-resource-annotation"></a>4.9.6&nbsp;@Resource</h3></div></div></div>

<p>Spring also supports injection using the JSR-250 <code class="literal">@Resource</code> annotation on fields or
bean property setter methods. This is a common pattern in Java EE 5 and 6, for example
in JSF 1.2 managed beans or JAX-WS 2.0 endpoints. Spring supports this pattern for
Spring-managed objects as well.</p>
<p><code class="literal">@Resource</code> takes a name attribute, and by default Spring interprets that value as the
bean name to be injected. In other words, it follows <span class="emphasis"><em>by-name</em></span> semantics, as
demonstrated in this example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <span class="strong"><strong>@Resource(name="myMovieFinder")</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

}</pre>

<p>If no name is specified explicitly, the default name is derived from the field name or
setter method. In case of a field, it takes the field name; in case of a setter method,
it takes the bean property name. So the following example is going to have the bean with
name "movieFinder" injected into its setter method:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <span class="strong"><strong>@Resource</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The name provided with the annotation is resolved as a bean name by the
<code class="literal">ApplicationContext</code> of which the <code class="literal">CommonAnnotationBeanPostProcessor</code> is aware. The
names can be resolved through JNDI if you configure Spring&#8217;s
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jndi/support/SimpleJndiBeanFactory.html" target="_top"><code class="literal">SimpleJndiBeanFactory</code></a>
explicitly. However, it is recommended that you rely on the default behavior and simply
use Spring&#8217;s JNDI lookup capabilities to preserve the level of indirection.</p>
</td></tr></table></div>

<p>In the exclusive case of <code class="literal">@Resource</code> usage with no explicit name specified, and similar
to <code class="literal">@Autowired</code>, <code class="literal">@Resource</code> finds a primary type match instead of a specific named bean
and resolves well-known resolvable dependencies: the <code class="literal">BeanFactory</code>,
<code class="literal">ApplicationContext</code>, <code class="literal">ResourceLoader</code>, <code class="literal">ApplicationEventPublisher</code>, and <code class="literal">MessageSource</code>
interfaces.</p>
<p>Thus in the following example, the <code class="literal">customerPreferenceDao</code> field first looks for a bean
named customerPreferenceDao, then falls back to a primary type match for the type
<code class="literal">CustomerPreferenceDao</code>. The "context" field is injected based on the known resolvable
dependency type <code class="literal">ApplicationContext</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <i><span class="hl-annotation" style="color: gray">@Resource</span></i>
    <span class="hl-keyword">private</span> CustomerPreferenceDao customerPreferenceDao;

    <i><span class="hl-annotation" style="color: gray">@Resource</span></i>
    <span class="hl-keyword">private</span> ApplicationContext context;

    <span class="hl-keyword">public</span> MovieRecommender() {
    }

    <span class="hl-comment">// ...</span>

}</pre>

</div>
<div class="section" title="4.9.7&nbsp;@PostConstruct and @PreDestroy"><div class="titlepage"><div><div><h3 class="title"><a name="beans-postconstruct-and-predestroy-annotations"></a>4.9.7&nbsp;@PostConstruct and @PreDestroy</h3></div></div></div>

<p>The <code class="literal">CommonAnnotationBeanPostProcessor</code> not only recognizes the <code class="literal">@Resource</code> annotation
but also the JSR-250 <span class="emphasis"><em>lifecycle</em></span> annotations. Introduced in Spring 2.5, the support
for these annotations offers yet another alternative to those described in
<a class="link" href="#beans-factory-lifecycle-initializingbean" title="Initialization callbacks">initialization callbacks</a> and
<a class="link" href="#beans-factory-lifecycle-disposablebean" title="Destruction callbacks">destruction callbacks</a>. Provided that the
<code class="literal">CommonAnnotationBeanPostProcessor</code> is registered within the Spring
<code class="literal">ApplicationContext</code>, a method carrying one of these annotations is invoked at the same
point in the lifecycle as the corresponding Spring lifecycle interface method or
explicitly declared callback method. In the example below, the cache will be
pre-populated upon initialization and cleared upon destruction.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CachingMovieLister {

    <i><span class="hl-annotation" style="color: gray">@PostConstruct</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> populateMovieCache() {
        <span class="hl-comment">// populates the movie cache upon initialization...</span>
    }

    <i><span class="hl-annotation" style="color: gray">@PreDestroy</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> clearMovieCache() {
        <span class="hl-comment">// clears the movie cache upon destruction...</span>
    }

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For details about the effects of combining various lifecycle mechanisms, see
<a class="xref" href="#beans-factory-lifecycle-combined-effects" title="Combining lifecycle mechanisms">the section called &#8220;Combining lifecycle mechanisms&#8221;</a>.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="4.10&nbsp;Classpath scanning and managed components"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-classpath-scanning"></a>4.10&nbsp;Classpath scanning and managed components</h2></div></div></div>

<p>Most examples in this chapter use XML to specify the configuration metadata that
produces each <code class="literal">BeanDefinition</code> within the Spring container. The previous section
(<a class="xref" href="#beans-annotation-config" title="4.9&nbsp;Annotation-based container configuration">Section&nbsp;4.9, &#8220;Annotation-based container configuration&#8221;</a>) demonstrates how to provide a lot of the configuration
metadata through source-level annotations. Even in those examples, however, the "base"
bean definitions are explicitly defined in the XML file, while the annotations only
drive the dependency injection. This section describes an option for implicitly
detecting the <span class="emphasis"><em>candidate components</em></span> by scanning the classpath. Candidate components
are classes that match against a filter criteria and have a corresponding bean
definition registered with the container. This removes the need to use XML to perform
bean registration, instead you can use annotations (for example @Component), AspectJ
type expressions, or your own custom filter criteria to select which classes will have
bean definitions registered with the container.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with Spring 3.0, many features provided by the Spring JavaConfig project are
part of the core Spring Framework. This allows you to define beans using Java rather
than using the traditional XML files. Take a look at the <code class="literal">@Configuration</code>, <code class="literal">@Bean</code>,
<code class="literal">@Import</code>, and <code class="literal">@DependsOn</code> annotations for examples of how to use these new features.</p>
</td></tr></table></div>

<div class="section" title="4.10.1&nbsp;@Component and further stereotype annotations"><div class="titlepage"><div><div><h3 class="title"><a name="beans-stereotype-annotations"></a>4.10.1&nbsp;@Component and further stereotype annotations</h3></div></div></div>

<p>The <code class="literal">@Repository</code> annotation is a marker for any class that fulfills the role or
<span class="emphasis"><em>stereotype</em></span> (also known as Data Access Object or DAO) of a repository. Among the uses
of this marker is the automatic translation of exceptions as described in
<a class="xref" href="#orm-exception-translation" title="14.2.2&nbsp;Exception translation">Section&nbsp;14.2.2, &#8220;Exception translation&#8221;</a>.</p>
<p>Spring provides further stereotype annotations: <code class="literal">@Component</code>, <code class="literal">@Service</code>, and
<code class="literal">@Controller</code>. <code class="literal">@Component</code> is a generic stereotype for any Spring-managed component.
<code class="literal">@Repository</code>, <code class="literal">@Service</code>, and <code class="literal">@Controller</code> are specializations of <code class="literal">@Component</code> for
more specific use cases, for example, in the persistence, service, and presentation
layers, respectively. Therefore, you can annotate your component classes with
<code class="literal">@Component</code>, but by annotating them with <code class="literal">@Repository</code>, <code class="literal">@Service</code>, or <code class="literal">@Controller</code>
instead, your classes are more properly suited for processing by tools or associating
with aspects. For example, these stereotype annotations make ideal targets for
pointcuts. It is also possible that <code class="literal">@Repository</code>, <code class="literal">@Service</code>, and <code class="literal">@Controller</code> may
carry additional semantics in future releases of the Spring Framework. Thus, if you are
choosing between using <code class="literal">@Component</code> or <code class="literal">@Service</code> for your service layer, <code class="literal">@Service</code> is
clearly the better choice. Similarly, as stated above, <code class="literal">@Repository</code> is already
supported as a marker for automatic exception translation in your persistence layer.</p>
</div>
<div class="section" title="4.10.2&nbsp;Meta-annotations"><div class="titlepage"><div><div><h3 class="title"><a name="beans-meta-annotations"></a>4.10.2&nbsp;Meta-annotations</h3></div></div></div>

<p>Many of the annotations provided by Spring can be used as "meta-annotations" in
your own code. A meta-annotation is simply an annotation, that can be applied to another
annotation. For example, The <code class="literal">@Service</code> annotation mentioned above is meta-annotated with
with <code class="literal">@Component</code>:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Target({ElementType.TYPE})</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Documented</span></i>
<span class="strong"><strong>@Component</strong></span> <span class="hl-comment">// Spring will see this and treat @Service in the same way as @Component</span>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> Service {

    <span class="hl-comment">// ....</span>

}</pre>

<p>Meta-annotations can also be combined together to create <span class="emphasis"><em>composed annotations</em></span>. For
example, the <code class="literal">@RestController</code> annotation from Spring MVC is <span class="emphasis"><em>composed</em></span> of
<code class="literal">@Controller</code> and <code class="literal">@ResponseBody</code>.</p>
<p>With the exception of <code class="literal">value()</code>, meta-annotated types may redeclare attributes from the
source annotation to allow user customization. This can be particularly useful when you
want to only expose a subset of the source annotation attributes. For example, here is a
custom <code class="literal">@Scope</code> annotation that defines <code class="literal">session</code> scope, but still allows customization
of the <code class="literal">proxyMode</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Target({ElementType.TYPE})</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Documented</span></i>
<span class="strong"><strong>@Scope("session")</strong></span>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> SessionScope {

    ScopedProxyMode proxyMode() <span class="hl-keyword">default</span> ScopedProxyMode.DEFAULT

}</pre>

</div>
<div class="section" title="4.10.3&nbsp;Automatically detecting classes and registering bean definitions"><div class="titlepage"><div><div><h3 class="title"><a name="beans-scanning-autodetection"></a>4.10.3&nbsp;Automatically detecting classes and registering bean definitions</h3></div></div></div>

<p>Spring can automatically detect stereotyped classes and register corresponding
<code class="literal">BeanDefinition</code> s with the <code class="literal">ApplicationContext</code>. For example, the following two classes
are eligible for such autodetection:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Service</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> SimpleMovieLister(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Repository</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaMovieFinder <span class="hl-keyword">implements</span> MovieFinder {
    <span class="hl-comment">// implementation elided for clarity</span>
}</pre>

<p>To autodetect these classes and register the corresponding beans, you need to include
the following element in XML, where the base-package element is a common parent package
for the two classes. (Alternatively, you can specify a comma-separated list that
includes the parent package of each class.)</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.example"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The use of <code class="literal">&lt;context:component-scan&gt;</code> implicitly enables the functionality of
<code class="literal">&lt;context:annotation-config&gt;</code>. There is usually no need to include the
<code class="literal">&lt;context:annotation-config&gt;</code> element when using <code class="literal">&lt;context:component-scan&gt;</code>.</p>
</td></tr></table></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The scanning of classpath packages requires the presence of corresponding directory
entries in the classpath. When you build JARs with Ant, make sure that you do <span class="emphasis"><em>not</em></span>
activate the files-only switch of the JAR task. Also, classpath directories may not
get exposed based on security policies in some environments, e.g. standalone apps on
JDK 1.7.0_45 and higher (which requires <span class="emphasis"><em>Trusted-Library</em></span> setup in your manifests; see
<a class="ulink" href="http://stackoverflow.com/questions/19394570/java-jre-7u45-breaks-classloader-getresources)" target="_top">http://stackoverflow.com/questions/19394570/java-jre-7u45-breaks-classloader-getresources)</a>.</p>
</td></tr></table></div>

<p>Furthermore, the <code class="literal">AutowiredAnnotationBeanPostProcessor</code> and
<code class="literal">CommonAnnotationBeanPostProcessor</code> are both included implicitly when you use the
component-scan element. That means that the two components are autodetected <span class="emphasis"><em>and</em></span>
wired together - all without any bean configuration metadata provided in XML.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can disable the registration of <code class="literal">AutowiredAnnotationBeanPostProcessor</code> and
<code class="literal">CommonAnnotationBeanPostProcessor</code> by including the <span class="emphasis"><em>annotation-config</em></span> attribute
with a value of false.</p>
</td></tr></table></div>

</div>
<div class="section" title="4.10.4&nbsp;Using filters to customize scanning"><div class="titlepage"><div><div><h3 class="title"><a name="beans-scanning-filters"></a>4.10.4&nbsp;Using filters to customize scanning</h3></div></div></div>

<p>By default, classes annotated with <code class="literal">@Component</code>, <code class="literal">@Repository</code>, <code class="literal">@Service</code>,
<code class="literal">@Controller</code>, or a custom annotation that itself is annotated with <code class="literal">@Component</code> are the
only detected candidate components. However, you can modify and extend this behavior
simply by applying custom filters. Add them as <span class="emphasis"><em>include-filter</em></span> or <span class="emphasis"><em>exclude-filter</em></span>
sub-elements of the <code class="literal">component-scan</code> element. Each filter element requires the <code class="literal">type</code>
and <code class="literal">expression</code> attributes. The following table describes the filtering options.</p>
<div class="table"><a name="beans-scanning-filters-tbl"></a><p class="title"><b>Table&nbsp;4.5.&nbsp;Filter Types</b></p><div class="table-contents">

  <table summary="Filter Types" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Filter Type</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Example Expression</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>annotation</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org.example.SomeAnnotation</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An annotation to be present at the type level in target components.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>assignable</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org.example.SomeClass</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A class (or interface) that the target components are assignable to (extend/implement).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>aspectj</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org.example..*Service+</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An AspectJ type expression to be matched by the target components.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>regex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org\.example\.Default.*</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A regex expression to be matched by the target components class names.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>custom</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org.example.MyTypeFilter</code></p></td><td style="" align="left" valign="top"><p>A custom implementation of the <code class="literal">org.springframework.core.type .TypeFilter</code> interface.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>The following example shows the XML configuration ignoring all <code class="literal">@Repository</code> annotations
and using "stub" repositories instead.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.example"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;context:include-filter</span> <span class="hl-attribute">type</span>=<span class="hl-value">"regex"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">".*Stub.*Repository"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;context:exclude-filter</span> <span class="hl-attribute">type</span>=<span class="hl-value">"annotation"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"org.springframework.stereotype.Repository"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/context:component-scan&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can also disable the default filters by providing <span class="emphasis"><em>use-default-filters="false"</em></span> as
an attribute of the &lt;component-scan/&gt; element. This will in effect disable automatic
detection of classes annotated with <code class="literal">@Component</code>, <code class="literal">@Repository</code>, <code class="literal">@Service</code>, or
<code class="literal">@Controller</code>.</p>
</td></tr></table></div>

</div>
<div class="section" title="4.10.5&nbsp;Defining bean metadata within components"><div class="titlepage"><div><div><h3 class="title"><a name="beans-factorybeans-annotations"></a>4.10.5&nbsp;Defining bean metadata within components</h3></div></div></div>

<p>Spring components can also contribute bean definition metadata to the container. You do
this with the same <code class="literal">@Bean</code> annotation used to define bean metadata within
<code class="literal">@Configuration</code> annotated classes. Here is a simple example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Component</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FactoryMethodComponent {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <i><span class="hl-annotation" style="color: gray">@Qualifier("public")</span></i>
    <span class="hl-keyword">public</span> TestBean publicInstance() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TestBean(<span class="hl-string">"publicInstance"</span>);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doWork() {
        <span class="hl-comment">// Component method implementation omitted</span>
    }

}</pre>

<p>This class is a Spring component that has application-specific code contained in its
<code class="literal">doWork()</code> method. However, it also contributes a bean definition that has a factory
method referring to the method <code class="literal">publicInstance()</code>. The <code class="literal">@Bean</code> annotation identifies the
factory method and other bean definition properties, such as a qualifier value through
the <code class="literal">@Qualifier</code> annotation. Other method level annotations that can be specified are
<code class="literal">@Scope</code>, <code class="literal">@Lazy</code>, and custom qualifier annotations.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>In addition to its role for component initialization, the <code class="literal">@Lazy</code> annotation may also be
placed on injection points marked with <code class="literal">@Autowired</code> or <code class="literal">@Inject</code>. In this context, it
leads to the injection of a lazy-resolution proxy.</p>
</td></tr></table></div>

<p>Autowired fields and methods are supported as previously discussed, with additional
support for autowiring of <code class="literal">@Bean</code> methods:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Component</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FactoryMethodComponent {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">int</span> i;

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <i><span class="hl-annotation" style="color: gray">@Qualifier("public")</span></i>
    <span class="hl-keyword">public</span> TestBean publicInstance() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TestBean(<span class="hl-string">"publicInstance"</span>);
    }

    <span class="hl-comment">// use of a custom qualifier and autowiring of method parameters</span>

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">protected</span> TestBean protectedInstance(
            <i><span class="hl-annotation" style="color: gray">@Qualifier("public")</span></i> TestBean spouse,
            <i><span class="hl-annotation" style="color: gray">@Value("#{privateInstance.age}")</span></i> String country) {
        TestBean tb = <span class="hl-keyword">new</span> TestBean(<span class="hl-string">"protectedInstance"</span>, <span class="hl-number">1</span>);
        tb.setSpouse(tb);
        tb.setCountry(country);
        <span class="hl-keyword">return</span> tb;
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <i><span class="hl-annotation" style="color: gray">@Scope(BeanDefinition.SCOPE_SINGLETON)</span></i>
    <span class="hl-keyword">private</span> TestBean privateInstance() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TestBean(<span class="hl-string">"privateInstance"</span>, i++);
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <i><span class="hl-annotation" style="color: gray">@Scope(value = WebApplicationContext.SCOPE_SESSION, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></i>
    <span class="hl-keyword">public</span> TestBean requestScopedInstance() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TestBean(<span class="hl-string">"requestScopedInstance"</span>, <span class="hl-number">3</span>);
    }

}</pre>

<p>The example autowires the <code class="literal">String</code> method parameter <code class="literal">country</code> to the value of the <code class="literal">Age</code>
property on another bean named <code class="literal">privateInstance</code>. A Spring Expression Language element
defines the value of the property through the notation <code class="literal">#{ &lt;expression&gt; }</code>. For <code class="literal">@Value</code>
annotations, an expression resolver is preconfigured to look for bean names when
resolving expression text.</p>
<p>The <code class="literal">@Bean</code> methods in a Spring component are processed differently than their
counterparts inside a Spring <code class="literal">@Configuration</code> class. The difference is that <code class="literal">@Component</code>
classes are not enhanced with CGLIB to intercept the invocation of methods and fields.
CGLIB proxying is the means by which invoking methods or fields within <code class="literal">@Configuration</code>
classes <code class="literal">@Bean</code> methods create bean metadata references to collaborating objects.
Methods are <span class="emphasis"><em>not</em></span> invoked with normal Java semantics. In contrast, calling a method or
field within a <code class="literal">@Component</code> classes <code class="literal">@Bean</code> method <span class="emphasis"><em>has</em></span> standard Java semantics.</p>
</div>
<div class="section" title="4.10.6&nbsp;Naming autodetected components"><div class="titlepage"><div><div><h3 class="title"><a name="beans-scanning-name-generator"></a>4.10.6&nbsp;Naming autodetected components</h3></div></div></div>

<p>When a component is autodetected as part of the scanning process, its bean name is
generated by the <code class="literal">BeanNameGenerator</code> strategy known to that scanner. By default, any
Spring stereotype annotation ( <code class="literal">@Component</code>, <code class="literal">@Repository</code>, <code class="literal">@Service</code>, and
<code class="literal">@Controller</code>) that contains a <code class="literal">name</code> value will thereby provide that name to the
corresponding bean definition.</p>
<p>If such an annotation contains no <code class="literal">name</code> value or for any other detected component (such
as those discovered by custom filters), the default bean name generator returns the
uncapitalized non-qualified class name. For example, if the following two components
were detected, the names would be myMovieLister and movieFinderImpl:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Service("myMovieLister")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {
    <span class="hl-comment">// ...</span>
}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Repository</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieFinderImpl <span class="hl-keyword">implements</span> MovieFinder {
    <span class="hl-comment">// ...</span>
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you do not want to rely on the default bean-naming strategy, you can provide a custom
bean-naming strategy. First, implement the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/support/BeanNameGenerator.html" target="_top"><code class="literal">BeanNameGenerator</code></a>
interface, and be sure to include a default no-arg constructor. Then, provide the
fully-qualified class name when configuring the scanner:</p>
</td></tr></table></div>

<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.example"</span>
        <span class="hl-attribute">name-generator</span>=<span class="hl-value">"org.example.MyNameGenerator"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>As a general rule, consider specifying the name with the annotation whenever other
components may be making explicit references to it. On the other hand, the
auto-generated names are adequate whenever the container is responsible for wiring.</p>
</div>
<div class="section" title="4.10.7&nbsp;Providing a scope for autodetected components"><div class="titlepage"><div><div><h3 class="title"><a name="beans-scanning-scope-resolver"></a>4.10.7&nbsp;Providing a scope for autodetected components</h3></div></div></div>

<p>As with Spring-managed components in general, the default and most common scope for
autodetected components is singleton. However, sometimes you need other scopes, which
Spring 2.5 provides with a new <code class="literal">@Scope</code> annotation. Simply provide the name of the scope
within the annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Scope("prototype")</span></i>
<i><span class="hl-annotation" style="color: gray">@Repository</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieFinderImpl <span class="hl-keyword">implements</span> MovieFinder {
    <span class="hl-comment">// ...</span>
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>To provide a custom strategy for scope resolution rather than relying on the
annotation-based approach, implement the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/ScopeMetadataResolver.html" target="_top"><code class="literal">ScopeMetadataResolver</code></a>
interface, and be sure to include a default no-arg constructor. Then, provide the
fully-qualified class name when configuring the scanner:</p>
</td></tr></table></div>

<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.example"</span>
            <span class="hl-attribute">scope-resolver</span>=<span class="hl-value">"org.example.MyScopeResolver"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>When using certain non-singleton scopes, it may be necessary to generate proxies for the
scoped objects. The reasoning is described in <a class="xref" href="#beans-factory-scopes-other-injection" title="Scoped beans as dependencies">the section called &#8220;Scoped beans as dependencies&#8221;</a>.
For this purpose, a <span class="emphasis"><em>scoped-proxy</em></span> attribute is available on the component-scan
element. The three possible values are: no, interfaces, and targetClass. For example,
the following configuration will result in standard JDK dynamic proxies:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.example"</span>
        <span class="hl-attribute">scoped-proxy</span>=<span class="hl-value">"interfaces"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="4.10.8&nbsp;Providing qualifier metadata with annotations"><div class="titlepage"><div><div><h3 class="title"><a name="beans-scanning-qualifiers"></a>4.10.8&nbsp;Providing qualifier metadata with annotations</h3></div></div></div>

<p>The <code class="literal">@Qualifier</code> annotation is discussed in <a class="xref" href="#beans-autowired-annotation-qualifiers" title="4.9.3&nbsp;Fine-tuning annotation-based autowiring with qualifiers">Section&nbsp;4.9.3, &#8220;Fine-tuning annotation-based autowiring with qualifiers&#8221;</a>.
The examples in that section demonstrate the use of the <code class="literal">@Qualifier</code> annotation and
custom qualifier annotations to provide fine-grained control when you resolve autowire
candidates. Because those examples were based on XML bean definitions, the qualifier
metadata was provided on the candidate bean definitions using the <code class="literal">qualifier</code> or <code class="literal">meta</code>
sub-elements of the <code class="literal">bean</code> element in the XML. When relying upon classpath scanning for
autodetection of components, you provide the qualifier metadata with type-level
annotations on the candidate class. The following three examples demonstrate this
technique:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Component</span></i>
<span class="strong"><strong>@Qualifier("Action")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ActionMovieCatalog <span class="hl-keyword">implements</span> MovieCatalog {
    <span class="hl-comment">// ...</span>
}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Component</span></i>
<span class="strong"><strong>@Genre("Action")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ActionMovieCatalog <span class="hl-keyword">implements</span> MovieCatalog {
    <span class="hl-comment">// ...</span>
}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Component</span></i>
<span class="strong"><strong>@Offline</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CachingMovieCatalog <span class="hl-keyword">implements</span> MovieCatalog {
    <span class="hl-comment">// ...</span>
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As with most annotation-based alternatives, keep in mind that the annotation metadata is
bound to the class definition itself, while the use of XML allows for multiple beans
<span class="emphasis"><em>of the same type</em></span> to provide variations in their qualifier metadata, because that
metadata is provided per-instance rather than per-class.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="4.11&nbsp;Using JSR 330 Standard Annotations"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-standard-annotations"></a>4.11&nbsp;Using JSR 330 Standard Annotations</h2></div></div></div>

<p>Starting with Spring 3.0, Spring offers support for JSR-330 standard annotations
(Dependency Injection). Those annotations are scanned in the same way as the Spring
annotations. You just need to have the relevant jars in your classpath.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are using Maven, the <code class="literal">javax.inject</code> artifact is available in the standard Maven
repository (
<a class="ulink" href="http://repo1.maven.org/maven2/javax/inject/javax.inject/1/" target="_top">http://repo1.maven.org/maven2/javax/inject/javax.inject/1/</a>).
You can add the following dependency to your file pom.xml:</p>
<pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>javax.inject<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>javax.inject<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>1<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre>

</td></tr></table></div>

<div class="section" title="4.11.1&nbsp;Dependency Injection with @Inject and @Named"><div class="titlepage"><div><div><h3 class="title"><a name="beans-inject-named"></a>4.11.1&nbsp;Dependency Injection with @Inject and @Named</h3></div></div></div>

<p>Instead of <code class="literal">@Autowired</code>, <code class="literal">@javax.inject.Inject</code> may be used as follows:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.inject.Inject;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <i><span class="hl-annotation" style="color: gray">@Inject</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>As with <code class="literal">@Autowired</code>, it is possible to use <code class="literal">@Inject</code> at the class-level, field-level,
method-level and constructor-argument level. If you would like to use a qualified name
for the dependency that should be injected, you should use the <code class="literal">@Named</code> annotation as
follows:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.inject.Inject;
<span class="hl-keyword">import</span> javax.inject.Named;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <i><span class="hl-annotation" style="color: gray">@Inject</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(<i><span class="hl-annotation" style="color: gray">@Named("main")</span></i> MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// ...</span>

}</pre>

</div>
<div class="section" title="4.11.2&nbsp;@Named: a standard equivalent to the @Component annotation"><div class="titlepage"><div><div><h3 class="title"><a name="beans-named"></a>4.11.2&nbsp;@Named: a standard equivalent to the @Component annotation</h3></div></div></div>

<p>Instead of <code class="literal">@Component</code>, <code class="literal">@javax.inject.Named</code> may be used as follows:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.inject.Inject;
<span class="hl-keyword">import</span> javax.inject.Named;

<i><span class="hl-annotation" style="color: gray">@Named("movieListener")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <i><span class="hl-annotation" style="color: gray">@Inject</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>It is very common to use <code class="literal">@Component</code> without
specifying a name for the component. <code class="literal">@Named</code>
can be used in a similar fashion:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.inject.Inject;
<span class="hl-keyword">import</span> javax.inject.Named;

<i><span class="hl-annotation" style="color: gray">@Named</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;

    <i><span class="hl-annotation" style="color: gray">@Inject</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMovieFinder(MovieFinder movieFinder) {
        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>When using <code class="literal">@Named</code>, it is possible to use
component-scanning in the exact same way as when using Spring annotations:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.example"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="4.11.3&nbsp;Limitations of the standard approach"><div class="titlepage"><div><div><h3 class="title"><a name="beans-standard-annotations-limitations"></a>4.11.3&nbsp;Limitations of the standard approach</h3></div></div></div>

<p>When working with standard annotations, it is important to know that some significant
features are not available as shown in the table below:</p>
<div class="table"><a name="annotations-comparison"></a><p class="title"><b>Table&nbsp;4.6.&nbsp;Spring annotations vs. standard annotations</b></p><div class="table-contents">

  <table summary="Spring annotations vs. standard annotations" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Spring</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">javax.inject.*</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">javax.inject restrictions / comments</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Autowired</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Inject</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Inject has no <span class="emphasis"><em>required</em></span> attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Component</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Named</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>-</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Scope("singleton")</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Singleton</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The JSR-330 default scope is like Spring&#8217;s <code class="literal">prototype</code>. However, in order to keep it
  consistent with Spring&#8217;s general defaults, a JSR-330 bean declared in the Spring
  container is a <code class="literal">singleton</code> by default. In order to use a scope other than <code class="literal">singleton</code>,
  you should use Spring&#8217;s <code class="literal">@Scope</code> annotation.
</p><p><code class="literal">javax.inject</code> also provides a
<a class="ulink" href="http://download.oracle.com/javaee/6/api/javax/inject/Scope.html" target="_top">@Scope</a> annotation.
Nevertheless, this one is only intended to be used for creating your own annotations.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Qualifier</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Named</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>-</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Value</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>-</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no equivalent</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>@Required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>-</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no equivalent</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>@Lazy</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>-</p></td><td style="" align="left" valign="top"><p>no equivalent</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
</div>
<div class="section" title="4.12&nbsp;Java-based container configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-java"></a>4.12&nbsp;Java-based container configuration</h2></div></div></div>

<div class="section" title="4.12.1&nbsp;Basic concepts: @Bean and @Configuration"><div class="titlepage"><div><div><h3 class="title"><a name="beans-java-basic-concepts"></a>4.12.1&nbsp;Basic concepts: @Bean and @Configuration</h3></div></div></div>

<p>The central artifacts in Spring&#8217;s new Java-configuration support are
<code class="literal">@Configuration</code>-annotated classes and <code class="literal">@Bean</code>-annotated methods.</p>
<p>The <code class="literal">@Bean</code> annotation is used to indicate that a method instantiates, configures and
initializes a new object to be managed by the Spring IoC container. For those familiar
with Spring&#8217;s <code class="literal">&lt;beans/&gt;</code> XML configuration the <code class="literal">@Bean</code> annotation plays the same role as
the <code class="literal">&lt;bean/&gt;</code> element. You can use <code class="literal">@Bean</code> annotated methods with any Spring
<code class="literal">@Component</code>, however, they are most often used with <code class="literal">@Configuration</code> beans.</p>
<p>Annotating a class with <code class="literal">@Configuration</code> indicates that its primary purpose is as a
source of bean definitions. Furthermore, <code class="literal">@Configuration</code> classes allow inter-bean
dependencies to be defined by simply calling other <code class="literal">@Bean</code> methods in the same class.
The simplest possible <code class="literal">@Configuration</code> class would read as follows:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> MyService myService() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MyServiceImpl();
    }

}</pre>

<p>The <code class="literal">AppConfig</code> class above would be equivalent to the following Spring <code class="literal">&lt;beans/&gt;</code> XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.acme.services.MyServiceImpl"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The <code class="literal">@Bean</code> and <code class="literal">@Configuration</code> annotations will be discussed in depth in the sections
below. First, however, we&#8217;ll cover the various ways of creating a spring container using
Java-based configuration.</p>
<div class="sidebar" title="Full @Configuration vs lite @Beans mode?"><p class="title"><b>Full @Configuration vs <span class="emphasis"><em>lite</em></span> @Beans mode?</b></p>

<p>When <code class="literal">@Bean</code> methods are declared within classes that are <span class="emphasis"><em>not</em></span> annotated with
<code class="literal">@Configuration</code> they are referred to as being processed in a <span class="emphasis"><em>lite</em></span> mode. For example,
bean methods declared in a <code class="literal">@Component</code> or even in a <span class="emphasis"><em>plain old class</em></span> will be
considered <span class="emphasis"><em>lite</em></span>.</p>
<p>Unlike full <code class="literal">@Configuration</code>, lite <code class="literal">@Bean</code> methods cannot easily declare inter-bean
dependencies. Usually one <code class="literal">@Bean</code> method should not invoke another <code class="literal">@Bean</code> method when
operating in <span class="emphasis"><em>lite</em></span> mode.</p>
<p>Only using <code class="literal">@Bean</code> methods within <code class="literal">@Configuration</code> classes is a recommended approach of
ensuring that <span class="emphasis"><em>full</em></span> mode is always used. This will prevent the same <code class="literal">@Bean</code> method from
accidentally being invoked multiple times and helps to reduce subtle bugs that can be
hard to track down when operating in <span class="emphasis"><em>lite</em></span> mode.</p>
</div>

</div>
<div class="section" title="4.12.2&nbsp;Instantiating the Spring container using AnnotationConfigApplicationContext"><div class="titlepage"><div><div><h3 class="title"><a name="beans-java-instantiating-container"></a>4.12.2&nbsp;Instantiating the Spring container using AnnotationConfigApplicationContext</h3></div></div></div>

<p>The sections below document Spring&#8217;s <code class="literal">AnnotationConfigApplicationContext</code>, new in Spring
3.0. This versatile <code class="literal">ApplicationContext</code> implementation is capable of accepting not only
<code class="literal">@Configuration</code> classes as input, but also plain <code class="literal">@Component</code> classes and classes
annotated with JSR-330 metadata.</p>
<p>When <code class="literal">@Configuration</code> classes are provided as input, the <code class="literal">@Configuration</code> class itself
is registered as a bean definition, and all declared <code class="literal">@Bean</code> methods within the class
are also registered as bean definitions.</p>
<p>When <code class="literal">@Component</code> and JSR-330 classes are provided, they are registered as bean
definitions, and it is assumed that DI metadata such as <code class="literal">@Autowired</code> or <code class="literal">@Inject</code> are
used within those classes where necessary.</p>
<div class="section" title="Simple construction"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-instantiating-container-contstructor"></a>Simple construction</h4></div></div></div>

<p>In much the same way that Spring XML files are used as input when instantiating a
<code class="literal">ClassPathXmlApplicationContext</code>, <code class="literal">@Configuration</code> classes may be used as input when
instantiating an <code class="literal">AnnotationConfigApplicationContext</code>. This allows for completely
XML-free usage of the Spring container:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    ApplicationContext ctx = <span class="hl-keyword">new</span> AnnotationConfigApplicationContext(AppConfig.<span class="hl-keyword">class</span>);
    MyService myService = ctx.getBean(MyService.<span class="hl-keyword">class</span>);
    myService.doStuff();
}</pre>

<p>As mentioned above, <code class="literal">AnnotationConfigApplicationContext</code> is not limited to working only
with <code class="literal">@Configuration</code> classes. Any <code class="literal">@Component</code> or JSR-330 annotated class may be supplied
as input to the constructor. For example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    ApplicationContext ctx = <span class="hl-keyword">new</span> AnnotationConfigApplicationContext(MyServiceImpl.<span class="hl-keyword">class</span>, Dependency1.<span class="hl-keyword">class</span>, Dependency2.<span class="hl-keyword">class</span>);
    MyService myService = ctx.getBean(MyService.<span class="hl-keyword">class</span>);
    myService.doStuff();
}</pre>

<p>The above assumes that <code class="literal">MyServiceImpl</code>, <code class="literal">Dependency1</code> and <code class="literal">Dependency2</code> use Spring
dependency injection annotations such as <code class="literal">@Autowired</code>.</p>
</div>
<div class="section" title="Building the container programmatically using register(Class<?&gt;&#8230;)"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-instantiating-container-register"></a>Building the container programmatically using register(Class&lt;?&gt;&#8230;)</h4></div></div></div>

<p>An <code class="literal">AnnotationConfigApplicationContext</code> may be instantiated using a no-arg constructor
and then configured using the <code class="literal">register()</code> method. This approach is particularly useful
when programmatically building an <code class="literal">AnnotationConfigApplicationContext</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    AnnotationConfigApplicationContext ctx = <span class="hl-keyword">new</span> AnnotationConfigApplicationContext();
    ctx.register(AppConfig.<span class="hl-keyword">class</span>, OtherConfig.<span class="hl-keyword">class</span>);
    ctx.register(AdditionalConfig.<span class="hl-keyword">class</span>);
    ctx.refresh();
    MyService myService = ctx.getBean(MyService.<span class="hl-keyword">class</span>);
    myService.doStuff();
}</pre>

</div>
<div class="section" title="Enabling component scanning with scan(String&#8230;)"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-instantiating-container-scan"></a>Enabling component scanning with scan(String&#8230;)</h4></div></div></div>

<p>Experienced Spring users will be familiar with the following commonly-used XML
declaration from Spring&#8217;s <code class="literal">context:</code> namespace</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"com.acme"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>In the example above, the <code class="literal">com.acme</code> package will be scanned, looking for any
<code class="literal">@Component</code>-annotated classes, and those classes will be registered as Spring bean
definitions within the container. <code class="literal">AnnotationConfigApplicationContext</code> exposes the
<code class="literal">scan(String...)</code> method to allow for the same component-scanning functionality:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    AnnotationConfigApplicationContext ctx = <span class="hl-keyword">new</span> AnnotationConfigApplicationContext();
    ctx.scan(<span class="hl-string">"com.acme"</span>);
    ctx.refresh();
    MyService myService = ctx.getBean(MyService.<span class="hl-keyword">class</span>);
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Remember that <code class="literal">@Configuration</code> classes are <a class="link" href="#beans-meta-annotations" title="4.10.2&nbsp;Meta-annotations">meta-annotated</a>
with <code class="literal">@Component</code>, so they are candidates for component-scanning! In the example above,
assuming that <code class="literal">AppConfig</code> is declared within the <code class="literal">com.acme</code> package (or any package
underneath), it will be picked up during the call to <code class="literal">scan()</code>, and upon <code class="literal">refresh()</code> all
its <code class="literal">@Bean</code> methods will be processed and registered as bean definitions within the
container.</p>
</td></tr></table></div>

</div>
<div class="section" title="Support for web applications with AnnotationConfigWebApplicationContext"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-instantiating-container-web"></a>Support for web applications with AnnotationConfigWebApplicationContext</h4></div></div></div>

<p>A <code class="literal">WebApplicationContext</code> variant of <code class="literal">AnnotationConfigApplicationContext</code> is available
with <code class="literal">AnnotationConfigWebApplicationContext</code>. This implementation may be used when
configuring the Spring <code class="literal">ContextLoaderListener</code> servlet listener, Spring MVC
<code class="literal">DispatcherServlet</code>, etc. What follows is a <code class="literal">web.xml</code> snippet that configures a typical
Spring MVC web application. Note the use of the <code class="literal">contextClass</code> context-param and
init-param:</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app&gt;</span>
    <span class="hl-comment">&lt;!-- Configure ContextLoaderListener to use AnnotationConfigWebApplicationContext
        instead of the default XmlWebApplicationContext --&gt;</span>
    <span class="hl-tag">&lt;context-param&gt;</span>
        <span class="hl-tag">&lt;param-name&gt;</span>contextClass<span class="hl-tag">&lt;/param-name&gt;</span>
        <span class="hl-tag">&lt;param-value&gt;</span>
            org.springframework.web.context.support.AnnotationConfigWebApplicationContext
        <span class="hl-tag">&lt;/param-value&gt;</span>
    <span class="hl-tag">&lt;/context-param&gt;</span>

    <span class="hl-comment">&lt;!-- Configuration locations must consist of one or more comma- or space-delimited
        fully-qualified @Configuration classes. Fully-qualified packages may also be
        specified for component-scanning --&gt;</span>
    <span class="hl-tag">&lt;context-param&gt;</span>
        <span class="hl-tag">&lt;param-name&gt;</span>contextConfigLocation<span class="hl-tag">&lt;/param-name&gt;</span>
        <span class="hl-tag">&lt;param-value&gt;</span>com.acme.AppConfig<span class="hl-tag">&lt;/param-value&gt;</span>
    <span class="hl-tag">&lt;/context-param&gt;</span>

    <span class="hl-comment">&lt;!-- Bootstrap the root application context as usual using ContextLoaderListener --&gt;</span>
    <span class="hl-tag">&lt;listener&gt;</span>
        <span class="hl-tag">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hl-tag">&lt;/listener-class&gt;</span>
    <span class="hl-tag">&lt;/listener&gt;</span>

    <span class="hl-comment">&lt;!-- Declare a Spring MVC DispatcherServlet as usual --&gt;</span>
    <span class="hl-tag">&lt;servlet&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>dispatcher<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
        <span class="hl-comment">&lt;!-- Configure DispatcherServlet to use AnnotationConfigWebApplicationContext
            instead of the default XmlWebApplicationContext --&gt;</span>
        <span class="hl-tag">&lt;init-param&gt;</span>
            <span class="hl-tag">&lt;param-name&gt;</span>contextClass<span class="hl-tag">&lt;/param-name&gt;</span>
            <span class="hl-tag">&lt;param-value&gt;</span>
                org.springframework.web.context.support.AnnotationConfigWebApplicationContext
            <span class="hl-tag">&lt;/param-value&gt;</span>
        <span class="hl-tag">&lt;/init-param&gt;</span>
        <span class="hl-comment">&lt;!-- Again, config locations must consist of one or more comma- or space-delimited
            and fully-qualified @Configuration classes --&gt;</span>
        <span class="hl-tag">&lt;init-param&gt;</span>
            <span class="hl-tag">&lt;param-name&gt;</span>contextConfigLocation<span class="hl-tag">&lt;/param-name&gt;</span>
            <span class="hl-tag">&lt;param-value&gt;</span>com.acme.web.MvcConfig<span class="hl-tag">&lt;/param-value&gt;</span>
        <span class="hl-tag">&lt;/init-param&gt;</span>
    <span class="hl-tag">&lt;/servlet&gt;</span>

    <span class="hl-comment">&lt;!-- map all requests for /app/* to the dispatcher servlet --&gt;</span>
    <span class="hl-tag">&lt;servlet-mapping&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>dispatcher<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;url-pattern&gt;</span>/app/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
    <span class="hl-tag">&lt;/servlet-mapping&gt;</span>
<span class="hl-tag">&lt;/web-app&gt;</span></pre>

</div>
</div>
<div class="section" title="4.12.3&nbsp;Using the @Bean annotation"><div class="titlepage"><div><div><h3 class="title"><a name="beans-java-bean-annotation"></a>4.12.3&nbsp;Using the @Bean annotation</h3></div></div></div>

<p><code class="literal">@Bean</code> is a method-level annotation and a direct analog of the XML <code class="literal">&lt;bean/&gt;</code> element.
The annotation supports some of the attributes offered by <code class="literal">&lt;bean/&gt;</code>, such as:
<a class="link" href="#beans-factory-lifecycle-initializingbean" title="Initialization callbacks">init-method</a>,
<a class="link" href="#beans-factory-lifecycle-disposablebean" title="Destruction callbacks">destroy-method</a>,
<a class="link" href="#beans-factory-autowire" title="4.4.5&nbsp;Autowiring collaborators">autowiring</a> and <code class="literal">name</code>.</p>
<p>You can use the <code class="literal">@Bean</code> annotation in a <code class="literal">@Configuration</code>-annotated or in a
<code class="literal">@Component</code>-annotated class.</p>
<div class="section" title="Declaring a bean"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-declaring-a-bean"></a>Declaring a bean</h4></div></div></div>

<p>To declare a bean, simply annotate a method with the <code class="literal">@Bean</code> annotation. You use this
method to register a bean definition within an <code class="literal">ApplicationContext</code> of the type
specified as the method&#8217;s return value. By default, the bean name will be the same as
the method name. The following is a simple example of a <code class="literal">@Bean</code> method declaration:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> TransferService transferService() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TransferServiceImpl();
    }

}</pre>

<p>The preceding configuration is exactly equivalent to the following Spring XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transferService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.acme.TransferServiceImpl"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Both declarations make a bean named <code class="literal">transferService</code> available in the
<code class="literal">ApplicationContext</code>, bound to an object instance of type <code class="literal">TransferServiceImpl</code>:</p>

<pre class="literallayout">transferService -&gt; com.acme.TransferServiceImpl</pre>

</div>
<div class="section" title="Receiving lifecycle callbacks"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-lifecycle-callbacks"></a>Receiving lifecycle callbacks</h4></div></div></div>

<p>Any classes defined with the <code class="literal">@Bean</code> annotation support the regular lifecycle callbacks
and can use the <code class="literal">@PostConstruct</code> and <code class="literal">@PreDestroy</code> annotations from JSR-250, see
<a class="link" href="#beans-postconstruct-and-predestroy-annotations" title="4.9.7&nbsp;@PostConstruct and @PreDestroy">JSR-250 annotations</a> for further
details.</p>
<p>The regular Spring <a class="link" href="#beans-factory-nature" title="4.6&nbsp;Customizing the nature of a bean">lifecycle</a> callbacks are fully supported as
well. If a bean implements <code class="literal">InitializingBean</code>, <code class="literal">DisposableBean</code>, or <code class="literal">Lifecycle</code>, their
respective methods are called by the container.</p>
<p>The standard set of <code class="literal">*Aware</code> interfaces such as <a class="link" href="#beans-beanfactory" title="4.17&nbsp;The BeanFactory">BeanFactoryAware</a>,
<a class="link" href="#beans-factory-aware" title="4.6.2&nbsp;ApplicationContextAware and BeanNameAware">BeanNameAware</a>,
<a class="link" href="#context-functionality-messagesource" title="4.16.1&nbsp;Internationalization using MessageSource">MessageSourceAware</a>,
<a class="link" href="#beans-factory-aware" title="4.6.2&nbsp;ApplicationContextAware and BeanNameAware">ApplicationContextAware</a>, and so on are also fully supported.</p>
<p>The <code class="literal">@Bean</code> annotation supports specifying arbitrary initialization and destruction
callback methods, much like Spring XML&#8217;s <code class="literal">init-method</code> and <code class="literal">destroy-method</code> attributes
on the <code class="literal">bean</code> element:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Foo {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() {
        <span class="hl-comment">// initialization logic</span>
    }
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Bar {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> cleanup() {
        <span class="hl-comment">// destruction logic</span>
    }
}

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean(initMethod = "init")</span></i>
    <span class="hl-keyword">public</span> Foo foo() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Foo();
    }

    <i><span class="hl-annotation" style="color: gray">@Bean(destroyMethod = "cleanup")</span></i>
    <span class="hl-keyword">public</span> Bar bar() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Bar();
    }

}</pre>

<p>Of course, in the case of <code class="literal">Foo</code> above, it would be equally as valid to call the <code class="literal">init()</code>
method directly during construction:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {
    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> Foo foo() {
        Foo foo = <span class="hl-keyword">new</span> Foo();
        foo.init();
    <span class="hl-keyword">return</span> foo;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When you work directly in Java, you can do anything you like with your objects and do
not always need to rely on the container lifecycle!</p>
</td></tr></table></div>

</div>
<div class="section" title="Specifying bean scope"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-specifying-bean-scope"></a>Specifying bean scope</h4></div></div></div>

<div class="section" title="Using the @Scope annotation"><div class="titlepage"><div><div><h5 class="title"><a name="beans-java-available-scopes"></a>Using the @Scope annotation</h5></div></div></div>

<p>You can specify that your beans defined with the <code class="literal">@Bean</code> annotation should have a
specific scope. You can use any of the standard scopes specified in the
<a class="link" href="#beans-factory-scopes" title="4.5&nbsp;Bean scopes">Bean Scopes</a> section.</p>
<p>The default scope is <code class="literal">singleton</code>, but you can override this with the <code class="literal">@Scope</code> annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyConfiguration {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="strong"><strong>@Scope("prototype")</strong></span>
    <span class="hl-keyword">public</span> Encryptor encryptor() {
        <span class="hl-comment">// ...</span>
    }

}</pre>

</div>
<div class="section" title="@Scope and scoped-proxy"><div class="titlepage"><div><div><h5 class="title"><a name="beans-java-scoped-proxy"></a>@Scope and scoped-proxy</h5></div></div></div>

<p>Spring offers a convenient way of working with scoped dependencies through
<a class="link" href="#beans-factory-scopes-other-injection" title="Scoped beans as dependencies">scoped proxies</a>. The easiest way to create such
a proxy when using the XML configuration is the <code class="literal">&lt;aop:scoped-proxy/&gt;</code> element.
Configuring your beans in Java with a @Scope annotation offers equivalent support with
the proxyMode attribute. The default is no proxy ( <code class="literal">ScopedProxyMode.NO</code>), but you can
specify <code class="literal">ScopedProxyMode.TARGET_CLASS</code> or <code class="literal">ScopedProxyMode.INTERFACES</code>.</p>
<p>If you port the scoped proxy example from the XML reference documentation (see preceding
link) to our <code class="literal">@Bean</code> using Java, it would look like the following:</p>
<pre class="programlisting"><span class="hl-comment">// an HTTP Session-scoped bean exposed as a proxy</span>
<i><span class="hl-annotation" style="color: gray">@Bean</span></i>
<span class="strong"><strong>@Scope(value = "session", proxyMode = ScopedProxyMode.TARGET_CLASS)</strong></span>
<span class="hl-keyword">public</span> UserPreferences userPreferences() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> UserPreferences();
}

<i><span class="hl-annotation" style="color: gray">@Bean</span></i>
<span class="hl-keyword">public</span> Service userService() {
    UserService service = <span class="hl-keyword">new</span> SimpleUserService();
    <span class="hl-comment">// a reference to the proxied userPreferences bean</span>
    service.setUserPreferences(userPreferences());
    <span class="hl-keyword">return</span> service;
}</pre>

</div>
</div>
<div class="section" title="Customizing bean naming"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-customizing-bean-naming"></a>Customizing bean naming</h4></div></div></div>

<p>By default, configuration classes use a <code class="literal">@Bean</code> method&#8217;s name as the name of the
resulting bean. This functionality can be overridden, however, with the <code class="literal">name</code> attribute.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean(name = "myFoo")</span></i>
    <span class="hl-keyword">public</span> Foo foo() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Foo();
    }

}</pre>

</div>
<div class="section" title="Bean aliasing"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-bean-aliasing"></a>Bean aliasing</h4></div></div></div>

<p>As discussed in <a class="xref" href="#beans-beanname" title="4.3.1&nbsp;Naming beans">Section&nbsp;4.3.1, &#8220;Naming beans&#8221;</a>, it is sometimes desirable to give a single bean
multiple names, otherwise known as<span class="emphasis"><em>bean aliasing</em></span>. The <code class="literal">name</code> attribute of the <code class="literal">@Bean</code>
annotation accepts a String array for this purpose.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean(name = { "dataSource", "subsystemA-dataSource", "subsystemB-dataSource" })</span></i>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-comment">// instantiate, configure and return DataSource bean...</span>
    }

}</pre>

</div>
<div class="section" title="Bean description"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-bean-description"></a>Bean description</h4></div></div></div>

<p>Sometimes it is helpful to provide a more detailed textual description of a bean. This can
be particularly useful when beans are exposed (perhaps via JMX) for monitoring purposes.</p>
<p>To add a description to a <code class="literal">@Bean</code> the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/Description.html" target="_top"><code class="literal">@Description</code></a>
annotation can be used:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="strong"><strong>@Desciption("Provides a basic example of a bean")</strong></span>
    <span class="hl-keyword">public</span> Foo foo() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Foo();
    }

}</pre>

</div>
</div>
<div class="section" title="4.12.4&nbsp;Using the @Configuration annotation"><div class="titlepage"><div><div><h3 class="title"><a name="beans-java-configuration-annotation"></a>4.12.4&nbsp;Using the @Configuration annotation</h3></div></div></div>

<p><code class="literal">@Configuration</code> is a class-level annotation indicating that an object is a source of
bean definitions. <code class="literal">@Configuration</code> classes declare beans via public <code class="literal">@Bean</code> annotated
methods. Calls to <code class="literal">@Bean</code> methods on <code class="literal">@Configuration</code> classes can also be used to define
inter-bean dependencies. See <a class="xref" href="#beans-java-basic-concepts" title="4.12.1&nbsp;Basic concepts: @Bean and @Configuration">Section&nbsp;4.12.1, &#8220;Basic concepts: @Bean and @Configuration&#8221;</a> for a general introduction.</p>
<div class="section" title="Injecting inter-bean dependencies"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-injecting-dependencies"></a>Injecting inter-bean dependencies</h4></div></div></div>

<p>When <code class="literal">@Bean</code> s have dependencies on one another, expressing that dependency is as simple
as having one bean method call another:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> Foo foo() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Foo(bar());
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> Bar bar() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Bar();
    }

}</pre>

<p>In the example above, the <code class="literal">foo</code> bean receives a reference to <code class="literal">bar</code> via constructor
injection.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This method of declaring inter-bean dependencies only works when the <code class="literal">@Bean</code> method is
declared within a <code class="literal">@Configuration</code> class. You cannot declare inter-bean dependencies
using plain <code class="literal">@Component</code> classes.</p>
</td></tr></table></div>

</div>
<div class="section" title="Lookup method injection"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-method-injection"></a>Lookup method injection</h4></div></div></div>

<p>As noted earlier, <a class="link" href="#beans-factory-method-injection" title="4.4.6&nbsp;Method injection">lookup method injection</a> is an
advanced feature that you should use rarely. It is useful in cases where a
singleton-scoped bean has a dependency on a prototype-scoped bean. Using Java for this
type of configuration provides a natural means for implementing this pattern.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> CommandManager {
    <span class="hl-keyword">public</span> Object process(Object commandState) {
        <span class="hl-comment">// grab a new instance of the appropriate Command interface</span>
        Command command = createCommand();

        <span class="hl-comment">// set the state on the (hopefully brand new) Command instance</span>
        command.setState(commandState);
    <span class="hl-keyword">return</span> command.execute();
    }

    <span class="hl-comment">// okay... but where is the implementation of this method?</span>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Command createCommand();
}</pre>

<p>Using Java-configuration support , you can create a subclass of <code class="literal">CommandManager</code> where
the abstract <code class="literal">createCommand()</code> method is overridden in such a way that it looks up a new
(prototype) command object:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Bean</span></i>
<i><span class="hl-annotation" style="color: gray">@Scope("prototype")</span></i>
<span class="hl-keyword">public</span> AsyncCommand asyncCommand() {
    AsyncCommand command = <span class="hl-keyword">new</span> AsyncCommand();
    <span class="hl-comment">// inject dependencies here as required</span>
    <span class="hl-keyword">return</span> command;
}

<i><span class="hl-annotation" style="color: gray">@Bean</span></i>
<span class="hl-keyword">public</span> CommandManager commandManager() {
    <span class="hl-comment">// return new anonymous implementation of CommandManager with command() overridden</span>
    <span class="hl-comment">// to return a new prototype Command object</span>
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CommandManager() {
        <span class="hl-keyword">protected</span> Command createCommand() {
            <span class="hl-keyword">return</span> asyncCommand();
        }
    }
}</pre>

</div>
<div class="section" title="Further information about how Java-based configuration works internally"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-further-information-java-config"></a>Further information about how Java-based configuration works internally</h4></div></div></div>

<p>The following example shows a <code class="literal">@Bean</code> annotated method being called twice:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> ClientService clientService1() {
        ClientServiceImpl clientService = <span class="hl-keyword">new</span> ClientServiceImpl();
        clientService.setClientDao(clientDao());
        <span class="hl-keyword">return</span> clientService;
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> ClientService clientService2() {
        ClientServiceImpl clientService = <span class="hl-keyword">new</span> ClientServiceImpl();
        clientService.setClientDao(clientDao());
        <span class="hl-keyword">return</span> clientService;
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> ClientDao clientDao() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ClientDaoImpl();
    }

}</pre>

<p><code class="literal">clientDao()</code> has been called once in <code class="literal">clientService1()</code> and once in <code class="literal">clientService2()</code>.
Since this method creates a new instance of <code class="literal">ClientDaoImpl</code> and returns it, you would
normally expect having 2 instances (one for each service). That definitely would be
problematic: in Spring, instantiated beans have a <code class="literal">singleton</code> scope by default. This is
where the magic comes in: All <code class="literal">@Configuration</code> classes are subclassed at startup-time
with <code class="literal">CGLIB</code>. In the subclass, the child method checks the container first for any
cached (scoped) beans before it calls the parent method and creates a new instance. Note
that as of Spring 3.2, it is no longer necessary to add CGLIB to your classpath because
CGLIB classes have been repackaged under org.springframework and included directly
within the spring-core JAR.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The behavior could be different according to the scope of your bean. We are talking
about singletons here.</p>
</td></tr></table></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>There are a few restrictions due to the fact that CGLIB dynamically adds features at
startup-time:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Configuration classes should not be final
</li><li class="listitem">
They should have a constructor with no arguments
</li></ul></div>

</td></tr></table></div>

</div>
</div>
<div class="section" title="4.12.5&nbsp;Composing Java-based configurations"><div class="titlepage"><div><div><h3 class="title"><a name="beans-java-composing-configuration-classes"></a>4.12.5&nbsp;Composing Java-based configurations</h3></div></div></div>

<div class="section" title="Using the @Import annotation"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-using-import"></a>Using the @Import annotation</h4></div></div></div>

<p>Much as the <code class="literal">&lt;import/&gt;</code> element is used within Spring XML files to aid in modularizing
configurations, the <code class="literal">@Import</code> annotation allows for loading <code class="literal">@Bean</code> definitions from
another configuration class:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ConfigA {

     <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> A a() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> A();
    }

}

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@Import(ConfigA.class)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ConfigB {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> B b() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> B();
    }

}</pre>

<p>Now, rather than needing to specify both <code class="literal">ConfigA.class</code> and <code class="literal">ConfigB.class</code> when
instantiating the context, only <code class="literal">ConfigB</code> needs to be supplied explicitly:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    ApplicationContext ctx = <span class="hl-keyword">new</span> AnnotationConfigApplicationContext(ConfigB.<span class="hl-keyword">class</span>);

    <span class="hl-comment">// now both beans A and B will be available...</span>
    A a = ctx.getBean(A.<span class="hl-keyword">class</span>);
    B b = ctx.getBean(B.<span class="hl-keyword">class</span>);
}</pre>

<p>This approach simplifies container instantiation, as only one class needs to be dealt
with, rather than requiring the developer to remember a potentially large number of
<code class="literal">@Configuration</code> classes during construction.</p>
<div class="section" title="Injecting dependencies on imported @Bean definitions"><div class="titlepage"><div><div><h5 class="title"><a name="beans-java-injecting-imported-beans"></a>Injecting dependencies on imported @Bean definitions</h5></div></div></div>

<p>The example above works, but is simplistic. In most practical scenarios, beans will have
dependencies on one another across configuration classes. When using XML, this is not an
issue, per se, because there is no compiler involved, and one can simply declare
<code class="literal">ref="someBean"</code> and trust that Spring will work it out during container initialization.
Of course, when using <code class="literal">@Configuration</code> classes, the Java compiler places constraints on
the configuration model, in that references to other beans must be valid Java syntax.</p>
<p>Fortunately, solving this problem is simple. Remember that <code class="literal">@Configuration</code> classes are
ultimately just another bean in the container - this means that they can take advantage
of <code class="literal">@Autowired</code> injection metadata just like any other bean!</p>
<p>Let&#8217;s consider a more real-world scenario with several <code class="literal">@Configuration</code> classes, each
depending on beans declared in the others:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ServiceConfig {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> AccountRepository accountRepository;

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> TransferService transferService() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TransferServiceImpl(accountRepository);
    }

}

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RepositoryConfig {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> DataSource dataSource;

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> AccountRepository accountRepository() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcAccountRepository(dataSource);
    }

}

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@Import({ServiceConfig.class, RepositoryConfig.class})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SystemTestConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-comment">// return new DataSource</span>
    }

}

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    ApplicationContext ctx = <span class="hl-keyword">new</span> AnnotationConfigApplicationContext(SystemTestConfig.<span class="hl-keyword">class</span>);
    <span class="hl-comment">// everything wires up across configuration classes...</span>
    TransferService transferService = ctx.getBean(TransferService.<span class="hl-keyword">class</span>);
    transferService.transfer(<span class="hl-number">100.00</span>, <span class="hl-string">"A123"</span>, <span class="hl-string">"C456"</span>);
}</pre>

<p>In the scenario above, using <code class="literal">@Autowired</code> works well and provides the desired
modularity, but determining exactly where the autowired bean definitions are declared is
still somewhat ambiguous. For example, as a developer looking at <code class="literal">ServiceConfig</code>, how do
you know exactly where the <code class="literal">@Autowired AccountRepository</code> bean is declared? It&#8217;s not
explicit in the code, and this may be just fine. Remember that the
<a class="ulink" href="http://www.springsource.com/products/sts" target="_top">SpringSource Tool Suite</a> provides tooling that
can render graphs showing how everything is wired up - that may be all you need. Also,
your Java IDE can easily find all declarations and uses of the <code class="literal">AccountRepository</code> type,
and will quickly show you the location of <code class="literal">@Bean</code> methods that return that type.</p>
<p>In cases where this ambiguity is not acceptable and you wish to have direct navigation
from within your IDE from one <code class="literal">@Configuration</code> class to another, consider autowiring the
configuration classes themselves:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ServiceConfig {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> RepositoryConfig repositoryConfig;

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> TransferService transferService() {
        <span class="hl-comment">// navigate </span><span class="emphasis"><em>through</em></span> the config <span class="hl-keyword">class</span> to the <i><span class="hl-annotation" style="color: gray">@Bean</span></i> method!
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TransferServiceImpl(repositoryConfig.accountRepository());
    }

}</pre>

<p>In the situation above, it is completely explicit where <code class="literal">AccountRepository</code> is defined.
However, <code class="literal">ServiceConfig</code> is now tightly coupled to <code class="literal">RepositoryConfig</code>; that&#8217;s the
tradeoff. This tight coupling can be somewhat mitigated by using interface-based or
abstract class-based <code class="literal">@Configuration</code> classes. Consider the following:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ServiceConfig {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> RepositoryConfig repositoryConfig;

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> TransferService transferService() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TransferServiceImpl(repositoryConfig.accountRepository());
    }
}

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RepositoryConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    AccountRepository accountRepository();

}

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultRepositoryConfig <span class="hl-keyword">implements</span> RepositoryConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> AccountRepository accountRepository() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcAccountRepository(...);
    }

}

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@Import({ServiceConfig.class, DefaultRepositoryConfig.class})</span></i> <span class="hl-comment">// import the concrete config!</span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SystemTestConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-comment">// return DataSource</span>
    }

}

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    ApplicationContext ctx = <span class="hl-keyword">new</span> AnnotationConfigApplicationContext(SystemTestConfig.<span class="hl-keyword">class</span>);
    TransferService transferService = ctx.getBean(TransferService.<span class="hl-keyword">class</span>);
    transferService.transfer(<span class="hl-number">100.00</span>, <span class="hl-string">"A123"</span>, <span class="hl-string">"C456"</span>);
}</pre>

<p>Now <code class="literal">ServiceConfig</code> is loosely coupled with respect to the concrete
<code class="literal">DefaultRepositoryConfig</code>, and built-in IDE tooling is still useful: it will be easy for
the developer to get a type hierarchy of <code class="literal">RepositoryConfig</code> implementations. In this
way, navigating <code class="literal">@Configuration</code> classes and their dependencies becomes no different
than the usual process of navigating interface-based code.</p>
</div>
</div>
<div class="section" title="Conditionally including @Configuration classes or @Beans"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-conditional"></a>Conditionally including @Configuration classes or @Beans</h4></div></div></div>

<p>It is often useful to conditionally enable to disable a complete <code class="literal">@Configuration</code> class,
or even individual <code class="literal">@Bean</code> methods, based on some arbitrary system state. One common
example of this it to use the <code class="literal">@Profile</code> annotation to active beans only when a specific
profile has been enabled in the Spring <code class="literal">Environment</code> (see <a class="xref" href="#beans-definition-profiles" title="4.13&nbsp;Bean definition profiles and environment abstraction">Section&nbsp;4.13, &#8220;Bean definition profiles and environment abstraction&#8221;</a>
for details).</p>
<p>The <code class="literal">@Profile</code> annotation is actually implemented using a much more flexible annotation
called <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/Conditional.html" target="_top"><code class="literal">@Conditional</code></a>.
The <code class="literal">@Conditional</code> annotation indicates specific
<code class="literal">org.springframework.context.annotation.Condition</code> implementations that should be
consulted before a <code class="literal">@Bean</code> is registered.</p>
<p>Implementations of the <code class="literal">Condition</code> interface simply provide a <code class="literal">matches(...)</code>
method that returns <code class="literal">true</code> or <code class="literal">false</code>. For example, here is the actual
<code class="literal">Condition</code> implementation used for <code class="literal">@Profile</code>:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Override</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
    <span class="hl-keyword">if</span> (context.getEnvironment() != null) {
        <span class="hl-comment">// Read the @Profile annotation attributes</span>
        MultiValueMap&lt;String, Object&gt; attrs = metadata.getAllAnnotationAttributes(Profile.<span class="hl-keyword">class</span>.getName());
        <span class="hl-keyword">if</span> (attrs != null) {
            <span class="hl-keyword">for</span> (Object value : attrs.get(<span class="hl-string">"value"</span>)) {
                <span class="hl-keyword">if</span> (context.getEnvironment().acceptsProfiles(((String[]) value))) {
                    <span class="hl-keyword">return</span> true;
                }
            }
            <span class="hl-keyword">return</span> false;
        }
    }
    <span class="hl-keyword">return</span> true;
}</pre>

<p>See the <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/Conditional.html" target="_top">
<code class="literal">@Conditional</code> Javadoc</a> for more detail.</p>
</div>
<div class="section" title="Combining Java and XML configuration"><div class="titlepage"><div><div><h4 class="title"><a name="beans-java-combining"></a>Combining Java and XML configuration</h4></div></div></div>

<p>Spring&#8217;s <code class="literal">@Configuration</code> class support does not aim to be a 100% complete replacement
for Spring XML. Some facilities such as Spring XML namespaces remain an ideal way to
configure the container. In cases where XML is convenient or necessary, you have a
choice: either instantiate the container in an "XML-centric" way using, for example,
<code class="literal">ClassPathXmlApplicationContext</code>, or in a "Java-centric" fashion using
<code class="literal">AnnotationConfigApplicationContext</code> and the <code class="literal">@ImportResource</code> annotation to import XML
as needed.</p>
<div class="section" title="XML-centric use of @Configuration classes"><div class="titlepage"><div><div><h5 class="title"><a name="beans-java-combining-xml-centric"></a>XML-centric use of @Configuration classes</h5></div></div></div>

<p>It may be preferable to bootstrap the Spring container from XML and include
<code class="literal">@Configuration</code> classes in an ad-hoc fashion. For example, in a large existing codebase
that uses Spring XML, it will be easier to create <code class="literal">@Configuration</code> classes on an
as-needed basis and include them from the existing XML files. Below you&#8217;ll find the
options for using <code class="literal">@Configuration</code> classes in this kind of "XML-centric" situation.</p>
<p>Remember that <code class="literal">@Configuration</code> classes are ultimately just bean definitions in the
container. In this example, we create a <code class="literal">@Configuration</code> class named <code class="literal">AppConfig</code> and
include it within <code class="literal">system-test-config.xml</code> as a <code class="literal">&lt;bean/&gt;</code> definition. Because
<code class="literal">&lt;context:annotation-config/&gt;</code> is switched on, the container will recognize the
<code class="literal">@Configuration</code> annotation, and process the <code class="literal">@Bean</code> methods declared in <code class="literal">AppConfig</code>
properly.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> DataSource dataSource;

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> AccountRepository accountRepository() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcAccountRepository(dataSource);
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> TransferService transferService() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TransferService(accountRepository());
    }

}</pre>

<pre class="programlisting">system-test-config.xml
<span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-comment">&lt;!-- enable processing of annotations such as @Autowired and @Configuration --&gt;</span>
    <span class="hl-tag">&lt;context:annotation-config/&gt;</span>
    <span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:/com/acme/jdbc.properties"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.acme.AppConfig"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.url}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.username}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.password}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>


<pre class="literallayout">jdbc.properties
jdbc.url=jdbc:hsqldb:hsql://localhost/xdb
jdbc.username=sa
jdbc.password=</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"classpath:/com/acme/system-test-config.xml"</span>);
    TransferService transferService = ctx.getBean(TransferService.<span class="hl-keyword">class</span>);
    <span class="hl-comment">// ...</span>
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In <code class="literal">system-test-config.xml</code> above, the <code class="literal">AppConfig&lt;bean/&gt;</code> does not declare an <code class="literal">id</code>
element. While it would be acceptable to do so, it is unnecessary given that no other
bean will ever refer to it, and it is unlikely that it will be explicitly fetched from
the container by name. Likewise with the <code class="literal">DataSource</code> bean - it is only ever autowired
by type, so an explicit bean id is not strictly required.</p>
</td></tr></table></div>

<p>Because <code class="literal">@Configuration</code> is meta-annotated with <code class="literal">@Component</code>, <code class="literal">@Configuration</code>-annotated
classes are automatically candidates for component scanning. Using the same scenario as
above, we can redefine <code class="literal">system-test-config.xml</code> to take advantage of component-scanning.
Note that in this case, we don&#8217;t need to explicitly declare
<code class="literal">&lt;context:annotation-config/&gt;</code>, because <code class="literal">&lt;context:component-scan/&gt;</code> enables all the same
functionality.</p>
<pre class="programlisting">system-test-config.xml
<span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-comment">&lt;!-- picks up and registers AppConfig as a bean definition --&gt;</span>
    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"com.acme"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:/com/acme/jdbc.properties"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.url}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.username}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.password}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="@Configuration class-centric use of XML with @ImportResource"><div class="titlepage"><div><div><h5 class="title"><a name="beans-java-combining-java-centric"></a>@Configuration class-centric use of XML with @ImportResource</h5></div></div></div>

<p>In applications where <code class="literal">@Configuration</code> classes are the primary mechanism for configuring
the container, it will still likely be necessary to use at least some XML. In these
scenarios, simply use <code class="literal">@ImportResource</code> and define only as much XML as is needed. Doing
so achieves a "Java-centric" approach to configuring the container and keeps XML to a
bare minimum.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@ImportResource("classpath:/com/acme/properties-config.xml")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Value("${jdbc.url}")</span></i>
    <span class="hl-keyword">private</span> String url;

    <i><span class="hl-annotation" style="color: gray">@Value("${jdbc.username}")</span></i>
    <span class="hl-keyword">private</span> String username;

    <i><span class="hl-annotation" style="color: gray">@Value("${jdbc.password}")</span></i>
    <span class="hl-keyword">private</span> String password;

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DriverManagerDataSource(url, username, password);
    }

}</pre>

<pre class="programlisting">properties-config.xml
<span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:/com/acme/jdbc.properties"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>


<pre class="literallayout">jdbc.properties
jdbc.url=jdbc:hsqldb:hsql://localhost/xdb
jdbc.username=sa
jdbc.password=</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    ApplicationContext ctx = <span class="hl-keyword">new</span> AnnotationConfigApplicationContext(AppConfig.<span class="hl-keyword">class</span>);
    TransferService transferService = ctx.getBean(TransferService.<span class="hl-keyword">class</span>);
    <span class="hl-comment">// ...</span>
}</pre>

</div>
</div>
</div>
</div>
<div class="section" title="4.13&nbsp;Bean definition profiles and environment abstraction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-definition-profiles"></a>4.13&nbsp;Bean definition profiles and environment abstraction</h2></div></div></div>

<p>Bean definition profiles is a mechanism in the core container that allows for registration
of different beans in different environments. This feature can help with many use cases,
including:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
working against an in-memory datasource in development vs looking up that same
datasource from JNDI when in QA or production
</li><li class="listitem">
registering monitoring infrastructure only when deploying an application into a
performance environment
</li><li class="listitem">
registering customized implementations of beans for customer A vs. customer B deployments
</li></ul></div>

<p>Find out more about <a class="ulink" href="http://spring.io/blog/2011/02/11/spring-framework-3-1-m1-released/" target="_top">Environment,
XML Profiles</a> and the
<a class="ulink" href="http://spring.io/blog/2011/02/14/spring-3-1-m1-introducing-profile/" target="_top">@Profile annotation</a>.</p>
</div>
<div class="section" title="4.14&nbsp;PropertySource Abstraction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-property-source-abstraction"></a>4.14&nbsp;PropertySource Abstraction</h2></div></div></div>

<p>Spring&#8217;s <a class="link" href="#beans-definition-profiles" title="4.13&nbsp;Bean definition profiles and environment abstraction">Environment abstraction</a> provides search operations
over a configurable hierarchy of property sources.</p>
<p>You can find out more about
<a class="ulink" href="http://spring.io/blog/2011/02/15/spring-3-1-m1-unified-property-management/" target="_top">Unified
Property Management</a>, the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/env/PropertySource.html" target="_top"><code class="literal">PropertySource</code> class</a>
and the <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-apiorg/springframework/context/annotation/PropertySource.html" target="_top"><code class="literal">@PropertySource</code>
annotation</a>.</p>
</div>
<div class="section" title="4.15&nbsp;Registering a LoadTimeWeaver"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="context-load-time-weaver"></a>4.15&nbsp;Registering a LoadTimeWeaver</h2></div></div></div>

<p>The <code class="literal">LoadTimeWeaver</code> is used by Spring to dynamically transform classes as they are
loaded into the Java virtual machine (JVM).</p>
<p>To enable load-time weaving add the <code class="literal">@EnableLoadTimeWeaving</code> to one of your
<code class="literal">@Configuration</code> classes:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableLoadTimeWeaving</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

}</pre>

<p>Alternatively for XML configuration use the <code class="literal">context:load-time-weaver</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;context:load-time-weaver/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Once configured for the <code class="literal">ApplicationContext</code>. Any bean within that <code class="literal">ApplicationContext</code>
may implement <code class="literal">LoadTimeWeaverAware</code>, thereby receiving a reference to the load-time
weaver instance. This is particularly useful in combination with <a class="link" href="#orm-jpa" title="14.5&nbsp;JPA">Spring&#8217;s JPA
support</a> where load-time weaving may be necessary for JPA class transformation. Consult
the <code class="literal">LocalContainerEntityManagerFactoryBean</code> Javadoc for more detail. For more on
AspectJ load-time weaving, see <a class="xref" href="#aop-aj-ltw" title="8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework">Section&nbsp;8.8.4, &#8220;Load-time weaving with AspectJ in the Spring Framework&#8221;</a>.</p>
</div>
<div class="section" title="4.16&nbsp;Additional Capabilities of the ApplicationContext"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="context-introduction"></a>4.16&nbsp;Additional Capabilities of the ApplicationContext</h2></div></div></div>

<p>As was discussed in the chapter introduction, the <code class="literal">org.springframework.beans.factory</code>
package provides basic functionality for managing and manipulating beans, including in a
programmatic way. The <code class="literal">org.springframework.context</code> package adds the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/ApplicationContext.html" target="_top"><code class="literal">ApplicationContext</code></a>
interface, which extends the <code class="literal">BeanFactory</code> interface, in addition to extending other
interfaces to provide additional functionality in a more <span class="emphasis"><em>application
framework-oriented style</em></span>. Many people use the <code class="literal">ApplicationContext</code> in a completely
declarative fashion, not even creating it programmatically, but instead relying on
support classes such as <code class="literal">ContextLoader</code> to automatically instantiate an
<code class="literal">ApplicationContext</code> as part of the normal startup process of a J2EE web application.</p>
<p>To enhance <code class="literal">BeanFactory</code> functionality in a more framework-oriented style the context
package also provides the following functionality:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>Access to messages in i18n-style</em></span>, through the <code class="literal">MessageSource</code> interface.
</li><li class="listitem">
<span class="emphasis"><em>Access to resources</em></span>, such as URLs and files, through the <code class="literal">ResourceLoader</code> interface.
</li><li class="listitem">
<span class="emphasis"><em>Event publication</em></span> to beans implementing the <code class="literal">ApplicationListener</code> interface,
through the use of the <code class="literal">ApplicationEventPublisher</code> interface.
</li><li class="listitem">
<span class="emphasis"><em>Loading of multiple (hierarchical) contexts</em></span>, allowing each to be focused on one
particular layer, such as the web layer of an application, through the
<code class="literal">HierarchicalBeanFactory</code> interface.
</li></ul></div>

<div class="section" title="4.16.1&nbsp;Internationalization using MessageSource"><div class="titlepage"><div><div><h3 class="title"><a name="context-functionality-messagesource"></a>4.16.1&nbsp;Internationalization using MessageSource</h3></div></div></div>

<p>The <code class="literal">ApplicationContext</code> interface extends an interface called <code class="literal">MessageSource</code>, and
therefore provides internationalization (i18n) functionality. Spring also provides the
interface <code class="literal">HierarchicalMessageSource</code>, which can resolve messages hierarchically.
Together these interfaces provide the foundation upon which Spring effects message
resolution. The methods defined on these interfaces include:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">String getMessage(String code, Object[] args, String default, Locale loc)</code>: The basic
method used to retrieve a message from the <code class="literal">MessageSource</code>. When no message is found
for the specified locale, the default message is used. Any arguments passed in become
replacement values, using the <code class="literal">MessageFormat</code> functionality provided by the standard
library.
</li><li class="listitem">
<code class="literal">String getMessage(String code, Object[] args, Locale loc)</code>: Essentially the same as
the previous method, but with one difference: no default message can be specified; if
the message cannot be found, a <code class="literal">NoSuchMessageException</code> is thrown.
</li><li class="listitem">
<code class="literal">String getMessage(MessageSourceResolvable resolvable, Locale locale)</code>: All properties
used in the preceding methods are also wrapped in a class named
<code class="literal">MessageSourceResolvable</code>, which you can use with this method.
</li></ul></div>

<p>When an <code class="literal">ApplicationContext</code> is loaded, it automatically searches for a <code class="literal">MessageSource</code>
bean defined in the context. The bean must have the name <code class="literal">messageSource</code>. If such a bean
is found, all calls to the preceding methods are delegated to the message source. If no
message source is found, the <code class="literal">ApplicationContext</code> attempts to find a parent containing a
bean with the same name. If it does, it uses that bean as the <code class="literal">MessageSource</code>. If the
<code class="literal">ApplicationContext</code> cannot find any source for messages, an empty
<code class="literal">DelegatingMessageSource</code> is instantiated in order to be able to accept calls to the
methods defined above.</p>
<p>Spring provides two <code class="literal">MessageSource</code> implementations, <code class="literal">ResourceBundleMessageSource</code> and
<code class="literal">StaticMessageSource</code>. Both implement <code class="literal">HierarchicalMessageSource</code> in order to do nested
messaging. The <code class="literal">StaticMessageSource</code> is rarely used but provides programmatic ways to
add messages to the source. The <code class="literal">ResourceBundleMessageSource</code> is shown in the following
example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageSource"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.context.support.ResourceBundleMessageSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basenames"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>format<span class="hl-tag">&lt;/value&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>exceptions<span class="hl-tag">&lt;/value&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>windows<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>In the example it is assumed you have three resource bundles defined in your classpath
called <code class="literal">format</code>, <code class="literal">exceptions</code> and <code class="literal">windows</code>. Any request to resolve a message will be
handled in the JDK standard way of resolving messages through ResourceBundles. For the
purposes of the example, assume the contents of two of the above resource bundle files
are&#8230;</p>
<pre class="programlisting"># in format.properties
message=Alligators rock!</pre>

<pre class="programlisting"># in exceptions.properties
argument.required=The <span class="emphasis"><em>{0}</em></span> argument is required.</pre>

<p>A program to execute the <code class="literal">MessageSource</code> functionality is shown in the next example.
Remember that all <code class="literal">ApplicationContext</code> implementations are also <code class="literal">MessageSource</code>
implementations and so can be cast to the <code class="literal">MessageSource</code> interface.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    MessageSource resources = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"beans.xml"</span>);
    String message = resources.getMessage(<span class="hl-string">"message"</span>, null, <span class="hl-string">"Default"</span>, null);
    System.out.println(message);
}</pre>

<p>The resulting output from the above program will be&#8230;</p>

<pre class="literallayout">Alligators rock!</pre>

<p>So to summarize, the <code class="literal">MessageSource</code> is defined in a file called <code class="literal">beans.xml</code>, which
exists at the root of your classpath. The <code class="literal">messageSource</code> bean definition refers to a
number of resource bundles through its <code class="literal">basenames</code> property. The three files that are
passed in the list to the <code class="literal">basenames</code> property exist as files at the root of your
classpath and are called <code class="literal">format.properties</code>, <code class="literal">exceptions.properties</code>, and
<code class="literal">windows.properties</code> respectively.</p>
<p>The next example shows arguments passed to the message lookup; these arguments will be
converted into Strings and inserted into placeholders in the lookup message.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-comment">&lt;!-- this MessageSource is being used in a web application --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.context.support.ResourceBundleMessageSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"exceptions"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- lets inject the above MessageSource into this POJO --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"example"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.Example"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messages"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Example {

    <span class="hl-keyword">private</span> MessageSource messages;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMessages(MessageSource messages) {
        <span class="hl-keyword">this</span>.messages = messages;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> execute() {
        String message = <span class="hl-keyword">this</span>.messages.getMessage(<span class="hl-string">"argument.required"</span>,
            <span class="hl-keyword">new</span> Object [] {<span class="hl-string">"userDao"</span>}, <span class="hl-string">"Required"</span>, null);
        System.out.println(message);
    }

}</pre>

<p>The resulting output from the invocation of the <code class="literal">execute()</code> method will be&#8230;</p>

<pre class="literallayout">The userDao argument is required.</pre>

<p>With regard to internationalization (i18n), Spring&#8217;s various <code class="literal">MessageResource</code>
implementations follow the same locale resolution and fallback rules as the standard JDK
<code class="literal">ResourceBundle</code>. In short, and continuing with the example <code class="literal">messageSource</code> defined
previously, if you want to resolve messages against the British (<code class="literal">en-GB</code>) locale, you
would create files called <code class="literal">format_en_GB.properties</code>, <code class="literal">exceptions_en_GB.properties</code>, and
<code class="literal">windows_en_GB.properties</code> respectively.</p>
<p>Typically, locale resolution is managed by the surrounding environment of the
application. In this example, the locale against which (British) messages will be
resolved is specified manually.</p>

<pre class="literallayout"># in exceptions_en_GB.properties
argument.required=Ebagum lad, the <span class="emphasis"><em>{0}</em></span> argument is required, I say, required.</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(<span class="hl-keyword">final</span> String[] args) {
    MessageSource resources = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"beans.xml"</span>);
    String message = resources.getMessage(<span class="hl-string">"argument.required"</span>,
        <span class="hl-keyword">new</span> Object [] {<span class="hl-string">"userDao"</span>}, <span class="hl-string">"Required"</span>, Locale.UK);
    System.out.println(message);
}</pre>

<p>The resulting output from the running of the above program will be&#8230;</p>

<pre class="literallayout">Ebagum lad, the <span class="emphasis"><em>userDao</em></span> argument is required, I say, required.</pre>

<p>You can also use the <code class="literal">MessageSourceAware</code> interface to acquire a reference to any
<code class="literal">MessageSource</code> that has been defined. Any bean that is defined in an
<code class="literal">ApplicationContext</code> that implements the <code class="literal">MessageSourceAware</code> interface is injected with
the application context&#8217;s <code class="literal">MessageSource</code> when the bean is created and configured.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>As an alternative to <code class="literal">ResourceBundleMessageSource</code>, Spring provides a
<code class="literal">ReloadableResourceBundleMessageSource</code> class. This variant supports the same bundle
file format but is more flexible than the standard JDK based
<code class="literal">ResourceBundleMessageSource</code> implementation.</em></span> In particular, it allows for reading
files from any Spring resource location (not just from the classpath) and supports hot
reloading of bundle property files (while efficiently caching them in between). Check
out the <code class="literal">ReloadableResourceBundleMessageSource</code> javadoc for details.</p>
</td></tr></table></div>

</div>
<div class="section" title="4.16.2&nbsp;Standard and Custom Events"><div class="titlepage"><div><div><h3 class="title"><a name="context-functionality-events"></a>4.16.2&nbsp;Standard and Custom Events</h3></div></div></div>

<p>Event handling in the <code class="literal">ApplicationContext</code> is provided through the <code class="literal">ApplicationEvent</code>
class and <code class="literal">ApplicationListener</code> interface. If a bean that implements the
<code class="literal">ApplicationListener</code> interface is deployed into the context, every time an
<code class="literal">ApplicationEvent</code> gets published to the <code class="literal">ApplicationContext</code>, that bean is notified.
Essentially, this is the standard <span class="emphasis"><em>Observer</em></span> design pattern. Spring provides the
following standard events:</p>
<div class="table"><a name="beans-ctx-events-tbl"></a><p class="title"><b>Table&nbsp;4.7.&nbsp;Built-in Events</b></p><div class="table-contents">

  <table summary="Built-in Events" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Event</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ContextRefreshedEvent</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Published when the <code class="literal">ApplicationContext</code> is initialized or refreshed, for example,
  using the <code class="literal">refresh()</code> method on the <code class="literal">ConfigurableApplicationContext</code> interface.
  "Initialized" here means that all beans are loaded, post-processor beans are detected
  and activated, singletons are pre-instantiated, and the <code class="literal">ApplicationContext</code> object is
  ready for use. As long as the context has not been closed, a refresh can be triggered
  multiple times, provided that the chosen <code class="literal">ApplicationContext</code> actually supports such
  "hot" refreshes. For example, <code class="literal">XmlWebApplicationContext</code> supports hot refreshes, but
  <code class="literal">GenericApplicationContext</code> does not.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ContextStartedEvent</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Published when the <code class="literal">ApplicationContext</code> is started, using the <code class="literal">start()</code> method on the
  <code class="literal">ConfigurableApplicationContext</code> interface. "Started" here means that all <code class="literal">Lifecycle</code>
  beans receive an explicit start signal. Typically this signal is used to restart beans
  after an explicit stop, but it may also be used to start components that have not been
  configured for autostart , for example, components that have not already started on
  initialization.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ContextStoppedEvent</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Published when the <code class="literal">ApplicationContext</code> is stopped, using the <code class="literal">stop()</code> method on the
  <code class="literal">ConfigurableApplicationContext</code> interface. "Stopped" here means that all <code class="literal">Lifecycle</code>
  beans receive an explicit stop signal. A stopped context may be restarted through a
  <code class="literal">start()</code> call.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ContextClosedEvent</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Published when the <code class="literal">ApplicationContext</code> is closed, using the <code class="literal">close()</code> method on the
  <code class="literal">ConfigurableApplicationContext</code> interface. "Closed" here means that all singleton
  beans are destroyed. A closed context reaches its end of life; it cannot be refreshed
  or restarted.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">RequestHandledEvent</code></p></td><td style="" align="left" valign="top"><p>A web-specific event telling all beans that an HTTP request has been serviced. This
  event is published <span class="emphasis"><em>after</em></span> the request is complete. This event is only applicable to
  web applications using Spring&#8217;s <code class="literal">DispatcherServlet</code>.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>You can also create and publish your own custom events. This example demonstrates a
simple class that extends Spring&#8217;s <code class="literal">ApplicationEvent</code> base class:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BlackListEvent <span class="hl-keyword">extends</span> ApplicationEvent {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> String address;
    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> String test;

    <span class="hl-keyword">public</span> BlackListEvent(Object source, String address, String test) {
        <span class="hl-keyword">super</span>(source);
        <span class="hl-keyword">this</span>.address = address;
        <span class="hl-keyword">this</span>.test = test;
    }

    <span class="hl-comment">// accessor and other methods...</span>

}</pre>

<p>To publish a custom <code class="literal">ApplicationEvent</code>, call the <code class="literal">publishEvent()</code> method on an
<code class="literal">ApplicationEventPublisher</code>. Typically this is done by creating a class that implements
<code class="literal">ApplicationEventPublisherAware</code> and registering it as a Spring bean. The following
example demonstrates such a class:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> EmailService <span class="hl-keyword">implements</span> ApplicationEventPublisherAware {

    <span class="hl-keyword">private</span> List&lt;String&gt; blackList;
    <span class="hl-keyword">private</span> ApplicationEventPublisher publisher;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setBlackList(List&lt;String&gt; blackList) {
        <span class="hl-keyword">this</span>.blackList = blackList;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setApplicationEventPublisher(ApplicationEventPublisher publisher) {
        <span class="hl-keyword">this</span>.publisher = publisher;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> sendEmail(String address, String text) {
        <span class="hl-keyword">if</span> (blackList.contains(address)) {
            BlackListEvent event = <span class="hl-keyword">new</span> BlackListEvent(<span class="hl-keyword">this</span>, address, text);
            publisher.publishEvent(event);
            <span class="hl-keyword">return</span>;
        }
        <span class="hl-comment">// send email...</span>
    }

}</pre>

<p>At configuration time, the Spring container will detect that <code class="literal">EmailService</code> implements
<code class="literal">ApplicationEventPublisherAware</code> and will automatically call
<code class="literal">setApplicationEventPublisher()</code>. In reality, the parameter passed in will be the Spring
container itself; you&#8217;re simply interacting with the application context via its
<code class="literal">ApplicationEventPublisher</code> interface.</p>
<p>To receive the custom <code class="literal">ApplicationEvent</code>, create a class that implements
<code class="literal">ApplicationListener</code> and register it as a Spring bean. The following example
demonstrates such a class:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BlackListNotifier <span class="hl-keyword">implements</span> ApplicationListener&lt;BlackListEvent&gt; {

    <span class="hl-keyword">private</span> String notificationAddress;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setNotificationAddress(String notificationAddress) {
        <span class="hl-keyword">this</span>.notificationAddress = notificationAddress;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onApplicationEvent(BlackListEvent event) {
        <span class="hl-comment">// notify appropriate parties via notificationAddress...</span>
    }

}</pre>

<p>Notice that <code class="literal">ApplicationListener</code> is generically parameterized with the type of your
custom event, <code class="literal">BlackListEvent</code>. This means that the <code class="literal">onApplicationEvent()</code> method can
remain type-safe, avoiding any need for downcasting. You may register as many event
listeners as you wish, but note that by default event listeners receive events
synchronously. This means the <code class="literal">publishEvent()</code> method blocks until all listeners have
finished processing the event. One advantage of this synchronous and single-threaded
approach is that when a listener receives an event, it operates inside the transaction
context of the publisher if a transaction context is available. If another strategy for
event publication becomes necessary, refer to the JavaDoc for Spring&#8217;s
<code class="literal">ApplicationEventMulticaster</code> interface.</p>
<p>The following example shows the bean definitions used to register and configure each of
the classes above:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emailService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.EmailService"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"blackList"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>known.spammer@example.org<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>known.hacker@example.org<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>john.doe@example.org<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"blackListNotifier"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.BlackListNotifier"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"notificationAddress"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"blacklist@example.org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Putting it all together, when the <code class="literal">sendEmail()</code> method of the <code class="literal">emailService</code> bean is
called, if there are any emails that should be blacklisted, a custom event of type
<code class="literal">BlackListEvent</code> is published. The <code class="literal">blackListNotifier</code> bean is registered as an
<code class="literal">ApplicationListener</code> and thus receives the <code class="literal">BlackListEvent</code>, at which point it can
notify appropriate parties.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring&#8217;s eventing mechanism is designed for simple communication between Spring beans
within the same application context. However, for more sophisticated enterprise
integration needs, the separately-maintained
<a class="ulink" href="http://projects.spring.io/spring-integration/" target="_top">Spring Integration</a> project provides
complete support for building lightweight,
<a class="ulink" href="http://www.enterpriseintegrationpatterns.com" target="_top">pattern-oriented</a>, event-driven
architectures that build upon the well-known Spring programming model.</p>
</td></tr></table></div>

</div>
<div class="section" title="4.16.3&nbsp;Convenient access to low-level resources"><div class="titlepage"><div><div><h3 class="title"><a name="context-functionality-resources"></a>4.16.3&nbsp;Convenient access to low-level resources</h3></div></div></div>

<p>For optimal usage and understanding of application contexts, users should generally
familiarize themselves with Spring&#8217;s <code class="literal">Resource</code> abstraction, as described in the chapter
<a class="xref" href="#resources" title="5.&nbsp;Resources">Chapter&nbsp;5, <i>Resources</i></a>.</p>
<p>An application context is a <code class="literal">ResourceLoader</code>, which can be used to load <code class="literal">Resource</code> s. A
<code class="literal">Resource</code> is essentially a more feature rich version of the JDK class <code class="literal">java.net.URL</code>,
in fact, the implementations of the <code class="literal">Resource</code> wrap an instance of <code class="literal">java.net.URL</code> where
appropriate. A <code class="literal">Resource</code> can obtain low-level resources from almost any location in a
transparent fashion, including from the classpath, a filesystem location, anywhere
describable with a standard URL, and some other variations. If the resource location
string is a simple path without any special prefixes, where those resources come from is
specific and appropriate to the actual application context type.</p>
<p>You can configure a bean deployed into the application context to implement the special
callback interface, <code class="literal">ResourceLoaderAware</code>, to be automatically called back at
initialization time with the application context itself passed in as the
<code class="literal">ResourceLoader</code>. You can also expose properties of type <code class="literal">Resource</code>, to be used to
access static resources; they will be injected into it like any other properties. You
can specify those <code class="literal">Resource</code> properties as simple String paths, and rely on a special
JavaBean <code class="literal">PropertyEditor</code> that is automatically registered by the context, to convert
those text strings to actual <code class="literal">Resource</code> objects when the bean is deployed.</p>
<p>The location path or paths supplied to an <code class="literal">ApplicationContext</code> constructor are actually
resource strings, and in simple form are treated appropriately to the specific context
implementation. <code class="literal">ClassPathXmlApplicationContext</code> treats a simple location path as a
classpath location. You can also use location paths (resource strings) with special
prefixes to force loading of definitions from the classpath or a URL, regardless of the
actual context type.</p>
</div>
<div class="section" title="4.16.4&nbsp;Convenient ApplicationContext instantiation for web applications"><div class="titlepage"><div><div><h3 class="title"><a name="context-create"></a>4.16.4&nbsp;Convenient ApplicationContext instantiation for web applications</h3></div></div></div>

<p>You can create <code class="literal">ApplicationContext</code> instances declaratively by using, for example, a
<code class="literal">ContextLoader</code>. Of course you can also create <code class="literal">ApplicationContext</code> instances
programmatically by using one of the <code class="literal">ApplicationContext</code> implementations.</p>
<p>You can register an <code class="literal">ApplicationContext</code> using the <code class="literal">ContextLoaderListener</code> as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;context-param&gt;</span>
    <span class="hl-tag">&lt;param-name&gt;</span>contextConfigLocation<span class="hl-tag">&lt;/param-name&gt;</span>
    <span class="hl-tag">&lt;param-value&gt;</span>/WEB-INF/daoContext.xml /WEB-INF/applicationContext.xml<span class="hl-tag">&lt;/param-value&gt;</span>
<span class="hl-tag">&lt;/context-param&gt;</span>

<span class="hl-tag">&lt;listener&gt;</span>
    <span class="hl-tag">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hl-tag">&lt;/listener-class&gt;</span>
<span class="hl-tag">&lt;/listener&gt;</span>

<span class="hl-comment">&lt;!-- or use the ContextLoaderServlet instead of the above listener
</span><span class="emphasis"><em>&lt;servlet&gt;
    &lt;servlet-name&gt;context&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.springframework.web.context.ContextLoaderServlet&lt;/servlet-class&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;</em></span>
--&gt;</pre>

<p>The listener inspects the <code class="literal">contextConfigLocation</code> parameter. If the parameter does not
exist, the listener uses <code class="literal">/WEB-INF/applicationContext.xml</code> as a default. When the
parameter <span class="emphasis"><em>does</em></span> exist, the listener separates the String by using predefined
delimiters (comma, semicolon and whitespace) and uses the values as locations where
application contexts will be searched. Ant-style path patterns are supported as well.
Examples are <code class="literal">/WEB-INF/*Context.xml</code> for all files with names ending with "Context.xml",
residing in the "WEB-INF" directory, and <code class="literal">/WEB-INF/**/*Context.xml</code>, for all such files
in any subdirectory of "WEB-INF".</p>
<p>You can use <code class="literal">ContextLoaderServlet</code> instead of <code class="literal">ContextLoaderListener</code>. The Servlet uses
the <code class="literal">contextConfigLocation</code> parameter just as the listener does.</p>
</div>
<div class="section" title="4.16.5&nbsp;Deploying a Spring ApplicationContext as a J2EE RAR file"><div class="titlepage"><div><div><h3 class="title"><a name="context-deploy-rar"></a>4.16.5&nbsp;Deploying a Spring ApplicationContext as a J2EE RAR file</h3></div></div></div>

<p>It is possible to deploy a Spring ApplicationContext as a RAR file, encapsulating the
context and all of its required bean classes and library JARs in a J2EE RAR deployment
unit. This is the equivalent of bootstrapping a standalone ApplicationContext, just hosted
in J2EE environment, being able to access the J2EE servers facilities. RAR deployment is a
more natural alternative to scenario of deploying a headless WAR file, in effect, a WAR
file without any HTTP entry points that is used only for bootstrapping a Spring
ApplicationContext in a J2EE environment.</p>
<p>RAR deployment is ideal for application contexts that do not need HTTP entry points but
rather consist only of message endpoints and scheduled jobs. Beans in such a context can
use application server resources such as the JTA transaction manager and JNDI-bound JDBC
DataSources and JMS ConnectionFactory instances, and may also register with the
platform&#8217;s JMX server - all through Spring&#8217;s standard transaction management and JNDI
and JMX support facilities. Application components can also interact with the
application server&#8217;s JCA WorkManager through Spring&#8217;s <code class="literal">TaskExecutor</code> abstraction.</p>
<p>Check out the JavaDoc of the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jca/context/SpringContextResourceAdapter.html" target="_top"><code class="literal">SpringContextResourceAdapter</code></a>
class for the configuration details involved in RAR deployment.</p>
<p><span class="emphasis"><em>For a simple deployment of a Spring ApplicationContext as a J2EE RAR file:</em></span> package
all application classes into a RAR file, which is a standard JAR file with a different
file extension. Add all required library JARs into the root of the RAR archive. Add a
"META-INF/ra.xml" deployment descriptor (as shown in <code class="literal">SpringContextResourceAdapter</code> s
JavaDoc) and the corresponding Spring XML bean definition file(s) (typically
"META-INF/applicationContext.xml"), and drop the resulting RAR file into your
application server&#8217;s deployment directory.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Such RAR deployment units are usually self-contained; they do not expose components to
the outside world, not even to other modules of the same application. Interaction with a
RAR-based ApplicationContext usually occurs through JMS destinations that it shares with
other modules. A RAR-based ApplicationContext may also, for example, schedule some jobs,
reacting to new files in the file system (or the like). If it needs to allow synchronous
access from the outside, it could for example export RMI endpoints, which of course may
be used by other application modules on the same machine.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="4.17&nbsp;The BeanFactory"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-beanfactory"></a>4.17&nbsp;The BeanFactory</h2></div></div></div>

<p>The <code class="literal">BeanFactory</code> provides the underlying basis for Spring&#8217;s IoC functionality but it is
only used directly in integration with other third-party frameworks and is now largely
historical in nature for most users of Spring. The <code class="literal">BeanFactory</code> and related interfaces,
such as <code class="literal">BeanFactoryAware</code>, <code class="literal">InitializingBean</code>, <code class="literal">DisposableBean</code>, are still present in
Spring for the purposes of backward compatibility with the large number of third-party
frameworks that integrate with Spring. Often third-party components that can not use
more modern equivalents such as <code class="literal">@PostConstruct</code> or <code class="literal">@PreDestroy</code> in order to remain
compatible with JDK 1.4 or to avoid a dependency on JSR-250.</p>
<p>This section provides additional background into the differences between the
<code class="literal">BeanFactory</code> and <code class="literal">ApplicationContext</code> and how one might access the IoC container
directly through a classic singleton lookup.</p>
<div class="section" title="4.17.1&nbsp;BeanFactory or ApplicationContext?"><div class="titlepage"><div><div><h3 class="title"><a name="context-introduction-ctx-vs-beanfactory"></a>4.17.1&nbsp;BeanFactory or ApplicationContext?</h3></div></div></div>

<p>Use an <code class="literal">ApplicationContext</code> unless you have a good reason for not doing so.</p>
<p>Because the <code class="literal">ApplicationContext</code> includes all functionality of the <code class="literal">BeanFactory</code>, it is
generally recommended over the <code class="literal">BeanFactory</code>, except for a few situations such as in an
<code class="literal">Applet</code> where memory consumption might be critical and a few extra kilobytes might make
a difference. However, for most typical enterprise applications and systems, the
<code class="literal">ApplicationContext</code> is what you will want to use. Spring makes <span class="emphasis"><em>heavy</em></span>
use of the <a class="link" href="#beans-factory-extension-bpp" title="4.8.1&nbsp;Customizing beans using a BeanPostProcessor"><code class="literal">BeanPostProcessor</code> extension point</a> (to
effect proxying and so on). If you use only a plain <code class="literal">BeanFactory</code>, a fair amount of
support such as transactions and AOP will not take effect, at least not without some
extra steps on your part. This situation could be confusing because nothing is actually
wrong with the configuration.</p>
<p>The following table lists features provided by the <code class="literal">BeanFactory</code> and
<code class="literal">ApplicationContext</code> interfaces and implementations.</p>
<div class="table"><a name="context-introduction-ctx-vs-beanfactory-feature-matrix"></a><p class="title"><b>Table&nbsp;4.8.&nbsp;Feature Matrix</b></p><div class="table-contents">

  <table summary="Feature Matrix" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Feature</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><code class="literal">BeanFactory</code></th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top"><code class="literal">ApplicationContext</code></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Bean instantiation/wiring</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Yes</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Automatic <code class="literal">BeanPostProcessor</code> registration</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Automatic <code class="literal">BeanFactoryPostProcessor</code> registration</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Convenient <code class="literal">MessageSource</code> access (for i18n)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ApplicationEvent</code> publication</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="" align="left" valign="top"><p>Yes</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>To explicitly register a bean post-processor with a <code class="literal">BeanFactory</code> implementation, you
must write code like this:</p>
<pre class="programlisting">ConfigurableBeanFactory factory = <span class="hl-keyword">new</span> XmlBeanFactory(...);

<span class="hl-comment">// now register any needed BeanPostProcessor instances</span>
MyBeanPostProcessor postProcessor = <span class="hl-keyword">new</span> MyBeanPostProcessor();
factory.addBeanPostProcessor(postProcessor);

<span class="hl-comment">// now start using the factory</span></pre>

<p>To explicitly register a <code class="literal">BeanFactoryPostProcessor</code> when using a <code class="literal">BeanFactory</code>
implementation, you must write code like this:</p>
<pre class="programlisting">XmlBeanFactory factory = <span class="hl-keyword">new</span> XmlBeanFactory(<span class="hl-keyword">new</span> FileSystemResource(<span class="hl-string">"beans.xml"</span>));

<span class="hl-comment">// bring in some property values from a Properties file</span>
PropertyPlaceholderConfigurer cfg = <span class="hl-keyword">new</span> PropertyPlaceholderConfigurer();
cfg.setLocation(<span class="hl-keyword">new</span> FileSystemResource(<span class="hl-string">"jdbc.properties"</span>));

<span class="hl-comment">// now actually do the replacement</span>
cfg.postProcessBeanFactory(factory);</pre>

<p>In both cases, the explicit registration step is inconvenient, which is one reason why
the various <code class="literal">ApplicationContext</code> implementations are preferred above plain <code class="literal">BeanFactory</code>
implementations in the vast majority of Spring-backed applications, especially when
using <code class="literal">BeanFactoryPostProcessors</code> and <code class="literal">BeanPostProcessors</code>. These mechanisms implement
important functionality such as property placeholder replacement and AOP.</p>
</div>
<div class="section" title="4.17.2&nbsp;Glue code and the evil singleton"><div class="titlepage"><div><div><h3 class="title"><a name="beans-servicelocator"></a>4.17.2&nbsp;Glue code and the evil singleton</h3></div></div></div>

<p>It is best to write most application code in a dependency-injection (DI) style, where
that code is served out of a Spring IoC container, has its own dependencies supplied by
the container when it is created, and is completely unaware of the container. However,
for the small glue layers of code that are sometimes needed to tie other code together,
you sometimes need a singleton (or quasi-singleton) style access to a Spring IoC
container. For example, third-party code may try to construct new objects directly (
<code class="literal">Class.forName()</code> style), without the ability to get these objects out of a Spring IoC
container.If the object constructed by the third-party code is a small stub or proxy,
which then uses a singleton style access to a Spring IoC container to get a real object
to delegate to, then inversion of control has still been achieved for the majority of
the code (the object coming out of the container). Thus most code is still unaware of
the container or how it is accessed, and remains decoupled from other code, with all
ensuing benefits. EJBs may also use this stub/proxy approach to delegate to a plain Java
implementation object, retrieved from a Spring IoC container. While the Spring IoC
container itself ideally does not have to be a singleton, it may be unrealistic in terms
of memory usage or initialization times (when using beans in the Spring IoC container
such as a Hibernate <code class="literal">SessionFactory</code>) for each bean to use its own, non-singleton Spring
IoC container.</p>
<p>Looking up the application context in a service locator style is sometimes the only
option for accessing shared Spring-managed components, such as in an EJB 2.1
environment, or when you want to share a single ApplicationContext as a parent to
WebApplicationContexts across WAR files. In this case you should look into using the
utility class
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/access/ContextSingletonBeanFactoryLocator.html" target="_top"><code class="literal">ContextSingletonBeanFactoryLocator</code></a>
locator that is described in this
<a class="ulink" href="http://blog.springsource.com/2007/06/11/using-a-shared-parent-application-context-in-a-multi-war-spring-application/" target="_top">SpringSource
team blog entry</a>.</p>
</div>
</div>
<div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d4e658" href="#d4e658" class="simpara">1</a>] </sup>See <a class="xref" href="#background-ioc" title="Background">Background</a> </p></div><div class="footnote"><p><sup>[<a name="ftn.d4e1469" href="#d4e1469" class="simpara">2</a>] </sup>See
<a class="xref" href="#beans-factory-collaborators" title="4.4.1&nbsp;Dependency injection">Section&nbsp;4.4.1, &#8220;Dependency injection&#8221;</a></p></div></div></div>
<div class="chapter" title="5.&nbsp;Resources"><div class="titlepage"><div><div><h2 class="title"><a name="resources"></a>5.&nbsp;Resources</h2></div></div></div>

<div class="section" title="5.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources-introduction"></a>5.1&nbsp;Introduction</h2></div></div></div>

<p>Java&#8217;s standard <code class="literal">java.net.URL</code> class and standard handlers for various URL prefixes
unfortunately are not quite adequate enough for all access to low-level resources. For
example, there is no standardized <code class="literal">URL</code> implementation that may be used to access a
resource that needs to be obtained from the classpath, or relative to a
<code class="literal">ServletContext</code>. While it is possible to register new handlers for specialized <code class="literal">URL</code>
prefixes (similar to existing handlers for prefixes such as <code class="literal">http:</code>), this is generally
quite complicated, and the <code class="literal">URL</code> interface still lacks some desirable functionality,
such as a method to check for the existence of the resource being pointed to.</p>
</div>
<div class="section" title="5.2&nbsp;The Resource interface"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources-resource"></a>5.2&nbsp;The Resource interface</h2></div></div></div>

<p>Spring&#8217;s <code class="literal">Resource</code> interface is meant to be a more capable interface for abstracting
access to low-level resources.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Resource <span class="hl-keyword">extends</span> InputStreamSource {

    <span class="hl-keyword">boolean</span> exists();

    <span class="hl-keyword">boolean</span> isOpen();

    URL getURL() <span class="hl-keyword">throws</span> IOException;

    File getFile() <span class="hl-keyword">throws</span> IOException;

    Resource createRelative(String relativePath) <span class="hl-keyword">throws</span> IOException;

    String getFilename();

    String getDescription();

}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> InputStreamSource {

    InputStream getInputStream() <span class="hl-keyword">throws</span> IOException;

}</pre>

<p>Some of the most important methods from the <code class="literal">Resource</code> interface are:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">getInputStream()</code>: locates and opens the resource, returning an <code class="literal">InputStream</code> for
reading from the resource. It is expected that each invocation returns a fresh
<code class="literal">InputStream</code>. It is the responsibility of the caller to close the stream.
</li><li class="listitem">
<code class="literal">exists()</code>: returns a <code class="literal">boolean</code> indicating whether this resource actually exists in
physical form.
</li><li class="listitem">
<code class="literal">isOpen()</code>: returns a <code class="literal">boolean</code> indicating whether this resource represents a handle
with an open stream. If <code class="literal">true</code>, the <code class="literal">InputStream</code> cannot be read multiple times, and
must be read once only and then closed to avoid resource leaks. Will be <code class="literal">false</code> for
all usual resource implementations, with the exception of <code class="literal">InputStreamResource</code>.
</li><li class="listitem">
<code class="literal">getDescription()</code>: returns a description for this resource, to be used for error
output when working with the resource. This is often the fully qualified file name or
the actual URL of the resource.
</li></ul></div>

<p>Other methods allow you to obtain an actual <code class="literal">URL</code> or <code class="literal">File</code> object representing the
resource (if the underlying implementation is compatible, and supports that
functionality).</p>
<p>The <code class="literal">Resource</code> abstraction is used extensively in Spring itself, as an argument type in
many method signatures when a resource is needed. Other methods in some Spring APIs
(such as the constructors to various <code class="literal">ApplicationContext</code> implementations), take a
<code class="literal">String</code> which in unadorned or simple form is used to create a <code class="literal">Resource</code> appropriate to
that context implementation, or via special prefixes on the <code class="literal">String</code> path, allow the
caller to specify that a specific <code class="literal">Resource</code> implementation must be created and used.</p>
<p>While the <code class="literal">Resource</code> interface is used a lot with Spring and by Spring, it&#8217;s actually
very useful to use as a general utility class by itself in your own code, for access to
resources, even when your code doesn&#8217;t know or care about any other parts of Spring.
While this couples your code to Spring, it really only couples it to this small set of
utility classes, which are serving as a more capable replacement for <code class="literal">URL</code>, and can be
considered equivalent to any other library you would use for this purpose.</p>
<p>It is important to note that the <code class="literal">Resource</code> abstraction does not replace functionality:
it wraps it where possible. For example, a <code class="literal">UrlResource</code> wraps a URL, and uses the
wrapped <code class="literal">URL</code> to do its work.</p>
</div>
<div class="section" title="5.3&nbsp;Built-in Resource implementations"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources-implementations"></a>5.3&nbsp;Built-in Resource implementations</h2></div></div></div>

<p>There are a number of <code class="literal">Resource</code> implementations that come supplied straight out of the
box in Spring:</p>
<div class="section" title="5.3.1&nbsp;UrlResource"><div class="titlepage"><div><div><h3 class="title"><a name="resources-implementations-urlresource"></a>5.3.1&nbsp;UrlResource</h3></div></div></div>

<p>The <code class="literal">UrlResource</code> wraps a <code class="literal">java.net.URL</code>, and may be used to access any object that is
normally accessible via a URL, such as files, an HTTP target, an FTP target, etc. All
URLs have a standardized <code class="literal">String</code> representation, such that appropriate standardized
prefixes are used to indicate one URL type from another. This includes <code class="literal">file:</code> for
accessing filesystem paths, <code class="literal">http:</code> for accessing resources via the HTTP protocol,
<code class="literal">ftp:</code> for accessing resources via FTP, etc.</p>
<p>A <code class="literal">UrlResource</code> is created by Java code explicitly using the <code class="literal">UrlResource</code> constructor,
but will often be created implicitly when you call an API method which takes a <code class="literal">String</code>
argument which is meant to represent a path. For the latter case, a JavaBeans
<code class="literal">PropertyEditor</code> will ultimately decide which type of <code class="literal">Resource</code> to create. If the path
string contains a few well-known (to it, that is) prefixes such as <code class="literal">classpath:</code>, it will
create an appropriate specialized <code class="literal">Resource</code> for that prefix. However, if it doesn&#8217;t
recognize the prefix, it will assume the this is just a standard URL string, and will
create a <code class="literal">UrlResource</code>.</p>
</div>
<div class="section" title="5.3.2&nbsp;ClassPathResource"><div class="titlepage"><div><div><h3 class="title"><a name="resources-implementations-classpathresource"></a>5.3.2&nbsp;ClassPathResource</h3></div></div></div>

<p>This class represents a resource which should be obtained from the classpath. This uses
either the thread context class loader, a given class loader, or a given class for
loading resources.</p>
<p>This <code class="literal">Resource</code> implementation supports resolution as <code class="literal">java.io.File</code> if the class path
resource resides in the file system, but not for classpath resources which reside in a
jar and have not been expanded (by the servlet engine, or whatever the environment is)
to the filesystem. To address this the various <code class="literal">Resource</code> implementations always support
resolution as a <code class="literal">java.net.URL</code>.</p>
<p>A <code class="literal">ClassPathResource</code> is created by Java code explicitly using the <code class="literal">ClassPathResource</code>
constructor, but will often be created implicitly when you call an API method which
takes a <code class="literal">String</code> argument which is meant to represent a path. For the latter case, a
JavaBeans <code class="literal">PropertyEditor</code> will recognize the special prefix <code class="literal">classpath:</code> on the string
path, and create a <code class="literal">ClassPathResource</code> in that case.</p>
</div>
<div class="section" title="5.3.3&nbsp;FileSystemResource"><div class="titlepage"><div><div><h3 class="title"><a name="resources-implementations-filesystemresource"></a>5.3.3&nbsp;FileSystemResource</h3></div></div></div>

<p>This is a <code class="literal">Resource</code> implementation for <code class="literal">java.io.File</code> handles. It obviously supports
resolution as a <code class="literal">File</code>, and as a <code class="literal">URL</code>.</p>
</div>
<div class="section" title="5.3.4&nbsp;ServletContextResource"><div class="titlepage"><div><div><h3 class="title"><a name="resources-implementations-servletcontextresource"></a>5.3.4&nbsp;ServletContextResource</h3></div></div></div>

<p>This is a <code class="literal">Resource</code> implementation for <code class="literal">ServletContext</code> resources, interpreting
relative paths within the relevant web application&#8217;s root directory.</p>
<p>This always supports stream access and URL access, but only allows <code class="literal">java.io.File</code> access
when the web application archive is expanded and the resource is physically on the
filesystem. Whether or not it&#8217;s expanded and on the filesystem like this, or accessed
directly from the JAR or somewhere else like a DB (it&#8217;s conceivable) is actually
dependent on the Servlet container.</p>
</div>
<div class="section" title="5.3.5&nbsp;InputStreamResource"><div class="titlepage"><div><div><h3 class="title"><a name="resources-implementations-inputstreamresource"></a>5.3.5&nbsp;InputStreamResource</h3></div></div></div>

<p>A <code class="literal">Resource</code> implementation for a given <code class="literal">InputStream</code>. This should only be used if no
specific <code class="literal">Resource</code> implementation is applicable. In particular, prefer
<code class="literal">ByteArrayResource</code> or any of the file-based <code class="literal">Resource</code> implementations where possible.</p>
<p>In contrast to other <code class="literal">Resource</code> implementations, this is a descriptor for an <span class="emphasis"><em>already</em></span>
opened resource - therefore returning <code class="literal">true</code> from <code class="literal">isOpen()</code>. Do not use it if you need
to keep the resource descriptor somewhere, or if you need to read a stream multiple
times.</p>
</div>
<div class="section" title="5.3.6&nbsp;ByteArrayResource"><div class="titlepage"><div><div><h3 class="title"><a name="resources-implementations-bytearrayresource"></a>5.3.6&nbsp;ByteArrayResource</h3></div></div></div>

<p>This is a <code class="literal">Resource</code> implementation for a given byte array. It creates a
<code class="literal">ByteArrayInputStream</code> for the given byte array.</p>
<p>It&#8217;s useful for loading content from any given byte array, without having to resort to a
single-use <code class="literal">InputStreamResource</code>.</p>
</div>
</div>
<div class="section" title="5.4&nbsp;The ResourceLoader"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources-resourceloader"></a>5.4&nbsp;The ResourceLoader</h2></div></div></div>

<p>The <code class="literal">ResourceLoader</code> interface is meant to be implemented by objects that can return
(i.e. load) <code class="literal">Resource</code> instances.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ResourceLoader {

    Resource getResource(String location);

}</pre>

<p>All application contexts implement the <code class="literal">ResourceLoader</code> interface, and therefore all
application contexts may be used to obtain <code class="literal">Resource</code> instances.</p>
<p>When you call <code class="literal">getResource()</code> on a specific application context, and the location path
specified doesn&#8217;t have a specific prefix, you will get back a <code class="literal">Resource</code> type that is
appropriate to that particular application context. For example, assume the following
snippet of code was executed against a <code class="literal">ClassPathXmlApplicationContext</code> instance:</p>
<pre class="programlisting">Resource template = ctx.getResource(<span class="hl-string">"some/resource/path/myTemplate.txt"</span>);</pre>

<p>What would be returned would be a <code class="literal">ClassPathResource</code>; if the same method was executed
against a <code class="literal">FileSystemXmlApplicationContext</code> instance, you&#8217;d get back a
<code class="literal">FileSystemResource</code>. For a <code class="literal">WebApplicationContext</code>, you&#8217;d get back a
<code class="literal">ServletContextResource</code>, and so on.</p>
<p>As such, you can load resources in a fashion appropriate to the particular application
context.</p>
<p>On the other hand, you may also force <code class="literal">ClassPathResource</code> to be used, regardless of the
application context type, by specifying the special <code class="literal">classpath:</code> prefix:</p>
<pre class="programlisting">Resource template = ctx.getResource(<span class="hl-string">"classpath:some/resource/path/myTemplate.txt"</span>);</pre>

<p>Similarly, one can force a <code class="literal">UrlResource</code> to be used by specifying any of the standard
<code class="literal">java.net.URL</code> prefixes:</p>
<pre class="programlisting">Resource template = ctx.getResource(<span class="hl-string">"file:/some/resource/path/myTemplate.txt"</span>);</pre>

<pre class="programlisting">Resource template = ctx.getResource(<span class="hl-string">"http://myhost.com/resource/path/myTemplate.txt"</span>);</pre>

<p>The following table summarizes the strategy for converting <code class="literal">String</code> s to <code class="literal">Resource</code> s:</p>
<div class="table"><a name="resources-resource-strings"></a><p class="title"><b>Table&nbsp;5.1.&nbsp;Resource strings</b></p><div class="table-contents">

  <table summary="Resource strings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Prefix</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Example</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>classpath:</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">classpath:com/myapp/config.xml</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Loaded from the classpath.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>file:</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">file:/data/config.xml</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Loaded as a <code class="literal">URL</code>, from the filesystem. <sup>[<a name="d4e4290" href="#ftn.d4e4290" class="footnote">1</a>]</sup></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>http:</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http://myserver/logo.png</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Loaded as a <code class="literal">URL</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>(none)</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">/data/config.xml</code></p></td><td style="" align="left" valign="top"><p>Depends on the underlying <code class="literal">ApplicationContext</code>.</p></td></tr></tbody><tbody class="footnotes"><tr><td colspan="3"><div class="footnote"><p><sup>[<a name="ftn.d4e4290" href="#d4e4290" class="simpara">1</a>] </sup>But see also
  <a class="xref" href="#resources-filesystemresource-caveats" title="5.7.3&nbsp;FileSystemResource caveats">Section&nbsp;5.7.3, &#8220;FileSystemResource caveats&#8221;</a>.</p></div></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="5.5&nbsp;The ResourceLoaderAware interface"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources-resourceloaderaware"></a>5.5&nbsp;The ResourceLoaderAware interface</h2></div></div></div>

<p>The <code class="literal">ResourceLoaderAware</code> interface is a special marker interface, identifying objects
that expect to be provided with a <code class="literal">ResourceLoader</code> reference.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ResourceLoaderAware {

    <span class="hl-keyword">void</span> setResourceLoader(ResourceLoader resourceLoader);
}</pre>

<p>When a class implements <code class="literal">ResourceLoaderAware</code> and is deployed into an application
context (as a Spring-managed bean), it is recognized as <code class="literal">ResourceLoaderAware</code> by the
application context. The application context will then invoke the
<code class="literal">setResourceLoader(ResourceLoader)</code>, supplying itself as the argument (remember, all
application contexts in Spring implement the <code class="literal">ResourceLoader</code> interface).</p>
<p>Of course, since an <code class="literal">ApplicationContext</code> is a <code class="literal">ResourceLoader</code>, the bean could also
implement the <code class="literal">ApplicationContextAware</code> interface and use the supplied application
context directly to load resources, but in general, it&#8217;s better to use the specialized
<code class="literal">ResourceLoader</code> interface if that&#8217;s all that&#8217;s needed. The code would just be coupled
to the resource loading interface, which can be considered a utility interface, and not
the whole Spring <code class="literal">ApplicationContext</code> interface.</p>
<p>As of Spring 2.5, you can rely upon autowiring of the <code class="literal">ResourceLoader</code> as an alternative
to implementing the <code class="literal">ResourceLoaderAware</code> interface. The "traditional" <code class="literal">constructor</code> and
<code class="literal">byType</code> autowiring modes (as described in <a class="xref" href="#beans-factory-autowire" title="4.4.5&nbsp;Autowiring collaborators">Section&nbsp;4.4.5, &#8220;Autowiring collaborators&#8221;</a>) are now capable
of providing a dependency of type <code class="literal">ResourceLoader</code> for either a constructor argument or
setter method parameter respectively. For more flexibility (including the ability to
autowire fields and multiple parameter methods), consider using the new annotation-based
autowiring features. In that case, the <code class="literal">ResourceLoader</code> will be autowired into a field,
constructor argument, or method parameter that is expecting the <code class="literal">ResourceLoader</code> type as
long as the field, constructor, or method in question carries the <code class="literal">@Autowired</code>
annotation. For more information, see <a class="xref" href="#beans-autowired-annotation" title="4.9.2&nbsp;@Autowired">Section&nbsp;4.9.2, &#8220;@Autowired&#8221;</a>.</p>
</div>
<div class="section" title="5.6&nbsp;Resources as dependencies"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources-as-dependencies"></a>5.6&nbsp;Resources as dependencies</h2></div></div></div>

<p>If the bean itself is going to determine and supply the resource path through some sort
of dynamic process, it probably makes sense for the bean to use the <code class="literal">ResourceLoader</code>
interface to load resources. Consider as an example the loading of a template of some
sort, where the specific resource that is needed depends on the role of the user. If the
resources are static, it makes sense to eliminate the use of the <code class="literal">ResourceLoader</code>
interface completely, and just have the bean expose the <code class="literal">Resource</code> properties it needs,
and expect that they will be injected into it.</p>
<p>What makes it trivial to then inject these properties, is that all application contexts
register and use a special JavaBeans <code class="literal">PropertyEditor</code> which can convert <code class="literal">String</code> paths
to <code class="literal">Resource</code> objects. So if <code class="literal">myBean</code> has a template property of type <code class="literal">Resource</code>, it can
be configured with a simple string for that resource, as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"template"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"some/resource/path/myTemplate.txt"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the resource path has no prefix, so because the application context itself is
going to be used as the <code class="literal">ResourceLoader</code>, the resource itself will be loaded via a
<code class="literal">ClassPathResource</code>, <code class="literal">FileSystemResource</code>, or <code class="literal">ServletContextResource</code> (as appropriate)
depending on the exact type of the context.</p>
<p>If there is a need to force a specific <code class="literal">Resource</code> type to be used, then a prefix may be
used. The following two examples show how to force a <code class="literal">ClassPathResource</code> and a
<code class="literal">UrlResource</code> (the latter being used to access a filesystem file).</p>
<pre class="programlisting"><span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"template"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:some/resource/path/myTemplate.txt"</span><span class="hl-tag">&gt;</span></pre>

<pre class="programlisting"><span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"template"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"file:/some/resource/path/myTemplate.txt"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="5.7&nbsp;Application contexts and Resource paths"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources-app-ctx"></a>5.7&nbsp;Application contexts and Resource paths</h2></div></div></div>

<div class="section" title="5.7.1&nbsp;Constructing application contexts"><div class="titlepage"><div><div><h3 class="title"><a name="resources-app-ctx-construction"></a>5.7.1&nbsp;Constructing application contexts</h3></div></div></div>

<p>An application context constructor (for a specific application context type) generally
takes a string or array of strings as the location path(s) of the resource(s) such as
XML files that make up the definition of the context.</p>
<p>When such a location path doesn&#8217;t have a prefix, the specific <code class="literal">Resource</code> type built from
that path and used to load the bean definitions, depends on and is appropriate to the
specific application context. For example, if you create a
<code class="literal">ClassPathXmlApplicationContext</code> as follows:</p>
<pre class="programlisting">ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"conf/appContext.xml"</span>);</pre>

<p>The bean definitions will be loaded from the classpath, as a <code class="literal">ClassPathResource</code> will be
used. But if you create a <code class="literal">FileSystemXmlApplicationContext</code> as follows:</p>
<pre class="programlisting">ApplicationContext ctx =
    <span class="hl-keyword">new</span> FileSystemXmlApplicationContext(<span class="hl-string">"conf/appContext.xml"</span>);</pre>

<p>The bean definition will be loaded from a filesystem location, in this case relative to
the current working directory.</p>
<p>Note that the use of the special classpath prefix or a standard URL prefix on the
location path will override the default type of <code class="literal">Resource</code> created to load the
definition. So this <code class="literal">FileSystemXmlApplicationContext</code>&#8230;</p>
<pre class="programlisting">ApplicationContext ctx =
    <span class="hl-keyword">new</span> FileSystemXmlApplicationContext(<span class="hl-string">"classpath:conf/appContext.xml"</span>);</pre>

<div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem">
will actually load its bean definitions from the classpath. However, it is still a
<code class="literal">FileSystemXmlApplicationContext</code>. If it is subsequently used as a <code class="literal">ResourceLoader</code>, any
unprefixed paths will still be treated as filesystem paths.
</li></ol></div>

<div class="section" title="Constructing ClassPathXmlApplicationContext instances - shortcuts"><div class="titlepage"><div><div><h4 class="title"><a name="resources-app-ctx-classpathxml"></a>Constructing ClassPathXmlApplicationContext instances - shortcuts</h4></div></div></div>

<p>The <code class="literal">ClassPathXmlApplicationContext</code> exposes a number of constructors to enable
convenient instantiation. The basic idea is that one supplies merely a string array
containing just the filenames of the XML files themselves (without the leading path
information), and one <span class="emphasis"><em>also</em></span> supplies a <code class="literal">Class</code>; the <code class="literal">ClassPathXmlApplicationContext</code>
will derive the path information from the supplied class.</p>
<p>An example will hopefully make this clear. Consider a directory layout that looks like
this:</p>

<pre class="literallayout">com/
  foo/
	services.xml
	daos.xml
    MessengerService.class</pre>

<p>A <code class="literal">ClassPathXmlApplicationContext</code> instance composed of the beans defined in the
<code class="literal">'services.xml'</code> and <code class="literal">'daos.xml'</code> could be instantiated like so&#8230;</p>
<pre class="programlisting">ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(
    <span class="hl-keyword">new</span> String[] {<span class="hl-string">"services.xml"</span>, <span class="hl-string">"daos.xml"</span>}, MessengerService.<span class="hl-keyword">class</span>);</pre>

<p>Please do consult the Javadocs for the <code class="literal">ClassPathXmlApplicationContext</code> class for
details of the various constructors.</p>
</div>
</div>
<div class="section" title="5.7.2&nbsp;Wildcards in application context constructor resource paths"><div class="titlepage"><div><div><h3 class="title"><a name="resources-app-ctx-wildcards-in-resource-paths"></a>5.7.2&nbsp;Wildcards in application context constructor resource paths</h3></div></div></div>

<p>The resource paths in application context constructor values may be a simple path (as
shown above) which has a one-to-one mapping to a target Resource, or alternately may
contain the special "classpath*:" prefix and/or internal Ant-style regular expressions
(matched using Spring&#8217;s <code class="literal">PathMatcher</code> utility). Both of the latter are effectively
wildcards</p>
<p>One use for this mechanism is when doing component-style application assembly. All
components can <span class="emphasis"><em>publish</em></span> context definition fragments to a well-known location path, and
when the final application context is created using the same path prefixed via
<code class="literal">classpath*:</code>, all component fragments will be picked up automatically.</p>
<p>Note that this wildcarding is specific to use of resource paths in application context
constructors (or when using the <code class="literal">PathMatcher</code> utility class hierarchy directly), and is
resolved at construction time. It has nothing to do with the <code class="literal">Resource</code> type itself.
It&#8217;s not possible to use the <code class="literal">classpath*:</code> prefix to construct an actual <code class="literal">Resource</code>, as
a resource points to just one resource at a time.</p>
<div class="section" title="Ant-style Patterns"><div class="titlepage"><div><div><h4 class="title"><a name="resources-app-ctx-ant-patterns-in-paths"></a>Ant-style Patterns</h4></div></div></div>

<p>When the path location contains an Ant-style pattern, for example:</p>

<pre class="literallayout">/WEB-INF/<span class="strong"><strong>-context.xml
  com/mycompany/<span class="strong"><strong>/applicationContext.xml
  file:C:/some/path/</strong></span>-context.xml
  classpath:com/mycompany/</strong></span>/applicationContext.xml</pre>

<div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem">
the resolver follows a more complex but defined procedure to try to resolve the
wildcard. It produces a Resource for the path up to the last non-wildcard segment and
obtains a URL from it. If this URL is not a "jar:" URL or container-specific variant
(e.g. " <code class="literal">zip:</code>" in WebLogic, " <code class="literal">wsjar</code>" in WebSphere, etc.), then a <code class="literal">java.io.File</code> is
obtained from it and used to resolve the wildcard by traversing the filesystem. In the
case of a jar URL, the resolver either gets a <code class="literal">java.net.JarURLConnection</code> from it or
manually parses the jar URL and then traverses the contents of the jar file to resolve
the wildcards.
</li></ol></div>

<div class="section" title="Implications on portability"><div class="titlepage"><div><div><h5 class="title"><a name="resources-app-ctx-portability"></a>Implications on portability</h5></div></div></div>

<p>If the specified path is already a file URL (either explicitly, or implicitly because
the base <code class="literal">ResourceLoader</code> is a filesystem one, then wildcarding is guaranteed to work in
a completely portable fashion.</p>
<p>If the specified path is a classpath location, then the resolver must obtain the last
non-wildcard path segment URL via a <code class="literal">Classloader.getResource()</code> call. Since this is just
a node of the path (not the file at the end) it is actually undefined (in the
<code class="literal">ClassLoader</code> Javadocs) exactly what sort of a URL is returned in this case. In
practice, it is always a <code class="literal">java.io.File</code> representing the directory, where the classpath
resource resolves to a filesystem location, or a jar URL of some sort, where the
classpath resource resolves to a jar location. Still, there is a portability concern on
this operation.</p>
<p>If a jar URL is obtained for the last non-wildcard segment, the resolver must be able to
get a <code class="literal">java.net.JarURLConnection</code> from it, or manually parse the jar URL, to be able to
walk the contents of the jar, and resolve the wildcard. This will work in most
environments, but will fail in others, and it is strongly recommended that the wildcard
resolution of resources coming from jars be thoroughly tested in your specific
environment before you rely on it.</p>
</div>
</div>
<div class="section" title="The Classpath*: portability classpath*: prefix"><div class="titlepage"><div><div><h4 class="title"><a name="resources-classpath-wildcards"></a>The Classpath*: portability classpath*: prefix</h4></div></div></div>

<p>When constructing an XML-based application context, a location string may use the
special <code class="literal">classpath*:</code> prefix:</p>
<pre class="programlisting">ApplicationContext ctx =
    <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"classpath*:conf/appContext.xml"</span>);</pre>

<p>This special prefix specifies that all classpath resources that match the given name
must be obtained (internally, this essentially happens via a
<code class="literal">ClassLoader.getResources(...)</code> call), and then merged to form the final application
context definition.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The wildcard classpath relies on the <code class="literal">getResources()</code> method of the underlying
classloader. As most application servers nowadays supply their own classloader
implementation, the behavior might differ especially when dealing with jar files. A
simple test to check if <code class="literal">classpath*</code> works is to use the classloader to load a file from
within a jar on the classpath:
<code class="literal">getClass().getClassLoader().getResources("&lt;someFileInsideTheJar&gt;")</code>. Try this test with
files that have the same name but are placed inside two different locations. In case an
inappropriate result is returned, check the application server documentation for
settings that might affect the classloader behavior.</p>
</td></tr></table></div>

<p>The " <code class="literal">classpath*:</code>" prefix can also be combined with a <code class="literal">PathMatcher</code> pattern in the
rest of the location path, for example " <code class="literal">classpath*:META-INF/*-beans.xml</code>". In this
case, the resolution strategy is fairly simple: a ClassLoader.getResources() call is
used on the last non-wildcard path segment to get all the matching resources in the
class loader hierarchy, and then off each resource the same PathMatcher resolution
strategy described above is used for the wildcard subpath.</p>
</div>
<div class="section" title="Other notes relating to wildcards"><div class="titlepage"><div><div><h4 class="title"><a name="resources-wildcards-in-path-other-stuff"></a>Other notes relating to wildcards</h4></div></div></div>

<p>Please note that " <code class="literal">classpath*:</code>" when combined with Ant-style patterns will only work
reliably with at least one root directory before the pattern starts, unless the actual
target files reside in the file system. This means that a pattern like "
<code class="literal">classpath*:*.xml</code>" will not retrieve files from the root of jar files but rather only
from the root of expanded directories. This originates from a limitation in the JDK&#8217;s
<code class="literal">ClassLoader.getResources()</code> method which only returns file system locations for a
passed-in empty string (indicating potential roots to search).</p>
<p>Ant-style patterns with " <code class="literal">classpath:</code>" resources are not guaranteed to find matching
resources if the root package to search is available in multiple class path locations.
This is because a resource such as</p>

<pre class="literallayout">com/mycompany/package1/service-context.xml</pre>

<p>may be in only one location, but when a path such as</p>

<pre class="literallayout">classpath:com/mycompany/**/service-context.xml</pre>

<p>is used to try to resolve it, the resolver will work off the (first) URL returned by
<code class="literal">getResource("com/mycompany")</code>;. If this base package node exists in multiple
classloader locations, the actual end resource may not be underneath. Therefore,
preferably, use " <code class="literal">classpath*:</code>" with the same Ant-style pattern in such a case, which
will search all class path locations that contain the root package.</p>
</div>
</div>
<div class="section" title="5.7.3&nbsp;FileSystemResource caveats"><div class="titlepage"><div><div><h3 class="title"><a name="resources-filesystemresource-caveats"></a>5.7.3&nbsp;FileSystemResource caveats</h3></div></div></div>

<p>A <code class="literal">FileSystemResource</code> that is not attached to a <code class="literal">FileSystemApplicationContext</code> (that
is, a <code class="literal">FileSystemApplicationContext</code> is not the actual <code class="literal">ResourceLoader</code>) will treat
absolute vs. relative paths as you would expect. Relative paths are relative to the
current working directory, while absolute paths are relative to the root of the
filesystem.</p>
<p>For backwards compatibility (historical) reasons however, this changes when the
<code class="literal">FileSystemApplicationContext</code> is the <code class="literal">ResourceLoader</code>. The
<code class="literal">FileSystemApplicationContext</code> simply forces all attached <code class="literal">FileSystemResource</code> instances
to treat all location paths as relative, whether they start with a leading slash or not.
In practice, this means the following are equivalent:</p>
<pre class="programlisting">ApplicationContext ctx =
    <span class="hl-keyword">new</span> FileSystemXmlApplicationContext(<span class="hl-string">"conf/context.xml"</span>);</pre>

<pre class="programlisting">ApplicationContext ctx =
    <span class="hl-keyword">new</span> FileSystemXmlApplicationContext(<span class="hl-string">"/conf/context.xml"</span>);</pre>

<p>As are the following: (Even though it would make sense for them to be different, as one
case is relative and the other absolute.)</p>
<pre class="programlisting">FileSystemXmlApplicationContext ctx = ...;
ctx.getResource(<span class="hl-string">"some/resource/path/myTemplate.txt"</span>);</pre>

<pre class="programlisting">FileSystemXmlApplicationContext ctx = ...;
ctx.getResource(<span class="hl-string">"/some/resource/path/myTemplate.txt"</span>);</pre>

<p>In practice, if true absolute filesystem paths are needed, it is better to forgo the use
of absolute paths with <code class="literal">FileSystemResource</code> / <code class="literal">FileSystemXmlApplicationContext</code>, and
just force the use of a <code class="literal">UrlResource</code>, by using the <code class="literal">file:</code> URL prefix.</p>
<pre class="programlisting"><span class="hl-comment">// actual context type doesn't matter, the Resource will always be UrlResource</span>
ctx.getResource(<span class="hl-string">"file:/some/resource/path/myTemplate.txt"</span>);</pre>

<pre class="programlisting"><span class="hl-comment">// force this FileSystemXmlApplicationContext to load its definition via a UrlResource</span>
ApplicationContext ctx =
    <span class="hl-keyword">new</span> FileSystemXmlApplicationContext(<span class="hl-string">"file:/conf/context.xml"</span>);</pre>

</div>
</div>
</div>
<div class="chapter" title="6.&nbsp;Validation, Data Binding, and Type Conversion"><div class="titlepage"><div><div><h2 class="title"><a name="validation"></a>6.&nbsp;Validation, Data Binding, and Type Conversion</h2></div></div></div>

<div class="section" title="6.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="validation-introduction"></a>6.1&nbsp;Introduction</h2></div></div></div>

<div class="sidebar" title="JSR-303/JSR-349 Bean Validation"><p class="title"><b>JSR-303/JSR-349 Bean Validation</b></p>

<p>Spring Framework 4.0 supports Bean Validation 1.0 (JSR-303) and Bean Validation 1.1
(JSR-349) in terms of setup support, also adapting it to Spring&#8217;s <code class="literal">Validator</code> interface.</p>
<p>An application can choose to enable Bean Validation once globally, as described in
<a class="xref" href="#validation-beanvalidation" title="6.8&nbsp;Spring Validation">Section&nbsp;6.8, &#8220;Spring Validation&#8221;</a>, and use it exclusively for all validation needs.</p>
<p>An application can also register additional Spring <code class="literal">Validator</code> instances per
<code class="literal">DataBinder</code> instance, as described in <a class="xref" href="#validation-binder" title="6.8.3&nbsp;Configuring a DataBinder">Section&nbsp;6.8.3, &#8220;Configuring a DataBinder&#8221;</a>. This may be useful for
plugging in validation logic without the use of annotations.</p>
</div>

<p>There are pros and cons for considering validation as business logic, and Spring offers
a design for validation (and data binding) that does not exclude either one of them.
Specifically validation should not be tied to the web tier, should be easy to localize
and it should be possible to plug in any validator available. Considering the above,
Spring has come up with a <code class="literal">Validator</code> interface that is both basic ands eminently usable
in every layer of an application.</p>
<p>Data binding is useful for allowing user input to be dynamically bound to the domain
model of an application (or whatever objects you use to process user input). Spring
provides the so-called <code class="literal">DataBinder</code> to do exactly that. The <code class="literal">Validator</code> and the
<code class="literal">DataBinder</code> make up the <code class="literal">validation</code> package, which is primarily used in but not
limited to the MVC framework.</p>
<p>The <code class="literal">BeanWrapper</code> is a fundamental concept in the Spring Framework and is used in a lot
of places. However, you probably will not have the need to use the <code class="literal">BeanWrapper</code>
directly. Because this is reference documentation however, we felt that some explanation
might be in order. We will explain the <code class="literal">BeanWrapper</code> in this chapter since, if you were
going to use it at all, you would most likely do so when trying to bind data to objects.</p>
<p>Spring&#8217;s DataBinder and the lower-level BeanWrapper both use PropertyEditors to parse
and format property values. The <code class="literal">PropertyEditor</code> concept is part of the JavaBeans
specification, and is also explained in this chapter. Spring 3 introduces a
"core.convert" package that provides a general type conversion facility, as well as a
higher-level "format" package for formatting UI field values. These new packages may be
used as simpler alternatives to PropertyEditors, and will also be discussed in this
chapter.</p>
</div>
<div class="section" title="6.2&nbsp;Validation using Spring&#8217;s Validator interface"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="validator"></a>6.2&nbsp;Validation using Spring&#8217;s Validator interface</h2></div></div></div>

<p>Spring features a <code class="literal">Validator</code> interface that you can use to validate objects. The
<code class="literal">Validator</code> interface works using an <code class="literal">Errors</code> object so that while validating,
validators can report validation failures to the <code class="literal">Errors</code> object.</p>
<p>Let&#8217;s consider a small data object:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Person {

    <span class="hl-keyword">private</span> String name;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> age;

    <span class="hl-comment">// the usual getters and setters...</span>
}</pre>

<p>We&#8217;re going to provide validation behavior for the <code class="literal">Person</code> class by implementing the
following two methods of the <code class="literal">org.springframework.validation.Validator</code> interface:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">supports(Class)</code> - Can this <code class="literal">Validator</code> validate instances of the supplied <code class="literal">Class</code>?
</li><li class="listitem">
<code class="literal">validate(Object, org.springframework.validation.Errors)</code> - validates the given object
and in case of validation errors, registers those with the given <code class="literal">Errors</code> object
</li></ul></div>

<p>Implementing a <code class="literal">Validator</code> is fairly straightforward, especially when you know of the
<code class="literal">ValidationUtils</code> helper class that the Spring Framework also provides.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PersonValidator <span class="hl-keyword">implements</span> Validator {

    /<span class="strong"><strong>*
     * This Validator validates *just</strong></span> Person instances
     */
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> supports(Class clazz) {
        <span class="hl-keyword">return</span> Person.<span class="hl-keyword">class</span>.equals(clazz);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> validate(Object obj, Errors e) {
        ValidationUtils.rejectIfEmpty(e, <span class="hl-string">"name"</span>, <span class="hl-string">"name.empty"</span>);
        Person p = (Person) obj;
        <span class="hl-keyword">if</span> (p.getAge() &lt; <span class="hl-number">0</span>) {
            e.rejectValue(<span class="hl-string">"age"</span>, <span class="hl-string">"negativevalue"</span>);
        } <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (p.getAge() &gt; <span class="hl-number">110</span>) {
            e.rejectValue(<span class="hl-string">"age"</span>, <span class="hl-string">"too.darn.old"</span>);
        }
    }
}</pre>

<p>As you can see, the <code class="literal">static</code> <code class="literal">rejectIfEmpty(..)</code> method on the <code class="literal">ValidationUtils</code> class
is used to reject the <code class="literal">'name'</code> property if it is <code class="literal">null</code> or the empty string. Have a look
at the Javadoc for the <code class="literal">ValidationUtils</code> class to see what functionality it provides
besides the example shown previously.</p>
<p>While it is certainly possible to implement a single <code class="literal">Validator</code> class to validate each
of the nested objects in a rich object, it may be better to encapsulate the validation
logic for each nested class of object in its own <code class="literal">Validator</code> implementation. A simple
example of a <span class="emphasis"><em>'rich'</em></span> object would be a <code class="literal">Customer</code> that is composed of two <code class="literal">String</code>
properties (a first and second name) and a complex <code class="literal">Address</code> object. <code class="literal">Address</code> objects
may be used independently of <code class="literal">Customer</code> objects, and so a distinct <code class="literal">AddressValidator</code>
has been implemented. If you want your <code class="literal">CustomerValidator</code> to reuse the logic contained
within the <code class="literal">AddressValidator</code> class without resorting to copy-and-paste, you can
dependency-inject or instantiate an <code class="literal">AddressValidator</code> within your <code class="literal">CustomerValidator</code>,
and use it like so:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomerValidator <span class="hl-keyword">implements</span> Validator {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> Validator addressValidator;

    <span class="hl-keyword">public</span> CustomerValidator(Validator addressValidator) {
        <span class="hl-keyword">if</span> (addressValidator == null) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> IllegalArgumentException(<span class="hl-string">"The supplied [Validator] is "</span> +
                <span class="hl-string">"required and must not be null."</span>);
        }
        <span class="hl-keyword">if</span> (!addressValidator.supports(Address.<span class="hl-keyword">class</span>)) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> IllegalArgumentException(<span class="hl-string">"The supplied [Validator] must "</span> +
                support the validation of [Address] instances.<span class="hl-string">");
</span>        }
        <span class="hl-keyword">this</span>.addressValidator = addressValidator;
    }

    <b class="hl-tag" style="color: blue">/**
     * This Validator validates Customer instances, and any subclasses of Customer too
     */</b>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> supports(Class clazz) {
        <span class="hl-keyword">return</span> Customer.<span class="hl-keyword">class</span>.isAssignableFrom(clazz);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> validate(Object target, Errors errors) {
        ValidationUtils.rejectIfEmptyOrWhitespace(errors, <span class="hl-string">"firstName"</span>, <span class="hl-string">"field.required"</span>);
        ValidationUtils.rejectIfEmptyOrWhitespace(errors, <span class="hl-string">"surname"</span>, <span class="hl-string">"field.required"</span>);
        Customer customer = (Customer) target;
        <span class="hl-keyword">try</span> {
            errors.pushNestedPath(<span class="hl-string">"address"</span>);
            ValidationUtils.invokeValidator(<span class="hl-keyword">this</span>.addressValidator, customer.getAddress(), errors);
        } <span class="hl-keyword">finally</span> {
            errors.popNestedPath();
        }
    }
}</pre>

<p>Validation errors are reported to the <code class="literal">Errors</code> object passed to the validator. In case
of Spring Web MVC you can use <code class="literal">&lt;spring:bind/&gt;</code> tag to inspect the error messages, but of
course you can also inspect the errors object yourself. More information about the
methods it offers can be found from the Javadoc.</p>
</div>
<div class="section" title="6.3&nbsp;Resolving codes to error messages"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="validation-conversion"></a>6.3&nbsp;Resolving codes to error messages</h2></div></div></div>

<p>We&#8217;ve talked about databinding and validation. Outputting messages corresponding to
validation errors is the last thing we need to discuss. In the example we&#8217;ve shown
above, we rejected the <code class="literal">name</code> and the <code class="literal">age</code> field. If we&#8217;re going to output the error
messages by using a <code class="literal">MessageSource</code>, we will do so using the error code we&#8217;ve given when
rejecting the field (<span class="emphasis"><em>name</em></span> and <span class="emphasis"><em>age</em></span> in this case). When you call (either directly, or
indirectly, using for example the <code class="literal">ValidationUtils</code> class) <code class="literal">rejectValue</code> or one of the
other <code class="literal">reject</code> methods from the <code class="literal">Errors</code> interface, the underlying implementation will
not only register the code you&#8217;ve passed in, but also a number of additional error
codes. What error codes it registers is determined by the <code class="literal">MessageCodesResolver</code> that is
used. By default, the <code class="literal">DefaultMessageCodesResolver</code> is used, which for example not only
registers a message with the code you gave, but also messages that include the field
name you passed to the reject method. So in case you reject a field using
<code class="literal">rejectValue("age", "too.darn.old")</code>, apart from the <code class="literal">too.darn.old</code> code, Spring will
also register <code class="literal">too.darn.old.age</code> and <code class="literal">too.darn.old.age.int</code> (so the first will include
the field name and the second will include the type of the field); this is done as a
convenience to aid developers in targeting error messages and suchlike.</p>
<p>More information on the <code class="literal">MessageCodesResolver</code> and the default strategy can be found
online with the Javadocs for
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/validation/MessageCodesResolver.html" target="_top"><code class="literal">MessageCodesResolver</code></a>
and
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/validation/DefaultMessageCodesResolver.html" target="_top"><code class="literal">DefaultMessageCodesResolver</code></a>
respectively.</p>
</div>
<div class="section" title="6.4&nbsp;Bean manipulation and the BeanWrapper"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="beans-beans"></a>6.4&nbsp;Bean manipulation and the BeanWrapper</h2></div></div></div>

<p>The <code class="literal">org.springframework.beans</code> package adheres to the JavaBeans standard provided by
Oracle. A JavaBean is simply a class with a default no-argument constructor, which follows
a naming convention where (by way of an example) a property named <code class="literal">bingoMadness</code> would
have a setter method <code class="literal">setBingoMadness(..)</code> and a getter method <code class="literal">getBingoMadness()</code>. For
more information about JavaBeans and the specification, please refer to Oracle&#8217;s website (
<a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/java/beans/package-summary.html" target="_top">javabeans</a>).</p>
<p>One quite important class in the beans package is the <code class="literal">BeanWrapper</code> interface and its
corresponding implementation ( <code class="literal">BeanWrapperImpl</code>). As quoted from the Javadoc, the
<code class="literal">BeanWrapper</code> offers functionality to set and get property values (individually or in
bulk), get property descriptors, and to query properties to determine if they are
readable or writable. Also, the <code class="literal">BeanWrapper</code> offers support for nested properties,
enabling the setting of properties on sub-properties to an unlimited depth. Then, the
<code class="literal">BeanWrapper</code> supports the ability to add standard JavaBeans <code class="literal">PropertyChangeListeners</code>
and <code class="literal">VetoableChangeListeners</code>, without the need for supporting code in the target class.
Last but not least, the <code class="literal">BeanWrapper</code> provides support for the setting of indexed
properties. The <code class="literal">BeanWrapper</code> usually isn&#8217;t used by application code directly, but by
the <code class="literal">DataBinder</code> and the <code class="literal">BeanFactory</code>.</p>
<p>The way the <code class="literal">BeanWrapper</code> works is partly indicated by its name: <span class="emphasis"><em>it wraps a bean</em></span> to
perform actions on that bean, like setting and retrieving properties.</p>
<div class="section" title="6.4.1&nbsp;Setting and getting basic and nested properties"><div class="titlepage"><div><div><h3 class="title"><a name="beans-beans-conventions"></a>6.4.1&nbsp;Setting and getting basic and nested properties</h3></div></div></div>

<p>Setting and getting properties is done using the <code class="literal">setPropertyValue(s)</code> and
<code class="literal">getPropertyValue(s)</code> methods that both come with a couple of overloaded variants.
They&#8217;re all described in more detail in the Javadoc Spring comes with. What&#8217;s important
to know is that there are a couple of conventions for indicating properties of an
object. A couple of examples:</p>
<div class="table"><a name="beans-beans-conventions-properties-tbl"></a><p class="title"><b>Table&nbsp;6.1.&nbsp;Examples of properties</b></p><div class="table-contents">

  <table summary="Examples of properties" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Expression</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">name</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates the property <code class="literal">name</code> corresponding to the methods <code class="literal">getName()</code> or <code class="literal">isName()</code>
  and <code class="literal">setName(..)</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">account.name</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates the nested property <code class="literal">name</code> of the property <code class="literal">account</code> corresponding e.g. to
  the methods <code class="literal">getAccount().setName()</code> or <code class="literal">getAccount().getName()</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">account[2]</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates the <span class="emphasis"><em>third</em></span> element of the indexed property <code class="literal">account</code>. Indexed properties
  can be of type <code class="literal">array</code>, <code class="literal">list</code> or other <span class="emphasis"><em>naturally ordered</em></span> collection</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">account[COMPANYNAME]</code></p></td><td style="" align="left" valign="top"><p>Indicates the value of the map entry indexed by the key <span class="emphasis"><em>COMPANYNAME</em></span> of the Map
  property <code class="literal">account</code></p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>Below you&#8217;ll find some examples of working with the <code class="literal">BeanWrapper</code> to get and set
properties.</p>
<p><span class="emphasis"><em>(This next section is not vitally important to you if you&#8217;re not planning to work with
the <code class="literal">BeanWrapper</code> directly. If you&#8217;re just using the <code class="literal">DataBinder</code> and the <code class="literal">BeanFactory</code>
and their out-of-the-box implementation, you should skip ahead to the section about
<code class="literal">PropertyEditors</code>.)</em></span></p>
<p>Consider the following two classes:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Company {

    <span class="hl-keyword">private</span> String name;
    <span class="hl-keyword">private</span> Employee managingDirector;

    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

    <span class="hl-keyword">public</span> Employee getManagingDirector() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.managingDirector;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setManagingDirector(Employee managingDirector) {
        <span class="hl-keyword">this</span>.managingDirector = managingDirector;
    }
}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Employee {

    <span class="hl-keyword">private</span> String name;

    <span class="hl-keyword">private</span> <span class="hl-keyword">float</span> salary;

    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">float</span> getSalary() {
        <span class="hl-keyword">return</span> salary;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSalary(<span class="hl-keyword">float</span> salary) {
        <span class="hl-keyword">this</span>.salary = salary;
    }
}</pre>

<p>The following code snippets show some examples of how to retrieve and manipulate some of
the properties of instantiated <code class="literal">Companies</code> and <code class="literal">Employees</code>:</p>
<pre class="programlisting">BeanWrapper company = BeanWrapperImpl(<span class="hl-keyword">new</span> Company());
<span class="hl-comment">// setting the company name..</span>
company.setPropertyValue(<span class="hl-string">"name"</span>, <span class="hl-string">"Some Company Inc."</span>);
<span class="hl-comment">// ... can also be done like this:</span>
PropertyValue value = <span class="hl-keyword">new</span> PropertyValue(<span class="hl-string">"name"</span>, <span class="hl-string">"Some Company Inc."</span>);
company.setPropertyValue(value);

<span class="hl-comment">// ok, let's create the director and tie it to the company:</span>
BeanWrapper jim = BeanWrapperImpl(<span class="hl-keyword">new</span> Employee());
jim.setPropertyValue(<span class="hl-string">"name"</span>, <span class="hl-string">"Jim Stravinsky"</span>);
company.setPropertyValue(<span class="hl-string">"managingDirector"</span>, jim.getWrappedInstance());

<span class="hl-comment">// retrieving the salary of the managingDirector through the company</span>
Float salary = (Float) company.getPropertyValue(<span class="hl-string">"managingDirector.salary"</span>);</pre>

</div>
<div class="section" title="6.4.2&nbsp;Built-in PropertyEditor implementations"><div class="titlepage"><div><div><h3 class="title"><a name="beans-beans-conversion"></a>6.4.2&nbsp;Built-in PropertyEditor implementations</h3></div></div></div>

<p>Spring uses the concept of <code class="literal">PropertyEditors</code> to effect the conversion between an
<code class="literal">Object</code> and a <code class="literal">String</code>. If you think about it, it sometimes might be handy to be able
to represent properties in a different way than the object itself. For example, a <code class="literal">Date</code>
can be represented in a human readable way (as the <code class="literal">String</code> ' <code class="literal">2007-14-09</code>'), while
we&#8217;re still able to convert the human readable form back to the original date (or even
better: convert any date entered in a human readable form, back to <code class="literal">Date</code> objects). This
behavior can be achieved by <span class="emphasis"><em>registering custom editors</em></span>, of type
<code class="literal">java.beans.PropertyEditor</code>. Registering custom editors on a <code class="literal">BeanWrapper</code> or
alternately in a specific IoC container as mentioned in the previous chapter, gives it
the knowledge of how to convert properties to the desired type. Read more about
<code class="literal">PropertyEditors</code> in the Javadoc of the <code class="literal">java.beans</code> package provided by Oracle.</p>
<p>A couple of examples where property editing is used in Spring:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>setting properties on beans</em></span> is done using <code class="literal">PropertyEditors</code>. When mentioning
<code class="literal">java.lang.String</code> as the value of a property of some bean you&#8217;re declaring in XML
file, Spring will (if the setter of the corresponding property has a
<code class="literal">Class</code>-parameter) use the <code class="literal">ClassEditor</code> to try to resolve the parameter to a <code class="literal">Class</code>
object.
</li><li class="listitem">
<span class="emphasis"><em>parsing HTTP request parameters</em></span> in Spring&#8217;s MVC framework is done using all kinds
of <code class="literal">PropertyEditors</code> that you can manually bind in all subclasses of the
<code class="literal">CommandController</code>.
</li></ul></div>

<p>Spring has a number of built-in <code class="literal">PropertyEditors</code> to make life easy. Each of those is
listed below and they are all located in the <code class="literal">org.springframework.beans.propertyeditors</code>
package. Most, but not all (as indicated below), are registered by default by
<code class="literal">BeanWrapperImpl</code>. Where the property editor is configurable in some fashion, you can of
course still register your own variant to override the default one:</p>
<div class="table"><a name="beans-beans-property-editors-tbl"></a><p class="title"><b>Table&nbsp;6.2.&nbsp;Built-in PropertyEditors</b></p><div class="table-contents">

  <table summary="Built-in PropertyEditors" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Class</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ByteArrayPropertyEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Editor for byte arrays. Strings will simply be converted to their corresponding byte
  representations. Registered by default by <code class="literal">BeanWrapperImpl</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ClassEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Parses Strings representing classes to actual classes and the other way around. When a
  class is not found, an <code class="literal">IllegalArgumentException</code> is thrown. Registered by default by
  <code class="literal">BeanWrapperImpl</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">CustomBooleanEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Customizable property editor for <code class="literal">Boolean</code> properties. Registered by default by
  <code class="literal">BeanWrapperImpl</code>, but, can be overridden by registering custom instance of it as
  custom editor.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">CustomCollectionEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Property editor for Collections, converting any source <code class="literal">Collection</code> to a given target
  <code class="literal">Collection</code> type.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">CustomDateEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Customizable property editor for java.util.Date, supporting a custom DateFormat. NOT
  registered by default. Must be user registered as needed with appropriate format.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">CustomNumberEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Customizable property editor for any Number subclass like <code class="literal">Integer</code>, <code class="literal">Long</code>, <code class="literal">Float</code>,
  <code class="literal">Double</code>. Registered by default by <code class="literal">BeanWrapperImpl</code>, but can be overridden by
  registering custom instance of it as a custom editor.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">FileEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Capable of resolving Strings to <code class="literal">java.io.File</code> objects. Registered by default by
  <code class="literal">BeanWrapperImpl</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">InputStreamEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>One-way property editor, capable of taking a text string and producing (via an
  intermediate <code class="literal">ResourceEditor</code> and <code class="literal">Resource</code>) an <code class="literal">InputStream</code>, so <code class="literal">InputStream</code>
  properties may be directly set as Strings. Note that the default usage will not close
  the <code class="literal">InputStream</code> for you! Registered by default by <code class="literal">BeanWrapperImpl</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">LocaleEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Capable of resolving Strings to <code class="literal">Locale</code> objects and vice versa (the String format is
  <span class="emphasis"><em><span class="language">[country]</span></em></span>[variant], which is the same thing the toString() method of
  Locale provides). Registered by default by <code class="literal">BeanWrapperImpl</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PatternEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Capable of resolving Strings to JDK 1.5 <code class="literal">Pattern</code> objects and vice versa.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PropertiesEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Capable of converting Strings (formatted using the format as defined in the Javadoc
  for the java.lang.Properties class) to <code class="literal">Properties</code> objects. Registered by default by
  <code class="literal">BeanWrapperImpl</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">StringTrimmerEditor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Property editor that trims Strings. Optionally allows transforming an empty string
  into a <code class="literal">null</code> value. NOT registered by default; must be user registered as needed.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">URLEditor</code></p></td><td style="" align="left" valign="top"><p>Capable of resolving a String representation of a URL to an actual <code class="literal">URL</code> object.
  Registered by default by <code class="literal">BeanWrapperImpl</code>.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>Spring uses the <code class="literal">java.beans.PropertyEditorManager</code> to set the search path for property
editors that might be needed. The search path also includes <code class="literal">sun.bean.editors</code>, which
includes <code class="literal">PropertyEditor</code> implementations for types such as <code class="literal">Font</code>, <code class="literal">Color</code>, and most of
the primitive types. Note also that the standard JavaBeans infrastructure will
automatically discover <code class="literal">PropertyEditor</code> classes (without you having to register them
explicitly) if they are in the same package as the class they handle, and have the same
name as that class, with <code class="literal">'Editor'</code> appended; for example, one could have the following
class and package structure, which would be sufficient for the <code class="literal">FooEditor</code> class to be
recognized and used as the <code class="literal">PropertyEditor</code> for <code class="literal">Foo</code>-typed properties.</p>

<pre class="literallayout">com
  chank
    pop
      Foo
      FooEditor // the PropertyEditor for the Foo class</pre>

<p>Note that you can also use the standard <code class="literal">BeanInfo</code> JavaBeans mechanism here as well
(described
<a class="ulink" href="http://docs.oracle.com/javase/tutorial/javabeans/advanced/customization.html" target="_top">in
not-amazing-detail here</a>). Find below an example of using the <code class="literal">BeanInfo</code> mechanism for
explicitly registering one or more <code class="literal">PropertyEditor</code> instances with the properties of an
associated class.</p>

<pre class="literallayout">com
  chank
    pop
      Foo
      FooBeanInfo // the BeanInfo for the Foo class</pre>

<p>Here is the Java source code for the referenced <code class="literal">FooBeanInfo</code> class. This would
associate a <code class="literal">CustomNumberEditor</code> with the <code class="literal">age</code> property of the <code class="literal">Foo</code> class.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FooBeanInfo <span class="hl-keyword">extends</span> SimpleBeanInfo {

    <span class="hl-keyword">public</span> PropertyDescriptor[] getPropertyDescriptors() {
        <span class="hl-keyword">try</span> {
            <span class="hl-keyword">final</span> PropertyEditor numberPE = <span class="hl-keyword">new</span> CustomNumberEditor(Integer.<span class="hl-keyword">class</span>, true);
            PropertyDescriptor ageDescriptor = <span class="hl-keyword">new</span> PropertyDescriptor(<span class="hl-string">"age"</span>, Foo.<span class="hl-keyword">class</span>) {
                <span class="hl-keyword">public</span> PropertyEditor createPropertyEditor(Object bean) {
                    <span class="hl-keyword">return</span> numberPE;
                };
            };
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> PropertyDescriptor[] { ageDescriptor };
        }
        <span class="hl-keyword">catch</span> (IntrospectionException ex) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> Error(ex.toString());
        }
    }
}</pre>

<div class="section" title="Registering additional custom PropertyEditors"><div class="titlepage"><div><div><h4 class="title"><a name="beans-beans-conversion-customeditor-registration"></a>Registering additional custom PropertyEditors</h4></div></div></div>

<p>When setting bean properties as a string value, a Spring IoC container ultimately uses
standard JavaBeans <code class="literal">PropertyEditors</code> to convert these Strings to the complex type of the
property. Spring pre-registers a number of custom <code class="literal">PropertyEditors</code> (for example, to
convert a classname expressed as a string into a real <code class="literal">Class</code> object). Additionally,
Java&#8217;s standard JavaBeans <code class="literal">PropertyEditor</code> lookup mechanism allows a <code class="literal">PropertyEditor</code>
for a class simply to be named appropriately and placed in the same package as the class
it provides support for, to be found automatically.</p>
<p>If there is a need to register other custom <code class="literal">PropertyEditors</code>, there are several
mechanisms available. The most manual approach, which is not normally convenient or
recommended, is to simply use the <code class="literal">registerCustomEditor()</code> method of the
<code class="literal">ConfigurableBeanFactory</code> interface, assuming you have a <code class="literal">BeanFactory</code> reference.
Another, slightly more convenient, mechanism is to use a special bean factory
post-processor called <code class="literal">CustomEditorConfigurer</code>. Although bean factory post-processors
can be used with <code class="literal">BeanFactory</code> implementations, the <code class="literal">CustomEditorConfigurer</code> has a
nested property setup, so it is strongly recommended that it is used with the
<code class="literal">ApplicationContext</code>, where it may be deployed in similar fashion to any other bean, and
automatically detected and applied.</p>
<p>Note that all bean factories and application contexts automatically use a number of
built-in property editors, through their use of something called a <code class="literal">BeanWrapper</code> to
handle property conversions. The standard property editors that the <code class="literal">BeanWrapper</code>
registers are listed in <a class="link" href="#beans-beans-conversion" title="6.4.2&nbsp;Built-in PropertyEditor implementations">the previous section</a>. Additionally,
<code class="literal">ApplicationContexts</code> also override or add an additional number of editors to handle
resource lookups in a manner appropriate to the specific application context type.</p>
<p>Standard JavaBeans <code class="literal">PropertyEditor</code> instances are used to convert property values
expressed as strings to the actual complex type of the property.
<code class="literal">CustomEditorConfigurer</code>, a bean factory post-processor, may be used to conveniently add
support for additional <code class="literal">PropertyEditor</code> instances to an <code class="literal">ApplicationContext</code>.</p>
<p>Consider a user class <code class="literal">ExoticType</code>, and another class <code class="literal">DependsOnExoticType</code> which needs
<code class="literal">ExoticType</code> set as a property:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> example;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExoticType {

    <span class="hl-keyword">private</span> String name;

    <span class="hl-keyword">public</span> ExoticType(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DependsOnExoticType {

    <span class="hl-keyword">private</span> ExoticType type;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setType(ExoticType type) {
        <span class="hl-keyword">this</span>.type = type;
    }
}</pre>

<p>When things are properly set up, we want to be able to assign the type property as a
string, which a <code class="literal">PropertyEditor</code> will behind the scenes convert into an actual
<code class="literal">ExoticType</code> instance:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sample"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.DependsOnExoticType"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"type"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"aNameForExoticType"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">PropertyEditor</code> implementation could look similar to this:</p>
<pre class="programlisting"><span class="hl-comment">// converts string representation to ExoticType object</span>
<span class="hl-keyword">package</span> example;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExoticTypeEditor <span class="hl-keyword">extends</span> PropertyEditorSupport {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setAsText(String text) {
        setValue(<span class="hl-keyword">new</span> ExoticType(text.toUpperCase()));
    }
}</pre>

<p>Finally, we use <code class="literal">CustomEditorConfigurer</code> to register the new <code class="literal">PropertyEditor</code> with the
<code class="literal">ApplicationContext</code>, which will then be able to use it as needed:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.CustomEditorConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"customEditors"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"example.ExoticType"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.ExoticTypeEditor"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="section" title="Using PropertyEditorRegistrars"><div class="titlepage"><div><div><h5 class="title"><a name="beans-beans-conversion-customeditor-registration-per"></a>Using PropertyEditorRegistrars</h5></div></div></div>

<p>Another mechanism for registering property editors with the Spring container is to
create and use a <code class="literal">PropertyEditorRegistrar</code>. This interface is particularly useful when
you need to use the same set of property editors in several different situations: write
a corresponding registrar and reuse that in each case. <code class="literal">PropertyEditorRegistrars</code> work
in conjunction with an interface called <code class="literal">PropertyEditorRegistry</code>, an interface that is
implemented by the Spring <code class="literal">BeanWrapper</code> (and <code class="literal">DataBinder</code>). <code class="literal">PropertyEditorRegistrars</code>
are particularly convenient when used in conjunction with the <code class="literal">CustomEditorConfigurer</code>
(introduced <a class="link" href="#beans-beans-conversion-customeditor-registration" title="Registering additional custom PropertyEditors">here</a>), which exposes a
property called <code class="literal">setPropertyEditorRegistrars(..)</code>: <code class="literal">PropertyEditorRegistrars</code> added to a
<code class="literal">CustomEditorConfigurer</code> in this fashion can easily be shared with <code class="literal">DataBinder</code> and
Spring MVC <code class="literal">Controllers</code>. Furthermore, it avoids the need for synchronization on custom
editors: a <code class="literal">PropertyEditorRegistrar</code> is expected to create fresh <code class="literal">PropertyEditor</code>
instances for each bean creation attempt.</p>
<p>Using a <code class="literal">PropertyEditorRegistrar</code> is perhaps best illustrated with an example. First
off, you need to create your own <code class="literal">PropertyEditorRegistrar</code> implementation:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo.editors.spring;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> CustomPropertyEditorRegistrar <span class="hl-keyword">implements</span> PropertyEditorRegistrar {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerCustomEditors(PropertyEditorRegistry registry) {

        <span class="hl-comment">// it is expected that new PropertyEditor instances are created</span>
        registry.registerCustomEditor(ExoticType.<span class="hl-keyword">class</span>, <span class="hl-keyword">new</span> ExoticTypeEditor());

        <span class="hl-comment">// you could register as many custom property editors as are required here...</span>
    }
}</pre>

<p>See also the <code class="literal">org.springframework.beans.support.ResourceEditorRegistrar</code> for an example
<code class="literal">PropertyEditorRegistrar</code> implementation. Notice how in its implementation of the
<code class="literal">registerCustomEditors(..)</code> method it creates new instances of each property editor.</p>
<p>Next we configure a <code class="literal">CustomEditorConfigurer</code> and inject an instance of our
<code class="literal">CustomPropertyEditorRegistrar</code> into it:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.CustomEditorConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"propertyEditorRegistrars"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"customPropertyEditorRegistrar"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customPropertyEditorRegistrar"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.editors.spring.CustomPropertyEditorRegistrar"</span><span class="hl-tag">/&gt;</span></pre>

<p>Finally, and in a bit of a departure from the focus of this chapter, for those of you
using <a class="link" href="#mvc" title="16.&nbsp;Web MVC framework">Spring&#8217;s MVC web framework</a>, using <code class="literal">PropertyEditorRegistrars</code> in
conjunction with data-binding <code class="literal">Controllers</code> (such as <code class="literal">SimpleFormController</code>) can be very
convenient. Find below an example of using a <code class="literal">PropertyEditorRegistrar</code> in the
implementation of an <code class="literal">initBinder(..)</code> method:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> RegisterUserController <span class="hl-keyword">extends</span> SimpleFormController {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> PropertyEditorRegistrar customPropertyEditorRegistrar;

    <span class="hl-keyword">public</span> RegisterUserController(PropertyEditorRegistrar propertyEditorRegistrar) {
        <span class="hl-keyword">this</span>.customPropertyEditorRegistrar = propertyEditorRegistrar;
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> initBinder(HttpServletRequest request,
            ServletRequestDataBinder binder) <span class="hl-keyword">throws</span> Exception {
        <span class="strong"><strong>this.customPropertyEditorRegistrar.registerCustomEditors(binder);</strong></span>
    }

    <span class="hl-comment">// other methods to do with registering a User</span>
}</pre>

<p>This style of <code class="literal">PropertyEditor</code> registration can lead to concise code (the implementation
of <code class="literal">initBinder(..)</code> is just one line long!), and allows common <code class="literal">PropertyEditor</code>
registration code to be encapsulated in a class and then shared amongst as many
<code class="literal">Controllers</code> as needed.</p>
</div>
</div>
</div>
</div>
<div class="section" title="6.5&nbsp;Spring Type Conversion"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="core-convert"></a>6.5&nbsp;Spring Type Conversion</h2></div></div></div>

<p>Spring 3 introduces a <code class="literal">core.convert</code> package that provides a general type conversion
system. The system defines an SPI to implement type conversion logic, as well as an API
to execute type conversions at runtime. Within a Spring container, this system can be
used as an alternative to PropertyEditors to convert externalized bean property value
strings to required property types. The public API may also be used anywhere in your
application where type conversion is needed.</p>
<div class="section" title="6.5.1&nbsp;Converter SPI"><div class="titlepage"><div><div><h3 class="title"><a name="core-convert-Converter-API"></a>6.5.1&nbsp;Converter SPI</h3></div></div></div>

<p>The SPI to implement type conversion logic is simple and strongly typed:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.core.convert.converter;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Converter&lt;S, T&gt; {

    T convert(S source);

}</pre>

<p>To create your own Converter, simply implement the interface above. Parameterize S as
the type you are converting from, and T as the type you are converting to. For each call
to convert(S), the source argument is guaranteed to be NOT null. Your Converter may
throw any Exception if conversion fails. An IllegalArgumentException should be thrown to
report an invalid source value. Take care to ensure your Converter implementation is
thread-safe.</p>
<p>Several converter implementations are provided in the <code class="literal">core.convert.support</code> package as
a convenience. These include converters from Strings to Numbers and other common types.
Consider <code class="literal">StringToInteger</code> as an example Converter implementation:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.core.convert.support;

<span class="hl-keyword">final</span> <span class="hl-keyword">class</span> StringToInteger <span class="hl-keyword">implements</span> Converter&lt;String, Integer&gt; {

    <span class="hl-keyword">public</span> Integer convert(String source) {
        <span class="hl-keyword">return</span> Integer.valueOf(source);
    }

}</pre>

</div>
<div class="section" title="6.5.2&nbsp;ConverterFactory"><div class="titlepage"><div><div><h3 class="title"><a name="core-convert-ConverterFactory-SPI"></a>6.5.2&nbsp;ConverterFactory</h3></div></div></div>

<p>When you need to centralize the conversion logic for an entire class hierarchy, for
example, when converting from String to java.lang.Enum objects, implement
<code class="literal">ConverterFactory</code>:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.core.convert.converter;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ConverterFactory&lt;S, R&gt; {

    &lt;T <span class="hl-keyword">extends</span> R&gt; Converter&lt;S, T&gt; getConverter(Class&lt;T&gt; targetType);

}</pre>

<p>Parameterize S to be the type you are converting from and R to be the base type defining
the <span class="emphasis"><em>range</em></span> of classes you can convert to. Then implement getConverter(Class&lt;T&gt;),
where T is a subclass of R.</p>
<p>Consider the <code class="literal">StringToEnum</code> ConverterFactory as an example:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.core.convert.support;

<span class="hl-keyword">final</span> <span class="hl-keyword">class</span> StringToEnumConverterFactory <span class="hl-keyword">implements</span> ConverterFactory&lt;String, Enum&gt; {

    <span class="hl-keyword">public</span> &lt;T <span class="hl-keyword">extends</span> Enum&gt; Converter&lt;String, T&gt; getConverter(Class&lt;T&gt; targetType) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StringToEnumConverter(targetType);
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> StringToEnumConverter&lt;T <span class="hl-keyword">extends</span> Enum&gt; <span class="hl-keyword">implements</span> Converter&lt;String, T&gt; {

        <span class="hl-keyword">private</span> Class&lt;T&gt; enumType;

        <span class="hl-keyword">public</span> StringToEnumConverter(Class&lt;T&gt; enumType) {
            <span class="hl-keyword">this</span>.enumType = enumType;
        }

        <span class="hl-keyword">public</span> T convert(String source) {
            <span class="hl-keyword">return</span> (T) Enum.valueOf(<span class="hl-keyword">this</span>.enumType, source.trim());
        }
    }
}</pre>

</div>
<div class="section" title="6.5.3&nbsp;GenericConverter"><div class="titlepage"><div><div><h3 class="title"><a name="core-convert-GenericConverter-SPI"></a>6.5.3&nbsp;GenericConverter</h3></div></div></div>

<p>When you require a sophisticated Converter implementation, consider the GenericConverter
interface. With a more flexible but less strongly typed signature, a GenericConverter
supports converting between multiple source and target types. In addition, a
GenericConverter makes available source and target field context you can use when
implementing your conversion logic. Such context allows a type conversion to be driven
by a field annotation, or generic information declared on a field signature.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.core.convert.converter;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> GenericConverter {

    <span class="hl-keyword">public</span> Set&lt;ConvertiblePair&gt; getConvertibleTypes();

    Object convert(Object source, TypeDescriptor sourceType, TypeDescriptor targetType);

}</pre>

<p>To implement a GenericConverter, have getConvertibleTypes() return the supported
source&#8594;target type pairs. Then implement convert(Object, TypeDescriptor,
TypeDescriptor) to implement your conversion logic. The source TypeDescriptor provides
access to the source field holding the value being converted. The target TypeDescriptor
provides access to the target field where the converted value will be set.</p>
<p>A good example of a GenericConverter is a converter that converts between a Java Array
and a Collection. Such an ArrayToCollectionConverter introspects the field that declares
the target Collection type to resolve the Collection&#8217;s element type. This allows each
element in the source array to be converted to the Collection element type before the
Collection is set on the target field.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Because GenericConverter is a more complex SPI interface, only use it when you need it.
Favor Converter or ConverterFactory for basic type conversion needs.</p>
</td></tr></table></div>

<div class="section" title="ConditionalGenericConverter"><div class="titlepage"><div><div><h4 class="title"><a name="core-convert-ConditionalGenericConverter-SPI"></a>ConditionalGenericConverter</h4></div></div></div>

<p>Sometimes you only want a Converter to execute if a specific condition holds true. For
example, you might only want to execute a Converter if a specific annotation is present
on the target field. Or you might only want to execute a Converter if a specific method,
such as static valueOf method, is defined on the target class.
ConditionalGenericConverter is an subinterface of GenericConverter that allows you to
define such custom matching criteria:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ConditionalGenericConverter <span class="hl-keyword">extends</span> GenericConverter {

    <span class="hl-keyword">boolean</span> matches(TypeDescriptor sourceType, TypeDescriptor targetType);

}</pre>

<p>A good example of a ConditionalGenericConverter is an EntityConverter that converts
between an persistent entity identifier and an entity reference. Such a EntityConverter
might only match if the target entity type declares a static finder method e.g.
findAccount(Long). You would perform such a finder method check in the implementation of
matches(TypeDescriptor, TypeDescriptor).</p>
</div>
</div>
<div class="section" title="6.5.4&nbsp;ConversionService API"><div class="titlepage"><div><div><h3 class="title"><a name="core-convert-ConversionService-API"></a>6.5.4&nbsp;ConversionService API</h3></div></div></div>

<p>The ConversionService defines a unified API for executing type conversion logic at
runtime. Converters are often executed behind this facade interface:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.core.convert;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ConversionService {

    <span class="hl-keyword">boolean</span> canConvert(Class&lt;?&gt; sourceType, Class&lt;?&gt; targetType);

    &lt;T&gt; T convert(Object source, Class&lt;T&gt; targetType);

    <span class="hl-keyword">boolean</span> canConvert(TypeDescriptor sourceType, TypeDescriptor targetType);

    Object convert(Object source, TypeDescriptor sourceType, TypeDescriptor targetType);

}</pre>

<p>Most ConversionService implementations also implement <code class="literal">ConverterRegistry</code>, which
provides an SPI for registering converters. Internally, a ConversionService
implementation delegates to its registered converters to carry out type conversion logic.</p>
<p>A robust ConversionService implementation is provided in the <code class="literal">core.convert.support</code>
package. <code class="literal">GenericConversionService</code> is the general-purpose implementation suitable for
use in most environments. <code class="literal">ConversionServiceFactory</code> provides a convenient factory for
creating common ConversionService configurations.</p>
</div>
<div class="section" title="6.5.5&nbsp;Configuring a ConversionService"><div class="titlepage"><div><div><h3 class="title"><a name="core-convert-Spring-config"></a>6.5.5&nbsp;Configuring a ConversionService</h3></div></div></div>

<p>A ConversionService is a stateless object designed to be instantiated at application
startup, then shared between multiple threads. In a Spring application, you typically
configure a ConversionService instance per Spring container (or ApplicationContext).
That ConversionService will be picked up by Spring and then used whenever a type
conversion needs to be performed by the framework. You may also inject this
ConversionService into any of your beans and invoke it directly.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If no ConversionService is registered with Spring, the original PropertyEditor-based
system is used.</p>
</td></tr></table></div>

<p>To register a default ConversionService with Spring, add the following bean definition
with id <code class="literal">conversionService</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"conversionService"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.context.support.ConversionServiceFactoryBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>A default ConversionService can convert between strings, numbers, enums, collections,
maps, and other common types. To supplement or override the default converters with your
own custom converter(s), set the <code class="literal">converters</code> property. Property values may implement
either of the Converter, ConverterFactory, or GenericConverter interfaces.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"conversionService"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.context.support.ConversionServiceFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"converters"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;set&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.MyCustomConverter"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/set&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>It is also common to use a ConversionService within a Spring MVC application. See
<a class="xref" href="#format-configuring-formatting-mvc" title="6.6.5&nbsp;Configuring Formatting in Spring MVC">Section&nbsp;6.6.5, &#8220;Configuring Formatting in Spring MVC&#8221;</a> for details on use with <code class="literal">&lt;mvc:annotation-driven/&gt;</code>.</p>
<p>In certain situations you may wish to apply formatting during conversion. See
<a class="xref" href="#format-FormatterRegistry-SPI" title="6.6.3&nbsp;FormatterRegistry SPI">Section&nbsp;6.6.3, &#8220;FormatterRegistry SPI&#8221;</a> for details on using
<code class="literal">FormattingConversionServiceFactoryBean</code>.</p>
</div>
<div class="section" title="6.5.6&nbsp;Using a ConversionService programmatically"><div class="titlepage"><div><div><h3 class="title"><a name="core-convert-programmatic-usage"></a>6.5.6&nbsp;Using a ConversionService programmatically</h3></div></div></div>

<p>To work with a ConversionService instance programmatically, simply inject a reference to
it like you would for any other bean:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Service</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyService {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> MyService(ConversionService conversionService) {
        <span class="hl-keyword">this</span>.conversionService = conversionService;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doIt() {
        <span class="hl-keyword">this</span>.conversionService.convert(...)
    }
}</pre>

</div>
</div>
<div class="section" title="6.6&nbsp;Spring Field Formatting"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="format"></a>6.6&nbsp;Spring Field Formatting</h2></div></div></div>

<p>As discussed in the previous section, <a class="link" href="#core-convert" title="6.5&nbsp;Spring Type Conversion"><code class="literal">core.convert</code></a> is a
general-purpose type conversion system. It provides a unified ConversionService API as
well as a strongly-typed Converter SPI for implementing conversion logic from one type
to another. A Spring Container uses this system to bind bean property values. In
addition, both the Spring Expression Language (SpEL) and DataBinder use this system to
bind field values. For example, when SpEL needs to coerce a <code class="literal">Short</code> to a <code class="literal">Long</code> to
complete an <code class="literal">expression.setValue(Object bean, Object value)</code> attempt, the core.convert
system performs the coercion.</p>
<p>Now consider the type conversion requirements of a typical client environment such as a
web or desktop application. In such environments, you typically convert <span class="emphasis"><em>from String</em></span>
to support the client postback process, as well as back <span class="emphasis"><em>to String</em></span> to support the
view rendering process. In addition, you often need to localize String values. The more
general <span class="emphasis"><em>core.convert</em></span> Converter SPI does not address such <span class="emphasis"><em>formatting</em></span> requirements
directly. To directly address them, Spring 3 introduces a convenient Formatter SPI that
provides a simple and robust alternative to PropertyEditors for client environments.</p>
<p>In general, use the Converter SPI when you need to implement general-purpose type
conversion logic; for example, for converting between a java.util.Date and and
java.lang.Long. Use the Formatter SPI when you&#8217;re working in a client environment, such
as a web application, and need to parse and print localized field values. The
ConversionService provides a unified type conversion API for both SPIs.</p>
<div class="section" title="6.6.1&nbsp;Formatter SPI"><div class="titlepage"><div><div><h3 class="title"><a name="format-Formatter-SPI"></a>6.6.1&nbsp;Formatter SPI</h3></div></div></div>

<p>The Formatter SPI to implement field formatting logic is simple and strongly typed:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.format;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Formatter&lt;T&gt; <span class="hl-keyword">extends</span> Printer&lt;T&gt;, Parser&lt;T&gt; {
}</pre>

<p>Where Formatter extends from the Printer and Parser building-block interfaces:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Printer&lt;T&gt; {
    String print(T fieldValue, Locale locale);
}</pre>

<pre class="programlisting"><span class="hl-keyword">import</span> java.text.ParseException;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Parser&lt;T&gt; {
    T parse(String clientValue, Locale locale) <span class="hl-keyword">throws</span> ParseException;
}</pre>

<p>To create your own Formatter, simply implement the Formatter interface above.
Parameterize T to be the type of object you wish to format, for example,
<code class="literal">java.util.Date</code>. Implement the <code class="literal">print()</code> operation to print an instance of T for
display in the client locale. Implement the <code class="literal">parse()</code> operation to parse an instance of
T from the formatted representation returned from the client locale. Your Formatter
should throw a ParseException or IllegalArgumentException if a parse attempt fails. Take
care to ensure your Formatter implementation is thread-safe.</p>
<p>Several Formatter implementations are provided in <code class="literal">format</code> subpackages as a convenience.
The <code class="literal">number</code> package provides a <code class="literal">NumberFormatter</code>, <code class="literal">CurrencyFormatter</code>, and
<code class="literal">PercentFormatter</code> to format <code class="literal">java.lang.Number</code> objects using a <code class="literal">java.text.NumberFormat</code>.
The <code class="literal">datetime</code> package provides a <code class="literal">DateFormatter</code> to format <code class="literal">java.util.Date</code> objects with
a <code class="literal">java.text.DateFormat</code>. The <code class="literal">datetime.joda</code> package provides comprehensive datetime
formatting support based on the <a class="ulink" href="http://joda-time.sourceforge.net" target="_top">Joda Time library</a>.</p>
<p>Consider <code class="literal">DateFormatter</code> as an example <code class="literal">Formatter</code> implementation:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.format.datetime;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> DateFormatter <span class="hl-keyword">implements</span> Formatter&lt;Date&gt; {

    <span class="hl-keyword">private</span> String pattern;

    <span class="hl-keyword">public</span> DateFormatter(String pattern) {
        <span class="hl-keyword">this</span>.pattern = pattern;
    }

    <span class="hl-keyword">public</span> String print(Date date, Locale locale) {
        <span class="hl-keyword">if</span> (date == null) {
            <span class="hl-keyword">return</span> <span class="hl-string">""</span>;
        }
        <span class="hl-keyword">return</span> getDateFormat(locale).format(date);
    }

    <span class="hl-keyword">public</span> Date parse(String formatted, Locale locale) <span class="hl-keyword">throws</span> ParseException {
        <span class="hl-keyword">if</span> (formatted.length() == <span class="hl-number">0</span>) {
            <span class="hl-keyword">return</span> null;
        }
        <span class="hl-keyword">return</span> getDateFormat(locale).parse(formatted);
    }

    <span class="hl-keyword">protected</span> DateFormat getDateFormat(Locale locale) {
        DateFormat dateFormat = <span class="hl-keyword">new</span> SimpleDateFormat(<span class="hl-keyword">this</span>.pattern, locale);
        dateFormat.setLenient(false);
        <span class="hl-keyword">return</span> dateFormat;
    }

}</pre>

<p>The Spring team welcomes community-driven Formatter contributions; see
<a class="ulink" href="http://jira.springframework.org" target="_top">http://jira.springframework.org</a> to contribute.</p>
</div>
<div class="section" title="6.6.2&nbsp;Annotation-driven Formatting"><div class="titlepage"><div><div><h3 class="title"><a name="format-CustomFormatAnnotations"></a>6.6.2&nbsp;Annotation-driven Formatting</h3></div></div></div>

<p>As you will see, field formatting can be configured by field type or annotation. To bind
an Annotation to a formatter, implement AnnotationFormatterFactory:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.format;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AnnotationFormatterFactory&lt;A <span class="hl-keyword">extends</span> Annotation&gt; {

    Set&lt;Class&lt;?&gt;&gt; getFieldTypes();

    Printer&lt;?&gt; getPrinter(A annotation, Class&lt;?&gt; fieldType);

    Parser&lt;?&gt; getParser(A annotation, Class&lt;?&gt; fieldType);

}</pre>

<p>Parameterize A to be the field annotationType you wish to associate formatting logic
with, for example <code class="literal">org.springframework.format.annotation.DateTimeFormat</code>. Have
<code class="literal">getFieldTypes()</code> return the types of fields the annotation may be used on. Have
<code class="literal">getPrinter()</code> return a Printer to print the value of an annotated field. Have
<code class="literal">getParser()</code> return a Parser to parse a clientValue for an annotated field.</p>
<p>The example AnnotationFormatterFactory implementation below binds the @NumberFormat
Annotation to a formatter. This annotation allows either a number style or pattern to be
specified:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> NumberFormatAnnotationFormatterFactory
        <span class="hl-keyword">implements</span> AnnotationFormatterFactory&lt;NumberFormat&gt; {

    <span class="hl-keyword">public</span> Set&lt;Class&lt;?&gt;&gt; getFieldTypes() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;(asList(<span class="hl-keyword">new</span> Class&lt;?&gt;[] {
            Short.<span class="hl-keyword">class</span>, Integer.<span class="hl-keyword">class</span>, Long.<span class="hl-keyword">class</span>, Float.<span class="hl-keyword">class</span>,
            Double.<span class="hl-keyword">class</span>, BigDecimal.<span class="hl-keyword">class</span>, BigInteger.<span class="hl-keyword">class</span> }));
    }

    <span class="hl-keyword">public</span> Printer&lt;Number&gt; getPrinter(NumberFormat annotation, Class&lt;?&gt; fieldType) {
        <span class="hl-keyword">return</span> configureFormatterFrom(annotation, fieldType);
    }

    <span class="hl-keyword">public</span> Parser&lt;Number&gt; getParser(NumberFormat annotation, Class&lt;?&gt; fieldType) {
        <span class="hl-keyword">return</span> configureFormatterFrom(annotation, fieldType);
    }

    <span class="hl-keyword">private</span> Formatter&lt;Number&gt; configureFormatterFrom(NumberFormat annotation,
            Class&lt;?&gt; fieldType) {
        <span class="hl-keyword">if</span> (!annotation.pattern().isEmpty()) {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> NumberFormatter(annotation.pattern());
        } <span class="hl-keyword">else</span> {
            Style style = annotation.style();
            <span class="hl-keyword">if</span> (style == Style.PERCENT) {
                <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> PercentFormatter();
            } <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (style == Style.CURRENCY) {
                <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CurrencyFormatter();
            } <span class="hl-keyword">else</span> {
                <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> NumberFormatter();
            }
        }
    }
}</pre>

<p>To trigger formatting, simply annotate fields with @NumberFormat:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyModel {

    <i><span class="hl-annotation" style="color: gray">@NumberFormat(style=Style.CURRENCY)</span></i>
    <span class="hl-keyword">private</span> BigDecimal decimal;

}</pre>

<div class="section" title="Format Annotation API"><div class="titlepage"><div><div><h4 class="title"><a name="format-annotations-api"></a>Format Annotation API</h4></div></div></div>

<p>A portable format annotation API exists in the <code class="literal">org.springframework.format.annotation</code>
package. Use @NumberFormat to format java.lang.Number fields. Use @DateTimeFormat to
format java.util.Date, java.util.Calendar, java.util.Long, or Joda Time fields.</p>
<p>The example below uses @DateTimeFormat to format a java.util.Date as a ISO Date
(yyyy-MM-dd):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyModel {

    <i><span class="hl-annotation" style="color: gray">@DateTimeFormat(iso=ISO.DATE)</span></i>
    <span class="hl-keyword">private</span> Date date;

}</pre>

</div>
</div>
<div class="section" title="6.6.3&nbsp;FormatterRegistry SPI"><div class="titlepage"><div><div><h3 class="title"><a name="format-FormatterRegistry-SPI"></a>6.6.3&nbsp;FormatterRegistry SPI</h3></div></div></div>

<p>The FormatterRegistry is an SPI for registering formatters and converters.
<code class="literal">FormattingConversionService</code> is an implementation of FormatterRegistry suitable for
most environments. This implementation may be configured programmatically or
declaratively as a Spring bean using <code class="literal">FormattingConversionServiceFactoryBean</code>. Because
this implementation also implements <code class="literal">ConversionService</code>, it can be directly configured
for use with Spring&#8217;s DataBinder and the Spring Expression Language (SpEL).</p>
<p>Review the FormatterRegistry SPI below:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.format;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FormatterRegistry <span class="hl-keyword">extends</span> ConverterRegistry {

    <span class="hl-keyword">void</span> addFormatterForFieldType(Class&lt;?&gt; fieldType, Printer&lt;?&gt; printer, Parser&lt;?&gt; parser);

    <span class="hl-keyword">void</span> addFormatterForFieldType(Class&lt;?&gt; fieldType, Formatter&lt;?&gt; formatter);

    <span class="hl-keyword">void</span> addFormatterForFieldType(Formatter&lt;?&gt; formatter);

    <span class="hl-keyword">void</span> addFormatterForAnnotation(AnnotationFormatterFactory&lt;?, ?&gt; factory);

}</pre>

<p>As shown above, Formatters can be registered by fieldType or annotation.</p>
<p>The FormatterRegistry SPI allows you to configure Formatting rules centrally, instead of
duplicating such configuration across your Controllers. For example, you might want to
enforce that all Date fields are formatted a certain way, or fields with a specific
annotation are formatted in a certain way. With a shared FormatterRegistry, you define
these rules once and they are applied whenever formatting is needed.</p>
</div>
<div class="section" title="6.6.4&nbsp;FormatterRegistrar SPI"><div class="titlepage"><div><div><h3 class="title"><a name="format-FormatterRegistrar-SPI"></a>6.6.4&nbsp;FormatterRegistrar SPI</h3></div></div></div>

<p>The FormatterRegistrar is an SPI for registering formatters and converters through the
FormatterRegistry:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.format;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FormatterRegistrar {

    <span class="hl-keyword">void</span> registerFormatters(FormatterRegistry registry);

}</pre>

<p>A FormatterRegistrar is useful when registering multiple related converters and
formatters for a given formatting category, such as Date formatting. It can also be
useful where declarative registration is insufficient. For example when a formatter
needs to be indexed under a specific field type different from its own &lt;T&gt; or when
registering a Printer/Parser pair. The next section provides more information on
converter and formatter registration.</p>
</div>
<div class="section" title="6.6.5&nbsp;Configuring Formatting in Spring MVC"><div class="titlepage"><div><div><h3 class="title"><a name="format-configuring-formatting-mvc"></a>6.6.5&nbsp;Configuring Formatting in Spring MVC</h3></div></div></div>

<p>In a Spring MVC application, you may configure a custom ConversionService instance
explicitly as an attribute of the <code class="literal">annotation-driven</code> element of the MVC namespace. This
ConversionService will then be used anytime a type conversion is required during
Controller model binding. If not configured explicitly, Spring MVC will automatically
register default formatters and converters for common types such as numbers and dates.</p>
<p>To rely on default formatting rules, no custom configuration is required in your Spring
MVC config XML:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:mvc</span>=<span class="hl-value">"http://www.springframework.org/schema/mvc"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;mvc:annotation-driven/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>With this one-line of configuration, default formatters for Numbers and Date types will
be installed, including support for the @NumberFormat and @DateTimeFormat annotations.
Full support for the Joda Time formatting library is also installed if Joda Time is
present on the classpath.</p>
<p>To inject a ConversionService instance with custom formatters and converters registered,
set the conversion-service attribute and then specify custom converters, formatters, or
FormatterRegistrars as properties of the FormattingConversionServiceFactoryBean:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:mvc</span>=<span class="hl-value">"http://www.springframework.org/schema/mvc"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;mvc:annotation-driven</span> <span class="hl-attribute">conversion-service</span>=<span class="hl-value">"conversionService"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"conversionService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.format.support.FormattingConversionServiceFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"converters"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;set&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyConverter"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/set&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"formatters"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;set&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyFormatter"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyAnnotationFormatterFactory"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/set&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"formatterRegistrars"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;set&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyFormatterRegistrar"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/set&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>See <a class="xref" href="#format-FormatterRegistrar-SPI" title="6.6.4&nbsp;FormatterRegistrar SPI">Section&nbsp;6.6.4, &#8220;FormatterRegistrar SPI&#8221;</a> and the <code class="literal">FormattingConversionServiceFactoryBean</code>
for more information on when to use FormatterRegistrars.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="6.7&nbsp;Configuring a global date &amp; time format"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="format-configuring-formatting-globaldatetimeformat"></a>6.7&nbsp;Configuring a global date &amp; time format</h2></div></div></div>

<p>By default, date and time fields that are not annotated with <code class="literal">@DateTimeFormat</code> are
converted from strings using the the <code class="literal">DateFormat.SHORT</code> style. If you prefer, you can
change this by defining your own global format.</p>
<p>You will need to ensure that Spring does not register default formatters, and instead
you should register all formatters manually. Use the
<code class="literal">org.springframework.format.datetime.joda.JodaTimeFormatterRegistrar</code> or
<code class="literal">org.springframework.format.datetime.DateFormatterRegistrar</code> class depending on whether
you use the Joda Time library.</p>
<p>For example, the following Java configuration will register a global ' <code class="literal">yyyyMMdd</code>'
format. This example does not depend on the Joda Time library:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> FormattingConversionService conversionService() {

        <span class="hl-comment">// Use the DefaultFormattingConversionService but do not register defaults</span>
        DefaultFormattingConversionService conversionService = <span class="hl-keyword">new</span> DefaultFormattingConversionService(false);

        <span class="hl-comment">// Ensure @NumberFormat is still supported</span>
        conversionService.addFormatterForFieldAnnotation(<span class="hl-keyword">new</span> NumberFormatAnnotationFormatterFactory());

        <span class="hl-comment">// Register date conversion with a specific global format</span>
        DateFormatterRegistrar registrar = <span class="hl-keyword">new</span> DateFormatterRegistrar();
        registrar.setFormatter(<span class="hl-keyword">new</span> DateFormatter(<span class="hl-string">"yyyyMMdd"</span>));
        registrar.registerFormatters(conversionService);

        <span class="hl-keyword">return</span> conversionService;
    }
}</pre>

<p>If you prefer XML based configuration you can use a
<code class="literal">FormattingConversionServiceFactoryBean</code>. Here is the same example, this time using Joda
Time:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd&gt;

    &lt;bean id="</span><span class="hl-attribute">conversionService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.format.support.FormattingConversionServiceFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"registerDefaultFormatters"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"formatters"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;set&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.format.number.NumberFormatAnnotationFormatterFactory"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/set&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"formatterRegistrars"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;set&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.format.datetime.joda.JodaTimeFormatterRegistrar"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dateFormatter"</span><span class="hl-tag">&gt;</span>
                        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.format.datetime.joda.DateTimeFormatterFactoryBean"</span><span class="hl-tag">&gt;</span>
                            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"pattern"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"yyyyMMdd"</span><span class="hl-tag">/&gt;</span>
                        <span class="hl-tag">&lt;/bean&gt;</span>
                    <span class="hl-tag">&lt;/property&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/set&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Joda Time provides separate distinct types to represent <code class="literal">date</code>, <code class="literal">time</code> and <code class="literal">date-time</code>
values. The <code class="literal">dateFormatter</code>, <code class="literal">timeFormatter</code> and <code class="literal">dateTimeFormatter</code> properties of the
<code class="literal">JodaTimeFormatterRegistrar</code> should be used to configure the different formats for each
type. The <code class="literal">DateTimeFormatterFactoryBean</code> provides a convenient way to create formatters.</p>
</td></tr></table></div>

<p>If you are using Spring MVC remember to explicitly configure the conversion service that
is used. For Java based <code class="literal">@Configuration</code> this means extending the
<code class="literal">WebMvcConfigurationSupport</code> class and overriding the <code class="literal">mvcConversionService()</code> method.
For XML you should use the <code class="literal">'conversion-service'</code> attribute of the
<code class="literal">mvc:annotation-driven</code> element. See <a class="xref" href="#format-configuring-formatting-mvc" title="6.6.5&nbsp;Configuring Formatting in Spring MVC">Section&nbsp;6.6.5, &#8220;Configuring Formatting in Spring MVC&#8221;</a> for details.</p>
</div>
<div class="section" title="6.8&nbsp;Spring Validation"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="validation-beanvalidation"></a>6.8&nbsp;Spring Validation</h2></div></div></div>

<p>Spring 3 introduces several enhancements to its validation support. First, the JSR-303
Bean Validation API is now fully supported. Second, when used programmatically, Spring&#8217;s
DataBinder can now validate objects as well as bind to them. Third, Spring MVC now has
support for declaratively validating @Controller inputs.</p>
<div class="section" title="6.8.1&nbsp;Overview of the JSR-303 Bean Validation API"><div class="titlepage"><div><div><h3 class="title"><a name="validation-beanvalidation-overview"></a>6.8.1&nbsp;Overview of the JSR-303 Bean Validation API</h3></div></div></div>

<p>JSR-303 standardizes validation constraint declaration and metadata for the Java
platform. Using this API, you annotate domain model properties with declarative
validation constraints and the runtime enforces them. There are a number of built-in
constraints you can take advantage of. You may also define your own custom constraints.</p>
<p>To illustrate, consider a simple PersonForm model with two properties:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PersonForm {
    <span class="hl-keyword">private</span> String name;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> age;
}</pre>

<p>JSR-303 allows you to define declarative validation constraints against such properties:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PersonForm {

    <i><span class="hl-annotation" style="color: gray">@NotNull</span></i>
    <i><span class="hl-annotation" style="color: gray">@Size(max=64)</span></i>
    <span class="hl-keyword">private</span> String name;

    <i><span class="hl-annotation" style="color: gray">@Min(0)</span></i>
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> age;

}</pre>

<p>When an instance of this class is validated by a JSR-303 Validator, these constraints
will be enforced.</p>
<p>For general information on JSR-303/JSR-349, see the <a class="ulink" href="http://beanvalidation.org/" target="_top">Bean
Validation website</a>. For information on the specific capabilities of the default
reference implementation, see the <a class="ulink" href="https://www.hibernate.org/412.html" target="_top">Hibernate
Validator</a> documentation. To learn how to setup a Bean Validation provider as a Spring
bean, keep reading.</p>
</div>
<div class="section" title="6.8.2&nbsp;Configuring a Bean Validation Provider"><div class="titlepage"><div><div><h3 class="title"><a name="validation-beanvalidation-spring"></a>6.8.2&nbsp;Configuring a Bean Validation Provider</h3></div></div></div>

<p>Spring provides full support for the Bean Validation API. This includes convenient
support for bootstrapping a JSR-303/JSR-349 Bean Validation provider as a Spring bean.
This allows for a <code class="literal">javax.validation.ValidatorFactory</code> or <code class="literal">javax.validation.Validator</code> to
be injected wherever validation is needed in your application.</p>
<p>Use the <code class="literal">LocalValidatorFactoryBean</code> to configure a default Validator as a Spring bean:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"validator"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.validation.beanvalidation.LocalValidatorFactoryBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>The basic configuration above will trigger Bean Validation to initialize using its
default bootstrap mechanism. A JSR-303/JSR-349 provider, such as Hibernate Validator, is
expected to be present in the classpath and will be detected automatically.</p>
<div class="section" title="Injecting a Validator"><div class="titlepage"><div><div><h4 class="title"><a name="validation-beanvalidation-spring-inject"></a>Injecting a Validator</h4></div></div></div>

<p><code class="literal">LocalValidatorFactoryBean</code> implements both <code class="literal">javax.validation.ValidatorFactory</code> and
<code class="literal">javax.validation.Validator</code>, as well as Spring&#8217;s
<code class="literal">org.springframework.validation.Validator</code>. You may inject a reference to either of
these interfaces into beans that need to invoke validation logic.</p>
<p>Inject a reference to <code class="literal">javax.validation.Validator</code> if you prefer to work with the Bean
Validation API directly:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.validation.Validator;

<i><span class="hl-annotation" style="color: gray">@Service</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyService {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> Validator validator;</pre>

<p>Inject a reference to <code class="literal">org.springframework.validation.Validator</code> if your bean requires
the Spring Validation API:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.validation.Validator;

<i><span class="hl-annotation" style="color: gray">@Service</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyService {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> Validator validator;

}</pre>

</div>
<div class="section" title="Configuring Custom Constraints"><div class="titlepage"><div><div><h4 class="title"><a name="validation-beanvalidation-spring-constraints"></a>Configuring Custom Constraints</h4></div></div></div>

<p>Each Bean Validation constraint consists of two parts. First, a @Constraint annotation
that declares the constraint and its configurable properties. Second, an implementation
of the <code class="literal">javax.validation.ConstraintValidator</code> interface that implements the constraint&#8217;s
behavior. To associate a declaration with an implementation, each @Constraint annotation
references a corresponding ValidationConstraint implementation class. At runtime, a
<code class="literal">ConstraintValidatorFactory</code> instantiates the referenced implementation when the
constraint annotation is encountered in your domain model.</p>
<p>By default, the <code class="literal">LocalValidatorFactoryBean</code> configures a
<code class="literal">SpringConstraintValidatorFactory</code> that uses Spring to create ConstraintValidator
instances. This allows your custom ConstraintValidators to benefit from dependency
injection like any other Spring bean.</p>
<p>Shown below is an example of a custom @Constraint declaration, followed by an associated
<code class="literal">ConstraintValidator</code> implementation that uses Spring for dependency injection:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.FIELD})</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Constraint(validatedBy=MyConstraintValidator.class)</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> MyConstraint {
}</pre>

<pre class="programlisting"><span class="hl-keyword">import</span> javax.validation.ConstraintValidator;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyConstraintValidator <span class="hl-keyword">implements</span> ConstraintValidator {

    <i><span class="hl-annotation" style="color: gray">@Autowired;</span></i>
    <span class="hl-keyword">private</span> Foo aDependency;

    ...
}</pre>

<p>As you can see, a ConstraintValidator implementation may have its dependencies
@Autowired like any other Spring bean.</p>
</div>
<div class="section" title="Additional Configuration Options"><div class="titlepage"><div><div><h4 class="title"><a name="validation-beanvalidation-spring-other"></a>Additional Configuration Options</h4></div></div></div>

<p>The default <code class="literal">LocalValidatorFactoryBean</code> configuration should prove sufficient for most
cases. There are a number of configuration options for various Bean Validation
constructs, from message interpolation to traversal resolution. See the JavaDocs of
<code class="literal">LocalValidatorFactoryBean</code> for more information on these options.</p>
</div>
</div>
<div class="section" title="6.8.3&nbsp;Configuring a DataBinder"><div class="titlepage"><div><div><h3 class="title"><a name="validation-binder"></a>6.8.3&nbsp;Configuring a DataBinder</h3></div></div></div>

<p>Since Spring 3, a DataBinder instance can be configured with a Validator. Once
configured, the Validator may be invoked by calling <code class="literal">binder.validate()</code>. Any validation
Errors are automatically added to the binder&#8217;s BindingResult.</p>
<p>When working with the DataBinder programmatically, this can be used to invoke validation
logic after binding to a target object:</p>
<pre class="programlisting">Foo target = <span class="hl-keyword">new</span> Foo();
DataBinder binder = <span class="hl-keyword">new</span> DataBinder(target);
binder.setValidator(<span class="hl-keyword">new</span> FooValidator());

<span class="hl-comment">// bind to the target object</span>
binder.bind(propertyValues);

<span class="hl-comment">// validate the target object</span>
binder.validate();

<span class="hl-comment">// get BindingResult that includes any validation errors</span>
BindingResult results = binder.getBindingResult();</pre>

<p>A DataBinder can also be configured with multiple <code class="literal">Validator</code> instances via
<code class="literal">dataBinder.addValidators</code> and <code class="literal">dataBinder.replaceValidators</code>. This is useful when
combining globally configured Bean Validation with a Spring <code class="literal">Validator</code> configured
locally on a DataBinder instance. See <a class="xref" href="#validation-mvc-configuring" title="Configuring a Validator for use by Spring MVC">the section called &#8220;Configuring a Validator for use by Spring MVC&#8221;</a>.</p>
</div>
<div class="section" title="6.8.4&nbsp;Spring MVC 3 Validation"><div class="titlepage"><div><div><h3 class="title"><a name="validation-mvc"></a>6.8.4&nbsp;Spring MVC 3 Validation</h3></div></div></div>

<p>Beginning with Spring 3, Spring MVC has the ability to automatically validate
@Controller inputs. In previous versions it was up to the developer to manually invoke
validation logic.</p>
<div class="section" title="Triggering @Controller Input Validation"><div class="titlepage"><div><div><h4 class="title"><a name="validation-mvc-triggering"></a>Triggering @Controller Input Validation</h4></div></div></div>

<p>To trigger validation of a @Controller input, simply annotate the input argument as
@Valid:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyController {

    <i><span class="hl-annotation" style="color: gray">@RequestMapping("/foo", method=RequestMethod.POST)</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> processFoo(<span class="strong"><strong>@Valid</strong></span> Foo foo) { <span class="hl-comment">/* ... */</span> }</pre>

<p>Spring MVC will validate a @Valid object after binding so-long as an appropriate
Validator has been configured.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The @Valid annotation is part of the standard JSR-303 Bean Validation API, and is not a
Spring-specific construct.</p>
</td></tr></table></div>

</div>
<div class="section" title="Configuring a Validator for use by Spring MVC"><div class="titlepage"><div><div><h4 class="title"><a name="validation-mvc-configuring"></a>Configuring a Validator for use by Spring MVC</h4></div></div></div>

<p>The Validator instance invoked when a @Valid method argument is encountered may be
configured in two ways. First, you may call binder.setValidator(Validator) within a
@Controller&#8217;s @InitBinder callback. This allows you to configure a Validator instance
per @Controller class:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyController {

    <i><span class="hl-annotation" style="color: gray">@InitBinder</span></i>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> initBinder(WebDataBinder binder) {
        binder.setValidator(<span class="hl-keyword">new</span> FooValidator());
    }

    <i><span class="hl-annotation" style="color: gray">@RequestMapping("/foo", method=RequestMethod.POST)</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> processFoo(<i><span class="hl-annotation" style="color: gray">@Valid</span></i> Foo foo) { ... }

}</pre>

<p>Second, you may call setValidator(Validator) on the global WebBindingInitializer. This
allows you to configure a Validator instance across all @Controllers. This can be
achieved easily by using the Spring MVC namespace:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:mvc</span>=<span class="hl-value">"http://www.springframework.org/schema/mvc"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;mvc:annotation-driven</span> <span class="hl-attribute">validator</span>=<span class="hl-value">"globalValidator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>To combine a global and a local validator, configure the global validator as shown above
and then add a local validator:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyController {

    <i><span class="hl-annotation" style="color: gray">@InitBinder</span></i>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> initBinder(WebDataBinder binder) {
        binder.addValidators(<span class="hl-keyword">new</span> FooValidator());
    }

}</pre>

</div>
<div class="section" title="Configuring a JSR-303/JSR-349 Validator for use by Spring MVC"><div class="titlepage"><div><div><h4 class="title"><a name="validation-mvc-jsr303"></a>Configuring a JSR-303/JSR-349 Validator for use by Spring MVC</h4></div></div></div>

<p>With Bean Validation, a single <code class="literal">javax.validation.Validator</code> instance typically validates
<span class="emphasis"><em>all</em></span> model objects that declare validation constraints. To configure such a JSR-303
backed Validator with Spring MVC, simply add a Bean Validation provider, such as
Hibernate Validator, to your classpath. Spring MVC will detect it and automatically
enable Bean Validation support across all Controllers.</p>
<p>The Spring MVC configuration required to enable Bean Validation support is shown below:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:mvc</span>=<span class="hl-value">"http://www.springframework.org/schema/mvc"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- JSR-303/JSR-349 support will be detected on classpath and enabled automatically --&gt;</span>
    <span class="hl-tag">&lt;mvc:annotation-driven/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>With this minimal configuration, anytime a @Valid @Controller input is encountered, it
will be validated by the Bean Validation provider. That provider, in turn, will enforce
any constraints declared against the input. Any ConstraintViolations will automatically
be exposed as errors in the BindingResult renderable by standard Spring MVC form tags.</p>
</div>
</div>
</div>
</div>
<div class="chapter" title="7.&nbsp;Spring Expression Language (SpEL)"><div class="titlepage"><div><div><h2 class="title"><a name="expressions"></a>7.&nbsp;Spring Expression Language (SpEL)</h2></div></div></div>

<div class="section" title="7.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="expressions-intro"></a>7.1&nbsp;Introduction</h2></div></div></div>

<p>The Spring Expression Language (SpEL for short) is a powerful expression language that
supports querying and manipulating an object graph at runtime. The language syntax is
similar to Unified EL but offers additional features, most notably method invocation and
basic string templating functionality.</p>
<p>While there are several other Java expression languages available, OGNL, MVEL, and JBoss
EL, to name a few, the Spring Expression Language was created to provide the Spring
community with a single well supported expression language that can be used across all
the products in the Spring portfolio. Its language features are driven by the
requirements of the projects in the Spring portfolio, including tooling requirements for
code completion support within the eclipse based SpringSource Tool Suite. That said,
SpEL is based on a technology agnostic API allowing other expression language
implementations to be integrated should the need arise.</p>
<p>While SpEL serves as the foundation for expression evaluation within the Spring
portfolio, it is not directly tied to Spring and can be used independently. In order to
be self contained, many of the examples in this chapter use SpEL as if it were an
independent expression language. This requires creating a few bootstrapping
infrastructure classes such as the parser. Most Spring users will not need to deal with
this infrastructure and will instead only author expression strings for evaluation. An
example of this typical use is the integration of SpEL into creating XML or annotated
based bean definitions as shown in the section <a class="link" href="#expressions-beandef" title="7.4&nbsp;Expression support for defining bean definitions">Expression support
for defining bean definitions.</a></p>
<p>This chapter covers the features of the expression language, its API, and its language
syntax. In several places an Inventor and Inventor&#8217;s Society class are used as the
target objects for expression evaluation. These class declarations and the data used to
populate them are listed at the end of the chapter.</p>
</div>
<div class="section" title="7.2&nbsp;Feature Overview"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="expressions-features"></a>7.2&nbsp;Feature Overview</h2></div></div></div>

<p>The expression language supports the following functionality</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Literal expressions
</li><li class="listitem">
Boolean and relational operators
</li><li class="listitem">
Regular expressions
</li><li class="listitem">
Class expressions
</li><li class="listitem">
Accessing properties, arrays, lists, maps
</li><li class="listitem">
Method invocation
</li><li class="listitem">
Relational operators
</li><li class="listitem">
Assignment
</li><li class="listitem">
Calling constructors
</li><li class="listitem">
Bean references
</li><li class="listitem">
Array construction
</li><li class="listitem">
Inline lists
</li><li class="listitem">
Ternary operator
</li><li class="listitem">
Variables
</li><li class="listitem">
User defined functions
</li><li class="listitem">
Collection projection
</li><li class="listitem">
Collection selection
</li><li class="listitem">
Templated expressions
</li></ul></div>

</div>
<div class="section" title="7.3&nbsp;Expression Evaluation using Spring&#8217;s Expression Interface"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="expressions-evaluation"></a>7.3&nbsp;Expression Evaluation using Spring&#8217;s Expression Interface</h2></div></div></div>

<p>This section introduces the simple use of SpEL interfaces and its expression language.
The complete language reference can be found in the section
<a class="link" href="#expressions-language-ref" title="7.5&nbsp;Language Reference">Language Reference</a>.</p>
<p>The following code introduces the SpEL API to evaluate the literal string expression
<span class="emphasis"><em>Hello World</em></span>.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();
Expression exp = parser.parseExpression(<span class="hl-string">"</span><span class="strong"><strong>'Hello World'</strong></span><span class="hl-string">");
</span>String message = (String) exp.getValue();</pre>

<p>The value of the message variable is simply <span class="emphasis"><em>Hello World</em></span>.</p>
<p>The SpEL classes and interfaces you are most likely to use are located in the packages
<code class="literal">org.springframework.expression</code> and its sub packages and <code class="literal">spel.support</code>.</p>
<p>The interface <code class="literal">ExpressionParser</code> is responsible for parsing an expression string. In
this example the expression string is a string literal denoted by the surrounding single
quotes. The interface <code class="literal">Expression</code> is responsible for evaluating the previously defined
expression string. There are two exceptions that can be thrown, <code class="literal">ParseException</code> and
<code class="literal">EvaluationException</code> when calling ' <code class="literal">parser.parseExpression</code>' and ' <code class="literal">exp.getValue</code>'
respectively.</p>
<p>SpEL supports a wide range of features, such as calling methods, accessing properties,
and calling constructors.</p>
<p>As an example of method invocation, we call the <span class="emphasis"><em>concat</em></span> method on the string literal.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();
Expression exp = parser.parseExpression(<span class="hl-string">"</span><span class="strong"><strong>'Hello World'.concat('!')</strong></span><span class="hl-string">");
</span>String message = (String) exp.getValue();</pre>

<p>The value of message is now <span class="emphasis"><em>Hello World!</em></span>.</p>
<p>As an example of calling a JavaBean property, the String property <span class="emphasis"><em>Bytes</em></span> can be called
as shown below.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();

<span class="hl-comment">// invokes </span><span class="emphasis"><em>getBytes()</em></span>
Expression exp = parser.parseExpression(<span class="hl-string">"</span><span class="strong"><strong>'Hello World'.bytes</strong></span><span class="hl-string">");
</span><span class="hl-keyword">byte</span>[] bytes = (<span class="hl-keyword">byte</span>[]) exp.getValue();</pre>

<p>SpEL also supports nested properties using standard <span class="emphasis"><em>dot</em></span> notation, i.e.
prop1.prop2.prop3 and the setting of property values</p>
<p>Public fields may also be accessed.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();

<span class="hl-comment">// invokes </span><span class="emphasis"><em>getBytes().length</em></span>
Expression exp = parser.parseExpression(<span class="hl-string">"</span><span class="strong"><strong>'Hello World'.bytes.length</strong></span><span class="hl-string">");
</span><span class="hl-keyword">int</span> length = (Integer) exp.getValue();</pre>

<p>The String&#8217;s constructor can be called instead of using a string literal.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();
Expression exp = parser.parseExpression(<span class="hl-string">"</span><span class="strong"><strong>new String('hello world').toUpperCase()</strong></span><span class="hl-string">");
</span>String message = exp.getValue(String.<span class="hl-keyword">class</span>);</pre>

<p>Note the use of the generic method <code class="literal">public &lt;T&gt; T getValue(Class&lt;T&gt; desiredResultType)</code>.
Using this method removes the need to cast the value of the expression to the desired
result type. An <code class="literal">EvaluationException</code> will be thrown if the value cannot be cast to the
type <code class="literal">T</code> or converted using the registered type converter.</p>
<p>The more common usage of SpEL is to provide an expression string that is evaluated
against a specific object instance (called the root object). There are two options here
and which to choose depends on whether the object against which the expression is being
evaluated will be changing with each call to evaluate the expression. In the following
example we retrieve the <code class="literal">name</code> property from an instance of the Inventor class.</p>
<pre class="programlisting"><span class="hl-comment">// Create and set a calendar</span>
GregorianCalendar c = <span class="hl-keyword">new</span> GregorianCalendar();
c.set(<span class="hl-number">1856</span>, <span class="hl-number">7</span>, <span class="hl-number">9</span>);

<span class="hl-comment">// The constructor arguments are name, birthday, and nationality.</span>
Inventor tesla = <span class="hl-keyword">new</span> Inventor(<span class="hl-string">"Nikola Tesla"</span>, c.getTime(), <span class="hl-string">"Serbian"</span>);

ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();
Expression exp = parser.parseExpression(<span class="hl-string">"</span><span class="strong"><strong>name</strong></span><span class="hl-string">");
</span>
EvaluationContext context = <span class="hl-keyword">new</span> StandardEvaluationContext(tesla);
String name = (String) exp.getValue(context);</pre>

<p>In the last line, the value of the string variable <span class="emphasis"><em>name</em></span> will be set to "Nikola Tesla".
The class StandardEvaluationContext is where you can specify which object the "name"
property will be evaluated against. This is the mechanism to use if the root object is
unlikely to change, it can simply be set once in the evaluation context. If the root
object is likely to change repeatedly, it can be supplied on each call to <code class="literal">getValue</code>, as
this next example shows:</p>
<pre class="programlisting">/ Create and set a calendar
GregorianCalendar c = <span class="hl-keyword">new</span> GregorianCalendar();
c.set(<span class="hl-number">1856</span>, <span class="hl-number">7</span>, <span class="hl-number">9</span>);

<span class="hl-comment">// The constructor arguments are name, birthday, and nationality.</span>
Inventor tesla = <span class="hl-keyword">new</span> Inventor(<span class="hl-string">"Nikola Tesla"</span>, c.getTime(), <span class="hl-string">"Serbian"</span>);

ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();
Expression exp = parser.parseExpression(<span class="hl-string">"</span><span class="strong"><strong>name</strong></span><span class="hl-string">");
</span>String name = (String) exp.getValue(tesla);</pre>

<p>In this case the inventor <code class="literal">tesla</code> has been supplied directly to <code class="literal">getValue</code> and the
expression evaluation infrastructure creates and manages a default evaluation context
internally - it did not require one to be supplied.</p>
<p>The StandardEvaluationContext is relatively expensive to construct and during repeated
usage it builds up cached state that enables subsequent expression evaluations to be
performed more quickly. For this reason it is better to cache and reuse them where
possible, rather than construct a new one for each expression evaluation.</p>
<p>In some cases it can be desirable to use a configured evaluation context and yet still
supply a different root object on each call to <code class="literal">getValue</code>. <code class="literal">getValue</code> allows both to be
specified on the same call. In these situations the root object passed on the call is
considered to override any (which maybe null) specified on the evaluation context.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In standalone usage of SpEL there is a need to create the parser, parse expressions and
perhaps provide evaluation contexts and a root context object. However, more common
usage is to provide only the SpEL expression string as part of a configuration file, for
example for Spring bean or Spring Web Flow definitions. In this case, the parser,
evaluation context, root object and any predefined variables are all set up implicitly,
requiring the user to specify nothing other than the expressions.</p>
</td></tr></table></div>

<p>As a final introductory example, the use of a boolean operator is shown using the
Inventor object in the previous example.</p>
<pre class="programlisting">Expression exp = parser.parseExpression(<span class="hl-string">"name == </span><span class="emphasis"><em>Nikola Tesla</em></span><span class="hl-string">");
</span><span class="hl-keyword">boolean</span> result = exp.getValue(context, Boolean.<span class="hl-keyword">class</span>); <span class="hl-comment">// evaluates to true</span></pre>

<div class="section" title="7.3.1&nbsp;The EvaluationContext interface"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-evaluation-context"></a>7.3.1&nbsp;The EvaluationContext interface</h3></div></div></div>

<p>The interface <code class="literal">EvaluationContext</code> is used when evaluating an expression to resolve
properties, methods, fields, and to help perform type conversion. The out-of-the-box
implementation, <code class="literal">StandardEvaluationContext</code>, uses reflection to manipulate the object,
caching <code class="literal">java.lang.reflect</code>'s <code class="literal">Method</code>, <code class="literal">Field</code>, and <code class="literal">Constructor</code> instances for
increased performance.</p>
<p>The <code class="literal">StandardEvaluationContext</code> is where you may specify the root object to evaluate
against via the method <code class="literal">setRootObject()</code> or passing the root object into the
constructor. You can also specify variables and functions that will be used in the
expression using the methods <code class="literal">setVariable()</code> and <code class="literal">registerFunction()</code>. The use of
variables and functions are described in the language reference sections
<a class="link" href="#expressions-ref-variables" title="7.5.10&nbsp;Variables">Variables</a> and <a class="link" href="#expressions-ref-functions" title="7.5.11&nbsp;Functions">Functions</a>. The
<code class="literal">StandardEvaluationContext</code> is also where you can register custom
<code class="literal">ConstructorResolver</code> s, <code class="literal">MethodResolver</code> s, and <code class="literal">PropertyAccessor</code> s to extend how SpEL
evaluates expressions. Please refer to the JavaDoc of these classes for more details.</p>
<div class="section" title="Type Conversion"><div class="titlepage"><div><div><h4 class="title"><a name="expressions-type-conversion"></a>Type Conversion</h4></div></div></div>

<p>By default SpEL uses the conversion service available in Spring core (
<code class="literal">org.springframework.core.convert.ConversionService</code>). This conversion service comes
with many converters built in for common conversions but is also fully extensible so
custom conversions between types can be added. Additionally it has the key capability
that it is generics aware. This means that when working with generic types in
expressions, SpEL will attempt conversions to maintain type correctness for any objects
it encounters.</p>
<p>What does this mean in practice? Suppose assignment, using <code class="literal">setValue()</code>, is being used
to set a <code class="literal">List</code> property. The type of the property is actually <code class="literal">List&lt;Boolean&gt;</code>. SpEL
will recognize that the elements of the list need to be converted to <code class="literal">Boolean</code> before
being placed in it. A simple example:</p>
<pre class="programlisting"><span class="hl-keyword">class</span> Simple {
    <span class="hl-keyword">public</span> List&lt;Boolean&gt; booleanList = <span class="hl-keyword">new</span> ArrayList&lt;Boolean&gt;();
}

Simple simple = <span class="hl-keyword">new</span> Simple();

simple.booleanList.add(true);

StandardEvaluationContext simpleContext = <span class="hl-keyword">new</span> StandardEvaluationContext(simple);

<span class="hl-comment">// false is passed in here as a string. SpEL and the conversion service will</span>
<span class="hl-comment">// correctly recognize that it needs to be a Boolean and convert it</span>
parser.parseExpression(<span class="hl-string">"booleanList[0]"</span>).setValue(simpleContext, <span class="hl-string">"false"</span>);

<span class="hl-comment">// b will be false</span>
Boolean b = simple.booleanList.get(<span class="hl-number">0</span>);</pre>

</div>
</div>
</div>
<div class="section" title="7.4&nbsp;Expression support for defining bean definitions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="expressions-beandef"></a>7.4&nbsp;Expression support for defining bean definitions</h2></div></div></div>

<p>SpEL expressions can be used with XML or annotation based configuration metadata for
defining BeanDefinitions. In both cases the syntax to define the expression is of the
form <code class="literal">#{ &lt;expression string&gt; }</code>.</p>
<div class="section" title="7.4.1&nbsp;XML based configuration"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-beandef-xml-based"></a>7.4.1&nbsp;XML based configuration</h3></div></div></div>

<p>A property or constructor-arg value can be set using expressions as shown below</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"numberGuess"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.spring.samples.NumberGuess"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"randomNumber"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"#{ T(java.lang.Math).random() * 100.0 }"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- other properties --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The variable <span class="emphasis"><em>systemProperties</em></span> is predefined, so you can use it in your expressions as
shown below. Note that you do not have to prefix the predefined variable with the <span class="emphasis"><em>#</em></span>
symbol in this context.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"taxCalculator"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.spring.samples.TaxCalculator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"defaultLocale"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"#{ systemProperties[</span><span class="emphasis"><em>user.region</em></span>] }"/&gt;

    <span class="hl-comment">&lt;!-- other properties --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>You can also refer to other bean properties by name, for example.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"numberGuess"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.spring.samples.NumberGuess"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"randomNumber"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"{ T(java.lang.Math).random() * 100.0 }"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- other properties --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"shapeGuess"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.spring.samples.ShapeGuess"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"initialShapeSeed"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"{ numberGuess.randomNumber }"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- other properties --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="7.4.2&nbsp;Annotation-based configuration"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-beandef-annotation-based"></a>7.4.2&nbsp;Annotation-based configuration</h3></div></div></div>

<p>The <code class="literal">@Value</code> annotation can be placed on fields, methods and method/constructor
parameters to specify a default value.</p>
<p>Here is an example to set the default value of a field variable.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> FieldValueTestBean

    @Value(<span class="hl-string">"#{ systemProperties[</span><span class="emphasis"><em>user.region</em></span>] }<span class="hl-string">")
</span>    <span class="hl-keyword">private</span> String defaultLocale;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDefaultLocale(String defaultLocale) {
        <span class="hl-keyword">this</span>.defaultLocale = defaultLocale;
    }

    <span class="hl-keyword">public</span> String getDefaultLocale() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.defaultLocale;
    }

}</pre>

<p>The equivalent but on a property setter method is shown below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> PropertyValueTestBean

    <span class="hl-keyword">private</span> String defaultLocale;

    @Value(<span class="hl-string">"#{ systemProperties[</span><span class="emphasis"><em>user.region</em></span>] }<span class="hl-string">")
</span>    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDefaultLocale(String defaultLocale) {
        <span class="hl-keyword">this</span>.defaultLocale = defaultLocale;
    }

    <span class="hl-keyword">public</span> String getDefaultLocale() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.defaultLocale;
    }

}</pre>

<p>Autowired methods and constructors can also use the <code class="literal">@Value</code> annotation.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleMovieLister {

    <span class="hl-keyword">private</span> MovieFinder movieFinder;
    <span class="hl-keyword">private</span> String defaultLocale;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configure(MovieFinder movieFinder,
            @Value(<span class="hl-string">"#{ systemProperties[</span><span class="emphasis"><em>user.region</em></span>] }<span class="hl-string">") String defaultLocale) {
</span>        <span class="hl-keyword">this</span>.movieFinder = movieFinder;
        <span class="hl-keyword">this</span>.defaultLocale = defaultLocale;
    }

    <span class="hl-comment">// ...</span>
}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MovieRecommender {

    <span class="hl-keyword">private</span> String defaultLocale;

    <span class="hl-keyword">private</span> CustomerPreferenceDao customerPreferenceDao;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> MovieRecommender(CustomerPreferenceDao customerPreferenceDao,
            @Value(<span class="hl-string">"#{systemProperties[</span><span class="emphasis"><em>user.country</em></span>]}<span class="hl-string">") String defaultLocale) {
</span>        <span class="hl-keyword">this</span>.customerPreferenceDao = customerPreferenceDao;
        <span class="hl-keyword">this</span>.defaultLocale = defaultLocale;
    }

    <span class="hl-comment">// ...</span>
}</pre>

</div>
</div>
<div class="section" title="7.5&nbsp;Language Reference"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="expressions-language-ref"></a>7.5&nbsp;Language Reference</h2></div></div></div>

<div class="section" title="7.5.1&nbsp;Literal expressions"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-ref-literal"></a>7.5.1&nbsp;Literal expressions</h3></div></div></div>

<p>The types of literal expressions supported are strings, dates, numeric values (int,
real, and hex), boolean and null. Strings are delimited by single quotes. To put a
single quote itself in a string use two single quote characters. The following listing
shows simple usage of literals. Typically they would not be used in isolation like this,
but as part of a more complex expression, for example using a literal on one side of a
logical comparison operator.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();

<span class="hl-comment">// evals to "Hello World"</span>
String helloWorld = (String) parser.parseExpression(<span class="hl-string">"</span><span class="emphasis"><em>Hello World</em></span><span class="hl-string">").getValue();
</span>
<span class="hl-keyword">double</span> avogadrosNumber = (Double) parser.parseExpression(<span class="hl-string">"6.0221415E+23"</span>).getValue();

<span class="hl-comment">// evals to 2147483647</span>
<span class="hl-keyword">int</span> maxValue = (Integer) parser.parseExpression(<span class="hl-string">"0x7FFFFFFF"</span>).getValue();

<span class="hl-keyword">boolean</span> trueValue = (Boolean) parser.parseExpression(<span class="hl-string">"true"</span>).getValue();

Object nullValue = parser.parseExpression(<span class="hl-string">"null"</span>).getValue();</pre>

<p>Numbers support the use of the negative sign, exponential notation, and decimal points.
By default real numbers are parsed using Double.parseDouble().</p>
</div>
<div class="section" title="7.5.2&nbsp;Properties, Arrays, Lists, Maps, Indexers"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-properties-arrays"></a>7.5.2&nbsp;Properties, Arrays, Lists, Maps, Indexers</h3></div></div></div>

<p>Navigating with property references is easy, just use a period to indicate a nested
property value. The instances of Inventor class, pupin and tesla, were populated with
data listed in the section <a class="link" href="#expressions-example-classes" title="7.6&nbsp;Classes used in the examples">Classes used in the examples</a>.
To navigate "down" and get Tesla&#8217;s year of birth and Pupin&#8217;s city of birth the following
expressions are used.</p>
<pre class="programlisting"><span class="hl-comment">// evals to 1856</span>
<span class="hl-keyword">int</span> year = (Integer) parser.parseExpression(<span class="hl-string">"Birthdate.Year + 1900"</span>).getValue(context);

String city = (String) parser.parseExpression(<span class="hl-string">"placeOfBirth.City"</span>).getValue(context);</pre>

<p>Case insensitivity is allowed for the first letter of property names. The contents of
arrays and lists are obtained using square bracket notation.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();

<span class="hl-comment">// Inventions Array</span>
StandardEvaluationContext teslaContext = <span class="hl-keyword">new</span> StandardEvaluationContext(tesla);

<span class="hl-comment">// evaluates to "Induction motor"</span>
String invention = parser.parseExpression(<span class="hl-string">"inventions[3]"</span>).getValue(
        teslaContext, String.<span class="hl-keyword">class</span>);

<span class="hl-comment">// Members List</span>
StandardEvaluationContext societyContext = <span class="hl-keyword">new</span> StandardEvaluationContext(ieee);

<span class="hl-comment">// evaluates to "Nikola Tesla"</span>
String name = parser.parseExpression(<span class="hl-string">"Members[0].Name"</span>).getValue(
        societyContext, String.<span class="hl-keyword">class</span>);

<span class="hl-comment">// List and Array navigation</span>
<span class="hl-comment">// evaluates to "Wireless communication"</span>
String invention = parser.parseExpression(<span class="hl-string">"Members[0].Inventions[6]"</span>).getValue(
        societyContext, String.<span class="hl-keyword">class</span>);</pre>

<p>The contents of maps are obtained by specifying the literal key value within the
brackets. In this case, because keys for the Officers map are strings, we can specify
string literals.</p>
<pre class="programlisting"><span class="hl-comment">// Officer's Dictionary</span>

Inventor pupin = parser.parseExpression(<span class="hl-string">"Officers[</span><span class="emphasis"><em>president</em></span>]<span class="hl-string">").getValue(
</span>        societyContext, Inventor.<span class="hl-keyword">class</span>);

<span class="hl-comment">// evaluates to "Idvor"</span>
String city = parser.parseExpression(<span class="hl-string">"Officers[</span><span class="emphasis"><em>president</em></span>].PlaceOfBirth.City<span class="hl-string">").getValue(
</span>        societyContext, String.<span class="hl-keyword">class</span>);

<span class="hl-comment">// setting values</span>
parser.parseExpression(<span class="hl-string">"Officers[</span><span class="emphasis"><em>advisors</em></span>][<span class="hl-number">0</span>].PlaceOfBirth.Country<span class="hl-string">").setValue(
</span>        societyContext, <span class="hl-string">"Croatia"</span>);</pre>

</div>
<div class="section" title="7.5.3&nbsp;Inline lists"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-inline-lists"></a>7.5.3&nbsp;Inline lists</h3></div></div></div>

<p>Lists can be expressed directly in an expression using {} notation.</p>
<pre class="programlisting"><span class="hl-comment">// evaluates to a Java list containing the four numbers</span>
List numbers = (List) parser.parseExpression(<span class="hl-string">"{1,2,3,4}"</span>).getValue(context);

List listOfLists = (List) parser.parseExpression(<span class="hl-string">"{{</span><span class="emphasis"><em>a</em></span>,<span class="emphasis"><em>b</em></span>},{<span class="emphasis"><em>x</em></span>,<span class="emphasis"><em>y</em></span>}}<span class="hl-string">").getValue(context);</span></pre>

<p>{} by itself means an empty list. For performance reasons, if the list is itself
entirely composed of fixed literals then a constant list is created to represent the
expression, rather than building a new list on each evaluation.</p>
</div>
<div class="section" title="7.5.4&nbsp;Array construction"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-array-construction"></a>7.5.4&nbsp;Array construction</h3></div></div></div>

<p>Arrays can be built using the familiar Java syntax, optionally supplying an initializer
to have the array populated at construction time.</p>
<pre class="programlisting"><span class="hl-keyword">int</span>[] numbers1 = (<span class="hl-keyword">int</span>[]) parser.parseExpression(<span class="hl-string">"new int[4]"</span>).getValue(context);

<span class="hl-comment">// Array with initializer</span>
<span class="hl-keyword">int</span>[] numbers2 = (<span class="hl-keyword">int</span>[]) parser.parseExpression(<span class="hl-string">"new int[]{1,2,3}"</span>).getValue(context);

<span class="hl-comment">// Multi dimensional array</span>
<span class="hl-keyword">int</span>[][] numbers3 = (<span class="hl-keyword">int</span>[][]) parser.parseExpression(<span class="hl-string">"new int[4][5]"</span>).getValue(context);</pre>

<p>It is not currently allowed to supply an initializer when constructing a
multi-dimensional array.</p>
</div>
<div class="section" title="7.5.5&nbsp;Methods"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-methods"></a>7.5.5&nbsp;Methods</h3></div></div></div>

<p>Methods are invoked using typical Java programming syntax. You may also invoke methods
on literals. Varargs are also supported.</p>
<pre class="programlisting"><span class="hl-comment">// string literal, evaluates to "bc"</span>
String c = parser.parseExpression(<span class="hl-string">"</span><span class="emphasis"><em>abc</em></span>.substring(<span class="hl-number">2</span>, <span class="hl-number">3</span>)<span class="hl-string">").getValue(String.class);
</span>
<span class="hl-comment">// evaluates to true</span>
<span class="hl-keyword">boolean</span> isMember = parser.parseExpression(<span class="hl-string">"isMember(</span><span class="emphasis"><em>Mihajlo Pupin</em></span>)<span class="hl-string">").getValue(
</span>        societyContext, Boolean.<span class="hl-keyword">class</span>);</pre>

</div>
<div class="section" title="7.5.6&nbsp;Operators"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-operators"></a>7.5.6&nbsp;Operators</h3></div></div></div>

<div class="section" title="Relational operators"><div class="titlepage"><div><div><h4 class="title"><a name="expressions-operators-relational"></a>Relational operators</h4></div></div></div>

<p>The relational operators; equal, not equal, less than, less than or equal, greater than,
and greater than or equal are supported using standard operator notation.</p>
<pre class="programlisting"><span class="hl-comment">// evaluates to true</span>
<span class="hl-keyword">boolean</span> trueValue = parser.parseExpression(<span class="hl-string">"2 == 2"</span>).getValue(Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">// evaluates to false</span>
<span class="hl-keyword">boolean</span> falseValue = parser.parseExpression(<span class="hl-string">"2 &lt; -5.0"</span>).getValue(Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">// evaluates to true</span>
<span class="hl-keyword">boolean</span> trueValue = parser.parseExpression(<span class="hl-string">"</span><span class="emphasis"><em>black</em></span> &lt; <span class="emphasis"><em>block</em></span><span class="hl-string">").getValue(Boolean.class);</span></pre>

<p>In addition to standard relational operators SpEL supports the <span class="emphasis"><em>instanceof</em></span> and regular
expression based <span class="emphasis"><em>matches</em></span> operator.</p>
<pre class="programlisting"><span class="hl-comment">// evaluates to false</span>
<span class="hl-keyword">boolean</span> falseValue = parser.parseExpression(
        <span class="hl-string">"'xyz' instanceof T(int)"</span>).getValue(Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">// evaluates to true</span>
<span class="hl-keyword">boolean</span> trueValue = parser.parseExpression(
        <span class="hl-string">"'5.00' matches '^-?\\d+(\\.\\d{2})?$'"</span>).getValue(Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">//evaluates to false</span>
<span class="hl-keyword">boolean</span> falseValue = parser.parseExpression(
        <span class="hl-string">"'5.0067' matches '^-?\\d+(\\.\\d{2})?$'"</span>).getValue(Boolean.<span class="hl-keyword">class</span>);</pre>

<p>Each symbolic operator can also be specified as a purely alphabetic equivalent. This
avoids problems where the symbols used have special meaning for the document type in
which the expression is embedded (eg. an XML document). The textual equivalents are
shown here: lt (<span class="emphasis"><em>&lt;</em></span>), gt (<span class="emphasis"><em>&gt;</em></span>), le (<span class="emphasis"><em>&#8656;</em></span>), ge (<span class="emphasis"><em>&gt;=</em></span>), eq (<span class="emphasis"><em>==</em></span>), ne (<span class="emphasis"><em>!=</em></span>), div (<span class="emphasis"><em>/</em></span>),
mod (<span class="emphasis"><em>%</em></span>), not (<span class="emphasis"><em>!</em></span>). These are case insensitive.</p>
</div>
<div class="section" title="Logical operators"><div class="titlepage"><div><div><h4 class="title"><a name="expressions-operators-logical"></a>Logical operators</h4></div></div></div>

<p>The logical operators that are supported are and, or, and not. Their use is demonstrated
below.</p>
<pre class="programlisting"><span class="hl-comment">// -- AND --</span>

<span class="hl-comment">// evaluates to false</span>
<span class="hl-keyword">boolean</span> falseValue = parser.parseExpression(<span class="hl-string">"true and false"</span>).getValue(Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">// evaluates to true</span>
String expression = <span class="hl-string">"isMember(</span><span class="emphasis"><em>Nikola Tesla</em></span>) and isMember(<span class="emphasis"><em>Mihajlo Pupin</em></span>)<span class="hl-string">";
</span><span class="hl-keyword">boolean</span> trueValue = parser.parseExpression(expression).getValue(societyContext, Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">// -- OR --</span>

<span class="hl-comment">// evaluates to true</span>
<span class="hl-keyword">boolean</span> trueValue = parser.parseExpression(<span class="hl-string">"true or false"</span>).getValue(Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">// evaluates to true</span>
String expression = <span class="hl-string">"isMember(</span><span class="emphasis"><em>Nikola Tesla</em></span>) or isMember(<span class="emphasis"><em>Albert Einstein</em></span>)<span class="hl-string">";
</span><span class="hl-keyword">boolean</span> trueValue = parser.parseExpression(expression).getValue(societyContext, Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">// -- NOT --</span>

<span class="hl-comment">// evaluates to false</span>
<span class="hl-keyword">boolean</span> falseValue = parser.parseExpression(<span class="hl-string">"!true"</span>).getValue(Boolean.<span class="hl-keyword">class</span>);

<span class="hl-comment">// -- AND and NOT --</span>
String expression = <span class="hl-string">"isMember(</span><span class="emphasis"><em>Nikola Tesla</em></span>) and !isMember(<span class="emphasis"><em>Mihajlo Pupin</em></span>)<span class="hl-string">";
</span><span class="hl-keyword">boolean</span> falseValue = parser.parseExpression(expression).getValue(societyContext, Boolean.<span class="hl-keyword">class</span>);</pre>

</div>
<div class="section" title="Mathematical operators"><div class="titlepage"><div><div><h4 class="title"><a name="expressions-operators-mathematical"></a>Mathematical operators</h4></div></div></div>

<p>The addition operator can be used on both numbers and strings. Subtraction, multiplication
and division can be used only on numbers. Other mathematical operators supported are
modulus (%) and exponential power (^). Standard operator precedence is enforced. These
operators are demonstrated below.</p>
<pre class="programlisting"><span class="hl-comment">// Addition</span>
<span class="hl-keyword">int</span> two = parser.parseExpression(<span class="hl-string">"1 + 1"</span>).getValue(Integer.<span class="hl-keyword">class</span>); <span class="hl-comment">// 2</span>

String testString = parser.parseExpression(
        <span class="hl-string">"</span><span class="emphasis"><em>test</em></span> + <span class="hl-string">' '</span> + <span class="emphasis"><em>string</em></span><span class="hl-string">").getValue(String.class); // </span><span class="emphasis"><em>test string</em></span>

<span class="hl-comment">// Subtraction</span>
<span class="hl-keyword">int</span> four = parser.parseExpression(<span class="hl-string">"1 - -3"</span>).getValue(Integer.<span class="hl-keyword">class</span>); <span class="hl-comment">// 4</span>

<span class="hl-keyword">double</span> d = parser.parseExpression(<span class="hl-string">"1000.00 - 1e4"</span>).getValue(Double.<span class="hl-keyword">class</span>); <span class="hl-comment">// -9000</span>

<span class="hl-comment">// Multiplication</span>
<span class="hl-keyword">int</span> six = parser.parseExpression(<span class="hl-string">"-2 * -3"</span>).getValue(Integer.<span class="hl-keyword">class</span>); <span class="hl-comment">// 6</span>

<span class="hl-keyword">double</span> twentyFour = parser.parseExpression(<span class="hl-string">"2.0 * 3e0 * 4"</span>).getValue(Double.<span class="hl-keyword">class</span>); <span class="hl-comment">// 24.0</span>

<span class="hl-comment">// Division</span>
<span class="hl-keyword">int</span> minusTwo = parser.parseExpression(<span class="hl-string">"6 / -3"</span>).getValue(Integer.<span class="hl-keyword">class</span>); <span class="hl-comment">// -2</span>

<span class="hl-keyword">double</span> one = parser.parseExpression(<span class="hl-string">"8.0 / 4e0 / 2"</span>).getValue(Double.<span class="hl-keyword">class</span>); <span class="hl-comment">// 1.0</span>

<span class="hl-comment">// Modulus</span>
<span class="hl-keyword">int</span> three = parser.parseExpression(<span class="hl-string">"7 % 4"</span>).getValue(Integer.<span class="hl-keyword">class</span>); <span class="hl-comment">// 3</span>

<span class="hl-keyword">int</span> one = parser.parseExpression(<span class="hl-string">"8 / 5 % 2"</span>).getValue(Integer.<span class="hl-keyword">class</span>); <span class="hl-comment">// 1</span>

<span class="hl-comment">// Operator precedence</span>
<span class="hl-keyword">int</span> minusTwentyOne = parser.parseExpression(<span class="hl-string">"1+2-3*8"</span>).getValue(Integer.<span class="hl-keyword">class</span>); <span class="hl-comment">// -21</span></pre>

</div>
</div>
<div class="section" title="7.5.7&nbsp;Assignment"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-assignment"></a>7.5.7&nbsp;Assignment</h3></div></div></div>

<p>Setting of a property is done by using the assignment operator. This would typically be
done within a call to <code class="literal">setValue</code> but can also be done inside a call to <code class="literal">getValue</code>.</p>
<pre class="programlisting">Inventor inventor = <span class="hl-keyword">new</span> Inventor();
StandardEvaluationContext inventorContext = <span class="hl-keyword">new</span> StandardEvaluationContext(inventor);

parser.parseExpression(<span class="hl-string">"Name"</span>).setValue(inventorContext, <span class="hl-string">"Alexander Seovic2"</span>);

<span class="hl-comment">// alternatively</span>

String aleks = parser.parseExpression(
        <span class="hl-string">"Name = </span><span class="emphasis"><em>Alexandar Seovic</em></span><span class="hl-string">").getValue(inventorContext, String.class);</span></pre>

</div>
<div class="section" title="7.5.8&nbsp;Types"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-types"></a>7.5.8&nbsp;Types</h3></div></div></div>

<p>The special <span class="emphasis"><em>T</em></span> operator can be used to specify an instance of java.lang.Class (the
<span class="emphasis"><em>type</em></span>). Static methods are invoked using this operator as well. The
<code class="literal">StandardEvaluationContext</code> uses a <code class="literal">TypeLocator</code> to find types and the
<code class="literal">StandardTypeLocator</code> (which can be replaced) is built with an understanding of the
java.lang package. This means T() references to types within java.lang do not need to be
fully qualified, but all other type references must be.</p>
<pre class="programlisting">Class dateClass = parser.parseExpression(<span class="hl-string">"T(java.util.Date)"</span>).getValue(Class.<span class="hl-keyword">class</span>);

Class stringClass = parser.parseExpression(<span class="hl-string">"T(String)"</span>).getValue(Class.<span class="hl-keyword">class</span>);

<span class="hl-keyword">boolean</span> trueValue = parser.parseExpression(
        <span class="hl-string">"T(java.math.RoundingMode).CEILING &lt; T(java.math.RoundingMode).FLOOR"</span>)
        .getValue(Boolean.<span class="hl-keyword">class</span>);</pre>

</div>
<div class="section" title="7.5.9&nbsp;Constructors"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-constructors"></a>7.5.9&nbsp;Constructors</h3></div></div></div>

<p>Constructors can be invoked using the new operator. The fully qualified class name
should be used for all but the primitive type and String (where int, float, etc, can be
used).</p>
<pre class="programlisting">Inventor einstein = p.parseExpression(
        <span class="hl-string">"new org.spring.samples.spel.inventor.Inventor(</span><span class="emphasis"><em>Albert Einstein</em></span>, <span class="emphasis"><em>German</em></span>)<span class="hl-string">")
</span>        .getValue(Inventor.<span class="hl-keyword">class</span>);

<span class="hl-comment">//create new inventor instance within add method of List</span>
p.parseExpression(
        <span class="hl-string">"Members.add(new org.spring.samples.spel.inventor.Inventor(
</span>            <span class="emphasis"><em>Albert Einstein</em></span>, <span class="emphasis"><em>German</em></span>))<span class="hl-string">").getValue(societyContext);</span></pre>

</div>
<div class="section" title="7.5.10&nbsp;Variables"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-ref-variables"></a>7.5.10&nbsp;Variables</h3></div></div></div>

<p>Variables can be referenced in the expression using the syntax #variableName. Variables
are set using the method setVariable on the StandardEvaluationContext.</p>
<pre class="programlisting">Inventor tesla = <span class="hl-keyword">new</span> Inventor(<span class="hl-string">"Nikola Tesla"</span>, <span class="hl-string">"Serbian"</span>);
StandardEvaluationContext context = <span class="hl-keyword">new</span> StandardEvaluationContext(tesla);
context.setVariable(<span class="hl-string">"newName"</span>, <span class="hl-string">"Mike Tesla"</span>);

parser.parseExpression(<span class="hl-string">"Name = #newName"</span>).getValue(context);

System.out.println(tesla.getName()) <span class="hl-comment">// "Mike Tesla"</span></pre>

<div class="section" title="The #this and #root variables"><div class="titlepage"><div><div><h4 class="title"><a name="expressions-this-root"></a>The #this and #root variables</h4></div></div></div>

<p>The variable #this is always defined and refers to the current evaluation object
(against which unqualified references are resolved). The variable #root is always
defined and refers to the root context object. Although #this may vary as components of
an expression are evaluated, #root always refers to the root.</p>
<pre class="programlisting"><span class="hl-comment">// create an array of integers</span>
List&lt;Integer&gt; primes = <span class="hl-keyword">new</span> ArrayList&lt;Integer&gt;();
primes.addAll(Arrays.asList(<span class="hl-number">2</span>,<span class="hl-number">3</span>,<span class="hl-number">5</span>,<span class="hl-number">7</span>,<span class="hl-number">11</span>,<span class="hl-number">13</span>,<span class="hl-number">17</span>));

<span class="hl-comment">// create parser and set variable </span><span class="emphasis"><em>primes</em></span> as the array of integers
ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();
StandardEvaluationContext context = <span class="hl-keyword">new</span> StandardEvaluationContext();
context.setVariable(<span class="hl-string">"primes"</span>,primes);

<span class="hl-comment">// all prime numbers &gt; 10 from the list (using selection ?{...})</span>
<span class="hl-comment">// evaluates to [11, 13, 17]</span>
List&lt;Integer&gt; primesGreaterThanTen = (List&lt;Integer&gt;) parser.parseExpression(
        <span class="hl-string">"#primes.?[#this&gt;10]"</span>).getValue(context);</pre>

</div>
</div>
<div class="section" title="7.5.11&nbsp;Functions"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-ref-functions"></a>7.5.11&nbsp;Functions</h3></div></div></div>

<p>You can extend SpEL by registering user defined functions that can be called within the
expression string. The function is registered with the <code class="literal">StandardEvaluationContext</code> using
the method.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerFunction(String name, Method m)</pre>

<p>A reference to a Java Method provides the implementation of the function. For example, a
utility method to reverse a string is shown below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> StringUtils {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> String reverseString(String input) {
        StringBuilder backwards = <span class="hl-keyword">new</span> StringBuilder();
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i = <span class="hl-number">0</span>; i &lt; input.length(); i++)
            backwards.append(input.charAt(input.length() - <span class="hl-number">1</span> - i));
        }
        <span class="hl-keyword">return</span> backwards.toString();
    }
}</pre>

<p>This method is then registered with the evaluation context and can be used within an
expression string.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();
StandardEvaluationContext context = <span class="hl-keyword">new</span> StandardEvaluationContext();

context.registerFunction(<span class="hl-string">"reverseString"</span>,
    StringUtils.<span class="hl-keyword">class</span>.getDeclaredMethod(<span class="hl-string">"reverseString"</span>, <span class="hl-keyword">new</span> Class[] { String.<span class="hl-keyword">class</span> }));

String helloWorldReversed = parser.parseExpression(
    <span class="hl-string">"#reverseString(</span><span class="emphasis"><em>hello</em></span>)<span class="hl-string">").getValue(context, String.class);</span></pre>

</div>
<div class="section" title="7.5.12&nbsp;Bean references"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-bean-references"></a>7.5.12&nbsp;Bean references</h3></div></div></div>

<p>If the evaluation context has been configured with a bean resolver it is possible to
lookup beans from an expression using the (@) symbol.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();
StandardEvaluationContext context = <span class="hl-keyword">new</span> StandardEvaluationContext();
context.setBeanResolver(<span class="hl-keyword">new</span> MyBeanResolver());

<span class="hl-comment">// This will end up calling resolve(context,"foo") on MyBeanResolver during evaluation</span>
Object bean = parser.parseExpression(<span class="hl-string">"@foo"</span>).getValue(context);</pre>

</div>
<div class="section" title="7.5.13&nbsp;Ternary Operator (If-Then-Else)"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-operator-ternary"></a>7.5.13&nbsp;Ternary Operator (If-Then-Else)</h3></div></div></div>

<p>You can use the ternary operator for performing if-then-else conditional logic inside
the expression. A minimal example is:</p>
<pre class="programlisting">String falseString = parser.parseExpression(
        <span class="hl-string">"false ? </span><span class="emphasis"><em>trueExp</em></span> : <span class="emphasis"><em>falseExp</em></span><span class="hl-string">").getValue(String.class);</span></pre>

<p>In this case, the boolean false results in returning the string value <span class="emphasis"><em>falseExp</em></span>. A more
realistic example is shown below.</p>
<pre class="programlisting">parser.parseExpression(<span class="hl-string">"Name"</span>).setValue(societyContext, <span class="hl-string">"IEEE"</span>);
societyContext.setVariable(<span class="hl-string">"queryName"</span>, <span class="hl-string">"Nikola Tesla"</span>);

expression = <span class="hl-string">"isMember(#queryName)? #queryName + ' is a member of the ' "</span> +
        <span class="hl-string">"+ Name + ' Society' : #queryName + ' is not a member of the ' + Name + ' Society'"</span>;

String queryResultString = parser.parseExpression(expression)
        .getValue(societyContext, String.<span class="hl-keyword">class</span>);
<span class="hl-comment">// queryResultString = "Nikola Tesla is a member of the IEEE Society"</span></pre>

<p>Also see the next section on the Elvis operator for an even shorter syntax for the
ternary operator.</p>
</div>
<div class="section" title="7.5.14&nbsp;The Elvis Operator"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-operator-elvis"></a>7.5.14&nbsp;The Elvis Operator</h3></div></div></div>

<p>The Elvis operator is a shortening of the ternary operator syntax and is used in the
<a class="ulink" href="http://groovy.codehaus.org/Operators#Operators-ElvisOperator(%3F%3A)" target="_top">Groovy</a> language.
With the ternary operator syntax you usually have to repeat a variable twice, for
example:</p>
<pre class="programlisting">String name = "Elvis Presley";
String displayName = name != null ? name : "Unknown";</pre>

<p>Instead you can use the Elvis operator, named for the resemblance to Elvis' hair style.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();

String name = parser.parseExpression(<span class="hl-string">"null?:'Unknown'"</span>).getValue(String.<span class="hl-keyword">class</span>);

System.out.println(name); <span class="hl-comment">// </span><span class="emphasis"><em>Unknown</em></span></pre>

<p>Here is a more complex example.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();

Inventor tesla = <span class="hl-keyword">new</span> Inventor(<span class="hl-string">"Nikola Tesla"</span>, <span class="hl-string">"Serbian"</span>);
StandardEvaluationContext context = <span class="hl-keyword">new</span> StandardEvaluationContext(tesla);

String name = parser.parseExpression(<span class="hl-string">"Name?:'Elvis Presley'"</span>).getValue(context, String.<span class="hl-keyword">class</span>);

System.out.println(name); <span class="hl-comment">// Nikola Tesla</span>

tesla.setName(null);

name = parser.parseExpression(<span class="hl-string">"Name?:'Elvis Presley'"</span>).getValue(context, String.<span class="hl-keyword">class</span>);

System.out.println(name); <span class="hl-comment">// Elvis Presley</span></pre>

</div>
<div class="section" title="7.5.15&nbsp;Safe Navigation operator"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-operator-safe-navigation"></a>7.5.15&nbsp;Safe Navigation operator</h3></div></div></div>

<p>The Safe Navigation operator is used to avoid a <code class="literal">NullPointerException</code> and comes from
the <a class="ulink" href="http://groovy.codehaus.org/Operators#Operators-SafeNavigationOperator(%3F.)" target="_top">Groovy</a>
language. Typically when you have a reference to an object you might need to verify that
it is not null before accessing methods or properties of the object. To avoid this, the
safe navigation operator will simply return null instead of throwing an exception.</p>
<pre class="programlisting">ExpressionParser parser = <span class="hl-keyword">new</span> SpelExpressionParser();

Inventor tesla = <span class="hl-keyword">new</span> Inventor(<span class="hl-string">"Nikola Tesla"</span>, <span class="hl-string">"Serbian"</span>);
tesla.setPlaceOfBirth(<span class="hl-keyword">new</span> PlaceOfBirth(<span class="hl-string">"Smiljan"</span>));

StandardEvaluationContext context = <span class="hl-keyword">new</span> StandardEvaluationContext(tesla);

String city = parser.parseExpression(<span class="hl-string">"PlaceOfBirth?.City"</span>).getValue(context, String.<span class="hl-keyword">class</span>);
System.out.println(city); <span class="hl-comment">// Smiljan</span>

tesla.setPlaceOfBirth(null);

city = parser.parseExpression(<span class="hl-string">"PlaceOfBirth?.City"</span>).getValue(context, String.<span class="hl-keyword">class</span>);

System.out.println(city); <span class="hl-comment">// null - does not throw NullPointerException!!!</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Elvis operator can be used to apply default values in expressions, e.g. in an
<code class="literal">@Value</code> expression:</p>
<pre class="programlisting">@Value(<span class="hl-string">"#{systemProperties[</span><span class="emphasis"><em>pop3.port</em></span>] ?: <span class="hl-number">25</span>}<span class="hl-string">")</span></pre>

<p>This will inject a system property <code class="literal">pop3.port</code> if it is defined or 25 if not.</p>
</td></tr></table></div>

</div>
<div class="section" title="7.5.16&nbsp;Collection Selection"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-collection-selection"></a>7.5.16&nbsp;Collection Selection</h3></div></div></div>

<p>Selection is a powerful expression language feature that allows you to transform some
source collection into another by selecting from its entries.</p>
<p>Selection uses the syntax <code class="literal">?[selectionExpression]</code>. This will filter the collection and
return a new collection containing a subset of the original elements. For example,
selection would allow us to easily get a list of Serbian inventors:</p>
<pre class="programlisting">List&lt;Inventor&gt; list = (List&lt;Inventor&gt;) parser.parseExpression(
        <span class="hl-string">"Members.?[Nationality == </span><span class="emphasis"><em>Serbian</em></span>]<span class="hl-string">").getValue(societyContext);</span></pre>

<p>Selection is possible upon both lists and maps. In the former case the selection
criteria is evaluated against each individual list element whilst against a map the
selection criteria is evaluated against each map entry (objects of the Java type
<code class="literal">Map.Entry</code>). Map entries have their key and value accessible as properties for use in
the selection.</p>
<p>This expression will return a new map consisting of those elements of the original map
where the entry value is less than 27.</p>
<pre class="programlisting">Map newMap = parser.parseExpression(<span class="hl-string">"map.?[value&lt;27]"</span>).getValue();</pre>

<p>In addition to returning all the selected elements, it is possible to retrieve just the
first or the last value. To obtain the first entry matching the selection the syntax is
<code class="literal">^[...]</code> whilst to obtain the last matching selection the syntax is <code class="literal">$[...]</code>.</p>
</div>
<div class="section" title="7.5.17&nbsp;Collection Projection"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-collection-projection"></a>7.5.17&nbsp;Collection Projection</h3></div></div></div>

<p>Projection allows a collection to drive the evaluation of a sub-expression and the
result is a new collection. The syntax for projection is <code class="literal">![projectionExpression]</code>. Most
easily understood by example, suppose we have a list of inventors but want the list of
cities where they were born. Effectively we want to evaluate <span class="emphasis"><em>placeOfBirth.city</em></span> for
every entry in the inventor list. Using projection:</p>
<pre class="programlisting"><span class="hl-comment">// returns [</span><span class="emphasis"><em>Smiljan</em></span>, <span class="emphasis"><em>Idvor</em></span> ]
List placesOfBirth = (List)parser.parseExpression(<span class="hl-string">"Members.![placeOfBirth.city]"</span>);</pre>

<p>A map can also be used to drive projection and in this case the projection expression is
evaluated against each entry in the map (represented as a Java <code class="literal">Map.Entry</code>). The result
of a projection across a map is a list consisting of the evaluation of the projection
expression against each map entry.</p>
</div>
<div class="section" title="7.5.18&nbsp;Expression templating"><div class="titlepage"><div><div><h3 class="title"><a name="expressions-templating"></a>7.5.18&nbsp;Expression templating</h3></div></div></div>

<p>Expression templates allow a mixing of literal text with one or more evaluation blocks.
Each evaluation block is delimited with prefix and suffix characters that you can
define, a common choice is to use <code class="literal">#{ }</code> as the delimiters. For example,</p>
<pre class="programlisting">String randomPhrase = parser.parseExpression(
        <span class="hl-string">"random number is #{T(java.lang.Math).random()}"</span>,
        <span class="hl-keyword">new</span> TemplateParserContext()).getValue(String.<span class="hl-keyword">class</span>);

<span class="hl-comment">// evaluates to "random number is 0.7038186818312008"</span></pre>

<p>The string is evaluated by concatenating the literal text 'random number is ' with the
result of evaluating the expression inside the #{ } delimiter, in this case the result
of calling that random() method. The second argument to the method <code class="literal">parseExpression()</code>
is of the type <code class="literal">ParserContext</code>. The <code class="literal">ParserContext</code> interface is used to influence how
the expression is parsed in order to support the expression templating functionality.
The definition of <code class="literal">TemplateParserContext</code> is shown below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TemplateParserContext <span class="hl-keyword">implements</span> ParserContext {

    <span class="hl-keyword">public</span> String getExpressionPrefix() {
        <span class="hl-keyword">return</span> <span class="hl-string">"#{"</span>;
    }

    <span class="hl-keyword">public</span> String getExpressionSuffix() {
        <span class="hl-keyword">return</span> <span class="hl-string">"}"</span>;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isTemplate() {
        <span class="hl-keyword">return</span> true;
    }
}</pre>

</div>
</div>
<div class="section" title="7.6&nbsp;Classes used in the examples"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="expressions-example-classes"></a>7.6&nbsp;Classes used in the examples</h2></div></div></div>

<p>Inventor.java</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.spring.samples.spel.inventor;

<span class="hl-keyword">import</span> java.util.Date;
<span class="hl-keyword">import</span> java.util.GregorianCalendar;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Inventor {

    <span class="hl-keyword">private</span> String name;
    <span class="hl-keyword">private</span> String nationality;
    <span class="hl-keyword">private</span> String[] inventions;
    <span class="hl-keyword">private</span> Date birthdate;
    <span class="hl-keyword">private</span> PlaceOfBirth placeOfBirth;

    <span class="hl-keyword">public</span> Inventor(String name, String nationality) {
        GregorianCalendar c= <span class="hl-keyword">new</span> GregorianCalendar();
        <span class="hl-keyword">this</span>.name = name;
        <span class="hl-keyword">this</span>.nationality = nationality;
        <span class="hl-keyword">this</span>.birthdate = c.getTime();
    }

    <span class="hl-keyword">public</span> Inventor(String name, Date birthdate, String nationality) {
        <span class="hl-keyword">this</span>.name = name;
        <span class="hl-keyword">this</span>.nationality = nationality;
        <span class="hl-keyword">this</span>.birthdate = birthdate;
    }

    <span class="hl-keyword">public</span> Inventor() {
    }

    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

    <span class="hl-keyword">public</span> String getNationality() {
        <span class="hl-keyword">return</span> nationality;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setNationality(String nationality) {
        <span class="hl-keyword">this</span>.nationality = nationality;
    }

    <span class="hl-keyword">public</span> Date getBirthdate() {
        <span class="hl-keyword">return</span> birthdate;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setBirthdate(Date birthdate) {
        <span class="hl-keyword">this</span>.birthdate = birthdate;
    }

    <span class="hl-keyword">public</span> PlaceOfBirth getPlaceOfBirth() {
        <span class="hl-keyword">return</span> placeOfBirth;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPlaceOfBirth(PlaceOfBirth placeOfBirth) {
        <span class="hl-keyword">this</span>.placeOfBirth = placeOfBirth;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setInventions(String[] inventions) {
        <span class="hl-keyword">this</span>.inventions = inventions;
    }

    <span class="hl-keyword">public</span> String[] getInventions() {
        <span class="hl-keyword">return</span> inventions;
    }
}</pre>

<p>PlaceOfBirth.java</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.spring.samples.spel.inventor;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PlaceOfBirth {

    <span class="hl-keyword">private</span> String city;
    <span class="hl-keyword">private</span> String country;

    <span class="hl-keyword">public</span> PlaceOfBirth(String city) {
        <span class="hl-keyword">this</span>.city=city;
    }

    <span class="hl-keyword">public</span> PlaceOfBirth(String city, String country) {
        <span class="hl-keyword">this</span>(city);
        <span class="hl-keyword">this</span>.country = country;
    }

    <span class="hl-keyword">public</span> String getCity() {
        <span class="hl-keyword">return</span> city;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setCity(String s) {
        <span class="hl-keyword">this</span>.city = s;
    }

    <span class="hl-keyword">public</span> String getCountry() {
        <span class="hl-keyword">return</span> country;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setCountry(String country) {
        <span class="hl-keyword">this</span>.country = country;
    }

}</pre>

<p>Society.java</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.spring.samples.spel.inventor;

<span class="hl-keyword">import</span> java.util.*;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Society {

    <span class="hl-keyword">private</span> String name;

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> String Advisors = <span class="hl-string">"advisors"</span>;
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> String President = <span class="hl-string">"president"</span>;

    <span class="hl-keyword">private</span> List&lt;Inventor&gt; members = <span class="hl-keyword">new</span> ArrayList&lt;Inventor&gt;();
    <span class="hl-keyword">private</span> Map officers = <span class="hl-keyword">new</span> HashMap();

    <span class="hl-keyword">public</span> List getMembers() {
        <span class="hl-keyword">return</span> members;
    }

    <span class="hl-keyword">public</span> Map getOfficers() {
        <span class="hl-keyword">return</span> officers;
    }

    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isMember(String name) {
        <span class="hl-keyword">for</span> (Inventor inventor : members) {
            <span class="hl-keyword">if</span> (inventor.getName().equals(name)) {
                <span class="hl-keyword">return</span> true;
            }
        }
        <span class="hl-keyword">return</span> false;
    }

}</pre>

</div>
</div>
<div class="chapter" title="8.&nbsp;Aspect Oriented Programming with Spring"><div class="titlepage"><div><div><h2 class="title"><a name="aop"></a>8.&nbsp;Aspect Oriented Programming with Spring</h2></div></div></div>

<div class="section" title="8.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-introduction"></a>8.1&nbsp;Introduction</h2></div></div></div>

<p><span class="emphasis"><em>Aspect-Oriented Programming</em></span> (AOP) complements Object-Oriented Programming (OOP) by
providing another way of thinking about program structure. The key unit of modularity in
OOP is the class, whereas in AOP the unit of modularity is the <span class="emphasis"><em>aspect</em></span>. Aspects
enable the modularization of concerns such as transaction management that cut across
multiple types and objects. (Such concerns are often termed <span class="emphasis"><em>crosscutting</em></span> concerns in
AOP literature.)</p>
<p>One of the key components of Spring is the <span class="emphasis"><em>AOP framework</em></span>. While the Spring IoC
container does not depend on AOP, meaning you do not need to use AOP if you don&#8217;t want
to, AOP complements Spring IoC to provide a very capable middleware solution.</p>
<div class="sidebar" title="Spring 2.0 AOP"><p class="title"><b>Spring 2.0 AOP</b></p>

<p>Spring 2.0 introduces a simpler and more powerful way of writing custom aspects using
either a <a class="link" href="#aop-schema" title="8.3&nbsp;Schema-based AOP support">schema-based approach</a> or the <a class="link" href="#aop-ataspectj" title="8.2&nbsp;@AspectJ support">@AspectJ annotation
style</a>. Both of these styles offer fully typed advice and use of the AspectJ pointcut
language, while still using Spring AOP for weaving.</p>
<p>The Spring 2.0 schema- and @AspectJ-based AOP support is discussed in this chapter.
Spring 2.0 AOP remains fully backwards compatible with Spring 1.2 AOP, and the
lower-level AOP support offered by the Spring 1.2 APIs is discussed in <a class="link" href="#aop-api" title="9.&nbsp;Spring AOP APIs">the
following chapter</a>.</p>
</div>

<p>AOP is used in the Spring Framework to&#8230;</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
&#8230; provide declarative enterprise services, especially as a replacement for EJB
declarative services. The most important such service is
<a class="link" href="#transaction-declarative" title="11.5&nbsp;Declarative transaction management"><span class="emphasis"><em>declarative transaction management</em></span></a>.
</li><li class="listitem">
&#8230; allow users to implement custom aspects, complementing their use of OOP with AOP.
</li></ul></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are interested only in generic declarative services or other pre-packaged
declarative middleware services such as pooling, you do not need to work directly with
Spring AOP, and can skip most of this chapter.</p>
</td></tr></table></div>

<div class="section" title="8.1.1&nbsp;AOP concepts"><div class="titlepage"><div><div><h3 class="title"><a name="aop-introduction-defn"></a>8.1.1&nbsp;AOP concepts</h3></div></div></div>

<p>Let us begin by defining some central AOP concepts and terminology. These terms are not
Spring-specific&#8230; unfortunately, AOP terminology is not particularly intuitive;
however, it would be even more confusing if Spring used its own terminology.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>Aspect</em></span>: a modularization of a concern that cuts across multiple classes.
Transaction management is a good example of a crosscutting concern in enterprise Java
applications. In Spring AOP, aspects are implemented using regular classes
(the <a class="link" href="#aop-schema" title="8.3&nbsp;Schema-based AOP support">schema-based approach</a>) or regular classes annotated with the
<code class="literal">@Aspect</code> annotation (the <a class="link" href="#aop-ataspectj" title="8.2&nbsp;@AspectJ support"><code class="literal">@AspectJ</code> style</a>).
</li><li class="listitem">
<span class="emphasis"><em>Join point</em></span>: a point during the execution of a program, such as the execution of a
method or the handling of an exception. In Spring AOP, a join point <span class="emphasis"><em>always</em></span>
represents a method execution.
</li><li class="listitem">
<span class="emphasis"><em>Advice</em></span>: action taken by an aspect at a particular join point. Different types of
advice include "around," "before" and "after" advice. (Advice types are discussed
below.) Many AOP frameworks, including Spring, model an advice as an <span class="emphasis"><em>interceptor</em></span>,
maintaining a chain of interceptors <span class="emphasis"><em>around</em></span> the join point.
</li><li class="listitem">
<span class="emphasis"><em>Pointcut</em></span>: a predicate that matches join points. Advice is associated with a
pointcut expression and runs at any join point matched by the pointcut (for example,
the execution of a method with a certain name). The concept of join points as matched
by pointcut expressions is central to AOP, and Spring uses the AspectJ pointcut
expression language by default.
</li><li class="listitem">
<span class="emphasis"><em>Introduction</em></span>: declaring additional methods or fields on behalf of a type. Spring
AOP allows you to introduce new interfaces (and a corresponding implementation) to any
advised object. For example, you could use an introduction to make a bean implement an
<code class="literal">IsModified</code> interface, to simplify caching. (An introduction is known as an
inter-type declaration in the AspectJ community.)
</li><li class="listitem">
<span class="emphasis"><em>Target object</em></span>: object being advised by one or more aspects. Also referred to as
the <span class="emphasis"><em>advised</em></span> object. Since Spring AOP is implemented using runtime proxies, this
object will always be a <span class="emphasis"><em>proxied</em></span> object.
</li><li class="listitem">
<span class="emphasis"><em>AOP proxy</em></span>: an object created by the AOP framework in order to implement the aspect
contracts (advise method executions and so on). In the Spring Framework, an AOP proxy
will be a JDK dynamic proxy or a CGLIB proxy.
</li><li class="listitem">
<span class="emphasis"><em>Weaving</em></span>: linking aspects with other application types or objects to create an
advised object. This can be done at compile time (using the AspectJ compiler, for
example), load time, or at runtime. Spring AOP, like other pure Java AOP frameworks,
performs weaving at runtime.
</li></ul></div>

<p>Types of advice:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>Before advice</em></span>: Advice that executes before a join point, but which does not have
the ability to prevent execution flow proceeding to the join point (unless it throws
an exception).
</li><li class="listitem">
<span class="emphasis"><em>After returning advice</em></span>: Advice to be executed after a join point completes
normally: for example, if a method returns without throwing an exception.
</li><li class="listitem">
<span class="emphasis"><em>After throwing advice</em></span>: Advice to be executed if a method exits by throwing an
exception.
</li><li class="listitem">
<span class="emphasis"><em>After (finally) advice</em></span>: Advice to be executed regardless of the means by which a
join point exits (normal or exceptional return).
</li><li class="listitem">
<span class="emphasis"><em>Around advice</em></span>: Advice that surrounds a join point such as a method invocation.
This is the most powerful kind of advice. Around advice can perform custom behavior
before and after the method invocation. It is also responsible for choosing whether to
proceed to the join point or to shortcut the advised method execution by returning its
own return value or throwing an exception.
</li></ul></div>

<p>Around advice is the most general kind of advice. Since Spring AOP, like AspectJ,
provides a full range of advice types, we recommend that you use the least powerful
advice type that can implement the required behavior. For example, if you need only to
update a cache with the return value of a method, you are better off implementing an
after returning advice than an around advice, although an around advice can accomplish
the same thing. Using the most specific advice type provides a simpler programming model
with less potential for errors. For example, you do not need to invoke the <code class="literal">proceed()</code>
method on the <code class="literal">JoinPoint</code> used for around advice, and hence cannot fail to invoke it.</p>
<p>In Spring 2.0, all advice parameters are statically typed, so that you work with advice
parameters of the appropriate type (the type of the return value from a method execution
for example) rather than <code class="literal">Object</code> arrays.</p>
<p>The concept of join points, matched by pointcuts, is the key to AOP which distinguishes
it from older technologies offering only interception. Pointcuts enable advice to be
targeted independently of the Object-Oriented hierarchy. For example, an around advice
providing declarative transaction management can be applied to a set of methods spanning
multiple objects (such as all business operations in the service layer).</p>
</div>
<div class="section" title="8.1.2&nbsp;Spring AOP capabilities and goals"><div class="titlepage"><div><div><h3 class="title"><a name="aop-introduction-spring-defn"></a>8.1.2&nbsp;Spring AOP capabilities and goals</h3></div></div></div>

<p>Spring AOP is implemented in pure Java. There is no need for a special compilation
process. Spring AOP does not need to control the class loader hierarchy, and is thus
suitable for use in a Servlet container or application server.</p>
<p>Spring AOP currently supports only method execution join points (advising the execution
of methods on Spring beans). Field interception is not implemented, although support for
field interception could be added without breaking the core Spring AOP APIs. If you need
to advise field access and update join points, consider a language such as AspectJ.</p>
<p>Spring AOP&#8217;s approach to AOP differs from that of most other AOP frameworks. The aim is
not to provide the most complete AOP implementation (although Spring AOP is quite
capable); it is rather to provide a close integration between AOP implementation and
Spring IoC to help solve common problems in enterprise applications.</p>
<p>Thus, for example, the Spring Framework&#8217;s AOP functionality is normally used in
conjunction with the Spring IoC container. Aspects are configured using normal bean
definition syntax (although this allows powerful "autoproxying" capabilities): this is a
crucial difference from other AOP implementations. There are some things you cannot do
easily or efficiently with Spring AOP, such as advise very fine-grained objects (such as
domain objects typically): AspectJ is the best choice in such cases. However, our
experience is that Spring AOP provides an excellent solution to most problems in
enterprise Java applications that are amenable to AOP.</p>
<p>Spring AOP will never strive to compete with AspectJ to provide a comprehensive AOP
solution. We believe that both proxy-based frameworks like Spring AOP and full-blown
frameworks such as AspectJ are valuable, and that they are complementary, rather than in
competition. Spring seamlessly integrates Spring AOP and IoC with AspectJ, to enable
all uses of AOP to be catered for within a consistent Spring-based application
architecture. This integration does not affect the Spring AOP API or the AOP Alliance
API: Spring AOP remains backward-compatible. See <a class="link" href="#aop-api" title="9.&nbsp;Spring AOP APIs">the following chapter</a> for a
discussion of the Spring AOP APIs.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>One of the central tenets of the Spring Framework is that of <span class="emphasis"><em>non-invasiveness</em></span>; this
is the idea that you should not be forced to introduce framework-specific classes and
interfaces into your business/domain model. However, in some places the Spring Framework
does give you the option to introduce Spring Framework-specific dependencies into your
codebase: the rationale in giving you such options is because in certain scenarios it
might be just plain easier to read or code some specific piece of functionality in such
a way. The Spring Framework (almost) always offers you the choice though: you have the
freedom to make an informed decision as to which option best suits your particular use
case or scenario.</p>
<p>One such choice that is relevant to this chapter is that of which AOP framework (and
which AOP style) to choose. You have the choice of AspectJ and/or Spring AOP, and you
also have the choice of either the @AspectJ annotation-style approach or the Spring XML
configuration-style approach. The fact that this chapter chooses to introduce the
@AspectJ-style approach first should not be taken as an indication that the Spring team
favors the @AspectJ annotation-style approach over the Spring XML configuration-style.</p>
<p>See <a class="xref" href="#aop-choosing" title="8.4&nbsp;Choosing which AOP declaration style to use">Section&nbsp;8.4, &#8220;Choosing which AOP declaration style to use&#8221;</a> for a more complete discussion of the whys and wherefores of each
style.</p>
</td></tr></table></div>

</div>
<div class="section" title="8.1.3&nbsp;AOP Proxies"><div class="titlepage"><div><div><h3 class="title"><a name="aop-introduction-proxies"></a>8.1.3&nbsp;AOP Proxies</h3></div></div></div>

<p>Spring AOP defaults to using standard J2SE <span class="emphasis"><em>dynamic proxies</em></span> for AOP proxies. This
enables any interface (or set of interfaces) to be proxied.</p>
<p>Spring AOP can also use CGLIB proxies. This is necessary to proxy classes, rather than
interfaces. CGLIB is used by default if a business object does not implement an
interface. As it is good practice to program to interfaces rather than classes, business
classes normally will implement one or more business interfaces. It is possible to
<a class="link" href="#">force the use of CGLIB</a>, in those (hopefully rare) cases
where you need to advise a method that is not declared on an interface, or where you
need to pass a proxied object to a method as a concrete type.</p>
<p>It is important to grasp the fact that Spring AOP is <span class="emphasis"><em>proxy-based</em></span>. See
<a class="xref" href="#aop-understanding-aop-proxies" title="8.6.1&nbsp;Understanding AOP proxies">Section&nbsp;8.6.1, &#8220;Understanding AOP proxies&#8221;</a> for a thorough examination of exactly what this
implementation detail actually means.</p>
</div>
</div>
<div class="section" title="8.2&nbsp;@AspectJ support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-ataspectj"></a>8.2&nbsp;@AspectJ support</h2></div></div></div>

<p>@AspectJ refers to a style of declaring aspects as regular Java classes annotated with
annotations. The @AspectJ style was introduced by the
<a class="ulink" href="http://www.eclipse.org/aspectj" target="_top">AspectJ project</a> as part of the AspectJ 5 release. Spring
interprets the same annotations as AspectJ 5, using a library supplied by AspectJ
for pointcut parsing and matching. The AOP runtime is still pure Spring AOP though, and
there is no dependency on the AspectJ compiler or weaver.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using the AspectJ compiler and weaver enables use of the full AspectJ language, and is
discussed in <a class="xref" href="#aop-using-aspectj" title="8.8&nbsp;Using AspectJ with Spring applications">Section&nbsp;8.8, &#8220;Using AspectJ with Spring applications&#8221;</a>.</p>
</td></tr></table></div>

<div class="section" title="8.2.1&nbsp;Enabling @AspectJ Support"><div class="titlepage"><div><div><h3 class="title"><a name="aop-aspectj-support"></a>8.2.1&nbsp;Enabling @AspectJ Support</h3></div></div></div>

<p>To use @AspectJ aspects in a Spring configuration you need to enable Spring support for
configuring Spring AOP based on @AspectJ aspects, and <span class="emphasis"><em>autoproxying</em></span> beans based on
whether or not they are advised by those aspects. By autoproxying we mean that if Spring
determines that a bean is advised by one or more aspects, it will automatically generate
a proxy for that bean to intercept method invocations and ensure that advice is executed
as needed.</p>
<p>The @AspectJ support can be enabled with XML or Java style configuration. In either
case you will also need to ensure that AspectJ&#8217;s <code class="literal">aspectjweaver.jar</code> library is on the
classpath of your application (version 1.6.8 or later). This library is available in the
<code class="literal">'lib'</code> directory of an AspectJ distribution or via the Maven Central repository.</p>
<div class="section" title="Enabling @AspectJ Support with Java configuration"><div class="titlepage"><div><div><h4 class="title"><a name="aop-enable-aspectj-java"></a>Enabling @AspectJ Support with Java configuration</h4></div></div></div>

<p>To enable @AspectJ support with Java <code class="literal">@Configuration</code> add the <code class="literal">@EnableAspectJAutoProxy</code>
annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableAspectJAutoProxy</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

}</pre>

</div>
<div class="section" title="Enabling @AspectJ Support with XML configuration"><div class="titlepage"><div><div><h4 class="title"><a name="aop-enable-aspectj-xml"></a>Enabling @AspectJ Support with XML configuration</h4></div></div></div>

<p>To enable @AspectJ support with XML based configuration use the <code class="literal">aop:aspectj-autoproxy</code>
element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspectj-autoproxy/&gt;</span></pre>

<p>This assumes that you are using schema support as described in <a class="xref" href="#xsd-config" title="33.&nbsp;XML Schema-based configuration">Chapter&nbsp;33, <i>XML Schema-based configuration</i></a>. See
<a class="xref" href="#xsd-config-body-schemas-aop" title="33.2.7&nbsp;the aop schema">Section&nbsp;33.2.7, &#8220;the aop schema&#8221;</a> for how to import the tags in the aop namespace.</p>
</div>
</div>
<div class="section" title="8.2.2&nbsp;Declaring an aspect"><div class="titlepage"><div><div><h3 class="title"><a name="aop-at-aspectj"></a>8.2.2&nbsp;Declaring an aspect</h3></div></div></div>

<p>With the @AspectJ support enabled, any bean defined in your application context with a
class that is an @AspectJ aspect (has the <code class="literal">@Aspect</code> annotation) will be automatically
detected by Spring and used to configure Spring AOP. The following example shows the
minimal definition required for a not-very-useful aspect:</p>
<p>A regular bean definition in the application context, pointing to a bean class that has
the <code class="literal">@Aspect</code> annotation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAspect"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.xyz.NotVeryUsefulAspect"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- configure properties of aspect here as normal --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>And the <code class="literal">NotVeryUsefulAspect</code> class definition, annotated with
<code class="literal">org.aspectj.lang.annotation.Aspect</code> annotation;</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.xyz;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> NotVeryUsefulAspect {

}</pre>

<p>Aspects (classes annotated with <code class="literal">@Aspect</code>) may have methods and fields just like any
other class. They may also contain pointcut, advice, and introduction (inter-type)
declarations.</p>
<div class="note" title="Autodetecting aspects through component scanning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Autodetecting aspects through component scanning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Autodetecting aspects through component scanning</th></tr><tr><td align="left" valign="top">

<p>You may register aspect classes as regular beans in your Spring XML configuration, or
autodetect them through classpath scanning - just like any other Spring-managed bean.
However, note that the <span class="emphasis"><em>@Aspect</em></span> annotation is <span class="emphasis"><em>not</em></span> sufficient for autodetection in
the classpath: For that purpose, you need to add a separate <span class="emphasis"><em>@Component</em></span> annotation
(or alternatively a custom stereotype annotation that qualifies, as per the rules of
Spring&#8217;s component scanner).</p>
</td></tr></table></div>

<div class="note" title="Advising aspects with other aspects?" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Advising aspects with other aspects?"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Advising aspects with other aspects?</th></tr><tr><td align="left" valign="top">

<p>In Spring AOP, it is <span class="emphasis"><em>not</em></span> possible to have aspects themselves be the target of advice
from other aspects. The <span class="emphasis"><em>@Aspect</em></span> annotation on a class marks it as an aspect, and
hence excludes it from auto-proxying.</p>
</td></tr></table></div>

</div>
<div class="section" title="8.2.3&nbsp;Declaring a pointcut"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pointcuts"></a>8.2.3&nbsp;Declaring a pointcut</h3></div></div></div>

<p>Recall that pointcuts determine join points of interest, and thus enable us to control
when advice executes. <span class="emphasis"><em>Spring AOP only supports method execution join points for Spring
beans</em></span>, so you can think of a pointcut as matching the execution of methods on Spring
beans. A pointcut declaration has two parts: a signature comprising a name and any
parameters, and a pointcut expression that determines <span class="emphasis"><em>exactly</em></span> which method
executions we are interested in. In the @AspectJ annotation-style of AOP, a pointcut
signature is provided by a regular method definition, and the pointcut expression is
indicated using the <code class="literal">@Pointcut</code> annotation (the method serving as the pointcut signature
<span class="emphasis"><em>must</em></span> have a <code class="literal">void</code> return type).</p>
<p>An example will help make this distinction between a pointcut signature and a pointcut
expression clear. The following example defines a pointcut named <code class="literal">'anyOldTransfer'</code> that
will match the execution of any method named <code class="literal">'transfer'</code>:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Pointcut("execution(* transfer(..))")//</span></i> the pointcut expression
<span class="hl-keyword">private</span> <span class="hl-keyword">void</span> anyOldTransfer() {}<span class="hl-comment">// the pointcut signature</span></pre>

<p>The pointcut expression that forms the value of the <code class="literal">@Pointcut</code> annotation is a regular
AspectJ 5 pointcut expression. For a full discussion of AspectJ&#8217;s pointcut language, see
the <a class="ulink" href="http://www.eclipse.org/aspectj/doc/released/progguide/index.html" target="_top">AspectJ
Programming Guide</a> (and for extensions, the
<a class="ulink" href="http://www.eclipse.org/aspectj/doc/released/adk15notebook/index.html" target="_top">AspectJ 5
Developers Notebook</a>) or one of the books on AspectJ such as "Eclipse AspectJ" by Colyer
et. al. or "AspectJ in Action" by Ramnivas Laddad.</p>
<div class="section" title="Supported Pointcut Designators"><div class="titlepage"><div><div><h4 class="title"><a name="aop-pointcuts-designators"></a>Supported Pointcut Designators</h4></div></div></div>

<p>Spring AOP supports the following AspectJ pointcut designators (PCD) for use in pointcut
expressions:</p>
<div class="sidebar" title="Other pointcut types"><p class="title"><b>Other pointcut types</b></p>

<p>The full AspectJ pointcut language supports additional pointcut designators that are not
supported in Spring. These are: <code class="literal">call, get, set, preinitialization,
staticinitialization, initialization, handler, adviceexecution, withincode, cflow,
cflowbelow, if, @this</code>, and <code class="literal">@withincode</code>. Use of these pointcut designators in pointcut
expressions interpreted by Spring AOP will result in an <code class="literal">IllegalArgumentException</code> being
thrown.</p>
<p>The set of pointcut designators supported by Spring AOP may be extended in future
releases to support more of the AspectJ pointcut designators.</p>
</div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>execution</em></span> - for matching method execution join points, this is the primary
pointcut designator you will use when working with Spring AOP
</li><li class="listitem">
<span class="emphasis"><em>within</em></span> - limits matching to join points within certain types (simply the execution
of a method declared within a matching type when using Spring AOP)
</li><li class="listitem">
<span class="emphasis"><em>this</em></span> - limits matching to join points (the execution of methods when using Spring
AOP) where the bean reference (Spring AOP proxy) is an instance of the given type
</li><li class="listitem">
<span class="emphasis"><em>target</em></span> - limits matching to join points (the execution of methods when using
Spring AOP) where the target object (application object being proxied) is an instance
of the given type
</li><li class="listitem">
<span class="emphasis"><em>args</em></span> - limits matching to join points (the execution of methods when using Spring
AOP) where the arguments are instances of the given types
</li><li class="listitem">
<span class="emphasis"><em>@target</em></span> - limits matching to join points (the execution of methods when using
Spring AOP) where the class of the executing object has an annotation of the given type
</li><li class="listitem">
<span class="emphasis"><em>@args</em></span> - limits matching to join points (the execution of methods when using Spring
AOP) where the runtime type of the actual arguments passed have annotations of the
given type(s)
</li><li class="listitem">
<span class="emphasis"><em>@within</em></span> - limits matching to join points within types that have the given
annotation (the execution of methods declared in types with the given annotation when
using Spring AOP)
</li><li class="listitem">
<span class="emphasis"><em>@annotation</em></span> - limits matching to join points where the subject of the join point
(method being executed in Spring AOP) has the given annotation
</li></ul></div>

<p>Because Spring AOP limits matching to only method execution join points, the discussion
of the pointcut designators above gives a narrower definition than you will find in the
AspectJ programming guide. In addition, AspectJ itself has type-based semantics and at
an execution join point both ' <code class="literal">this</code>' and ' <code class="literal">target</code>' refer to the same object - the
object executing the method. Spring AOP is a proxy-based system and differentiates
between the proxy object itself (bound to ' <code class="literal">this</code><span class="emphasis"><em>) and the target object behind the
proxy (bound to ' <code class="literal">target</code></em></span>).</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Due to the proxy-based nature of Spring&#8217;s AOP framework, protected methods are by
definition <span class="emphasis"><em>not</em></span> intercepted, neither for JDK proxies (where this isn&#8217;t applicable)
nor for CGLIB proxies (where this is technically possible but not recommendable for AOP
purposes). As a consequence, any given pointcut will be matched against <span class="emphasis"><em>public methods
only</em></span>!</p>
<p>If your interception needs include protected/private methods or even constructors,
consider the use of Spring-driven <a class="link" href="#aop-aj-ltw" title="8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework">native AspectJ weaving</a> instead of
Spring&#8217;s proxy-based AOP framework. This constitutes a different mode of AOP usage with
different characteristics, so be sure to make yourself familiar with weaving first
before making a decision.</p>
</td></tr></table></div>

<p>Spring AOP also supports an additional PCD named ' <code class="literal">bean</code><span class="emphasis"><em>. This PCD allows you to limit
the matching of join points to a particular named Spring bean, or to a set of named
Spring beans (when using wildcards). The ' <code class="literal">bean</code></em></span> PCD has the following form:</p>
<pre class="programlisting">bean(idOrNameOfBean)</pre>

<p>The ' <code class="literal">idOrNameOfBean</code>' token can be the name of any Spring bean: limited wildcard
support using the ' <code class="literal">*</code>' character is provided, so if you establish some naming
conventions for your Spring beans you can quite easily write a ' <code class="literal">bean</code>' PCD expression
to pick them out. As is the case with other pointcut designators, the ' <code class="literal">bean</code>' PCD can
be &amp;&amp;'ed, ||'ed, and ! (negated) too.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please note that the ' <code class="literal">bean</code>' PCD is <span class="emphasis"><em>only</em></span> supported in Spring AOP - and <span class="emphasis"><em>not</em></span> in
native AspectJ weaving. It is a Spring-specific extension to the standard PCDs that
AspectJ defines.</p>
<p>The ' <code class="literal">bean</code>' PCD operates at the <span class="emphasis"><em>instance</em></span> level (building on the Spring bean name
concept) rather than at the type level only (which is what weaving-based AOP is limited
to). Instance-based pointcut designators are a special capability of Spring&#8217;s
proxy-based AOP framework and its close integration with the Spring bean factory, where
it is natural and straightforward to identify specific beans by name.</p>
</td></tr></table></div>

</div>
<div class="section" title="Combining pointcut expressions"><div class="titlepage"><div><div><h4 class="title"><a name="aop-pointcuts-combining"></a>Combining pointcut expressions</h4></div></div></div>

<p>Pointcut expressions can be combined using <span class="emphasis"><em>&amp;&amp;</em></span>, <span class="emphasis"><em>||</em></span> and <span class="emphasis"><em>!</em></span>. It is also possible to
refer to pointcut expressions by name. The following example shows three pointcut
expressions: <code class="literal">anyPublicOperation</code> (which matches if a method execution join point
represents the execution of any public method); <code class="literal">inTrading</code> (which matches if a method
execution is in the trading module), and <code class="literal">tradingOperation</code> (which matches if a method
execution represents any public method in the trading module).</p>
<pre class="programlisting">@Pointcut(<span class="hl-string">"execution(public * </span><span class="strong"><strong>(..))")
    private void anyPublicOperation() {}

    @Pointcut("within(com.xyz.someapp.trading..</strong></span>)<span class="hl-string">")
</span>    <span class="hl-keyword">private</span> <span class="hl-keyword">void</span> inTrading() {}

    <i><span class="hl-annotation" style="color: gray">@Pointcut("anyPublicOperation() &amp;&amp; inTrading()")</span></i>
    <span class="hl-keyword">private</span> <span class="hl-keyword">void</span> tradingOperation() {}</pre>

<p>It is a best practice to build more complex pointcut expressions out of smaller named
components as shown above. When referring to pointcuts by name, normal Java visibility
rules apply (you can see private pointcuts in the same type, protected pointcuts in the
hierarchy, public pointcuts anywhere and so on). Visibility does not affect pointcut
<span class="emphasis"><em>matching</em></span>.</p>
</div>
<div class="section" title="Sharing common pointcut definitions"><div class="titlepage"><div><div><h4 class="title"><a name="aop-common-pointcuts"></a>Sharing common pointcut definitions</h4></div></div></div>

<p>When working with enterprise applications, you often want to refer to modules of the
application and particular sets of operations from within several aspects. We recommend
defining a "SystemArchitecture" aspect that captures common pointcut expressions for
this purpose. A typical such aspect would look as follows:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.xyz.someapp;

<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Pointcut;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SystemArchitecture {

    /<span class="strong"><strong>
     * A join point is in the web layer if the method is defined
     * in a type in the com.xyz.someapp.web package or any sub-package
     * under that.
     <span class="strong"><strong>/
    @Pointcut("within(com.xyz.someapp.web..</strong></span>)")
    public void inWebLayer() {}

    /</strong></span>
     * A join point is in the service layer <span class="hl-keyword">if</span> the method is defined
     * in a type in the com.xyz.someapp.service <span class="hl-keyword">package</span> or any sub-<span class="hl-keyword">package</span>
     * under that.
     <span class="strong"><strong>/
    @Pointcut("within(com.xyz.someapp.service..</strong></span>)<span class="hl-string">")
</span>    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> inServiceLayer() {}

    /<span class="strong"><strong>
     * A join point is in the data access layer if the method is defined
     * in a type in the com.xyz.someapp.dao package or any sub-package
     * under that.
     <span class="strong"><strong>/
    @Pointcut("within(com.xyz.someapp.dao..</strong></span>)")
    public void inDataAccessLayer() {}

    /</strong></span>
     * A business service is the execution of any method defined on a service
     * <span class="hl-keyword">interface</span>. This definition assumes that interfaces are placed in the
     * <span class="hl-string">"service"</span> <span class="hl-keyword">package</span>, and that implementation types are in sub-packages.
     *
     * If you group service interfaces by functional area (<span class="hl-keyword">for</span> example,
     * in packages com.xyz.someapp.abc.service and com.xyz.def.service) then
     * the pointcut expression <span class="hl-string">"execution(* com.xyz.someapp..service.</span><span class="strong"><strong>.</strong></span>(..))<span class="hl-string">"
</span>     * could be used instead.
     *
     * Alternatively, you can write the expression using the <span class="emphasis"><em>bean</em></span>
     * PCD, like so <span class="hl-string">"bean(</span><span class="strong"><strong>Service)". (This assumes that you have
     * named your Spring service beans in a consistent fashion.)
     */
    @Pointcut("execution(</strong></span> com.xyz.someapp.service.<span class="strong"><strong>.</strong></span>(..))<span class="hl-string">")
</span>    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> businessService() {}

    /<span class="strong"><strong>*
     * A data access operation is the execution of any method defined on a
     * dao interface. This definition assumes that interfaces are placed in the
     * "dao" package, and that implementation types are in sub-packages.
     */
    @Pointcut("execution(</strong></span> com.xyz.someapp.dao.<span class="strong"><strong>.</strong></span>(..))<span class="hl-string">")
</span>    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> dataAccessOperation() {}

}</pre>

<p>The pointcuts defined in such an aspect can be referred to anywhere that you need a
pointcut expression. For example, to make the service layer transactional, you could
write:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>
    <span class="hl-tag">&lt;aop:advisor</span>
        <span class="hl-attribute">pointcut</span>=<span class="hl-value">"com.xyz.someapp.SystemArchitecture.businessService()"</span>
        <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"tx-advice"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"tx-advice"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;tx:attributes&gt;</span>
        <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/tx:attributes&gt;</span>
<span class="hl-tag">&lt;/tx:advice&gt;</span></pre>

<p>The <code class="literal">&lt;aop:config&gt;</code> and <code class="literal">&lt;aop:advisor&gt;</code> elements are discussed in <a class="xref" href="#aop-schema" title="8.3&nbsp;Schema-based AOP support">Section&nbsp;8.3, &#8220;Schema-based AOP support&#8221;</a>. The
transaction elements are discussed in <a class="xref" href="#transaction" title="11.&nbsp;Transaction Management">Chapter&nbsp;11, <i>Transaction Management</i></a>.</p>
</div>
<div class="section" title="Examples"><div class="titlepage"><div><div><h4 class="title"><a name="aop-pointcuts-examples"></a>Examples</h4></div></div></div>

<p>Spring AOP users are likely to use the <code class="literal">execution</code> pointcut designator the most often.
The format of an execution expression is:</p>
<pre class="programlisting">execution(modifiers-pattern? ret-type-pattern declaring-type-pattern? name-pattern(param-pattern)
            <span class="hl-keyword">throws</span>-pattern?)</pre>

<p>All parts except the returning type pattern (ret-type-pattern in the snippet above),
name pattern, and parameters pattern are optional. The returning type pattern determines
what the return type of the method must be in order for a join point to be matched. Most
frequently you will use <code class="literal">*</code> as the returning type pattern, which matches any return
type. A fully-qualified type name will match only when the method returns the given
type. The name pattern matches the method name. You can use the <code class="literal">*</code> wildcard as all or
part of a name pattern. The parameters pattern is slightly more complex: <code class="literal">()</code> matches a
method that takes no parameters, whereas <code class="literal">(..)</code> matches any number of parameters (zero
or more). The pattern <code class="literal">(*)</code> matches a method taking one parameter of any type,
<code class="literal">(*,String)</code> matches a method taking two parameters, the first can be of any type, the
second must be a String. Consult the
<a class="ulink" href="http://www.eclipse.org/aspectj/doc/released/progguide/semantics-pointcuts.html" target="_top">Language
Semantics</a> section of the AspectJ Programming Guide for more information.</p>
<p>Some examples of common pointcut expressions are given below.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
the execution of any public method:
</li></ul></div>

<pre class="programlisting">execution(<span class="hl-keyword">public</span> * *(..))</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
the execution of any method with a name beginning with "set":
</li></ul></div>

<pre class="programlisting">execution(* set*(..))</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
the execution of any method defined by the <code class="literal">AccountService</code> interface:
</li></ul></div>

<pre class="programlisting">execution(* com.xyz.service.AccountService.*(..))</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
the execution of any method defined in the service package:
</li></ul></div>

<pre class="programlisting">execution(* com.xyz.service.<span class="strong"><strong>.</strong></span>(..))</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
the execution of any method defined in the service package or a sub-package:
</li></ul></div>

<pre class="programlisting">execution(* com.xyz.service..<span class="strong"><strong>.</strong></span>(..))</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) within the service package:
</li></ul></div>

<pre class="programlisting">within(com.xyz.service.*)</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) within the service package or a
sub-package:
</li></ul></div>

<pre class="programlisting">within(com.xyz.service..*)</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) where the proxy implements the
<code class="literal">AccountService</code> interface:
</li></ul></div>

<pre class="programlisting"><span class="hl-keyword">this</span>(com.xyz.service.AccountService)</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>this</em></span> is more commonly used in a binding form :- see the following section on advice
for how to make the proxy object available in the advice body.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) where the target object
implements the <code class="literal">AccountService</code> interface:
</li></ul></div>

<pre class="programlisting">target(com.xyz.service.AccountService)</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>target</em></span> is more commonly used in a binding form :- see the following section on advice
for how to make the target object available in the advice body.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) which takes a single parameter,
and where the argument passed at runtime is <code class="literal">Serializable</code>:
</li></ul></div>

<pre class="programlisting">args(java.io.Serializable)</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>args</em></span> is more commonly used in a binding form :- see the following section on advice
for how to make the method arguments available in the advice body.</p>
</td></tr></table></div>

<p>Note that the pointcut given in this example is different to <code class="literal">execution(*
*(java.io.Serializable))</code>: the args version matches if the argument passed at runtime is
Serializable, the execution version matches if the method signature declares a single
parameter of type <code class="literal">Serializable</code>.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) where the target object has an
<code class="literal">@Transactional</code> annotation:
</li></ul></div>

<pre class="programlisting">@target(org.springframework.transaction.annotation.Transactional)</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>@target</em></span> can also be used in a binding form :- see the following section on advice for
how to make the annotation object available in the advice body.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) where the declared type of the
target object has an <code class="literal">@Transactional</code> annotation:
</li></ul></div>

<pre class="programlisting">@within(org.springframework.transaction.annotation.Transactional)</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>@within</em></span> can also be used in a binding form :- see the following section on advice for
how to make the annotation object available in the advice body.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) where the executing method has an
<code class="literal">@Transactional</code> annotation:
</li></ul></div>

<pre class="programlisting">@annotation(org.springframework.transaction.annotation.Transactional)</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>@annotation</em></span> can also be used in a binding form :- see the following section on advice
for how to make the annotation object available in the advice body.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) which takes a single parameter,
and where the runtime type of the argument passed has the <code class="literal">@Classified</code> annotation:
</li></ul></div>

<pre class="programlisting">@args(com.xyz.security.Classified)</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>@args</em></span> can also be used in a binding form :- see the following section on advice for
how to make the annotation object(s) available in the advice body.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) on a Spring bean named '
<code class="literal">tradeService</code>':
</li></ul></div>

<pre class="programlisting">bean(tradeService)</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
any join point (method execution only in Spring AOP) on Spring beans having names that
match the wildcard expression ' <code class="literal">*Service</code>':
</li></ul></div>

<pre class="programlisting">bean(*Service)</pre>

</div>
<div class="section" title="Writing good pointcuts"><div class="titlepage"><div><div><h4 class="title"><a name="writing-good-pointcuts"></a>Writing good pointcuts</h4></div></div></div>

<p>During compilation, AspectJ processes pointcuts in order to try and optimize matching
performance. Examining code and determining if each join point matches (statically or
dynamically) a given pointcut is a costly process. (A dynamic match means the match
cannot be fully determined from static analysis and a test will be placed in the code to
determine if there is an actual match when the code is running). On first encountering a
pointcut declaration, AspectJ will rewrite it into an optimal form for the matching
process. What does this mean? Basically pointcuts are rewritten in DNF (Disjunctive
Normal Form) and the components of the pointcut are sorted such that those components
that are cheaper to evaluate are checked first. This means you do not have to worry
about understanding the performance of various pointcut designators and may supply them
in any order in a pointcut declaration.</p>
<p>However, AspectJ can only work with what it is told, and for optimal performance of
matching you should think about what they are trying to achieve and narrow the search
space for matches as much as possible in the definition. The existing designators
naturally fall into one of three groups: kinded, scoping and context:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Kinded designators are those which select a particular kind of join point. For
example: execution, get, set, call, handler
</li><li class="listitem">
Scoping designators are those which select a group of join points of interest (of
probably many kinds). For example: within, withincode
</li><li class="listitem">
Contextual designators are those that match (and optionally bind) based on context.
For example: this, target, @annotation
</li></ul></div>

<p>A well written pointcut should try and include at least the first two types (kinded and
scoping), whilst the contextual designators may be included if wishing to match based on
join point context, or bind that context for use in the advice. Supplying either just a
kinded designator or just a contextual designator will work but could affect weaving
performance (time and memory used) due to all the extra processing and analysis. Scoping
designators are very fast to match and their usage means AspectJ can very quickly
dismiss groups of join points that should not be further processed - that is why a good
pointcut should always include one if possible.</p>
</div>
</div>
<div class="section" title="8.2.4&nbsp;Declaring advice"><div class="titlepage"><div><div><h3 class="title"><a name="aop-advice"></a>8.2.4&nbsp;Declaring advice</h3></div></div></div>

<p>Advice is associated with a pointcut expression, and runs before, after, or around
method executions matched by the pointcut. The pointcut expression may be either a
simple reference to a named pointcut, or a pointcut expression declared in place.</p>
<div class="section" title="Before advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-advice-before"></a>Before advice</h4></div></div></div>

<p>Before advice is declared in an aspect using the <code class="literal">@Before</code> annotation:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Before;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BeforeExample {

    <i><span class="hl-annotation" style="color: gray">@Before("com.xyz.myapp.SystemArchitecture.dataAccessOperation()")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doAccessCheck() {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<p>If using an in-place pointcut expression we could rewrite the above example as:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Before;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BeforeExample {

    @Before(<span class="hl-string">"execution(* com.xyz.myapp.dao.</span><span class="strong"><strong>.</strong></span>(..))<span class="hl-string">")
</span>    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doAccessCheck() {
        <span class="hl-comment">// ...</span>
    }

}</pre>

</div>
<div class="section" title="After returning advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-advice-after-returning"></a>After returning advice</h4></div></div></div>

<p>After returning advice runs when a matched method execution returns normally. It is
declared using the <code class="literal">@AfterReturning</code> annotation:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.AfterReturning;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AfterReturningExample {

    <i><span class="hl-annotation" style="color: gray">@AfterReturning("com.xyz.myapp.SystemArchitecture.dataAccessOperation()")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doAccessCheck() {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Note: it is of course possible to have multiple advice declarations, and other members
as well, all inside the same aspect. We&#8217;re just showing a single advice declaration in
these examples to focus on the issue under discussion at the time.</p>
</td></tr></table></div>

<p>Sometimes you need access in the advice body to the actual value that was returned. You
can use the form of <code class="literal">@AfterReturning</code> that binds the return value for this:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.AfterReturning;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AfterReturningExample {

    <i><span class="hl-annotation" style="color: gray">@AfterReturning(
        pointcut="com.xyz.myapp.SystemArchitecture.dataAccessOperation()",
        returning="retVal")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doAccessCheck(Object retVal) {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<p>The name used in the <code class="literal">returning</code> attribute must correspond to the name of a parameter in
the advice method. When a method execution returns, the return value will be passed to
the advice method as the corresponding argument value. A <code class="literal">returning</code> clause also
restricts matching to only those method executions that return a value of the specified
type ( <code class="literal">Object</code> in this case, which will match any return value).</p>
<p>Please note that it is <span class="emphasis"><em>not</em></span> possible to return a totally different reference when
using after-returning advice.</p>
</div>
<div class="section" title="After throwing advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-advice-after-throwing"></a>After throwing advice</h4></div></div></div>

<p>After throwing advice runs when a matched method execution exits by throwing an
exception. It is declared using the <code class="literal">@AfterThrowing</code> annotation:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.AfterThrowing;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AfterThrowingExample {

    <i><span class="hl-annotation" style="color: gray">@AfterThrowing("com.xyz.myapp.SystemArchitecture.dataAccessOperation()")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doRecoveryActions() {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<p>Often you want the advice to run only when exceptions of a given type are thrown, and
you also often need access to the thrown exception in the advice body. Use the
<code class="literal">throwing</code> attribute to both restrict matching (if desired, use <code class="literal">Throwable</code> as the
exception type otherwise) and bind the thrown exception to an advice parameter.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.AfterThrowing;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AfterThrowingExample {

    <i><span class="hl-annotation" style="color: gray">@AfterThrowing(
        pointcut="com.xyz.myapp.SystemArchitecture.dataAccessOperation()",
        throwing="ex")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doRecoveryActions(DataAccessException ex) {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<p>The name used in the <code class="literal">throwing</code> attribute must correspond to the name of a parameter in
the advice method. When a method execution exits by throwing an exception, the exception
will be passed to the advice method as the corresponding argument value. A <code class="literal">throwing</code>
clause also restricts matching to only those method executions that throw an exception
of the specified type ( <code class="literal">DataAccessException</code> in this case).</p>
</div>
<div class="section" title="After (finally) advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-advice-after-finally"></a>After (finally) advice</h4></div></div></div>

<p>After (finally) advice runs however a matched method execution exits. It is declared
using the <code class="literal">@After</code> annotation. After advice must be prepared to handle both normal and
exception return conditions. It is typically used for releasing resources, etc.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.After;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AfterFinallyExample {

    <i><span class="hl-annotation" style="color: gray">@After("com.xyz.myapp.SystemArchitecture.dataAccessOperation()")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doReleaseLock() {
        <span class="hl-comment">// ...</span>
    }

}</pre>

</div>
<div class="section" title="Around advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-ataspectj-around-advice"></a>Around advice</h4></div></div></div>

<p>The final kind of advice is around advice. Around advice runs "around" a matched method
execution. It has the opportunity to do work both before and after the method executes,
and to determine when, how, and even if, the method actually gets to execute at all.
Around advice is often used if you need to share state before and after a method
execution in a thread-safe manner (starting and stopping a timer for example). Always
use the least powerful form of advice that meets your requirements (i.e. don&#8217;t use
around advice if simple before advice would do).</p>
<p>Around advice is declared using the <code class="literal">@Around</code> annotation. The first parameter of the
advice method must be of type <code class="literal">ProceedingJoinPoint</code>. Within the body of the advice,
calling <code class="literal">proceed()</code> on the <code class="literal">ProceedingJoinPoint</code> causes the underlying method to
execute. The <code class="literal">proceed</code> method may also be called passing in an <code class="literal">Object[]</code> - the values
in the array will be used as the arguments to the method execution when it proceeds.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The behavior of proceed when called with an Object[] is a little different than the
behavior of proceed for around advice compiled by the AspectJ compiler. For around
advice written using the traditional AspectJ language, the number of arguments passed to
proceed must match the number of arguments passed to the around advice (not the number
of arguments taken by the underlying join point), and the value passed to proceed in a
given argument position supplants the original value at the join point for the entity
the value was bound to (Don&#8217;t worry if this doesn&#8217;t make sense right now!). The approach
taken by Spring is simpler and a better match to its proxy-based, execution only
semantics. You only need to be aware of this difference if you are compiling @AspectJ
aspects written for Spring and using proceed with arguments with the AspectJ compiler
and weaver. There is a way to write such aspects that is 100% compatible across both
Spring AOP and AspectJ, and this is discussed in the following section on advice
parameters.</p>
</td></tr></table></div>

<pre class="programlisting"><span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hl-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AroundExample {

    <i><span class="hl-annotation" style="color: gray">@Around("com.xyz.myapp.SystemArchitecture.businessService()")</span></i>
    <span class="hl-keyword">public</span> Object doBasicProfiling(ProceedingJoinPoint pjp) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// start stopwatch</span>
        Object retVal = pjp.proceed();
        <span class="hl-comment">// stop stopwatch</span>
        <span class="hl-keyword">return</span> retVal;
    }

}</pre>

<p>The value returned by the around advice will be the return value seen by the caller of
the method. A simple caching aspect for example could return a value from a cache if it
has one, and invoke proceed() if it does not. Note that proceed may be invoked once,
many times, or not at all within the body of the around advice, all of these are quite
legal.</p>
</div>
<div class="section" title="Advice parameters"><div class="titlepage"><div><div><h4 class="title"><a name="aop-ataspectj-advice-params"></a>Advice parameters</h4></div></div></div>

<p>Spring offers fully typed advice - meaning that you declare the parameters you need
in the advice signature (as we saw for the returning and throwing examples above) rather
than work with <code class="literal">Object[]</code> arrays all the time. We&#8217;ll see how to make argument and other
contextual values available to the advice body in a moment. First let&#8217;s take a look at
how to write generic advice that can find out about the method the advice is currently
advising.</p>
<div class="section" title="Access to the current JoinPoint"><div class="titlepage"><div><div><h5 class="title"><a name="aop-ataspectj-advice-params-the-joinpoint"></a>Access to the current JoinPoint</h5></div></div></div>

<p>Any advice method may declare as its first parameter, a parameter of type
<code class="literal">org.aspectj.lang.JoinPoint</code> (please note that around advice is <span class="emphasis"><em>required</em></span> to declare
a first parameter of type <code class="literal">ProceedingJoinPoint</code>, which is a subclass of <code class="literal">JoinPoint</code>. The
<code class="literal">JoinPoint</code> interface provides a number of useful methods such as <code class="literal">getArgs()</code> (returns
the method arguments), <code class="literal">getThis()</code> (returns the proxy object), <code class="literal">getTarget()</code> (returns
the target object), <code class="literal">getSignature()</code> (returns a description of the method that is being
advised) and <code class="literal">toString()</code> (prints a useful description of the method being advised).
Please do consult the Javadocs for full details.</p>
</div>
<div class="section" title="Passing parameters to advice"><div class="titlepage"><div><div><h5 class="title"><a name="aop-ataspectj-advice-params-passing"></a>Passing parameters to advice</h5></div></div></div>

<p>We&#8217;ve already seen how to bind the returned value or exception value (using after
returning and after throwing advice). To make argument values available to the advice
body, you can use the binding form of <code class="literal">args</code>. If a parameter name is used in place of a
type name in an args expression, then the value of the corresponding argument will be
passed as the parameter value when the advice is invoked. An example should make this
clearer. Suppose you want to advise the execution of dao operations that take an Account
object as the first parameter, and you need access to the account in the advice body.
You could write the following:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Before("com.xyz.myapp.SystemArchitecture.dataAccessOperation() &amp;&amp; args(account,..)")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> validateAccount(Account account) {
    <span class="hl-comment">// ...</span>
}</pre>

<p>The <code class="literal">args(account,..)</code> part of the pointcut expression serves two purposes: firstly, it
restricts matching to only those method executions where the method takes at least one
parameter, and the argument passed to that parameter is an instance of <code class="literal">Account</code>;
secondly, it makes the actual <code class="literal">Account</code> object available to the advice via the <code class="literal">account</code>
parameter.</p>
<p>Another way of writing this is to declare a pointcut that "provides" the <code class="literal">Account</code>
object value when it matches a join point, and then just refer to the named pointcut
from the advice. This would look as follows:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Pointcut("com.xyz.myapp.SystemArchitecture.dataAccessOperation() &amp;&amp; args(account,..)")</span></i>
<span class="hl-keyword">private</span> <span class="hl-keyword">void</span> accountDataAccessOperation(Account account) {}

<i><span class="hl-annotation" style="color: gray">@Before("accountDataAccessOperation(account)")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> validateAccount(Account account) {
    <span class="hl-comment">// ...</span>
}</pre>

<p>The interested reader is once more referred to the AspectJ programming guide for more
details.</p>
<p>The proxy object ( <code class="literal">this</code>), target object ( <code class="literal">target</code>), and annotations ( <code class="literal">@within,
@target, @annotation, @args</code>) can all be bound in a similar fashion. The following
example shows how you could match the execution of methods annotated with an
<code class="literal">@Auditable</code> annotation, and extract the audit code.</p>
<p>First the definition of the <code class="literal">@Auditable</code> annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Target(ElementType.METHOD)</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> Auditable {
    AuditCode value();
}</pre>

<p>And then the advice that matches the execution of <code class="literal">@Auditable</code> methods:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Before("com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; @annotation(auditable)")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> audit(Auditable auditable) {
    AuditCode code = auditable.value();
    <span class="hl-comment">// ...</span>
}</pre>

</div>
<div class="section" title="Advice parameters and generics"><div class="titlepage"><div><div><h5 class="title"><a name="aop-ataspectj-advice-params-generics"></a>Advice parameters and generics</h5></div></div></div>

<p>Spring AOP can handle generics used in class declarations and method parameters. Suppose
you have a generic type like this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Sample&lt;T&gt; {
    <span class="hl-keyword">void</span> sampleGenericMethod(T param);
    <span class="hl-keyword">void</span> sampleGenericCollectionMethod(Collection&gt;T&gt; param);
}</pre>

<p>You can restrict interception of method types to certain parameter types by simply
typing the advice parameter to the parameter type you want to intercept the method for:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Before("execution(* ..Sample+.sampleGenericMethod(*)) &amp;&amp; args(param)")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> beforeSampleMethod(MyType param) {
    <span class="hl-comment">// Advice implementation</span>
}</pre>

<p>That this works is pretty obvious as we already discussed above. However, it&#8217;s worth
pointing out that this won&#8217;t work for generic collections. So you cannot define a
pointcut like this:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Before("execution(* ..Sample+.sampleGenericCollectionMethod(*)) &amp;&amp; args(param)")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> beforeSampleMethod(Collection&lt;MyType&gt; param) {
    <span class="hl-comment">// Advice implementation</span>
}</pre>

<p>To make this work we would have to inspect every element of the collection, which is not
reasonable as we also cannot decide how to treat <code class="literal">null</code> values in general. To achieve
something similar to this you have to type the parameter to <code class="literal">Collection&lt;?&gt;</code> and manually
check the type of the elements.</p>
</div>
<div class="section" title="Determining argument names"><div class="titlepage"><div><div><h5 class="title"><a name="aop-ataspectj-advice-params-names"></a>Determining argument names</h5></div></div></div>

<p>The parameter binding in advice invocations relies on matching names used in pointcut
expressions to declared parameter names in (advice and pointcut) method signatures.
Parameter names are <span class="emphasis"><em>not</em></span> available through Java reflection, so Spring AOP uses the
following strategies to determine parameter names:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
If the parameter names have been specified by the user explicitly, then the specified
parameter names are used: both the advice and the pointcut annotations have
an optional "argNames" attribute which can be used to specify the argument names of
the annotated method - these argument names <span class="emphasis"><em>are</em></span> available at runtime. For example:
</li></ul></div>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Before(value="com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)",
        argNames="bean,auditable")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> audit(Object bean, Auditable auditable) {
    AuditCode code = auditable.value();
    <span class="hl-comment">// ... use code and bean</span>
}</pre>

<p>If the first parameter is of the <code class="literal">JoinPoint</code>, <code class="literal">ProceedingJoinPoint</code>, or
<code class="literal">JoinPoint.StaticPart</code> type, you may leave out the name of the parameter from the value
of the "argNames" attribute. For example, if you modify the preceding advice to receive
the join point object, the "argNames" attribute need not include it:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Before(value="com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)",
        argNames="bean,auditable")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> audit(JoinPoint jp, Object bean, Auditable auditable) {
    AuditCode code = auditable.value();
    <span class="hl-comment">// ... use code, bean, and jp</span>
}</pre>

<p>The special treatment given to the first parameter of the <code class="literal">JoinPoint</code>,
<code class="literal">ProceedingJoinPoint</code>, and <code class="literal">JoinPoint.StaticPart</code> types is particularly convenient for
advice that do not collect any other join point context. In such situations, you may
simply omit the "argNames" attribute. For example, the following advice need not declare
the "argNames" attribute:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Before("com.xyz.lib.Pointcuts.anyPublicMethod()")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> audit(JoinPoint jp) {
    <span class="hl-comment">// ... use jp</span>
}</pre>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Using the <code class="literal">'argNames'</code> attribute is a little clumsy, so if the <code class="literal">'argNames'</code> attribute
has not been specified, then Spring AOP will look at the debug information for the
class and try to determine the parameter names from the local variable table. This
information will be present as long as the classes have been compiled with debug
information ( <code class="literal">'-g:vars'</code> at a minimum). The consequences of compiling with this flag
on are: (1) your code will be slightly easier to understand (reverse engineer), (2)
the class file sizes will be very slightly bigger (typically inconsequential), (3) the
optimization to remove unused local variables will not be applied by your compiler. In
other words, you should encounter no difficulties building with this flag on.
</li></ul></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If an @AspectJ aspect has been compiled by the AspectJ compiler (ajc) even without the
debug information then there is no need to add the argNames attribute as the compiler
will retain the needed information.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
If the code has been compiled without the necessary debug information, then Spring AOP
will attempt to deduce the pairing of binding variables to parameters (for example, if
only one variable is bound in the pointcut expression, and the advice method only
takes one parameter, the pairing is obvious!). If the binding of variables is
ambiguous given the available information, then an <code class="literal">AmbiguousBindingException</code> will be
thrown.
</li><li class="listitem">
If all of the above strategies fail then an <code class="literal">IllegalArgumentException</code> will be thrown.
</li></ul></div>

</div>
<div class="section" title="Proceeding with arguments"><div class="titlepage"><div><div><h5 class="title"><a name="aop-ataspectj-advice-proceeding-with-the-call"></a>Proceeding with arguments</h5></div></div></div>

<p>We remarked earlier that we would describe how to write a proceed call <span class="emphasis"><em>with
arguments</em></span> that works consistently across Spring AOP and AspectJ. The solution is
simply to ensure that the advice signature binds each of the method parameters in order.
For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Around("execution(List&lt;Account&gt; find*(..)) &amp;&amp; " +
        "com.xyz.myapp.SystemArchitecture.inDataAccessLayer() &amp;&amp; " +
        "args(accountHolderNamePattern)")</span></i>
<span class="hl-keyword">public</span> Object preProcessQueryPattern(ProceedingJoinPoint pjp,
        String accountHolderNamePattern) <span class="hl-keyword">throws</span> Throwable {
    String newPattern = preProcess(accountHolderNamePattern);
    <span class="hl-keyword">return</span> pjp.proceed(<span class="hl-keyword">new</span> Object[] {newPattern});
}</pre>

<p>In many cases you will be doing this binding anyway (as in the example above).</p>
</div>
</div>
<div class="section" title="Advice ordering"><div class="titlepage"><div><div><h4 class="title"><a name="aop-ataspectj-advice-ordering"></a>Advice ordering</h4></div></div></div>

<p>What happens when multiple pieces of advice all want to run at the same join point?
Spring AOP follows the same precedence rules as AspectJ to determine the order of advice
execution. The highest precedence advice runs first "on the way in" (so given two pieces
of before advice, the one with highest precedence runs first). "On the way out" from a
join point, the highest precedence advice runs last (so given two pieces of after
advice, the one with the highest precedence will run second).</p>
<p>When two pieces of advice defined in <span class="emphasis"><em>different</em></span> aspects both need to run at the same
join point, unless you specify otherwise the order of execution is undefined. You can
control the order of execution by specifying precedence. This is done in the normal
Spring way by either implementing the <code class="literal">org.springframework.core.Ordered</code> interface in
the aspect class or annotating it with the <code class="literal">Order</code> annotation. Given two aspects, the
aspect returning the lower value from <code class="literal">Ordered.getValue()</code> (or the annotation value) has
the higher precedence.</p>
<p>When two pieces of advice defined in <span class="emphasis"><em>the same</em></span> aspect both need to run at the same
join point, the ordering is undefined (since there is no way to retrieve the declaration
order via reflection for javac-compiled classes). Consider collapsing such advice
methods into one advice method per join point in each aspect class, or refactor the
pieces of advice into separate aspect classes - which can be ordered at the aspect level.</p>
</div>
</div>
<div class="section" title="8.2.5&nbsp;Introductions"><div class="titlepage"><div><div><h3 class="title"><a name="aop-introductions"></a>8.2.5&nbsp;Introductions</h3></div></div></div>

<p>Introductions (known as inter-type declarations in AspectJ) enable an aspect to declare
that advised objects implement a given interface, and to provide an implementation of
that interface on behalf of those objects.</p>
<p>An introduction is made using the <code class="literal">@DeclareParents</code> annotation. This annotation is used
to declare that matching types have a new parent (hence the name). For example, given an
interface <code class="literal">UsageTracked</code>, and an implementation of that interface <code class="literal">DefaultUsageTracked</code>,
the following aspect declares that all implementors of service interfaces also implement
the <code class="literal">UsageTracked</code> interface. (In order to expose statistics via JMX for example.)</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UsageTracking {

    <i><span class="hl-annotation" style="color: gray">@DeclareParents(value="com.xzy.myapp.service.*+", defaultImpl=DefaultUsageTracked.class)</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> UsageTracked mixin;

    <i><span class="hl-annotation" style="color: gray">@Before("com.xyz.myapp.SystemArchitecture.businessService() &amp;&amp; this(usageTracked)")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> recordUsage(UsageTracked usageTracked) {
        usageTracked.incrementUseCount();
    }

}</pre>

<p>The interface to be implemented is determined by the type of the annotated field. The
<code class="literal">value</code> attribute of the <code class="literal">@DeclareParents</code> annotation is an AspectJ type pattern :- any
bean of a matching type will implement the UsageTracked interface. Note that in the
before advice of the above example, service beans can be directly used as
implementations of the <code class="literal">UsageTracked</code> interface. If accessing a bean programmatically
you would write the following:</p>
<pre class="programlisting">UsageTracked usageTracked = (UsageTracked) context.getBean(<span class="hl-string">"myService"</span>);</pre>

</div>
<div class="section" title="8.2.6&nbsp;Aspect instantiation models"><div class="titlepage"><div><div><h3 class="title"><a name="aop-instantiation-models"></a>8.2.6&nbsp;Aspect instantiation models</h3></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>(This is an advanced topic, so if you are just starting out with AOP you can safely skip
it until later.)</p>
</td></tr></table></div>

<p>By default there will be a single instance of each aspect within the application
context. AspectJ calls this the singleton instantiation model. It is possible to define
aspects with alternate lifecycles :- Spring supports AspectJ&#8217;s <code class="literal">perthis</code> and <code class="literal">pertarget</code>
instantiation models ( <code class="literal">percflow, percflowbelow,</code> and <code class="literal">pertypewithin</code> are not currently
supported).</p>
<p>A "perthis" aspect is declared by specifying a <code class="literal">perthis</code> clause in the <code class="literal">@Aspect</code>
annotation. Let&#8217;s look at an example, and then we&#8217;ll explain how it works.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Aspect("perthis(com.xyz.myapp.SystemArchitecture.businessService())")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyAspect {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> someState;

    <i><span class="hl-annotation" style="color: gray">@Before(com.xyz.myapp.SystemArchitecture.businessService())</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> recordServiceUsage() {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<p>The effect of the <code class="literal">'perthis'</code> clause is that one aspect instance will be created for
each unique service object executing a business service (each unique object bound to
<span class="emphasis"><em>this</em></span> at join points matched by the pointcut expression). The aspect instance is
created the first time that a method is invoked on the service object. The aspect goes
out of scope when the service object goes out of scope. Before the aspect instance is
created, none of the advice within it executes. As soon as the aspect instance has been
created, the advice declared within it will execute at matched join points, but only
when the service object is the one this aspect is associated with. See the AspectJ
programming guide for more information on per-clauses.</p>
<p>The <code class="literal">'pertarget'</code> instantiation model works in exactly the same way as perthis, but
creates one aspect instance for each unique target object at matched join points.</p>
</div>
<div class="section" title="8.2.7&nbsp;Example"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ataspectj-example"></a>8.2.7&nbsp;Example</h3></div></div></div>

<p>Now that you have seen how all the constituent parts work, let&#8217;s put them together to do
something useful!</p>
<p>The execution of business services can sometimes fail due to concurrency issues (for
example, deadlock loser). If the operation is retried, it is quite likely to succeed
next time round. For business services where it is appropriate to retry in such
conditions (idempotent operations that don&#8217;t need to go back to the user for conflict
resolution), we&#8217;d like to transparently retry the operation to avoid the client seeing a
<code class="literal">PessimisticLockingFailureException</code>. This is a requirement that clearly cuts across
multiple services in the service layer, and hence is ideal for implementing via an
aspect.</p>
<p>Because we want to retry the operation, we will need to use around advice so that we can
call proceed multiple times. Here&#8217;s how the basic aspect implementation looks:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ConcurrentOperationExecutor <span class="hl-keyword">implements</span> Ordered {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> DEFAULT_MAX_RETRIES = <span class="hl-number">2</span>;

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> maxRetries = DEFAULT_MAX_RETRIES;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> order = <span class="hl-number">1</span>;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMaxRetries(<span class="hl-keyword">int</span> maxRetries) {
        <span class="hl-keyword">this</span>.maxRetries = maxRetries;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getOrder() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.order;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setOrder(<span class="hl-keyword">int</span> order) {
        <span class="hl-keyword">this</span>.order = order;
    }

    <i><span class="hl-annotation" style="color: gray">@Around("com.xyz.myapp.SystemArchitecture.businessService()")</span></i>
    <span class="hl-keyword">public</span> Object doConcurrentOperation(ProceedingJoinPoint pjp) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-keyword">int</span> numAttempts = <span class="hl-number">0</span>;
        PessimisticLockingFailureException lockFailureException;
        <span class="hl-keyword">do</span> {
            numAttempts++;
            <span class="hl-keyword">try</span> {
                <span class="hl-keyword">return</span> pjp.proceed();
            }
            <span class="hl-keyword">catch</span>(PessimisticLockingFailureException ex) {
                lockFailureException = ex;
            }
        } <span class="hl-keyword">while</span>(numAttempts &lt;= <span class="hl-keyword">this</span>.maxRetries);
        <span class="hl-keyword">throw</span> lockFailureException;
    }

}</pre>

<p>Note that the aspect implements the <code class="literal">Ordered</code> interface so we can set the precedence of
the aspect higher than the transaction advice (we want a fresh transaction each time we
retry). The <code class="literal">maxRetries</code> and <code class="literal">order</code> properties will both be configured by Spring. The
main action happens in the <code class="literal">doConcurrentOperation</code> around advice. Notice that for the
moment we&#8217;re applying the retry logic to all <code class="literal">businessService()s</code>. We try to proceed,
and if we fail with an <code class="literal">PessimisticLockingFailureException</code> we simply try again unless
we have exhausted all of our retry attempts.</p>
<p>The corresponding Spring configuration is:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspectj-autoproxy/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"concurrentOperationExecutor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.xyz.myapp.service.impl.ConcurrentOperationExecutor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxRetries"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"order"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>To refine the aspect so that it only retries idempotent operations, we might define an
<code class="literal">Idempotent</code> annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> Idempotent {
    <span class="hl-comment">// marker annotation</span>
}</pre>

<p>and use the annotation to annotate the implementation of service operations. The change
to the aspect to only retry idempotent operations simply involves refining the pointcut
expression so that only <code class="literal">@Idempotent</code> operations match:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Around("com.xyz.myapp.SystemArchitecture.businessService() &amp;&amp; " +
        "@annotation(com.xyz.myapp.service.Idempotent)")</span></i>
<span class="hl-keyword">public</span> Object doConcurrentOperation(ProceedingJoinPoint pjp) <span class="hl-keyword">throws</span> Throwable {
    ...
}</pre>

</div>
</div>
<div class="section" title="8.3&nbsp;Schema-based AOP support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-schema"></a>8.3&nbsp;Schema-based AOP support</h2></div></div></div>

<p>If you prefer an XML-based format, then Spring also offers support for defining aspects
using the new "aop" namespace tags. The exact same pointcut expressions and advice kinds
are supported as when using the @AspectJ style, hence in this section we will focus on
the new <span class="emphasis"><em>syntax</em></span> and refer the reader to the discussion in the previous section
(<a class="xref" href="#aop-ataspectj" title="8.2&nbsp;@AspectJ support">Section&nbsp;8.2, &#8220;@AspectJ support&#8221;</a>) for an understanding of writing pointcut expressions and the binding
of advice parameters.</p>
<p>To use the aop namespace tags described in this section, you need to import the
spring-aop schema as described in <a class="xref" href="#xsd-config" title="33.&nbsp;XML Schema-based configuration">Chapter&nbsp;33, <i>XML Schema-based configuration</i></a>. See <a class="xref" href="#xsd-config-body-schemas-aop" title="33.2.7&nbsp;the aop schema">Section&nbsp;33.2.7, &#8220;the aop schema&#8221;</a>
for how to import the tags in the aop namespace.</p>
<p>Within your Spring configurations, all aspect and advisor elements must be placed within
an <code class="literal">&lt;aop:config&gt;</code> element (you can have more than one <code class="literal">&lt;aop:config&gt;</code> element in an
application context configuration). An <code class="literal">&lt;aop:config&gt;</code> element can contain pointcut,
advisor, and aspect elements (note these must be declared in that order).</p>
<div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">&lt;aop:config&gt;</code> style of configuration makes heavy use of Spring&#8217;s
<a class="link" href="#aop-autoproxy" title="9.9&nbsp;Using the &#34;auto-proxy&#34; facility">auto-proxying</a> mechanism. This can cause issues (such as advice not
being woven) if you are already using explicit auto-proxying via the use of
<code class="literal">BeanNameAutoProxyCreator</code> or suchlike. The recommended usage pattern is to use either
just the <code class="literal">&lt;aop:config&gt;</code> style, or just the <code class="literal">AutoProxyCreator</code> style.</p>
</td></tr></table></div>

<div class="section" title="8.3.1&nbsp;Declaring an aspect"><div class="titlepage"><div><div><h3 class="title"><a name="aop-schema-declaring-an-aspect"></a>8.3.1&nbsp;Declaring an aspect</h3></div></div></div>

<p>Using the schema support, an aspect is simply a regular Java object defined as a bean in
your Spring application context. The state and behavior is captured in the fields and
methods of the object, and the pointcut and advice information is captured in the XML.</p>
<p>An aspect is declared using the &lt;aop:aspect&gt; element, and the backing bean is referenced
using the <code class="literal">ref</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>
    <span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAspect"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>
        ...
    <span class="hl-tag">&lt;/aop:aspect&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The bean backing the aspect (" <code class="literal">aBean</code>" in this case) can of course be configured and
dependency injected just like any other Spring bean.</p>
</div>
<div class="section" title="8.3.2&nbsp;Declaring a pointcut"><div class="titlepage"><div><div><h3 class="title"><a name="aop-schema-pointcuts"></a>8.3.2&nbsp;Declaring a pointcut</h3></div></div></div>

<p>A named pointcut can be declared inside an &lt;aop:config&gt; element, enabling the pointcut
definition to be shared across several aspects and advisors.</p>
<p>A pointcut representing the execution of any business service in the service layer could
be defined as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>

    <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessService"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* com.xyz.myapp.service.</span><span class="strong"><strong>.</strong></span>(..))"/&gt;

<span class="hl-tag">&lt;/aop:config&gt;</span></pre>

<p>Note that the pointcut expression itself is using the same AspectJ pointcut expression
language as described in <a class="xref" href="#aop-ataspectj" title="8.2&nbsp;@AspectJ support">Section&nbsp;8.2, &#8220;@AspectJ support&#8221;</a>. If you are using the schema based
declaration style, you can refer to named pointcuts defined in types
(@Aspects) within the pointcut expression. Another way of defining the above pointcut
would be:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>

    <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessService"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"com.xyz.myapp.SystemArchitecture.businessService()"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/aop:config&gt;</span></pre>

<p>Assuming you have a <code class="literal">SystemArchitecture</code> aspect as described in <a class="xref" href="#aop-common-pointcuts" title="Sharing common pointcut definitions">the section called &#8220;Sharing common pointcut definitions&#8221;</a>.</p>
<p>Declaring a pointcut inside an aspect is very similar to declaring a top-level pointcut:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>

    <span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAspect"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessService"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* com.xyz.myapp.service.</span><span class="strong"><strong>.</strong></span>(..))"/&gt;

        ...

    <span class="hl-tag">&lt;/aop:aspect&gt;</span>

<span class="hl-tag">&lt;/aop:config&gt;</span></pre>

<p>Much the same way in an @AspectJ aspect, pointcuts declared using the schema based
definition style may collect join point context. For example, the following pointcut
collects the <span class="emphasis"><em>this</em></span> object as the join point context and passes it to advice:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>

    <span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAspect"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessService"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* com.xyz.myapp.service.</span><span class="strong"><strong>.</strong></span>(..)) &amp;amp;&amp;amp; this(service)"/&gt;

        <span class="hl-tag">&lt;aop:before</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"businessService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"monitor"</span><span class="hl-tag">/&gt;</span>

        ...

    <span class="hl-tag">&lt;/aop:aspect&gt;</span>

<span class="hl-tag">&lt;/aop:config&gt;</span></pre>

<p>The advice must be declared to receive the collected join point context by including
parameters of the matching names:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> monitor(Object service) {
    ...
}</pre>

<p>When combining pointcut sub-expressions, <span class="emphasis"><em>&amp;&amp;</em></span> is awkward within an XML document, and so
the keywords <span class="emphasis"><em>and</em></span>, <span class="emphasis"><em>or</em></span> and <span class="emphasis"><em>not</em></span> can be used in place of <span class="emphasis"><em>&amp;&amp;</em></span>, <span class="emphasis"><em>||</em></span> and <span class="emphasis"><em>!</em></span>
respectively. For example, the previous pointcut may be better written as:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>

    <span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAspect"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessService"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* com.xyz.myapp.service.</span><span class="strong"><strong>.</strong></span>(..)) <span class="strong"><strong>and</strong></span> this(service)"/&gt;

        <span class="hl-tag">&lt;aop:before</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"businessService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"monitor"</span><span class="hl-tag">/&gt;</span>

        ...
    <span class="hl-tag">&lt;/aop:aspect&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span></pre>

<p>Note that pointcuts defined in this way are referred to by their XML id and cannot be
used as named pointcuts to form composite pointcuts. The named pointcut support in the
schema based definition style is thus more limited than that offered by the @AspectJ
style.</p>
</div>
<div class="section" title="8.3.3&nbsp;Declaring advice"><div class="titlepage"><div><div><h3 class="title"><a name="aop-schema-advice"></a>8.3.3&nbsp;Declaring advice</h3></div></div></div>

<p>The same five advice kinds are supported as for the @AspectJ style, and they have
exactly the same semantics.</p>
<div class="section" title="Before advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-schema-advice-before"></a>Before advice</h4></div></div></div>

<p>Before advice runs before a matched method execution. It is declared inside an
<code class="literal">&lt;aop:aspect&gt;</code> using the &lt;aop:before&gt; element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"beforeExample"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:before</span>
        <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"dataAccessOperation"</span>
        <span class="hl-attribute">method</span>=<span class="hl-value">"doAccessCheck"</span><span class="hl-tag">/&gt;</span>

    ...

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

<p>Here <code class="literal">dataAccessOperation</code> is the id of a pointcut defined at the top ( <code class="literal">&lt;aop:config&gt;</code>)
level. To define the pointcut inline instead, replace the <code class="literal">pointcut-ref</code> attribute with
a <code class="literal">pointcut</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"beforeExample"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:before</span>
        <span class="hl-attribute">pointcut</span>=<span class="hl-value">"execution(* com.xyz.myapp.dao.</span><span class="strong"><strong>.</strong></span>(..))"
        method="doAccessCheck"/&gt;

    ...

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

<p>As we noted in the discussion of the @AspectJ style, using named pointcuts can
significantly improve the readability of your code.</p>
<p>The method attribute identifies a method ( <code class="literal">doAccessCheck</code>) that provides the body of
the advice. This method must be defined for the bean referenced by the aspect element
containing the advice. Before a data access operation is executed (a method execution
join point matched by the pointcut expression), the "doAccessCheck" method on the aspect
bean will be invoked.</p>
</div>
<div class="section" title="After returning advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-schema-advice-after-returning"></a>After returning advice</h4></div></div></div>

<p>After returning advice runs when a matched method execution completes normally. It is
declared inside an <code class="literal">&lt;aop:aspect&gt;</code> in the same way as before advice. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"afterReturningExample"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:after-returning</span>
        <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"dataAccessOperation"</span>
        <span class="hl-attribute">method</span>=<span class="hl-value">"doAccessCheck"</span><span class="hl-tag">/&gt;</span>

    ...

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

<p>Just as in the @AspectJ style, it is possible to get hold of the return value within the
advice body. Use the returning attribute to specify the name of the parameter to which
the return value should be passed:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"afterReturningExample"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:after-returning</span>
        <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"dataAccessOperation"</span>
        <span class="hl-attribute">returning</span>=<span class="hl-value">"retVal"</span>
        <span class="hl-attribute">method</span>=<span class="hl-value">"doAccessCheck"</span><span class="hl-tag">/&gt;</span>

    ...

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

<p>The doAccessCheck method must declare a parameter named <code class="literal">retVal</code>. The type of this
parameter constrains matching in the same way as described for @AfterReturning. For
example, the method signature may be declared as:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doAccessCheck(Object retVal) {...</pre>

</div>
<div class="section" title="After throwing advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-schema-advice-after-throwing"></a>After throwing advice</h4></div></div></div>

<p>After throwing advice executes when a matched method execution exits by throwing an
exception. It is declared inside an <code class="literal">&lt;aop:aspect&gt;</code> using the after-throwing element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"afterThrowingExample"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:after-throwing</span>
        <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"dataAccessOperation"</span>
        <span class="hl-attribute">method</span>=<span class="hl-value">"doRecoveryActions"</span><span class="hl-tag">/&gt;</span>

    ...

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

<p>Just as in the @AspectJ style, it is possible to get hold of the thrown exception within
the advice body. Use the throwing attribute to specify the name of the parameter to
which the exception should be passed:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"afterThrowingExample"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:after-throwing</span>
        <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"dataAccessOperation"</span>
        <span class="hl-attribute">throwing</span>=<span class="hl-value">"dataAccessEx"</span>
        <span class="hl-attribute">method</span>=<span class="hl-value">"doRecoveryActions"</span><span class="hl-tag">/&gt;</span>

    ...

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

<p>The doRecoveryActions method must declare a parameter named <code class="literal">dataAccessEx</code>. The type of
this parameter constrains matching in the same way as described for @AfterThrowing. For
example, the method signature may be declared as:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doRecoveryActions(DataAccessException dataAccessEx) {...</pre>

</div>
<div class="section" title="After (finally) advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-schema-advice-after-finally"></a>After (finally) advice</h4></div></div></div>

<p>After (finally) advice runs however a matched method execution exits. It is declared
using the <code class="literal">after</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"afterFinallyExample"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:after</span>
        <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"dataAccessOperation"</span>
        <span class="hl-attribute">method</span>=<span class="hl-value">"doReleaseLock"</span><span class="hl-tag">/&gt;</span>

    ...

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

</div>
<div class="section" title="Around advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-schema-advice-around"></a>Around advice</h4></div></div></div>

<p>The final kind of advice is around advice. Around advice runs "around" a matched method
execution. It has the opportunity to do work both before and after the method executes,
and to determine when, how, and even if, the method actually gets to execute at all.
Around advice is often used if you need to share state before and after a method
execution in a thread-safe manner (starting and stopping a timer for example). Always
use the least powerful form of advice that meets your requirements; don&#8217;t use around
advice if simple before advice would do.</p>
<p>Around advice is declared using the <code class="literal">aop:around</code> element. The first parameter of the
advice method must be of type <code class="literal">ProceedingJoinPoint</code>. Within the body of the advice,
calling <code class="literal">proceed()</code> on the <code class="literal">ProceedingJoinPoint</code> causes the underlying method to
execute. The <code class="literal">proceed</code> method may also be calling passing in an <code class="literal">Object[]</code> - the values
in the array will be used as the arguments to the method execution when it proceeds. See
<a class="xref" href="#aop-ataspectj-around-advice" title="Around advice">the section called &#8220;Around advice&#8221;</a> for notes on calling proceed with an <code class="literal">Object[]</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aroundExample"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"aBean"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:around</span>
        <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"businessService"</span>
        <span class="hl-attribute">method</span>=<span class="hl-value">"doBasicProfiling"</span><span class="hl-tag">/&gt;</span>

    ...

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

<p>The implementation of the <code class="literal">doBasicProfiling</code> advice would be exactly the same as in the
@AspectJ example (minus the annotation of course):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> Object doBasicProfiling(ProceedingJoinPoint pjp) <span class="hl-keyword">throws</span> Throwable {
    <span class="hl-comment">// start stopwatch</span>
    Object retVal = pjp.proceed();
    <span class="hl-comment">// stop stopwatch</span>
    <span class="hl-keyword">return</span> retVal;
}</pre>

</div>
<div class="section" title="Advice parameters"><div class="titlepage"><div><div><h4 class="title"><a name="aop-schema-params"></a>Advice parameters</h4></div></div></div>

<p>The schema based declaration style supports fully typed advice in the same way as
described for the @AspectJ support - by matching pointcut parameters by name against
advice method parameters. See <a class="xref" href="#aop-ataspectj-advice-params" title="Advice parameters">the section called &#8220;Advice parameters&#8221;</a> for details. If you wish
to explicitly specify argument names for the advice methods (not relying on the
detection strategies previously described) then this is done using the <code class="literal">arg-names</code>
attribute of the advice element, which is treated in the same manner to the "argNames"
attribute in an advice annotation as described in <a class="xref" href="#aop-ataspectj-advice-params-names" title="Determining argument names">the section called &#8220;Determining argument names&#8221;</a>.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:before</span>
    <span class="hl-attribute">pointcut</span>=<span class="hl-value">"com.xyz.lib.Pointcuts.anyPublicMethod() and @annotation(auditable)"</span>
    <span class="hl-attribute">method</span>=<span class="hl-value">"audit"</span>
    <span class="hl-attribute">arg-names</span>=<span class="hl-value">"auditable"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">arg-names</code> attribute accepts a comma-delimited list of parameter names.</p>
<p>Find below a slightly more involved example of the XSD-based approach that illustrates
some around advice used in conjunction with a number of strongly typed parameters.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> x.y.service;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FooService {

    Foo getFoo(String fooName, <span class="hl-keyword">int</span> age);
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultFooService <span class="hl-keyword">implements</span> FooService {

    <span class="hl-keyword">public</span> Foo getFoo(String name, <span class="hl-keyword">int</span> age) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Foo(name, age);
    }
}</pre>

<p>Next up is the aspect. Notice the fact that the <code class="literal">profile(..)</code> method accepts a number of
strongly-typed parameters, the first of which happens to be the join point used to
proceed with the method call: the presence of this parameter is an indication that the
<code class="literal">profile(..)</code> is to be used as <code class="literal">around</code> advice:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> x.y;

<span class="hl-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hl-keyword">import</span> org.springframework.util.StopWatch;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleProfiler {

    <span class="hl-keyword">public</span> Object profile(ProceedingJoinPoint call, String name, <span class="hl-keyword">int</span> age) <span class="hl-keyword">throws</span> Throwable {
        StopWatch clock = <span class="hl-keyword">new</span> StopWatch(<span class="hl-string">"Profiling for </span><span class="emphasis"><em>" + name + "</em></span> and <span class="emphasis"><em>" + age + "</em></span><span class="hl-string">");
</span>        <span class="hl-keyword">try</span> {
            clock.start(call.toShortString());
            <span class="hl-keyword">return</span> call.proceed();
        } <span class="hl-keyword">finally</span> {
            clock.stop();
            System.out.println(clock.prettyPrint());
        }
    }
}</pre>

<p>Finally, here is the XML configuration that is required to effect the execution of the
above advice for a particular join point:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- this is the object that will be proxied by Spring's AOP infrastructure --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.DefaultFooService"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- this is the actual advice itself --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"profiler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.SimpleProfiler"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"profiler"</span><span class="hl-tag">&gt;</span>

            <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"theExecutionOfSomeFooServiceMethod"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* x.y.service.FooService.getFoo(String,int))
                and args(name, age)"</span><span class="hl-tag">/&gt;</span>

            <span class="hl-tag">&lt;aop:around</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"theExecutionOfSomeFooServiceMethod"</span>
                <span class="hl-attribute">method</span>=<span class="hl-value">"profile"</span><span class="hl-tag">/&gt;</span>

        <span class="hl-tag">&lt;/aop:aspect&gt;</span>
    <span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>If we had the following driver script, we would get output something like this on
standard output:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.beans.factory.BeanFactory;
<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;
<span class="hl-keyword">import</span> x.y.service.FooService;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> Boot {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(<span class="hl-keyword">final</span> String[] args) <span class="hl-keyword">throws</span> Exception {
        BeanFactory ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"x/y/plain.xml"</span>);
        FooService foo = (FooService) ctx.getBean(<span class="hl-string">"fooService"</span>);
        foo.getFoo(<span class="hl-string">"Pengo"</span>, <span class="hl-number">12</span>);
    }
}</pre>


<pre class="literallayout">StopWatch <span class="emphasis"><em>Profiling for 'Pengo</em></span> and <span class="emphasis"><em>12</em></span>': running time (millis) = 0
-----------------------------------------
ms     %     Task name
-----------------------------------------
00000  ?  execution(getFoo)</pre>

</div>
<div class="section" title="Advice ordering"><div class="titlepage"><div><div><h4 class="title"><a name="aop-ordering"></a>Advice ordering</h4></div></div></div>

<p>When multiple advice needs to execute at the same join point (executing method) the
ordering rules are as described in <a class="xref" href="#aop-ataspectj-advice-ordering" title="Advice ordering">the section called &#8220;Advice ordering&#8221;</a>. The precedence
between aspects is determined by either adding the <code class="literal">Order</code> annotation to the bean
backing the aspect or by having the bean implement the <code class="literal">Ordered</code> interface.</p>
</div>
</div>
<div class="section" title="8.3.4&nbsp;Introductions"><div class="titlepage"><div><div><h3 class="title"><a name="aop-schema-introductions"></a>8.3.4&nbsp;Introductions</h3></div></div></div>

<p>Introductions (known as inter-type declarations in AspectJ) enable an aspect to declare
that advised objects implement a given interface, and to provide an implementation of
that interface on behalf of those objects.</p>
<p>An introduction is made using the <code class="literal">aop:declare-parents</code> element inside an <code class="literal">aop:aspect</code>
This element is used to declare that matching types have a new parent (hence the name).
For example, given an interface <code class="literal">UsageTracked</code>, and an implementation of that interface
<code class="literal">DefaultUsageTracked</code>, the following aspect declares that all implementors of service
interfaces also implement the <code class="literal">UsageTracked</code> interface. (In order to expose statistics
via JMX for example.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"usageTrackerAspect"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"usageTracking"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:declare-parents</span>
        <span class="hl-attribute">types-matching</span>=<span class="hl-value">"com.xzy.myapp.service.*+"</span>
        <span class="hl-attribute">implement-interface</span>=<span class="hl-value">"com.xyz.myapp.service.tracking.UsageTracked"</span>
        <span class="hl-attribute">default-impl</span>=<span class="hl-value">"com.xyz.myapp.service.tracking.DefaultUsageTracked"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;aop:before</span>
        <span class="hl-attribute">pointcut</span>=<span class="hl-value">"com.xyz.myapp.SystemArchitecture.businessService()
            and this(usageTracked)"</span>
            <span class="hl-attribute">method</span>=<span class="hl-value">"recordUsage"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/aop:aspect&gt;</span></pre>

<p>The class backing the <code class="literal">usageTracking</code> bean would contain the method:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> recordUsage(UsageTracked usageTracked) {
    usageTracked.incrementUseCount();
}</pre>

<p>The interface to be implemented is determined by <code class="literal">implement-interface</code> attribute. The
value of the <code class="literal">types-matching</code> attribute is an AspectJ type pattern :- any bean of a
matching type will implement the <code class="literal">UsageTracked</code> interface. Note that in the before
advice of the above example, service beans can be directly used as implementations of
the <code class="literal">UsageTracked</code> interface. If accessing a bean programmatically you would write the
following:</p>
<pre class="programlisting">UsageTracked usageTracked = (UsageTracked) context.getBean(<span class="hl-string">"myService"</span>);</pre>

</div>
<div class="section" title="8.3.5&nbsp;Aspect instantiation models"><div class="titlepage"><div><div><h3 class="title"><a name="aop-schema-instatiation-models"></a>8.3.5&nbsp;Aspect instantiation models</h3></div></div></div>

<p>The only supported instantiation model for schema-defined aspects is the singleton
model. Other instantiation models may be supported in future releases.</p>
</div>
<div class="section" title="8.3.6&nbsp;Advisors"><div class="titlepage"><div><div><h3 class="title"><a name="aop-schema-advisors"></a>8.3.6&nbsp;Advisors</h3></div></div></div>

<p>The concept of "advisors" is brought forward from the AOP support defined in Spring 1.2
and does not have a direct equivalent in AspectJ. An advisor is like a small
self-contained aspect that has a single piece of advice. The advice itself is
represented by a bean, and must implement one of the advice interfaces described in
<a class="xref" href="#aop-api-advice-types" title="9.3.2&nbsp;Advice types in Spring">Section&nbsp;9.3.2, &#8220;Advice types in Spring&#8221;</a>. Advisors can take advantage of AspectJ pointcut expressions
though.</p>
<p>Spring supports the advisor concept with the <code class="literal">&lt;aop:advisor&gt;</code> element. You will most
commonly see it used in conjunction with transactional advice, which also has its own
namespace support in Spring. Here&#8217;s how it looks:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>

    <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessService"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* com.xyz.myapp.service.</span><span class="strong"><strong>.</strong></span>(..))"/&gt;

    <span class="hl-tag">&lt;aop:advisor</span>
        <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"businessService"</span>
        <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"tx-advice"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"tx-advice"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;tx:attributes&gt;</span>
        <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/tx:attributes&gt;</span>
<span class="hl-tag">&lt;/tx:advice&gt;</span></pre>

<p>As well as the <code class="literal">pointcut-ref</code> attribute used in the above example, you can also use the
<code class="literal">pointcut</code> attribute to define a pointcut expression inline.</p>
<p>To define the precedence of an advisor so that the advice can participate in ordering,
use the <code class="literal">order</code> attribute to define the <code class="literal">Ordered</code> value of the advisor.</p>
</div>
<div class="section" title="8.3.7&nbsp;Example"><div class="titlepage"><div><div><h3 class="title"><a name="aop-schema-example"></a>8.3.7&nbsp;Example</h3></div></div></div>

<p>Let&#8217;s see how the concurrent locking failure retry example from
<a class="xref" href="#aop-ataspectj-example" title="8.2.7&nbsp;Example">Section&nbsp;8.2.7, &#8220;Example&#8221;</a> looks when rewritten using the schema support.</p>
<p>The execution of business services can sometimes fail due to concurrency issues (for
example, deadlock loser). If the operation is retried, it is quite likely it will
succeed next time round. For business services where it is appropriate to retry in such
conditions (idempotent operations that don&#8217;t need to go back to the user for conflict
resolution), we&#8217;d like to transparently retry the operation to avoid the client seeing a
<code class="literal">PessimisticLockingFailureException</code>. This is a requirement that clearly cuts across
multiple services in the service layer, and hence is ideal for implementing via an
aspect.</p>
<p>Because we want to retry the operation, we&#8217;ll need to use around advice so that we can
call proceed multiple times. Here&#8217;s how the basic aspect implementation looks (it&#8217;s just
a regular Java class using the schema support):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ConcurrentOperationExecutor <span class="hl-keyword">implements</span> Ordered {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> DEFAULT_MAX_RETRIES = <span class="hl-number">2</span>;

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> maxRetries = DEFAULT_MAX_RETRIES;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> order = <span class="hl-number">1</span>;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMaxRetries(<span class="hl-keyword">int</span> maxRetries) {
        <span class="hl-keyword">this</span>.maxRetries = maxRetries;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getOrder() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.order;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setOrder(<span class="hl-keyword">int</span> order) {
        <span class="hl-keyword">this</span>.order = order;
    }

    <span class="hl-keyword">public</span> Object doConcurrentOperation(ProceedingJoinPoint pjp) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-keyword">int</span> numAttempts = <span class="hl-number">0</span>;
        PessimisticLockingFailureException lockFailureException;
        <span class="hl-keyword">do</span> {
            numAttempts++;
            <span class="hl-keyword">try</span> {
                <span class="hl-keyword">return</span> pjp.proceed();
            }
            <span class="hl-keyword">catch</span>(PessimisticLockingFailureException ex) {
                lockFailureException = ex;
            }
        } <span class="hl-keyword">while</span>(numAttempts &lt;= <span class="hl-keyword">this</span>.maxRetries);
        <span class="hl-keyword">throw</span> lockFailureException;
    }

}</pre>

<p>Note that the aspect implements the <code class="literal">Ordered</code> interface so we can set the precedence of
the aspect higher than the transaction advice (we want a fresh transaction each time we
retry). The <code class="literal">maxRetries</code> and <code class="literal">order</code> properties will both be configured by Spring. The
main action happens in the <code class="literal">doConcurrentOperation</code> around advice method. We try to
proceed, and if we fail with a <code class="literal">PessimisticLockingFailureException</code> we simply try again
unless we have exhausted all of our retry attempts.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This class is identical to the one used in the @AspectJ example, but with the
annotations removed.</p>
</td></tr></table></div>

<p>The corresponding Spring configuration is:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>

    <span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"concurrentOperationRetry"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"concurrentOperationExecutor"</span><span class="hl-tag">&gt;</span>

        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"idempotentOperation"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* com.xyz.myapp.service.</span><span class="strong"><strong>.</strong></span>(..))"/&gt;

        <span class="hl-tag">&lt;aop:around</span>
            <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"idempotentOperation"</span>
            <span class="hl-attribute">method</span>=<span class="hl-value">"doConcurrentOperation"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;/aop:aspect&gt;</span>

<span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"concurrentOperationExecutor"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"com.xyz.myapp.service.impl.ConcurrentOperationExecutor"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxRetries"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"order"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Notice that for the time being we assume that all business services are idempotent. If
this is not the case we can refine the aspect so that it only retries genuinely
idempotent operations, by introducing an <code class="literal">Idempotent</code> annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> Idempotent {
    <span class="hl-comment">// marker annotation</span>
}</pre>

<p>and using the annotation to annotate the implementation of service operations. The
change to the aspect to retry only idempotent operations simply involves refining the
pointcut expression so that only <code class="literal">@Idempotent</code> operations match:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"idempotentOperation"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* com.xyz.myapp.service.</span><span class="strong"><strong>.</strong></span>(..)) and
        @annotation(com.xyz.myapp.service.Idempotent)"/&gt;</pre>

</div>
</div>
<div class="section" title="8.4&nbsp;Choosing which AOP declaration style to use"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-choosing"></a>8.4&nbsp;Choosing which AOP declaration style to use</h2></div></div></div>

<p>Once you have decided that an aspect is the best approach for implementing a given
requirement, how do you decide between using Spring AOP or AspectJ, and between the
Aspect language (code) style, @AspectJ annotation style, or the Spring XML style? These
decisions are influenced by a number of factors including application requirements,
development tools, and team familiarity with AOP.</p>
<div class="section" title="8.4.1&nbsp;Spring AOP or full AspectJ?"><div class="titlepage"><div><div><h3 class="title"><a name="aop-spring-or-aspectj"></a>8.4.1&nbsp;Spring AOP or full AspectJ?</h3></div></div></div>

<p>Use the simplest thing that can work. Spring AOP is simpler than using full AspectJ as
there is no requirement to introduce the AspectJ compiler / weaver into your development
and build processes. If you only need to advise the execution of operations on Spring
beans, then Spring AOP is the right choice. If you need to advise objects not managed by
the Spring container (such as domain objects typically), then you will need to use
AspectJ. You will also need to use AspectJ if you wish to advise join points other than
simple method executions (for example, field get or set join points, and so on).</p>
<p>When using AspectJ, you have the choice of the AspectJ language syntax (also known as
the "code style") or the @AspectJ annotation style. Clearly, if you are not using Java
5+ then the choice has been made for you&#8230; use the code style. If aspects play a large
role in your design, and you are able to use the <a class="ulink" href="http://www.eclipse.org/ajdt/" target="_top">AspectJ
Development Tools (AJDT)</a> plugin for Eclipse, then the AspectJ language syntax is the
preferred option: it is cleaner and simpler because the language was purposefully
designed for writing aspects. If you are not using Eclipse, or have only a few aspects
that do not play a major role in your application, then you may want to consider using
the @AspectJ style and sticking with a regular Java compilation in your IDE, and adding
an aspect weaving phase to your build script.</p>
</div>
<div class="section" title="8.4.2&nbsp;@AspectJ or XML for Spring AOP?"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ataspectj-or-xml"></a>8.4.2&nbsp;@AspectJ or XML for Spring AOP?</h3></div></div></div>

<p>If you have chosen to use Spring AOP, then you have a choice of @AspectJ or XML style.
There are various tradeoffs to consider.</p>
<p>The XML style will be most familiar to existing Spring users and it is backed by genuine
POJOs. When using AOP as a tool to configure enterprise services then XML can be a good
choice (a good test is whether you consider the pointcut expression to be a part of your
configuration you might want to change independently). With the XML style arguably it is
clearer from your configuration what aspects are present in the system.</p>
<p>The XML style has two disadvantages. Firstly it does not fully encapsulate the
implementation of the requirement it addresses in a single place. The DRY principle says
that there should be a single, unambiguous, authoritative representation of any piece of
knowledge within a system. When using the XML style, the knowledge of <span class="emphasis"><em>how</em></span> a
requirement is implemented is split across the declaration of the backing bean class,
and the XML in the configuration file. When using the @AspectJ style there is a single
module - the aspect - in which this information is encapsulated. Secondly, the XML style
is slightly more limited in what it can express than the @AspectJ style: only the
"singleton" aspect instantiation model is supported, and it is not possible to combine
named pointcuts declared in XML. For example, in the @AspectJ style you can write
something like:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Pointcut(execution(* get*()))</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> propertyAccess() {}

    @Pointcut(execution(org.xyz.Account+ *(..))
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> operationReturningAnAccount() {}

    <i><span class="hl-annotation" style="color: gray">@Pointcut(propertyAccess() &amp;&amp; operationReturningAnAccount())</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> accountPropertyAccess() {}</pre>

<p>In the XML style I can declare the first two pointcuts:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"propertyAccess"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* get*())"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"operationReturningAnAccount"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(org.xyz.Account+ *(..))"</span><span class="hl-tag">/&gt;</span></pre>

<p>The downside of the XML approach is that you cannot define the '
<code class="literal">accountPropertyAccess</code>' pointcut by combining these definitions.</p>
<p>The @AspectJ style supports additional instantiation models, and richer pointcut
composition. It has the advantage of keeping the aspect as a modular unit. It also has
the advantage the @AspectJ aspects can be understood (and thus consumed) both by Spring
AOP and by AspectJ - so if you later decide you need the capabilities of AspectJ to
implement additional requirements then it is very easy to migrate to an AspectJ-based
approach. On balance the Spring team prefer the @AspectJ style whenever you have aspects
that do more than simple "configuration" of enterprise services.</p>
</div>
</div>
<div class="section" title="8.5&nbsp;Mixing aspect types"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-mixing-styles"></a>8.5&nbsp;Mixing aspect types</h2></div></div></div>

<p>It is perfectly possible to mix @AspectJ style aspects using the autoproxying support,
schema-defined <code class="literal">&lt;aop:aspect&gt;</code> aspects, <code class="literal">&lt;aop:advisor&gt;</code> declared advisors and even
proxies and interceptors defined using the Spring 1.2 style in the same configuration.
All of these are implemented using the same underlying support mechanism and will
co-exist without any difficulty.</p>
</div>
<div class="section" title="8.6&nbsp;Proxying mechanisms"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-proxying"></a>8.6&nbsp;Proxying mechanisms</h2></div></div></div>

<p>Spring AOP uses either JDK dynamic proxies or CGLIB to create the proxy for a given
target object. (JDK dynamic proxies are preferred whenever you have a choice).</p>
<p>If the target object to be proxied implements at least one interface then a JDK dynamic
proxy will be used. All of the interfaces implemented by the target type will be
proxied. If the target object does not implement any interfaces then a CGLIB proxy will
be created.</p>
<p>If you want to force the use of CGLIB proxying (for example, to proxy every method
defined for the target object, not just those implemented by its interfaces) you can do
so. However, there are some issues to consider:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">final</code> methods cannot be advised, as they cannot be overridden.
</li><li class="listitem">
As of Spring 3.2, it is no longer necessary to add CGLIB to your project classpath, as
CGLIB classes are repackaged under org.springframework and included directly in the
spring-core JAR. This means that CGLIB-based proxy support <span class="emphasis"><em>just works</em></span> in the same
way that JDK dynamic proxies always have.
</li><li class="listitem">
The constructor of your proxied object will be called twice. This is a natural
consequence of the CGLIB proxy model whereby a subclass is generated for each proxied
object. For each proxied instance, two objects are created: the actual proxied object
and an instance of the subclass that implements the advice. This behavior is not
exhibited when using JDK proxies. Usually, calling the constructor of the proxied type
twice, is not an issue, as there are usually only assignments taking place and no real
logic is implemented in the constructor.
</li></ul></div>

<p>To force the use of CGLIB proxies set the value of the <code class="literal">proxy-target-class</code> attribute of
the <code class="literal">&lt;aop:config&gt;</code> element to true:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config</span> <span class="hl-attribute">proxy-target-class</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- other beans defined here... --&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span></pre>

<p>To force CGLIB proxying when using the @AspectJ autoproxy support, set the
<code class="literal">'proxy-target-class'</code> attribute of the <code class="literal">&lt;aop:aspectj-autoproxy&gt;</code> element to <code class="literal">true</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspectj-autoproxy</span> <span class="hl-attribute">proxy-target-class</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Multiple <code class="literal">&lt;aop:config/&gt;</code> sections are collapsed into a single unified auto-proxy creator
at runtime, which applies the <span class="emphasis"><em>strongest</em></span> proxy settings that any of the
<code class="literal">&lt;aop:config/&gt;</code> sections (typically from different XML bean definition files) specified.
This also applies to the <code class="literal">&lt;tx:annotation-driven/&gt;</code> and <code class="literal">&lt;aop:aspectj-autoproxy/&gt;</code>
elements.</p>
<p>To be clear: using ' <code class="literal">proxy-target-class="true"</code>' on <code class="literal">&lt;tx:annotation-driven/&gt;</code>,
<code class="literal">&lt;aop:aspectj-autoproxy/&gt;</code> or <code class="literal">&lt;aop:config/&gt;</code> elements will force the use of CGLIB
proxies <span class="emphasis"><em>for all three of them</em></span>.</p>
</td></tr></table></div>

<div class="section" title="8.6.1&nbsp;Understanding AOP proxies"><div class="titlepage"><div><div><h3 class="title"><a name="aop-understanding-aop-proxies"></a>8.6.1&nbsp;Understanding AOP proxies</h3></div></div></div>

<p>Spring AOP is <span class="emphasis"><em>proxy-based</em></span>. It is vitally important that you grasp the semantics of
what that last statement actually means before you write your own aspects or use any of
the Spring AOP-based aspects supplied with the Spring Framework.</p>
<p>Consider first the scenario where you have a plain-vanilla, un-proxied,
nothing-special-about-it, straight object reference, as illustrated by the following
code snippet.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimplePojo <span class="hl-keyword">implements</span> Pojo {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> foo() {
        <span class="hl-comment">// this next method invocation is a direct call on the </span><span class="emphasis"><em>this</em></span> reference
        <span class="hl-keyword">this</span>.bar();
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> bar() {
        <span class="hl-comment">// some logic...</span>
    }
}</pre>

<p>If you invoke a method on an object reference, the method is invoked <span class="emphasis"><em>directly</em></span> on
that object reference, as can be seen below.</p>
<div class="figure"><a name="d4e6517"></a><p class="title"><b>Figure&nbsp;8.1.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/aop-proxy-plain-pojo-call.png" alt="aop proxy plain pojo call"></div>
</div></div><br class="figure-break">

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Main {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {

        Pojo pojo = <span class="hl-keyword">new</span> SimplePojo();

        <span class="hl-comment">// this is a direct method call on the </span><span class="emphasis"><em>pojo</em></span> reference
        pojo.foo();
    }
}</pre>

<p>Things change slightly when the reference that client code has is a proxy. Consider the
following diagram and code snippet.</p>
<div class="figure"><a name="d4e6526"></a><p class="title"><b>Figure&nbsp;8.2.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/aop-proxy-call.png" alt="aop proxy call"></div>
</div></div><br class="figure-break">

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Main {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {

        ProxyFactory factory = <span class="hl-keyword">new</span> ProxyFactory(<span class="hl-keyword">new</span> SimplePojo());
        factory.addInterface(Pojo.<span class="hl-keyword">class</span>);
        factory.addAdvice(<span class="hl-keyword">new</span> RetryAdvice());

        Pojo pojo = (Pojo) factory.getProxy();

        <span class="hl-comment">// this is a method call on the proxy!</span>
        pojo.foo();
    }
}</pre>

<p>The key thing to understand here is that the client code inside the <code class="literal">main(..)</code> of the
<code class="literal">Main</code> class <span class="emphasis"><em>has a reference to the proxy</em></span>. This means that method calls on that
object reference will be calls on the proxy, and as such the proxy will be able to
delegate to all of the interceptors (advice) that are relevant to that particular method
call. However, once the call has finally reached the target object, the <code class="literal">SimplePojo</code>
reference in this case, any method calls that it may make on itself, such as
<code class="literal">this.bar()</code> or <code class="literal">this.foo()</code>, are going to be invoked against the <span class="emphasis"><em>this</em></span> reference,
and <span class="emphasis"><em>not</em></span> the proxy. This has important implications. It means that self-invocation is
<span class="emphasis"><em>not</em></span> going to result in the advice associated with a method invocation getting a
chance to execute.</p>
<p>Okay, so what is to be done about this? The best approach (the term best is used loosely
here) is to refactor your code such that the self-invocation does not happen. For sure,
this does entail some work on your part, but it is the best, least-invasive approach.
The next approach is absolutely horrendous, and I am almost reticent to point it out
precisely because it is so horrendous. You can (choke!) totally tie the logic within
your class to Spring AOP by doing this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimplePojo <span class="hl-keyword">implements</span> Pojo {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> foo() {
        <span class="hl-comment">// this works, but... gah!</span>
        ((Pojo) AopContext.currentProxy()).bar();
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> bar() {
        <span class="hl-comment">// some logic...</span>
    }
}</pre>

<p>This totally couples your code to Spring AOP, <span class="emphasis"><em>and</em></span> it makes the class itself aware of
the fact that it is being used in an AOP context, which flies in the face of AOP. It
also requires some additional configuration when the proxy is being created:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Main {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {

        ProxyFactory factory = <span class="hl-keyword">new</span> ProxyFactory(<span class="hl-keyword">new</span> SimplePojo());
        factory.adddInterface(Pojo.<span class="hl-keyword">class</span>);
        factory.addAdvice(<span class="hl-keyword">new</span> RetryAdvice());
        factory.setExposeProxy(true);

        Pojo pojo = (Pojo) factory.getProxy();

        <span class="hl-comment">// this is a method call on the proxy!</span>
        pojo.foo();
    }
}</pre>

<p>Finally, it must be noted that AspectJ does not have this self-invocation issue because
it is not a proxy-based AOP framework.</p>
</div>
</div>
<div class="section" title="8.7&nbsp;Programmatic creation of @AspectJ Proxies"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-aspectj-programmatic"></a>8.7&nbsp;Programmatic creation of @AspectJ Proxies</h2></div></div></div>

<p>In addition to declaring aspects in your configuration using either <code class="literal">&lt;aop:config&gt;</code> or
<code class="literal">&lt;aop:aspectj-autoproxy&gt;</code>, it is also possible programmatically to create proxies that
advise target objects. For the full details of Spring&#8217;s AOP API, see the next chapter.
Here we want to focus on the ability to automatically create proxies using @AspectJ
aspects.</p>
<p>The class <code class="literal">org.springframework.aop.aspectj.annotation.AspectJProxyFactory</code> can be used
to create a proxy for a target object that is advised by one or more @AspectJ aspects.
Basic usage for this class is very simple, as illustrated below. See the Javadocs for
full information.</p>
<pre class="programlisting"><span class="hl-comment">// create a factory that can generate a proxy for the given target object</span>
AspectJProxyFactory factory = <span class="hl-keyword">new</span> AspectJProxyFactory(targetObject);

<span class="hl-comment">// add an aspect, the class must be an @AspectJ aspect</span>
<span class="hl-comment">// you can call this as many times as you need with different aspects</span>
factory.addAspect(SecurityManager.<span class="hl-keyword">class</span>);

<span class="hl-comment">// you can also add existing aspect instances, the type of the object supplied must be an @AspectJ aspect</span>
factory.addAspect(usageTracker);

<span class="hl-comment">// now get the proxy object...</span>
MyInterfaceType proxy = factory.getProxy();</pre>

</div>
<div class="section" title="8.8&nbsp;Using AspectJ with Spring applications"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-using-aspectj"></a>8.8&nbsp;Using AspectJ with Spring applications</h2></div></div></div>

<p>Everything we&#8217;ve covered so far in this chapter is pure Spring AOP. In this section,
we&#8217;re going to look at how you can use the AspectJ compiler/weaver instead of, or in
addition to, Spring AOP if your needs go beyond the facilities offered by Spring AOP
alone.</p>
<p>Spring ships with a small AspectJ aspect library, which is available standalone in your
distribution as <code class="literal">spring-aspects.jar</code>; you&#8217;ll need to add this to your classpath in order
to use the aspects in it. <a class="xref" href="#aop-atconfigurable" title="8.8.1&nbsp;Using AspectJ to dependency inject domain objects with Spring">Section&nbsp;8.8.1, &#8220;Using AspectJ to dependency inject domain objects with Spring&#8221;</a> and <a class="xref" href="#aop-ajlib-other" title="8.8.2&nbsp;Other Spring aspects for AspectJ">Section&nbsp;8.8.2, &#8220;Other Spring aspects for AspectJ&#8221;</a> discuss the
content of this library and how you can use it. <a class="xref" href="#aop-aj-configure" title="8.8.3&nbsp;Configuring AspectJ aspects using Spring IoC">Section&nbsp;8.8.3, &#8220;Configuring AspectJ aspects using Spring IoC&#8221;</a> discusses how to
dependency inject AspectJ aspects that are woven using the AspectJ compiler. Finally,
<a class="xref" href="#aop-aj-ltw" title="8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework">Section&nbsp;8.8.4, &#8220;Load-time weaving with AspectJ in the Spring Framework&#8221;</a> provides an introduction to load-time weaving for Spring applications
using AspectJ.</p>
<div class="section" title="8.8.1&nbsp;Using AspectJ to dependency inject domain objects with Spring"><div class="titlepage"><div><div><h3 class="title"><a name="aop-atconfigurable"></a>8.8.1&nbsp;Using AspectJ to dependency inject domain objects with Spring</h3></div></div></div>

<p>The Spring container instantiates and configures beans defined in your application
context. It is also possible to ask a bean factory to configure a <span class="emphasis"><em>pre-existing</em></span>
object given the name of a bean definition containing the configuration to be applied.
The <code class="literal">spring-aspects.jar</code> contains an annotation-driven aspect that exploits this
capability to allow dependency injection of <span class="emphasis"><em>any object</em></span>. The support is intended to
be used for objects created <span class="emphasis"><em>outside of the control of any container</em></span>. Domain objects
often fall into this category because they are often created programmatically using the
<code class="literal">new</code> operator, or by an ORM tool as a result of a database query.</p>
<p>The <code class="literal">@Configurable</code> annotation marks a class as eligible for Spring-driven
configuration. In the simplest case it can be used just as a marker annotation:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.xyz.myapp.domain;

<span class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Configurable;

<i><span class="hl-annotation" style="color: gray">@Configurable</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Account {
    <span class="hl-comment">// ...</span>
}</pre>

<p>When used as a marker interface in this way, Spring will configure new instances of the
annotated type ( <code class="literal">Account</code> in this case) using a bean definition (typically
prototype-scoped) with the same name as the fully-qualified type name (
<code class="literal">com.xyz.myapp.domain.Account</code>). Since the default name for a bean is the
fully-qualified name of its type, a convenient way to declare the prototype definition
is simply to omit the <code class="literal">id</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.xyz.myapp.domain.Account"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fundsTransferService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"fundsTransferService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>If you want to explicitly specify the name of the prototype bean definition to use, you
can do so directly in the annotation:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.xyz.myapp.domain;

<span class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Configurable;

<i><span class="hl-annotation" style="color: gray">@Configurable("account")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Account {
    <span class="hl-comment">// ...</span>
}</pre>

<p>Spring will now look for a bean definition named " <code class="literal">account</code>" and use that as the
definition to configure new <code class="literal">Account</code> instances.</p>
<p>You can also use autowiring to avoid having to specify a dedicated bean definition at
all. To have Spring apply autowiring use the ' <code class="literal">autowire</code>' property of the
<code class="literal">@Configurable</code> annotation: specify either <code class="literal">@Configurable(autowire=Autowire.BY_TYPE)</code> or
<code class="literal">@Configurable(autowire=Autowire.BY_NAME</code> for autowiring by type or by name
respectively. As an alternative, as of Spring 2.5 it is preferable to specify explicit,
annotation-driven dependency injection for your <code class="literal">@Configurable</code> beans by using
<code class="literal">@Autowired</code> or <code class="literal">@Inject</code> at the field or method level (see <a class="xref" href="#beans-annotation-config" title="4.9&nbsp;Annotation-based container configuration">Section&nbsp;4.9, &#8220;Annotation-based container configuration&#8221;</a>
for further details).</p>
<p>Finally you can enable Spring dependency checking for the object references in the newly
created and configured object by using the <code class="literal">dependencyCheck</code> attribute (for example:
<code class="literal">@Configurable(autowire=Autowire.BY_NAME,dependencyCheck=true)</code>). If this attribute is
set to true, then Spring will validate after configuration that all properties (<span class="emphasis"><em>which
are not primitives or collections</em></span>) have been set.</p>
<p>Using the annotation on its own does nothing of course. It is the
<code class="literal">AnnotationBeanConfigurerAspect</code> in <code class="literal">spring-aspects.jar</code> that acts on the presence of
the annotation. In essence the aspect says "after returning from the initialization of a
new object of a type annotated with <code class="literal">@Configurable</code>, configure the newly created object
using Spring in accordance with the properties of the annotation". In this context,
<span class="emphasis"><em>initialization</em></span> refers to newly instantiated objects (e.g., objects instantiated with
the ' <code class="literal">new</code>' operator) as well as to <code class="literal">Serializable</code> objects that are undergoing
deserialization (e.g., via
<a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/java/io/Serializable.html" target="_top">readResolve()</a>).</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>One of the key phrases in the above paragraph is <span class="emphasis"><em><span class="emphasis"><em>in essence</em></span></em></span>. For most cases, the
exact semantics of <span class="emphasis"><em><span class="emphasis"><em>after returning from the initialization of a new object</em></span></em></span> will be
fine&#8230; in this context, <span class="emphasis"><em><span class="emphasis"><em>after initialization</em></span></em></span> means that the dependencies will be
injected <span class="emphasis"><em>after</em></span> the object has been constructed - this means that the dependencies
will not be available for use in the constructor bodies of the class. If you want the
dependencies to be injected <span class="emphasis"><em>before</em></span> the constructor bodies execute, and thus be
available for use in the body of the constructors, then you need to define this on the
<code class="literal">@Configurable</code> declaration like so:</p>
<pre class="programlisting">@Configurable(preConstruction=true)</pre>

<p>You can find out more information about the language semantics of the various pointcut
types in AspectJ
<a class="ulink" href="http://www.eclipse.org/aspectj/doc/next/progguide/semantics-joinPoints.html" target="_top">in this
appendix</a> of the <a class="ulink" href="http://www.eclipse.org/aspectj/doc/next/progguide/index.html" target="_top">AspectJ
Programming Guide</a>.</p>
</td></tr></table></div>

<p>For this to work the annotated types must be woven with the AspectJ weaver - you can
either use a build-time Ant or Maven task to do this (see for example the
<a class="ulink" href="http://www.eclipse.org/aspectj/doc/released/devguide/antTasks.html" target="_top">AspectJ Development
Environment Guide</a>) or load-time weaving (see <a class="xref" href="#aop-aj-ltw" title="8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework">Section&nbsp;8.8.4, &#8220;Load-time weaving with AspectJ in the Spring Framework&#8221;</a>). The
<code class="literal">AnnotationBeanConfigurerAspect</code> itself needs configuring by Spring (in order to obtain
a reference to the bean factory that is to be used to configure new objects). If you are
using Java based configuration simply add <code class="literal">@EnableSpringConfigured</code> to any
<code class="literal">@Configuration</code> class.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableSpringConfigured</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

}</pre>

<p>If you prefer XML based configuration, the Spring <a class="link" href="#xsd-config-body-schemas-context" title="33.2.8&nbsp;the context schema"><code class="literal">context</code> namespace</a> defines a convenient <code class="literal">context:spring-configured</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:spring-configured/&gt;</span></pre>

<p>Instances of <code class="literal">@Configurable</code> objects created <span class="emphasis"><em>before</em></span> the aspect has been configured
will result in a message being issued to the debug log and no configuration of the
object taking place. An example might be a bean in the Spring configuration that creates
domain objects when it is initialized by Spring. In this case you can use the
"depends-on" bean attribute to manually specify that the bean depends on the
configuration aspect.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myService"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"com.xzy.myapp.service.MyService"</span>
        <span class="hl-attribute">depends-on</span>=<span class="hl-value">"org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- ... --&gt;</span>

<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Do not activate <code class="literal">@Configurable</code> processing through the bean configurer aspect unless you
really mean to rely on its semantics at runtime. In particular, make sure that you do
not use <code class="literal">@Configurable</code> on bean classes which are registered as regular Spring beans
with the container: You would get double initialization otherwise, once through the
container and once through the aspect.</p>
</td></tr></table></div>

<div class="section" title="Unit testing @Configurable objects"><div class="titlepage"><div><div><h4 class="title"><a name="aop-configurable-testing"></a>Unit testing @Configurable objects</h4></div></div></div>

<p>One of the goals of the <code class="literal">@Configurable</code> support is to enable independent unit testing of
domain objects without the difficulties associated with hard-coded lookups. If
<code class="literal">@Configurable</code> types have not been woven by AspectJ then the annotation has no affect
during unit testing, and you can simply set mock or stub property references in the
object under test and proceed as normal. If <code class="literal">@Configurable</code> types <span class="emphasis"><em>have</em></span> been woven by
AspectJ then you can still unit test outside of the container as normal, but you will
see a warning message each time that you construct an <code class="literal">@Configurable</code> object indicating
that it has not been configured by Spring.</p>
</div>
<div class="section" title="Working with multiple application contexts"><div class="titlepage"><div><div><h4 class="title"><a name="aop-configurable-container"></a>Working with multiple application contexts</h4></div></div></div>

<p>The <code class="literal">AnnotationBeanConfigurerAspect</code> used to implement the <code class="literal">@Configurable</code> support is an
AspectJ singleton aspect. The scope of a singleton aspect is the same as the scope of
<code class="literal">static</code> members, that is to say there is one aspect instance per classloader that
defines the type. This means that if you define multiple application contexts within the
same classloader hierarchy you need to consider where to define the
<code class="literal">@EnableSpringConfigured</code> bean and where to place <code class="literal">spring-aspects.jar</code> on the classpath.</p>
<p>Consider a typical Spring web-app configuration with a shared parent application context
defining common business services and everything needed to support them, and one child
application context per servlet containing definitions particular to that servlet. All
of these contexts will co-exist within the same classloader hierarchy, and so the
<code class="literal">AnnotationBeanConfigurerAspect</code> can only hold a reference to one of them. In this case
we recommend defining the <code class="literal">@EnableSpringConfigured</code> bean in the shared (parent)
application context: this defines the services that you are likely to want to inject
into domain objects. A consequence is that you cannot configure domain objects with
references to beans defined in the child (servlet-specific) contexts using the
@Configurable mechanism (probably not something you want to do anyway!).</p>
<p>When deploying multiple web-apps within the same container, ensure that each
web-application loads the types in <code class="literal">spring-aspects.jar</code> using its own classloader (for
example, by placing <code class="literal">spring-aspects.jar</code> in <code class="literal">'WEB-INF/lib'</code>). If <code class="literal">spring-aspects.jar</code> is
only added to the container wide classpath (and hence loaded by the shared parent
classloader), all web applications will share the same aspect instance which is probably
not what you want.</p>
</div>
</div>
<div class="section" title="8.8.2&nbsp;Other Spring aspects for AspectJ"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ajlib-other"></a>8.8.2&nbsp;Other Spring aspects for AspectJ</h3></div></div></div>

<p>In addition to the <code class="literal">@Configurable</code> aspect, <code class="literal">spring-aspects.jar</code> contains an AspectJ
aspect that can be used to drive Spring&#8217;s transaction management for types and methods
annotated with the <code class="literal">@Transactional</code> annotation. This is primarily intended for users who
want to use the Spring Framework&#8217;s transaction support outside of the Spring container.</p>
<p>The aspect that interprets <code class="literal">@Transactional</code> annotations is the
<code class="literal">AnnotationTransactionAspect</code>. When using this aspect, you must annotate the
<span class="emphasis"><em>implementation</em></span> class (and/or methods within that class), <span class="emphasis"><em>not</em></span> the interface (if
any) that the class implements. AspectJ follows Java&#8217;s rule that annotations on
interfaces are <span class="emphasis"><em>not inherited</em></span>.</p>
<p>A <code class="literal">@Transactional</code> annotation on a class specifies the default transaction semantics for
the execution of any <span class="emphasis"><em>public</em></span> operation in the class.</p>
<p>A <code class="literal">@Transactional</code> annotation on a method within the class overrides the default
transaction semantics given by the class annotation (if present). Methods with <code class="literal">public</code>,
<code class="literal">protected</code>, and default visibility may all be annotated. Annotating <code class="literal">protected</code> and
default visibility methods directly is the only way to get transaction demarcation for
the execution of such methods.</p>
<p>For AspectJ programmers that want to use the Spring configuration and transaction
management support but don&#8217;t want to (or cannot) use annotations, <code class="literal">spring-aspects.jar</code>
also contains <code class="literal">abstract</code> aspects you can extend to provide your own pointcut
definitions. See the sources for the <code class="literal">AbstractBeanConfigurerAspect</code> and
<code class="literal">AbstractTransactionAspect</code> aspects for more information. As an example, the following
excerpt shows how you could write an aspect to configure all instances of objects
defined in the domain model using prototype bean definitions that match the
fully-qualified class names:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> aspect DomainObjectConfiguration <span class="hl-keyword">extends</span> AbstractBeanConfigurerAspect {

    <span class="hl-keyword">public</span> DomainObjectConfiguration() {
        setBeanWiringInfoResolver(<span class="hl-keyword">new</span> ClassNameBeanWiringInfoResolver());
    }

    <span class="hl-comment">// the creation of a new bean (any object in the domain model)</span>
    <span class="hl-keyword">protected</span> pointcut beanCreation(Object beanInstance) :
        initialization(<span class="hl-keyword">new</span>(..)) &amp;&amp;
        SystemArchitecture.inDomainModel() &amp;&amp;
        <span class="hl-keyword">this</span>(beanInstance);

}</pre>

</div>
<div class="section" title="8.8.3&nbsp;Configuring AspectJ aspects using Spring IoC"><div class="titlepage"><div><div><h3 class="title"><a name="aop-aj-configure"></a>8.8.3&nbsp;Configuring AspectJ aspects using Spring IoC</h3></div></div></div>

<p>When using AspectJ aspects with Spring applications, it is natural to both want and
expect to be able to configure such aspects using Spring. The AspectJ runtime itself is
responsible for aspect creation, and the means of configuring the AspectJ created
aspects via Spring depends on the AspectJ instantiation model (the ' <code class="literal">per-xxx</code>' clause)
used by the aspect.</p>
<p>The majority of AspectJ aspects are <span class="emphasis"><em>singleton</em></span> aspects. Configuration of these
aspects is very easy: simply create a bean definition referencing the aspect type as
normal, and include the bean attribute <code class="literal">'factory-method="aspectOf"'</code>. This ensures that
Spring obtains the aspect instance by asking AspectJ for it rather than trying to create
an instance itself. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"profiler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.xyz.profiler.Profiler"</span>
        <span class="strong"><strong>factory-method="aspectOf"</strong></span>&gt;

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"profilingStrategy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"jamonProfilingStrategy"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Non-singleton aspects are harder to configure: however it is possible to do so by
creating prototype bean definitions and using the <code class="literal">@Configurable</code> support from
<code class="literal">spring-aspects.jar</code> to configure the aspect instances once they have bean created by
the AspectJ runtime.</p>
<p>If you have some @AspectJ aspects that you want to weave with AspectJ (for example,
using load-time weaving for domain model types) and other @AspectJ aspects that you want
to use with Spring AOP, and these aspects are all configured using Spring, then you will
need to tell the Spring AOP @AspectJ autoproxying support which exact subset of the
@AspectJ aspects defined in the configuration should be used for autoproxying. You can
do this by using one or more <code class="literal">&lt;include/&gt;</code> elements inside the <code class="literal">&lt;aop:aspectj-autoproxy/&gt;</code>
declaration. Each <code class="literal">&lt;include/&gt;</code> element specifies a name pattern, and only beans with
names matched by at least one of the patterns will be used for Spring AOP autoproxy
configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:aspectj-autoproxy&gt;</span>
    <span class="hl-tag">&lt;aop:include</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thisBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;aop:include</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thatBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/aop:aspectj-autoproxy&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Do not be misled by the name of the <code class="literal">&lt;aop:aspectj-autoproxy/&gt;</code> element: using it will
result in the creation of <span class="emphasis"><em>Spring AOP proxies</em></span>. The @AspectJ style of aspect
declaration is just being used here, but the AspectJ runtime is <span class="emphasis"><em>not</em></span> involved.</p>
</td></tr></table></div>

</div>
<div class="section" title="8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework"><div class="titlepage"><div><div><h3 class="title"><a name="aop-aj-ltw"></a>8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework</h3></div></div></div>

<p>Load-time weaving (LTW) refers to the process of weaving AspectJ aspects into an
application&#8217;s class files as they are being loaded into the Java virtual machine (JVM).
The focus of this section is on configuring and using LTW in the specific context of the
Spring Framework: this section is not an introduction to LTW though. For full details on
the specifics of LTW and configuring LTW with just AspectJ (with Spring not being
involved at all), see the
<a class="ulink" href="http://www.eclipse.org/aspectj/doc/released/devguide/ltw.html" target="_top">LTW section of the AspectJ
Development Environment Guide</a>.</p>
<p>The value-add that the Spring Framework brings to AspectJ LTW is in enabling much
finer-grained control over the weaving process. <span class="emphasis"><em>Vanilla</em></span> AspectJ LTW is effected using
a Java (5+) agent, which is switched on by specifying a VM argument when starting up a
JVM. It is thus a JVM-wide setting, which may be fine in some situations, but often is a
little too coarse. Spring-enabled LTW enables you to switch on LTW on a
<span class="emphasis"><em>per-ClassLoader</em></span> basis, which obviously is more fine-grained and which can make more
sense in a <span class="emphasis"><em>single-JVM-multiple-application</em></span> environment (such as is found in a typical
application server environment).</p>
<p>Further, <a class="link" href="#aop-aj-ltw-environments" title="Environment-specific configuration">in certain environments</a>, this support enables
load-time weaving <span class="emphasis"><em>without making any modifications to the application server&#8217;s launch
script</em></span> that will be needed to add <code class="literal">-javaagent:path/to/aspectjweaver.jar</code> or (as we
describe later in this section)
<code class="literal">-javaagent:path/to/org.springframework.instrument-{version}.jar</code> (previously named
<code class="literal">spring-agent.jar</code>). Developers simply modify one or more files that form the
application context to enable load-time weaving instead of relying on administrators who
typically are in charge of the deployment configuration such as the launch script.</p>
<p>Now that the sales pitch is over, let us first walk through a quick example of AspectJ
LTW using Spring, followed by detailed specifics about elements introduced in the
following example. For a complete example, please see the
<a class="ulink" href="https://github.com/spring-projects/spring-petclinic" target="_top">Petclinic sample application</a>.</p>
<div class="section" title="A first example"><div class="titlepage"><div><div><h4 class="title"><a name="aop-aj-ltw-first-example"></a>A first example</h4></div></div></div>

<p>Let us assume that you are an application developer who has been tasked with diagnosing
the cause of some performance problems in a system. Rather than break out a profiling
tool, what we are going to do is switch on a simple profiling aspect that will enable us
to very quickly get some performance metrics, so that we can then apply a finer-grained
profiling tool to that specific area immediately afterwards.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The example presented here uses XML style configuration, it is also possible to
configure and use @AspectJ with <a class="link" href="#beans-java" title="4.12&nbsp;Java-based container configuration">Java Configuration</a>. Specifically the
<code class="literal">@EnableLoadTimeWeaving</code> annotation can be used as an alternative to
<code class="literal">&lt;context:load-time-weaver/&gt;</code> (see <a class="link" href="#aop-aj-ltw-spring" title="Spring configuration">below</a> for details).</p>
</td></tr></table></div>

<p>Here is the profiling aspect. Nothing too fancy, just a quick-and-dirty time-based
profiler, using the @AspectJ-style of aspect declaration.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> foo;

<span class="hl-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hl-keyword">import</span> org.aspectj.lang.annotation.Pointcut;
<span class="hl-keyword">import</span> org.springframework.util.StopWatch;
<span class="hl-keyword">import</span> org.springframework.core.annotation.Order;

<i><span class="hl-annotation" style="color: gray">@Aspect</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProfilingAspect {

    <i><span class="hl-annotation" style="color: gray">@Around("methodsToBeProfiled()")</span></i>
    <span class="hl-keyword">public</span> Object profile(ProceedingJoinPoint pjp) <span class="hl-keyword">throws</span> Throwable {
        StopWatch sw = <span class="hl-keyword">new</span> StopWatch(getClass().getSimpleName());
        <span class="hl-keyword">try</span> {
            sw.start(pjp.getSignature().getName());
            <span class="hl-keyword">return</span> pjp.proceed();
        } <span class="hl-keyword">finally</span> {
            sw.stop();
            System.out.println(sw.prettyPrint());
        }
    }

    @Pointcut(<span class="hl-string">"execution(public * foo..</span><span class="strong"><strong>.</strong></span>(..))<span class="hl-string">")
</span>    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> methodsToBeProfiled(){}
}</pre>

<p>We will also need to create an ' <code class="literal">META-INF/aop.xml</code>' file, to inform the AspectJ weaver
that we want to weave our <code class="literal">ProfilingAspect</code> into our classes. This file convention,
namely the presence of a file (or files) on the Java classpath called '
<code class="literal">META-INF/aop.xml</code>' is standard AspectJ.</p>
<pre class="programlisting"><b class="hl-tag" style="color: blue">&lt;!DOCTYPE aspectj PUBLIC "-//AspectJ//DTD//EN" "http://www.eclipse.org/aspectj/dtd/aspectj.dtd"&gt;</b>
<span class="hl-tag">&lt;aspectj&gt;</span>

    <span class="hl-tag">&lt;weaver&gt;</span>
        <span class="hl-comment">&lt;!-- only weave classes in our application-specific packages --&gt;</span>
        <span class="hl-tag">&lt;include</span> <span class="hl-attribute">within</span>=<span class="hl-value">"foo.*"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/weaver&gt;</span>

    <span class="hl-tag">&lt;aspects&gt;</span>
        <span class="hl-comment">&lt;!-- weave in just this aspect --&gt;</span>
        <span class="hl-tag">&lt;aspect</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo.ProfilingAspect"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/aspects&gt;</span>

<span class="hl-tag">&lt;/aspectj&gt;</span></pre>

<p>Now to the Spring-specific portion of the configuration. We need to configure a
<code class="literal">LoadTimeWeaver</code> (all explained later, just take it on trust for now). This load-time
weaver is the essential component responsible for weaving the aspect configuration in
one or more ' <code class="literal">META-INF/aop.xml</code>' files into the classes in your application. The good
thing is that it does not require a lot of configuration, as can be seen below (there
are some more options that you can specify, but these are detailed later).</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- a service object; we will be profiling its methods --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"entitlementCalculationService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"foo.StubEntitlementCalculationService"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- this switches on the load-time weaving --&gt;</span>
    <span class="strong"><strong>&lt;context:load-time-weaver/&gt;</strong></span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Now that all the required artifacts are in place - the aspect, the ' <code class="literal">META-INF/aop.xml</code>'
file, and the Spring configuration -, let us create a simple driver class with a
<code class="literal">main(..)</code> method to demonstrate the LTW in action.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> foo;

<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> Main {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {

        ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"beans.xml"</span>, Main.<span class="hl-keyword">class</span>);

        EntitlementCalculationService entitlementCalculationService
            = (EntitlementCalculationService) ctx.getBean(<span class="hl-string">"entitlementCalculationService"</span>);

        <span class="hl-comment">// the profiling aspect is </span><span class="emphasis"><em>woven</em></span> around <span class="hl-keyword">this</span> method execution
        entitlementCalculationService.calculateEntitlement();
    }
}</pre>

<p>There is one last thing to do. The introduction to this section did say that one could
switch on LTW selectively on a per- <code class="literal">ClassLoader</code> basis with Spring, and this is true.
However, just for this example, we are going to use a Java agent (supplied with Spring)
to switch on the LTW. This is the command line we will use to run the above <code class="literal">Main</code> class:</p>

<pre class="literallayout">java -javaagent:C:/projects/foo/lib/global/spring-instrument.jar foo.Main</pre>

<p>The ' <code class="literal">-javaagent</code>' is a flag for specifying and enabling
<a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/java/lang/instrument/package-summary.html" target="_top">agents
to instrument programs running on the JVM</a>. The Spring Framework ships with such an
agent, the <code class="literal">InstrumentationSavingAgent</code>, which is packaged in the
<code class="literal">spring-instrument.jar</code> that was supplied as the value of the <code class="literal">-javaagent</code> argument in
the above example.</p>
<p>The output from the execution of the <code class="literal">Main</code> program will look something like that below.
(I have introduced a <code class="literal">Thread.sleep(..)</code> statement into the <code class="literal">calculateEntitlement()</code>
implementation so that the profiler actually captures something other than 0
milliseconds - the <code class="literal">01234</code> milliseconds is <span class="emphasis"><em>not</em></span> an overhead introduced by the AOP :) )</p>

<pre class="literallayout">Calculating entitlement

StopWatch <span class="emphasis"><em>ProfilingAspect</em></span>: running time (millis) = 1234
------ ----- ----------------------------
ms     %     Task name
------ ----- ----------------------------
01234  100%  calculateEntitlement</pre>

<p>Since this LTW is effected using full-blown AspectJ, we are not just limited to advising
Spring beans; the following slight variation on the <code class="literal">Main</code> program will yield the same
result.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> foo;

<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> Main {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {

        <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"beans.xml"</span>, Main.<span class="hl-keyword">class</span>);

        EntitlementCalculationService entitlementCalculationService =
            <span class="hl-keyword">new</span> StubEntitlementCalculationService();

        <span class="hl-comment">// the profiling aspect will be </span><span class="emphasis"><em>woven</em></span> around <span class="hl-keyword">this</span> method execution
        entitlementCalculationService.calculateEntitlement();
    }
}</pre>

<p>Notice how in the above program we are simply bootstrapping the Spring container, and
then creating a new instance of the <code class="literal">StubEntitlementCalculationService</code> totally outside
the context of Spring&#8230; the profiling advice still gets woven in.</p>
<p>The example admittedly is simplistic&#8230; however the basics of the LTW support in Spring
have all been introduced in the above example, and the rest of this section will explain
the <span class="emphasis"><em>why</em></span> behind each bit of configuration and usage in detail.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">ProfilingAspect</code> used in this example may be basic, but it is quite useful. It is a
nice example of a development-time aspect that developers can use during development (of
course), and then quite easily exclude from builds of the application being deployed
into UAT or production.</p>
</td></tr></table></div>

</div>
<div class="section" title="Aspects"><div class="titlepage"><div><div><h4 class="title"><a name="aop-aj-ltw-the-aspects"></a>Aspects</h4></div></div></div>

<p>The aspects that you use in LTW have to be AspectJ aspects. They can be written in
either the AspectJ language itself or you can write your aspects in the @AspectJ-style.
It means that your aspects are then both valid AspectJ <span class="emphasis"><em>and</em></span> Spring AOP aspects.
Furthermore, the compiled aspect classes need to be available on the classpath.</p>
</div>
<div class="section" title="' META-INF/aop.xml'"><div class="titlepage"><div><div><h4 class="title"><a name="aop-aj-ltw-aop_dot_xml"></a>' META-INF/aop.xml'</h4></div></div></div>

<p>The AspectJ LTW infrastructure is configured using one or more ' <code class="literal">META-INF/aop.xml</code>'
files, that are on the Java classpath (either directly, or more typically in jar files).</p>
<p>The structure and contents of this file is detailed in the main AspectJ reference
documentation, and the interested reader is
<a class="ulink" href="http://www.eclipse.org/aspectj/doc/released/devguide/ltw-configuration.html" target="_top">referred to
that resource</a>. (I appreciate that this section is brief, but the ' <code class="literal">aop.xml</code>' file is
100% AspectJ - there is no Spring-specific information or semantics that apply to it,
and so there is no extra value that I can contribute either as a result), so rather than
rehash the quite satisfactory section that the AspectJ developers wrote, I am just
directing you there.)</p>
</div>
<div class="section" title="Required libraries (JARS)"><div class="titlepage"><div><div><h4 class="title"><a name="aop-aj-ltw-libraries"></a>Required libraries (JARS)</h4></div></div></div>

<p>At a minimum you will need the following libraries to use the Spring Framework&#8217;s support
for AspectJ LTW:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">spring-aop.jar</code> (version 2.5 or later, plus all mandatory dependencies)
</li><li class="listitem">
<code class="literal">aspectjweaver.jar</code> (version 1.6.8 or later)
</li></ul></div>

<p>If you are using the <a class="link" href="#aop-aj-ltw-environment-generic" title="Generic Java applications">Spring-provided agent to enable
instrumentation</a>, you will also need:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">spring-instrument.jar</code>
</li></ul></div>

</div>
<div class="section" title="Spring configuration"><div class="titlepage"><div><div><h4 class="title"><a name="aop-aj-ltw-spring"></a>Spring configuration</h4></div></div></div>

<p>The key component in Spring&#8217;s LTW support is the <code class="literal">LoadTimeWeaver</code> interface (in the
<code class="literal">org.springframework.instrument.classloading</code> package), and the numerous implementations
of it that ship with the Spring distribution. A <code class="literal">LoadTimeWeaver</code> is responsible for
adding one or more <code class="literal">java.lang.instrument.ClassFileTransformers</code> to a <code class="literal">ClassLoader</code> at
runtime, which opens the door to all manner of interesting applications, one of which
happens to be the LTW of aspects.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you are unfamiliar with the idea of runtime class file transformation, you are
encouraged to read the Javadoc API documentation for the <code class="literal">java.lang.instrument</code> package
before continuing. This is not a huge chore because there is - rather annoyingly -
precious little documentation there&#8230; the key interfaces and classes will at least be
laid out in front of you for reference as you read through this section.</p>
</td></tr></table></div>

<p>Configuring a <code class="literal">LoadTimeWeaver</code> for a particular <code class="literal">ApplicationContext</code> can be as easy as
adding one line. (Please note that you almost certainly will need to be using an
<code class="literal">ApplicationContext</code> as your Spring container - typically a <code class="literal">BeanFactory</code> will not be
enough because the LTW support makes use of <code class="literal">BeanFactoryPostProcessors</code>.)</p>
<p>To enable the Spring Framework&#8217;s LTW support, you need to configure a <code class="literal">LoadTimeWeaver</code>,
which typically is done using the <code class="literal">@EnableLoadTimeWeaving</code> annotation.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableLoadTimeWeaving</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

}</pre>

<p>Alternatively, if you prefer XML based configuration, use the
<code class="literal">&lt;context:load-time-weaver/&gt;</code> element. Note that the element is defined in the '
<code class="literal">context</code>' namespace.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:load-time-weaver/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The above configuration will define and register a number of LTW-specific infrastructure
beans for you automatically, such as a <code class="literal">LoadTimeWeaver</code> and an <code class="literal">AspectJWeavingEnabler</code>.
The default <code class="literal">LoadTimeWeaver</code> is the <code class="literal">DefaultContextLoadTimeWeaver</code> class, which attempts
to decorate an automatically detected <code class="literal">LoadTimeWeaver</code>: the exact type of
<code class="literal">LoadTimeWeaver</code> that will be <span class="emphasis"><em>automatically detected</em></span> is dependent upon your runtime
environment (summarized in the following table).</p>
<div class="table"><a name="aop-aj-ltw-spring-env-impls"></a><p class="title"><b>Table&nbsp;8.1.&nbsp;DefaultContextLoadTimeWeaver LoadTimeWeavers</b></p><div class="table-contents">

  <table summary="DefaultContextLoadTimeWeaver LoadTimeWeavers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Environment</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top"><code class="literal">LoadTimeWeaver</code> implementation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Running in
  <a class="ulink" href="http://www.bea.com/framework.jsp?CNT=index.htm&amp;FP=/content/products/weblogic/server" target="_top">BEA&#8217;s
  Weblogic 10</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">WebLogicLoadTimeWeaver</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Running in <a class="ulink" href="http://www-01.ibm.com/software/webservers/appserv/was/" target="_top">IBM WebSphere
  Application Server 7</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">WebSphereLoadTimeWeaver</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Running in <a class="ulink" href="http://glassfish.dev.java.net/" target="_top">GlassFish</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">GlassFishLoadTimeWeaver</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Running in <a class="ulink" href="http://www.jboss.org/jbossas/" target="_top">JBoss AS</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JBossLoadTimeWeaver</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JVM started with Spring <code class="literal">InstrumentationSavingAgent</code> <span class="emphasis"><em>(java
  -javaagent:path/to/spring-instrument.jar)</em></span></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">InstrumentationLoadTimeWeaver</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Fallback, expecting the underlying ClassLoader to follow common conventions (e.g.
  applicable to <code class="literal">TomcatInstrumentableClassLoader</code> and <a class="ulink" href="http://www.caucho.com/" target="_top">Resin</a>)</p></td><td style="" align="left" valign="top"><p><code class="literal">ReflectiveLoadTimeWeaver</code></p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>Note that these are just the <code class="literal">LoadTimeWeavers</code> that are autodetected when using the
<code class="literal">DefaultContextLoadTimeWeaver</code>: it is of course possible to specify exactly which
<code class="literal">LoadTimeWeaver</code> implementation that you wish to use.</p>
<p>To specify a specific <code class="literal">LoadTimeWeaver</code> with Java configuration implement the
<code class="literal">LoadTimeWeavingConfigurer</code> interface and override the <code class="literal">getLoadTimeWeaver()</code> method:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableLoadTimeWeaving</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig <span class="hl-keyword">implements</span> LoadTimeWeavingConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> LoadTimeWeaver getLoadTimeWeaver() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ReflectiveLoadTimeWeaver();
    }
}</pre>

<p>If you are using XML based configuration you can specify the fully-qualified classname
as the value of the ' <code class="literal">weaver-class</code>' attribute on the <code class="literal">&lt;context:load-time-weaver/&gt;</code>
element:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:load-time-weaver</span>
            <span class="hl-attribute">weaver-class</span>=<span class="hl-value">"org.springframework.instrument.classloading.ReflectiveLoadTimeWeaver"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The <code class="literal">LoadTimeWeaver</code> that is defined and registered by the configuration can be later
retrieved from the Spring container using the well-known name ' <code class="literal">loadTimeWeaver</code>'.
Remember that the <code class="literal">LoadTimeWeaver</code> exists just as a mechanism for Spring&#8217;s LTW
infrastructure to add one or more <code class="literal">ClassFileTransformers</code>. The actual
<code class="literal">ClassFileTransformer</code> that does the LTW is the <code class="literal">ClassPreProcessorAgentAdapter</code> (from
the <code class="literal">org.aspectj.weaver.loadtime</code> package) class. See the class-level Javadoc for the
<code class="literal">ClassPreProcessorAgentAdapter</code> class for further details, because the specifics of how
the weaving is actually effected is beyond the scope of this section.</p>
<p>There is one final attribute of the configuration left to discuss: the '
<code class="literal">aspectjWeaving</code>' attribute (or ' <code class="literal">aspectj-weaving</code>' if you are using XML). This is a
simple attribute that controls whether LTW is enabled or not, it is as simple as that.
It accepts one of three possible values, summarized below, with the default value if the
attribute is not present being ' <code class="literal">autodetect</code>'</p>
<div class="table"><a name="aop-aj-ltw-ltw-tag-attrs"></a><p class="title"><b>Table&nbsp;8.2.&nbsp;AspectJ weaving attribute values</b></p><div class="table-contents">

  <table summary="AspectJ weaving attribute values" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Annotation Value</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">XML Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ENABLED</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">on</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>AspectJ weaving is on, and aspects will be woven at load-time as appropriate.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DISABLED</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">off</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LTW is off&#8230; no aspect will be woven at load-time.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">AUTODETECT</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">autodetect</code></p></td><td style="" align="left" valign="top"><p>If the Spring LTW infrastructure can find at least one ' <code class="literal">META-INF/aop.xml</code>' file,
  then AspectJ weaving is on, else it is off. This is the default value.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="Environment-specific configuration"><div class="titlepage"><div><div><h4 class="title"><a name="aop-aj-ltw-environments"></a>Environment-specific configuration</h4></div></div></div>

<p>This last section contains any additional settings and configuration that you will need
when using Spring&#8217;s LTW support in environments such as application servers and web
containers.</p>
<div class="section" title="Tomcat"><div class="titlepage"><div><div><h5 class="title"><a name="aop-aj-ltw-environment-tomcat"></a>Tomcat</h5></div></div></div>

<p><a class="ulink" href="http://tomcat.apache.org/" target="_top">Apache Tomcat</a>'s default class loader does not support class
transformation which is why Spring provides an enhanced implementation that addresses
this need. Named <code class="literal">TomcatInstrumentableClassLoader</code>, the loader works on Tomcat 5.0 and
above and can be registered individually for <span class="emphasis"><em>each</em></span> web application as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Tomcat 6.0.x or higher
</li><li class="listitem">
Copy <code class="literal">org.springframework.instrument.tomcat.jar</code> into <span class="emphasis"><em>$CATALINA_HOME</em></span>/lib, where
<span class="emphasis"><em>$CATALINA_HOME</em></span> represents the root of the Tomcat installation)
</li><li class="listitem">
Instruct Tomcat to use the custom class loader (instead of the default) by editing the
web application context file:
</li></ul></div>

<pre class="programlisting"><span class="hl-tag">&lt;Context</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myWebApp"</span> <span class="hl-attribute">docBase</span>=<span class="hl-value">"/my/webApp/location"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;Loader</span>
        <span class="hl-attribute">loaderClass</span>=<span class="hl-value">"org.springframework.instrument.classloading.tomcat.TomcatInstrumentableClassLoader"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/Context&gt;</span></pre>

<p>Apache Tomcat 6.0.x (similar to 5.0.x/5.5.x) series supports several context locations:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
server configuration file - <span class="emphasis"><em>$CATALINA_HOME/conf/server.xml</em></span>
</li><li class="listitem">
default context configuration - <span class="emphasis"><em>$CATALINA_HOME/conf/context.xml</em></span> - that affects all
deployed web applications
</li><li class="listitem">
per-web application configuration which can be deployed either on the server-side at
<span class="emphasis"><em>$CATALINA_HOME/conf/[enginename]/[hostname]/[webapp]-context.xml</em></span> or embedded
inside the web-app archive at <span class="emphasis"><em>META-INF/context.xml</em></span>
</li></ul></div>

<p>For efficiency, the embedded per-web-app configuration style is recommended because it
will impact only applications that use the custom class loader and does not require any
changes to the server configuration. See the Tomcat 6.0.x
<a class="ulink" href="http://tomcat.apache.org/tomcat-6.0-doc/config/context.html" target="_top">documentation</a> for more
details about available context locations.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Tomcat 5.0.x/5.5.x
</li><li class="listitem">
Copy <code class="literal">org.springframework.instrument.tomcat.jar</code> into <span class="emphasis"><em>$CATALINA_HOME</em></span>/server/lib,
where <span class="emphasis"><em>$CATALINA_HOME</em></span> represents the root of the Tomcat installation.
</li><li class="listitem">
Instruct Tomcat to use the custom class loader instead of the default one by editing
the web application context file:
</li></ul></div>

<pre class="programlisting"><span class="hl-tag">&lt;Context</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myWebApp"</span> <span class="hl-attribute">docBase</span>=<span class="hl-value">"/my/webApp/location"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;Loader</span>
        <span class="hl-attribute">loaderClass</span>=<span class="hl-value">"org.springframework.instrument.classloading.tomcat.TomcatInstrumentableClassLoader"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/Context&gt;</span></pre>

<p>Tomcat 5.0.x and 5.5.x series supports several context locations:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
server configuration file - <span class="emphasis"><em>$CATALINA_HOME/conf/server.xml</em></span>
</li><li class="listitem">
default context configuration - <span class="emphasis"><em>$CATALINA_HOME/conf/context.xml</em></span> - that affects all
deployed web applications
</li><li class="listitem">
per-web application configuration which can be deployed either on the server-side at
<span class="emphasis"><em>$CATALINA_HOME/conf/[enginename]/[hostname]/[webapp]-context.xml</em></span> or embedded
inside the web-app archive at <span class="emphasis"><em>META-INF/context.xml</em></span>
</li></ul></div>

<p>For efficiency, the embedded web-app configuration style is recommended recommended
because it will impact only applications that use the class loader. See the Tomcat 5.x
<a class="ulink" href="http://tomcat.apache.org/tomcat-5.5-doc/config/context.html" target="_top">documentation</a> for more
details about available context locations.</p>
<p>Tomcat versions prior to 5.5.20 contained a bug in the XML configuration parsing that
prevented usage of the <code class="literal">Loader</code> tag inside <span class="emphasis"><em>server.xml</em></span> configuration, regardless of
whether a class loader is specified or whether it is the official or a custom one. See
Tomcat&#8217;s bugzilla for <a class="ulink" href="http://issues.apache.org/bugzilla/show_bug.cgi?id=39704" target="_top">more
details</a>.</p>
<p>In Tomcat 5.5.x, versions 5.5.20 or later, you should set
<span class="emphasis"><em>useSystemClassLoaderAsParent</em></span> to <code class="literal">false</code> to fix this problem:</p>
<pre class="programlisting"><span class="hl-tag">&lt;Context</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myWebApp"</span> <span class="hl-attribute">docBase</span>=<span class="hl-value">"/my/webApp/location"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;Loader</span>
        <span class="hl-attribute">loaderClass</span>=<span class="hl-value">"org.springframework.instrument.classloading.tomcat.TomcatInstrumentableClassLoader"</span>
                <span class="strong"><strong>useSystemClassLoaderAsParent="false"</strong></span>/&gt;
<span class="hl-tag">&lt;/Context&gt;</span></pre>

<p>This setting is not needed on Tomcat 6 or higher.</p>
<p>Alternatively, consider the use of the Spring-provided generic VM agent, to be specified
in Tomcat&#8217;s launch script (see above). This will make instrumentation available to all
deployed web applications, no matter what ClassLoader they happen to run on.</p>
</div>
<div class="section" title="WebLogic, WebSphere, Resin, GlassFish, JBoss"><div class="titlepage"><div><div><h5 class="title"><a name="aop-aj-ltw-environments-weblogic-oc4j-resin-glassfish-jboss"></a>WebLogic, WebSphere, Resin, GlassFish, JBoss</h5></div></div></div>

<p>Recent versions of WebLogic Server (version 10 and above), IBM WebSphere Application
Server (version 7 and above), Resin (3.1 and above) and JBoss (5.x or above) provide a
ClassLoader that is capable of local instrumentation. Spring&#8217;s native LTW leverages such
ClassLoaders to enable AspectJ weaving. You can enable LTW by simply activating
load-time weaving as described earlier. Specifically, you do <span class="emphasis"><em>not</em></span> need to modify the
launch script to add <code class="literal">-javaagent:path/to/spring-instrument.jar</code>.</p>
<p>Note that GlassFish instrumentation-capable ClassLoader is available only in its EAR
environment. For GlassFish web applications, follow the Tomcat setup instructions as
outlined above.</p>
<p>Note that on JBoss 6.x, the app server scanning needs to be disabled to prevent it from
loading the classes before the application actually starts. A quick workaround is to add
to your artifact a file named <code class="literal">WEB-INF/jboss-scanning.xml</code> with the following content:</p>
<pre class="programlisting"><span class="hl-tag">&lt;scanning</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"urn:jboss:scanning:1.0"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="Generic Java applications"><div class="titlepage"><div><div><h5 class="title"><a name="aop-aj-ltw-environment-generic"></a>Generic Java applications</h5></div></div></div>

<p>When class instrumentation is required in environments that do not support or are not
supported by the existing <code class="literal">LoadTimeWeaver</code> implementations, a JDK agent can be the only
solution. For such cases, Spring provides <code class="literal">InstrumentationLoadTimeWeaver</code>, which
requires a Spring-specific (but very general) VM agent,
<code class="literal">org.springframework.instrument-{version}.jar</code> (previously named <code class="literal">spring-agent.jar</code>).</p>
<p>To use it, you must start the virtual machine with the Spring agent, by supplying the
following JVM options:</p>

<pre class="literallayout">-javaagent:/path/to/org.springframework.instrument-{version}.jar</pre>

<p>Note that this requires modification of the VM launch script which may prevent you from
using this in application server environments (depending on your operation policies).
Additionally, the JDK agent will instrument the <span class="emphasis"><em>entire</em></span> VM which can prove expensive.</p>
<p>For performance reasons, it is recommended to use this configuration only if your target
environment (such as <a class="ulink" href="http://www.eclipse.org/jetty/" target="_top">Jetty</a>) does not have (or does not
support) a dedicated LTW.</p>
</div>
</div>
</div>
</div>
<div class="section" title="8.9&nbsp;Further Resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-resources"></a>8.9&nbsp;Further Resources</h2></div></div></div>

<p>More information on AspectJ can be found on the <a class="ulink" href="http://www.eclipse.org/aspectj" target="_top">AspectJ
website</a>.</p>
<p>The book <span class="emphasis"><em>Eclipse AspectJ</em></span> by Adrian Colyer et. al. (Addison-Wesley, 2005) provides a
comprehensive introduction and reference for the AspectJ language.</p>
<p>The book <span class="emphasis"><em>AspectJ in Action</em></span> by Ramnivas Laddad (Manning, 2003) comes highly
recommended; the focus of the book is on AspectJ, but a lot of general AOP themes are
explored (in some depth).</p>
</div>
</div>
<div class="chapter" title="9.&nbsp;Spring AOP APIs"><div class="titlepage"><div><div><h2 class="title"><a name="aop-api"></a>9.&nbsp;Spring AOP APIs</h2></div></div></div>

<div class="section" title="9.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-introduction"></a>9.1&nbsp;Introduction</h2></div></div></div>

<p>The previous chapter described the Spring&#8217;s support for AOP using
@AspectJ and schema-based aspect definitions. In this chapter we discuss the lower-level
Spring AOP APIs and the AOP support used in Spring 1.2 applications. For new
applications, we recommend the use of the Spring 2.0 and later AOP support described in
the previous chapter, but when working with existing applications, or when reading books
and articles, you may come across Spring 1.2 style examples. Spring 4.0 is backwards
compatible with Spring 1.2 and everything described in this chapter is fully supported
in Spring 4.0.</p>
</div>
<div class="section" title="9.2&nbsp;Pointcut API in Spring"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-pointcuts"></a>9.2&nbsp;Pointcut API in Spring</h2></div></div></div>

<p>Let&#8217;s look at how Spring handles the crucial pointcut concept.</p>
<div class="section" title="9.2.1&nbsp;Concepts"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-concepts"></a>9.2.1&nbsp;Concepts</h3></div></div></div>

<p>Spring&#8217;s pointcut model enables pointcut reuse independent of advice types. It&#8217;s
possible to target different advice using the same pointcut.</p>
<p>The <code class="literal">org.springframework.aop.Pointcut</code> interface is the central interface, used to
target advices to particular classes and methods. The complete interface is shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Pointcut {

    ClassFilter getClassFilter();

    MethodMatcher getMethodMatcher();

}</pre>

<p>Splitting the <code class="literal">Pointcut</code> interface into two parts allows reuse of class and method
matching parts, and fine-grained composition operations (such as performing a "union"
with another method matcher).</p>
<p>The <code class="literal">ClassFilter</code> interface is used to restrict the pointcut to a given set of target
classes. If the <code class="literal">matches()</code> method always returns true, all target classes will be
matched:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ClassFilter {

    <span class="hl-keyword">boolean</span> matches(Class clazz);
}</pre>

<p>The <code class="literal">MethodMatcher</code> interface is normally more important. The complete interface is
shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodMatcher {

    <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass);

    <span class="hl-keyword">boolean</span> isRuntime();

    <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass, Object[] args);
}</pre>

<p>The <code class="literal">matches(Method, Class)</code> method is used to test whether this pointcut will ever
match a given method on a target class. This evaluation can be performed when an AOP
proxy is created, to avoid the need for a test on every method invocation. If the
2-argument matches method returns true for a given method, and the <code class="literal">isRuntime()</code> method
for the MethodMatcher returns true, the 3-argument matches method will be invoked on
every method invocation. This enables a pointcut to look at the arguments passed to the
method invocation immediately before the target advice is to execute.</p>
<p>Most MethodMatchers are static, meaning that their <code class="literal">isRuntime()</code> method returns false.
In this case, the 3-argument matches method will never be invoked.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If possible, try to make pointcuts static, allowing the AOP framework to cache the
results of pointcut evaluation when an AOP proxy is created.</p>
</td></tr></table></div>

</div>
<div class="section" title="9.2.2&nbsp;Operations on pointcuts"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcut-ops"></a>9.2.2&nbsp;Operations on pointcuts</h3></div></div></div>

<p>Spring supports operations on pointcuts: notably, <span class="emphasis"><em>union</em></span> and <span class="emphasis"><em>intersection</em></span>.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Union means the methods that either pointcut matches.
</li><li class="listitem">
Intersection means the methods that both pointcuts match.
</li><li class="listitem">
Union is usually more useful.
</li><li class="listitem">
Pointcuts can be composed using the static methods in the
<span class="emphasis"><em>org.springframework.aop.support.Pointcuts</em></span> class, or using the
<span class="emphasis"><em>ComposablePointcut</em></span> class in the same package. However, using AspectJ pointcut
expressions is usually a simpler approach.
</li></ul></div>

</div>
<div class="section" title="9.2.3&nbsp;AspectJ expression pointcuts"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-aspectj"></a>9.2.3&nbsp;AspectJ expression pointcuts</h3></div></div></div>

<p>Since 2.0, the most important type of pointcut used by Spring is
<code class="literal">org.springframework.aop.aspectj.AspectJExpressionPointcut</code>. This is a pointcut that
uses an AspectJ supplied library to parse an AspectJ pointcut expression string.</p>
<p>See the previous chapter for a discussion of supported AspectJ pointcut primitives.</p>
</div>
<div class="section" title="9.2.4&nbsp;Convenience pointcut implementations"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-impls"></a>9.2.4&nbsp;Convenience pointcut implementations</h3></div></div></div>

<p>Spring provides several convenient pointcut implementations. Some can be used out of the
box; others are intended to be subclassed in application-specific pointcuts.</p>
<div class="section" title="Static pointcuts"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-pointcuts-static"></a>Static pointcuts</h4></div></div></div>

<p>Static pointcuts are based on method and target class, and cannot take into account the
method&#8217;s arguments. Static pointcuts are sufficient - <span class="emphasis"><em>and best</em></span> - for most usages.
It&#8217;s possible for Spring to evaluate a static pointcut only once, when a method is first
invoked: after that, there is no need to evaluate the pointcut again with each method
invocation.</p>
<p>Let&#8217;s consider some static pointcut implementations included with Spring.</p>
<div class="section" title="Regular expression pointcuts"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-regex"></a>Regular expression pointcuts</h5></div></div></div>

<p>One obvious way to specify static pointcuts is regular expressions. Several AOP
frameworks besides Spring make this possible.
<code class="literal">org.springframework.aop.support.JdkRegexpMethodPointcut</code> is a generic regular
expression pointcut, using the regular expression support in JDK 1.4+.</p>
<p>Using the <code class="literal">JdkRegexpMethodPointcut</code> class, you can provide a list of pattern Strings. If
any of these is a match, the pointcut will evaluate to true. (So the result is
effectively the union of these pointcuts.)</p>
<p>The usage is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"settersAndAbsquatulatePointcut"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.JdkRegexpMethodPointcut"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.<span class="strong"><strong>set.</strong></span><span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*absquatulate<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Spring provides a convenience class, <code class="literal">RegexpMethodPointcutAdvisor</code>, that allows us to
also reference an Advice (remember that an Advice can be an interceptor, before advice,
throws advice etc.). Behind the scenes, Spring will use a <code class="literal">JdkRegexpMethodPointcut</code>.
Using <code class="literal">RegexpMethodPointcutAdvisor</code> simplifies wiring, as the one bean encapsulates both
pointcut and advice, as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"settersAndAbsquatulateAdvisor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.RegexpMethodPointcutAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"advice"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"beanNameOfAopAllianceInterceptor"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.<span class="strong"><strong>set.</strong></span><span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*absquatulate<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p><span class="emphasis"><em>RegexpMethodPointcutAdvisor</em></span> can be used with any Advice type.</p>
</div>
<div class="section" title="Attribute-driven pointcuts"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-attribute-driven"></a>Attribute-driven pointcuts</h5></div></div></div>

<p>An important type of static pointcut is a <span class="emphasis"><em>metadata-driven</em></span> pointcut. This uses the
values of metadata attributes: typically, source-level metadata.</p>
</div>
</div>
<div class="section" title="Dynamic pointcuts"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-pointcuts-dynamic"></a>Dynamic pointcuts</h4></div></div></div>

<p>Dynamic pointcuts are costlier to evaluate than static pointcuts. They take into account
method <span class="emphasis"><em>arguments</em></span>, as well as static information. This means that they must be
evaluated with every method invocation; the result cannot be cached, as arguments will
vary.</p>
<p>The main example is the <code class="literal">control flow</code> pointcut.</p>
<div class="section" title="Control flow pointcuts"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-cflow"></a>Control flow pointcuts</h5></div></div></div>

<p>Spring control flow pointcuts are conceptually similar to AspectJ <span class="emphasis"><em>cflow</em></span> pointcuts,
although less powerful. (There is currently no way to specify that a pointcut executes
below a join point matched by another pointcut.) A control flow pointcut matches the
current call stack. For example, it might fire if the join point was invoked by a method
in the <code class="literal">com.mycompany.web</code> package, or by the <code class="literal">SomeCaller</code> class. Control flow pointcuts
are specified using the <code class="literal">org.springframework.aop.support.ControlFlowPointcut</code> class.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Control flow pointcuts are significantly more expensive to evaluate at runtime than even
other dynamic pointcuts. In Java 1.4, the cost is about 5 times that of other dynamic
pointcuts.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section" title="9.2.5&nbsp;Pointcut superclasses"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-superclasses"></a>9.2.5&nbsp;Pointcut superclasses</h3></div></div></div>

<p>Spring provides useful pointcut superclasses to help you to implement your own pointcuts.</p>
<p>Because static pointcuts are most useful, you&#8217;ll probably subclass
StaticMethodMatcherPointcut, as shown below. This requires implementing just one
abstract method (although it&#8217;s possible to override other methods to customize behavior):</p>
<pre class="programlisting"><span class="hl-keyword">class</span> TestStaticPointcut <span class="hl-keyword">extends</span> StaticMethodMatcherPointcut {

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass) {
        <span class="hl-comment">// return true if custom criteria match</span>
    }
}</pre>

<p>There are also superclasses for dynamic pointcuts.</p>
<p>You can use custom pointcuts with any advice type in Spring 1.0 RC2 and above.</p>
</div>
<div class="section" title="9.2.6&nbsp;Custom pointcuts"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-custom"></a>9.2.6&nbsp;Custom pointcuts</h3></div></div></div>

<p>Because pointcuts in Spring AOP are Java classes, rather than language features (as in
AspectJ) it&#8217;s possible to declare custom pointcuts, whether static or dynamic. Custom
pointcuts in Spring can be arbitrarily complex. However, using the AspectJ pointcut
expression language is recommended if possible.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Later versions of Spring may offer support for "semantic pointcuts" as offered by JAC:
for example, "all methods that change instance variables in the target object."</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="9.3&nbsp;Advice API in Spring"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advice"></a>9.3&nbsp;Advice API in Spring</h2></div></div></div>

<p>Let&#8217;s now look at how Spring AOP handles advice.</p>
<div class="section" title="9.3.1&nbsp;Advice lifecycles"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-advice-lifecycle"></a>9.3.1&nbsp;Advice lifecycles</h3></div></div></div>

<p>Each advice is a Spring bean. An advice instance can be shared across all advised
objects, or unique to each advised object. This corresponds to <span class="emphasis"><em>per-class</em></span> or
<span class="emphasis"><em>per-instance</em></span> advice.</p>
<p>Per-class advice is used most often. It is appropriate for generic advice such as
transaction advisors. These do not depend on the state of the proxied object or add new
state; they merely act on the method and arguments.</p>
<p>Per-instance advice is appropriate for introductions, to support mixins. In this case,
the advice adds state to the proxied object.</p>
<p>It&#8217;s possible to use a mix of shared and per-instance advice in the same AOP proxy.</p>
</div>
<div class="section" title="9.3.2&nbsp;Advice types in Spring"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-advice-types"></a>9.3.2&nbsp;Advice types in Spring</h3></div></div></div>

<p>Spring provides several advice types out of the box, and is extensible to support
arbitrary advice types. Let us look at the basic concepts and standard advice types.</p>
<div class="section" title="Interception around advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-around"></a>Interception around advice</h4></div></div></div>

<p>The most fundamental advice type in Spring is <span class="emphasis"><em>interception around advice</em></span>.</p>
<p>Spring is compliant with the AOP Alliance interface for around advice using method
interception. MethodInterceptors implementing around advice should implement the
following interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodInterceptor <span class="hl-keyword">extends</span> Interceptor {

    Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>The <code class="literal">MethodInvocation</code> argument to the <code class="literal">invoke()</code> method exposes the method being
invoked; the target join point; the AOP proxy; and the arguments to the method. The
<code class="literal">invoke()</code> method should return the invocation&#8217;s result: the return value of the join
point.</p>
<p>A simple <code class="literal">MethodInterceptor</code> implementation looks as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DebugInterceptor <span class="hl-keyword">implements</span> MethodInterceptor {

    <span class="hl-keyword">public</span> Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable {
        System.out.println(<span class="hl-string">"Before: invocation=["</span> + invocation + <span class="hl-string">"]"</span>);
        Object rval = invocation.proceed();
        System.out.println(<span class="hl-string">"Invocation returned"</span>);
        <span class="hl-keyword">return</span> rval;
    }
}</pre>

<p>Note the call to the MethodInvocation&#8217;s <code class="literal">proceed()</code> method. This proceeds down the
interceptor chain towards the join point. Most interceptors will invoke this method, and
return its return value. However, a MethodInterceptor, like any around advice, can
return a different value or throw an exception rather than invoke the proceed method.
However, you don&#8217;t want to do this without good reason!</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>MethodInterceptors offer interoperability with other AOP Alliance-compliant AOP
implementations. The other advice types discussed in the remainder of this section
implement common AOP concepts, but in a Spring-specific way. While there is an advantage
in using the most specific advice type, stick with MethodInterceptor around advice if
you are likely to want to run the aspect in another AOP framework. Note that pointcuts
are not currently interoperable between frameworks, and the AOP Alliance does not
currently define pointcut interfaces.</p>
</td></tr></table></div>

</div>
<div class="section" title="Before advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-before"></a>Before advice</h4></div></div></div>

<p>A simpler advice type is a <span class="emphasis"><em>before advice</em></span>. This does not need a <code class="literal">MethodInvocation</code>
object, since it will only be called before entering the method.</p>
<p>The main advantage of a before advice is that there is no need to invoke the <code class="literal">proceed()</code>
method, and therefore no possibility of inadvertently failing to proceed down the
interceptor chain.</p>
<p>The <code class="literal">MethodBeforeAdvice</code> interface is shown below. (Spring&#8217;s API design would allow for
field before advice, although the usual objects apply to field interception and it&#8217;s
unlikely that Spring will ever implement it).</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodBeforeAdvice <span class="hl-keyword">extends</span> BeforeAdvice {

    <span class="hl-keyword">void</span> before(Method m, Object[] args, Object target) <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>Note the return type is <code class="literal">void</code>. Before advice can insert custom behavior before the join
point executes, but cannot change the return value. If a before advice throws an
exception, this will abort further execution of the interceptor chain. The exception
will propagate back up the interceptor chain. If it is unchecked, or on the signature of
the invoked method, it will be passed directly to the client; otherwise it will be
wrapped in an unchecked exception by the AOP proxy.</p>
<p>An example of a before advice in Spring, which counts all method invocations:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingBeforeAdvice <span class="hl-keyword">implements</span> MethodBeforeAdvice {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> before(Method m, Object[] args, Object target) <span class="hl-keyword">throws</span> Throwable {
        ++count;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> count;
    }
}</pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Before advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section" title="Throws advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-throws"></a>Throws advice</h4></div></div></div>

<p><span class="emphasis"><em>Throws advice</em></span> is invoked after the return of the join point if the join point threw
an exception. Spring offers typed throws advice. Note that this means that the
<code class="literal">org.springframework.aop.ThrowsAdvice</code> interface does not contain any methods: It is a
tag interface identifying that the given object implements one or more typed throws
advice methods. These should be in the form of:</p>
<pre class="programlisting">afterThrowing([Method, args, target], subclassOfThrowable)</pre>

<p>Only the last argument is required. The method signatures may have either one or four
arguments, depending on whether the advice method is interested in the method and
arguments. The following classes are examples of throws advice.</p>
<p>The advice below is invoked if a <code class="literal">RemoteException</code> is thrown (including subclasses):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RemoteThrowsAdvice <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(RemoteException ex) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// Do something with remote exception</span>
    }
}</pre>

<p>The following advice is invoked if a <code class="literal">ServletException</code> is thrown. Unlike the above
advice, it declares 4 arguments, so that it has access to the invoked method, method
arguments and target object:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ServletThrowsAdviceWithArguments <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(Method m, Object[] args, Object target, ServletException ex) {
        <span class="hl-comment">// Do something with all arguments</span>
    }
}</pre>

<p>The final example illustrates how these two methods could be used in a single class,
which handles both <code class="literal">RemoteException</code> and <code class="literal">ServletException</code>. Any number of throws advice
methods can be combined in a single class.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> CombinedThrowsAdvice <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(RemoteException ex) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// Do something with remote exception</span>
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(Method m, Object[] args, Object target, ServletException ex) {
        <span class="hl-comment">// Do something with all arguments</span>
    }
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If a throws-advice method throws an exception itself, it will override the
original exception (i.e. change the exception thrown to the user). The overriding
exception will typically be a RuntimeException; this is compatible with any method
signature. However, if a throws-advice method throws a checked exception, it will have
to match the declared exceptions of the target method and is hence to some degree
coupled to specific target method signatures. <span class="emphasis"><em>Do not throw an undeclared checked
exception that is incompatible with the target method&#8217;s signature!</em></span></p>
</td></tr></table></div>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Throws advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section" title="After Returning advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-after-returning"></a>After Returning advice</h4></div></div></div>

<p>An after returning advice in Spring must implement the
<span class="emphasis"><em>org.springframework.aop.AfterReturningAdvice</em></span> interface, shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AfterReturningAdvice <span class="hl-keyword">extends</span> Advice {

    <span class="hl-keyword">void</span> afterReturning(Object returnValue, Method m, Object[] args, Object target)
            <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>An after returning advice has access to the return value (which it cannot modify),
invoked method, methods arguments and target.</p>
<p>The following after returning advice counts all successful method invocations that have
not thrown exceptions:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingAfterReturningAdvice <span class="hl-keyword">implements</span> AfterReturningAdvice {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterReturning(Object returnValue, Method m, Object[] args, Object target)
            <span class="hl-keyword">throws</span> Throwable {
        ++count;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> count;
    }
}</pre>

<p>This advice doesn&#8217;t change the execution path. If it throws an exception, this will be
thrown up the interceptor chain instead of the return value.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>After returning advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section" title="Introduction advice"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-introduction"></a>Introduction advice</h4></div></div></div>

<p>Spring treats introduction advice as a special kind of interception advice.</p>
<p>Introduction requires an <code class="literal">IntroductionAdvisor</code>, and an <code class="literal">IntroductionInterceptor</code>,
implementing the following interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionInterceptor <span class="hl-keyword">extends</span> MethodInterceptor {

    <span class="hl-keyword">boolean</span> implementsInterface(Class intf);
}</pre>

<p>The <code class="literal">invoke()</code> method inherited from the AOP Alliance <code class="literal">MethodInterceptor</code> interface must
implement the introduction: that is, if the invoked method is on an introduced
interface, the introduction interceptor is responsible for handling the method call - it
cannot invoke <code class="literal">proceed()</code>.</p>
<p>Introduction advice cannot be used with any pointcut, as it applies only at class,
rather than method, level. You can only use introduction advice with the
<code class="literal">IntroductionAdvisor</code>, which has the following methods:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionAdvisor <span class="hl-keyword">extends</span> Advisor, IntroductionInfo {

    ClassFilter getClassFilter();

    <span class="hl-keyword">void</span> validateInterfaces() <span class="hl-keyword">throws</span> IllegalArgumentException;
}

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionInfo {

    Class[] getInterfaces();
}</pre>

<p>There is no <code class="literal">MethodMatcher</code>, and hence no <code class="literal">Pointcut</code>, associated with introduction
advice. Only class filtering is logical.</p>
<p>The <code class="literal">getInterfaces()</code> method returns the interfaces introduced by this advisor.</p>
<p>The <code class="literal">validateInterfaces()</code> method is used internally to see whether or not the
introduced interfaces can be implemented by the configured <code class="literal">IntroductionInterceptor</code>.</p>
<p>Let&#8217;s look at a simple example from the Spring test suite. Let&#8217;s suppose we want to
introduce the following interface to one or more objects:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Lockable {
    <span class="hl-keyword">void</span> lock();
    <span class="hl-keyword">void</span> unlock();
    <span class="hl-keyword">boolean</span> locked();
}</pre>

<p>This illustrates a <span class="emphasis"><em>mixin</em></span>. We want to be able to cast advised objects to Lockable,
whatever their type, and call lock and unlock methods. If we call the lock() method, we
want all setter methods to throw a <code class="literal">LockedException</code>. Thus we can add an aspect that
provides the ability to make objects immutable, without them having any knowledge of it:
a good example of AOP.</p>
<p>Firstly, we&#8217;ll need an <code class="literal">IntroductionInterceptor</code> that does the heavy lifting. In this
case, we extend the <code class="literal">org.springframework.aop.support.DelegatingIntroductionInterceptor</code>
convenience class. We could implement IntroductionInterceptor directly, but using
<code class="literal">DelegatingIntroductionInterceptor</code> is best for most cases.</p>
<p>The <code class="literal">DelegatingIntroductionInterceptor</code> is designed to delegate an introduction to an
actual implementation of the introduced interface(s), concealing the use of interception
to do so. The delegate can be set to any object using a constructor argument; the
default delegate (when the no-arg constructor is used) is this. Thus in the example
below, the delegate is the <code class="literal">LockMixin</code> subclass of <code class="literal">DelegatingIntroductionInterceptor</code>.
Given a delegate (by default itself), a <code class="literal">DelegatingIntroductionInterceptor</code> instance
looks for all interfaces implemented by the delegate (other than
IntroductionInterceptor), and will support introductions against any of them. It&#8217;s
possible for subclasses such as <code class="literal">LockMixin</code> to call the <code class="literal">suppressInterface(Class intf)</code>
method to suppress interfaces that should not be exposed. However, no matter how many
interfaces an <code class="literal">IntroductionInterceptor</code> is prepared to support, the
<code class="literal">IntroductionAdvisor</code> used will control which interfaces are actually exposed. An
introduced interface will conceal any implementation of the same interface by the target.</p>
<p>Thus <code class="literal">LockMixin</code> extends <code class="literal">DelegatingIntroductionInterceptor</code> and implements <code class="literal">Lockable</code>
itself. The superclass automatically picks up that Lockable can be supported for
introduction, so we don&#8217;t need to specify that. We could introduce any number of
interfaces in this way.</p>
<p>Note the use of the <code class="literal">locked</code> instance variable. This effectively adds additional state
to that held in the target object.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LockMixin <span class="hl-keyword">extends</span> DelegatingIntroductionInterceptor <span class="hl-keyword">implements</span> Lockable {

    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> locked;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> lock() {
        <span class="hl-keyword">this</span>.locked = true;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> unlock() {
        <span class="hl-keyword">this</span>.locked = false;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> locked() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.locked;
    }

    <span class="hl-keyword">public</span> Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-keyword">if</span> (locked() &amp;&amp; invocation.getMethod().getName().indexOf(<span class="hl-string">"set"</span>) == <span class="hl-number">0</span>) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> LockedException();
        }
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.invoke(invocation);
    }

}</pre>

<p>Often it isn&#8217;t necessary to override the <code class="literal">invoke()</code> method: the
<code class="literal">DelegatingIntroductionInterceptor</code> implementation - which calls the delegate method if
the method is introduced, otherwise proceeds towards the join point - is usually
sufficient. In the present case, we need to add a check: no setter method can be invoked
if in locked mode.</p>
<p>The introduction advisor required is simple. All it needs to do is hold a distinct
<code class="literal">LockMixin</code> instance, and specify the introduced interfaces - in this case, just
<code class="literal">Lockable</code>. A more complex example might take a reference to the introduction
interceptor (which would be defined as a prototype): in this case, there&#8217;s no
configuration relevant for a <code class="literal">LockMixin</code>, so we simply create it using <code class="literal">new</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LockMixinAdvisor <span class="hl-keyword">extends</span> DefaultIntroductionAdvisor {

    <span class="hl-keyword">public</span> LockMixinAdvisor() {
        <span class="hl-keyword">super</span>(<span class="hl-keyword">new</span> LockMixin(), Lockable.<span class="hl-keyword">class</span>);
    }
}</pre>

<p>We can apply this advisor very simply: it requires no configuration. (However, it <span class="emphasis"><em>is</em></span>
necessary: It&#8217;s impossible to use an <code class="literal">IntroductionInterceptor</code> without an
<span class="emphasis"><em>IntroductionAdvisor</em></span>.) As usual with introductions, the advisor must be per-instance,
as it is stateful. We need a different instance of <code class="literal">LockMixinAdvisor</code>, and hence
<code class="literal">LockMixin</code>, for each advised object. The advisor comprises part of the advised object&#8217;s
state.</p>
<p>We can apply this advisor programmatically, using the <code class="literal">Advised.addAdvisor()</code> method, or
(the recommended way) in XML configuration, like any other advisor. All proxy creation
choices discussed below, including "auto proxy creators," correctly handle introductions
and stateful mixins.</p>
</div>
</div>
</div>
<div class="section" title="9.4&nbsp;Advisor API in Spring"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advisor"></a>9.4&nbsp;Advisor API in Spring</h2></div></div></div>

<p>In Spring, an Advisor is an aspect that contains just a single advice object associated
with a pointcut expression.</p>
<p>Apart from the special case of introductions, any advisor can be used with any advice.
<code class="literal">org.springframework.aop.support.DefaultPointcutAdvisor</code> is the most commonly used
advisor class. For example, it can be used with a <code class="literal">MethodInterceptor</code>, <code class="literal">BeforeAdvice</code> or
<code class="literal">ThrowsAdvice</code>.</p>
<p>It is possible to mix advisor and advice types in Spring in the same AOP proxy. For
example, you could use a interception around advice, throws advice and before advice in
one proxy configuration: Spring will automatically create the necessary interceptor
chain.</p>
</div>
<div class="section" title="9.5&nbsp;Using the ProxyFactoryBean to create AOP proxies"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-pfb"></a>9.5&nbsp;Using the ProxyFactoryBean to create AOP proxies</h2></div></div></div>

<p>If you&#8217;re using the Spring IoC container (an ApplicationContext or BeanFactory) for your
business objects - and you should be! - you will want to use one of Spring&#8217;s AOP
FactoryBeans. (Remember that a factory bean introduces a layer of indirection, enabling
it to create objects of a different type.)</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Spring AOP support also uses factory beans under the covers.</p>
</td></tr></table></div>

<p>The basic way to create an AOP proxy in Spring is to use the
<span class="emphasis"><em>org.springframework.aop.framework.ProxyFactoryBean</em></span>. This gives complete control over
the pointcuts and advice that will apply, and their ordering. However, there are simpler
options that are preferable if you don&#8217;t need such control.</p>
<div class="section" title="9.5.1&nbsp;Basics"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-1"></a>9.5.1&nbsp;Basics</h3></div></div></div>

<p>The <code class="literal">ProxyFactoryBean</code>, like other Spring <code class="literal">FactoryBean</code> implementations, introduces a
level of indirection. If you define a <code class="literal">ProxyFactoryBean</code> with name <code class="literal">foo</code>, what objects
referencing <code class="literal">foo</code> see is not the <code class="literal">ProxyFactoryBean</code> instance itself, but an object
created by the <code class="literal">ProxyFactoryBean</code>'s implementation of the <code class="literal">getObject()</code> method. This
method will create an AOP proxy wrapping a target object.</p>
<p>One of the most important benefits of using a <code class="literal">ProxyFactoryBean</code> or another IoC-aware
class to create AOP proxies, is that it means that advices and pointcuts can also be
managed by IoC. This is a powerful feature, enabling certain approaches that are hard to
achieve with other AOP frameworks. For example, an advice may itself reference
application objects (besides the target, which should be available in any AOP
framework), benefiting from all the pluggability provided by Dependency Injection.</p>
</div>
<div class="section" title="9.5.2&nbsp;JavaBean properties"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-2"></a>9.5.2&nbsp;JavaBean properties</h3></div></div></div>

<p>In common with most <code class="literal">FactoryBean</code> implementations provided with Spring, the
<code class="literal">ProxyFactoryBean</code> class is itself a JavaBean. Its properties are used to:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Specify the target you want to proxy.
</li><li class="listitem">
Specify whether to use CGLIB (see below and also <a class="xref" href="#aop-pfb-proxy-types" title="9.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;9.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li></ul></div>

<p>Some key properties are inherited from <code class="literal">org.springframework.aop.framework.ProxyConfig</code>
(the superclass for all AOP proxy factories in Spring). These key properties include:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">proxyTargetClass</code>: <code class="literal">true</code> if the target class is to be proxied, rather than the
target class' interfaces. If this property value is set to <code class="literal">true</code>, then CGLIB proxies
will be created (but see also <a class="xref" href="#aop-pfb-proxy-types" title="9.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;9.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li><li class="listitem">
<code class="literal">optimize</code>: controls whether or not aggressive optimizations are applied to proxies
<span class="emphasis"><em>created via CGLIB</em></span>. One should not blithely use this setting unless one fully
understands how the relevant AOP proxy handles optimization. This is currently used
only for CGLIB proxies; it has no effect with JDK dynamic proxies.
</li><li class="listitem">
<code class="literal">frozen</code>: if a proxy configuration is <code class="literal">frozen</code>, then changes to the configuration are
no longer allowed. This is useful both as a slight optimization and for those cases
when you don&#8217;t want callers to be able to manipulate the proxy (via the <code class="literal">Advised</code>
interface) after the proxy has been created. The default value of this property is
<code class="literal">false</code>, so changes such as adding additional advice are allowed.
</li><li class="listitem">
<code class="literal">exposeProxy</code>: determines whether or not the current proxy should be exposed in a
<code class="literal">ThreadLocal</code> so that it can be accessed by the target. If a target needs to obtain
the proxy and the <code class="literal">exposeProxy</code> property is set to <code class="literal">true</code>, the target can use the
<code class="literal">AopContext.currentProxy()</code> method.
</li></ul></div>

<p>Other properties specific to <code class="literal">ProxyFactoryBean</code> include:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">proxyInterfaces</code>: array of String interface names. If this isn&#8217;t supplied, a CGLIB
proxy for the target class will be used (but see also <a class="xref" href="#aop-pfb-proxy-types" title="9.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;9.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li><li class="listitem">
<code class="literal">interceptorNames</code>: String array of <code class="literal">Advisor</code>, interceptor or other advice names to
apply. Ordering is significant, on a first come-first served basis. That is to say
that the first interceptor in the list will be the first to be able to intercept the
invocation.
</li></ul></div>

<p>The names are bean names in the current factory, including bean names from ancestor
factories. You can&#8217;t mention bean references here since doing so would result in the
<code class="literal">ProxyFactoryBean</code> ignoring the singleton setting of the advice.</p>
<p>You can append an interceptor name with an asterisk ( <code class="literal">*</code>). This will result in the
application of all advisor beans with names starting with the part before the asterisk
to be applied. An example of using this feature can be found in <a class="xref" href="#aop-global-advisors" title="9.5.6&nbsp;Using global advisors">Section&nbsp;9.5.6, &#8220;Using <span class="emphasis"><em>global</em></span> advisors&#8221;</a>.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
singleton: whether or not the factory should return a single object, no matter how
often the <code class="literal">getObject()</code> method is called. Several <code class="literal">FactoryBean</code> implementations offer
such a method. The default value is <code class="literal">true</code>. If you want to use stateful advice - for
example, for stateful mixins - use prototype advices along with a singleton value of
<code class="literal">false</code>.
</li></ul></div>

</div>
<div class="section" title="9.5.3&nbsp;JDK- and CGLIB-based proxies"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-proxy-types"></a>9.5.3&nbsp;JDK- and CGLIB-based proxies</h3></div></div></div>

<p>This section serves as the definitive documentation on how the <code class="literal">ProxyFactoryBean</code>
chooses to create one of either a JDK- and CGLIB-based proxy for a particular target
object (that is to be proxied).</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The behavior of the <code class="literal">ProxyFactoryBean</code> with regard to creating JDK- or CGLIB-based
proxies changed between versions 1.2.x and 2.0 of Spring. The <code class="literal">ProxyFactoryBean</code> now
exhibits similar semantics with regard to auto-detecting interfaces as those of the
<code class="literal">TransactionProxyFactoryBean</code> class.</p>
</td></tr></table></div>

<p>If the class of a target object that is to be proxied (hereafter simply referred to as
the target class) doesn&#8217;t implement any interfaces, then a CGLIB-based proxy will be
created. This is the easiest scenario, because JDK proxies are interface based, and no
interfaces means JDK proxying isn&#8217;t even possible. One simply plugs in the target bean,
and specifies the list of interceptors via the <code class="literal">interceptorNames</code> property. Note that a
CGLIB-based proxy will be created even if the <code class="literal">proxyTargetClass</code> property of the
<code class="literal">ProxyFactoryBean</code> has been set to <code class="literal">false</code>. (Obviously this makes no sense, and is best
removed from the bean definition because it is at best redundant, and at worst
confusing.)</p>
<p>If the target class implements one (or more) interfaces, then the type of proxy that is
created depends on the configuration of the <code class="literal">ProxyFactoryBean</code>.</p>
<p>If the <code class="literal">proxyTargetClass</code> property of the <code class="literal">ProxyFactoryBean</code> has been set to <code class="literal">true</code>,
then a CGLIB-based proxy will be created. This makes sense, and is in keeping with the
principle of least surprise. Even if the <code class="literal">proxyInterfaces</code> property of the
<code class="literal">ProxyFactoryBean</code> has been set to one or more fully qualified interface names, the fact
that the <code class="literal">proxyTargetClass</code> property is set to <code class="literal">true</code> <span class="emphasis"><em>will</em></span> cause CGLIB-based
proxying to be in effect.</p>
<p>If the <code class="literal">proxyInterfaces</code> property of the <code class="literal">ProxyFactoryBean</code> has been set to one or more
fully qualified interface names, then a JDK-based proxy will be created. The created
proxy will implement all of the interfaces that were specified in the <code class="literal">proxyInterfaces</code>
property; if the target class happens to implement a whole lot more interfaces than
those specified in the <code class="literal">proxyInterfaces</code> property, that is all well and good but those
additional interfaces will not be implemented by the returned proxy.</p>
<p>If the <code class="literal">proxyInterfaces</code> property of the <code class="literal">ProxyFactoryBean</code> has <span class="emphasis"><em>not</em></span> been set, but
the target class <span class="emphasis"><em>does implement one (or more)</em></span> interfaces, then the
<code class="literal">ProxyFactoryBean</code> will auto-detect the fact that the target class does actually
implement at least one interface, and a JDK-based proxy will be created. The interfaces
that are actually proxied will be <span class="emphasis"><em>all</em></span> of the interfaces that the target class
implements; in effect, this is the same as simply supplying a list of each and every
interface that the target class implements to the <code class="literal">proxyInterfaces</code> property. However,
it is significantly less work, and less prone to typos.</p>
</div>
<div class="section" title="9.5.4&nbsp;Proxying interfaces"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-proxying-intf"></a>9.5.4&nbsp;Proxying interfaces</h3></div></div></div>

<p>Let&#8217;s look at a simple example of <code class="literal">ProxyFactoryBean</code> in action. This example involves:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
A <span class="emphasis"><em>target bean</em></span> that will be proxied. This is the "personTarget" bean definition in
the example below.
</li><li class="listitem">
An Advisor and an Interceptor used to provide advice.
</li><li class="listitem">
An AOP proxy bean definition specifying the target object (the personTarget bean) and
the interfaces to proxy, along with the advices to apply.
</li></ul></div>

<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"personTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Tony"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"51"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Custom string property value"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"debugInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterfaces"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.mycompany.Person"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"personTarget"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myAdvisor<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>debugInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the <code class="literal">interceptorNames</code> property takes a list of String: the bean names of the
interceptor or advisors in the current factory. Advisors, interceptors, before, after
returning and throws advice objects can be used. The ordering of advisors is significant.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You might be wondering why the list doesn&#8217;t hold bean references. The reason for this is
that if the ProxyFactoryBean&#8217;s singleton property is set to false, it must be able to
return independent proxy instances. If any of the advisors is itself a prototype, an
independent instance would need to be returned, so it&#8217;s necessary to be able to obtain
an instance of the prototype from the factory; holding a reference isn&#8217;t sufficient.</p>
</td></tr></table></div>

<p>The "person" bean definition above can be used in place of a Person implementation, as
follows:</p>
<pre class="programlisting">Person person = (Person) factory.getBean(<span class="hl-string">"person"</span>);</pre>

<p>Other beans in the same IoC context can express a strongly typed dependency on it, as
with an ordinary Java object:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"personUser"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonUser"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"person"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"person"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">PersonUser</code> class in this example would expose a property of type Person. As far as
it&#8217;s concerned, the AOP proxy can be used transparently in place of a "real" person
implementation. However, its class would be a dynamic proxy class. It would be possible
to cast it to the <code class="literal">Advised</code> interface (discussed below).</p>
<p>It&#8217;s possible to conceal the distinction between target and proxy using an anonymous
<span class="emphasis"><em>inner bean</em></span>, as follows. Only the <code class="literal">ProxyFactoryBean</code> definition is different; the
advice is included only for completeness:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Custom string property value"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"debugInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterfaces"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.mycompany.Person"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-comment">&lt;!-- Use inner bean, not local reference to target --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonImpl"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Tony"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"51"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myAdvisor<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>debugInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This has the advantage that there&#8217;s only one object of type <code class="literal">Person</code>: useful if we want
to prevent users of the application context from obtaining a reference to the un-advised
object, or need to avoid any ambiguity with Spring IoC <span class="emphasis"><em>autowiring</em></span>. There&#8217;s also
arguably an advantage in that the ProxyFactoryBean definition is self-contained.
However, there are times when being able to obtain the un-advised target from the
factory might actually be an <span class="emphasis"><em>advantage</em></span>: for example, in certain test scenarios.</p>
</div>
<div class="section" title="9.5.5&nbsp;Proxying classes"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-proxying-class"></a>9.5.5&nbsp;Proxying classes</h3></div></div></div>

<p>What if you need to proxy a class, rather than one or more interfaces?</p>
<p>Imagine that in our example above, there was no <code class="literal">Person</code> interface: we needed to advise
a class called <code class="literal">Person</code> that didn&#8217;t implement any business interface. In this case, you
can configure Spring to use CGLIB proxying, rather than dynamic proxies. Simply set the
<code class="literal">proxyTargetClass</code> property on the ProxyFactoryBean above to true. While it&#8217;s best to
program to interfaces, rather than classes, the ability to advise classes that don&#8217;t
implement interfaces can be useful when working with legacy code. (In general, Spring
isn&#8217;t prescriptive. While it makes it easy to apply good practices, it avoids forcing a
particular approach.)</p>
<p>If you want to, you can force the use of CGLIB in any case, even if you do have
interfaces.</p>
<p>CGLIB proxying works by generating a subclass of the target class at runtime. Spring
configures this generated subclass to delegate method calls to the original target: the
subclass is used to implement the <span class="emphasis"><em>Decorator</em></span> pattern, weaving in the advice.</p>
<p>CGLIB proxying should generally be transparent to users. However, there are some issues
to consider:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">Final</code> methods can&#8217;t be advised, as they can&#8217;t be overridden.
</li><li class="listitem">
There is no need to add CGLIB to your classpath. As of Spring 3.2, CGLIB is repackaged
and included in the spring-core JAR. In other words, CGLIB-based AOP will work "out of
the box" just as do JDK dynamic proxies.
</li></ul></div>

<p>There&#8217;s little performance difference between CGLIB proxying and dynamic proxies. As of
Spring 1.0, dynamic proxies are slightly faster. However, this may change in the future.
Performance should not be a decisive consideration in this case.</p>
</div>
<div class="section" title="9.5.6&nbsp;Using global advisors"><div class="titlepage"><div><div><h3 class="title"><a name="aop-global-advisors"></a>9.5.6&nbsp;Using <span class="emphasis"><em>global</em></span> advisors</h3></div></div></div>

<p>By appending an asterisk to an interceptor name, all advisors with bean names matching
the part before the asterisk, will be added to the advisor chain. This can come in handy
if you need to add a standard set of <span class="emphasis"><em>global</em></span> advisors:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>global*<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"global_debug"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"global_performance"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.PerformanceMonitorInterceptor"</span><span class="hl-tag">/&gt;</span></pre>

</div>
</div>
<div class="section" title="9.6&nbsp;Concise proxy definitions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-concise-proxy"></a>9.6&nbsp;Concise proxy definitions</h2></div></div></div>

<p>Especially when defining transactional proxies, you may end up with many similar proxy
definitions. The use of parent and child bean definitions, along with inner bean
definitions, can result in much cleaner and more concise proxy definitions.</p>
<p>First a parent, <span class="emphasis"><em>template</em></span>, bean definition is created for the proxy:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txProxyTemplate"</span> <span class="hl-attribute">abstract</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This will never be instantiated itself, so may actually be incomplete. Then each proxy
which needs to be created is just a child bean definition, which wraps the target of the
proxy as an inner bean definition, since the target will never be used on its own anyway.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myService"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"txProxyTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MyServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>It is of course possible to override properties from the parent template, such as in
this case, the transaction propagation settings:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySpecialService"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"txProxyTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MySpecialServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"get*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"find*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"load*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"store*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that in the example above, we have explicitly marked the parent bean definition as
<span class="emphasis"><em>abstract</em></span> by using the <span class="emphasis"><em>abstract</em></span> attribute, as described
<a class="link" href="#beans-child-bean-definitions" title="4.7&nbsp;Bean definition inheritance">previously</a>, so that it may not actually ever be
instantiated. Application contexts (but not simple bean factories) will by default
pre-instantiate all singletons. It is therefore important (at least for singleton beans)
that if you have a (parent) bean definition which you intend to use only as a template,
and this definition specifies a class, you must make sure to set the <span class="emphasis"><em>abstract</em></span>
attribute to <span class="emphasis"><em>true</em></span>, otherwise the application context will actually try to
pre-instantiate it.</p>
</div>
<div class="section" title="9.7&nbsp;Creating AOP proxies programmatically with the ProxyFactory"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-prog"></a>9.7&nbsp;Creating AOP proxies programmatically with the ProxyFactory</h2></div></div></div>

<p>It&#8217;s easy to create AOP proxies programmatically using Spring. This enables you to use
Spring AOP without dependency on Spring IoC.</p>
<p>The following listing shows creation of a proxy for a target object, with one
interceptor and one advisor. The interfaces implemented by the target object will
automatically be proxied:</p>
<pre class="programlisting">ProxyFactory factory = <span class="hl-keyword">new</span> ProxyFactory(myBusinessInterfaceImpl);
factory.addAdvice(myMethodInterceptor);
factory.addAdvisor(myAdvisor);
MyBusinessInterface tb = (MyBusinessInterface) factory.getProxy();</pre>

<p>The first step is to construct an object of type
<code class="literal">org.springframework.aop.framework.ProxyFactory</code>. You can create this with a target
object, as in the above example, or specify the interfaces to be proxied in an alternate
constructor.</p>
<p>You can add advices (with interceptors as a specialized kind of advice) and/or advisors,
and manipulate them for the life of the ProxyFactory. If you add an
IntroductionInterceptionAroundAdvisor, you can cause the proxy to implement additional
interfaces.</p>
<p>There are also convenience methods on ProxyFactory (inherited from <code class="literal">AdvisedSupport</code>)
which allow you to add other advice types such as before and throws advice.
AdvisedSupport is the superclass of both ProxyFactory and ProxyFactoryBean.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Integrating AOP proxy creation with the IoC framework is best practice in most
applications. We recommend that you externalize configuration from Java code with AOP,
as in general.</p>
</td></tr></table></div>

</div>
<div class="section" title="9.8&nbsp;Manipulating advised objects"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advised"></a>9.8&nbsp;Manipulating advised objects</h2></div></div></div>

<p>However you create AOP proxies, you can manipulate them using the
<code class="literal">org.springframework.aop.framework.Advised</code> interface. Any AOP proxy can be cast to this
interface, whichever other interfaces it implements. This interface includes the
following methods:</p>
<pre class="programlisting">Advisor[] getAdvisors();

<span class="hl-keyword">void</span> addAdvice(Advice advice) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvice(<span class="hl-keyword">int</span> pos, Advice advice) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvisor(Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvisor(<span class="hl-keyword">int</span> pos, Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">int</span> indexOf(Advisor advisor);

<span class="hl-keyword">boolean</span> removeAdvisor(Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> removeAdvisor(<span class="hl-keyword">int</span> index) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">boolean</span> replaceAdvisor(Advisor a, Advisor b) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">boolean</span> isFrozen();</pre>

<p>The <code class="literal">getAdvisors()</code> method will return an Advisor for every advisor, interceptor or
other advice type that has been added to the factory. If you added an Advisor, the
returned advisor at this index will be the object that you added. If you added an
interceptor or other advice type, Spring will have wrapped this in an advisor with a
pointcut that always returns true. Thus if you added a <code class="literal">MethodInterceptor</code>, the advisor
returned for this index will be an <code class="literal">DefaultPointcutAdvisor</code> returning your
<code class="literal">MethodInterceptor</code> and a pointcut that matches all classes and methods.</p>
<p>The <code class="literal">addAdvisor()</code> methods can be used to add any Advisor. Usually the advisor holding
pointcut and advice will be the generic <code class="literal">DefaultPointcutAdvisor</code>, which can be used with
any advice or pointcut (but not for introductions).</p>
<p>By default, it&#8217;s possible to add or remove advisors or interceptors even once a proxy
has been created. The only restriction is that it&#8217;s impossible to add or remove an
introduction advisor, as existing proxies from the factory will not show the interface
change. (You can obtain a new proxy from the factory to avoid this problem.)</p>
<p>A simple example of casting an AOP proxy to the <code class="literal">Advised</code> interface and examining and
manipulating its advice:</p>
<pre class="programlisting">Advised advised = (Advised) myObject;
Advisor[] advisors = advised.getAdvisors();
<span class="hl-keyword">int</span> oldAdvisorCount = advisors.length;
System.out.println(oldAdvisorCount + <span class="hl-string">" advisors"</span>);

<span class="hl-comment">// Add an advice like an interceptor without a pointcut</span>
<span class="hl-comment">// Will match all proxied methods</span>
<span class="hl-comment">// Can use for interceptors, before, after returning or throws advice</span>
advised.addAdvice(<span class="hl-keyword">new</span> DebugInterceptor());

<span class="hl-comment">// Add selective advice using a pointcut</span>
advised.addAdvisor(<span class="hl-keyword">new</span> DefaultPointcutAdvisor(mySpecialPointcut, myAdvice));

assertEquals(<span class="hl-string">"Added two advisors"</span>, oldAdvisorCount + <span class="hl-number">2</span>, advised.getAdvisors().length);</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It&#8217;s questionable whether it&#8217;s advisable (no pun intended) to modify advice on a
business object in production, although there are no doubt legitimate usage cases.
However, it can be very useful in development: for example, in tests. I have sometimes
found it very useful to be able to add test code in the form of an interceptor or other
advice, getting inside a method invocation I want to test. (For example, the advice can
get inside a transaction created for that method: for example, to run SQL to check that
a database was correctly updated, before marking the transaction for roll back.)</p>
</td></tr></table></div>

<p>Depending on how you created the proxy, you can usually set a <code class="literal">frozen</code> flag, in which
case the <code class="literal">Advised</code> <code class="literal">isFrozen()</code> method will return true, and any attempts to modify
advice through addition or removal will result in an <code class="literal">AopConfigException</code>. The ability
to freeze the state of an advised object is useful in some cases, for example, to
prevent calling code removing a security interceptor. It may also be used in Spring 1.1
to allow aggressive optimization if runtime advice modification is known not to be
required.</p>
</div>
<div class="section" title="9.9&nbsp;Using the &#34;auto-proxy&#34; facility"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-autoproxy"></a>9.9&nbsp;Using the "auto-proxy" facility</h2></div></div></div>

<p>So far we&#8217;ve considered explicit creation of AOP proxies using a <code class="literal">ProxyFactoryBean</code> or
similar factory bean.</p>
<p>Spring also allows us to use "auto-proxy" bean definitions, which can automatically
proxy selected bean definitions. This is built on Spring "bean post processor"
infrastructure, which enables modification of any bean definition as the container loads.</p>
<p>In this model, you set up some special bean definitions in your XML bean definition file
to configure the auto proxy infrastructure. This allows you just to declare the targets
eligible for auto-proxying: you don&#8217;t need to use <code class="literal">ProxyFactoryBean</code>.</p>
<p>There are two ways to do this:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Using an auto-proxy creator that refers to specific beans in the current context.
</li><li class="listitem">
A special case of auto-proxy creation that deserves to be considered separately;
auto-proxy creation driven by source-level metadata attributes.
</li></ul></div>

<div class="section" title="9.9.1&nbsp;Autoproxy bean definitions"><div class="titlepage"><div><div><h3 class="title"><a name="aop-autoproxy-choices"></a>9.9.1&nbsp;Autoproxy bean definitions</h3></div></div></div>

<p>The <code class="literal">org.springframework.aop.framework.autoproxy</code> package provides the following
standard auto-proxy creators.</p>
<div class="section" title="BeanNameAutoProxyCreator"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy"></a>BeanNameAutoProxyCreator</h4></div></div></div>

<p>The <code class="literal">BeanNameAutoProxyCreator</code> class is a <code class="literal">BeanPostProcessor</code> that automatically creates
AOP proxies for beans with names matching literal values or wildcards.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beanNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdk*,onlyJdk"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>As with <code class="literal">ProxyFactoryBean</code>, there is an <code class="literal">interceptorNames</code> property rather than a list
of interceptors, to allow correct behavior for prototype advisors. Named "interceptors"
can be advisors or any advice type.</p>
<p>As with auto proxying in general, the main point of using <code class="literal">BeanNameAutoProxyCreator</code> is
to apply the same configuration consistently to multiple objects, with minimal volume of
configuration. It is a popular choice for applying declarative transactions to multiple
objects.</p>
<p>Bean definitions whose names match, such as "jdkMyBean" and "onlyJdk" in the above
example, are plain old bean definitions with the target class. An AOP proxy will be
created automatically by the <code class="literal">BeanNameAutoProxyCreator</code>. The same advice will be applied
to all matching beans. Note that if advisors are used (rather than the interceptor in
the above example), the pointcuts may apply differently to different beans.</p>
</div>
<div class="section" title="DefaultAdvisorAutoProxyCreator"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy-default"></a>DefaultAdvisorAutoProxyCreator</h4></div></div></div>

<p>A more general and extremely powerful auto proxy creator is
<code class="literal">DefaultAdvisorAutoProxyCreator</code>. This will automagically apply eligible advisors in the
current context, without the need to include specific bean names in the auto-proxy
advisor&#8217;s bean definition. It offers the same merit of consistent configuration and
avoidance of duplication as <code class="literal">BeanNameAutoProxyCreator</code>.</p>
<p>Using this mechanism involves:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Specifying a <code class="literal">DefaultAdvisorAutoProxyCreator</code> bean definition.
</li><li class="listitem">
Specifying any number of Advisors in the same or related contexts. Note that these
<span class="emphasis"><em>must</em></span> be Advisors, not just interceptors or other advices. This is necessary
because there must be a pointcut to evaluate, to check the eligibility of each advice
to candidate bean definitions.
</li></ul></div>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> will automatically evaluate the pointcut contained
in each advisor, to see what (if any) advice it should apply to each business object
(such as "businessObject1" and "businessObject2" in the example).</p>
<p>This means that any number of advisors can be applied automatically to each business
object. If no pointcut in any of the advisors matches any method in a business object,
the object will not be proxied. As bean definitions are added for new business objects,
they will automatically be proxied if necessary.</p>
<p>Autoproxying in general has the advantage of making it impossible for callers or
dependencies to obtain an un-advised object. Calling getBean("businessObject1") on this
ApplicationContext will return an AOP proxy, not the target business object. (The "inner
bean" idiom shown earlier also offers this benefit.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject1"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.BusinessObject1"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- Properties omitted --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject2"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.BusinessObject2"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> is very useful if you want to apply the same advice
consistently to many business objects. Once the infrastructure definitions are in place,
you can simply add new business objects without including specific proxy configuration.
You can also drop in additional aspects very easily - for example, tracing or
performance monitoring aspects - with minimal change to configuration.</p>
<p>The DefaultAdvisorAutoProxyCreator offers support for filtering (using a naming
convention so that only certain advisors are evaluated, allowing use of multiple,
differently configured, AdvisorAutoProxyCreators in the same factory) and ordering.
Advisors can implement the <code class="literal">org.springframework.core.Ordered</code> interface to ensure
correct ordering if this is an issue. The TransactionAttributeSourceAdvisor used in the
above example has a configurable order value; the default setting is unordered.</p>
</div>
<div class="section" title="AbstractAdvisorAutoProxyCreator"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy-abstract"></a>AbstractAdvisorAutoProxyCreator</h4></div></div></div>

<p>This is the superclass of DefaultAdvisorAutoProxyCreator. You can create your own
auto-proxy creators by subclassing this class, in the unlikely event that advisor
definitions offer insufficient customization to the behavior of the framework
<code class="literal">DefaultAdvisorAutoProxyCreator</code>.</p>
</div>
</div>
<div class="section" title="9.9.2&nbsp;Using metadata-driven auto-proxying"><div class="titlepage"><div><div><h3 class="title"><a name="aop-autoproxy-metadata"></a>9.9.2&nbsp;Using metadata-driven auto-proxying</h3></div></div></div>

<p>A particularly important type of auto-proxying is driven by metadata. This produces a
similar programming model to .NET <code class="literal">ServicedComponents</code>. Instead of defining metadata in
XML descriptors, configuration for transaction management and other enterprise services
is held in source-level attributes.</p>
<p>In this case, you use the <code class="literal">DefaultAdvisorAutoProxyCreator</code>, in combination with Advisors
that understand metadata attributes. The metadata specifics are held in the pointcut
part of the candidate advisors, rather than in the auto-proxy creation class itself.</p>
<p>This is really a special case of the <code class="literal">DefaultAdvisorAutoProxyCreator</code>, but deserves
consideration on its own. (The metadata-aware code is in the pointcuts contained in the
advisors, not the AOP framework itself.)</p>
<p>The <code class="literal">/attributes</code> directory of the JPetStore sample application shows the use of
attribute-driven auto-proxying. In this case, there&#8217;s no need to use the
<code class="literal">TransactionProxyFactoryBean</code>. Simply defining transactional attributes on business
objects is sufficient, because of the use of metadata-aware pointcuts. The bean
definitions include the following code, in <code class="literal">/WEB-INF/declarativeServices.xml</code>. Note that
this is generic, and can be used outside the JPetStore:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributeSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.AttributesTransactionAttributeSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"attributes"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"attributes"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"attributes"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.metadata.commons.CommonsAttributes"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> bean definition (the name is not significant, hence
it can even be omitted) will pick up all eligible pointcuts in the current application
context. In this case, the "transactionAdvisor" bean definition, of type
<code class="literal">TransactionAttributeSourceAdvisor</code>, will apply to classes or methods carrying a
transaction attribute. The TransactionAttributeSourceAdvisor depends on a
TransactionInterceptor, via constructor dependency. The example resolves this via
autowiring. The <code class="literal">AttributesTransactionAttributeSource</code> depends on an implementation of
the <code class="literal">org.springframework.metadata.Attributes</code> interface. In this fragment, the
"attributes" bean satisfies this, using the Jakarta Commons Attributes API to obtain
attribute information. (The application code must have been compiled using the Commons
Attributes compilation task.)</p>
<p>The <code class="literal">/annotation</code> directory of the JPetStore sample application contains an analogous
example for auto-proxying driven by JDK 1.5+ annotations. The following configuration
enables automatic detection of Spring&#8217;s <code class="literal">Transactional</code> annotation, leading to implicit
proxies for beans containing that annotation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributeSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">TransactionInterceptor</code> defined here depends on a <code class="literal">PlatformTransactionManager</code>
definition, which is not included in this generic file (although it could be) because it
will be specific to the application&#8217;s transaction requirements (typically JTA, as in
this example, or Hibernate, JDO or JDBC):</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you require only declarative transaction management, using these generic XML
definitions will result in Spring automatically proxying all classes or methods with
transaction attributes. You won&#8217;t need to work directly with AOP, and the programming
model is similar to that of .NET ServicedComponents.</p>
</td></tr></table></div>

<p>This mechanism is extensible. It&#8217;s possible to do auto-proxying based on custom
attributes. You need to:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Define your custom attribute.
</li><li class="listitem">
Specify an Advisor with the necessary advice, including a pointcut that is triggered
by the presence of the custom attribute on a class or method. You may be able to use
an existing advice, merely implementing a static pointcut that picks up the custom
attribute.
</li></ul></div>

<p>It&#8217;s possible for such advisors to be unique to each advised class (for example, mixins):
they simply need to be defined as prototype, rather than singleton, bean definitions.
For example, the <code class="literal">LockMixin</code> introduction interceptor from the Spring test suite,
shown above, could be used in conjunction with a generic <code class="literal">DefaultIntroductionAdvisor</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lockMixin"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"test.mixin.LockMixin"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lockableAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.DefaultIntroductionAdvisor"</span>
        <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"lockMixin"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that both <code class="literal">lockMixin</code> and <code class="literal">lockableAdvisor</code> are defined as prototypes.</p>
</div>
</div>
<div class="section" title="9.10&nbsp;Using TargetSources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-targetsource"></a>9.10&nbsp;Using TargetSources</h2></div></div></div>

<p>Spring offers the concept of a <span class="emphasis"><em>TargetSource</em></span>, expressed in the
<code class="literal">org.springframework.aop.TargetSource</code> interface. This interface is responsible for
returning the "target object" implementing the join point. The <code class="literal">TargetSource</code>
implementation is asked for a target instance each time the AOP proxy handles a method
invocation.</p>
<p>Developers using Spring AOP don&#8217;t normally need to work directly with TargetSources, but
this provides a powerful means of supporting pooling, hot swappable and other
sophisticated targets. For example, a pooling TargetSource can return a different target
instance for each invocation, using a pool to manage instances.</p>
<p>If you do not specify a TargetSource, a default implementation is used that wraps a
local object. The same target is returned for each invocation (as you would expect).</p>
<p>Let&#8217;s look at the standard target sources provided with Spring, and how you can use them.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When using a custom target source, your target will usually need to be a prototype
rather than a singleton bean definition. This allows Spring to create a new target
instance when required.</p>
</td></tr></table></div>

<div class="section" title="9.10.1&nbsp;Hot swappable target sources"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-swap"></a>9.10.1&nbsp;Hot swappable target sources</h3></div></div></div>

<p>The <code class="literal">org.springframework.aop.target.HotSwappableTargetSource</code> exists to allow the target
of an AOP proxy to be switched while allowing callers to keep their references to it.</p>
<p>Changing the target source&#8217;s target takes effect immediately. The
<code class="literal">HotSwappableTargetSource</code> is threadsafe.</p>
<p>You can change the target via the <code class="literal">swap()</code> method on HotSwappableTargetSource as follows:</p>
<pre class="programlisting">HotSwappableTargetSource swapper = (HotSwappableTargetSource) beanFactory.getBean(<span class="hl-string">"swapper"</span>);
Object oldTarget = swapper.swap(newTarget);</pre>

<p>The XML definitions required look as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"initialTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"mycompany.OldTarget"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"swapper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.HotSwappableTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"initialTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"swappable"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"swapper"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above <code class="literal">swap()</code> call changes the target of the swappable bean. Clients who hold a
reference to that bean will be unaware of the change, but will immediately start hitting
the new target.</p>
<p>Although this example doesn&#8217;t add any advice - and it&#8217;s not necessary to add advice to
use a <code class="literal">TargetSource</code> - of course any <code class="literal">TargetSource</code> can be used in conjunction with
arbitrary advice.</p>
</div>
<div class="section" title="9.10.2&nbsp;Pooling target sources"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-pool"></a>9.10.2&nbsp;Pooling target sources</h3></div></div></div>

<p>Using a pooling target source provides a similar programming model to stateless session
EJBs, in which a pool of identical instances is maintained, with method invocations
going to free objects in the pool.</p>
<p>A crucial difference between Spring pooling and SLSB pooling is that Spring pooling can
be applied to any POJO. As with Spring in general, this service can be applied in a
non-invasive way.</p>
<p>Spring provides out-of-the-box support for Jakarta Commons Pool 1.3, which provides a
fairly efficient pooling implementation. You&#8217;ll need the commons-pool Jar on your
application&#8217;s classpath to use this feature. It&#8217;s also possible to subclass
<code class="literal">org.springframework.aop.target.AbstractPoolingTargetSource</code> to support any other
pooling API.</p>
<p>Sample configuration is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObjectTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyBusinessObject"</span>
        <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    ... properties omitted
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poolTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.CommonsPoolTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"25"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"poolTargetSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the target object - "businessObjectTarget" in the example - <span class="emphasis"><em>must</em></span> be a
prototype. This allows the <code class="literal">PoolingTargetSource</code> implementation to create new instances
of the target to grow the pool as necessary. See the javadoc for
<code class="literal">AbstractPoolingTargetSource</code> and the concrete subclass you wish to use for information
about its properties: "maxSize" is the most basic, and always guaranteed to be present.</p>
<p>In this case, "myInterceptor" is the name of an interceptor that would need to be
defined in the same IoC context. However, it isn&#8217;t necessary to specify interceptors to
use pooling. If you want only pooling, and no other advice, don&#8217;t set the
interceptorNames property at all.</p>
<p>It&#8217;s possible to configure Spring so as to be able to cast any pooled object to the
<code class="literal">org.springframework.aop.target.PoolingConfig</code> interface, which exposes information
about the configuration and current size of the pool through an introduction. You&#8217;ll
need to define an advisor like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poolConfigAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.MethodInvokingFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetObject"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"poolTargetSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetMethod"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"getPoolingConfigMixin"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This advisor is obtained by calling a convenience method on the
<code class="literal">AbstractPoolingTargetSource</code> class, hence the use of MethodInvokingFactoryBean. This
advisor&#8217;s name ("poolConfigAdvisor" here) must be in the list of interceptors names in
the ProxyFactoryBean exposing the pooled object.</p>
<p>The cast will look as follows:</p>
<pre class="programlisting">PoolingConfig conf = (PoolingConfig) beanFactory.getBean(<span class="hl-string">"businessObject"</span>);
System.out.println(<span class="hl-string">"Max pool size is "</span> + conf.getMaxSize());</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Pooling stateless service objects is not usually necessary. We don&#8217;t believe it should
be the default choice, as most stateless objects are naturally thread safe, and instance
pooling is problematic if resources are cached.</p>
</td></tr></table></div>

<p>Simpler pooling is available using auto-proxying. It&#8217;s possible to set the TargetSources
used by any auto-proxy creator.</p>
</div>
<div class="section" title="9.10.3&nbsp;Prototype target sources"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-prototype"></a>9.10.3&nbsp;Prototype target sources</h3></div></div></div>

<p>Setting up a "prototype" target source is similar to a pooling TargetSource. In this
case, a new instance of the target will be created on every method invocation. Although
the cost of creating a new object isn&#8217;t high in a modern JVM, the cost of wiring up the
new object (satisfying its IoC dependencies) may be more expensive. Thus you shouldn&#8217;t
use this approach without very good reason.</p>
<p>To do this, you could modify the <code class="literal">poolTargetSource</code> definition shown above as follows.
(I&#8217;ve also changed the name, for clarity.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"prototypeTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.PrototypeTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>There&#8217;s only one property: the name of the target bean. Inheritance is used in the
TargetSource implementations to ensure consistent naming. As with the pooling target
source, the target bean must be a prototype bean definition.</p>
</div>
<div class="section" title="9.10.4&nbsp;ThreadLocal target sources"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-threadlocal"></a>9.10.4&nbsp;ThreadLocal target sources</h3></div></div></div>

<p><code class="literal">ThreadLocal</code> target sources are useful if you need an object to be created for each
incoming request (per thread that is). The concept of a <code class="literal">ThreadLocal</code> provide a JDK-wide
facility to transparently store resource alongside a thread. Setting up a
<code class="literal">ThreadLocalTargetSource</code> is pretty much the same as was explained for the other types
of target source:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"threadlocalTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.ThreadLocalTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>ThreadLocals come with serious issues (potentially resulting in memory leaks) when
incorrectly using them in a multi-threaded and multi-classloader environments. One
should always consider wrapping a threadlocal in some other class and never directly use
the <code class="literal">ThreadLocal</code> itself (except of course in the wrapper class). Also, one should
always remember to correctly set and unset (where the latter simply involved a call to
<code class="literal">ThreadLocal.set(null)</code>) the resource local to the thread. Unsetting should be done in
any case since not unsetting it might result in problematic behavior. Spring&#8217;s
ThreadLocal support does this for you and should always be considered in favor of using
ThreadLocals without other proper handling code.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="9.11&nbsp;Defining new Advice types"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-extensibility"></a>9.11&nbsp;Defining new Advice types</h2></div></div></div>

<p>Spring AOP is designed to be extensible. While the interception implementation strategy
is presently used internally, it is possible to support arbitrary advice types in
addition to the out-of-the-box interception around advice, before, throws advice and
after returning advice.</p>
<p>The <code class="literal">org.springframework.aop.framework.adapter</code> package is an SPI package allowing
support for new custom advice types to be added without changing the core framework. The
only constraint on a custom <code class="literal">Advice</code> type is that it must implement the
<code class="literal">org.aopalliance.aop.Advice</code> tag interface.</p>
<p>Please refer to the <code class="literal">org.springframework.aop.framework.adapter</code> package&#8217;s Javadocs for
further information.</p>
</div>
<div class="section" title="9.12&nbsp;Further resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-resources"></a>9.12&nbsp;Further resources</h2></div></div></div>

<p>Please refer to the Spring sample applications for further examples of Spring AOP:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The JPetStore&#8217;s default configuration illustrates the use of the
<code class="literal">TransactionProxyFactoryBean</code> for declarative transaction management.
</li><li class="listitem">
The <code class="literal">/attributes</code> directory of the JPetStore illustrates the use of attribute-driven
declarative transaction management.
</li></ul></div>

</div>
</div>
<div class="chapter" title="10.&nbsp;Testing"><div class="titlepage"><div><div><h2 class="title"><a name="testing"></a>10.&nbsp;Testing</h2></div></div></div>

<div class="section" title="10.1&nbsp;Introduction to Spring Testing"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-introduction"></a>10.1&nbsp;Introduction to Spring Testing</h2></div></div></div>

<p>Testing is an integral part of enterprise software development. This chapter focuses on
the value-add of the IoC principle to <a class="link" href="#unit-testing" title="10.2&nbsp;Unit Testing">unit testing</a> and on the benefits
of the Spring Framework&#8217;s support for <a class="link" href="#integration-testing" title="10.3&nbsp;Integration Testing">integration testing</a>. <span class="emphasis"><em>(A
thorough treatment of testing in the enterprise is beyond the scope of this reference
manual.)</em></span></p>
</div>
<div class="section" title="10.2&nbsp;Unit Testing"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="unit-testing"></a>10.2&nbsp;Unit Testing</h2></div></div></div>

<p>Dependency Injection should make your code less dependent on the container than it would
be with traditional Java EE development. The POJOs that make up your application should
be testable in JUnit or TestNG tests, with objects simply instantiated using the <code class="literal">new</code>
operator, <span class="emphasis"><em>without Spring or any other container</em></span>. You can use <a class="link" href="#mock-objects" title="10.2.1&nbsp;Mock Objects">mock
objects</a> (in conjunction with other valuable testing techniques) to test your code in
isolation. If you follow the architecture recommendations for Spring, the resulting
clean layering and componentization of your codebase will facilitate easier unit
testing. For example, you can test service layer objects by stubbing or mocking DAO or
Repository interfaces, without needing to access persistent data while running unit
tests.</p>
<p>True unit tests typically run extremely quickly, as there is no runtime infrastructure
to set up. Emphasizing true unit tests as part of your development methodology will
boost your productivity. You may not need this section of the testing chapter to help
you write effective unit tests for your IoC-based applications. For certain unit testing
scenarios, however, the Spring Framework provides the following mock objects and testing
support classes.</p>
<div class="section" title="10.2.1&nbsp;Mock Objects"><div class="titlepage"><div><div><h3 class="title"><a name="mock-objects"></a>10.2.1&nbsp;Mock Objects</h3></div></div></div>

<div class="section" title="Environment"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-env"></a>Environment</h4></div></div></div>

<p>The <code class="literal">org.springframework.mock.env</code> package contains mock implementations of the
<code class="literal">Environment</code> and <code class="literal">PropertySource</code> abstractions (see <a class="xref" href="#beans-definition-profiles" title="4.13&nbsp;Bean definition profiles and environment abstraction">Section&nbsp;4.13, &#8220;Bean definition profiles and environment abstraction&#8221;</a>
and <a class="xref" href="#beans-property-source-abstraction" title="4.14&nbsp;PropertySource Abstraction">Section&nbsp;4.14, &#8220;PropertySource Abstraction&#8221;</a>). <code class="literal">MockEnvironment</code> and
<code class="literal">MockPropertySource</code> are useful for developing <span class="emphasis"><em>out-of-container</em></span> tests for code that
depends on environment-specific properties.</p>
</div>
<div class="section" title="JNDI"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-jndi"></a>JNDI</h4></div></div></div>

<p>The <code class="literal">org.springframework.mock.jndi</code> package contains an implementation of the JNDI SPI,
which you can use to set up a simple JNDI environment for test suites or stand-alone
applications. If, for example, JDBC <code class="literal">DataSource</code> s get bound to the same JNDI names in
test code as within a Java EE container, you can reuse both application code and
configuration in testing scenarios without modification.</p>
</div>
<div class="section" title="Servlet API"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-servlet"></a>Servlet API</h4></div></div></div>

<p>The <code class="literal">org.springframework.mock.web</code> package contains a comprehensive set of Servlet API
mock objects, targeted at usage with Spring&#8217;s Web MVC framework, which are useful for
testing web contexts and controllers. These mock objects are generally more convenient
to use than dynamic mock objects such as <a class="ulink" href="http://www.easymock.org" target="_top">EasyMock</a> or existing
Servlet API mock objects such as <a class="ulink" href="http://www.mockobjects.com" target="_top">MockObjects</a>.</p>
</div>
<div class="section" title="Portlet API"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-portlet"></a>Portlet API</h4></div></div></div>

<p>The <code class="literal">org.springframework.mock.web.portlet</code> package contains a set of Portlet API mock
objects, targeted at usage with Spring&#8217;s Portlet MVC framework.</p>
</div>
</div>
<div class="section" title="10.2.2&nbsp;Unit Testing support Classes"><div class="titlepage"><div><div><h3 class="title"><a name="unit-testing-support-classes"></a>10.2.2&nbsp;Unit Testing support Classes</h3></div></div></div>

<div class="section" title="General utilities"><div class="titlepage"><div><div><h4 class="title"><a name="unit-testing-utilities"></a>General utilities</h4></div></div></div>

<p>The <code class="literal">org.springframework.test.util</code> package contains <code class="literal">ReflectionTestUtils</code>, which is a
collection of reflection-based utility methods. Developers use these methods in unit and
integration testing scenarios in which they need to set a non- <code class="literal">public</code> field or invoke
a non- <code class="literal">public</code> setter method when testing application code involving, for example:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
ORM frameworks such as JPA and Hibernate that condone <code class="literal">private</code> or <code class="literal">protected</code> field
access as opposed to <code class="literal">public</code> setter methods for properties in a domain entity.
</li><li class="listitem">
Spring&#8217;s support for annotations such as <code class="literal">@Autowired</code>, <code class="literal">@Inject</code>, and <code class="literal">@Resource,</code>
which provides dependency injection for <code class="literal">private</code> or <code class="literal">protected</code> fields, setter
methods, and configuration methods.
</li></ul></div>

</div>
<div class="section" title="Spring MVC"><div class="titlepage"><div><div><h4 class="title"><a name="unit-testing-spring-mvc"></a>Spring MVC</h4></div></div></div>

<p>The <code class="literal">org.springframework.test.web</code> package contains <code class="literal">ModelAndViewAssert</code>, which you can
use in combination with JUnit, TestNG, or any other testing framework for unit tests
dealing with Spring MVC <code class="literal">ModelAndView</code> objects.</p>
<div class="tip" title="Unit testing Spring MVC Controllers" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: Unit testing Spring MVC Controllers"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Unit testing Spring MVC Controllers</th></tr><tr><td align="left" valign="top">

<p>To test your Spring MVC <code class="literal">Controller</code> s, use <code class="literal">ModelAndViewAssert</code> combined with
<code class="literal">MockHttpServletRequest</code>, <code class="literal">MockHttpSession</code>, and so on from the <a class="link" href="#mock-objects-servlet" title="Servlet API"><code class="literal">org.springframework.mock.web</code></a> package.</p>
<p>Note: As of Spring 4.0, the set of mocks in the <code class="literal">org.springframework.mock.web</code> package
is now based on the Servlet 3.0 API.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section" title="10.3&nbsp;Integration Testing"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="integration-testing"></a>10.3&nbsp;Integration Testing</h2></div></div></div>

<div class="section" title="10.3.1&nbsp;Overview"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-overview"></a>10.3.1&nbsp;Overview</h3></div></div></div>

<p>It is important to be able to perform some integration testing without requiring
deployment to your application server or connecting to other enterprise infrastructure.
This will enable you to test things such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The correct wiring of your Spring IoC container contexts.
</li><li class="listitem">
Data access using JDBC or an ORM tool. This would include such things as the
correctness of SQL statements, Hibernate queries, JPA entity mappings, etc.
</li></ul></div>

<p>The Spring Framework provides first-class support for integration testing in the
<code class="literal">spring-test</code> module. The name of the actual JAR file might include the release version
and might also be in the long <code class="literal">org.springframework.test</code> form, depending on where you
get it from (see the <a class="link" href="#dependency-management" title="2.3.1&nbsp;Dependency Management and Naming Conventions">section on Dependency Management</a> for an
explanation). This library includes the <code class="literal">org.springframework.test</code> package, which
contains valuable classes for integration testing with a Spring container. This testing
does not rely on an application server or other deployment environment. Such tests are
slower to run than unit tests but much faster than the equivalent Selenium tests or remote
tests that rely on deployment to an application server.</p>
<p>In Spring 2.5 and later, unit and integration testing support is provided in the form of
the annotation-driven <a class="link" href="#testcontext-framework" title="10.3.5&nbsp;Spring TestContext Framework">Spring TestContext Framework</a>. The
TestContext framework is agnostic of the actual testing framework in use, thus allowing
instrumentation of tests in various environments including JUnit, TestNG, and so on.</p>
</div>
<div class="section" title="10.3.2&nbsp;Goals of Integration Testing"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-goals"></a>10.3.2&nbsp;Goals of Integration Testing</h3></div></div></div>

<p>Spring&#8217;s integration testing support has the following primary goals:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
To manage <a class="link" href="#testing-ctx-management" title="Context management and caching">Spring IoC container caching</a> between test
execution.
</li><li class="listitem">
To provide <a class="link" href="#testing-fixture-di" title="Dependency Injection of test fixtures">Dependency Injection of test fixture instances</a>.
</li><li class="listitem">
To provide <a class="link" href="#testing-tx" title="Transaction management">transaction management</a> appropriate to integration testing.
</li><li class="listitem">
To supply <a class="link" href="#testing-support-classes" title="Support classes for integration testing">Spring-specific base classes</a> that assist
developers in writing integration tests.
</li></ul></div>

<p>The next few sections describe each goal and provide links to implementation and
configuration details.</p>
<div class="section" title="Context management and caching"><div class="titlepage"><div><div><h4 class="title"><a name="testing-ctx-management"></a>Context management and caching</h4></div></div></div>

<p>The Spring TestContext Framework provides consistent loading of Spring
<code class="literal">ApplicationContext</code> s and <code class="literal">WebApplicationContext</code> s as well as caching of those
contexts. Support for the caching of loaded contexts is important, because startup time
can become an issue&#8201;&#8212;&#8201;not because of the overhead of Spring itself, but because the
objects instantiated by the Spring container take time to instantiate. For example, a
project with 50 to 100 Hibernate mapping files might take 10 to 20 seconds to load the
mapping files, and incurring that cost before running every test in every test fixture
leads to slower overall test runs that reduce developer productivity.</p>
<p>Test classes typically declare either an array of <span class="emphasis"><em>resource locations</em></span> for XML
configuration metadata&#8201;&#8212;&#8201;often in the classpath&#8201;&#8212;&#8201;or an array of <span class="emphasis"><em>annotated classes</em></span>
that is used to configure the application. These locations or classes are the same as or
similar to those specified in <code class="literal">web.xml</code> or other deployment configuration files.</p>
<p>By default, once loaded, the configured <code class="literal">ApplicationContext</code> is reused for each test.
Thus the setup cost is incurred only once per test suite, and subsequent test execution
is much faster. In this context, the term <span class="emphasis"><em>test suite</em></span> means all tests run in the same
JVM&#8201;&#8212;&#8201;for example, all tests run from an Ant, Maven, or Gradle build for a given
project or module. In the unlikely case that a test corrupts the application context and
requires reloading&#8201;&#8212;&#8201;for example, by modifying a bean definition or the state of an
application object&#8201;&#8212;&#8201;the TestContext framework can be configured to reload the
configuration and rebuild the application context before executing the next test.</p>
<p>See <a class="xref" href="#testcontext-ctx-management" title="Context management">the section called &#8220;Context management&#8221;</a> and <a class="xref" href="#testcontext-ctx-management-caching" title="Context caching">the section called &#8220;Context caching&#8221;</a> with the
TestContext framework.</p>
</div>
<div class="section" title="Dependency Injection of test fixtures"><div class="titlepage"><div><div><h4 class="title"><a name="testing-fixture-di"></a>Dependency Injection of test fixtures</h4></div></div></div>

<p>When the TestContext framework loads your application context, it can optionally
configure instances of your test classes via Dependency Injection. This provides a
convenient mechanism for setting up test fixtures using preconfigured beans from your
application context. A strong benefit here is that you can reuse application contexts
across various testing scenarios (e.g., for configuring Spring-managed object graphs,
transactional proxies, <code class="literal">DataSource</code> s, etc.), thus avoiding the need to duplicate
complex test fixture setup for individual test cases.</p>
<p>As an example, consider the scenario where we have a class, <code class="literal">HibernateTitleRepository</code>,
that implements data access logic for a <code class="literal">Title</code> domain entity. We want to write
integration tests that test the following areas:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The Spring configuration: basically, is everything related to the configuration of the
<code class="literal">HibernateTitleRepository</code> bean correct and present?
</li><li class="listitem">
The Hibernate mapping file configuration: is everything mapped correctly, and are the
correct lazy-loading settings in place?
</li><li class="listitem">
The logic of the <code class="literal">HibernateTitleRepository</code>: does the configured instance of this
class perform as anticipated?
</li></ul></div>

<p>See dependency injection of test fixtures with the <a class="link" href="#testcontext-fixture-di" title="Dependency injection of test fixtures">TestContext
framework</a>.</p>
</div>
<div class="section" title="Transaction management"><div class="titlepage"><div><div><h4 class="title"><a name="testing-tx"></a>Transaction management</h4></div></div></div>

<p>One common issue in tests that access a real database is their effect on the state of
the persistence store. Even when you&#8217;re using a development database, changes to the
state may affect future tests. Also, many operations&#8201;&#8212;&#8201;such as inserting or modifying
persistent data&#8201;&#8212;&#8201;cannot be performed (or verified) outside a transaction.</p>
<p>The TestContext framework addresses this issue. By default, the framework will create
and roll back a transaction for each test. You simply write code that can assume the
existence of a transaction. If you call transactionally proxied objects in your tests,
they will behave correctly, according to their configured transactional semantics. In
addition, if a test method deletes the contents of selected tables while running within
the transaction managed for the test, the transaction will roll back by default, and the
database will return to its state prior to execution of the test. Transactional support
is provided to a test via a <code class="literal">PlatformTransactionManager</code> bean defined in the test&#8217;s
application context.</p>
<p>If you want a transaction to commit&#8201;&#8212;&#8201;unusual, but occasionally useful when you want a
particular test to populate or modify the database&#8201;&#8212;&#8201;the TestContext framework can be
instructed to cause the transaction to commit instead of roll back via the
<a class="link" href="#integration-testing-annotations" title="10.3.4&nbsp;Annotations"><code class="literal">@TransactionConfiguration</code></a> and
<a class="link" href="#integration-testing-annotations" title="10.3.4&nbsp;Annotations"><code class="literal">@Rollback</code></a> annotations.</p>
<p>See transaction management with the <a class="link" href="#testcontext-tx" title="Transaction management">TestContext framework</a>.</p>
</div>
<div class="section" title="Support classes for integration testing"><div class="titlepage"><div><div><h4 class="title"><a name="testing-support-classes"></a>Support classes for integration testing</h4></div></div></div>

<p>The Spring TestContext Framework provides several <code class="literal">abstract</code> support classes that
simplify the writing of integration tests. These base test classes provide well-defined
hooks into the testing framework as well as convenient instance variables and methods,
which enable you to access:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <code class="literal">ApplicationContext</code>, for performing explicit bean lookups or testing the state of
the context as a whole.
</li><li class="listitem">
A <code class="literal">JdbcTemplate</code>, for executing SQL statements to query the database. Such queries can
be used to confirm database state both <span class="emphasis"><em>prior to</em></span> and <span class="emphasis"><em>after</em></span> execution of
database-related application code, and Spring ensures that such queries run in the
scope of the same transaction as the application code. When used in conjunction with
an ORM tool, be sure to avoid <a class="link" href="#">false positives</a>.
</li></ul></div>

<p>In addition, you may want to create your own custom, application-wide superclass with
instance variables and methods specific to your project.</p>
<p>See support classes for the <a class="link" href="#testcontext-support-classes" title="TestContext Framework support classes">TestContext framework</a>.</p>
</div>
</div>
<div class="section" title="10.3.3&nbsp;JDBC Testing Support"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-support-jdbc"></a>10.3.3&nbsp;JDBC Testing Support</h3></div></div></div>

<p>The <code class="literal">org.springframework.test.jdbc</code> package contains <code class="literal">JdbcTestUtils</code>, which is a
collection of JDBC related utility functions intended to simplify standard database
testing scenarios. <span class="emphasis"><em>Note that <a class="link" href="#testcontext-support-classes-junit4" title="JUnit support classes"><code class="literal">AbstractTransactionalJUnit4SpringContextTests</code></a> and
<a class="link" href="#testcontext-support-classes-testng" title="TestNG support classes"><code class="literal">AbstractTransactionalTestNGSpringContextTests</code></a>
provide convenience methods which delegate to <code class="literal">JdbcTestUtils</code> internally.</em></span></p>
<p>The <code class="literal">spring-jdbc</code> module provides support for configuring and launching an embedded
database which can be used in integration tests that interact with a database. For
details, see <a class="xref" href="#jdbc-embedded-database-support" title="13.8&nbsp;Embedded database support">Section&nbsp;13.8, &#8220;Embedded database support&#8221;</a> and
<a class="xref" href="#jdbc-embedded-database-dao-testing" title="13.8.8&nbsp;Testing data access logic with an embedded database">Section&nbsp;13.8.8, &#8220;Testing data access logic with an embedded database&#8221;</a>.</p>
</div>
<div class="section" title="10.3.4&nbsp;Annotations"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-annotations"></a>10.3.4&nbsp;Annotations</h3></div></div></div>

<div class="section" title="Spring Testing Annotations"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-spring"></a>Spring Testing Annotations</h4></div></div></div>

<p>The Spring Framework provides the following set of <span class="emphasis"><em>Spring-specific</em></span> annotations that
you can use in your unit and integration tests in conjunction with the TestContext
framework. Refer to the respective Javadoc for further information, including default
attribute values, attribute aliases, and so on.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<p class="simpara"><code class="literal">@ContextConfiguration</code></p>
<p class="simpara">Defines class-level metadata that is used to determine how to load and configure an
<code class="literal">ApplicationContext</code> for integration tests. Specifically, <code class="literal">@ContextConfiguration</code>
declares <span class="emphasis"><em>either</em></span> the application context resource <code class="literal">locations</code> <span class="emphasis"><em>or</em></span> the annotated
<code class="literal">classes</code> that will be used to load the context.</p>
<p class="simpara">Resource locations are typically XML configuration files located in the classpath;
whereas, annotated classes are typically <code class="literal">@Configuration</code> classes. However, resource
locations can also refer to files in the file system, and annotated classes can be
component classes, etc.</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="hl-string">"/test-config.xml"</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> XmlApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>classes</strong></span> = TestConfig.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ConfigClassApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">As an alternative or in addition to declaring resource locations or annotated classes,
<code class="literal">@ContextConfiguration</code> may be used to declare <code class="literal">ApplicationContextInitializer</code> classes.</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>initializers</strong></span> = CustomContextIntializer.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextInitializerTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara"><code class="literal">@ContextConfiguration</code> may optionally be used to declare the <code class="literal">ContextLoader</code> strategy
as well. Note, however, that you typically do not need to explicitly configure the
loader since the default loader supports either resource <code class="literal">locations</code> or annotated
<code class="literal">classes</code> as well as <code class="literal">initializers</code>.</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>locations</strong></span> = <span class="hl-string">"/test-context.xml"</span>, <span class="strong"><strong>loader</strong></span> = CustomContextLoader.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomLoaderXmlApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@ContextConfiguration</code> provides support for <span class="emphasis"><em>inheriting</em></span> resource locations or
configuration classes as well as context initializers declared by superclasses by
default.</p>
</td></tr></table></div>

<p class="simpara">See <a class="xref" href="#testcontext-ctx-management" title="Context management">the section called &#8220;Context management&#8221;</a> and the Javadoc for <code class="literal">@ContextConfiguration</code> for
further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@WebAppConfiguration</code></p>
<p class="simpara">A class-level annotation that is used to declare that the <code class="literal">ApplicationContext</code> loaded
for an integration test should be a <code class="literal">WebApplicationContext</code>. The mere presence of
<code class="literal">@WebAppConfiguration</code> on a test class ensures that a <code class="literal">WebApplicationContext</code> will be
loaded for the test, using the default value of <code class="literal">"file:src/main/webapp"</code> for the path to
the root of the web application (i.e., the <span class="emphasis"><em>resource base path</em></span>). The resource base
path is used behind the scenes to create a <code class="literal">MockServletContext</code> which serves as the
<code class="literal">ServletContext</code> for the test&#8217;s <code class="literal">WebApplicationContext</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="strong"><strong>@WebAppConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebAppTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">To override the default, specify a different base resource path via the <span class="emphasis"><em>implicit</em></span>
<code class="literal">value</code> attribute. Both <code class="literal">classpath:</code> and <code class="literal">file:</code> resource prefixes are supported. If no
resource prefix is supplied the path is assumed to be a file system resource.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="strong"><strong>@WebAppConfiguration("classpath:test-web-resources")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebAppTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">Note that <code class="literal">@WebAppConfiguration</code> must be used in conjunction with
<code class="literal">@ContextConfiguration</code>, either within a single test class or within a test class
hierarchy. See the Javadoc for <code class="literal">@WebAppConfiguration</code> for further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@ContextHierarchy</code></p>
<p class="simpara">A class-level annotation that is used to define a hierarchy of <code class="literal">ApplicationContext</code> s
for integration tests. <code class="literal">@ContextHierarchy</code> should be declared with a list of one or more
<code class="literal">@ContextConfiguration</code> instances, each of which defines a level in the context
hierarchy. The following examples demonstrate the use of <code class="literal">@ContextHierarchy</code> within a
single test class; however, <code class="literal">@ContextHierarchy</code> can also be used within a test class
hierarchy.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration("/parent-config.xml"),
    @ContextConfiguration("/child-config.xml")
})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextHierarchyTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(classes = AppConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">If you need to merge or override the configuration for a given level of the context
hierarchy within a test class hierarchy, you must explicitly name that level by
supplying the same value to the <code class="literal">name</code> attribute in <code class="literal">@ContextConfiguration</code> at each
corresponding level in the class hierarchy. See
<a class="xref" href="#testcontext-ctx-management-ctx-hierarchies" title="Context hierarchies">the section called &#8220;Context hierarchies&#8221;</a> and the Javadoc for <code class="literal">@ContextHierarchy</code>
for further examples.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@ActiveProfiles</code></p>
<p class="simpara">A class-level annotation that is used to declare which <span class="emphasis"><em>bean definition profiles</em></span>
should be active when loading an <code class="literal">ApplicationContext</code> for test classes.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="strong"><strong>@ActiveProfiles</strong></span>(<span class="hl-string">"dev"</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DeveloperTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="strong"><strong>@ActiveProfiles</strong></span>({<span class="hl-string">"dev"</span>, <span class="hl-string">"integration"</span>})
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DeveloperIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@ActiveProfiles</code> provides support for <span class="emphasis"><em>inheriting</em></span> active bean definition profiles
declared by superclasses by default. It is also possible to resolve active bean
definition profiles programmatically by implementing a custom
<a class="link" href="#testcontext-ctx-management-env-profiles-ActiveProfilesResolver"><code class="literal">ActiveProfilesResolver</code></a>
and registering it via the <code class="literal">resolver</code> attribute of <code class="literal">@ActiveProfiles</code>.</p>
</td></tr></table></div>

<p class="simpara">See <a class="xref" href="#testcontext-ctx-management-env-profiles" title="Context configuration with environment profiles">the section called &#8220;Context configuration with environment profiles&#8221;</a> and the Javadoc for <code class="literal">@ActiveProfiles</code>
for examples and further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@DirtiesContext</code></p>
<p class="simpara">Indicates that the underlying Spring <code class="literal">ApplicationContext</code> has been <span class="emphasis"><em>dirtied</em></span> during
the execution of a test (i.e., modified or corrupted in some manner&#8201;&#8212;&#8201;for example, by
changing the state of a singleton bean) and should be closed, regardless of whether the
test passed. When an application context is marked <span class="emphasis"><em>dirty</em></span>, it is removed from the
testing framework&#8217;s cache and closed. As a consequence, the underlying Spring container
will be rebuilt for any subsequent test that requires a context with the same
configuration metadata.</p>
<p class="simpara"><code class="literal">@DirtiesContext</code> can be used as both a class-level and method-level annotation within
the same test class. In such scenarios, the <code class="literal">ApplicationContext</code> is marked as <span class="emphasis"><em>dirty</em></span>
after any such annotated method as well as after the entire class. If the <code class="literal">ClassMode</code> is
set to <code class="literal">AFTER_EACH_TEST_METHOD</code>, the context is marked dirty after each test method in
the class.</p>
<p class="simpara">The following examples explain when the context would be dirtied for various
configuration scenarios:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<p class="simpara">After the current test class, when declared on a class with class mode set to
<code class="literal">AFTER_CLASS</code> (i.e., the default class mode).</p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextDirtyingTests {
    <span class="hl-comment">// some tests that result in the Spring container being dirtied</span>
}</pre>

</li><li class="listitem">
<p class="simpara">After each test method in the current test class, when declared on a class with class
mode set to <code class="literal">AFTER_EACH_TEST_METHOD.</code></p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>(<span class="strong"><strong>classMode</strong></span> = ClassMode.AFTER_EACH_TEST_METHOD)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextDirtyingTests {
    <span class="hl-comment">// some tests that result in the Spring container being dirtied</span>
}</pre>

</li><li class="listitem">
<p class="simpara">After the current test, when declared on a method.</p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>
<i><span class="hl-annotation" style="color: gray">@Test</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichDirtiesAppCtx() {
    <span class="hl-comment">// some logic that results in the Spring container being dirtied</span>
}</pre>

<p class="simpara">If <code class="literal">@DirtiesContext</code> is used in a test whose context is configured as part of a context
hierarchy via <code class="literal">@ContextHierarchy</code>, the <code class="literal">hierarchyMode</code> flag can be used to control how
the context cache is cleared. By default an <span class="emphasis"><em>exhaustive</em></span> algorithm will be used that
clears the context cache including not only the current level but also all other context
hierarchies that share an ancestor context common to the current test; all
<code class="literal">ApplicationContext</code> s that reside in a sub-hierarchy of the common ancestor context
will be removed from the context cache and closed. If the <span class="emphasis"><em>exhaustive</em></span> algorithm is
overkill for a particular use case, the simpler <span class="emphasis"><em>current level</em></span> algorithm can be
specified instead, as seen below.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration("/parent-config.xml"),
    @ContextConfiguration("/child-config.xml")
})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTests {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTests <span class="hl-keyword">extends</span> BaseTests {

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    @DirtiesContext(<span class="strong"><strong>hierarchyMode = HierarchyMode.CURRENT_LEVEL</strong></span>)
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> test() {
        <span class="hl-comment">// some logic that results in the child context being dirtied</span>
    }
}</pre>

</li></ul></div>

<p class="simpara">For further details regarding the <code class="literal">EXHAUSTIVE</code> and <code class="literal">CURRENT_LEVEL</code> algorithms see the
Javadoc for <code class="literal">DirtiesContext.HierarchyMode</code>.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@TestExecutionListeners</code></p>
<p class="simpara">Defines class-level metadata for configuring which <code class="literal">TestExecutionListener</code> s should be
registered with the <code class="literal">TestContextManager</code>. Typically, <code class="literal">@TestExecutionListeners</code> is used
in conjunction with <code class="literal">@ContextConfiguration</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="strong"><strong>@TestExecutionListeners</strong></span>({CustomTestExecutionListener.<span class="hl-keyword">class</span>, AnotherTestExecutionListener.<span class="hl-keyword">class</span>})
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomTestExecutionListenerTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara"><code class="literal">@TestExecutionListeners</code> supports <span class="emphasis"><em>inherited</em></span> listeners by default. See the Javadoc
for an example and further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@TransactionConfiguration</code></p>
<p class="simpara">Defines class-level metadata for configuring transactional tests. Specifically, the bean
name of the <code class="literal">PlatformTransactionManager</code> that should be used to drive transactions can
be explicitly specified if there are multiple beans of type <code class="literal">PlatformTransactionManager</code>
in the test&#8217;s <code class="literal">ApplicationContext</code> and if the bean name of the desired
<code class="literal">PlatformTransactionManager</code> is not "transactionManager". In addition, you can change
the <code class="literal">defaultRollback</code> flag to <code class="literal">false</code>. Typically, <code class="literal">@TransactionConfiguration</code> is used in
conjunction with <code class="literal">@ContextConfiguration</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="strong"><strong>@TransactionConfiguration</strong></span>(<span class="strong"><strong>transactionManager</strong></span> = <span class="hl-string">"txMgr"</span>, <span class="strong"><strong>defaultRollback</strong></span> = false)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomConfiguredTransactionalTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If the default conventions are sufficient for your test configuration, you can avoid
using <code class="literal">@TransactionConfiguration</code> altogether. In other words, if you have only one
transaction manger&#8201;&#8212;&#8201;or if you have multiple transaction mangers but the transaction
manager for tests is named "transactionManager" or specified via a
<code class="literal">TransactionManagementConfigurer</code>&#8201;&#8212;&#8201;and if you want transactions to roll back
automatically, then there is no need to annotate your test class with
<code class="literal">@TransactionConfiguration</code>.</p>
</td></tr></table></div>

</li><li class="listitem">
<p class="simpara"><code class="literal">@Rollback</code></p>
<p class="simpara">Indicates whether the transaction for the annotated test method should be <span class="emphasis"><em>rolled
back</em></span> after the test method has completed. If <code class="literal">true</code>, the transaction is rolled back;
otherwise, the transaction is committed. Use <code class="literal">@Rollback</code> to override the default
rollback flag configured at the class level.</p>
<pre class="programlisting"><span class="strong"><strong>@Rollback</strong></span>(false)
<i><span class="hl-annotation" style="color: gray">@Test</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWithoutRollback() {
    <span class="hl-comment">// ...</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@BeforeTransaction</code></p>
<p class="simpara">Indicates that the annotated <code class="literal">public void</code> method should be executed <span class="emphasis"><em>before</em></span> a
transaction is started for test methods configured to run within a transaction via the
<code class="literal">@Transactional</code> annotation.</p>
<pre class="programlisting"><span class="strong"><strong>@BeforeTransaction</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> beforeTransaction() {
    <span class="hl-comment">// logic to be executed before a transaction is started</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@AfterTransaction</code></p>
<p class="simpara">Indicates that the annotated <code class="literal">public void</code> method should be executed <span class="emphasis"><em>after</em></span> a
transaction has ended for test methods configured to run within a transaction via the
<code class="literal">@Transactional</code> annotation.</p>
<pre class="programlisting"><span class="strong"><strong>@AfterTransaction</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterTransaction() {
    <span class="hl-comment">// logic to be executed after a transaction has ended</span>
}</pre>

</li></ul></div>

</div>
<div class="section" title="Standard Annotation Support"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-standard"></a>Standard Annotation Support</h4></div></div></div>

<p>The following annotations are supported with standard semantics for all configurations
of the Spring TestContext Framework. Note that these annotations are not specific to
tests and can be used anywhere in the Spring Framework.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">@Autowired</code>
</li><li class="listitem">
<code class="literal">@Qualifier</code>
</li><li class="listitem">
<code class="literal">@Resource</code> (javax.annotation) <span class="emphasis"><em>if JSR-250 is present</em></span>
</li><li class="listitem">
<code class="literal">@Inject</code> (javax.inject) <span class="emphasis"><em>if JSR-330 is present</em></span>
</li><li class="listitem">
<code class="literal">@Named</code> (javax.inject) <span class="emphasis"><em>if JSR-330 is present</em></span>
</li><li class="listitem">
<code class="literal">@PersistenceContext</code> (javax.persistence) <span class="emphasis"><em>if JPA is present</em></span>
</li><li class="listitem">
<code class="literal">@PersistenceUnit</code> (javax.persistence) <span class="emphasis"><em>if JPA is present</em></span>
</li><li class="listitem">
<code class="literal">@Required</code>
</li><li class="listitem">
<code class="literal">@Transactional</code>
</li></ul></div>

<div class="note" title="JSR-250 Lifecycle Annotations" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: JSR-250 Lifecycle Annotations"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">JSR-250 Lifecycle Annotations</th></tr><tr><td align="left" valign="top">

<p>In the Spring TestContext Framework <code class="literal">@PostConstruct</code> and <code class="literal">@PreDestroy</code> may be used with
standard semantics on any application components configured in the <code class="literal">ApplicationContext</code>;
however, these lifecycle annotations have limited usage within an actual test class.</p>
<p>If a method within a test class is annotated with <code class="literal">@PostConstruct</code>, that method will be
executed before any <span class="emphasis"><em>before</em></span> methods of the underlying test framework (e.g., methods
annotated with JUnit&#8217;s <code class="literal">@Before</code>), and that will apply for every test method in the test
class. On the other hand, if a method within a test class is annotated with
<code class="literal">@PreDestroy</code>, that method will <span class="emphasis"><em>never</em></span> be executed. Within a test class it is
therefore recommended to use test lifecycle callbacks from the underlying test framework
instead of <code class="literal">@PostConstruct</code> and <code class="literal">@PreDestroy</code>.</p>
</td></tr></table></div>

</div>
<div class="section" title="Spring JUnit Testing Annotations"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-junit"></a>Spring JUnit Testing Annotations</h4></div></div></div>

<p>The following annotations are <span class="emphasis"><em>only</em></span> supported when used in conjunction with the
<a class="link" href="#testcontext-junit4-runner" title="Spring JUnit Runner">SpringJUnit4ClassRunner</a> or the
<a class="link" href="#testcontext-support-classes-junit4" title="JUnit support classes">JUnit</a> support classes.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<p class="simpara"><code class="literal">@IfProfileValue</code></p>
<p class="simpara">Indicates that the annotated test is enabled for a specific testing environment. If the
configured <code class="literal">ProfileValueSource</code> returns a matching <code class="literal">value</code> for the provided <code class="literal">name</code>, the
test is enabled. This annotation can be applied to an entire class or to individual
methods. Class-level usage overrides method-level usage.</p>
<pre class="programlisting"><span class="strong"><strong>@IfProfileValue</strong></span>(<span class="strong"><strong>name</strong></span>=<span class="hl-string">"java.vendor"</span>, <span class="strong"><strong>value</strong></span>=<span class="hl-string">"Oracle Corporation"</span>)
<i><span class="hl-annotation" style="color: gray">@Test</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichRunsOnlyOnOracleJvm() {
    <span class="hl-comment">// some logic that should run only on Java VMs from Oracle Corporation</span>
}</pre>

<p class="simpara">Alternatively, you can configure <code class="literal">@IfProfileValue</code> with a list of <code class="literal">values</code> (with <span class="emphasis"><em>OR</em></span>
semantics) to achieve TestNG-like support for <span class="emphasis"><em>test groups</em></span> in a JUnit environment.
Consider the following example:</p>
<pre class="programlisting"><span class="strong"><strong>@IfProfileValue</strong></span>(<span class="strong"><strong>name</strong></span>=<span class="hl-string">"test-groups"</span>, <span class="strong"><strong>values</strong></span>={<span class="hl-string">"unit-tests"</span>, <span class="hl-string">"integration-tests"</span>})
<i><span class="hl-annotation" style="color: gray">@Test</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichRunsForUnitOrIntegrationTestGroups() {
    <span class="hl-comment">// some logic that should run only for unit and integration test groups</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@ProfileValueSourceConfiguration</code></p>
<p class="simpara">Class-level annotation that specifies what type of <code class="literal">ProfileValueSource</code> to use when
retrieving <span class="emphasis"><em>profile values</em></span> configured through the <code class="literal">@IfProfileValue</code> annotation. If
<code class="literal">@ProfileValueSourceConfiguration</code> is not declared for a test,
<code class="literal">SystemProfileValueSource</code> is used by default.</p>
<pre class="programlisting"><span class="strong"><strong>@ProfileValueSourceConfiguration</strong></span>(CustomProfileValueSource.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomProfileValueSourceTests {
    <span class="hl-comment">// class body...</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@Timed</code></p>
<p class="simpara">Indicates that the annotated test method must finish execution in a specified time
period (in milliseconds). If the text execution time exceeds the specified time period,
the test fails.</p>
<p class="simpara">The time period includes execution of the test method itself, any repetitions of the
test (see <code class="literal">@Repeat</code>), as well as any <span class="emphasis"><em>set up</em></span> or <span class="emphasis"><em>tear down</em></span> of the test fixture.</p>
<pre class="programlisting"><span class="strong"><strong>@Timed</strong></span>(millis=<span class="hl-number">1000</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWithOneSecondTimeout() {
    <span class="hl-comment">// some logic that should not take longer than 1 second to execute</span>
}</pre>

<p class="simpara">Spring&#8217;s <code class="literal">@Timed</code> annotation has different semantics than JUnit&#8217;s <code class="literal">@Test(timeout=...)</code>
support. Specifically, due to the manner in which JUnit handles test execution timeouts
(that is, by executing the test method in a separate <code class="literal">Thread</code>), <code class="literal">@Test(timeout=...)</code>
applies to <span class="emphasis"><em>each iteration</em></span> in the case of repetitions and preemptively fails the test
if the test takes too long. Spring&#8217;s <code class="literal">@Timed</code>, on the other hand, times the <span class="emphasis"><em>total</em></span>
test execution time (including all repetitions) and does not preemptively fail the test
but rather waits for the test to complete before failing.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@Repeat</code></p>
<p class="simpara">Indicates that the annotated test method must be executed repeatedly. The number of
times that the test method is to be executed is specified in the annotation.</p>
<p class="simpara">The scope of execution to be repeated includes execution of the test method itself as
well as any <span class="emphasis"><em>set up</em></span> or <span class="emphasis"><em>tear down</em></span> of the test fixture.</p>
<pre class="programlisting"><span class="strong"><strong>@Repeat</strong></span>(<span class="hl-number">10</span>)
<i><span class="hl-annotation" style="color: gray">@Test</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessRepeatedly() {
    <span class="hl-comment">// ...</span>
}</pre>

</li></ul></div>

</div>
<div class="section" title="Meta-Annotation Support for Testing"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-meta"></a>Meta-Annotation Support for Testing</h4></div></div></div>

<p>As of Spring Framework 4.0, it is now possible to use test-related annotations
as <a class="link" href="#beans-meta-annotations" title="4.10.2&nbsp;Meta-annotations">meta-annotations</a> in order to create custom
<span class="emphasis"><em>composed annotations</em></span> and reduce configuration duplication across a test suite.</p>
<p>Each of the following may be used as meta-annotations in conjunction with the
<a class="link" href="#testcontext-framework" title="10.3.5&nbsp;Spring TestContext Framework">TestContext framework</a>.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">@ContextConfiguration</code>
</li><li class="listitem">
<code class="literal">@ContextHierarchy</code>
</li><li class="listitem">
<code class="literal">@ActiveProfiles</code>
</li><li class="listitem">
<code class="literal">@DirtiesContext</code>
</li><li class="listitem">
<code class="literal">@WebAppConfiguration</code>
</li><li class="listitem">
<code class="literal">@TestExecutionListeners</code>
</li><li class="listitem">
<code class="literal">@Transactional</code>
</li><li class="listitem">
<code class="literal">@BeforeTransaction</code>
</li><li class="listitem">
<code class="literal">@AfterTransaction</code>
</li><li class="listitem">
<code class="literal">@TransactionConfiguration</code>
</li><li class="listitem">
<code class="literal">@Rollback</code>
</li><li class="listitem">
<code class="literal">@Repeat</code>
</li><li class="listitem">
<code class="literal">@Timed</code>
</li><li class="listitem">
<code class="literal">@IfProfileValue</code>
</li><li class="listitem">
<code class="literal">@ProfileValueSourceConfiguration</code>
</li></ul></div>

<p>For example, if we discover that we are repeating the following configuration
across our JUnit-based test suite&#8230;</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></i>
<i><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></i>
<i><span class="hl-annotation" style="color: gray">@Transactional</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderRepositoryTests { }

<i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></i>
<i><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></i>
<i><span class="hl-annotation" style="color: gray">@Transactional</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UserRepositoryTests { }</pre>

<p>We can reduce the above duplication by introducing a custom <span class="emphasis"><em>composed annotation</em></span>
that centralizes the common test configuration like this:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Target(ElementType.TYPE)</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></i>
<i><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></i>
<i><span class="hl-annotation" style="color: gray">@Transactional</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> TransactionalDevTest { }</pre>

<p>Then we can use our custom <code class="literal">@TransactionalDevTest</code> annotation to simplify the
configuration of individual test classes as follows:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@TransactionalDevTest</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderRepositoryTests { }

<i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@TransactionalDevTest</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UserRepositoryTests { }</pre>

</div>
</div>
<div class="section" title="10.3.5&nbsp;Spring TestContext Framework"><div class="titlepage"><div><div><h3 class="title"><a name="testcontext-framework"></a>10.3.5&nbsp;Spring TestContext Framework</h3></div></div></div>

<p>The <span class="emphasis"><em>Spring TestContext Framework</em></span> (located in the
<code class="literal">org.springframework.test.context</code> package) provides generic, annotation-driven unit and
integration testing support that is agnostic of the testing framework in use. The
TestContext framework also places a great deal of importance on <span class="emphasis"><em>convention over
configuration</em></span> with reasonable defaults that can be overridden through annotation-based
configuration.</p>
<p>In addition to generic testing infrastructure, the TestContext framework provides
explicit support for JUnit and TestNG in the form of <code class="literal">abstract</code> support classes. For
JUnit, Spring also provides a custom JUnit <code class="literal">Runner</code> that allows one to write so-called
<span class="emphasis"><em>POJO test classes</em></span>. POJO test classes are not required to extend a particular class
hierarchy.</p>
<p>The following section provides an overview of the internals of the TestContext
framework. If you are only interested in using the framework and not necessarily
interested in extending it with your own custom listeners or custom loaders, feel free
to go directly to the configuration (<a class="link" href="#testcontext-ctx-management" title="Context management">context management</a>,
<a class="link" href="#testcontext-fixture-di" title="Dependency injection of test fixtures">dependency injection</a>, <a class="link" href="#testcontext-tx" title="Transaction management">transaction
management</a>), <a class="link" href="#testcontext-support-classes" title="TestContext Framework support classes">support classes</a>, and
<a class="link" href="#integration-testing-annotations" title="10.3.4&nbsp;Annotations">annotation support</a> sections.</p>
<div class="section" title="Key abstractions"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-key-abstractions"></a>Key abstractions</h4></div></div></div>

<p>The core of the framework consists of the <code class="literal">TestContext</code> and <code class="literal">TestContextManager</code> classes
and the <code class="literal">TestExecutionListener</code>, <code class="literal">ContextLoader</code>, and <code class="literal">SmartContextLoader</code> interfaces. A
<code class="literal">TestContextManager</code> is created on a per-test basis (e.g., for the execution of a single
test method in JUnit). The <code class="literal">TestContextManager</code> in turn manages a <code class="literal">TestContext</code> that
holds the context of the current test. The <code class="literal">TestContextManager</code> also updates the state
of the <code class="literal">TestContext</code> as the test progresses and delegates to <code class="literal">TestExecutionListener</code> s,
which instrument the actual test execution by providing dependency injection, managing
transactions, and so on. A <code class="literal">ContextLoader</code> (or <code class="literal">SmartContextLoader</code>) is responsible for
loading an <code class="literal">ApplicationContext</code> for a given test class. Consult the Javadoc and the
Spring test suite for further information and examples of various implementations.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">TestContext</code>: Encapsulates the context in which a test is executed, agnostic of the
actual testing framework in use, and provides context management and caching support
for the test instance for which it is responsible. The <code class="literal">TestContext</code> also delegates to
a <code class="literal">ContextLoader</code> (or <code class="literal">SmartContextLoader</code>) to load an <code class="literal">ApplicationContext</code> if
requested.
</li><li class="listitem">
<p class="simpara"><code class="literal">TestContextManager</code>: The main entry point into the <span class="emphasis"><em>Spring TestContext Framework</em></span>,
which manages a single <code class="literal">TestContext</code> and signals events to all registered
<code class="literal">TestExecutionListener</code> s at well-defined test execution points:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
prior to any <span class="emphasis"><em>before class methods</em></span> of a particular testing framework
</li><li class="listitem">
test instance preparation
</li><li class="listitem">
prior to any <span class="emphasis"><em>before methods</em></span> of a particular testing framework
</li><li class="listitem">
after any <span class="emphasis"><em>after methods</em></span> of a particular testing framework
</li><li class="listitem">
after any <span class="emphasis"><em>after class methods</em></span> of a particular testing framework
</li></ul></div>

</li><li class="listitem">
<p class="simpara"><code class="literal">TestExecutionListener</code>: Defines a <span class="emphasis"><em>listener</em></span> API for reacting to test execution
events published by the <code class="literal">TestContextManager</code> with which the listener is registered.</p>
<p class="simpara">Spring provides four <code class="literal">TestExecutionListener</code> implementations that are configured by
default: <code class="literal">ServletTestExecutionListener</code>, <code class="literal">DependencyInjectionTestExecutionListener</code>,
<code class="literal">DirtiesContextTestExecutionListener</code>, and <code class="literal">TransactionalTestExecutionListener</code>.
Respectively, they support Servlet API mocks for a <code class="literal">WebApplicationContext</code>, dependency
injection of the test instance, handling of the <code class="literal">@DirtiesContext</code> annotation, and
transactional test execution with default rollback semantics.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">ContextLoader</code>: Strategy interface introduced in Spring 2.5 for loading an
<code class="literal">ApplicationContext</code> for an integration test managed by the Spring TestContext
Framework.</p>
<p class="simpara">As of Spring 3.1, implement <code class="literal">SmartContextLoader</code> instead of this interface in order to
provide support for annotated classes and active bean definition profiles.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">SmartContextLoader</code>: Extension of the <code class="literal">ContextLoader</code> interface introduced in Spring
3.1.</p>
<p class="simpara">The <code class="literal">SmartContextLoader</code> SPI supersedes the <code class="literal">ContextLoader</code> SPI that was introduced in
Spring 2.5. Specifically, a <code class="literal">SmartContextLoader</code> can choose to process resource
<code class="literal">locations</code>, annotated <code class="literal">classes</code>, or context <code class="literal">initializers</code>. Furthermore, a
<code class="literal">SmartContextLoader</code> can set active bean definition profiles in the context that it
loads.</p>
<p class="simpara">Spring provides the following implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">DelegatingSmartContextLoader</code>: one of two default loaders which delegates internally
to an <code class="literal">AnnotationConfigContextLoader</code> or a <code class="literal">GenericXmlContextLoader</code> depending either on
the configuration declared for the test class or on the presence of default locations or
default configuration classes.
</li><li class="listitem">
<code class="literal">WebDelegatingSmartContextLoader</code>: one of two default loaders which delegates
internally to an <code class="literal">AnnotationConfigWebContextLoader</code> or a <code class="literal">GenericXmlWebContextLoader</code>
depending either on the configuration declared for the test class or on the presence of
default locations or default configuration classes. A web <code class="literal">ContextLoader</code> will only be
used if <code class="literal">@WebAppConfiguration</code> is present on the test class.
</li><li class="listitem">
<code class="literal">AnnotationConfigContextLoader</code>: loads a standard <code class="literal">ApplicationContext</code> from
<span class="emphasis"><em>annotated classes</em></span>.
</li><li class="listitem">
<code class="literal">AnnotationConfigWebContextLoader</code>: loads a <code class="literal">WebApplicationContext</code> from <span class="emphasis"><em>annotated
classes</em></span>.
</li><li class="listitem">
<code class="literal">GenericXmlContextLoader</code>: loads a standard <code class="literal">ApplicationContext</code> from XML <span class="emphasis"><em>resource
locations</em></span>.
</li><li class="listitem">
<code class="literal">GenericXmlWebContextLoader</code>: loads a <code class="literal">WebApplicationContext</code> from XML <span class="emphasis"><em>resource
locations</em></span>.
</li><li class="listitem">
<code class="literal">GenericPropertiesContextLoader</code>: loads a standard <code class="literal">ApplicationContext</code> from Java
Properties files.
</li></ul></div>

</li></ul></div>

<p>The following sections explain how to configure the TestContext framework through
annotations and provide working examples of how to write unit and integration tests with
the framework.</p>
</div>
<div class="section" title="Context management"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-ctx-management"></a>Context management</h4></div></div></div>

<p>Each <code class="literal">TestContext</code> provides context management and caching support for the test instance
it is responsible for. Test instances do not automatically receive access to the
configured <code class="literal">ApplicationContext</code>. However, if a test class implements the
<code class="literal">ApplicationContextAware</code> interface, a reference to the <code class="literal">ApplicationContext</code> is supplied
to the test instance. Note that <code class="literal">AbstractJUnit4SpringContextTests</code> and
<code class="literal">AbstractTestNGSpringContextTests</code> implement <code class="literal">ApplicationContextAware</code> and therefore
provide access to the <code class="literal">ApplicationContext</code> automatically.</p>
<div class="tip" title="@Autowired ApplicationContext" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: @Autowired ApplicationContext"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">@Autowired ApplicationContext</th></tr><tr><td align="left" valign="top">

<p>As an alternative to implementing the <code class="literal">ApplicationContextAware</code> interface, you can
inject the application context for your test class through the <code class="literal">@Autowired</code> annotation
on either a field or setter method. For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {

    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">private</span> ApplicationContext applicationContext;

    <span class="hl-comment">// class body...</span>
}</pre>

<p>Similarly, if your test is configured to load a <code class="literal">WebApplicationContext</code>, you can inject
the web application context into your test as follows:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="strong"><strong>@WebAppConfiguration</strong></span>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebAppTest {
    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-comment">// class body...</span>
}</pre>

<p>Dependency injection via <code class="literal">@Autowired</code> is provided by the
<code class="literal">DependencyInjectionTestExecutionListener</code> which is configured by default (see
<a class="xref" href="#testcontext-fixture-di" title="Dependency injection of test fixtures">the section called &#8220;Dependency injection of test fixtures&#8221;</a>).</p>
</td></tr></table></div>

<p>Test classes that use the TestContext framework do not need to extend any particular
class or implement a specific interface to configure their application context. Instead,
configuration is achieved simply by declaring the <code class="literal">@ContextConfiguration</code> annotation at
the class level. If your test class does not explicitly declare application context
resource <code class="literal">locations</code> or annotated <code class="literal">classes</code>, the configured <code class="literal">ContextLoader</code> determines
how to load a context from a default location or default configuration classes. In
addition to context resource <code class="literal">locations</code> and annotated <code class="literal">classes</code>, an application context
can also be configured via application context <code class="literal">initializers</code>.</p>
<p>The following sections explain how to configure an <code class="literal">ApplicationContext</code> via XML
configuration files, annotated classes (typically <code class="literal">@Configuration</code> classes), or context
initializers using Spring&#8217;s <code class="literal">@ContextConfiguration</code> annotation. Alternatively, you can
implement and configure your own custom <code class="literal">SmartContextLoader</code> for advanced use cases.</p>
<div class="section" title="Context configuration with XML resources"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-xml"></a>Context configuration with XML resources</h5></div></div></div>

<p>To load an <code class="literal">ApplicationContext</code> for your tests using XML configuration files, annotate
your test class with <code class="literal">@ContextConfiguration</code> and configure the <code class="literal">locations</code> attribute
with an array that contains the resource locations of XML configuration metadata. A
plain or relative path&#8201;&#8212;&#8201;for example <code class="literal">"context.xml"</code>&#8201;&#8212;&#8201;will be treated as a classpath
resource that is relative to the package in which the test class is defined. A path
starting with a slash is treated as an absolute classpath location, for example
<code class="literal">"/org/example/config.xml"</code>. A path which represents a resource URL (i.e., a path
prefixed with <code class="literal">classpath:</code>, <code class="literal">file:</code>, <code class="literal">http:</code>, etc.) will be used <span class="emphasis"><em>as is</em></span>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be loaded from "/app-config.xml" and</span>
<span class="hl-comment">// "/test-config.xml" in the root of the classpath</span>
<span class="strong"><strong>@ContextConfiguration(locations={"/app-config.xml", "/test-config.xml"})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p><code class="literal">@ContextConfiguration</code> supports an alias for the <code class="literal">locations</code> attribute through the
standard Java <code class="literal">value</code> attribute. Thus, if you do not need to declare additional
attributes in <code class="literal">@ContextConfiguration</code>, you can omit the declaration of the <code class="literal">locations</code>
attribute name and declare the resource locations by using the shorthand format
demonstrated in the following example.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="strong"><strong>@ContextConfiguration({"/app-config.xml", "/test-config.xml"})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>If you omit both the <code class="literal">locations</code> and <code class="literal">value</code> attributes from the <code class="literal">@ContextConfiguration</code>
annotation, the TestContext framework will attempt to detect a default XML resource
location. Specifically, <code class="literal">GenericXmlContextLoader</code> detects a default location based on
the name of the test class. If your class is named <code class="literal">com.example.MyTest</code>,
<code class="literal">GenericXmlContextLoader</code> loads your application context from
<code class="literal">"classpath:/com/example/MyTest-context.xml"</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.example;

<i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be loaded from</span>
<span class="hl-comment">// "classpath:/com/example/MyTest-context.xml"</span>
<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

</div>
<div class="section" title="Context configuration with annotated classes"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-javaconfig"></a>Context configuration with annotated classes</h5></div></div></div>

<p>To load an <code class="literal">ApplicationContext</code> for your tests using <span class="emphasis"><em>annotated classes</em></span> (see
<a class="xref" href="#beans-java" title="4.12&nbsp;Java-based container configuration">Section&nbsp;4.12, &#8220;Java-based container configuration&#8221;</a>), annotate your test class with <code class="literal">@ContextConfiguration</code> and configure the
<code class="literal">classes</code> attribute with an array that contains references to annotated classes.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be loaded from AppConfig and TestConfig</span>
<span class="strong"><strong>@ContextConfiguration(classes = {AppConfig.class, TestConfig.class})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="tip" title="Annotated Classes" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: Annotated Classes"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Annotated Classes</th></tr><tr><td align="left" valign="top">

<p>The term <span class="emphasis"><em>annotated class</em></span> can refer to any of the following.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
A class annotated with <code class="literal">@Configuration</code>
</li><li class="listitem">
A component (i.e., a class annotated with <code class="literal">@Component</code>, <code class="literal">@Service</code>, <code class="literal">@Repository</code>, etc.)
</li><li class="listitem">
A JSR-330 compliant class that is annotated with <code class="literal">javax.inject</code> annotations
</li><li class="listitem">
Any other class that contains <code class="literal">@Bean</code>-methods
</li></ul></div>

<p>Consult the Javadoc for <code class="literal">@Configuration</code> and <code class="literal">@Bean</code> for further information regarding
the configuration and semantics of <span class="emphasis"><em>annotated classes</em></span>, paying special attention to
the discussion of <span class="emphasis"><em> <code class="literal">@Bean</code> Lite Mode</em></span>.</p>
</td></tr></table></div>

<p>If you omit the <code class="literal">classes</code> attribute from the <code class="literal">@ContextConfiguration</code> annotation, the
TestContext framework will attempt to detect the presence of default configuration
classes. Specifically, <code class="literal">AnnotationConfigContextLoader</code> will detect all static inner
classes of the test class that meet the requirements for configuration class
implementations as specified in the Javadoc for <code class="literal">@Configuration</code>. In the following
example, the <code class="literal">OrderServiceTest</code> class declares a static inner configuration class named
<code class="literal">Config</code> that will be automatically used to load the <code class="literal">ApplicationContext</code> for the test
class. Note that the name of the configuration class is arbitrary. In addition, a test
class can contain more than one static inner configuration class if desired.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be loaded from the</span>
<span class="hl-comment">// static inner Config class</span>
<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderServiceTest {

    <i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
    <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> Config {

        <span class="hl-comment">// this bean will be injected into the OrderServiceTest class</span>
        <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
        <span class="hl-keyword">public</span> OrderService orderService() {
            OrderService orderService = <span class="hl-keyword">new</span> OrderServiceImpl();
            <span class="hl-comment">// set properties, etc.</span>
            <span class="hl-keyword">return</span> orderService;
        }
    }

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> OrderService orderService;

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testOrderService() {
        <span class="hl-comment">// test the orderService</span>
    }

}</pre>

</div>
<div class="section" title="Mixing XML resources and annotated classes"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-mixed-config"></a>Mixing XML resources and annotated classes</h5></div></div></div>

<p>It may sometimes be desirable to mix XML resources and annotated classes (i.e.,
typically <code class="literal">@Configuration</code> classes) to configure an <code class="literal">ApplicationContext</code> for your tests.
For example, if you use XML configuration in production, you may decide that you want to
use <code class="literal">@Configuration</code> classes to configure specific Spring-managed components for your
tests, or vice versa. As mentioned in <a class="xref" href="#integration-testing-annotations-spring" title="Spring Testing Annotations">the section called &#8220;Spring Testing Annotations&#8221;</a> the
TestContext framework does not allow you to declare <span class="emphasis"><em>both</em></span> via
<code class="literal">@ContextConfiguration</code>, but this does not mean that you cannot use both.</p>
<p>If you want to use XML <span class="emphasis"><em>and</em></span> <code class="literal">@Configuration</code> classes to configure your tests, you
will have to pick one as the <span class="emphasis"><em>entry point</em></span>, and that one will have to include or
import the other. For example, in XML you can include <code class="literal">@Configuration</code> classes via
component scanning or define them as normal Spring beans in XML; whereas, in a
<code class="literal">@Configuration</code> class you can use <code class="literal">@ImportResource</code> to import XML configuration files.
Note that this behavior is semantically equivalent to how you configure your application
in production: in production configuration you will define either a set of XML resource
locations or a set of <code class="literal">@Configuration</code> classes that your production <code class="literal">ApplicationContext</code>
will be loaded from, but you still have the freedom to include or import the other type
of configuration.</p>
</div>
<div class="section" title="Context configuration with context initializers"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-initializers"></a>Context configuration with context initializers</h5></div></div></div>

<p>To configure an <code class="literal">ApplicationContext</code> for your tests using context initializers, annotate
your test class with <code class="literal">@ContextConfiguration</code> and configure the <code class="literal">initializers</code> attribute
with an array that contains references to classes that implement
<code class="literal">ApplicationContextInitializer</code>. The declared context initializers will then be used to
initialize the <code class="literal">ConfigurableApplicationContext</code> that is loaded for your tests. Note that
the concrete <code class="literal">ConfigurableApplicationContext</code> type supported by each declared
initializer must be compatible with the type of <code class="literal">ApplicationContext</code> created by the
<code class="literal">SmartContextLoader</code> in use (i.e., typically a <code class="literal">GenericApplicationContext</code>).
Furthermore, the order in which the initializers are invoked depends on whether they
implement Spring&#8217;s <code class="literal">Ordered</code> interface or are annotated with Spring&#8217;s <code class="literal">@Order</code>
annotation.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be loaded from TestConfig</span>
<span class="hl-comment">// and initialized by TestAppCtxInitializer</span>
<span class="strong"><strong>@ContextConfiguration(
    classes = TestConfig.class,
    initializers = TestAppCtxInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>It is also possible to omit the declaration of XML configuration files or annotated
classes in <code class="literal">@ContextConfiguration</code> entirely and instead declare only
<code class="literal">ApplicationContextInitializer</code> classes which are then responsible for registering beans
in the context&#8201;&#8212;&#8201;for example, by programmatically loading bean definitions from XML
files or configuration classes.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be initialized by EntireAppInitializer</span>
<span class="hl-comment">// which presumably registers beans in the context</span>
<span class="strong"><strong>@ContextConfiguration(initializers = EntireAppInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

</div>
<div class="section" title="Context configuration inheritance"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-inheritance"></a>Context configuration inheritance</h5></div></div></div>

<p><code class="literal">@ContextConfiguration</code> supports boolean <code class="literal">inheritLocations</code> and <code class="literal">inheritInitializers</code>
attributes that denote whether resource locations or annotated classes and context
initializers declared by superclasses should be <span class="emphasis"><em>inherited</em></span>. The default value for
both flags is <code class="literal">true</code>. This means that a test class inherits the resource locations or
annotated classes as well as the context initializers declared by any superclasses.
Specifically, the resource locations or annotated classes for a test class are appended
to the list of resource locations or annotated classes declared by superclasses.
Similarly, the initializers for a given test class will be added to the set of
initializers defined by test superclasses. Thus, subclasses have the option
of <span class="emphasis"><em>extending</em></span> the resource locations, annotated classes, or context initializers.</p>
<p>If <code class="literal">@ContextConfiguration</code>'s <code class="literal">inheritLocations</code> or <code class="literal">inheritInitializers</code> attribute is
set to <code class="literal">false</code>, the resource locations or annotated classes and the context
initializers, respectively, for the test class <span class="emphasis"><em>shadow</em></span> and effectively replace the
configuration defined by superclasses.</p>
<p>In the following example that uses XML resource locations, the <code class="literal">ApplicationContext</code> for
<code class="literal">ExtendedTest</code> will be loaded from <span class="emphasis"><em>"base-config.xml"</em></span> <span class="emphasis"><em>and</em></span>
<span class="emphasis"><em>"extended-config.xml"</em></span>, in that order. Beans defined in <span class="emphasis"><em>"extended-config.xml"</em></span> may
therefore <span class="emphasis"><em>override</em></span> (i.e., replace) those defined in <span class="emphasis"><em>"base-config.xml"</em></span>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be loaded from "/base-config.xml"</span>
<span class="hl-comment">// in the root of the classpath</span>
<span class="strong"><strong>@ContextConfiguration("/base-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-comment">// ApplicationContext will be loaded from "/base-config.xml" and</span>
<span class="hl-comment">// "/extended-config.xml" in the root of the classpath</span>
<span class="strong"><strong>@ContextConfiguration("/extended-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>Similarly, in the following example that uses annotated classes, the
<code class="literal">ApplicationContext</code> for <code class="literal">ExtendedTest</code> will be loaded from the <code class="literal">BaseConfig</code> <span class="emphasis"><em>and</em></span>
<code class="literal">ExtendedConfig</code> classes, in that order. Beans defined in <code class="literal">ExtendedConfig</code> may therefore
override (i.e., replace) those defined in <code class="literal">BaseConfig</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be loaded from BaseConfig</span>
<span class="strong"><strong>@ContextConfiguration(classes = BaseConfig.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-comment">// ApplicationContext will be loaded from BaseConfig and ExtendedConfig</span>
<span class="strong"><strong>@ContextConfiguration(classes = ExtendedConfig.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>In the following example that uses context initializers, the <code class="literal">ApplicationContext</code> for
<code class="literal">ExtendedTest</code> will be initialized using <code class="literal">BaseInitializer</code> <span class="emphasis"><em>and</em></span>
<code class="literal">ExtendedInitializer</code>. Note, however, that the order in which the initializers are
invoked depends on whether they implement Spring&#8217;s <code class="literal">Ordered</code> interface or are annotated
with Spring&#8217;s <code class="literal">@Order</code> annotation.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be initialized by BaseInitializer</span>
<span class="strong"><strong>@ContextConfiguration(initializers=BaseInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-comment">// ApplicationContext will be initialized by BaseInitializer</span>
<span class="hl-comment">// and ExtendedInitializer</span>
<span class="strong"><strong>@ContextConfiguration(initializers=ExtendedInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}</pre>

</div>
<div class="section" title="Context configuration with environment profiles"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-env-profiles"></a>Context configuration with environment profiles</h5></div></div></div>

<p>Spring 3.1 introduced first-class support in the framework for the notion of
environments and profiles (a.k.a., <span class="emphasis"><em>bean definition profiles</em></span>), and integration tests
can be configured to activate particular bean definition profiles for various testing
scenarios. This is achieved by annotating a test class with the <code class="literal">@ActiveProfiles</code>
annotation and supplying a list of profiles that should be activated when loading the
<code class="literal">ApplicationContext</code> for the test.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@ActiveProfiles</code> may be used with any implementation of the new <code class="literal">SmartContextLoader</code>
SPI, but <code class="literal">@ActiveProfiles</code> is not supported with implementations of the older
<code class="literal">ContextLoader</code> SPI.</p>
</td></tr></table></div>

<p>Let&#8217;s take a look at some examples with XML configuration and <code class="literal">@Configuration</code> classes.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- app-config.xml --&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:jdbc</span>=<span class="hl-value">"http://www.springframework.org/schema/jdbc"</span>
    <span class="hl-attribute">xmlns:jee</span>=<span class="hl-value">"http://www.springframework.org/schema/jee"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transferService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.service.internal.DefaultTransferService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountRepository"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"feePolicy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountRepository"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.repository.internal.JdbcAccountRepository"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"feePolicy"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.service.internal.ZeroFeePolicy"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"dev"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jdbc:embedded-database</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/schema.sql"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/test-data.sql"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/jdbc:embedded-database&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"production"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/datasource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"default"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jdbc:embedded-database</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/schema.sql"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/jdbc:embedded-database&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// ApplicationContext will be loaded from "classpath:/app-config.xml"</span>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("/app-config.xml")</span></i>
<i><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> TransferService transferService;

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// test the transferService</span>
    }
}</pre>

<p>When <code class="literal">TransferServiceTest</code> is run, its <code class="literal">ApplicationContext</code> will be loaded from the
<code class="literal">app-config.xml</code> configuration file in the root of the classpath. If you inspect
<code class="literal">app-config.xml</code> you&#8217;ll notice that the <code class="literal">accountRepository</code> bean has a dependency on a
<code class="literal">dataSource</code> bean; however, <code class="literal">dataSource</code> is not defined as a top-level bean. Instead,
<code class="literal">dataSource</code> is defined three times: in the <span class="emphasis"><em>production</em></span> profile, the
<span class="emphasis"><em>dev</em></span> profile, and the <span class="emphasis"><em>default</em></span> profile.</p>
<p>By annotating <code class="literal">TransferServiceTest</code> with <code class="literal">@ActiveProfiles("dev")</code> we instruct the Spring
TestContext Framework to load the <code class="literal">ApplicationContext</code> with the active profiles set to
<code class="literal">{"dev"}</code>. As a result, an embedded database will be created and populated with test data,
and the <code class="literal">accountRepository</code> bean will be wired with a reference to the development
<code class="literal">DataSource</code>. And that&#8217;s likely what we want in an integration test.</p>
<p>It is sometimes useful to assign beans to a <code class="literal">default</code> profile. Beans within the default profile
are only included when no other profile is specifically activated. This can be used to define
<span class="emphasis"><em>fallback</em></span> beans to be used in the application&#8217;s default state. For example, you may
explicitly provide a data source for <code class="literal">dev</code> and <code class="literal">production</code> profiles, but define an in-memory
data source as a default when neither of these is active.</p>
<p>The following code listings demonstrate how to implement the same configuration and
integration test but using <code class="literal">@Configuration</code> classes instead of XML.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@Profile("dev")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> StandaloneDataConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/schema.sql"</span>)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/test-data.sql"</span>)
            .build();
    }
}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@Profile("production")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JndiDataConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> DataSource dataSource() <span class="hl-keyword">throws</span> Exception {
        Context ctx = <span class="hl-keyword">new</span> InitialContext();
        <span class="hl-keyword">return</span> (DataSource) ctx.lookup(<span class="hl-string">"java:comp/env/jdbc/datasource"</span>);
    }
}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@Profile("default")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultDataConfig {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/schema.sql"</span>)
            .build();
    }
}</pre>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceConfig {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i> DataSource dataSource;

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> TransferService transferService() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultTransferService(accountRepository(), feePolicy());
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> AccountRepository accountRepository() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcAccountRepository(dataSource);
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> FeePolicy feePolicy() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ZeroFeePolicy();
    }

}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = {
        TransferServiceConfig.class,
        StandaloneDataConfig.class,
        JndiDataConfig.class,
        DefaultDataConfig.class})</span></i>
<i><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> TransferService transferService;

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// test the transferService</span>
    }
}</pre>

<p>In this variation, we have split the XML configuration into four independent
<code class="literal">@Configuration</code> classes:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">TransferServiceConfig</code>: acquires a <code class="literal">dataSource</code> via dependency injection using
<code class="literal">@Autowired</code>
</li><li class="listitem">
<code class="literal">StandaloneDataConfig</code>: defines a <code class="literal">dataSource</code> for an embedded database suitable for
developer tests
</li><li class="listitem">
<code class="literal">JndiDataConfig</code>: defines a <code class="literal">dataSource</code> that is retrieved from JNDI in a production
environment
</li><li class="listitem">
<code class="literal">DefaultDataConfig</code>: defines a <code class="literal">dataSource</code> for a default embedded database in case
no profile is active
</li></ul></div>

<p>As with the XML-based configuration example, we still annotate <code class="literal">TransferServiceTest</code>
with <code class="literal">@ActiveProfiles("dev")</code>, but this time we specify all four configuration classes
via the <code class="literal">@ContextConfiguration</code> annotation. The body of the test class itself remains
completely unchanged.</p>
<p>It is often the case that a single set of profiles is used across multiple test classes
within a given project. Thus, to avoid duplicate declarations of the <code class="literal">@ActiveProfiles</code>
annotation it is possible to declare <code class="literal">@ActiveProfiles</code> once on a base class, and
subclasses will automatically inherit the <code class="literal">@ActiveProfiles</code> configuration from the base
class. In the following example, the declaration of <code class="literal">@ActiveProfiles</code> (as well as other
annotations) has been moved to an abstract superclass, <code class="literal">AbstractIntegrationTest</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = {
        TransferServiceConfig.class,
        StandaloneDataConfig.class,
        JndiDataConfig.class,
        DefaultDataConfig.class})</span></i>
<i><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractIntegrationTest {
}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// "dev" profile inherited from superclass</span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> TransferService transferService;

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// test the transferService</span>
    }
}</pre>

<p><code class="literal">@ActiveProfiles</code> also supports an <code class="literal">inheritProfiles</code> attribute that can be used to
disable the inheritance of active profiles.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// "dev" profile overridden with "production"</span>
<i><span class="hl-annotation" style="color: gray">@ActiveProfiles(profiles = "production", inheritProfiles = false)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductionTransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {
    <span class="hl-comment">// test body</span>
}</pre>

<p><a name="testcontext-ctx-management-env-profiles-ActiveProfilesResolver"></a>Furthermore, it is sometimes necessary to resolve active profiles for tests
<span class="emphasis"><em>programmatically</em></span> instead of declaratively&#8201;&#8212;&#8201;for example, based on:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
the current operating system
</li><li class="listitem">
whether tests are being executed on a continuous integration build server
</li><li class="listitem">
the presence of certain environment variables
</li><li class="listitem">
the presence of custom class-level annotations
</li><li class="listitem">
etc.
</li></ul></div>

<p>To resolve active bean definition profiles programmatically, simply implement a custom
<code class="literal">ActiveProfilesResolver</code> and register it via the <code class="literal">resolver</code> attribute of
<code class="literal">@ActiveProfiles</code>. The following example demonstrates how to implement and register a
custom <code class="literal">OperatingSystemActiveProfilesResolver</code>. For further information, refer to the
respective Javadoc.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// "dev" profile overridden programmatically via a custom resolver</span>
<i><span class="hl-annotation" style="color: gray">@ActiveProfiles(
    resolver = OperatingSystemActiveProfilesResolver.class,
    inheritProfiles = false)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {
    <span class="hl-comment">// test body</span>
}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service.test;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OperatingSystemActiveProfilesResolver <span class="hl-keyword">implements</span> ActiveProfilesResolver {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    String[] resolve(Class&lt;?&gt; testClass) {
        String profile = ...;
        <span class="hl-comment">// determine the value of profile based on the operating system</span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String[] {profile};
    }
}</pre>

</div>
<div class="section" title="Loading a WebApplicationContext"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-web"></a>Loading a WebApplicationContext</h5></div></div></div>

<p>Spring 3.2 introduced support for loading a <code class="literal">WebApplicationContext</code> in integration
tests. To instruct the TestContext framework to load a <code class="literal">WebApplicationContext</code> instead
of a standard <code class="literal">ApplicationContext</code>, simply annotate the respective test class with
<code class="literal">@WebAppConfiguration</code>.</p>
<p>The presence of <code class="literal">@WebAppConfiguration</code> on your test class instructs the TestContext
framework (TCF) that a <code class="literal">WebApplicationContext</code> (WAC) should be loaded for your
integration tests. In the background the TCF makes sure that a <code class="literal">MockServletContext</code> is
created and supplied to your test&#8217;s WAC. By default the base resource path for your
<code class="literal">MockServletContext</code> will be set to <span class="emphasis"><em>"src/main/webapp"</em></span>. This is interpreted as a path
relative to the root of your JVM (i.e., normally the path to your project). If you&#8217;re
familiar with the directory structure of a web application in a Maven project, you&#8217;ll
know that <span class="emphasis"><em>"src/main/webapp"</em></span> is the default location for the root of your WAR. If you
need to override this default, simply provide an alternate path to the
<code class="literal">@WebAppConfiguration</code> annotation (e.g., <code class="literal">@WebAppConfiguration("src/test/webapp")</code>). If
you wish to reference a base resource path from the classpath instead of the file
system, just use Spring&#8217;s <span class="emphasis"><em>classpath:</em></span> prefix.</p>
<p>Please note that Spring&#8217;s testing support for <code class="literal">WebApplicationContexts</code> is on par with
its support for standard <code class="literal">ApplicationContexts</code>. When testing with a
<code class="literal">WebApplicationContext</code> you are free to declare either XML configuration files or
<code class="literal">@Configuration</code> classes via <code class="literal">@ContextConfiguration</code>. You are of course also free to use
any other test annotations such as <code class="literal">@TestExecutionListeners</code>,
<code class="literal">@TransactionConfiguration</code>, <code class="literal">@ActiveProfiles</code>, etc.</p>
<p>The following examples demonstrate some of the various configuration options for loading
a <code class="literal">WebApplicationContext</code>.</p>
<p title="Conventions">
<b>Conventions.&nbsp;</b>

</p><pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>

<span class="hl-comment">// defaults to "file:src/main/webapp"</span>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>

<span class="hl-comment">// detects "WacTests-context.xml" in same package</span>
<span class="hl-comment">// or static nested @Configuration class</span>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p title="Conventions">

</p>

<p>The above example demonstrates the TestContext framework&#8217;s support for <span class="emphasis"><em>convention over
configuration</em></span>. If you annotate a test class with <code class="literal">@WebAppConfiguration</code> without
specifying a resource base path, the resource path will effectively default
to <span class="emphasis"><em>"file:src/main/webapp"</em></span>. Similarly, if you declare <code class="literal">@ContextConfiguration</code> without
specifying resource <code class="literal">locations</code>, annotated <code class="literal">classes</code>, or context <code class="literal">initializers</code>, Spring
will attempt to detect the presence of your configuration using conventions
(i.e., <span class="emphasis"><em>"WacTests-context.xml"</em></span> in the same package as the <code class="literal">WacTests</code> class or static
nested <code class="literal">@Configuration</code> classes).</p>
<p title="Default resource semantics">
<b>Default resource semantics.&nbsp;</b>

</p><pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>

<span class="hl-comment">// file system resource</span>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration("webapp")</span></i>

<span class="hl-comment">// classpath resource</span>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("/spring/test-servlet-config.xml")</span></i>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p title="Default resource semantics">

</p>

<p>This example demonstrates how to explicitly declare a resource base path with
<code class="literal">@WebAppConfiguration</code> and an XML resource location with <code class="literal">@ContextConfiguration</code>. The
important thing to note here is the different semantics for paths with these two
annotations. By default, <code class="literal">@WebAppConfiguration</code> resource paths are file system based;
whereas, <code class="literal">@ContextConfiguration</code> resource locations are classpath based.</p>
<p title="Explicit resource semantics">
<b>Explicit resource semantics.&nbsp;</b>

</p><pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>

<span class="hl-comment">// classpath resource</span>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration("classpath:test-web-resources")</span></i>

<span class="hl-comment">// file system resource</span>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("file:src/main/webapp/WEB-INF/servlet-config.xml")</span></i>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p title="Explicit resource semantics">

</p>

<p>In this third example, we see that we can override the default resource semantics for
both annotations by specifying a Spring resource prefix. Contrast the comments in this
example with the previous example.</p>
<p>To provide comprehensive web testing support, Spring 3.2 introduced a
<code class="literal">ServletTestExecutionListener</code> that is enabled by default. When testing against a
<code class="literal">WebApplicationContext</code> this <a class="link" href="#testcontext-key-abstractions" title="Key abstractions">TestExecutionListener</a> sets
up default thread-local state via Spring Web&#8217;s <code class="literal">RequestContextHolder</code> before each test
method and creates a <code class="literal">MockHttpServletRequest</code>, <code class="literal">MockHttpServletResponse</code>, and
<code class="literal">ServletWebRequest</code> based on the base resource path configured via
<code class="literal">@WebAppConfiguration</code>. <code class="literal">ServletTestExecutionListener</code> also ensures that the
<code class="literal">MockHttpServletResponse</code> and <code class="literal">ServletWebRequest</code> can be injected into the test
instance, and once the test is complete it cleans up thread-local state.</p>
<p>Once you have a <code class="literal">WebApplicationContext</code> loaded for your test you might find that you
need to interact with the web mocks&#8201;&#8212;&#8201;for example, to set up your test fixture or to
perform assertions after invoking your web component. The following example demonstrates
which mocks can be autowired into your test instance. Note that the
<code class="literal">WebApplicationContext</code> and <code class="literal">MockServletContext</code> are both cached across the test suite;
whereas, the other mocks are managed per test method by the
<code class="literal">ServletTestExecutionListener</code>.</p>
<p title="Injecting mocks">
<b>Injecting mocks.&nbsp;</b>

</p><pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    WebApplicationContext wac; <span class="hl-comment">// cached</span>

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    MockServletContext servletContext; <span class="hl-comment">// cached</span>

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    MockHttpSession session;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    MockHttpServletRequest request;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    MockHttpServletResponse response;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    ServletWebRequest webRequest;

    <span class="hl-comment">//...</span>
}</pre><p title="Injecting mocks">

</p>

</div>
<div class="section" title="Context caching"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-caching"></a>Context caching</h5></div></div></div>

<p>Once the TestContext framework loads an <code class="literal">ApplicationContext</code> (or
<code class="literal">WebApplicationContext</code>) for a test, that context will be cached and reused for <span class="emphasis"><em>all</em></span>
subsequent tests that declare the same unique context configuration within the same test
suite. To understand how caching works, it is important to understand what is meant by
<span class="emphasis"><em>unique</em></span> and <span class="emphasis"><em>test suite</em></span>.</p>
<p>An <code class="literal">ApplicationContext</code> can be <span class="emphasis"><em>uniquely</em></span> identified by the combination of
configuration parameters that are used to load it. Consequently, the unique combination
of configuration parameters are used to generate a <span class="emphasis"><em>key</em></span> under which the context is
cached. The TestContext framework uses the following configuration parameters to build
the context cache key:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">locations</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">classes</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">contextInitializerClasses</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">contextLoader</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">activeProfiles</code> <span class="emphasis"><em>(from @ActiveProfiles)</em></span>
</li><li class="listitem">
<code class="literal">resourceBasePath</code> <span class="emphasis"><em>(from @WebAppConfiguration)</em></span>
</li></ul></div>

<p>For example, if <code class="literal">TestClassA</code> specifies <code class="literal">{"app-config.xml", "test-config.xml"}</code> for the
<code class="literal">locations</code> (or <code class="literal">value</code>) attribute of <code class="literal">@ContextConfiguration</code>, the TestContext framework
will load the corresponding <code class="literal">ApplicationContext</code> and store it in a <code class="literal">static</code> context
cache under a key that is based solely on those locations. So if <code class="literal">TestClassB</code> also
defines <code class="literal">{"app-config.xml", "test-config.xml"}</code> for its locations (either explicitly or
implicitly through inheritance) but does not define <code class="literal">@WebAppConfiguration</code>, a different
<code class="literal">ContextLoader</code>, different active profiles, or different context initializers, then the
same <code class="literal">ApplicationContext</code> will be shared by both test classes. This means that the setup
cost for loading an application context is incurred only once (per test suite), and
subsequent test execution is much faster.</p>
<div class="note" title="Test suites and forked processes" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Test suites and forked processes"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Test suites and forked processes</th></tr><tr><td align="left" valign="top">

<p>The Spring TestContext framework stores application contexts in a <span class="emphasis"><em>static</em></span> cache. This
means that the context is literally stored in a <code class="literal">static</code> variable. In other words, if
tests execute in separate processes the static cache will be cleared between each test
execution, and this will effectively disable the caching mechanism.</p>
<p>To benefit from the caching mechanism, all tests must run within the same process or
test suite. This can be achieved by executing all tests as a group within an IDE.
Similarly, when executing tests with a build framework such as Ant, Maven, or Gradle it
is important to make sure that the build framework does not <span class="emphasis"><em>fork</em></span> between tests. For
example, if the
<a class="ulink" href="http://maven.apache.org/plugins/maven-surefire-plugin/test-mojo.html#forkMode" target="_top">forkMode</a>
for the Maven Surefire plug-in is set to <code class="literal">always</code> or <code class="literal">pertest</code>, the TestContext
framework will not be able to cache application contexts between test classes and the
build process will run significantly slower as a result.</p>
</td></tr></table></div>

<p>In the unlikely case that a test corrupts the application context and requires reloading&#8201;&#8212;&#8201;for example, by modifying a bean definition or the state of an application object&#8201;&#8212;&#8201;you can annotate your test class or test method with <code class="literal">@DirtiesContext</code> (see the
discussion of <code class="literal">@DirtiesContext</code> in <a class="xref" href="#integration-testing-annotations-spring" title="Spring Testing Annotations">the section called &#8220;Spring Testing Annotations&#8221;</a>). This
instructs Spring to remove the context from the cache and rebuild the application
context before executing the next test. Note that support for the <code class="literal">@DirtiesContext</code>
annotation is provided by the <code class="literal">DirtiesContextTestExecutionListener</code> which is enabled by
default.</p>
</div>
<div class="section" title="Context hierarchies"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-ctx-hierarchies"></a>Context hierarchies</h5></div></div></div>

<p>When writing integration tests that rely on a loaded Spring <code class="literal">ApplicationContext</code>, it is
often sufficient to test against a single context; however, there are times when it is
beneficial or even necessary to test against a hierarchy of <code class="literal">ApplicationContext</code> s. For
example, if you are developing a Spring MVC web application you will typically have a
root <code class="literal">WebApplicationContext</code> loaded via Spring&#8217;s <code class="literal">ContextLoaderListener</code> and a child
<code class="literal">WebApplicationContext</code> loaded via Spring&#8217;s <code class="literal">DispatcherServlet</code>. This results in a
parent-child context hierarchy where shared components and infrastructure configuration
are declared in the root context and consumed in the child context by web-specific
components. Another use case can be found in Spring Batch applications where you often
have a parent context that provides configuration for shared batch infrastructure and a
child context for the configuration of a specific batch job.</p>
<p>As of Spring Framework 3.2.2, it is possible to write integration tests that use context
hierarchies by declaring context configuration via the <code class="literal">@ContextHierarchy</code> annotation,
either on an individual test class or within a test class hierarchy. If a context
hierarchy is declared on multiple classes within a test class hierarchy it is also
possible to merge or override the context configuration for a specific, named level in
the context hierarchy. When merging configuration for a given level in the hierarchy the
configuration resource type (i.e., XML configuration files or annotated classes) must be
consistent; otherwise, it is perfectly acceptable to have different levels in a context
hierarchy configured using different resource types.</p>
<p>The following JUnit-based examples demonstrate common configuration scenarios for
integration tests that require the use of context hierarchies.</p>
<p><code class="literal">ControllerIntegrationTests</code> represents a typical integration testing scenario for a
Spring MVC web application by declaring a context hierarchy consisting of two levels,
one for the <span class="emphasis"><em>root</em></span> WebApplicationContext (loaded using the <code class="literal">TestAppConfig</code>
<code class="literal">@Configuration</code> class) and one for the <span class="emphasis"><em>dispatcher servlet</em></span> <code class="literal">WebApplicationContext</code>
(loaded using the <code class="literal">WebConfig</code> <code class="literal">@Configuration</code> class). The <code class="literal">WebApplicationContext</code> that
is <span class="emphasis"><em>autowired</em></span> into the test instance is the one for the child context (i.e., the
lowest context in the hierarchy).</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(classes = TestAppConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ControllerIntegrationTests {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-comment">// ...</span>
}</pre>

<p>The following test classes define a context hierarchy within a test class hierarchy.
<code class="literal">AbstractWebTests</code> declares the configuration for a root <code class="literal">WebApplicationContext</code> in a
Spring-powered web application. Note, however, that <code class="literal">AbstractWebTests</code> does not declare
<code class="literal">@ContextHierarchy</code>; consequently, subclasses of <code class="literal">AbstractWebTests</code> can optionally
participate in a context hierarchy or simply follow the standard semantics for
<code class="literal">@ContextConfiguration</code>. <code class="literal">SoapWebServiceTests</code> and <code class="literal">RestWebServiceTests</code> both extend
<code class="literal">AbstractWebTests</code> and define a context hierarchy via <code class="literal">@ContextHierarchy</code>. The result is
that three application contexts will be loaded (one for each declaration of
<code class="literal">@ContextConfiguration</code>), and the application context loaded based on the configuration
in <code class="literal">AbstractWebTests</code> will be set as the parent context for each of the contexts loaded
for the concrete subclasses.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("file:src/main/webapp/WEB-INF/applicationContext.xml")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractWebTests {}

@ContextHierarchy(<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("/spring/soap-ws-config.xml")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SoapWebServiceTests <span class="hl-keyword">extends</span> AbstractWebTests {}

@ContextHierarchy(<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("/spring/rest-ws-config.xml")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RestWebServiceTests <span class="hl-keyword">extends</span> AbstractWebTests {}</pre>

<p>The following classes demonstrate the use of <span class="emphasis"><em>named</em></span> hierarchy levels in order to
<span class="emphasis"><em>merge</em></span> the configuration for specific levels in a context hierarchy. <code class="literal">BaseTests</code>
defines two levels in the hierarchy, <code class="literal">parent</code> and <code class="literal">child</code>. <code class="literal">ExtendedTests</code> extends
<code class="literal">BaseTests</code> and instructs the Spring TestContext Framework to merge the context
configuration for the <code class="literal">child</code> hierarchy level, simply by ensuring that the names
declared via <code class="literal">ContextConfiguration</code>'s <code class="literal">name</code> attribute are both <code class="literal">"child"</code>. The result is
that three application contexts will be loaded: one for <code class="literal">"/app-config.xml"</code>, one for
<code class="literal">"/user-config.xml"</code>, and one for <code class="literal">{"/user-config.xml", "/order-config.xml"}</code>. As with
the previous example, the application context loaded from <code class="literal">"/app-config.xml"</code> will be
set as the parent context for the contexts loaded from <code class="literal">"/user-config.xml"</code> and
<code class="literal">{"/user-config.xml", "/order-config.xml"}</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(name = "parent", locations = "/app-config.xml"),
    @ContextConfiguration(name = "child", locations = "/user-config.xml")
})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTests {}

<i><span class="hl-annotation" style="color: gray">@ContextHierarchy(
    @ContextConfiguration(name = "child", locations = "/order-config.xml")
)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTests <span class="hl-keyword">extends</span> BaseTests {}</pre>

<p>In contrast to the previous example, this example demonstrates how to <span class="emphasis"><em>override</em></span> the
configuration for a given named level in a context hierarchy by setting
<code class="literal">ContextConfiguration</code>'s <code class="literal">inheritLocations</code> flag to <code class="literal">false</code>. Consequently, the
application context for <code class="literal">ExtendedTests</code> will be loaded only from
<code class="literal">"/test-user-config.xml"</code> and will have its parent set to the context loaded from
<code class="literal">"/app-config.xml"</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(name = "parent", locations = "/app-config.xml"),
    @ContextConfiguration(name = "child", locations = "/user-config.xml")
})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTests {}

<i><span class="hl-annotation" style="color: gray">@ContextHierarchy(
    @ContextConfiguration(
        name = "child",
        locations = "/test-user-config.xml",
        inheritLocations = false
))</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTests <span class="hl-keyword">extends</span> BaseTests {}</pre>

<div class="note" title="Dirtying a context within a context hierarchy" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Dirtying a context within a context hierarchy"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Dirtying a context within a context hierarchy</th></tr><tr><td align="left" valign="top">

<p>If <code class="literal">@DirtiesContext</code> is used in a test whose context is configured as part of a context
hierarchy, the <code class="literal">hierarchyMode</code> flag can be used to control how the context cache is
cleared. For further details consult the discussion of <code class="literal">@DirtiesContext</code> in
<a class="xref" href="#integration-testing-annotations-spring" title="Spring Testing Annotations">the section called &#8220;Spring Testing Annotations&#8221;</a> and the Javadoc for <code class="literal">@DirtiesContext</code>.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="Dependency injection of test fixtures"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-fixture-di"></a>Dependency injection of test fixtures</h4></div></div></div>

<p>When you use the <code class="literal">DependencyInjectionTestExecutionListener</code>&#8201;&#8212;&#8201;which is configured by
default&#8201;&#8212;&#8201;the dependencies of your test instances are <span class="emphasis"><em>injected</em></span> from beans in the
application context that you configured with <code class="literal">@ContextConfiguration</code>. You may use setter
injection, field injection, or both, depending on which annotations you choose and
whether you place them on setter methods or fields. For consistency with the annotation
support introduced in Spring 2.5 and 3.0, you can use Spring&#8217;s <code class="literal">@Autowired</code> annotation
or the <code class="literal">@Inject</code> annotation from JSR 300.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The TestContext framework does not instrument the manner in which a test instance is
instantiated. Thus the use of <code class="literal">@Autowired</code> or <code class="literal">@Inject</code> for constructors has no effect
for test classes.</p>
</td></tr></table></div>

<p>Because <code class="literal">@Autowired</code> is used to perform <a class="link" href="#beans-factory-autowire" title="4.4.5&nbsp;Autowiring collaborators"><span class="emphasis"><em>autowiring by type</em></span></a>, if you have multiple bean definitions of the same type, you cannot rely on this
approach for those particular beans. In that case, you can use <code class="literal">@Autowired</code> in
conjunction with <code class="literal">@Qualifier</code>. As of Spring 3.0 you may also choose to use <code class="literal">@Inject</code> in
conjunction with <code class="literal">@Named</code>. Alternatively, if your test class has access to its
<code class="literal">ApplicationContext</code>, you can perform an explicit lookup by using (for example) a call
to <code class="literal">applicationContext.getBean("titleRepository")</code>.</p>
<p>If you do not want dependency injection applied to your test instances, simply do not
annotate fields or setter methods with <code class="literal">@Autowired</code> or <code class="literal">@Inject</code>. Alternatively, you can
disable dependency injection altogether by explicitly configuring your class with
<code class="literal">@TestExecutionListeners</code> and omitting <code class="literal">DependencyInjectionTestExecutionListener.class</code>
from the list of listeners.</p>
<p>Consider the scenario of testing a <code class="literal">HibernateTitleRepository</code> class, as outlined in the
<a class="link" href="#integration-testing-goals" title="10.3.2&nbsp;Goals of Integration Testing">Goals</a> section. The next two code listings demonstrate the
use of <code class="literal">@Autowired</code> on fields and setter methods. The application context configuration
is presented after all sample code listings.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The dependency injection behavior in the following code listings is not specific to
JUnit. The same DI techniques can be used in conjunction with any testing framework.</p>
<p>The following examples make calls to static assertion methods such as <code class="literal">assertNotNull()</code>
but without prepending the call with <code class="literal">Assert</code>. In such cases, assume that the method was
properly imported through an <code class="literal">import static</code> declaration that is not shown in the
example.</p>
</td></tr></table></div>

<p>The first code listing shows a JUnit-based implementation of the test class that uses
<code class="literal">@Autowired</code> for field injection.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// specifies the Spring configuration to load for this test fixture</span>
<span class="strong"><strong>@ContextConfiguration("repository-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateTitleRepositoryTests {

    <span class="hl-comment">// this instance will be dependency injected by type</span>
    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">private</span> HibernateTitleRepository titleRepository;

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findById() {
        Title title = titleRepository.findById(<span class="hl-keyword">new</span> Long(<span class="hl-number">10</span>));
        assertNotNull(title);
    }
}</pre>

<p>Alternatively, you can configure the class to use <code class="literal">@Autowired</code> for setter injection as
seen below.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<span class="hl-comment">// specifies the Spring configuration to load for this test fixture</span>
<span class="strong"><strong>@ContextConfiguration("repository-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateTitleRepositoryTests {

    <span class="hl-comment">// this instance will be dependency injected by type</span>
    <span class="hl-keyword">private</span> HibernateTitleRepository titleRepository;

    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTitleRepository(HibernateTitleRepository titleRepository) {
        <span class="hl-keyword">this</span>.titleRepository = titleRepository;
    }

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findById() {
        Title title = titleRepository.findById(<span class="hl-keyword">new</span> Long(<span class="hl-number">10</span>));
        assertNotNull(title);
    }
}</pre>

<p>The preceding code listings use the same XML context file referenced by the
<code class="literal">@ContextConfiguration</code> annotation (that is, <code class="literal">repository-config.xml</code>), which looks like
this:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- this bean will be injected into the HibernateTitleRepositoryTests class --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"</span><span class="strong"><strong>titleRepository</strong></span>" class="<span class="strong"><strong>com.foo.repository.hibernate.HibernateTitleRepository</strong></span>"&gt;
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- configuration elided for brevity --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are extending from a Spring-provided test base class that happens to use
<code class="literal">@Autowired</code> on one of its setter methods, you might have multiple beans of the affected
type defined in your application context: for example, multiple <code class="literal">DataSource</code> beans. In
such a case, you can override the setter method and use the <code class="literal">@Qualifier</code> annotation to
indicate a specific target bean as follows, but make sure to delegate to the overridden
method in the superclass as well.</p>
<pre class="programlisting"><span class="hl-comment">// ...</span>

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(<span class="strong"><strong>@Qualifier("myDataSource")</strong></span> DataSource dataSource) {
        <span class="strong"><strong>super</strong></span>.setDataSource(dataSource);
    }

<span class="hl-comment">// ...</span></pre>

<p>The specified qualifier value indicates the specific <code class="literal">DataSource</code> bean to inject,
narrowing the set of type matches to a specific bean. Its value is matched against
<code class="literal">&lt;qualifier&gt;</code> declarations within the corresponding <code class="literal">&lt;bean&gt;</code> definitions. The bean name
is used as a fallback qualifier value, so you may effectively also point to a specific
bean by name there (as shown above, assuming that "myDataSource" is the bean id).</p>
</td></tr></table></div>

</div>
<div class="section" title="Testing request and session scoped beans"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-web-scoped-beans"></a>Testing request and session scoped beans</h4></div></div></div>

<p><a class="link" href="#beans-factory-scopes-other" title="4.5.4&nbsp;Request, session, and global session scopes">Request and session scoped beans</a> have been supported by
Spring for several years now, but it&#8217;s always been a bit non-trivial to test them. As of
Spring 3.2 it&#8217;s a breeze to test your request-scoped and session-scoped beans by
following these steps.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Ensure that a <code class="literal">WebApplicationContext</code> is loaded for your test by annotating your test
class with <code class="literal">@WebAppConfiguration</code>.
</li><li class="listitem">
Inject the mock request or session into your test instance and prepare your test
fixture as appropriate.
</li><li class="listitem">
Invoke your web component that you retrieved from the configured
<code class="literal">WebApplicationContext</code> (i.e., via dependency injection).
</li><li class="listitem">
Perform assertions against the mocks.
</li></ul></div>

<p>The following code snippet displays the XML configuration for a login use case. Note
that the <code class="literal">userService</code> bean has a dependency on a request-scoped <code class="literal">loginAction</code> bean.
Also, the <code class="literal">LoginAction</code> is instantiated using <a class="link" href="#expressions" title="7.&nbsp;Spring Expression Language (SpEL)">SpEL expressions</a> that
retrieve the username and password from the current HTTP request. In our test, we will
want to configure these request parameters via the mock managed by the TestContext
framework.</p>
<p title="Request-scoped bean configuration">
<b>Request-scoped bean configuration.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.SimpleUserService"</span>
            <span class="hl-attribute">c:loginAction-ref</span>=<span class="hl-value">"loginAction"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loginAction"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.LoginAction"</span>
            <span class="hl-attribute">c:username</span>=<span class="hl-value">"{request.getParameter(</span><span class="emphasis"><em>user</em></span>)}"
            c:password="{request.getParameter(<span class="emphasis"><em>pswd</em></span>)}"
            scope="request"&gt;
        <span class="hl-tag">&lt;aop:scoped-proxy /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre><p title="Request-scoped bean configuration">

</p>

<p>In <code class="literal">RequestScopedBeanTests</code> we inject both the <code class="literal">UserService</code> (i.e., the subject under
test) and the <code class="literal">MockHttpServletRequest</code> into our test instance. Within our
<code class="literal">requestScope()</code> test method we set up our test fixture by setting request parameters in
the provided <code class="literal">MockHttpServletRequest</code>. When the <code class="literal">loginUser()</code> method is invoked on our
<code class="literal">userService</code> we are assured that the user service has access to the request-scoped
<code class="literal">loginAction</code> for the current <code class="literal">MockHttpServletRequest</code> (i.e., the one we just set
parameters in). We can then perform assertions against the results based on the known
inputs for the username and password.</p>
<p title="Request-scoped bean test">
<b>Request-scoped bean test.&nbsp;</b>

</p><pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RequestScopedBeanTests {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i> UserService userService;
    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i> MockHttpServletRequest request;

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> requestScope() {

        request.setParameter(<span class="hl-string">"user"</span>, <span class="hl-string">"enigma"</span>);
        request.setParameter(<span class="hl-string">"pswd"</span>, <span class="hl-string">"$pr!ng"</span>);

        LoginResults results = userService.loginUser();

        <span class="hl-comment">// assert results</span>
    }
}</pre><p title="Request-scoped bean test">

</p>

<p>The following code snippet is similar to the one we saw above for a request-scoped bean;
however, this time the <code class="literal">userService</code> bean has a dependency on a session-scoped
<code class="literal">userPreferences</code> bean. Note that the <code class="literal">UserPreferences</code> bean is instantiated using a
SpEL expression that retrieves the <span class="emphasis"><em>theme</em></span> from the current HTTP session. In our test,
we will need to configure a theme in the mock session managed by the TestContext
framework.</p>
<p title="Session-scoped bean configuration">
<b>Session-scoped bean configuration.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.SimpleUserService"</span>
            <span class="hl-attribute">c:userPreferences-ref</span>=<span class="hl-value">"userPreferences"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userPreferences"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.UserPreferences"</span>
            <span class="hl-attribute">c:theme</span>=<span class="hl-value">"#{session.getAttribute(</span><span class="emphasis"><em>theme</em></span>)}"
            scope="session"&gt;
        <span class="hl-tag">&lt;aop:scoped-proxy /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre><p title="Session-scoped bean configuration">

</p>

<p>In <code class="literal">SessionScopedBeanTests</code> we inject the <code class="literal">UserService</code> and the <code class="literal">MockHttpSession</code> into
our test instance. Within our <code class="literal">sessionScope()</code> test method we set up our test fixture by
setting the expected "theme" attribute in the provided <code class="literal">MockHttpSession</code>. When the
<code class="literal">processUserPreferences()</code> method is invoked on our <code class="literal">userService</code> we are assured that
the user service has access to the session-scoped <code class="literal">userPreferences</code> for the current
<code class="literal">MockHttpSession</code>, and we can perform assertions against the results based on the
configured theme.</p>
<p title="Session-scoped bean test">
<b>Session-scoped bean test.&nbsp;</b>

</p><pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SessionScopedBeanTests {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i> UserService userService;
    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i> MockHttpSession session;

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> sessionScope() <span class="hl-keyword">throws</span> Exception {

        session.setAttribute(<span class="hl-string">"theme"</span>, <span class="hl-string">"blue"</span>);

        Results results = userService.processUserPreferences();

        <span class="hl-comment">// assert results</span>
    }
}</pre><p title="Session-scoped bean test">

</p>

</div>
<div class="section" title="Transaction management"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-tx"></a>Transaction management</h4></div></div></div>

<p>In the TestContext framework, transactions are managed by the
<code class="literal">TransactionalTestExecutionListener</code>. Note that <code class="literal">TransactionalTestExecutionListener</code> is
configured by default, even if you do not explicitly declare <code class="literal">@TestExecutionListeners</code>
on your test class. To enable support for transactions, however, you must provide a
<code class="literal">PlatformTransactionManager</code> bean in the application context loaded by
<code class="literal">@ContextConfiguration</code> semantics. In addition, you must declare <code class="literal">@Transactional</code> either
at the class or method level for your tests.</p>
<p>For class-level transaction configuration (i.e., setting an explicit bean name for the
transaction manager and the default rollback flag), see the <code class="literal">@TransactionConfiguration</code>
entry in the <a class="link" href="#integration-testing-annotations" title="10.3.4&nbsp;Annotations">annotation support</a> section.</p>
<p>If transactions are not enabled for the entire test class, you can annotate methods
explicitly with <code class="literal">@Transactional</code>. To control whether a transaction should commit for a
particular test method, you can use the <code class="literal">@Rollback</code> annotation to override the
class-level default rollback setting.</p>
<p><span class="emphasis"><em><a class="link" href="#testcontext-support-classes-junit4" title="JUnit support classes"><code class="literal">AbstractTransactionalJUnit4SpringContextTests</code></a> and
<a class="link" href="#testcontext-support-classes-testng" title="TestNG support classes"><code class="literal">AbstractTransactionalTestNGSpringContextTests</code></a>
are preconfigured for transactional support at the class level.</em></span></p>
<p>Occasionally you need to execute certain code before or after a transactional test
method but outside the transactional context, for example, to verify the initial
database state prior to execution of your test or to verify expected transactional
commit behavior after test execution (if the test was configured not to roll back the
transaction). <code class="literal">TransactionalTestExecutionListener</code> supports the <code class="literal">@BeforeTransaction</code> and
<code class="literal">@AfterTransaction</code> annotations exactly for such scenarios. Simply annotate any <code class="literal">public
void</code> method in your test class with one of these annotations, and the
<code class="literal">TransactionalTestExecutionListener</code> ensures that your <span class="emphasis"><em>before transaction method</em></span> or
<span class="emphasis"><em>after transaction method</em></span> is executed at the appropriate time.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Any <span class="emphasis"><em>before methods</em></span> (such as methods annotated with JUnit&#8217;s <code class="literal">@Before</code>) and any
<span class="emphasis"><em>after methods</em></span> (such as methods annotated with JUnit&#8217;s <code class="literal">@After</code>) are executed
<span class="emphasis"><em>within</em></span> a transaction. In addition, methods annotated with <code class="literal">@BeforeTransaction</code> or
<code class="literal">@AfterTransaction</code> are naturally not executed for test methods that are not configured
to run within a transaction.</p>
</td></tr></table></div>

<p>The following JUnit-based example displays a fictitious integration testing scenario
highlighting several transaction-related annotations. Consult the
<a class="link" href="#integration-testing-annotations" title="10.3.4&nbsp;Annotations">annotation support</a> section for further information
and configuration examples.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></i>
<span class="strong"><strong>@TransactionConfiguration(transactionManager="txMgr", defaultRollback=false)
@Transactional</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FictitiousTransactionalTest {

    <span class="strong"><strong>@BeforeTransaction</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> verifyInitialDatabaseState() {
        <span class="hl-comment">// logic to verify the initial state before a transaction is started</span>
    }

    <i><span class="hl-annotation" style="color: gray">@Before</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setUpTestDataWithinTransaction() {
        <span class="hl-comment">// set up test data within the transaction</span>
    }

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-comment">// overrides the class-level defaultRollback setting</span>
    <span class="strong"><strong>@Rollback(true)</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> modifyDatabaseWithinTransaction() {
        <span class="hl-comment">// logic which uses the test data and modifies database state</span>
    }

    <i><span class="hl-annotation" style="color: gray">@After</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> tearDownWithinTransaction() {
        <span class="hl-comment">// execute "tear down" logic within the transaction</span>
    }

    <span class="strong"><strong>@AfterTransaction</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> verifyFinalDatabaseState() {
        <span class="hl-comment">// logic to verify the final state after transaction has rolled back</span>
    }

}</pre>

<div class="note" title="Avoid false positives when testing ORM code" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Avoid false positives when testing ORM code"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Avoid false positives when testing ORM code</th></tr><tr><td align="left" valign="top">

<p>When you test application code that manipulates the state of the Hibernate session, make
sure to <span class="emphasis"><em>flush</em></span> the underlying session within test methods that execute that code.
Failing to flush the underlying session can produce <span class="emphasis"><em>false positives</em></span>: your test may
pass, but the same code throws an exception in a live, production environment. In the
following Hibernate-based example test case, one method demonstrates a false positive,
and the other method correctly exposes the results of flushing the session. Note that
this applies to JPA and any other ORM frameworks that maintain an in-memory <span class="emphasis"><em>unit of
work</em></span>.</p>
<pre class="programlisting"><span class="hl-comment">// ...</span>

<i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
<span class="hl-keyword">private</span> SessionFactory sessionFactory;

<i><span class="hl-annotation" style="color: gray">@Test</span></i> <span class="hl-comment">// no expected exception!</span>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> falsePositive() {
    updateEntityInHibernateSession();
    <span class="hl-comment">// False positive: an exception will be thrown once the session is</span>
    <span class="hl-comment">// finally flushed (i.e., in production code)</span>
}

<i><span class="hl-annotation" style="color: gray">@Test(expected = GenericJDBCException.class)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> updateWithSessionFlush() {
    updateEntityInHibernateSession();
    <span class="hl-comment">// Manual flush is required to avoid false positive in test</span>
    sessionFactory.getCurrentSession().flush();
}

<span class="hl-comment">// ...</span></pre>

</td></tr></table></div>

</div>
<div class="section" title="TestContext Framework support classes"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-support-classes"></a>TestContext Framework support classes</h4></div></div></div>

<div class="section" title="JUnit support classes"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-support-classes-junit4"></a>JUnit support classes</h5></div></div></div>

<p>The <code class="literal">org.springframework.test.context.junit4</code> package provides support classes for JUnit
4.5+ based test cases.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<p class="simpara"><code class="literal">AbstractJUnit4SpringContextTests</code>: Abstract base test class that integrates the
<span class="emphasis"><em>Spring TestContext Framework</em></span> with explicit <code class="literal">ApplicationContext</code> testing support in
a JUnit 4.5+ environment.</p>
<p class="simpara">When you extend <code class="literal">AbstractJUnit4SpringContextTests</code>, you can access the following
<code class="literal">protected</code> instance variable:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">applicationContext</code>: Use this variable to perform explicit bean lookups or to test
the state of the context as a whole.
</li></ul></div>

</li><li class="listitem">
<p class="simpara"><code class="literal">AbstractTransactionalJUnit4SpringContextTests</code>: Abstract <span class="emphasis"><em>transactional</em></span> extension
of <code class="literal">AbstractJUnit4SpringContextTests</code> that also adds some convenience functionality
for JDBC access. Expects a <code class="literal">javax.sql.DataSource</code> bean and a
<code class="literal">PlatformTransactionManager</code> bean to be defined in the <code class="literal">ApplicationContext</code>. When you
extend <code class="literal">AbstractTransactionalJUnit4SpringContextTests</code> you can access the following
<code class="literal">protected</code> instance variables:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">applicationContext</code>: Inherited from the <code class="literal">AbstractJUnit4SpringContextTests</code>
superclass. Use this variable to perform explicit bean lookups or to test the state of
the context as a whole.
</li><li class="listitem">
<code class="literal">jdbcTemplate</code>: Use this variable to execute SQL statements to query the database.
Such queries can be used to confirm database state both <span class="emphasis"><em>prior to</em></span> and <span class="emphasis"><em>after</em></span>
execution of database-related application code, and Spring ensures that such queries run
in the scope of the same transaction as the application code. When used in conjunction
with an ORM tool, be sure to avoid <a class="link" href="#">false positives</a>.
</li></ul></div>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>These classes are a convenience for extension. If you do not want your test classes to
be tied to a Spring-specific class hierarchy&#8201;&#8212;&#8201;for example, if you want to directly
extend the class you are testing&#8201;&#8212;&#8201;you can configure your own custom test classes by
using <code class="literal">@RunWith(SpringJUnit4ClassRunner.class)</code>, <code class="literal">@ContextConfiguration</code>,
<code class="literal">@TestExecutionListeners</code>, and so on.</p>
</td></tr></table></div>

</li></ul></div>

</div>
<div class="section" title="Spring JUnit Runner"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-junit4-runner"></a>Spring JUnit Runner</h5></div></div></div>

<p>The <span class="emphasis"><em>Spring TestContext Framework</em></span> offers full integration with JUnit 4.5+ through a
custom runner (tested on JUnit 4.5&#8201;&#8212;&#8201;4.11). By annotating test classes with
<code class="literal">@RunWith(SpringJUnit4ClassRunner.class)</code>, developers can implement standard JUnit-based
unit and integration tests and simultaneously reap the benefits of the TestContext
framework such as support for loading application contexts, dependency injection of test
instances, transactional test method execution, and so on. The following code listing
displays the minimal requirements for configuring a test class to run with the custom
Spring Runner. <code class="literal">@TestExecutionListeners</code> is configured with an empty list in order to
disable the default listeners, which otherwise would require an ApplicationContext to be
configured through <code class="literal">@ContextConfiguration</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@TestExecutionListeners({})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleTest {

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testMethod() {
        <span class="hl-comment">// execute test logic...</span>
    }
}</pre>

</div>
<div class="section" title="TestNG support classes"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-support-classes-testng"></a>TestNG support classes</h5></div></div></div>

<p>The <code class="literal">org.springframework.test.context.testng</code> package provides support classes for
TestNG based test cases.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<p class="simpara"><code class="literal">AbstractTestNGSpringContextTests</code>: Abstract base test class that integrates the
<span class="emphasis"><em>Spring TestContext Framework</em></span> with explicit <code class="literal">ApplicationContext</code> testing support in
a TestNG environment.</p>
<p class="simpara">When you extend <code class="literal">AbstractTestNGSpringContextTests</code>, you can access the following
<code class="literal">protected</code> instance variable:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">applicationContext</code>: Use this variable to perform explicit bean lookups or to test
the state of the context as a whole.
</li><li class="listitem">
<code class="literal">AbstractTransactionalTestNGSpringContextTests</code>: Abstract <span class="emphasis"><em>transactional</em></span> extension
of <code class="literal">AbstractTestNGSpringContextTests</code> that adds some convenience functionality for JDBC
access. Expects a <code class="literal">javax.sql.DataSource</code> bean and a <code class="literal">PlatformTransactionManager</code> bean to
be defined in the <code class="literal">ApplicationContext</code>. When you extend
<code class="literal">AbstractTransactionalTestNGSpringContextTests</code>, you can access the following
<code class="literal">protected</code> instance variables:
</li><li class="listitem">
<code class="literal">applicationContext</code>: Inherited from the <code class="literal">AbstractTestNGSpringContextTests</code>
superclass. Use this variable to perform explicit bean lookups or to test the state of
the context as a whole.
</li><li class="listitem">
<code class="literal">jdbcTemplate</code>: Use this variable to execute SQL statements to query the database.
Such queries can be used to confirm database state both <span class="emphasis"><em>prior to</em></span> and <span class="emphasis"><em>after</em></span>
execution of database-related application code, and Spring ensures that such queries run
in the scope of the same transaction as the application code. When used in conjunction
with an ORM tool, be sure to avoid <a class="link" href="#">false positives</a>.
</li></ul></div>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>These classes are a convenience for extension. If you do not want your test classes to
be tied to a Spring-specific class hierarchy&#8201;&#8212;&#8201;for example, if you want to directly
extend the class you are testing&#8201;&#8212;&#8201;you can configure your own custom test classes by
using <code class="literal">@ContextConfiguration</code>, <code class="literal">@TestExecutionListeners</code>, and so on, and by manually
instrumenting your test class with a <code class="literal">TestContextManager</code>. See the source code of
<code class="literal">AbstractTestNGSpringContextTests</code> for an example of how to instrument your test class.</p>
</td></tr></table></div>

</li></ul></div>

</div>
</div>
</div>
<div class="section" title="10.3.6&nbsp;Spring MVC Test Framework"><div class="titlepage"><div><div><h3 class="title"><a name="spring-mvc-test-framework"></a>10.3.6&nbsp;Spring MVC Test Framework</h3></div></div></div>

<div class="sidebar" title="Standalone project"><p class="title"><b>Standalone project</b></p>

<p>Before inclusion in Spring Framework 3.2, the Spring MVC Test framework had already
existed as a separate project on GitHub where it grew and evolved through actual use,
feedback, and the contribution of many.</p>
<p>The standalone <a class="ulink" href="https://github.com/SpringSource/spring-test-mvc" target="_top">spring-test-mvc project</a>
is still available on GitHub and can be used in conjunction with Spring Framework 3.1.x.
Applications upgrading to 3.2 or later should replace the <code class="literal">spring-test-mvc</code> dependency with a
dependency on <code class="literal">spring-test</code>.</p>
<p>The <code class="literal">spring-test</code> module uses a different package <code class="literal">org.springframework.test.web</code> but
otherwise is nearly identical with two exceptions. One is support for features new in
3.2 (e.g. asynchronous web requests). The other relates to the options for creating a
<code class="literal">MockMvc</code> instance. In Spring Framework 3.2 and later, this can only be done through the
TestContext framework, which provides caching benefits for the loaded configuration.</p>
</div>

<p>The <span class="emphasis"><em>Spring MVC Test framework</em></span> provides first class JUnit support for testing client
and server-side Spring MVC code through a fluent API. Typically it loads the actual
Spring configuration through the <span class="emphasis"><em>TestContext framework</em></span> and always uses the
<code class="literal">DispatcherServlet</code> to process requests thus approximating full integration tests
without requiring a running Servlet container.</p>
<p>Client-side tests are <code class="literal">RestTemplate</code>-based and allow tests for code that relies on the
<code class="literal">RestTemplate</code> without requiring a running server to respond to the requests.</p>
<div class="section" title="Server-Side Tests"><div class="titlepage"><div><div><h4 class="title"><a name="spring-mvc-test-server"></a>Server-Side Tests</h4></div></div></div>

<p>Before Spring Framework 3.2, the most likely way to test a Spring MVC controller was to
write a unit test that instantiates the controller, injects it with mock or stub
dependencies, and then calls its methods directly, using a <code class="literal">MockHttpServletRequest</code> and
<code class="literal">MockHttpServletResponse</code> where necessary.</p>
<p>Although this is pretty easy to do, controllers have many annotations, and much remains
untested. Request mappings, data binding, type conversion, and validation are just a few
examples of what isn&#8217;t tested. Furthermore, there are other types of annotated methods
such as <code class="literal">@InitBinder</code>, <code class="literal">@ModelAttribute</code>, and <code class="literal">@ExceptionHandler</code> that get invoked as
part of request processing.</p>
<p>The idea behind Spring MVC Test is to be able to re-write those controller tests by
performing actual requests and generating responses, as they would be at runtime, along
the way invoking controllers through the Spring MVC <code class="literal">DispatcherServlet</code>. Controllers can
still be injected with mock dependencies, so tests can remain focused on the web layer.</p>
<p>Spring MVC Test builds on the familiar "mock" implementations of the Servlet API
available in the <code class="literal">spring-test</code> module. This allows performing requests and generating
responses without the need for running in a Servlet container. For the most part
everything should work as it does at runtime with the exception of JSP rendering, which
is not available outside a Servlet container. Furthermore, if you are familiar with how
the <code class="literal">MockHttpServletResponse</code> works, you&#8217;ll know that forwards and redirects are not
actually executed. Instead "forwarded" and "redirected" URLs are saved and can be
asserted in tests. This means if you are using JSPs, you can verify the JSP page to
which the request was forwarded.</p>
<p>All other means of rendering including <code class="literal">@ResponseBody</code> methods and <code class="literal">View</code> types (besides
JSPs) such as Freemarker, Velocity, Thymeleaf, and others for rendering HTML, JSON, XML,
and so on should work as expected, and the response will contain the generated content.</p>
<p>Below is an example of a test requesting account information in JSON format:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
<span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

<i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("test-servlet-context.xml")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleTests {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <i><span class="hl-annotation" style="color: gray">@Before</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
        <span class="hl-keyword">this</span>.mockMvc = MockMvcBuilders.webAppContextSetup(<span class="hl-keyword">this</span>.wac).build();
    }

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getAccount() <span class="hl-keyword">throws</span> Exception {
        <span class="hl-keyword">this</span>.mockMvc.perform(get(<span class="hl-string">"/accounts/1"</span>).accept(MediaType.parseMediaType(<span class="hl-string">"application/json;charset=UTF-8"</span>)))
            .andExpect(status().isOk())
            .andExpect(content().contentType(<span class="hl-string">"application/json"</span>))
            .andExpect(jsonPath(<span class="hl-string">"$.name"</span>).value(<span class="hl-string">"Lee"</span>));
    }

}</pre>

<p>The test relies on the <code class="literal">WebApplicationContext</code> support of the <span class="emphasis"><em>TestContext framework</em></span>.
It loads Spring configuration from an XML configuration file located in the same package
as the test class (also supports JavaConfig) and injects the created
<code class="literal">WebApplicationContext</code> into the test so a <code class="literal">MockMvc</code> instance can be created with it.</p>
<p>The <code class="literal">MockMvc</code> is then used to perform a request to <code class="literal">"/accounts/1"</code> and verify the
resulting response status is 200, the response content type is <code class="literal">"application/json"</code>, and
response content has a JSON property called "name" with the value "Lee". JSON content is
inspected with the help of Jayway&#8217;s <a class="ulink" href="https://github.com/jayway/JsonPath" target="_top">JsonPath
project</a>. There are lots of other options for verifying the result of the performed
request and those will be discussed later.</p>
<div class="section" title="Static Imports"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-static-imports"></a>Static Imports</h5></div></div></div>

<p>The fluent API in the example above requires a few static imports such as
<code class="literal">MockMvcRequestBuilders.*</code>, <code class="literal">MockMvcResultMatchers.*</code>, and <code class="literal">MockMvcBuilders.*</code>. An easy
way to find these classes is to search for types matching <span class="emphasis"><em>"MockMvc*"</em></span>. If using
Eclipse, be sure to add them as "favorite static members" in the Eclipse preferences
under<span class="emphasis"><em>Java &#8594; Editor &#8594; Content Assist &#8594; Favorites</em></span>. That will allow use of content
assist after typing the first character of the static method name. Other IDEs (e.g.
IntelliJ) may not require any additional configuration. Just check the support for code
completion on static members.</p>
</div>
<div class="section" title="Setup Options"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-setup-options"></a>Setup Options</h5></div></div></div>

<p>The goal of server-side test setup is to create an instance of <code class="literal">MockMvc</code> that can be
used to perform requests. There are two main options.</p>
<p>The first option is to point to Spring MVC configuration through the <span class="emphasis"><em>TestContext
framework</em></span>, which loads the Spring configuration and injects a <code class="literal">WebApplicationContext</code>
into the test to use to create a <code class="literal">MockMvc</code>:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("my-servlet-context.xml")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebTests {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <i><span class="hl-annotation" style="color: gray">@Before</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
        <span class="hl-keyword">this</span>.mockMvc = MockMvcBuilders.webAppContextSetup(<span class="hl-keyword">this</span>.wac).build();
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>The second option is to simply register a controller instance without loading any Spring
configuration. Instead basic Spring MVC configuration suitable for testing annotated
controllers is automatically created. The created configuration is comparable to that of
the MVC JavaConfig (and the MVC namespace) and can be customized to a degree through
builder-style methods:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebTests {

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <i><span class="hl-annotation" style="color: gray">@Before</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
        <span class="hl-keyword">this</span>.mockMvc = MockMvcBuilders.standaloneSetup(<span class="hl-keyword">new</span> AccountController()).build();
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>Which option should you use?</p>
<p>The <span class="emphasis"><em>"webAppContextSetup"</em></span> loads the actual Spring MVC configuration resulting in a
more complete integration test. Since the <span class="emphasis"><em>TestContext framework</em></span> caches the loaded
Spring configuration, it helps to keep tests running fast even as more tests get added.
Furthermore, you can inject mock services into controllers through Spring configuration,
in order to remain focused on testing the web layer. Here is an example of declaring a
mock service with Mockito:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.mockito.Mockito"</span> <span class="hl-attribute">factory-method</span>=<span class="hl-value">"mock"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Then you can inject the mock service into the test in order set up and verify
expectations:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></i>
<i><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></i>
<i><span class="hl-annotation" style="color: gray">@ContextConfiguration("test-servlet-context.xml")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AccountTests {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> AccountService accountService;

    <span class="hl-comment">// ...</span>

}</pre>

<p>The <span class="emphasis"><em>"standaloneSetup"</em></span> on the other hand is a little closer to a unit test. It tests
one controller at a time, the controller can be injected with mock dependencies
manually, and it doesn&#8217;t involve loading Spring configuration. Such tests are more
focused in style and make it easier to see which controller is being tested, whether any
specific Spring MVC configuration is required to work, and so on. The "standaloneSetup"
is also a very convenient way to write ad-hoc tests to verify some behavior or to debug
an issue.</p>
<p>Just like with integration vs unit testing, there is no right or wrong answer. Using the
"standaloneSetup" does imply the need for some additional "webAppContextSetup" tests to
verify the Spring MVC configuration. Alternatively, you can decide write all tests with
"webAppContextSetup" and always test against actual Spring MVC configuration.</p>
</div>
<div class="section" title="Performing Requests"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-performing-requests"></a>Performing Requests</h5></div></div></div>

<p>To perform requests, use the appropriate HTTP method and additional builder-style
methods corresponding to properties of <code class="literal">MockHttpServletRequest</code>. For example:</p>
<pre class="programlisting">mockMvc.perform(post(<span class="hl-string">"/hotels/{id}"</span>, <span class="hl-number">42</span>).accept(MediaType.APPLICATION_JSON));</pre>

<p>In addition to all the HTTP methods, you can also perform file upload requests, which
internally creates an instance of <code class="literal">MockMultipartHttpServletRequest</code>:</p>
<pre class="programlisting">mockMvc.perform(fileUpload(<span class="hl-string">"/doc"</span>).file(<span class="hl-string">"a1"</span>, <span class="hl-string">"ABC"</span>.getBytes(<span class="hl-string">"UTF-8"</span>)));</pre>

<p>Query string parameters can be specified in the URI template:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/hotels?foo={foo}"</span>, <span class="hl-string">"bar"</span>));</pre>

<p>Or by adding Servlet request parameters:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/hotels"</span>).param(<span class="hl-string">"foo"</span>, <span class="hl-string">"bar"</span>));</pre>

<p>If application code relies on Servlet request parameters, and doesn&#8217;t check the query
string, as is most often the case, then it doesn&#8217;t matter how parameters are added. Keep
in mind though that parameters provided in the URI template will be decoded while
parameters provided through the <code class="literal">param(...)</code> method are expected to be decoded.</p>
<p>In most cases it&#8217;s preferable to leave out the context path and the Servlet path from
the request URI. If you must test with the full request URI, be sure to set the
<code class="literal">contextPath</code> and <code class="literal">servletPath</code> accordingly so that request mappings will work:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/app/main/hotels/{id}"</span>).contextPath(<span class="hl-string">"/app"</span>).servletPath(<span class="hl-string">"/main"</span>))</pre>

<p>Looking at the above example, it would be cumbersome to set the contextPath and
servletPath with every performed request. That&#8217;s why you can define default request
properties when building the <code class="literal">MockMvc</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebTests {

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <i><span class="hl-annotation" style="color: gray">@Before</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
        mockMvc = standaloneSetup(<span class="hl-keyword">new</span> AccountController())
            .defaultRequest(get(<span class="hl-string">"/"</span>)
            .contextPath(<span class="hl-string">"/app"</span>).servletPath(<span class="hl-string">"/main"</span>)
            .accept(MediaType.APPLICATION_JSON).build();
    }</pre>

<p>The above properties will apply to every request performed through the <code class="literal">MockMvc</code>. If the
same property is also specified on a given request, it will override the default value.
That is why, the HTTP method and URI don&#8217;t matter, when setting default request
properties, since they must be specified on every request.</p>
</div>
<div class="section" title="Defining Expectations"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-defining-expectations"></a>Defining Expectations</h5></div></div></div>

<p>Expectations can be defined by appending one or more <code class="literal">.andExpect(..)</code> after call to
perform the request:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/accounts/1"</span>)).andExpect(status().isOk());</pre>

<p><code class="literal">MockMvcResultMatchers.*</code> defines a number of static members, some of which return types
with additional methods, for asserting the result of the performed request. The
assertions fall in two general categories.</p>
<p>The first category of assertions verify properties of the response, i.e the response
status, headers, and content. Those are the most important things to test for.</p>
<p>The second category of assertions go beyond the response, and allow inspecting Spring
MVC specific constructs such as which controller method processed the request, whether
an exception was raised and handled, what the content of the model is, what view was
selected, what flash attributes were added, and so on. It is also possible to verify
Servlet specific constructs such as request and session attributes. The following test
asserts that binding/validation failed:</p>
<pre class="programlisting">mockMvc.perform(post(<span class="hl-string">"/persons"</span>))
    .andExpect(status().isOk())
    .andExpect(model().attributeHasErrors(<span class="hl-string">"person"</span>));</pre>

<p>Many times when writing tests, it&#8217;s useful to dump the result of the performed request.
This can be done as follows, where <code class="literal">print()</code> is a static import from
<code class="literal">MockMvcResultHandlers</code>:</p>
<pre class="programlisting">mockMvc.perform(post(<span class="hl-string">"/persons"</span>))
    .andDo(print())
    .andExpect(status().isOk())
    .andExpect(model().attributeHasErrors(<span class="hl-string">"person"</span>));</pre>

<p>As long as request processing causes an unhandled exception, the <code class="literal">print()</code> method will
print all the available result data to <code class="literal">System.out</code>.</p>
<p>In some cases, you may want to get direct access to the result and verify something that
cannot be verified otherwise. This can be done by appending <code class="literal">.andReturn()</code> at the end
after all expectations:</p>
<pre class="programlisting">MvcResult mvcResult = mockMvc.perform(post(<span class="hl-string">"/persons"</span>)).andExpect(status().isOk()).andReturn();
<span class="hl-comment">// ...</span></pre>

<p>When all tests repeat the same expectations, you can define the common expectations once
when building the <code class="literal">MockMvc</code>:</p>
<pre class="programlisting">standaloneSetup(<span class="hl-keyword">new</span> SimpleController())
    .alwaysExpect(status().isOk())
    .alwaysExpect(content().contentType(<span class="hl-string">"application/json;charset=UTF-8"</span>))
    .build()</pre>

<p>Note that the expectation is <span class="emphasis"><em>always</em></span> applied and cannot be overridden without
creating a separate <code class="literal">MockMvc</code> instance.</p>
<p>When JSON response content contains hypermedia links created with
<a class="ulink" href="https://github.com/SpringSource/spring-hateoas" target="_top">Spring HATEOAS</a>, the resulting links can
be verified:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/people"</span>).accept(MediaType.APPLICATION_JSON))
    .andExpect(jsonPath(<span class="hl-string">"$.links[?(@.rel == </span><span class="emphasis"><em>self</em></span>)].href<span class="hl-string">").value("</span>http:<span class="hl-comment">//localhost:8080/people"));</span></pre>

<p>When XML response content contains hypermedia links created with
<a class="ulink" href="https://github.com/SpringSource/spring-hateoas" target="_top">Spring HATEOAS</a>, the resulting links can
be verified:</p>
<pre class="programlisting">Map&lt;String, String&gt; ns = Collections.singletonMap(<span class="hl-string">"ns"</span>, <span class="hl-string">"http://www.w3.org/2005/Atom"</span>);
mockMvc.perform(get(<span class="hl-string">"/handle"</span>).accept(MediaType.APPLICATION_XML))
    .andExpect(xpath(<span class="hl-string">"/person/ns:link[@rel=</span><span class="emphasis"><em>self</em></span>]/<i><span class="hl-annotation" style="color: gray">@href",</span></i> ns).string(<span class="hl-string">"http://localhost:8080/people"</span>));</pre>

</div>
<div class="section" title="Filter Registrations"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-filters"></a>Filter Registrations</h5></div></div></div>

<p>When setting up a <code class="literal">MockMvc</code>, you can register one or more <code class="literal">Filter</code> instances:</p>
<pre class="programlisting">mockMvc = standaloneSetup(<span class="hl-keyword">new</span> PersonController()).addFilters(<span class="hl-keyword">new</span> CharacterEncodingFilter()).build();</pre>

<p>Registered filters will be invoked through <code class="literal">MockFilterChain</code> from <code class="literal">spring-test</code> and the
last filter will delegates to the <code class="literal">DispatcherServlet</code>.</p>
</div>
<div class="section" title="Further Server-Side Test Examples"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-resources"></a>Further Server-Side Test Examples</h5></div></div></div>

<p>The framework&#8217;s own tests include
<a class="ulink" href="https://github.com/SpringSource/spring-framework/tree/master/spring-test/src/test/java/org/springframework/test/web/servlet/samples" target="_top">many
sample tests</a> intended to demonstrate how to use Spring MVC Test. Browse these examples
for further ideas. Also the
<a class="ulink" href="https://github.com/SpringSource/spring-mvc-showcase" target="_top">spring-mvc-showcase</a> has full test
coverage based on Spring MVC Test.</p>
</div>
</div>
<div class="section" title="Client-Side REST Tests"><div class="titlepage"><div><div><h4 class="title"><a name="spring-mvc-test-client"></a>Client-Side REST Tests</h4></div></div></div>

<p>Client-side tests are for code using the <code class="literal">RestTemplate</code>. The goal is to define expected
requests and provide "stub" responses:</p>
<pre class="programlisting">RestTemplate restTemplate = <span class="hl-keyword">new</span> RestTemplate();

MockRestServiceServer mockServer = MockRestServiceServer.createServer(restTemplate);
mockServer.expect(requestTo(<span class="hl-string">"/greeting"</span>)).andRespond(withSuccess(<span class="hl-string">"Hello world"</span>, <span class="hl-string">"text/plain"</span>));

<span class="hl-comment">// use RestTemplate ...</span>

mockServer.verify();</pre>

<p>In the above example, <code class="literal">MockRestServiceServer</code>&#8201;&#8212;&#8201;the central class for client-side REST
tests&#8201;&#8212;&#8201;configures the <code class="literal">RestTemplate</code> with a custom <code class="literal">ClientHttpRequestFactory</code> that
asserts actual requests against expectations and returns "stub" responses. In this case
we expect a single request to "/greeting" and want to return a 200 response with
"text/plain" content. We could define as many additional requests and stub responses as
necessary.</p>
<p>Once expected requests and stub responses have been defined, the <code class="literal">RestTemplate</code> can be
used in client-side code as usual. At the end of the tests <code class="literal">mockServer.verify()</code> can be
used to verify that all expected requests were performed.</p>
<div class="section" title="Static Imports"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-client-static-imports"></a>Static Imports</h5></div></div></div>

<p>Just like with server-side tests, the fluent API for client-side tests requires a few
static imports. Those are easy to find by searching <span class="emphasis"><em>"MockRest*"</em></span>. Eclipse users
should add <code class="literal">"MockRestRequestMatchers.*"</code> and <code class="literal">"MockRestResponseCreators.*"</code> as "favorite
static members" in the Eclipse preferences under <span class="emphasis"><em>Java &#8594; Editor &#8594; Content Assist &#8594;
Favorites</em></span>. That allows using content assist after typing the first character of the
static method name. Other IDEs (e.g. IntelliJ) may not require any additional
configuration. Just check the support for code completion on static members.</p>
</div>
<div class="section" title="Further Examples of Client-side REST Tests"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-client-resources"></a>Further Examples of Client-side REST Tests</h5></div></div></div>

<p>Spring MVC Test&#8217;s own tests include
<a class="ulink" href="https://github.com/SpringSource/spring-framework/tree/master/spring-test/src/test/java/org/springframework/test/web/client/samples" target="_top">example
tests</a> of client-side REST tests.</p>
</div>
</div>
</div>
<div class="section" title="10.3.7&nbsp;PetClinic Example"><div class="titlepage"><div><div><h3 class="title"><a name="testing-examples-petclinic"></a>10.3.7&nbsp;PetClinic Example</h3></div></div></div>

<p>The PetClinic application, available on
<a class="ulink" href="https://github.com/spring-projects/spring-petclinic" target="_top">Github</a>, illustrates several features
of the <span class="emphasis"><em>Spring TestContext Framework</em></span> in a JUnit 4.5+ environment. Most test
functionality is included in the <code class="literal">AbstractClinicTests</code>, for which a partial listing
is shown below:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.junit.Assert.assertEquals;
<span class="hl-comment">// import ...</span>

<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractClinicTests <span class="strong"><strong>extends AbstractTransactionalJUnit4SpringContextTests</strong></span> {

    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">protected</span> Clinic clinic;

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getVets() {
        Collection&lt;Vet&gt; vets = <span class="hl-keyword">this</span>.clinic.getVets();
        assertEquals(<span class="hl-string">"JDBC query must show the same number of vets"</span>,
            <span class="strong"><strong>super.countRowsInTable("VETS")</strong></span>, vets.size());
        Vet v1 = EntityUtils.getById(vets, Vet.<span class="hl-keyword">class</span>, <span class="hl-number">2</span>);
        assertEquals(<span class="hl-string">"Leary"</span>, v1.getLastName());
        assertEquals(<span class="hl-number">1</span>, v1.getNrOfSpecialties());
        assertEquals(<span class="hl-string">"radiology"</span>, (v1.getSpecialties().get(<span class="hl-number">0</span>)).getName());
        <span class="hl-comment">// ...</span>
    }

    <span class="hl-comment">// ...</span>
}</pre>

<p>Notes:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
This test case extends the <code class="literal">AbstractTransactionalJUnit4SpringContextTests</code> class, from
which it inherits configuration for Dependency Injection (through the
<code class="literal">DependencyInjectionTestExecutionListener</code>) and transactional behavior (through the
<code class="literal">TransactionalTestExecutionListener</code>).
</li><li class="listitem">
The <code class="literal">clinic</code> instance variable&#8201;&#8212;&#8201;the application object being tested&#8201;&#8212;&#8201;is set by
Dependency Injection through <code class="literal">@Autowired</code> semantics.
</li><li class="listitem">
The <code class="literal">testGetVets()</code> method illustrates how you can use the inherited
<code class="literal">countRowsInTable()</code> method to easily verify the number of rows in a given table, thus
verifying correct behavior of the application code being tested. This allows for
stronger tests and lessens dependency on the exact test data. For example, you can add
additional rows in the database without breaking tests.
</li><li class="listitem">
Like many integration tests that use a database, most of the tests in
<code class="literal">AbstractClinicTests</code> depend on a minimum amount of data already in the database
before the test cases run. Alternatively, you might choose to populate the database
within the test fixture set up of your test cases&#8201;&#8212;&#8201;again, within the same
transaction as the tests.
</li></ul></div>

<p>The PetClinic application supports three data access technologies: JDBC, Hibernate, and
JPA. By declaring <code class="literal">@ContextConfiguration</code> without any specific resource locations, the
<code class="literal">AbstractClinicTests</code> class will have its application context loaded from the default
location, <code class="literal">AbstractClinicTests-context.xml</code>, which declares a common <code class="literal">DataSource</code>.
Subclasses specify additional context locations that must declare a
<code class="literal">PlatformTransactionManager</code> and a concrete implementation of <code class="literal">Clinic</code>.</p>
<p>For example, the Hibernate implementation of the PetClinic tests contains the following
implementation. For this example, <code class="literal">HibernateClinicTests</code> does not contain a single line
of code: we only need to declare <code class="literal">@ContextConfiguration</code>, and the tests are inherited
from <code class="literal">AbstractClinicTests</code>. Because <code class="literal">@ContextConfiguration</code> is declared without any
specific resource locations, the <span class="emphasis"><em>Spring TestContext Framework</em></span> loads an application
context from all the beans defined in <code class="literal">AbstractClinicTests-context.xml</code> (i.e., the
inherited locations) and <code class="literal">HibernateClinicTests-context.xml</code>, with
<code class="literal">HibernateClinicTests-context.xml</code> possibly overriding beans defined in
<code class="literal">AbstractClinicTests-context.xml</code>.</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateClinicTests <span class="hl-keyword">extends</span> AbstractClinicTests { }</pre>

<p>In a large-scale application, the Spring configuration is often split across multiple
files. Consequently, configuration locations are typically specified in a common base
class for all application-specific integration tests. Such a base class may also add
useful instance variables&#8201;&#8212;&#8201;populated by Dependency Injection, naturally&#8201;&#8212;&#8201;such as a
<code class="literal">SessionFactory</code> in the case of an application using Hibernate.</p>
<p>As far as possible, you should have exactly the same Spring configuration files in your
integration tests as in the deployed environment. One likely point of difference
concerns database connection pooling and transaction infrastructure. If you are
deploying to a full-blown application server, you will probably use its connection pool
(available through JNDI) and JTA implementation. Thus in production you will use a
<code class="literal">JndiObjectFactoryBean</code> or <code class="literal">&lt;jee:jndi-lookup&gt;</code> for the <code class="literal">DataSource</code> and
<code class="literal">JtaTransactionManager</code>. JNDI and JTA will not be available in out-of-container
integration tests, so you should use a combination like the Commons DBCP
<code class="literal">BasicDataSource</code> and <code class="literal">DataSourceTransactionManager</code> or <code class="literal">HibernateTransactionManager</code>
for them. You can factor out this variant behavior into a single XML file, having the
choice between application server and a <span class="emphasis"><em>local</em></span> configuration separated from all other
configuration, which will not vary between the test and production environments. In
addition, it is advisable to use properties files for connection settings. See the
PetClinic application for an example.</p>
</div>
</div>
<div class="section" title="10.4&nbsp;Further Resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-resources"></a>10.4&nbsp;Further Resources</h2></div></div></div>

<p>Consult the following resources for more information about testing:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="ulink" href="http://www.junit.org/" target="_top">JUnit</a>: "<span class="emphasis"><em>A programmer-oriented testing framework for Java</em></span>".
Used by the Spring Framework in its test suite.
</li><li class="listitem">
<a class="ulink" href="http://testng.org/" target="_top">TestNG</a>: A testing framework inspired by JUnit with added support
for annotations, test groups, data-driven testing, distributed testing, etc.
</li><li class="listitem">
<a class="ulink" href="http://www.mockobjects.com/" target="_top">MockObjects.com</a>: Web site dedicated to mock objects, a
technique for improving the design of code within test-driven development.
</li><li class="listitem">
<a class="ulink" href="http://en.wikipedia.org/wiki/Mock_Object" target="_top">"Mock Objects"</a>: Article in Wikipedia.
</li><li class="listitem">
<a class="ulink" href="http://www.easymock.org/" target="_top">EasyMock</a>: Java library " <span class="emphasis"><em>that provides Mock Objects for
interfaces (and objects through the class extension) by generating them on the fly
using Java&#8217;s proxy mechanism.</em></span> " Used by the Spring Framework in its test suite.
</li><li class="listitem">
<a class="ulink" href="http://www.jmock.org/" target="_top">JMock</a>: Library that supports test-driven development of Java
code with mock objects.
</li><li class="listitem">
<a class="ulink" href="http://mockito.org/" target="_top">Mockito</a>: Java mock library based on the
<a class="ulink" href="http://xunitpatterns.com/Test%20Spy.html" target="_top">test spy</a> pattern.
</li><li class="listitem">
<a class="ulink" href="http://dbunit.sourceforge.net/" target="_top">DbUnit</a>: JUnit extension (also usable with Ant and
Maven) targeted for database-driven projects that, among other things, puts your
database into a known state between test runs.
</li><li class="listitem">
<a class="ulink" href="http://grinder.sourceforge.net/" target="_top">The Grinder</a>: Java load testing framework.
</li></ul></div>

</div>
</div>
</div>
<div class="part" title="Part&nbsp;IV.&nbsp;Data Access"><div class="titlepage"><div><div><h1 class="title"><a name="spring-data-tier"></a>Part&nbsp;IV.&nbsp;Data Access</h1></div></div></div>

<div class="partintro" title="Data Access"><div></div>
<p>This part of the reference documentation is concerned with data access and the
interaction between the data access layer and the business or service layer.</p>
<p>Spring&#8217;s comprehensive transaction management support is covered in some detail,
followed by thorough coverage of the various data access frameworks and technologies
that the Spring Framework integrates with.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#transaction" title="11.&nbsp;Transaction Management">Chapter&nbsp;11, <i>Transaction Management</i></a>
</li><li class="listitem">
<a class="xref" href="#dao" title="12.&nbsp;DAO support">Chapter&nbsp;12, <i>DAO support</i></a>
</li><li class="listitem">
<a class="xref" href="#jdbc" title="13.&nbsp;Data access with JDBC">Chapter&nbsp;13, <i>Data access with JDBC</i></a>
</li><li class="listitem">
<a class="xref" href="#orm" title="14.&nbsp;Object Relational Mapping (ORM) Data Access">Chapter&nbsp;14, <i>Object Relational Mapping (ORM) Data Access</i></a>
</li><li class="listitem">
<a class="xref" href="#oxm" title="15.&nbsp;Marshalling XML using O/X Mappers">Chapter&nbsp;15, <i>Marshalling XML using O/X Mappers</i></a>
</li></ul></div>

</div>
<div class="chapter" title="11.&nbsp;Transaction Management"><div class="titlepage"><div><div><h2 class="title"><a name="transaction"></a>11.&nbsp;Transaction Management</h2></div></div></div>

<div class="section" title="11.1&nbsp;Introduction to Spring Framework transaction management"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-intro"></a>11.1&nbsp;Introduction to Spring Framework transaction management</h2></div></div></div>

<p>Comprehensive transaction support is among the most compelling reasons to use the Spring
Framework. The Spring Framework provides a consistent abstraction for transaction
management that delivers the following benefits:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Consistent programming model across different transaction APIs such as Java
Transaction API (JTA), JDBC, Hibernate, Java Persistence API (JPA), and Java Data
Objects (JDO).
</li><li class="listitem">
Support for <a class="link" href="#transaction-declarative" title="11.5&nbsp;Declarative transaction management">declarative transaction management</a>.
</li><li class="listitem">
Simpler API for <a class="link" href="#transaction-programmatic" title="11.6&nbsp;Programmatic transaction management">programmatic</a> transaction management than
complex transaction APIs such as JTA.
</li><li class="listitem">
Excellent integration with Spring&#8217;s data access abstractions.
</li></ul></div>

<p>The following sections describe the Spring Framework&#8217;s transaction value-adds and
technologies. (The chapter also includes discussions of best practices, application
server integration, and solutions to common problems.)</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="link" href="#transaction-motivation" title="11.2&nbsp;Advantages of the Spring Framework&#8217;s transaction support model">Advantages of the Spring Framework&#8217;s transaction support
model</a> describes <span class="emphasis"><em>why</em></span> you would use the Spring Framework&#8217;s transaction abstraction
instead of EJB Container-Managed Transactions (CMT) or choosing to drive local
transactions through a proprietary API such as Hibernate.
</li><li class="listitem">
<a class="link" href="#transaction-strategies" title="11.3&nbsp;Understanding the Spring Framework transaction abstraction">Understanding the Spring Framework transaction abstraction</a>
outlines the core classes and describes how to configure and obtain <code class="literal">DataSource</code>
instances from a variety of sources.
</li><li class="listitem">
<a class="link" href="#tx-resource-synchronization" title="11.4&nbsp;Synchronizing resources with transactions">Synchronizing resources with transactions</a>describes
how the application code ensures that resources are created, reused, and cleaned up
properly.
</li><li class="listitem">
<a class="link" href="#transaction-declarative" title="11.5&nbsp;Declarative transaction management">Declarative transaction management</a> describes support for
declarative transaction management.
</li><li class="listitem">
<a class="link" href="#transaction-programmatic" title="11.6&nbsp;Programmatic transaction management">Programmatic transaction management</a> covers support for
programmatic (that is, explicitly coded) transaction management.
</li></ul></div>

</div>
<div class="section" title="11.2&nbsp;Advantages of the Spring Framework&#8217;s transaction support model"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-motivation"></a>11.2&nbsp;Advantages of the Spring Framework&#8217;s transaction support model</h2></div></div></div>

<p>Traditionally, Java EE developers have had two choices for transaction management:
<span class="emphasis"><em>global</em></span> or <span class="emphasis"><em>local</em></span> transactions, both of which have profound limitations. Global
and local transaction management is reviewed in the next two sections, followed by a
discussion of how the Spring Framework&#8217;s transaction management support addresses the
limitations of the global and local transaction models.</p>
<div class="section" title="11.2.1&nbsp;Global transactions"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-global"></a>11.2.1&nbsp;Global transactions</h3></div></div></div>

<p>Global transactions enable you to work with multiple transactional resources, typically
relational databases and message queues. The application server manages global
transactions through the JTA, which is a cumbersome API to use (partly due to its
exception model). Furthermore, a JTA <code class="literal">UserTransaction</code> normally needs to be sourced from
JNDI, meaning that you <span class="emphasis"><em>also</em></span> need to use JNDI in order to use JTA. Obviously the use
of global transactions would limit any potential reuse of application code, as JTA is
normally only available in an application server environment.</p>
<p>Previously, the preferred way to use global transactions was via EJB <span class="emphasis"><em>CMT</em></span>
(<span class="emphasis"><em>Container Managed Transaction</em></span>): CMT is a form of <span class="emphasis"><em>declarative transaction
management</em></span> (as distinguished from <span class="emphasis"><em>programmatic transaction management</em></span>). EJB CMT
removes the need for transaction-related JNDI lookups, although of course the use of EJB
itself necessitates the use of JNDI. It removes most but not all of the need to write
Java code to control transactions. The significant downside is that CMT is tied to JTA
and an application server environment. Also, it is only available if one chooses to
implement business logic in EJBs, or at least behind a transactional EJB facade. The
negatives of EJB in general are so great that this is not an attractive proposition,
especially in the face of compelling alternatives for declarative transaction management.</p>
</div>
<div class="section" title="11.2.2&nbsp;Local transactions"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-local"></a>11.2.2&nbsp;Local transactions</h3></div></div></div>

<p>Local transactions are resource-specific, such as a transaction associated with a JDBC
connection. Local transactions may be easier to use, but have significant disadvantages:
they cannot work across multiple transactional resources. For example, code that manages
transactions using a JDBC connection cannot run within a global JTA transaction. Because
the application server is not involved in transaction management, it cannot help ensure
correctness across multiple resources. (It is worth noting that most applications use a
single transaction resource.) Another downside is that local transactions are invasive
to the programming model.</p>
</div>
<div class="section" title="11.2.3&nbsp;Spring Framework&#8217;s consistent programming model"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-programming-model"></a>11.2.3&nbsp;Spring Framework&#8217;s consistent programming model</h3></div></div></div>

<p>Spring resolves the disadvantages of global and local transactions. It enables
application developers to use a <span class="emphasis"><em>consistent</em></span> programming model <span class="emphasis"><em>in any environment</em></span>.
You write your code once, and it can benefit from different transaction management
strategies in different environments. The Spring Framework provides both declarative and
programmatic transaction management. Most users prefer declarative transaction
management, which is recommended in most cases.</p>
<p>With programmatic transaction management, developers work with the Spring Framework
transaction abstraction, which can run over any underlying transaction infrastructure.
With the preferred declarative model, developers typically write little or no code
related to transaction management, and hence do not depend on the Spring Framework
transaction API, or any other transaction API.</p>
<div class="sidebar" title="Do you need an application server for transaction management?"><p class="title"><b>Do you need an application server for transaction management?</b></p>

<p>The Spring Framework&#8217;s transaction management support changes traditional rules as to
when an enterprise Java application requires an application server.</p>
<p>In particular, you do not need an application server simply for declarative transactions
through EJBs. In fact, even if your application server has powerful JTA capabilities,
you may decide that the Spring Framework&#8217;s declarative transactions offer more power and
a more productive programming model than EJB CMT.</p>
<p>Typically you need an application server&#8217;s JTA capability only if your application needs
to handle transactions across multiple resources, which is not a requirement for many
applications. Many high-end applications use a single, highly scalable database (such as
Oracle RAC) instead. Standalone transaction managers such as
<a class="ulink" href="http://www.atomikos.com/" target="_top">Atomikos Transactions</a> and <a class="ulink" href="http://jotm.objectweb.org/" target="_top">JOTM</a>
are other options. Of course, you may need other application server capabilities such as
Java Message Service (JMS) and J2EE Connector Architecture (JCA).</p>
<p>The Spring Framework <span class="emphasis"><em>gives you the choice of when to scale your application to a fully
loaded application server</em></span>. Gone are the days when the only alternative to using EJB
CMT or JTA was to write code with local transactions such as those on JDBC connections,
and face a hefty rework if you need that code to run within global, container-managed
transactions. With the Spring Framework, only some of the bean definitions in your
configuration file, rather than your code, need to change.</p>
</div>

</div>
</div>
<div class="section" title="11.3&nbsp;Understanding the Spring Framework transaction abstraction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-strategies"></a>11.3&nbsp;Understanding the Spring Framework transaction abstraction</h2></div></div></div>

<p>The key to the Spring transaction abstraction is the notion of a <span class="emphasis"><em>transaction
strategy</em></span>. A transaction strategy is defined by the
<code class="literal">org.springframework.transaction.PlatformTransactionManager</code> interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> PlatformTransactionManager {

    TransactionStatus getTransaction(
            TransactionDefinition definition) <span class="hl-keyword">throws</span> TransactionException;

    <span class="hl-keyword">void</span> commit(TransactionStatus status) <span class="hl-keyword">throws</span> TransactionException;

    <span class="hl-keyword">void</span> rollback(TransactionStatus status) <span class="hl-keyword">throws</span> TransactionException;
}</pre>

<p>This is primarily a service provider interface (SPI), although it can be used
<a class="link" href="#transaction-programmatic-ptm" title="11.6.2&nbsp;Using the PlatformTransactionManager">programmatically</a> from your application code. Because
<code class="literal">PlatformTransactionManager</code> is an <span class="emphasis"><em>interface</em></span>, it can be easily mocked or stubbed as
necessary. It is not tied to a lookup strategy such as JNDI.
<code class="literal">PlatformTransactionManager</code> implementations are defined like any other object (or bean)
in the Spring Framework IoC container. This benefit alone makes Spring Framework
transactions a worthwhile abstraction even when you work with JTA. Transactional code
can be tested much more easily than if it used JTA directly.</p>
<p>Again in keeping with Spring&#8217;s philosophy, the <code class="literal">TransactionException</code> that can be thrown
by any of the <code class="literal">PlatformTransactionManager</code> interface&#8217;s methods is <span class="emphasis"><em>unchecked</em></span> (that
is, it extends the <code class="literal">java.lang.RuntimeException</code> class). Transaction infrastructure
failures are almost invariably fatal. In rare cases where application code can actually
recover from a transaction failure, the application developer can still choose to catch
and handle <code class="literal">TransactionException</code>. The salient point is that developers are not
<span class="emphasis"><em>forced</em></span> to do so.</p>
<p>The <code class="literal">getTransaction(..)</code> method returns a <code class="literal">TransactionStatus</code> object, depending on a
<code class="literal">TransactionDefinition</code> parameter. The returned <code class="literal">TransactionStatus</code> might represent a
new transaction, or can represent an existing transaction if a matching transaction
exists in the current call stack. The implication in this latter case is that, as with
Java EE transaction contexts, a <code class="literal">TransactionStatus</code> is associated with a <span class="emphasis"><em>thread</em></span> of
execution.</p>
<p>The <code class="literal">TransactionDefinition</code> interface specifies:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>Isolation</em></span>: The degree to which this transaction is isolated from the work of other
transactions. For example, can this transaction see uncommitted writes from other
transactions?
</li><li class="listitem">
<span class="emphasis"><em>Propagation</em></span>: Typically, all code executed within a transaction scope will run in
that transaction. However, you have the option of specifying the behavior in the event
that a transactional method is executed when a transaction context already exists. For
example, code can continue running in the existing transaction (the common case); or
the existing transaction can be suspended and a new transaction created. <span class="emphasis"><em>Spring
offers all of the transaction propagation options familiar from EJB CMT</em></span>. To read
about the semantics of transaction propagation in Spring, see <a class="xref" href="#tx-propagation" title="11.5.7&nbsp;Transaction propagation">Section&nbsp;11.5.7, &#8220;Transaction propagation&#8221;</a>.
</li><li class="listitem">
<span class="emphasis"><em>Timeout</em></span>: How long this transaction runs before timing out and being rolled back
automatically by the underlying transaction infrastructure.
</li><li class="listitem">
<span class="emphasis"><em>Read-only status</em></span>: A read-only transaction can be used when your code reads but
does not modify data. Read-only transactions can be a useful optimization in some
cases, such as when you are using Hibernate.
</li></ul></div>

<p>These settings reflect standard transactional concepts. If necessary, refer to resources
that discuss transaction isolation levels and other core transaction concepts.
Understanding these concepts is essential to using the Spring Framework or any
transaction management solution.</p>
<p>The <code class="literal">TransactionStatus</code> interface provides a simple way for transactional code to
control transaction execution and query transaction status. The concepts should be
familiar, as they are common to all transaction APIs:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TransactionStatus <span class="hl-keyword">extends</span> SavepointManager {

    <span class="hl-keyword">boolean</span> isNewTransaction();

    <span class="hl-keyword">boolean</span> hasSavepoint();

    <span class="hl-keyword">void</span> setRollbackOnly();

    <span class="hl-keyword">boolean</span> isRollbackOnly();

    <span class="hl-keyword">void</span> flush();

    <span class="hl-keyword">boolean</span> isCompleted();

}</pre>

<p>Regardless of whether you opt for declarative or programmatic transaction management in
Spring, defining the correct <code class="literal">PlatformTransactionManager</code> implementation is absolutely
essential. You typically define this implementation through dependency injection.</p>
<p><code class="literal">PlatformTransactionManager</code> implementations normally require knowledge of the
environment in which they work: JDBC, JTA, Hibernate, and so on. The following examples
show how you can define a local <code class="literal">PlatformTransactionManager</code> implementation. (This
example works with plain JDBC.)</p>
<p>You define a JDBC <code class="literal">DataSource</code></p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.driverClassName}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.url}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.username}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.password}"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The related <code class="literal">PlatformTransactionManager</code> bean definition will then have a reference to
the <code class="literal">DataSource</code> definition. It will look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>If you use JTA in a Java EE container then you use a container <code class="literal">DataSource</code>, obtained
through JNDI, in conjunction with Spring&#8217;s <code class="literal">JtaTransactionManager</code>. This is what the JTA
and JNDI lookup version would look like:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:jee</span>=<span class="hl-value">"http://www.springframework.org/schema/jee"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/jee
        http://www.springframework.org/schema/jee/spring-jee.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"jdbc/jpetstore"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The <code class="literal">JtaTransactionManager</code> does not need to know about the <code class="literal">DataSource</code>, or any other
specific resources, because it uses the container&#8217;s global transaction management
infrastructure.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The above definition of the <code class="literal">dataSource</code> bean uses the <code class="literal">&lt;jndi-lookup/&gt;</code> tag from the
<code class="literal">jee</code> namespace. For more information on schema-based configuration, see <a class="xref" href="#xsd-config" title="33.&nbsp;XML Schema-based configuration">Chapter&nbsp;33, <i>XML Schema-based configuration</i></a>,
and for more information on the <code class="literal">&lt;jee/&gt;</code> tags see the section entitled
<a class="xref" href="#xsd-config-body-schemas-jee" title="33.2.3&nbsp;the jee schema">Section&nbsp;33.2.3, &#8220;the jee schema&#8221;</a>.</p>
</td></tr></table></div>

<p>You can also use Hibernate local transactions easily, as shown in the following
examples. In this case, you need to define a Hibernate <code class="literal">LocalSessionFactoryBean</code>, which
your application code will use to obtain Hibernate <code class="literal">Session</code> instances.</p>
<p>The <code class="literal">DataSource</code> bean definition will be similar to the local JDBC example shown
previously and thus is not shown in the following example.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">DataSource</code>, used by any non-JTA transaction manager, is looked up via JNDI and
managed by a Java EE container, then it should be non-transactional because the Spring
Framework, rather than the Java EE container, will manage the transactions.</p>
</td></tr></table></div>

<p>The <code class="literal">txManager</code> bean in this case is of the <code class="literal">HibernateTransactionManager</code> type. In the
same way as the <code class="literal">DataSourceTransactionManager</code> needs a reference to the <code class="literal">DataSource</code>,
the <code class="literal">HibernateTransactionManager</code> needs a reference to the <code class="literal">SessionFactory</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingResources"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>org/springframework/samples/petclinic/hibernate/petclinic.hbm.xml<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hibernateProperties"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;value&gt;</span>
            hibernate.dialect=${hibernate.dialect}
        <span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionFactory"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>If you are using Hibernate and Java EE container-managed JTA transactions, then you
should simply use the same <code class="literal">JtaTransactionManager</code> as in the previous JTA example for
JDBC.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you use JTA , then your transaction manager definition will look the same regardless
of what data access technology you use, be it JDBC, Hibernate JPA or any other supported
technology. This is due to the fact that JTA transactions are global transactions, which
can enlist any transactional resource.</p>
</td></tr></table></div>

<p>In all these cases, application code does not need to change. You can change how
transactions are managed merely by changing configuration, even if that change means
moving from local to global transactions or vice versa.</p>
</div>
<div class="section" title="11.4&nbsp;Synchronizing resources with transactions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tx-resource-synchronization"></a>11.4&nbsp;Synchronizing resources with transactions</h2></div></div></div>

<p>It should now be clear how you create different transaction managers, and how they are
linked to related resources that need to be synchronized to transactions (for example
<code class="literal">DataSourceTransactionManager</code> to a JDBC <code class="literal">DataSource</code>, <code class="literal">HibernateTransactionManager</code> to
a Hibernate <code class="literal">SessionFactory</code>, and so forth). This section describes how the application
code, directly or indirectly using a persistence API such as JDBC, Hibernate, or JDO,
ensures that these resources are created, reused, and cleaned up properly. The section
also discusses how transaction synchronization is triggered (optionally) through the
relevant <code class="literal">PlatformTransactionManager</code>.</p>
<div class="section" title="11.4.1&nbsp;High-level synchronization approach"><div class="titlepage"><div><div><h3 class="title"><a name="tx-resource-synchronization-high"></a>11.4.1&nbsp;High-level synchronization approach</h3></div></div></div>

<p>The preferred approach is to use Spring&#8217;s highest level template based persistence
integration APIs or to use native ORM APIs with transaction- aware factory beans or
proxies for managing the native resource factories. These transaction-aware solutions
internally handle resource creation and reuse, cleanup, optional transaction
synchronization of the resources, and exception mapping. Thus user data access code does
not have to address these tasks, but can be focused purely on non-boilerplate
persistence logic. Generally, you use the native ORM API or take a <span class="emphasis"><em>template</em></span> approach
for JDBC access by using the <code class="literal">JdbcTemplate</code>. These solutions are detailed in subsequent
chapters of this reference documentation.</p>
</div>
<div class="section" title="11.4.2&nbsp;Low-level synchronization approach"><div class="titlepage"><div><div><h3 class="title"><a name="tx-resource-synchronization-low"></a>11.4.2&nbsp;Low-level synchronization approach</h3></div></div></div>

<p>Classes such as <code class="literal">DataSourceUtils</code> (for JDBC), <code class="literal">EntityManagerFactoryUtils</code> (for JPA),
<code class="literal">SessionFactoryUtils</code> (for Hibernate), <code class="literal">PersistenceManagerFactoryUtils</code> (for JDO), and
so on exist at a lower level. When you want the application code to deal directly with
the resource types of the native persistence APIs, you use these classes to ensure that
proper Spring Framework-managed instances are obtained, transactions are (optionally)
synchronized, and exceptions that occur in the process are properly mapped to a
consistent API.</p>
<p>For example, in the case of JDBC, instead of the traditional JDBC approach of calling
the <code class="literal">getConnection()</code> method on the <code class="literal">DataSource</code>, you instead use Spring&#8217;s
<code class="literal">org.springframework.jdbc.datasource.DataSourceUtils</code> class as follows:</p>
<pre class="programlisting">Connection conn = DataSourceUtils.getConnection(dataSource);</pre>

<p>If an existing transaction already has a connection synchronized (linked) to it, that
instance is returned. Otherwise, the method call triggers the creation of a new
connection, which is (optionally) synchronized to any existing transaction, and made
available for subsequent reuse in that same transaction. As mentioned, any
<code class="literal">SQLException</code> is wrapped in a Spring Framework <code class="literal">CannotGetJdbcConnectionException</code>, one
of the Spring Framework&#8217;s hierarchy of unchecked DataAccessExceptions. This approach
gives you more information than can be obtained easily from the <code class="literal">SQLException</code>, and
ensures portability across databases, even across different persistence technologies.</p>
<p>This approach also works without Spring transaction management (transaction
synchronization is optional), so you can use it whether or not you are using Spring for
transaction management.</p>
<p>Of course, once you have used Spring&#8217;s JDBC support, JPA support or Hibernate support,
you will generally prefer not to use <code class="literal">DataSourceUtils</code> or the other helper classes,
because you will be much happier working through the Spring abstraction than directly
with the relevant APIs. For example, if you use the Spring <code class="literal">JdbcTemplate</code> or
<code class="literal">jdbc.object</code> package to simplify your use of JDBC, correct connection retrieval occurs
behind the scenes and you won&#8217;t need to write any special code.</p>
</div>
<div class="section" title="11.4.3&nbsp;TransactionAwareDataSourceProxy"><div class="titlepage"><div><div><h3 class="title"><a name="tx-resource-synchronization-tadsp"></a>11.4.3&nbsp;TransactionAwareDataSourceProxy</h3></div></div></div>

<p>At the very lowest level exists the <code class="literal">TransactionAwareDataSourceProxy</code> class. This is a
proxy for a target <code class="literal">DataSource</code>, which wraps the target <code class="literal">DataSource</code> to add awareness of
Spring-managed transactions. In this respect, it is similar to a transactional JNDI
<code class="literal">DataSource</code> as provided by a Java EE server.</p>
<p>It should almost never be necessary or desirable to use this class, except when existing
code must be called and passed a standard JDBC <code class="literal">DataSource</code> interface implementation. In
that case, it is possible that this code is usable, but participating in Spring managed
transactions. It is preferable to write your new code by using the higher level
abstractions mentioned above.</p>
</div>
</div>
<div class="section" title="11.5&nbsp;Declarative transaction management"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-declarative"></a>11.5&nbsp;Declarative transaction management</h2></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Most Spring Framework users choose declarative transaction management. This option has
the least impact on application code, and hence is most consistent with the ideals of a
<span class="emphasis"><em>non-invasive</em></span> lightweight container.</p>
</td></tr></table></div>

<p>The Spring Framework&#8217;s declarative transaction management is made possible with Spring
aspect-oriented programming (AOP), although, as the transactional aspects code comes
with the Spring Framework distribution and may be used in a boilerplate fashion, AOP
concepts do not generally have to be understood to make effective use of this code.</p>
<p>The Spring Framework&#8217;s declarative transaction management is similar to EJB CMT in that
you can specify transaction behavior (or lack of it) down to individual method level. It
is possible to make a <code class="literal">setRollbackOnly()</code> call within a transaction context if
necessary. The differences between the two types of transaction management are:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Unlike EJB CMT, which is tied to JTA, the Spring Framework&#8217;s declarative transaction
management works in any environment. It can work with JTA transactions or local
transactions using JDBC, JPA, Hibernate or JDO by simply adjusting the configuration
files.
</li><li class="listitem">
You can apply the Spring Framework declarative transaction management to any class,
not merely special classes such as EJBs.
</li><li class="listitem">
The Spring Framework offers declarative
<a class="link" href="#transaction-declarative-rolling-back" title="11.5.3&nbsp;Rolling back a declarative transaction"><span class="emphasis"><em>rollback rules</em></span>,</a>a feature with no EJB
equivalent. Both programmatic and declarative support for rollback rules is provided.
</li><li class="listitem">
The Spring Framework enables you to customize transactional behavior, by using AOP.
For example, you can insert custom behavior in the case of transaction rollback. You
can also add arbitrary advice, along with the transactional advice. With EJB CMT, you
cannot influence the container&#8217;s transaction management except with
<code class="literal">setRollbackOnly()</code>.
</li><li class="listitem">
The Spring Framework does not support propagation of transaction contexts across
remote calls, as do high-end application servers. If you need this feature, we
recommend that you use EJB. However, consider carefully before using such a feature,
because normally, one does not want transactions to span remote calls.
</li></ul></div>

<div class="sidebar" title="Where is TransactionProxyFactoryBean?"><p class="title"><b>Where is TransactionProxyFactoryBean?</b></p>

<p>Declarative transaction configuration in versions of Spring 2.0 and above differs
considerably from previous versions of Spring. The main difference is that there is no
longer any need to configure <code class="literal">TransactionProxyFactoryBean</code> beans.</p>
<p>The pre-Spring 2.0 configuration style is still 100% valid configuration; think of the
new <code class="literal">&lt;tx:tags/&gt;</code> as simply defining <code class="literal">TransactionProxyFactoryBean</code> beans on your behalf.</p>
</div>

<p>The concept of rollback rules is important: they enable you to specify which exceptions
(and throwables) should cause automatic rollback. You specify this declaratively, in
configuration, not in Java code. So, although you can still call <code class="literal">setRollbackOnly()</code> on
the <code class="literal">TransactionStatus</code> object to roll back the current transaction back, most often you
can specify a rule that <code class="literal">MyApplicationException</code> must always result in rollback. The
significant advantage to this option is that business objects do not depend on the
transaction infrastructure. For example, they typically do not need to import Spring
transaction APIs or other Spring APIs.</p>
<p>Although EJB container default behavior automatically rolls back the transaction on a
<span class="emphasis"><em>system exception</em></span> (usually a runtime exception), EJB CMT does not roll back the
transaction automatically on an<span class="emphasis"><em>application exception</em></span> (that is, a checked exception
other than <code class="literal">java.rmi.RemoteException</code>). While the Spring default behavior for
declarative transaction management follows EJB convention (roll back is automatic only
on unchecked exceptions), it is often useful to customize this behavior.</p>
<div class="section" title="11.5.1&nbsp;Understanding the Spring Framework&#8217;s declarative transaction implementation"><div class="titlepage"><div><div><h3 class="title"><a name="tx-decl-explained"></a>11.5.1&nbsp;Understanding the Spring Framework&#8217;s declarative transaction implementation</h3></div></div></div>

<p>It is not sufficient to tell you simply to annotate your classes with the
<code class="literal">@Transactional</code> annotation, add <code class="literal">@EnableTransactionManagement</code> to your configuration,
and then expect you to understand how it all works. This section explains the inner
workings of the Spring Framework&#8217;s declarative transaction infrastructure in the event
of transaction-related issues.</p>
<p>The most important concepts to grasp with regard to the Spring Framework&#8217;s declarative
transaction support are that this support is enabled
<a class="link" href="#aop-understanding-aop-proxies" title="8.6.1&nbsp;Understanding AOP proxies"><span class="emphasis"><em>via AOP proxies</em></span></a>, and that the transactional advice
is driven by <span class="emphasis"><em>metadata</em></span> (currently XML- or annotation-based). The combination of AOP
with transactional metadata yields an AOP proxy that uses a <code class="literal">TransactionInterceptor</code> in
conjunction with an appropriate <code class="literal">PlatformTransactionManager</code> implementation to drive
transactions <span class="emphasis"><em>around method invocations</em></span>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring AOP is covered in <a class="xref" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">Chapter&nbsp;8, <i>Aspect Oriented Programming with Spring</i></a>.</p>
</td></tr></table></div>

<p>Conceptually, calling a method on a transactional proxy looks like this&#8230;</p>
<div class="figure"><a name="d4e9804"></a><p class="title"><b>Figure&nbsp;11.1.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/tx.png" alt="tx"></div>
</div></div><br class="figure-break">

</div>
<div class="section" title="11.5.2&nbsp;Example of declarative transaction implementation"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-declarative-first-example"></a>11.5.2&nbsp;Example of declarative transaction implementation</h3></div></div></div>

<p>Consider the following interface, and its attendant implementation. This example uses
<code class="literal">Foo</code> and <code class="literal">Bar</code> classes as placeholders so that you can concentrate on the transaction
usage without focusing on a particular domain model. For the purposes of this example,
the fact that the <code class="literal">DefaultFooService</code> class throws <code class="literal">UnsupportedOperationException</code>
instances in the body of each implemented method is good; it allows you to see
transactions created and then rolled back in response to the
<code class="literal">UnsupportedOperationException</code> instance.</p>
<pre class="programlisting"><span class="hl-comment">// the service interface that we want to make transactional</span>

<span class="hl-keyword">package</span> x.y.service;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FooService {

    Foo getFoo(String fooName);

    Foo getFoo(String fooName, String barName);

    <span class="hl-keyword">void</span> insertFoo(Foo foo);

    <span class="hl-keyword">void</span> updateFoo(Foo foo);

}</pre>

<pre class="programlisting"><span class="hl-comment">// an implementation of the above interface</span>

<span class="hl-keyword">package</span> x.y.service;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultFooService <span class="hl-keyword">implements</span> FooService {

    <span class="hl-keyword">public</span> Foo getFoo(String fooName) {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UnsupportedOperationException();
    }

    <span class="hl-keyword">public</span> Foo getFoo(String fooName, String barName) {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UnsupportedOperationException();
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> insertFoo(Foo foo) {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UnsupportedOperationException();
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> updateFoo(Foo foo) {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UnsupportedOperationException();
    }

}</pre>

<p>Assume that the first two methods of the <code class="literal">FooService</code> interface, <code class="literal">getFoo(String)</code> and
<code class="literal">getFoo(String, String)</code>, must execute in the context of a transaction with read-only
semantics, and that the other methods, <code class="literal">insertFoo(Foo)</code> and <code class="literal">updateFoo(Foo)</code>, must
execute in the context of a transaction with read-write semantics. The following
configuration is explained in detail in the next few paragraphs.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- from the file </span><span class="emphasis"><em>context.xml</em></span> --&gt;
<span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- this is the service object that we want to make transactional --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.DefaultFooService"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- the transactional advice (what </span><span class="emphasis"><em>happens</em></span>; see the <span class="hl-tag">&lt;aop:advisor/&gt;</span> bean below) --&gt;
    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- the transactional semantics... --&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-comment">&lt;!-- all methods starting with </span><span class="emphasis"><em>get</em></span> are read-only --&gt;
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"get*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-comment">&lt;!-- other methods use the default transaction settings (see below) --&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"</span><span class="strong"><strong>"/&gt;
        &lt;/tx:attributes&gt;
    &lt;/tx:advice&gt;

    &lt;!-- ensure that the above transactional advice runs for any execution
        of an operation defined by the FooService interface --&gt;
    &lt;aop:config&gt;
        &lt;aop:pointcut id="fooServiceOperation" expression="execution(</strong></span> x.y.service.FooService.*(..))"/&gt;
        <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"fooServiceOperation"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/aop:config&gt;</span>

    <span class="hl-comment">&lt;!-- don't forget the DataSource --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"oracle.jdbc.driver.OracleDriver"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc:oracle:thin:@rj-t42:1521:elvis"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"scott"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"tiger"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- similarly, don't forget the PlatformTransactionManager --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Examine the preceding configuration. You want to make a service object, the <code class="literal">fooService</code>
bean, transactional. The transaction semantics to apply are encapsulated in the
<code class="literal">&lt;tx:advice/&gt;</code> definition. The <code class="literal">&lt;tx:advice/&gt;</code> definition reads as "<span class="emphasis"><em>&#8230; all methods on
starting with <code class="literal">'get'</code> are to execute in the context of a read-only transaction, and all
other methods are to execute with the default transaction semantics</em></span>". The
<code class="literal">transaction-manager</code> attribute of the <code class="literal">&lt;tx:advice/&gt;</code> tag is set to the name of the
<code class="literal">PlatformTransactionManager</code> bean that is going to <span class="emphasis"><em>drive</em></span> the transactions, in this
case, the <code class="literal">txManager</code> bean.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>You can omit the <code class="literal">transaction-manager</code> attribute in the transactional advice (
<code class="literal">&lt;tx:advice/&gt;</code>) if the bean name of the <code class="literal">PlatformTransactionManager</code> that you want to
wire in has the name <code class="literal">transactionManager</code>. If the <code class="literal">PlatformTransactionManager</code> bean that
you want to wire in has any other name, then you must use the <code class="literal">transaction-manager</code>
attribute explicitly, as in the preceding example.</p>
</td></tr></table></div>

<p>The <code class="literal">&lt;aop:config/&gt;</code> definition ensures that the transactional advice defined by the
<code class="literal">txAdvice</code> bean executes at the appropriate points in the program. First you define a
pointcut that matches the execution of any operation defined in the <code class="literal">FooService</code>
interface ( <code class="literal">fooServiceOperation</code>). Then you associate the pointcut with the <code class="literal">txAdvice</code>
using an advisor. The result indicates that at the execution of a <code class="literal">fooServiceOperation</code>,
the advice defined by <code class="literal">txAdvice</code> will be run.</p>
<p>The expression defined within the <code class="literal">&lt;aop:pointcut/&gt;</code> element is an AspectJ pointcut
expression; see <a class="xref" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">Chapter&nbsp;8, <i>Aspect Oriented Programming with Spring</i></a> for more details on pointcut expressions in Spring.</p>
<p>A common requirement is to make an entire service layer transactional. The best way to
do this is simply to change the pointcut expression to match any operation in your
service layer. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>
    <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooServiceMethods"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* x.y.service.</span><span class="strong"><strong>.</strong></span>(..))"/&gt;
    <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"fooServiceMethods"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>In this example it is assumed that all your service interfaces are defined in the
<code class="literal">x.y.service</code> package; see <a class="xref" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">Chapter&nbsp;8, <i>Aspect Oriented Programming with Spring</i></a> for more details.</em></span></p>
</td></tr></table></div>

<p>Now that we&#8217;ve analyzed the configuration, you may be asking yourself, "<span class="emphasis"><em>Okay&#8230; but
what does all this configuration actually do?</em></span>".</p>
<p>The above configuration will be used to create a transactional proxy around the object
that is created from the <code class="literal">fooService</code> bean definition. The proxy will be configured with
the transactional advice, so that when an appropriate method is invoked <span class="emphasis"><em>on the
proxy</em></span>, a transaction is started, suspended, marked as read-only, and so on, depending
on the transaction configuration associated with that method. Consider the following
program that test drives the above configuration:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> Boot {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(<span class="hl-keyword">final</span> String[] args) <span class="hl-keyword">throws</span> Exception {
        ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"context.xml"</span>, Boot.<span class="hl-keyword">class</span>);
        FooService fooService = (FooService) ctx.getBean(<span class="hl-string">"fooService"</span>);
        fooService.insertFoo (<span class="hl-keyword">new</span> Foo());
    }
}</pre>

<p>The output from running the preceding program will resemble the following. (The Log4J
output and the stack trace from the UnsupportedOperationException thrown by the
insertFoo(..) method of the DefaultFooService class have been truncated for clarity.)</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- the Spring container is starting up... --&gt;</span>
[AspectJInvocationContextExposingAdvisorAutoProxyCreator] - Creating implicit proxy for bean <span class="emphasis"><em>fooService</em></span> with 0 common interceptors and 1 specific interceptors

<span class="hl-comment">&lt;!-- the DefaultFooService is actually proxied --&gt;</span>
[JdkDynamicAopProxy] - Creating JDK dynamic proxy for [x.y.service.DefaultFooService]

<span class="hl-comment">&lt;!-- ... the insertFoo(..) method is now being invoked on the proxy --&gt;</span>
[TransactionInterceptor] - Getting transaction for x.y.service.FooService.insertFoo

<span class="hl-comment">&lt;!-- the transactional advice kicks in here... --&gt;</span>
[DataSourceTransactionManager] - Creating new transaction with name [x.y.service.FooService.insertFoo]
[DataSourceTransactionManager] - Acquired Connection [org.apache.commons.dbcp.PoolableConnection@a53de4] for JDBC transaction

<span class="hl-comment">&lt;!-- the insertFoo(..) method from DefaultFooService throws an exception... --&gt;</span>
[RuleBasedTransactionAttribute] - Applying rules to determine whether transaction should rollback on java.lang.UnsupportedOperationException
[TransactionInterceptor] - Invoking rollback for transaction on x.y.service.FooService.insertFoo due to throwable [java.lang.UnsupportedOperationException]

<span class="hl-comment">&lt;!-- and the transaction is rolled back (by default, RuntimeException instances cause rollback) --&gt;</span>
[DataSourceTransactionManager] - Rolling back JDBC transaction on Connection [org.apache.commons.dbcp.PoolableConnection@a53de4]
[DataSourceTransactionManager] - Releasing JDBC Connection after transaction
[DataSourceUtils] - Returning JDBC Connection to DataSource

Exception in thread "main" java.lang.UnsupportedOperationException at x.y.service.DefaultFooService.insertFoo(DefaultFooService.java:14)
<span class="hl-comment">&lt;!-- AOP infrastructure stack trace elements removed for clarity --&gt;</span>
at $Proxy0.insertFoo(Unknown Source)
at Boot.main(Boot.java:11)</pre>

</div>
<div class="section" title="11.5.3&nbsp;Rolling back a declarative transaction"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-declarative-rolling-back"></a>11.5.3&nbsp;Rolling back a declarative transaction</h3></div></div></div>

<p>The previous section outlined the basics of how to specify transactional settings for
classes, typically service layer classes, declaratively in your application. This
section describes how you can control the rollback of transactions in a simple
declarative fashion.</p>
<p>The recommended way to indicate to the Spring Framework&#8217;s transaction infrastructure
that a transaction&#8217;s work is to be rolled back is to throw an <code class="literal">Exception</code> from code that
is currently executing in the context of a transaction. The Spring Framework&#8217;s
transaction infrastructure code will catch any unhandled <code class="literal">Exception</code> as it bubbles up
the call stack, and make a determination whether to mark the transaction for rollback.</p>
<p>In its default configuration, the Spring Framework&#8217;s transaction infrastructure code
<span class="emphasis"><em>only</em></span> marks a transaction for rollback in the case of runtime, unchecked exceptions;
that is, when the thrown exception is an instance or subclass of <code class="literal">RuntimeException</code>. (
<code class="literal">Error</code> s will also - by default - result in a rollback). Checked exceptions that are
thrown from a transactional method do <span class="emphasis"><em>not</em></span> result in rollback in the default
configuration.</p>
<p>You can configure exactly which <code class="literal">Exception</code> types mark a transaction for rollback,
including checked exceptions. The following XML snippet demonstrates how you configure
rollback for a checked, application-specific <code class="literal">Exception</code> type.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;tx:attributes&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"get*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">rollback-for</span>=<span class="hl-value">"NoProductInStockException"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/tx:attributes&gt;</span>
<span class="hl-tag">&lt;/tx:advice&gt;</span></pre>

<p>You can also specify <span class="emphasis"><em>no rollback rules</em></span>, if you do <span class="emphasis"><em>not</em></span> want a transaction rolled
back when an exception is thrown. The following example tells the Spring Framework&#8217;s
transaction infrastructure to commit the attendant transaction even in the face of an
unhandled <code class="literal">InstrumentNotFoundException</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;tx:attributes&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"updateStock"</span> <span class="hl-attribute">no-rollback-for</span>=<span class="hl-value">"InstrumentNotFoundException"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/tx:attributes&gt;</span>
<span class="hl-tag">&lt;/tx:advice&gt;</span></pre>

<p>When the Spring Framework&#8217;s transaction infrastructure catches an exception and is
consults configured rollback rules to determine whether to mark the transaction for
rollback, the <span class="emphasis"><em>strongest</em></span> matching rule wins. So in the case of the following
configuration, any exception other than an <code class="literal">InstrumentNotFoundException</code> results in a
rollback of the attendant transaction.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;tx:attributes&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">rollback-for</span>=<span class="hl-value">"Throwable"</span> <span class="hl-attribute">no-rollback-for</span>=<span class="hl-value">"InstrumentNotFoundException"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/tx:attributes&gt;</span>
<span class="hl-tag">&lt;/tx:advice&gt;</span></pre>

<p>You can also indicate a required rollback <span class="emphasis"><em>programmatically</em></span>. Although very simple,
this process is quite invasive, and tightly couples your code to the Spring Framework&#8217;s
transaction infrastructure:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> resolvePosition() {
    <span class="hl-keyword">try</span> {
        <span class="hl-comment">// some business logic...</span>
    } <span class="hl-keyword">catch</span> (NoProductInStockException ex) {
        <span class="hl-comment">// trigger rollback programmatically</span>
        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
    }
}</pre>

<p>You are strongly encouraged to use the declarative approach to rollback if at all
possible. Programmatic rollback is available should you absolutely need it, but its
usage flies in the face of achieving a clean POJO-based architecture.</p>
</div>
<div class="section" title="11.5.4&nbsp;Configuring different transactional semantics for different beans"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-declarative-diff-tx"></a>11.5.4&nbsp;Configuring different transactional semantics for different beans</h3></div></div></div>

<p>Consider the scenario where you have a number of service layer objects, and you want to
apply a <span class="emphasis"><em>totally different</em></span> transactional configuration to each of them. You do this
by defining distinct <code class="literal">&lt;aop:advisor/&gt;</code> elements with differing <code class="literal">pointcut</code> and
<code class="literal">advice-ref</code> attribute values.</p>
<p>As a point of comparison, first assume that all of your service layer classes are
defined in a root <code class="literal">x.y.service</code> package. To make all beans that are instances of classes
defined in that package (or in subpackages) and that have names ending in <code class="literal">Service</code> have
the default transactional configuration, you would write the following:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>

        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serviceOperation"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* x.y.service..</span><span class="strong"><strong>Service.</strong></span>(..))"/&gt;

        <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"serviceOperation"</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;/aop:config&gt;</span>

    <span class="hl-comment">&lt;!-- these two beans will be transactional... --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.DefaultFooService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"barService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.extras.SimpleBarService"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- ... and these two beans won't --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anotherService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.xyz.SomeService"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- (not in the right package) --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"barManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.SimpleBarManager"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- (doesn't end in </span><span class="emphasis"><em>Service</em></span>) --&gt;

    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"get*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

    <span class="hl-comment">&lt;!-- other transaction infrastructure beans such as a PlatformTransactionManager omitted... --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The following example shows how to configure two distinct beans with totally different
transactional settings.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>

        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"defaultServiceOperation"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* x.y.service.</span><span class="strong"><strong>Service.</strong></span>(..))"/&gt;

        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"noTxServiceOperation"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* x.y.service.ddl.DefaultDdlManager.</span><span class="strong"><strong>(..))"/&gt;

        &lt;aop:advisor pointcut-ref="defaultServiceOperation" advice-ref="defaultTxAdvice"/&gt;

        &lt;aop:advisor pointcut-ref="noTxServiceOperation" advice-ref="noTxAdvice"/&gt;

    &lt;/aop:config&gt;

    &lt;!-- this bean will be transactional (see the <span class="emphasis"><em>defaultServiceOperation</em></span> pointcut) --&gt;
    &lt;bean id="fooService" class="x.y.service.DefaultFooService"/&gt;

    &lt;!-- this bean will also be transactional, but with totally different transactional settings --&gt;
    &lt;bean id="anotherFooService" class="x.y.service.ddl.DefaultDdlManager"/&gt;

    &lt;tx:advice id="defaultTxAdvice"&gt;
        &lt;tx:attributes&gt;
            &lt;tx:method name="get</strong></span>" read-only="true"/&gt;
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"</span><span class="strong"><strong>"/&gt;
        &lt;/tx:attributes&gt;
    &lt;/tx:advice&gt;

    &lt;tx:advice id="noTxAdvice"&gt;
        &lt;tx:attributes&gt;
            &lt;tx:method name="</strong></span>" propagation="NEVER"/&gt;
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

    <span class="hl-comment">&lt;!-- other transaction infrastructure beans such as a PlatformTransactionManager omitted... --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="11.5.5&nbsp;<tx:advice/&gt; settings"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-declarative-txadvice-settings"></a>11.5.5&nbsp;&lt;tx:advice/&gt; settings</h3></div></div></div>

<p>This section summarizes the various transactional settings that can be specified using
the <code class="literal">&lt;tx:advice/&gt;</code> tag. The default <code class="literal">&lt;tx:advice/&gt;</code> settings are:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="link" href="#tx-propagation" title="11.5.7&nbsp;Transaction propagation">Propagation setting</a> is <code class="literal">REQUIRED.</code>
</li><li class="listitem">
Isolation level is <code class="literal">DEFAULT.</code>
</li><li class="listitem">
Transaction is read/write.
</li><li class="listitem">
Transaction timeout defaults to the default timeout of the underlying transaction
system, or none if timeouts are not supported.
</li><li class="listitem">
Any <code class="literal">RuntimeException</code> triggers rollback, and any checked <code class="literal">Exception</code> does not.
</li></ul></div>

<p>You can change these default settings; the various attributes of the <code class="literal">&lt;tx:method/&gt;</code> tags
that are nested within <code class="literal">&lt;tx:advice/&gt;</code> and <code class="literal">&lt;tx:attributes/&gt;</code> tags are summarized below:</p>
<div class="table"><a name="tx-method-settings"></a><p class="title"><b>Table&nbsp;11.1.&nbsp;&lt;tx:method/&gt; settings</b></p><div class="table-contents">

  <table summary="<tx:method/&gt; settings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Default</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">name</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Yes</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Method name(s) with which the transaction attributes are to be associated. The
  wildcard (*) character can be used to associate the same transaction attribute
  settings with a number of methods; for example, <code class="literal">get*</code>, <code class="literal">handle*</code>, <code class="literal">on*Event</code>, and so
  forth.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">propagation</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REQUIRED</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Transaction propagation behavior.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">isolation</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DEFAULT</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Transaction isolation level.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>-1</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Transaction timeout value (in seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">read-only</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Is this transaction read-only?</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">rollback-for</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">Exception(s)</code> that trigger rollback; comma-delimited. For example,
  <code class="literal">com.foo.MyBusinessException,ServletException.</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">no-rollback-for</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>No</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top"><p><code class="literal">Exception(s)</code> that do <span class="emphasis"><em>not</em></span> trigger rollback; comma-delimited. For example,
  <code class="literal">com.foo.MyBusinessException,ServletException.</code></p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="11.5.6&nbsp;Using @Transactional"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-declarative-annotations"></a>11.5.6&nbsp;Using @Transactional</h3></div></div></div>

<p>In addition to the XML-based declarative approach to transaction configuration, you can
use an annotation-based approach. Declaring transaction semantics directly in the Java
source code puts the declarations much closer to the affected code. There is not much
danger of undue coupling, because code that is meant to be used transactionally is
almost always deployed that way anyway.</p>
<p>The ease-of-use afforded by the use of the <code class="literal">@Transactional</code> annotation is best
illustrated with an example, which is explained in the text that follows. Consider the
following class definition:</p>
<pre class="programlisting"><span class="hl-comment">// the service class that we want to make transactional</span>
<span class="strong"><strong>@Transactional</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultFooService <span class="hl-keyword">implements</span> FooService {

    Foo getFoo(String fooName);

    Foo getFoo(String fooName, String barName);

    <span class="hl-keyword">void</span> insertFoo(Foo foo);

    <span class="hl-keyword">void</span> updateFoo(Foo foo);
}</pre>

<p>When the above POJO is defined as a bean in a Spring IoC container, the bean instance
can be made transactional by adding merely <span class="emphasis"><em>one</em></span> line of XML configuration:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- from the file </span><span class="emphasis"><em>context.xml</em></span> --&gt;
<span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- this is the service object that we want to make transactional --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.DefaultFooService"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- enable the configuration of transactional behavior based on annotations --&gt;</span>
    <span class="emphasis"><em>&lt;tx:annotation-driven transaction-manager="txManager"/&gt;</em></span><span class="hl-comment">&lt;!-- a PlatformTransactionManager is still required --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- (this dependency is defined somewhere else) --&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>You can omit the <code class="literal">transaction-manager</code> attribute in the <code class="literal">&lt;tx:annotation-driven/&gt;</code> tag if
the bean name of the <code class="literal">PlatformTransactionManager</code> that you want to wire in has the name
<code class="literal">transactionManager</code>. If the <code class="literal">PlatformTransactionManager</code> bean that you want to
dependency-inject has any other name, then you have to use the <code class="literal">transaction-manager</code>
attribute explicitly, as in the preceding example.</p>
</td></tr></table></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">@EnableTransactionManagement</code> annotation provides equivalent support if you are
using Java based configuration. Simply add the annotation to a <code class="literal">@Configuration</code> class.
See Javadoc for full details.</p>
</td></tr></table></div>

<div class="sidebar" title="Method visibility and @Transactional"><p class="title"><b>Method visibility and @Transactional</b></p>

<p>When using proxies, you should apply the <code class="literal">@Transactional</code> annotation only to methods
with <span class="emphasis"><em>public</em></span> visibility. If you do annotate protected, private or package-visible
methods with the <code class="literal">@Transactional</code> annotation, no error is raised, but the annotated
method does not exhibit the configured transactional settings. Consider the use of
AspectJ (see below) if you need to annotate non-public methods.</p>
</div>

<p>You can place the <code class="literal">@Transactional</code> annotation before an interface definition, a method
on an interface, a class definition, or a <span class="emphasis"><em>public</em></span> method on a class. However, the
mere presence of the <code class="literal">@Transactional</code> annotation is not enough to activate the
transactional behavior. The <code class="literal">@Transactional</code> annotation is simply metadata that can be
consumed by some runtime infrastructure that is <code class="literal">@Transactional</code>-aware and that can use
the metadata to configure the appropriate beans with transactional behavior. In the
preceding example, the <code class="literal">&lt;tx:annotation-driven/&gt;</code> element <span class="emphasis"><em>switches on</em></span> the
transactional behavior.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Spring recommends that you only annotate concrete classes (and methods of concrete
classes) with the <code class="literal">@Transactional</code> annotation, as opposed to annotating interfaces. You
certainly can place the <code class="literal">@Transactional</code> annotation on an interface (or an interface
method), but this works only as you would expect it to if you are using interface-based
proxies. The fact that Java annotations are <span class="emphasis"><em>not inherited from interfaces</em></span> means that
if you are using class-based proxies ( <code class="literal">proxy-target-class="true"</code>) or the weaving-based
aspect ( <code class="literal">mode="aspectj"</code>), then the transaction settings are not recognized by the
proxying and weaving infrastructure, and the object will not be wrapped in a
transactional proxy, which would be decidedly <span class="emphasis"><em>bad</em></span>.</p>
</td></tr></table></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In proxy mode (which is the default), only external method calls coming in through the
proxy are intercepted. This means that self-invocation, in effect, a method within the
target object calling another method of the target object, will not lead to an actual
transaction at runtime even if the invoked method is marked with <code class="literal">@Transactional</code>.</p>
</td></tr></table></div>

<p>Consider the use of AspectJ mode (see mode attribute in table below) if you expect
self-invocations to be wrapped with transactions as well. In this case, there will not
be a proxy in the first place; instead, the target class will be weaved (that is, its
byte code will be modified) in order to turn <code class="literal">@Transactional</code> into runtime behavior on
any kind of method.</p>
<div class="table"><a name="tx-annotation-driven-settings"></a><p class="title"><b>Table&nbsp;11.2.&nbsp;Annotation driven transaction settings</b></p><div class="table-contents">

  <table summary="Annotation driven transaction settings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">XML Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Annotation Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Default</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">transaction-manager</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A (See <code class="literal">TransactionManagementConfigurer</code> Javadoc)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>transactionManager</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of transaction manager to use. Only required if the name of the transaction
  manager is not <code class="literal">transactionManager</code>, as in the example above.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">mode</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">mode</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>proxy</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The default mode "proxy" processes annotated beans to be proxied using Spring&#8217;s AOP
  framework (following proxy semantics, as discussed above, applying to method calls
  coming in through the proxy only). The alternative mode "aspectj" instead weaves the
  affected classes with Spring&#8217;s AspectJ transaction aspect, modifying the target class
  byte code to apply to any kind of method call. AspectJ weaving requires
  spring-aspects.jar in the classpath as well as load-time weaving (or compile-time
  weaving) enabled. (See <a class="xref" href="#aop-aj-ltw-spring" title="Spring configuration">the section called &#8220;Spring configuration&#8221;</a> for details on how to set up load-time
  weaving.)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">proxy-target-class</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">proxyTargetClass</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Applies to proxy mode only. Controls what type of transactional proxies are created
  for classes annotated with the <code class="literal">@Transactional</code> annotation. If the
  <code class="literal">proxy-target-class</code> attribute is set to <code class="literal">true</code>, then class-based proxies are created.
  If <code class="literal">proxy-target-class</code> is <code class="literal">false</code> or if the attribute is omitted, then standard JDK
  interface-based proxies are created. (See <a class="xref" href="#aop-proxying" title="8.6&nbsp;Proxying mechanisms">Section&nbsp;8.6, &#8220;Proxying mechanisms&#8221;</a> for a detailed examination
  of the different proxy types.)</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">order</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">order</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Ordered.LOWEST_PRECEDENCE</p></td><td style="" align="left" valign="top"><p>Defines the order of the transaction advice that is applied to beans annotated with
  <code class="literal">@Transactional</code>. (For more information about the rules related to ordering of AOP
  advice, see <a class="xref" href="#aop-ataspectj-advice-ordering" title="Advice ordering">the section called &#8220;Advice ordering&#8221;</a>.) No specified ordering means that the
  AOP subsystem determines the order of the advice.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">proxy-target-class</code> attribute controls what type of transactional proxies are
created for classes annotated with the <code class="literal">@Transactional</code> annotation. If
<code class="literal">proxy-target-class</code> is set to <code class="literal">true</code>, class-based proxies are created. If
<code class="literal">proxy-target-class</code> is <code class="literal">false</code> or if the attribute is omitted, standard JDK
interface-based proxies are created. (See <a class="xref" href="#aop-proxying" title="8.6&nbsp;Proxying mechanisms">Section&nbsp;8.6, &#8220;Proxying mechanisms&#8221;</a> for a discussion of the
different proxy types.)</p>
</td></tr></table></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@EnableTransactionManagement</code> and <code class="literal">&lt;tx:annotation-driven/&gt;</code> only looks for
<code class="literal">@Transactional</code> on beans in the same application context they are defined in. This
means that, if you put annotation driven configuration in a <code class="literal">WebApplicationContext</code> for
a <code class="literal">DispatcherServlet</code>, it only checks for <code class="literal">@Transactional</code> beans in your controllers,
and not your services. See <a class="xref" href="#mvc-servlet" title="16.2&nbsp;The DispatcherServlet">Section&nbsp;16.2, &#8220;The DispatcherServlet&#8221;</a> for more information.</p>
</td></tr></table></div>

<p>The most derived location takes precedence when evaluating the transactional settings
for a method. In the case of the following example, the <code class="literal">DefaultFooService</code> class is
annotated at the class level with the settings for a read-only transaction, but the
<code class="literal">@Transactional</code> annotation on the <code class="literal">updateFoo(Foo)</code> method in the same class takes
precedence over the transactional settings defined at the class level.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Transactional(readOnly = true)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultFooService <span class="hl-keyword">implements</span> FooService {

    <span class="hl-keyword">public</span> Foo getFoo(String fooName) {
        <span class="hl-comment">// do something</span>
    }

    <span class="hl-comment">// these settings have precedence for this method</span>
    <i><span class="hl-annotation" style="color: gray">@Transactional(readOnly = false, propagation = Propagation.REQUIRES_NEW)</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> updateFoo(Foo foo) {
        <span class="hl-comment">// do something</span>
    }
}</pre>

<div class="section" title="@Transactional settings"><div class="titlepage"><div><div><h4 class="title"><a name="transaction-declarative-attransactional-settings"></a>@Transactional settings</h4></div></div></div>

<p>The <code class="literal">@Transactional</code> annotation is metadata that specifies that an interface, class, or
method must have transactional semantics; for example, "<span class="emphasis"><em>start a brand new read-only
transaction when this method is invoked, suspending any existing transaction</em></span>". The
default <code class="literal">@Transactional</code> settings are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Propagation setting is <code class="literal">PROPAGATION_REQUIRED.</code>
</li><li class="listitem">
Isolation level is <code class="literal">ISOLATION_DEFAULT.</code>
</li><li class="listitem">
Transaction is read/write.
</li><li class="listitem">
Transaction timeout defaults to the default timeout of the underlying transaction
system, or to none if timeouts are not supported.
</li><li class="listitem">
Any <code class="literal">RuntimeException</code> triggers rollback, and any checked <code class="literal">Exception</code> does not.
</li></ul></div>

<p>These default settings can be changed; the various properties of the <code class="literal">@Transactional</code>
annotation are summarized in the following table:</p>
<div class="table"><a name="tx-attransactional-properties"></a><p class="title"><b>Table&nbsp;11.3.&nbsp;@</b></p><div class="table-contents">

  <table summary="@" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#tx-multiple-tx-mgrs-with-attransactional" title="Multiple Transaction Managers with @Transactional">value</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>String</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional qualifier specifying the transaction manager to be used.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#tx-propagation" title="11.5.7&nbsp;Transaction propagation">propagation</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>enum: <code class="literal">Propagation</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional propagation setting.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">isolation</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>enum: <code class="literal">Isolation</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional isolation level.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">readOnly</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>boolean</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Read/write vs. read-only transaction</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>int (in seconds granularity)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Transaction timeout.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">rollbackFor</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Array of <code class="literal">Class</code> objects, which must be derived from <code class="literal">Throwable.</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional array of exception classes that <span class="emphasis"><em>must</em></span> cause rollback.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">rollbackForClassName</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Array of class names. Classes must be derived from <code class="literal">Throwable.</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional array of names of exception classes that <span class="emphasis"><em>must</em></span> cause rollback.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">noRollbackFor</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Array of <code class="literal">Class</code> objects, which must be derived from <code class="literal">Throwable.</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional array of exception classes that <span class="emphasis"><em>must not</em></span> cause rollback.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">noRollbackForClassName</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Array of <code class="literal">String</code> class names, which must be derived from <code class="literal">Throwable.</code></p></td><td style="" align="left" valign="top"><p>Optional array of names of exception classes that <span class="emphasis"><em>must not</em></span> cause rollback.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>Currently you cannot have explicit control over the name of a transaction, where <span class="emphasis"><em>name</em></span>
means the transaction name that will be shown in a transaction monitor, if applicable
(for example, WebLogic&#8217;s transaction monitor), and in logging output. For declarative
transactions, the transaction name is always the fully-qualified class name + "."
+ method name of the transactionally-advised class. For example, if the
<code class="literal">handlePayment(..)</code> method of the <code class="literal">BusinessService</code> class started a transaction, the
name of the transaction would be: <code class="literal">com.foo.BusinessService.handlePayment</code>.</p>
</div>
<div class="section" title="Multiple Transaction Managers with @Transactional"><div class="titlepage"><div><div><h4 class="title"><a name="tx-multiple-tx-mgrs-with-attransactional"></a>Multiple Transaction Managers with @Transactional</h4></div></div></div>

<p>Most Spring applications only need a single transaction manager, but there may be
situations where you want multiple independent transaction managers in a single
application. The value attribute of the <code class="literal">@Transactional</code> annotation can be used to
optionally specify the identity of the <code class="literal">PlatformTransactionManager</code> to be used. This can
either be the bean name or the qualifier value of the transaction manager bean. For
example, using the qualifier notation, the following Java code</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransactionalService {

    <i><span class="hl-annotation" style="color: gray">@Transactional("order")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSomething(String name) { ... }

    <i><span class="hl-annotation" style="color: gray">@Transactional("account")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doSomething() { ... }
}</pre>

<p>could be combined with the following transaction manager bean declarations in the
application context.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tx:annotation-driven/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager1"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.DataSourceTransactionManager"</span><span class="hl-tag">&gt;</span>
        ...
        <span class="hl-tag">&lt;qualifier</span> <span class="hl-attribute">value</span>=<span class="hl-value">"order"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager2"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.DataSourceTransactionManager"</span><span class="hl-tag">&gt;</span>
        ...
        <span class="hl-tag">&lt;qualifier</span> <span class="hl-attribute">value</span>=<span class="hl-value">"account"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In this case, the two methods on <code class="literal">TransactionalService</code> will run under separate
transaction managers, differentiated by the "order" and "account" qualifiers. The
default <code class="literal">&lt;tx:annotation-driven&gt;</code> target bean name <code class="literal">transactionManager</code> will still be
used if no specifically qualified PlatformTransactionManager bean is found.</p>
</div>
<div class="section" title="Custom shortcut annotations"><div class="titlepage"><div><div><h4 class="title"><a name="tx-custom-attributes"></a>Custom shortcut annotations</h4></div></div></div>

<p>If you find you are repeatedly using the same attributes with <code class="literal">@Transactional</code> on many
different methods, then <a class="link" href="#beans-meta-annotations" title="4.10.2&nbsp;Meta-annotations">Spring&#8217;s meta-annotation support</a> allows
you to define custom shortcut annotations for your specific use cases. For example,
defining the following annotations</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.TYPE})</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Transactional("order")</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> OrderTx {
}

<i><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.TYPE})</span></i>
<i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Transactional("account")</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> AccountTx {
}</pre>

<p>allows us to write the example from the previous section as</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransactionalService {

    <i><span class="hl-annotation" style="color: gray">@OrderTx</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSomething(String name) { ... }

    <i><span class="hl-annotation" style="color: gray">@AccountTx</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doSomething() { ... }
}</pre>

<p>Here we have used the syntax to define the transaction manager qualifier, but could also
have included propagation behavior, rollback rules, timeouts etc.</p>
</div>
</div>
<div class="section" title="11.5.7&nbsp;Transaction propagation"><div class="titlepage"><div><div><h3 class="title"><a name="tx-propagation"></a>11.5.7&nbsp;Transaction propagation</h3></div></div></div>

<p>This section describes some semantics of transaction propagation in Spring. Please note
that this section is not an introduction to transaction propagation proper; rather it
details some of the semantics regarding transaction propagation in Spring.</p>
<p>In Spring-managed transactions, be aware of the difference between <span class="emphasis"><em>physical</em></span> and
<span class="emphasis"><em>logical</em></span> transactions, and how the propagation setting applies to this difference.</p>
<div class="section" title="Required"><div class="titlepage"><div><div><h4 class="title"><a name="tx-propagation-required"></a>Required</h4></div></div></div>

<div class="figure"><a name="d4e10335"></a><p class="title"><b>Figure&nbsp;11.2.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/tx_prop_required.png" alt="tx prop required"></div>
</div></div><br class="figure-break">

<p>PROPAGATION_REQUIRED</p>
<p>When the propagation setting is <code class="literal">PROPAGATION_REQUIRED</code>, a <span class="emphasis"><em>logical</em></span> transaction scope
is created for each method upon which the setting is applied. Each such logical
transaction scope can determine rollback-only status individually, with an outer
transaction scope being logically independent from the inner transaction scope. Of
course, in case of standard <code class="literal">PROPAGATION_REQUIRED</code> behavior, all these scopes will be
mapped to the same physical transaction. So a rollback-only marker set in the inner
transaction scope does affect the outer transaction&#8217;s chance to actually commit (as you
would expect it to).</p>
<p>However, in the case where an inner transaction scope sets the rollback-only marker, the
outer transaction has not decided on the rollback itself, and so the rollback (silently
triggered by the inner transaction scope) is unexpected. A corresponding
<code class="literal">UnexpectedRollbackException</code> is thrown at that point. This is <span class="emphasis"><em>expected behavior</em></span> so
that the caller of a transaction can never be misled to assume that a commit was
performed when it really was not. So if an inner transaction (of which the outer caller
is not aware) silently marks a transaction as rollback-only, the outer caller still
calls commit. The outer caller needs to receive an <code class="literal">UnexpectedRollbackException</code> to
indicate clearly that a rollback was performed instead.</p>
</div>
<div class="section" title="RequiresNew"><div class="titlepage"><div><div><h4 class="title"><a name="tx-propagation-requires_new"></a>RequiresNew</h4></div></div></div>

<div class="figure"><a name="d4e10352"></a><p class="title"><b>Figure&nbsp;11.3.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/tx_prop_requires_new.png" alt="tx prop requires new"></div>
</div></div><br class="figure-break">

<p>PROPAGATION_REQUIRES_NEW</p>
<p><code class="literal">PROPAGATION_REQUIRES_NEW</code>, in contrast to <code class="literal">PROPAGATION_REQUIRED</code>, uses a <span class="emphasis"><em>completely</em></span>
independent transaction for each affected transaction scope. In that case, the
underlying physical transactions are different and hence can commit or roll back
independently, with an outer transaction not affected by an inner transaction&#8217;s rollback
status.</p>
</div>
<div class="section" title="Nested"><div class="titlepage"><div><div><h4 class="title"><a name="tx-propagation-nested"></a>Nested</h4></div></div></div>

<p><code class="literal">PROPAGATION_NESTED</code> uses a <span class="emphasis"><em>single</em></span> physical transaction with multiple savepoints
that it can roll back to. Such partial rollbacks allow an inner transaction scope to
trigger a rollback <span class="emphasis"><em>for its scope</em></span>, with the outer transaction being able to continue
the physical transaction despite some operations having been rolled back. This setting
is typically mapped onto JDBC savepoints, so will only work with JDBC resource
transactions. See Spring&#8217;s <code class="literal">DataSourceTransactionManager</code>.</p>
</div>
</div>
<div class="section" title="11.5.8&nbsp;Advising transactional operations"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-declarative-applying-more-than-just-tx-advice"></a>11.5.8&nbsp;Advising transactional operations</h3></div></div></div>

<p>Suppose you want to execute <span class="emphasis"><em>both</em></span> transactional <span class="emphasis"><em>and</em></span> some basic profiling advice.
How do you effect this in the context of <code class="literal">&lt;tx:annotation-driven/&gt;</code>?</p>
<p>When you invoke the <code class="literal">updateFoo(Foo)</code> method, you want to see the following actions:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Configured profiling aspect starts up.
</li><li class="listitem">
Transactional advice executes.
</li><li class="listitem">
Method on the advised object executes.
</li><li class="listitem">
Transaction commits.
</li><li class="listitem">
Profiling aspect reports exact duration of the whole transactional method invocation.
</li></ul></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This chapter is not concerned with explaining AOP in any great detail (except as it
applies to transactions). See <a class="xref" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">Chapter&nbsp;8, <i>Aspect Oriented Programming with Spring</i></a> for detailed coverage of the following AOP
configuration and AOP in general.</p>
</td></tr></table></div>

<p>Here is the code for a simple profiling aspect discussed above. The ordering of advice
is controlled through the <code class="literal">Ordered</code> interface. For full details on advice ordering, see
<a class="xref" href="#aop-ataspectj-advice-ordering" title="Advice ordering">the section called &#8220;Advice ordering&#8221;</a>.
.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> x.y;

<span class="hl-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hl-keyword">import</span> org.springframework.util.StopWatch;
<span class="hl-keyword">import</span> org.springframework.core.Ordered;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleProfiler <span class="hl-keyword">implements</span> Ordered {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> order;

    <span class="hl-comment">// allows us to control the ordering of advice</span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getOrder() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.order;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setOrder(<span class="hl-keyword">int</span> order) {
        <span class="hl-keyword">this</span>.order = order;
    }

    <span class="hl-comment">// this method </span><span class="strong"><strong>is</strong></span> the around advice
    <span class="hl-keyword">public</span> Object profile(ProceedingJoinPoint call) <span class="hl-keyword">throws</span> Throwable {
        Object returnValue;
        StopWatch clock = <span class="hl-keyword">new</span> StopWatch(getClass().getName());
        <span class="hl-keyword">try</span> {
            clock.start(call.toShortString());
            returnValue = call.proceed();
        } <span class="hl-keyword">finally</span> {
            clock.stop();
            System.out.println(clock.prettyPrint());
        }
        <span class="hl-keyword">return</span> returnValue;
    }
}</pre>

<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.DefaultFooService"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- this is the aspect --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"profiler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.SimpleProfiler"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- execute before the transactional advice (hence the lower order number) --&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"order"</span> <span class="emphasis"><em>value="1"</em></span>/&gt;
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;tx:annotation-driven</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span> <span class="emphasis"><em>order="200"</em></span>/&gt;

    <span class="hl-tag">&lt;aop:config&gt;</span>
            <span class="hl-comment">&lt;!-- this advice will execute around the transactional advice --&gt;</span>
            <span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"profilingAspect"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"profiler"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serviceMethodWithReturnValue"</span>
                        <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(!void x.y..</span><span class="strong"><strong>Service.</strong></span>(..))"/&gt;
                <span class="hl-tag">&lt;aop:around</span> <span class="hl-attribute">method</span>=<span class="hl-value">"profile"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"serviceMethodWithReturnValue"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/aop:aspect&gt;</span>
    <span class="hl-tag">&lt;/aop:config&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"oracle.jdbc.driver.OracleDriver"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc:oracle:thin:@rj-t42:1521:elvis"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"scott"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"tiger"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The result of the above configuration is a <code class="literal">fooService</code> bean that has profiling and
transactional aspects applied to it <span class="emphasis"><em>in the desired order</em></span>. You configure any number
of additional aspects in similar fashion.</p>
<p>The following example effects the same setup as above, but uses the purely XML
declarative approach.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.DefaultFooService"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- the profiling advice --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"profiler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.SimpleProfiler"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- execute before the transactional advice (hence the lower order number) --&gt;</span>
        <span class="emphasis"><em>&lt;property name="order" value="1</em></span>"/&gt;
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"entryPointMethod"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* x.y..</span><span class="strong"><strong>Service.</strong></span>(..))"/&gt;
        <span class="hl-comment">&lt;!-- will execute after the profiling advice (c.f. the order attribute) --&gt;</span>

        <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"entryPointMethod"</span> <span class="emphasis"><em>order="2</em></span>"/&gt;
        <span class="hl-comment">&lt;!-- order value is higher than the profiling aspect --&gt;</span>

        <span class="hl-tag">&lt;aop:aspect</span> <span class="hl-attribute">id</span>=<span class="hl-value">"profilingAspect"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"profiler"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serviceMethodWithReturnValue"</span>
                    <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(!void x.y..</span><span class="strong"><strong>Service.</strong></span>(..))"/&gt;
            <span class="hl-tag">&lt;aop:around</span> <span class="hl-attribute">method</span>=<span class="hl-value">"profile"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"serviceMethodWithReturnValue"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/aop:aspect&gt;</span>

    <span class="hl-tag">&lt;/aop:config&gt;</span>

    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"get*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

    <span class="hl-comment">&lt;!-- other &lt;bean/&gt; definitions such as a DataSource and a PlatformTransactionManager here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The result of the above configuration will be a <code class="literal">fooService</code> bean that has profiling and
transactional aspects applied to it <span class="emphasis"><em>in that order</em></span>. If you want the profiling advice
to execute <span class="emphasis"><em>after</em></span> the transactional advice on the way in, and <span class="emphasis"><em>before</em></span> the
transactional advice on the way out, then you simply swap the value of the profiling
aspect bean&#8217;s <code class="literal">order</code> property so that it is higher than the transactional advice&#8217;s
order value.</p>
<p>You configure additional aspects in similar fashion.</p>
</div>
<div class="section" title="11.5.9&nbsp;Using @Transactional with AspectJ"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-declarative-aspectj"></a>11.5.9&nbsp;Using @Transactional with AspectJ</h3></div></div></div>

<p>It is also possible to use the Spring Framework&#8217;s <code class="literal">@Transactional</code> support outside of a
Spring container by means of an AspectJ aspect. To do so, you first annotate your
classes (and optionally your classes' methods) with the <code class="literal">@Transactional</code> annotation, and
then you link (weave) your application with the
<code class="literal">org.springframework.transaction.aspectj.AnnotationTransactionAspect</code> defined in the
<code class="literal">spring-aspects.jar</code> file. The aspect must also be configured with a transaction
manager. You can of course use the Spring Framework&#8217;s IoC container to take care of
dependency-injecting the aspect. The simplest way to configure the transaction
management aspect is to use the <code class="literal">&lt;tx:annotation-driven/&gt;</code> element and specify the <code class="literal">mode</code>
attribute to <code class="literal">aspectj</code> as described in <a class="xref" href="#transaction-declarative-annotations" title="11.5.6&nbsp;Using @Transactional">Section&nbsp;11.5.6, &#8220;Using @Transactional&#8221;</a>. Because
we&#8217;re focusing here on applications running outside of a Spring container, we&#8217;ll show
you how to do it programmatically.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Prior to continuing, you may want to read <a class="xref" href="#transaction-declarative-annotations" title="11.5.6&nbsp;Using @Transactional">Section&nbsp;11.5.6, &#8220;Using @Transactional&#8221;</a> and
<a class="xref" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">Chapter&nbsp;8, <i>Aspect Oriented Programming with Spring</i></a> respectively.</p>
</td></tr></table></div>

<pre class="programlisting"><span class="hl-comment">// construct an appropriate transaction manager</span>
DataSourceTransactionManager txManager = <span class="hl-keyword">new</span> DataSourceTransactionManager(getDataSource());

<span class="hl-comment">// configure the AnnotationTransactionAspect to use it; this must be done before executing any transactional methods</span>
AnnotationTransactionAspect.aspectOf().setTransactionManager(txManager);</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using this aspect, you must annotate the <span class="emphasis"><em>implementation</em></span> class (and/or methods
within that class), <span class="emphasis"><em>not</em></span> the interface (if any) that the class implements. AspectJ
follows Java&#8217;s rule that annotations on interfaces are <span class="emphasis"><em>not inherited</em></span>.</p>
</td></tr></table></div>

<p>The <code class="literal">@Transactional</code> annotation on a class specifies the default transaction semantics
for the execution of any method in the class.</p>
<p>The <code class="literal">@Transactional</code> annotation on a method within the class overrides the default
transaction semantics given by the class annotation (if present). Any method may be
annotated, regardless of visibility.</p>
<p>To weave your applications with the <code class="literal">AnnotationTransactionAspect</code> you must either build
your application with AspectJ (see the
<a class="ulink" href="http://www.eclipse.org/aspectj/doc/released/devguide/index.html" target="_top">AspectJ Development
Guide</a>) or use load-time weaving. See <a class="xref" href="#aop-aj-ltw" title="8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework">Section&nbsp;8.8.4, &#8220;Load-time weaving with AspectJ in the Spring Framework&#8221;</a> for a discussion of load-time
weaving with AspectJ.</p>
</div>
</div>
<div class="section" title="11.6&nbsp;Programmatic transaction management"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-programmatic"></a>11.6&nbsp;Programmatic transaction management</h2></div></div></div>

<p>The Spring Framework provides two means of programmatic transaction management:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Using the <code class="literal">TransactionTemplate</code>.
</li><li class="listitem">
Using a <code class="literal">PlatformTransactionManager</code> implementation directly.
</li></ul></div>

<p>The Spring team generally recommends the <code class="literal">TransactionTemplate</code> for programmatic
transaction management. The second approach is similar to using the JTA
<code class="literal">UserTransaction</code> API, although exception handling is less cumbersome.</p>
<div class="section" title="11.6.1&nbsp;Using the TransactionTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="tx-prog-template"></a>11.6.1&nbsp;Using the TransactionTemplate</h3></div></div></div>

<p>The <code class="literal">TransactionTemplate</code> adopts the same approach as other Spring <span class="emphasis"><em>templates</em></span> such as
the <code class="literal">JdbcTemplate</code>. It uses a callback approach, to free application code from having to
do the boilerplate acquisition and release of transactional resources, and results in
code that is intention driven, in that the code that is written focuses solely on what
the developer wants to do.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As you will see in the examples that follow, using the <code class="literal">TransactionTemplate</code> absolutely
couples you to Spring&#8217;s transaction infrastructure and APIs. Whether or not programmatic
transaction management is suitable for your development needs is a decision that you
will have to make yourself.</p>
</td></tr></table></div>

<p>Application code that must execute in a transactional context, and that will use the
<code class="literal">TransactionTemplate</code> explicitly, looks like the following. You, as an application
developer, write a <code class="literal">TransactionCallback</code> implementation (typically expressed as an
anonymous inner class) that contains the code that you need to execute in the context of
a transaction. You then pass an instance of your custom <code class="literal">TransactionCallback</code> to the
<code class="literal">execute(..)</code> method exposed on the <code class="literal">TransactionTemplate</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleService <span class="hl-keyword">implements</span> Service {

    <span class="hl-comment">// single TransactionTemplate shared amongst all methods in this instance</span>
    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> TransactionTemplate transactionTemplate;

    <span class="hl-comment">// use constructor-injection to supply the PlatformTransactionManager</span>
    <span class="hl-keyword">public</span> SimpleService(PlatformTransactionManager transactionManager) {
        Assert.notNull(transactionManager, <span class="hl-string">"The </span><span class="emphasis"><em>transactionManager</em></span> argument must not be null.<span class="hl-string">");
</span>        <span class="hl-keyword">this</span>.transactionTemplate = <span class="hl-keyword">new</span> TransactionTemplate(transactionManager);
    }

    <span class="hl-keyword">public</span> Object someServiceMethod() {
        <span class="hl-keyword">return</span> transactionTemplate.execute(<span class="hl-keyword">new</span> TransactionCallback() {
            <span class="hl-comment">// the code in this method executes in a transactional context</span>
            <span class="hl-keyword">public</span> Object doInTransaction(TransactionStatus status) {
                updateOperation1();
                <span class="hl-keyword">return</span> resultOfUpdateOperation2();
            }
        });
    }
}</pre>

<p>If there is no return value, use the convenient <code class="literal">TransactionCallbackWithoutResult</code> class
with an anonymous class as follows:</p>
<pre class="programlisting">transactionTemplate.execute(<span class="hl-keyword">new</span> <span class="strong"><strong>TransactionCallbackWithoutResult</strong></span>() {
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> doInTransactionWithoutResult(TransactionStatus status) {
        updateOperation1();
        updateOperation2();
    }
});</pre>

<p>Code within the callback can roll the transaction back by calling the
<code class="literal">setRollbackOnly()</code> method on the supplied <code class="literal">TransactionStatus</code> object:</p>
<pre class="programlisting">transactionTemplate.execute(<span class="hl-keyword">new</span> TransactionCallbackWithoutResult() {

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> doInTransactionWithoutResult(TransactionStatus status) {
        <span class="hl-keyword">try</span> {
            updateOperation1();
            updateOperation2();
        } <span class="hl-keyword">catch</span> (SomeBusinessExeption ex) {
            <span class="strong"><strong>status.setRollbackOnly();</strong></span>
        }
    }
});</pre>

<div class="section" title="Specifying transaction settings"><div class="titlepage"><div><div><h4 class="title"><a name="tx-prog-template-settings"></a>Specifying transaction settings</h4></div></div></div>

<p>You can specify transaction settings such as the propagation mode, the isolation level,
the timeout, and so forth on the <code class="literal">TransactionTemplate</code> either programmatically or in
configuration. <code class="literal">TransactionTemplate</code> instances by default have the
<a class="link" href="#transaction-declarative-txadvice-settings" title="11.5.5&nbsp;<tx:advice/&gt; settings">default transactional settings</a>. The
following example shows the programmatic customization of the transactional settings for
a specific <code class="literal">TransactionTemplate:</code></p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleService <span class="hl-keyword">implements</span> Service {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> TransactionTemplate transactionTemplate;

    <span class="hl-keyword">public</span> SimpleService(PlatformTransactionManager transactionManager) {
        Assert.notNull(transactionManager, <span class="hl-string">"The </span><span class="emphasis"><em>transactionManager</em></span> argument must not be null.<span class="hl-string">");
</span>        <span class="hl-keyword">this</span>.transactionTemplate = <span class="hl-keyword">new</span> TransactionTemplate(transactionManager);

        <span class="hl-comment">// the transaction settings can be set here explicitly if so desired</span>
        <span class="hl-keyword">this</span>.transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_UNCOMMITTED);
        <span class="hl-keyword">this</span>.transactionTemplate.setTimeout(<span class="hl-number">30</span>); <span class="hl-comment">// 30 seconds</span>
        <span class="hl-comment">// and so forth...</span>
    }
}</pre>

<p>The following example defines a <code class="literal">TransactionTemplate</code> with some custom transactional
settings, using Spring XML configuration. The <code class="literal">sharedTransactionTemplate</code> can then be
injected into as many services as are required.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sharedTransactionTemplate"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.support.TransactionTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"isolationLevelName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ISOLATION_READ_UNCOMMITTED"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"30"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>"</pre>

<p>Finally, instances of the <code class="literal">TransactionTemplate</code> class are threadsafe, in that instances
do not maintain any conversational state. <code class="literal">TransactionTemplate</code> instances <span class="emphasis"><em>do</em></span> however
maintain configuration state, so while a number of classes may share a single instance
of a <code class="literal">TransactionTemplate</code>, if a class needs to use a <code class="literal">TransactionTemplate</code> with
different settings (for example, a different isolation level), then you need to create
two distinct <code class="literal">TransactionTemplate</code> instances.</p>
</div>
</div>
<div class="section" title="11.6.2&nbsp;Using the PlatformTransactionManager"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-programmatic-ptm"></a>11.6.2&nbsp;Using the PlatformTransactionManager</h3></div></div></div>

<p>You can also use the <code class="literal">org.springframework.transaction.PlatformTransactionManager</code>
directly to manage your transaction. Simply pass the implementation of the
<code class="literal">PlatformTransactionManager</code> you are using to your bean through a bean reference. Then,
using the <code class="literal">TransactionDefinition</code> and <code class="literal">TransactionStatus</code> objects you can initiate
transactions, roll back, and commit.</p>
<pre class="programlisting">DefaultTransactionDefinition def = <span class="hl-keyword">new</span> DefaultTransactionDefinition();
<span class="hl-comment">// explicitly setting the transaction name is something that can only be done programmatically</span>
def.setName(<span class="hl-string">"SomeTxName"</span>);
def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);

TransactionStatus status = txManager.getTransaction(def);
<span class="hl-keyword">try</span> {
    <span class="hl-comment">// execute your business logic here</span>
}
<span class="hl-keyword">catch</span> (MyException ex) {
    txManager.rollback(status);
    <span class="hl-keyword">throw</span> ex;
}
txManager.commit(status);</pre>

</div>
</div>
<div class="section" title="11.7&nbsp;Choosing between programmatic and declarative transaction management"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tx-decl-vs-prog"></a>11.7&nbsp;Choosing between programmatic and declarative transaction management</h2></div></div></div>

<p>Programmatic transaction management is usually a good idea only if you have a small
number of transactional operations. For example, if you have a web application that
require transactions only for certain update operations, you may not want to set up
transactional proxies using Spring or any other technology. In this case, using the
<code class="literal">TransactionTemplate</code> <span class="emphasis"><em>may</em></span> be a good approach. Being able to set the transaction name
explicitly is also something that can only be done using the programmatic approach to
transaction management.</p>
<p>On the other hand, if your application has numerous transactional operations,
declarative transaction management is usually worthwhile. It keeps transaction
management out of business logic, and is not difficult to configure. When using the
Spring Framework, rather than EJB CMT, the configuration cost of declarative transaction
management is greatly reduced.</p>
</div>
<div class="section" title="11.8&nbsp;Application server-specific integration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-application-server-integration"></a>11.8&nbsp;Application server-specific integration</h2></div></div></div>

<p>Spring&#8217;s transaction abstraction generally is application server agnostic. Additionally,
Spring&#8217;s <code class="literal">JtaTransactionManager</code> class, which can optionally perform a JNDI lookup for
the JTA <code class="literal">UserTransaction</code> and <code class="literal">TransactionManager</code> objects, autodetects the location for
the latter object, which varies by application server. Having access to the JTA
<code class="literal">TransactionManager</code> allows for enhanced transaction semantics, in particular supporting
transaction suspension. See the <code class="literal">JtaTransactionManager</code> Javadocs for details.</p>
<p>Spring&#8217;s <code class="literal">JtaTransactionManager</code> is the standard choice to run on Java EE application
servers, and is known to work on all common servers. Advanced functionality such as
transaction suspension works on many servers as well&#8201;&#8212;&#8201;including GlassFish, JBoss and
Geronimo&#8201;&#8212;&#8201;without any special configuration required. However, for fully supported
transaction suspension and further advanced integration, Spring ships special adapters
for WebLogic Server and WebSphere. These adapters are discussed in the following
sections.</p>
<p><span class="emphasis"><em>For standard scenarios, including WebLogic Server and WebSphere, consider using the
convenient <code class="literal">&lt;tx:jta-transaction-manager/&gt;</code> configuration element.</em></span> When configured,
this element automatically detects the underlying server and chooses the best
transaction manager available for the platform. This means that you won&#8217;t have to
configure server-specific adapter classes (as discussed in the following sections)
explicitly; rather, they are chosen automatically, with the standard
<code class="literal">JtaTransactionManager</code> as default fallback.</p>
<div class="section" title="11.8.1&nbsp;IBM WebSphere"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-application-server-integration-websphere"></a>11.8.1&nbsp;IBM WebSphere</h3></div></div></div>

<p>On WebSphere 6.1.0.9 and above, the recommended Spring JTA transaction manager to use is
<code class="literal">WebSphereUowTransactionManager</code>. This special adapter leverages IBM&#8217;s <code class="literal">UOWManager</code> API,
which is available in WebSphere Application Server 6.0.2.19 and later and 6.1.0.9 and
later. With this adapter, Spring-driven transaction suspension (suspend/resume as
initiated by <code class="literal">PROPAGATION_REQUIRES_NEW</code>) is officially supported by IBM!</p>
</div>
<div class="section" title="11.8.2&nbsp;Oracle WebLogic Server"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-application-server-integration-weblogic"></a>11.8.2&nbsp;Oracle WebLogic Server</h3></div></div></div>

<p>On WebLogic Server 9.0 or above, you typically would use the
<code class="literal">WebLogicJtaTransactionManager</code> instead of the stock <code class="literal">JtaTransactionManager</code> class. This
special WebLogic-specific subclass of the normal <code class="literal">JtaTransactionManager</code> supports the
full power of Spring&#8217;s transaction definitions in a WebLogic-managed transaction
environment, beyond standard JTA semantics: Features include transaction names,
per-transaction isolation levels, and proper resuming of transactions in all cases.</p>
</div>
</div>
<div class="section" title="11.9&nbsp;Solutions to common problems"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-solutions-to-common-problems"></a>11.9&nbsp;Solutions to common problems</h2></div></div></div>

<div class="section" title="11.9.1&nbsp;Use of the wrong transaction manager for a specific DataSource"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-solutions-to-common-problems-wrong-ptm"></a>11.9.1&nbsp;Use of the wrong transaction manager for a specific DataSource</h3></div></div></div>

<p>Use the <span class="emphasis"><em>correct</em></span> <code class="literal">PlatformTransactionManager</code> implementation based on your choice of
transactional technologies and requirements. Used properly, the Spring Framework merely
provides a straightforward and portable abstraction. If you are using global
transactions, you <span class="emphasis"><em>must</em></span> use the
<code class="literal">org.springframework.transaction.jta.JtaTransactionManager</code> class (or an
<a class="link" href="#transaction-application-server-integration" title="11.8&nbsp;Application server-specific integration">application server-specific subclass</a> of
it) for all your transactional operations. Otherwise the transaction infrastructure
attempts to perform local transactions on resources such as container <code class="literal">DataSource</code>
instances. Such local transactions do not make sense, and a good application server
treats them as errors.</p>
</div>
</div>
<div class="section" title="11.10&nbsp;Further Resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-resources"></a>11.10&nbsp;Further Resources</h2></div></div></div>

<p>For more information about the Spring Framework&#8217;s transaction support:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="ulink" href="http://www.javaworld.com/javaworld/jw-01-2009/jw-01-spring-transactions.html" target="_top">Distributed
transactions in Spring, with and without XA</a> is a JavaWorld presentation in which
SpringSource&#8217;s David Syer guides you through seven patterns for distributed
transactions in Spring applications, three of them with XA and four without.
</li><li class="listitem">
<a class="ulink" href="http://www.infoq.com/minibooks/JTDS" target="_top">Java Transaction Design Strategies</a> is a book
available from <a class="ulink" href="http://www.infoq.com/" target="_top">InfoQ</a> that provides a well-paced introduction
to transactions in Java. It also includes side-by-side examples of how to configure
and use transactions with both the Spring Framework and EJB3.
</li></ul></div>

</div>
</div>
<div class="chapter" title="12.&nbsp;DAO support"><div class="titlepage"><div><div><h2 class="title"><a name="dao"></a>12.&nbsp;DAO support</h2></div></div></div>

<div class="section" title="12.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dao-introduction"></a>12.1&nbsp;Introduction</h2></div></div></div>

<p>The Data Access Object (DAO) support in Spring is aimed at making it easy to work with
data access technologies like JDBC, Hibernate, JPA or JDO in a consistent way. This
allows one to switch between the aforementioned persistence technologies fairly easily
and it also allows one to code without worrying about catching exceptions that are
specific to each technology.</p>
</div>
<div class="section" title="12.2&nbsp;Consistent exception hierarchy"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dao-exceptions"></a>12.2&nbsp;Consistent exception hierarchy</h2></div></div></div>

<p>Spring provides a convenient translation from technology-specific exceptions like
<code class="literal">SQLException</code> to its own exception class hierarchy with the <code class="literal">DataAccessException</code> as
the root exception. These exceptions wrap the original exception so there is never any
risk that one might lose any information as to what might have gone wrong.</p>
<p>In addition to JDBC exceptions, Spring can also wrap Hibernate-specific exceptions,
converting them from proprietary, checked exceptions (in the case of versions of
Hibernate prior to Hibernate 3.0), to a set of focused runtime exceptions (the same is
true for JDO and JPA exceptions). This allows one to handle most persistence exceptions,
which are non-recoverable, only in the appropriate layers, without having annoying
boilerplate catch-and-throw blocks and exception declarations in one&#8217;s DAOs. (One can
still trap and handle exceptions anywhere one needs to though.) As mentioned above, JDBC
exceptions (including database-specific dialects) are also converted to the same
hierarchy, meaning that one can perform some operations with JDBC within a consistent
programming model.</p>
<p>The above holds true for the various template classes in Springs support for various ORM
frameworks. If one uses the interceptor-based classes then the application must care
about handling <code class="literal">HibernateExceptions</code> and <code class="literal">JDOExceptions</code> itself, preferably via
delegating to <code class="literal">SessionFactoryUtils</code>' <code class="literal">convertHibernateAccessException(..)</code> or
<code class="literal">convertJdoAccessException()</code> methods respectively. These methods convert the exceptions
to ones that are compatible with the exceptions in the <code class="literal">org.springframework.dao</code>
exception hierarchy. As <code class="literal">JDOExceptions</code> are unchecked, they can simply get thrown too,
sacrificing generic DAO abstraction in terms of exceptions though.</p>
<p>The exception hierarchy that Spring provides can be seen below. (Please note that the
class hierarchy detailed in the image shows only a subset of the entire
<code class="literal">DataAccessException</code> hierarchy.)</p>
<div class="figure"><a name="d4e10588"></a><p class="title"><b>Figure&nbsp;12.1.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/DataAccessException.gif" alt="DataAccessException"></div>
</div></div><br class="figure-break">

</div>
<div class="section" title="12.3&nbsp;Annotations used for configuring DAO or Repository classes"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dao-annotations"></a>12.3&nbsp;Annotations used for configuring DAO or Repository classes</h2></div></div></div>

<p>The best way to guarantee that your Data Access Objects (DAOs) or repositories provide
exception translation is to use the <code class="literal">@Repository</code> annotation. This annotation also
allows the component scanning support to find and configure your DAOs and repositories
without having to provide XML configuration entries for them.</p>
<pre class="programlisting"><span class="strong"><strong>@Repository</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SomeMovieFinder <span class="hl-keyword">implements</span> MovieFinder {
    <span class="hl-comment">// ...</span>
}</pre>

<p>Any DAO or repository implementation will need to access to a persistence resource,
depending on the persistence technology used; for example, a JDBC-based repository will
need access to a JDBC <code class="literal">DataSource</code>; a JPA-based repository will need access to an
<code class="literal">EntityManager</code>. The easiest way to accomplish this is to have this resource dependency
injected using one of the <code class="literal">@Autowired,</code>, <code class="literal">@Inject</code>, <code class="literal">@Resource</code> or <code class="literal">@PersistenceContext</code>
annotations. Here is an example for a JPA repository:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Repository</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaMovieFinder <span class="hl-keyword">implements</span> MovieFinder {

    <i><span class="hl-annotation" style="color: gray">@PersistenceContext</span></i>
    <span class="hl-keyword">private</span> EntityManager entityManager;

    <span class="hl-comment">// ...</span>

}</pre>

<p>If you are using the classic Hibernate APIs than you can inject the SessionFactory:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Repository</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateMovieFinder <span class="hl-keyword">implements</span> MovieFinder {

    <span class="hl-keyword">private</span> SessionFactory sessionFactory;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSessionFactory(SessionFactory sessionFactory) {
        <span class="hl-keyword">this</span>.sessionFactory = sessionFactory;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>Last example we will show here is for typical JDBC support. You would have the
<code class="literal">DataSource</code> injected into an initialization method where you would create a
<code class="literal">JdbcTemplate</code> and other data access support classes like <code class="literal">SimpleJdbcCall</code> etc using
this <code class="literal">DataSource</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Repository</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcMovieFinder <span class="hl-keyword">implements</span> MovieFinder {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="hl-comment">// ...</span>

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please see the specific coverage of each persistence technology for details on how to
configure the application context to take advantage of these annotations.</p>
</td></tr></table></div>

</div>
</div>
<div class="chapter" title="13.&nbsp;Data access with JDBC"><div class="titlepage"><div><div><h2 class="title"><a name="jdbc"></a>13.&nbsp;Data access with JDBC</h2></div></div></div>

<div class="section" title="13.1&nbsp;Introduction to Spring Framework JDBC"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-introduction"></a>13.1&nbsp;Introduction to Spring Framework JDBC</h2></div></div></div>

<p>The value-add provided by the Spring Framework JDBC abstraction is perhaps best shown by
the sequence of actions outlined in the table below. The table shows what actions Spring
will take care of and which actions are the responsibility of you, the application
developer.</p>
<div class="table"><a name="jdbc-who-does-what"></a><p class="title"><b>Table&nbsp;13.1.&nbsp;Spring JDBC - who does what?</b></p><div class="table-contents">

  <table summary="Spring JDBC - who does what?" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Action</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Spring</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">You</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Define connection parameters.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Open the connection.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specify the SQL statement.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Declare parameters and provide parameter values</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Prepare and execute the statement.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set up the loop to iterate through the results (if any).</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Do the work for each iteration.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Process any exception.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Handle transactions.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Close the connection, statement and resultset.</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>X</p></td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">

<p>The Spring Framework takes care of all the low-level details that can make JDBC such a
tedious API to develop with.</p>
<div class="section" title="13.1.1&nbsp;Choosing an approach for JDBC database access"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-choose-style"></a>13.1.1&nbsp;Choosing an approach for JDBC database access</h3></div></div></div>

<p>You can choose among several approaches to form the basis for your JDBC database access.
In addition to three flavors of the JdbcTemplate, a new SimpleJdbcInsert and
SimplejdbcCall approach optimizes database metadata, and the RDBMS Object style takes a
more object-oriented approach similar to that of JDO Query design. Once you start using
one of these approaches, you can still mix and match to include a feature from a
different approach. All approaches require a JDBC 2.0-compliant driver, and some
advanced features require a JDBC 3.0 driver.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>JdbcTemplate</em></span> is the classic Spring JDBC approach and the most popular. This
"lowest level" approach and all others use a JdbcTemplate under the covers.
</li><li class="listitem">
<span class="emphasis"><em>NamedParameterJdbcTemplate</em></span> wraps a <code class="literal">JdbcTemplate</code> to provide named parameters
instead of the traditional JDBC "?" placeholders. This approach provides better
documentation and ease of use when you have multiple parameters for an SQL statement.
</li><li class="listitem">
<span class="emphasis"><em>SimpleJdbcInsert and SimpleJdbcCall</em></span> optimize database metadata to limit the amount
of necessary configuration. This approach simplifies coding so that you only need to
provide the name of the table or procedure and provide a map of parameters matching
the column names. This only works if the database provides adequate metadata. If the
database doesn&#8217;t provide this metadata, you will have to provide explicit
configuration of the parameters.
</li><li class="listitem">
<span class="emphasis"><em>RDBMS Objects including MappingSqlQuery, SqlUpdate and StoredProcedure</em></span> requires
you to create reusable and thread-safe objects during initialization of your data
access layer. This approach is modeled after JDO Query wherein you define your query
string, declare parameters, and compile the query. Once you do that, execute methods
can be called multiple times with various parameter values passed in.
</li></ul></div>

</div>
<div class="section" title="13.1.2&nbsp;Package hierarchy"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-packages"></a>13.1.2&nbsp;Package hierarchy</h3></div></div></div>

<p>The Spring Framework&#8217;s JDBC abstraction framework consists of four different packages,
namely <code class="literal">core</code>, <code class="literal">datasource</code>, <code class="literal">object</code>, and <code class="literal">support</code>.</p>
<p>The <code class="literal">org.springframework.jdbc.core</code> package contains the <code class="literal">JdbcTemplate</code> class and its
various callback interfaces, plus a variety of related classes. A subpackage named
<code class="literal">org.springframework.jdbc.core.simple</code> contains the <code class="literal">SimpleJdbcInsert</code> and
<code class="literal">SimpleJdbcCall</code> classes. Another subpackage named
<code class="literal">org.springframework.jdbc.core.namedparam</code> contains the <code class="literal">NamedParameterJdbcTemplate</code>
class and the related support classes. See <a class="xref" href="#jdbc-core" title="13.2&nbsp;Using the JDBC core classes to control basic JDBC processing and error handling">Section&nbsp;13.2, &#8220;Using the JDBC core classes to control basic JDBC processing and error handling&#8221;</a>, <a class="xref" href="#jdbc-advanced-jdbc" title="13.4&nbsp;JDBC batch operations">Section&nbsp;13.4, &#8220;JDBC batch operations&#8221;</a>, and
<a class="xref" href="#jdbc-simple-jdbc" title="13.5&nbsp;Simplifying JDBC operations with the SimpleJdbc classes">Section&nbsp;13.5, &#8220;Simplifying JDBC operations with the SimpleJdbc classes&#8221;</a></p>
<p>The <code class="literal">org.springframework.jdbc.datasource</code> package contains a utility class for easy
<code class="literal">DataSource</code> access, and various simple <code class="literal">DataSource</code> implementations that can be used
for testing and running unmodified JDBC code outside of a Java EE container. A
subpackage named <code class="literal">org.springfamework.jdbc.datasource.embedded</code> provides support for
creating in-memory database instances using Java database engines such as HSQL and H2.
See <a class="xref" href="#jdbc-connections" title="13.3&nbsp;Controlling database connections">Section&nbsp;13.3, &#8220;Controlling database connections&#8221;</a> and <a class="xref" href="#jdbc-embedded-database-support" title="13.8&nbsp;Embedded database support">Section&nbsp;13.8, &#8220;Embedded database support&#8221;</a></p>
<p>The <code class="literal">org.springframework.jdbc.object</code> package contains classes that represent RDBMS
queries, updates, and stored procedures as thread safe, reusable objects. See
<a class="xref" href="#jdbc-object" title="13.6&nbsp;Modeling JDBC operations as Java objects">Section&nbsp;13.6, &#8220;Modeling JDBC operations as Java objects&#8221;</a>.This approach is modeled by JDO, although of course objects returned by
queries are "disconnected" from the database. This higher level of JDBC abstraction
depends on the lower-level abstraction in the <code class="literal">org.springframework.jdbc.core</code> package.</p>
<p>The <code class="literal">org.springframework.jdbc.support</code> package provides <code class="literal">SQLException</code> translation
functionality and some utility classes. Exceptions thrown during JDBC processing are
translated to exceptions defined in the <code class="literal">org.springframework.dao</code> package. This means
that code using the Spring JDBC abstraction layer does not need to implement JDBC or
RDBMS-specific error handling. All translated exceptions are unchecked, which gives you
the option of catching the exceptions from which you can recover while allowing other
exceptions to be propagated to the caller. See <a class="xref" href="#jdbc-SQLExceptionTranslator" title="13.2.3&nbsp;SQLExceptionTranslator">Section&nbsp;13.2.3, &#8220;SQLExceptionTranslator&#8221;</a>.</p>
</div>
</div>
<div class="section" title="13.2&nbsp;Using the JDBC core classes to control basic JDBC processing and error handling"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-core"></a>13.2&nbsp;Using the JDBC core classes to control basic JDBC processing and error handling</h2></div></div></div>

<div class="section" title="13.2.1&nbsp;JdbcTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-JdbcTemplate"></a>13.2.1&nbsp;JdbcTemplate</h3></div></div></div>

<p>The <code class="literal">JdbcTemplate</code> class is the central class in the JDBC core package. It handles the
creation and release of resources, which helps you avoid common errors such as
forgetting to close the connection. It performs the basic tasks of the core JDBC
workflow such as statement creation and execution, leaving application code to provide
SQL and extract results. The <code class="literal">JdbcTemplate</code> class executes SQL queries, update
statements and stored procedure calls, performs iteration over <code class="literal">ResultSet</code> s and
extraction of returned parameter values. It also catches JDBC exceptions and translates
them to the generic, more informative, exception hierarchy defined in the
<code class="literal">org.springframework.dao</code> package.</p>
<p>When you use the <code class="literal">JdbcTemplate</code> for your code, you only need to implement callback
interfaces, giving them a clearly defined contract. The <code class="literal">PreparedStatementCreator</code>
callback interface creates a prepared statement given a <code class="literal">Connection</code> provided by this
class, providing SQL and any necessary parameters. The same is true for the
<code class="literal">CallableStatementCreator</code> interface, which creates callable statements. The
<code class="literal">RowCallbackHandler</code> interface extracts values from each row of a <code class="literal">ResultSet</code>.</p>
<p>The <code class="literal">JdbcTemplate</code> can be used within a DAO implementation through direct instantiation
with a <code class="literal">DataSource</code> reference, or be configured in a Spring IoC container and given to
DAOs as a bean reference.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">DataSource</code> should always be configured as a bean in the Spring IoC container. In
the first case the bean is given to the service directly; in the second case it is given
to the prepared template.</p>
</td></tr></table></div>

<p>All SQL issued by this class is logged at the <code class="literal">DEBUG</code> level under the category
corresponding to the fully qualified class name of the template instance (typically
<code class="literal">JdbcTemplate</code>, but it may be different if you are using a custom subclass of the
<code class="literal">JdbcTemplate</code> class).</p>
<div class="section" title="Examples of JdbcTemplate class usage"><div class="titlepage"><div><div><h4 class="title"><a name="jdbc-JdbcTemplate-examples"></a>Examples of JdbcTemplate class usage</h4></div></div></div>

<p>This section provides some examples of <code class="literal">JdbcTemplate</code> class usage. These examples are
not an exhaustive list of all of the functionality exposed by the <code class="literal">JdbcTemplate</code>; see
the attendant Javadocs for that.</p>
<div class="section" title="Querying (SELECT)"><div class="titlepage"><div><div><h5 class="title"><a name="jdbc-JdbcTemplate-examples-query"></a>Querying (SELECT)</h5></div></div></div>

<p>Here is a simple query for getting the number of rows in a relation:</p>
<pre class="programlisting"><span class="hl-keyword">int</span> rowCount = <span class="hl-keyword">this</span>.jdbcTemplate.queryForObject(<span class="hl-string">"select count(*) from t_actor"</span>, Integer.<span class="hl-keyword">class</span>);</pre>

<p>A simple query using a bind variable:</p>
<pre class="programlisting"><span class="hl-keyword">int</span> countOfActorsNamedJoe = <span class="hl-keyword">this</span>.jdbcTemplate.queryForObject(
        <span class="hl-string">"select count(*) from t_actor where first_name = ?"</span>, Integer.<span class="hl-keyword">class</span>, <span class="hl-string">"Joe"</span>);</pre>

<p>Querying for a <code class="literal">String</code>:</p>
<pre class="programlisting">String lastName = <span class="hl-keyword">this</span>.jdbcTemplate.queryForObject(
        <span class="hl-string">"select last_name from t_actor where id = ?"</span>,
        <span class="hl-keyword">new</span> Object[]{<span class="hl-number">1212L</span>}, String.<span class="hl-keyword">class</span>);</pre>

<p>Querying and populating a <span class="emphasis"><em>single</em></span> domain object:</p>
<pre class="programlisting">Actor actor = <span class="hl-keyword">this</span>.jdbcTemplate.queryForObject(
        <span class="hl-string">"select first_name, last_name from t_actor where id = ?"</span>,
        <span class="hl-keyword">new</span> Object[]{<span class="hl-number">1212L</span>},
        <span class="hl-keyword">new</span> RowMapper&lt;Actor&gt;() {
            <span class="hl-keyword">public</span> Actor mapRow(ResultSet rs, <span class="hl-keyword">int</span> rowNum) <span class="hl-keyword">throws</span> SQLException {
                Actor actor = <span class="hl-keyword">new</span> Actor();
                actor.setFirstName(rs.getString(<span class="hl-string">"first_name"</span>));
                actor.setLastName(rs.getString(<span class="hl-string">"last_name"</span>));
                <span class="hl-keyword">return</span> actor;
            }
        });</pre>

<p>Querying and populating a number of domain objects:</p>
<pre class="programlisting">List&lt;Actor&gt; actors = <span class="hl-keyword">this</span>.jdbcTemplate.query(
        <span class="hl-string">"select first_name, last_name from t_actor"</span>,
        <span class="hl-keyword">new</span> RowMapper&lt;Actor&gt;() {
            <span class="hl-keyword">public</span> Actor mapRow(ResultSet rs, <span class="hl-keyword">int</span> rowNum) <span class="hl-keyword">throws</span> SQLException {
                Actor actor = <span class="hl-keyword">new</span> Actor();
                actor.setFirstName(rs.getString(<span class="hl-string">"first_name"</span>));
                actor.setLastName(rs.getString(<span class="hl-string">"last_name"</span>));
                <span class="hl-keyword">return</span> actor;
            }
        });</pre>

<p>If the last two snippets of code actually existed in the same application, it would make
sense to remove the duplication present in the two <code class="literal">RowMapper</code> anonymous inner classes,
and extract them out into a single class (typically a <code class="literal">static</code> inner class) that can
then be referenced by DAO methods as needed. For example, it may be better to write the
last code snippet as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> List&lt;Actor&gt; findAllActors() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.jdbcTemplate.query( <span class="hl-string">"select first_name, last_name from t_actor"</span>, <span class="hl-keyword">new</span> ActorMapper());
}

<span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> ActorMapper <span class="hl-keyword">implements</span> RowMapper&lt;Actor&gt; {

    <span class="hl-keyword">public</span> Actor mapRow(ResultSet rs, <span class="hl-keyword">int</span> rowNum) <span class="hl-keyword">throws</span> SQLException {
        Actor actor = <span class="hl-keyword">new</span> Actor();
        actor.setFirstName(rs.getString(<span class="hl-string">"first_name"</span>));
        actor.setLastName(rs.getString(<span class="hl-string">"last_name"</span>));
        <span class="hl-keyword">return</span> actor;
    }
}</pre>

</div>
<div class="section" title="Updating (INSERT/UPDATE/DELETE) with jdbcTemplate"><div class="titlepage"><div><div><h5 class="title"><a name="jdbc-JdbcTemplate-examples-update"></a>Updating (INSERT/UPDATE/DELETE) with jdbcTemplate</h5></div></div></div>

<p>You use the <code class="literal">update(..)</code> method to perform insert, update and delete operations.
Parameter values are usually provided as var args or alternatively as an object array.</p>
<pre class="programlisting"><span class="hl-keyword">this</span>.jdbcTemplate.update(
        <span class="hl-string">"insert into t_actor (first_name, last_name) values (?, ?)"</span>,
        <span class="hl-string">"Leonor"</span>, <span class="hl-string">"Watling"</span>);</pre>

<pre class="programlisting"><span class="hl-keyword">this</span>.jdbcTemplate.update(
        <span class="hl-string">"update t_actor set last_name = ? where id = ?"</span>,
        <span class="hl-string">"Banjo"</span>, <span class="hl-number">5276L</span>);</pre>

<pre class="programlisting"><span class="hl-keyword">this</span>.jdbcTemplate.update(
        <span class="hl-string">"delete from actor where id = ?"</span>,
        Long.valueOf(actorId));</pre>

</div>
<div class="section" title="Other jdbcTemplate operations"><div class="titlepage"><div><div><h5 class="title"><a name="jdbc-JdbcTemplate-examples-other"></a>Other jdbcTemplate operations</h5></div></div></div>

<p>You can use the <code class="literal">execute(..)</code> method to execute any arbitrary SQL, and as such the
method is often used for DDL statements. It is heavily overloaded with variants taking
callback interfaces, binding variable arrays, and so on.</p>
<pre class="programlisting"><span class="hl-keyword">this</span>.jdbcTemplate.execute(<span class="hl-string">"create table mytable (id integer, name varchar(100))"</span>);</pre>

<p>The following example invokes a simple stored procedure. More sophisticated stored
procedure support is <a class="link" href="#jdbc-StoredProcedure" title="13.6.4&nbsp;StoredProcedure">covered later</a>.</p>
<pre class="programlisting"><span class="hl-keyword">this</span>.jdbcTemplate.update(
        <span class="hl-string">"call SUPPORT.REFRESH_ACTORS_SUMMARY(?)"</span>,
        Long.valueOf(unionId));</pre>

</div>
</div>
<div class="section" title="JdbcTemplate best practices"><div class="titlepage"><div><div><h4 class="title"><a name="jdbc-JdbcTemplate-idioms"></a>JdbcTemplate best practices</h4></div></div></div>

<p>Instances of the <code class="literal">JdbcTemplate</code> class are <span class="emphasis"><em>threadsafe once configured</em></span>. This is
important because it means that you can configure a single instance of a <code class="literal">JdbcTemplate</code>
and then safely inject this <span class="emphasis"><em>shared</em></span> reference into multiple DAOs (or repositories).
The <code class="literal">JdbcTemplate</code> is stateful, in that it maintains a reference to a <code class="literal">DataSource</code>, but
this state is <span class="emphasis"><em>not</em></span> conversational state.</p>
<p>A common practice when using the <code class="literal">JdbcTemplate</code> class (and the associated
<a class="link" href="#jdbc-NamedParameterJdbcTemplate" title="13.2.2&nbsp;NamedParameterJdbcTemplate"><code class="literal">NamedParameterJdbcTemplate</code></a> classes) is to
configure a <code class="literal">DataSource</code> in your Spring configuration file, and then dependency-inject
that shared <code class="literal">DataSource</code> bean into your DAO classes; the <code class="literal">JdbcTemplate</code> is created in
the setter for the <code class="literal">DataSource</code>. This leads to DAOs that look in part like the following:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcCorporateEventDao <span class="hl-keyword">implements</span> CorporateEventDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="strong"><strong>this.jdbcTemplate = new JdbcTemplate(dataSource);</strong></span>
    }

    <span class="hl-comment">// JDBC-backed implementations of the methods on the CorporateEventDao follow...</span>
}</pre>

<p>The corresponding configuration might look like this.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"corporateEventDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.JdbcCorporateEventDao"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.driverClassName}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.url}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.username}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.password}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">location</span>=<span class="hl-value">"jdbc.properties"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>An alternative to explicit configuration is to use component-scanning and annotation
support for dependency injection. In this case you annotate the class with <code class="literal">@Repository</code>
(which makes it a candidate for component-scanning) and annotate the <code class="literal">DataSource</code> setter
method with <code class="literal">@Autowired</code>.</p>
<pre class="programlisting"><span class="strong"><strong>@Repository</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcCorporateEventDao <span class="hl-keyword">implements</span> CorporateEventDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="strong"><strong>this.jdbcTemplate = new JdbcTemplate(dataSource);</strong></span>
    }

    <span class="hl-comment">// JDBC-backed implementations of the methods on the CorporateEventDao follow...</span>
}</pre>

<p>The corresponding XML configuration file would look like the following:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- Scans within the base package of the application for @Components to configure as beans --&gt;</span>
    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.springframework.docs.test"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.driverClassName}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.url}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.username}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.password}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">location</span>=<span class="hl-value">"jdbc.properties"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>If you are using Spring&#8217;s <code class="literal">JdbcDaoSupport</code> class, and your various JDBC-backed DAO classes
extend from it, then your sub-class inherits a <code class="literal">setDataSource(..)</code> method from the
<code class="literal">JdbcDaoSupport</code> class. You can choose whether to inherit from this class. The
<code class="literal">JdbcDaoSupport</code> class is provided as a convenience only.</p>
<p>Regardless of which of the above template initialization styles you choose to use (or
not), it is seldom necessary to create a new instance of a <code class="literal">JdbcTemplate</code> class each
time you want to execute SQL. Once configured, a <code class="literal">JdbcTemplate</code> instance is threadsafe.
You may want multiple <code class="literal">JdbcTemplate</code> instances if your application accesses multiple
databases, which requires multiple <code class="literal">DataSources</code>, and subsequently multiple differently
configured <code class="literal">JdbcTemplates</code>.</p>
</div>
</div>
<div class="section" title="13.2.2&nbsp;NamedParameterJdbcTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-NamedParameterJdbcTemplate"></a>13.2.2&nbsp;NamedParameterJdbcTemplate</h3></div></div></div>

<p>The <code class="literal">NamedParameterJdbcTemplate</code> class adds support for programming JDBC statements
using named parameters, as opposed to programming JDBC statements using only classic
placeholder ( <code class="literal">'?'</code>) arguments. The <code class="literal">NamedParameterJdbcTemplate</code> class wraps a
<code class="literal">JdbcTemplate</code>, and delegates to the wrapped <code class="literal">JdbcTemplate</code> to do much of its work. This
section describes only those areas of the <code class="literal">NamedParameterJdbcTemplate</code> class that differ
from the <code class="literal">JdbcTemplate</code> itself; namely, programming JDBC statements using named
parameters.</p>
<pre class="programlisting"><span class="hl-comment">// some JDBC-backed DAO class...</span>
<span class="hl-keyword">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
    <span class="hl-keyword">this</span>.namedParameterJdbcTemplate = <span class="hl-keyword">new</span> NamedParameterJdbcTemplate(dataSource);
}

<span class="hl-keyword">public</span> <span class="hl-keyword">int</span> countOfActorsByFirstName(String firstName) {

    String sql = <span class="hl-string">"select count(*) from T_ACTOR where first_name = :first_name"</span>;

    SqlParameterSource namedParameters = <span class="hl-keyword">new</span> MapSqlParameterSource(<span class="hl-string">"first_name"</span>, firstName);

    <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.namedParameterJdbcTemplate.queryForObject(sql, Integer.<span class="hl-keyword">class</span>, namedParameters);
}</pre>

<p>Notice the use of the named parameter notation in the value assigned to the <code class="literal">sql</code>
variable, and the corresponding value that is plugged into the <code class="literal">namedParameters</code>
variable (of type <code class="literal">MapSqlParameterSource</code>).</p>
<p>Alternatively, you can pass along named parameters and their corresponding values to a
<code class="literal">NamedParameterJdbcTemplate</code> instance by using the <code class="literal">Map</code>-based style.The remaining
methods exposed by the <code class="literal">NamedParameterJdbcOperations</code> and implemented by the
<code class="literal">NamedParameterJdbcTemplate</code> class follow a similar pattern and are not covered here.</p>
<p>The following example shows the use of the <code class="literal">Map</code>-based style.</p>
<pre class="programlisting"><span class="hl-comment">// some JDBC-backed DAO class...</span>
<span class="hl-keyword">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
    <span class="hl-keyword">this</span>.namedParameterJdbcTemplate = <span class="hl-keyword">new</span> NamedParameterJdbcTemplate(dataSource);
}

<span class="hl-keyword">public</span> <span class="hl-keyword">int</span> countOfActorsByFirstName(String firstName) {

    String sql = <span class="hl-string">"select count(*) from T_ACTOR where first_name = :first_name"</span>;

    Map&lt;String, String&gt; namedParameters = Collections.singletonMap(<span class="hl-string">"first_name"</span>, firstName);

    <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.namedParameterJdbcTemplate.queryForObject(sql, Integer.<span class="hl-keyword">class</span>, namedParameters);
}</pre>

<p>One nice feature related to the <code class="literal">NamedParameterJdbcTemplate</code> (and existing in the same
Java package) is the <code class="literal">SqlParameterSource</code> interface. You have already seen an example of
an implementation of this interface in one of the previous code snippet (the
<code class="literal">MapSqlParameterSource</code> class). An <code class="literal">SqlParameterSource</code> is a source of named parameter
values to a <code class="literal">NamedParameterJdbcTemplate</code>. The <code class="literal">MapSqlParameterSource</code> class is a very
simple implementation that is simply an adapter around a <code class="literal">java.util.Map</code>, where the keys
are the parameter names and the values are the parameter values.</p>
<p>Another <code class="literal">SqlParameterSource</code> implementation is the <code class="literal">BeanPropertySqlParameterSource</code>
class. This class wraps an arbitrary JavaBean (that is, an instance of a class that
adheres to <a class="ulink" href="http://www.oracle.com/technetwork/java/javase/documentation/spec-136004.html" target="_top">the
JavaBean conventions</a>), and uses the properties of the wrapped JavaBean as the source
of named parameter values.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Actor {

    <span class="hl-keyword">private</span> Long id;
    <span class="hl-keyword">private</span> String firstName;
    <span class="hl-keyword">private</span> String lastName;

    <span class="hl-keyword">public</span> String getFirstName() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.firstName;
    }

    <span class="hl-keyword">public</span> String getLastName() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.lastName;
    }

    <span class="hl-keyword">public</span> Long getId() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.id;
    }

    <span class="hl-comment">// setters omitted...</span>

}</pre>

<pre class="programlisting"><span class="hl-comment">// some JDBC-backed DAO class...</span>
<span class="hl-keyword">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
    <span class="hl-keyword">this</span>.namedParameterJdbcTemplate = <span class="hl-keyword">new</span> NamedParameterJdbcTemplate(dataSource);
}

<span class="hl-keyword">public</span> <span class="hl-keyword">int</span> countOfActors(Actor exampleActor) {

    <span class="hl-comment">// notice how the named parameters match the properties of the above </span><span class="emphasis"><em>Actor</em></span> <span class="hl-keyword">class</span>
    String sql = <span class="hl-string">"select count(*) from T_ACTOR where first_name = :firstName and last_name = :lastName"</span>;

    SqlParameterSource namedParameters = <span class="hl-keyword">new</span> BeanPropertySqlParameterSource(exampleActor);

    <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.namedParameterJdbcTemplate.queryForObject(sql, Integer.<span class="hl-keyword">class</span>, namedParameters);
}</pre>

<p>Remember that the <code class="literal">NamedParameterJdbcTemplate</code> class <span class="emphasis"><em>wraps</em></span> a classic <code class="literal">JdbcTemplate</code>
template; if you need access to the wrapped <code class="literal">JdbcTemplate</code> instance to access
functionality only present in the <code class="literal">JdbcTemplate</code> class, you can use the
<code class="literal">getJdbcOperations()</code> method to access the wrapped <code class="literal">JdbcTemplate</code> through the
<code class="literal">JdbcOperations</code> interface.</p>
<p>See also <a class="xref" href="#jdbc-JdbcTemplate-idioms" title="JdbcTemplate best practices">the section called &#8220;JdbcTemplate best practices&#8221;</a> for guidelines on using the
<code class="literal">NamedParameterJdbcTemplate</code> class in the context of an application.</p>
</div>
<div class="section" title="13.2.3&nbsp;SQLExceptionTranslator"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-SQLExceptionTranslator"></a>13.2.3&nbsp;SQLExceptionTranslator</h3></div></div></div>

<p><code class="literal">SQLExceptionTranslator</code> is an interface to be implemented by classes that can translate
between <code class="literal">SQLExceptions</code> and Spring&#8217;s own <code class="literal">org.springframework.dao.DataAccessException</code>,
which is agnostic in regard to data access strategy. Implementations can be generic (for
example, using SQLState codes for JDBC) or proprietary (for example, using Oracle error
codes) for greater precision.</p>
<p><code class="literal">SQLErrorCodeSQLExceptionTranslator</code> is the implementation of <code class="literal">SQLExceptionTranslator</code>
that is used by default. This implementation uses specific vendor codes. It is more
precise than the <code class="literal">SQLState</code> implementation. The error code translations are based on
codes held in a JavaBean type class called <code class="literal">SQLErrorCodes</code>. This class is created and
populated by an <code class="literal">SQLErrorCodesFactory</code> which as the name suggests is a factory for
creating <code class="literal">SQLErrorCodes</code> based on the contents of a configuration file named
<code class="literal">sql-error-codes.xml</code>. This file is populated with vendor codes and based on the
<code class="literal">DatabaseProductName</code> taken from the <code class="literal">DatabaseMetaData</code>. The codes for the actual
database you are using are used.</p>
<p>The <code class="literal">SQLErrorCodeSQLExceptionTranslator</code> applies matching rules in the following sequence:</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">SQLErrorCodesFactory</code> is used by default to define Error codes and custom exception
translations. They are looked up in a file named <code class="literal">sql-error-codes.xml</code> from the
classpath and the matching <code class="literal">SQLErrorCodes</code> instance is located based on the database
name from the database metadata of the database in use.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Any custom translation implemented by a subclass. Normally the provided concrete
<code class="literal">SQLErrorCodeSQLExceptionTranslator</code> is used so this rule does not apply. It only
applies if you have actually provided a subclass implementation.
</li><li class="listitem">
Any custom implementation of the <code class="literal">SQLExceptionTranslator</code> interface that is provided
as the <code class="literal">customSqlExceptionTranslator</code> property of the <code class="literal">SQLErrorCodes</code> class.
</li><li class="listitem">
The list of instances of the <code class="literal">CustomSQLErrorCodesTranslation</code> class, provided for the
<code class="literal">customTranslations</code> property of the <code class="literal">SQLErrorCodes</code> class, are searched for a match.
</li><li class="listitem">
Error code matching is applied.
</li><li class="listitem">
Use the fallback translator. <code class="literal">SQLExceptionSubclassTranslator</code> is the default fallback
translator. If this translation is not available then the next fallback translator is
the <code class="literal">SQLStateSQLExceptionTranslator</code>.
</li></ul></div>

<p>You can extend <code class="literal">SQLErrorCodeSQLExceptionTranslator:</code></p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomSQLErrorCodesTranslator <span class="hl-keyword">extends</span> SQLErrorCodeSQLExceptionTranslator {

    <span class="hl-keyword">protected</span> DataAccessException customTranslate(String task, String sql, SQLException sqlex) {
        <span class="hl-keyword">if</span> (sqlex.getErrorCode() == -<span class="hl-number">12345</span>) {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DeadlockLoserDataAccessException(task, sqlex);
        }
        <span class="hl-keyword">return</span> null;
    }
}</pre>

<p>In this example, the specific error code <code class="literal">-12345</code> is translated and other errors are
left to be translated by the default translator implementation. To use this custom
translator, it is necessary to pass it to the <code class="literal">JdbcTemplate</code> through the method
<code class="literal">setExceptionTranslator</code> and to use this <code class="literal">JdbcTemplate</code> for all of the data access
processing where this translator is needed. Here is an example of how this custom
translator can be used:</p>
<pre class="programlisting"><span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {

    <span class="hl-comment">// create a JdbcTemplate and set data source</span>
    <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate();
    <span class="hl-keyword">this</span>.jdbcTemplate.setDataSource(dataSource);

    <span class="hl-comment">// create a custom translator and set the DataSource for the default translation lookup</span>
    CustomSQLErrorCodesTranslator tr = <span class="hl-keyword">new</span> CustomSQLErrorCodesTranslator();
    tr.setDataSource(dataSource);
    <span class="hl-keyword">this</span>.jdbcTemplate.setExceptionTranslator(tr);

}

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> updateShippingCharge(<span class="hl-keyword">long</span> orderId, <span class="hl-keyword">long</span> pct) {
    <span class="hl-comment">// use the prepared JdbcTemplate for this update</span>
    <span class="hl-keyword">this</span>.jdbcTemplate.update(<span class="hl-string">"update orders"</span> +
        <span class="hl-string">" set shipping_charge = shipping_charge * ? / 100"</span> +
        <span class="hl-string">" where id = ?"</span>, pct, orderId);
}</pre>

<p>The custom translator is passed a data source in order to look up the error codes in
<code class="literal">sql-error-codes.xml</code>.</p>
</div>
<div class="section" title="13.2.4&nbsp;Executing statements"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-statements-executing"></a>13.2.4&nbsp;Executing statements</h3></div></div></div>

<p>Executing an SQL statement requires very little code. You need a <code class="literal">DataSource</code> and a
<code class="literal">JdbcTemplate</code>, including the convenience methods that are provided with the
<code class="literal">JdbcTemplate</code>. The following example shows what you need to include for a minimal but
fully functional class that creates a new table:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.sql.DataSource;
<span class="hl-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExecuteAStatement {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doExecute() {
        <span class="hl-keyword">this</span>.jdbcTemplate.execute(<span class="hl-string">"create table mytable (id integer, name varchar(100))"</span>);
    }
}</pre>

</div>
<div class="section" title="13.2.5&nbsp;Running queries"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-statements-querying"></a>13.2.5&nbsp;Running queries</h3></div></div></div>

<p>Some query methods return a single value. To retrieve a count or a specific value from
one row, use <code class="literal">queryForObject(..)</code>. The latter converts the returned JDBC <code class="literal">Type</code> to the
Java class that is passed in as an argument. If the type conversion is invalid, then an
<code class="literal">InvalidDataAccessApiUsageException</code> is thrown. Here is an example that contains two
query methods, one for an <code class="literal">int</code> and one that queries for a <code class="literal">String</code>.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.sql.DataSource;
<span class="hl-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RunAQuery {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.jdbcTemplate.queryForObject(<span class="hl-string">"select count(*) from mytable"</span>, Integer.<span class="hl-keyword">class</span>);
    }

    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.jdbcTemplate.queryForObject(<span class="hl-string">"select name from mytable"</span>, String.<span class="hl-keyword">class</span>);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.dataSource = dataSource;
    }
}</pre>

<p>In addition to the single result query methods, several methods return a list with an
entry for each row that the query returned. The most generic method is
<code class="literal">queryForList(..)</code> which returns a <code class="literal">List</code> where each entry is a <code class="literal">Map</code> with each entry in
the map representing the column value for that row. If you add a method to the above
example to retrieve a list of all the rows, it would look like this:</p>
<pre class="programlisting"><span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
    <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
}

<span class="hl-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; getList() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.jdbcTemplate.queryForList(<span class="hl-string">"select * from mytable"</span>);
}</pre>

<p>The list returned would look something like this:</p>

<pre class="literallayout">[{name=Bob, id=1}, {name=Mary, id=2}]</pre>

</div>
<div class="section" title="13.2.6&nbsp;Updating the database"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-updates"></a>13.2.6&nbsp;Updating the database</h3></div></div></div>

<p>The following example shows a column updated for a certain primary key. In this example,
an SQL statement has placeholders for row parameters. The parameter values can be passed
in as varargs or alternatively as an array of objects. Thus primitives should be wrapped
in the primitive wrapper classes explicitly or using auto-boxing.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.sql.DataSource;

<span class="hl-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExecuteAnUpdate {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(<span class="hl-keyword">int</span> id, String name) {
        <span class="hl-keyword">this</span>.jdbcTemplate.update(<span class="hl-string">"update mytable set name = ? where id = ?"</span>, name, id);
    }
}</pre>

</div>
<div class="section" title="13.2.7&nbsp;Retrieving auto-generated keys"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-auto-genereted-keys"></a>13.2.7&nbsp;Retrieving auto-generated keys</h3></div></div></div>

<p>An <code class="literal">update()</code> convenience method supports the retrieval of primary keys generated by the
database. This support is part of the JDBC 3.0 standard; see Chapter 13.6 of the
specification for details. The method takes a <code class="literal">PreparedStatementCreator</code> as its first
argument, and this is the way the required insert statement is specified. The other
argument is a <code class="literal">KeyHolder</code>, which contains the generated key on successful return from
the update. There is not a standard single way to create an appropriate
<code class="literal">PreparedStatement</code> (which explains why the method signature is the way it is). The
following example works on Oracle but may not work on other platforms:</p>
<pre class="programlisting"><span class="hl-keyword">final</span> String INSERT_SQL = <span class="hl-string">"insert into my_test (name) values(?)"</span>;
<span class="hl-keyword">final</span> String name = <span class="hl-string">"Rob"</span>;

KeyHolder keyHolder = <span class="hl-keyword">new</span> GeneratedKeyHolder();
jdbcTemplate.update(
    <span class="hl-keyword">new</span> PreparedStatementCreator() {
        <span class="hl-keyword">public</span> PreparedStatement createPreparedStatement(Connection connection) <span class="hl-keyword">throws</span> SQLException {
            PreparedStatement ps = connection.prepareStatement(INSERT_SQL, <span class="hl-keyword">new</span> String[] {<span class="hl-string">"id"</span>});
            ps.setString(<span class="hl-number">1</span>, name);
            <span class="hl-keyword">return</span> ps;
        }
    },
    keyHolder);

<span class="hl-comment">// keyHolder.getKey() now contains the generated key</span></pre>

</div>
</div>
<div class="section" title="13.3&nbsp;Controlling database connections"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-connections"></a>13.3&nbsp;Controlling database connections</h2></div></div></div>

<div class="section" title="13.3.1&nbsp;DataSource"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-datasource"></a>13.3.1&nbsp;DataSource</h3></div></div></div>

<p>Spring obtains a connection to the database through a <code class="literal">DataSource</code>. A <code class="literal">DataSource</code> is
part of the JDBC specification and is a generalized connection factory. It allows a
container or a framework to hide connection pooling and transaction management issues
from the application code. As a developer, you need not know details about how to
connect to the database; that is the responsibility of the administrator that sets up
the datasource. You most likely fill both roles as you develop and test code, but you do
not necessarily have to know how the production data source is configured.</p>
<p>When using Spring&#8217;s JDBC layer, you obtain a data source from JNDI or you configure your
own with a connection pool implementation provided by a third party. Popular
implementations are Apache Jakarta Commons DBCP and C3P0. Implementations in the Spring
distribution are meant only for testing purposes and do not provide pooling.</p>
<p>This section uses Spring&#8217;s <code class="literal">DriverManagerDataSource</code> implementation, and several
additional implementations are covered later.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Only use the <code class="literal">DriverManagerDataSource</code> class should only be used for testing purposes
since it does not provide pooling and will perform poorly when multiple requests for a
connection are made.</p>
</td></tr></table></div>

<p>You obtain a connection with <code class="literal">DriverManagerDataSource</code> as you typically obtain a JDBC
connection. Specify the fully qualified classname of the JDBC driver so that the
<code class="literal">DriverManager</code> can load the driver class. Next, provide a URL that varies between JDBC
drivers. (Consult the documentation for your driver for the correct value.) Then provide
a username and a password to connect to the database. Here is an example of how to
configure a <code class="literal">DriverManagerDataSource</code> in Java code:</p>
<pre class="programlisting">DriverManagerDataSource dataSource = <span class="hl-keyword">new</span> DriverManagerDataSource();
dataSource.setDriverClassName(<span class="hl-string">"org.hsqldb.jdbcDriver"</span>);
dataSource.setUrl(<span class="hl-string">"jdbc:hsqldb:hsql://localhost:"</span>);
dataSource.setUsername(<span class="hl-string">"sa"</span>);
dataSource.setPassword(<span class="hl-string">""</span>);</pre>

<p>Here is the corresponding XML configuration:</p>
<pre class="programlisting">&lt;bean id=<span class="hl-string">"dataSource"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;
    &lt;property name=<span class="hl-string">"driverClassName"</span> value=<span class="hl-string">"${jdbc.driverClassName}"</span>/&gt;
    &lt;property name=<span class="hl-string">"url"</span> value=<span class="hl-string">"${jdbc.url}"</span>/&gt;
    &lt;property name=<span class="hl-string">"username"</span> value=<span class="hl-string">"${jdbc.username}"</span>/&gt;
    &lt;property name=<span class="hl-string">"password"</span> value=<span class="hl-string">"${jdbc.password}"</span>/&gt;
&lt;/bean&gt;

&lt;context:property-placeholder location=<span class="hl-string">"jdbc.properties"</span>/&gt;</pre>

<p>The following examples show the basic connectivity and configuration for DBCP and C3P0.
To learn about more options that help control the pooling features, see the product
documentation for the respective connection pooling implementations.</p>
<p>DBCP configuration:</p>
<pre class="programlisting">&lt;bean id=<span class="hl-string">"dataSource"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"org.apache.commons.dbcp.BasicDataSource"</span> destroy-method=<span class="hl-string">"close"</span>&gt;
    &lt;property name=<span class="hl-string">"driverClassName"</span> value=<span class="hl-string">"${jdbc.driverClassName}"</span>/&gt;
    &lt;property name=<span class="hl-string">"url"</span> value=<span class="hl-string">"${jdbc.url}"</span>/&gt;
    &lt;property name=<span class="hl-string">"username"</span> value=<span class="hl-string">"${jdbc.username}"</span>/&gt;
    &lt;property name=<span class="hl-string">"password"</span> value=<span class="hl-string">"${jdbc.password}"</span>/&gt;
&lt;/bean&gt;

&lt;context:property-placeholder location=<span class="hl-string">"jdbc.properties"</span>/&gt;</pre>

<p>C3P0 configuration:</p>
<pre class="programlisting">&lt;bean id=<span class="hl-string">"dataSource"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span> destroy-method=<span class="hl-string">"close"</span>&gt;
    &lt;property name=<span class="hl-string">"driverClass"</span> value=<span class="hl-string">"${jdbc.driverClassName}"</span>/&gt;
    &lt;property name=<span class="hl-string">"jdbcUrl"</span> value=<span class="hl-string">"${jdbc.url}"</span>/&gt;
    &lt;property name=<span class="hl-string">"user"</span> value=<span class="hl-string">"${jdbc.username}"</span>/&gt;
    &lt;property name=<span class="hl-string">"password"</span> value=<span class="hl-string">"${jdbc.password}"</span>/&gt;
&lt;/bean&gt;

&lt;context:property-placeholder location=<span class="hl-string">"jdbc.properties"</span>/&gt;</pre>

</div>
<div class="section" title="13.3.2&nbsp;DataSourceUtils"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-DataSourceUtils"></a>13.3.2&nbsp;DataSourceUtils</h3></div></div></div>

<p>The <code class="literal">DataSourceUtils</code> class is a convenient and powerful helper class that provides
<code class="literal">static</code> methods to obtain connections from JNDI and close connections if necessary. It
supports thread-bound connections with, for example, <code class="literal">DataSourceTransactionManager</code>.</p>
</div>
<div class="section" title="13.3.3&nbsp;SmartDataSource"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-SmartDataSource"></a>13.3.3&nbsp;SmartDataSource</h3></div></div></div>

<p>The <code class="literal">SmartDataSource</code> interface should be implemented by classes that can provide a
connection to a relational database. It extends the <code class="literal">DataSource</code> interface to allow
classes using it to query whether the connection should be closed after a given
operation. This usage is efficient when you know that you will reuse a connection.</p>
</div>
<div class="section" title="13.3.4&nbsp;AbstractDataSource"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-AbstractDataSource"></a>13.3.4&nbsp;AbstractDataSource</h3></div></div></div>

<p><code class="literal">AbstractDataSource</code> is an <code class="literal">abstract</code> base class for Spring&#8217;s <code class="literal">DataSource</code>
implementations that implements code that is common to all <code class="literal">DataSource</code> implementations.
You extend the <code class="literal">AbstractDataSource</code> class if you are writing your own <code class="literal">DataSource</code>
implementation.</p>
</div>
<div class="section" title="13.3.5&nbsp;SingleConnectionDataSource"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-SingleConnectionDataSource"></a>13.3.5&nbsp;SingleConnectionDataSource</h3></div></div></div>

<p>The <code class="literal">SingleConnectionDataSource</code> class is an implementation of the <code class="literal">SmartDataSource</code>
interface that wraps a <span class="emphasis"><em>single</em></span> <code class="literal">Connection</code> that is <span class="emphasis"><em>not</em></span> closed after each use.
Obviously, this is not multi-threading capable.</p>
<p>If any client code calls <code class="literal">close</code> in the assumption of a pooled connection, as when using
persistence tools, set the <code class="literal">suppressClose</code> property to <code class="literal">true</code>. This setting returns a
close-suppressing proxy wrapping the physical connection. Be aware that you will not be
able to cast this to a native Oracle <code class="literal">Connection</code> or the like anymore.</p>
<p>This is primarily a test class. For example, it enables easy testing of code outside an
application server, in conjunction with a simple JNDI environment. In contrast to
<code class="literal">DriverManagerDataSource</code>, it reuses the same connection all the time, avoiding
excessive creation of physical connections.</p>
</div>
<div class="section" title="13.3.6&nbsp;DriverManagerDataSource"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-DriverManagerDataSource"></a>13.3.6&nbsp;DriverManagerDataSource</h3></div></div></div>

<p>The <code class="literal">DriverManagerDataSource</code> class is an implementation of the standard <code class="literal">DataSource</code>
interface that configures a plain JDBC driver through bean properties, and returns a new
<code class="literal">Connection</code> every time.</p>
<p>This implementation is useful for test and stand-alone environments outside of a Java EE
container, either as a <code class="literal">DataSource</code> bean in a Spring IoC container, or in conjunction
with a simple JNDI environment. Pool-assuming <code class="literal">Connection.close()</code> calls will simply
close the connection, so any <code class="literal">DataSource</code>-aware persistence code should work. However,
using JavaBean-style connection pools such as <code class="literal">commons-dbcp</code> is so easy, even in a test
environment, that it is almost always preferable to use such a connection pool over
<code class="literal">DriverManagerDataSource</code>.</p>
</div>
<div class="section" title="13.3.7&nbsp;TransactionAwareDataSourceProxy"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-TransactionAwareDataSourceProxy"></a>13.3.7&nbsp;TransactionAwareDataSourceProxy</h3></div></div></div>

<p><code class="literal">TransactionAwareDataSourceProxy</code> is a proxy for a target <code class="literal">DataSource</code>, which wraps that
target <code class="literal">DataSource</code> to add awareness of Spring-managed transactions. In this respect, it
is similar to a transactional JNDI <code class="literal">DataSource</code> as provided by a Java EE server.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is rarely desirable to use this class, except when already existing code that must be
called and passed a standard JDBC <code class="literal">DataSource</code> interface implementation. In this case,
it&#8217;s possible to still have this code be usable, and at the same time have this code
participating in Spring managed transactions. It is generally preferable to write your
own new code using the higher level abstractions for resource management, such as
<code class="literal">JdbcTemplate</code> or <code class="literal">DataSourceUtils</code>.</p>
</td></tr></table></div>

<p><span class="emphasis"><em>(See the <code class="literal">TransactionAwareDataSourceProxy</code> Javadocs for more details.)</em></span></p>
</div>
<div class="section" title="13.3.8&nbsp;DataSourceTransactionManager"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-DataSourceTransactionManager"></a>13.3.8&nbsp;DataSourceTransactionManager</h3></div></div></div>

<p>The <code class="literal">DataSourceTransactionManager</code> class is a <code class="literal">PlatformTransactionManager</code>
implementation for single JDBC datasources. It binds a JDBC connection from the
specified data source to the currently executing thread, potentially allowing for one
thread connection per data source.</p>
<p>Application code is required to retrieve the JDBC connection through
<code class="literal">DataSourceUtils.getConnection(DataSource)</code> instead of Java EE&#8217;s standard
<code class="literal">DataSource.getConnection</code>. It throws unchecked <code class="literal">org.springframework.dao</code> exceptions
instead of checked <code class="literal">SQLExceptions</code>. All framework classes like <code class="literal">JdbcTemplate</code> use this
strategy implicitly. If not used with this transaction manager, the lookup strategy
behaves exactly like the common one - it can thus be used in any case.</p>
<p>The <code class="literal">DataSourceTransactionManager</code> class supports custom isolation levels, and timeouts
that get applied as appropriate JDBC statement query timeouts. To support the latter,
application code must either use <code class="literal">JdbcTemplate</code> or call the
<code class="literal">DataSourceUtils.applyTransactionTimeout(..)</code> method for each created statement.</p>
<p>This implementation can be used instead of <code class="literal">JtaTransactionManager</code> in the single
resource case, as it does not require the container to support JTA. Switching between
both is just a matter of configuration, if you stick to the required connection lookup
pattern. JTA does not support custom isolation levels!</p>
</div>
<div class="section" title="13.3.9&nbsp;NativeJdbcExtractor"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-NativeJdbcExtractor"></a>13.3.9&nbsp;NativeJdbcExtractor</h3></div></div></div>

<p>Sometimes you need to access vendor specific JDBC methods that differ from the standard
JDBC API. This can be problematic if you are running in an application server or with a
<code class="literal">DataSource</code> that wraps the <code class="literal">Connection</code>, <code class="literal">Statement</code> and <code class="literal">ResultSet</code> objects with its
own wrapper objects. To gain access to the native objects you can configure your
<code class="literal">JdbcTemplate</code> or <code class="literal">OracleLobHandler</code> with a <code class="literal">NativeJdbcExtractor</code>.</p>
<p>The <code class="literal">NativeJdbcExtractor</code> comes in a variety of flavors to match your execution
environment:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
SimpleNativeJdbcExtractor
</li><li class="listitem">
C3P0NativeJdbcExtractor
</li><li class="listitem">
CommonsDbcpNativeJdbcExtractor
</li><li class="listitem">
JBossNativeJdbcExtractor
</li><li class="listitem">
WebLogicNativeJdbcExtractor
</li><li class="listitem">
WebSphereNativeJdbcExtractor
</li><li class="listitem">
XAPoolNativeJdbcExtractor
</li></ul></div>

<p>Usually the <code class="literal">SimpleNativeJdbcExtractor</code> is sufficient for unwrapping a <code class="literal">Connection</code>
object in most environments. See the Javadocs for more details.</p>
</div>
</div>
<div class="section" title="13.4&nbsp;JDBC batch operations"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-advanced-jdbc"></a>13.4&nbsp;JDBC batch operations</h2></div></div></div>

<p>Most JDBC drivers provide improved performance if you batch multiple calls to the same
prepared statement. By grouping updates into batches you limit the number of round trips
to the database.</p>
<div class="section" title="13.4.1&nbsp;Basic batch operations with the JdbcTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-batch-classic"></a>13.4.1&nbsp;Basic batch operations with the JdbcTemplate</h3></div></div></div>

<p>You accomplish <code class="literal">JdbcTemplate</code> batch processing by implementing two methods of a special
interface, <code class="literal">BatchPreparedStatementSetter</code>, and passing that in as the second parameter
in your <code class="literal">batchUpdate</code> method call. Use the <code class="literal">getBatchSize</code> method to provide the size of
the current batch. Use the <code class="literal">setValues</code> method to set the values for the parameters of
the prepared statement. This method will be called the number of times that you
specified in the <code class="literal">getBatchSize</code> call. The following example updates the actor table
based on entries in a list. The entire list is used as the batch in this example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {
    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span>[] batchUpdate(<span class="hl-keyword">final</span> List&lt;Actor&gt; actors) {
        <span class="hl-keyword">int</span>[] updateCounts = jdbcTemplate.batchUpdate(<span class="hl-string">"update t_actor set first_name = ?, "</span> +
                <span class="hl-string">"last_name = ? where id = ?"</span>,
            <span class="hl-keyword">new</span> BatchPreparedStatementSetter() {
                <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setValues(PreparedStatement ps, <span class="hl-keyword">int</span> i) <span class="hl-keyword">throws</span> SQLException {
                        ps.setString(<span class="hl-number">1</span>, actors.get(i).getFirstName());
                        ps.setString(<span class="hl-number">2</span>, actors.get(i).getLastName());
                        ps.setLong(<span class="hl-number">3</span>, actors.get(i).getId().longValue());
                    }

                    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getBatchSize() {
                        <span class="hl-keyword">return</span> actors.size();
                    }
                });
        <span class="hl-keyword">return</span> updateCounts;
    }

    <span class="hl-comment">// ... additional methods</span>
}</pre>

<p>If you are processing a stream of updates or reading from a file, then you might have a
preferred batch size, but the last batch might not have that number of entries. In this
case you can use the <code class="literal">InterruptibleBatchPreparedStatementSetter</code> interface, which allows
you to interrupt a batch once the input source is exhausted. The <code class="literal">isBatchExhausted</code> method
allows you to signal the end of the batch.</p>
</div>
<div class="section" title="13.4.2&nbsp;Batch operations with a List of objects"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-batch-list"></a>13.4.2&nbsp;Batch operations with a List of objects</h3></div></div></div>

<p>Both the <code class="literal">JdbcTemplate</code> and the <code class="literal">NamedParameterJdbcTemplate</code> provides an alternate way
of providing the batch update. Instead of implementing a special batch interface, you
provide all parameter values in the call as a list. The framework loops over these
values and uses an internal prepared statement setter. The API varies depending on
whether you use named parameters. For the named parameters you provide an array of
<code class="literal">SqlParameterSource</code>, one entry for each member of the batch. You can use the
<code class="literal">SqlParameterSource.createBatch</code> method to create this array, passing in either an array
of JavaBeans or an array of Maps containing the parameter values.</p>
<p>This example shows a batch update using named parameters:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {
    <span class="hl-keyword">private</span> NamedParameterTemplate namedParameterJdbcTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.namedParameterJdbcTemplate = <span class="hl-keyword">new</span> NamedParameterJdbcTemplate(dataSource);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span>[] batchUpdate(<span class="hl-keyword">final</span> List&lt;Actor&gt; actors) {
        SqlParameterSource[] batch = SqlParameterSourceUtils.createBatch(actors.toArray());
        <span class="hl-keyword">int</span>[] updateCounts = namedParameterJdbcTemplate.batchUpdate(
                <span class="hl-string">"update t_actor set first_name = :firstName, last_name = :lastName where id = :id"</span>,
                batch);
        <span class="hl-keyword">return</span> updateCounts;
    }

    <span class="hl-comment">// ... additional methods</span>
}</pre>

<p>For an SQL statement using the classic "?" placeholders, you pass in a list containing an
object array with the update values. This object array must have one entry for each
placeholder in the SQL statement, and they must be in the same order as they are defined
in the SQL statement.</p>
<p>The same example using classic JDBC "?" placeholders:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span>[] batchUpdate(<span class="hl-keyword">final</span> List&lt;Actor&gt; actors) {
        List&lt;Object[]&gt; batch = <span class="hl-keyword">new</span> ArrayList&lt;Object[]&gt;();
        <span class="hl-keyword">for</span> (Actor actor : actors) {
            Object[] values = <span class="hl-keyword">new</span> Object[] {
                    actor.getFirstName(),
                    actor.getLastName(),
                    actor.getId()};
            batch.add(values);
        }
        <span class="hl-keyword">int</span>[] updateCounts = jdbcTemplate.batchUpdate(
                <span class="hl-string">"update t_actor set first_name = ?, last_name = ? where id = ?"</span>,
                batch);
        <span class="hl-keyword">return</span> updateCounts;
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>All of the above batch update methods return an int array containing the number of
affected rows for each batch entry. This count is reported by the JDBC driver. If the
count is not available, the JDBC driver returns a -2 value.</p>
</div>
<div class="section" title="13.4.3&nbsp;Batch operations with multiple batches"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-batch-multi"></a>13.4.3&nbsp;Batch operations with multiple batches</h3></div></div></div>

<p>The last example of a batch update deals with batches that are so large that you want to
break them up into several smaller batches. You can of course do this with the methods
mentioned above by making multiple calls to the <code class="literal">batchUpdate</code> method, but there is now a
more convenient method. This method takes, in addition to the SQL statement, a
Collection of objects containing the parameters, the number of updates to make for each
batch and a <code class="literal">ParameterizedPreparedStatementSetter</code> to set the values for the parameters
of the prepared statement. The framework loops over the provided values and breaks the
update calls into batches of the size specified.</p>
<p>This example shows a batch update using a batch size of 100:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span>[][] batchUpdate(<span class="hl-keyword">final</span> Collection&lt;Actor&gt; actors) {
        <span class="hl-keyword">int</span>[][] updateCounts = jdbcTemplate.batchUpdate(
                <span class="hl-string">"update t_actor set first_name = ?, last_name = ? where id = ?"</span>,
                actors,
                <span class="hl-number">100</span>,
                <span class="hl-keyword">new</span> ParameterizedPreparedStatementSetter&lt;Actor&gt;() {
                    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setValues(PreparedStatement ps, Actor argument) <span class="hl-keyword">throws</span> SQLException {
                        ps.setString(<span class="hl-number">1</span>, argument.getFirstName());
                        ps.setString(<span class="hl-number">2</span>, argument.getLastName());
                        ps.setLong(<span class="hl-number">3</span>, argument.getId().longValue());
                    }
                });
        <span class="hl-keyword">return</span> updateCounts;
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>The batch update methods for this call returns an array of int arrays containing an array
entry for each batch with an array of the number of affected rows for each update. The top
level array&#8217;s length indicates the number of batches executed and the second level array&#8217;s
length indicates the number of updates in that batch. The number of updates in each batch
should be the the batch size provided for all batches except for the last one that might
be less, depending on the total number of update objects provided. The update count for
each update statement is the one reported by the JDBC driver. If the count is not
available, the JDBC driver returns a -2 value.</p>
</div>
</div>
<div class="section" title="13.5&nbsp;Simplifying JDBC operations with the SimpleJdbc classes"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-simple-jdbc"></a>13.5&nbsp;Simplifying JDBC operations with the SimpleJdbc classes</h2></div></div></div>

<p>The <code class="literal">SimpleJdbcInsert</code> and <code class="literal">SimpleJdbcCall</code> classes provide a simplified configuration
by taking advantage of database metadata that can be retrieved through the JDBC driver.
This means there is less to configure up front, although you can override or turn off
the metadata processing if you prefer to provide all the details in your code.</p>
<div class="section" title="13.5.1&nbsp;Inserting data using SimpleJdbcInsert"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-simple-jdbc-insert-1"></a>13.5.1&nbsp;Inserting data using SimpleJdbcInsert</h3></div></div></div>

<p>Let&#8217;s start by looking at the <code class="literal">SimpleJdbcInsert</code> class with the minimal amount of
configuration options. You should instantiate the <code class="literal">SimpleJdbcInsert</code> in the data access
layer&#8217;s initialization method. For this example, the initializing method is the
<code class="literal">setDataSource</code> method. You do not need to subclass the <code class="literal">SimpleJdbcInsert</code> class; simply
create a new instance and set the table name using the <code class="literal">withTableName</code> method.
Configuration methods for this class follow the "fluid" style that returns the instance
of the <code class="literal">SimpleJdbcInsert</code>, which allows you to chain all configuration methods. This
example uses only one configuration method; you will see examples of multiple ones later.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;
    <span class="hl-keyword">private</span> SimpleJdbcInsert insertActor;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        <span class="hl-keyword">this</span>.insertActor = <span class="hl-keyword">new</span> SimpleJdbcInsert(dataSource).withTableName(<span class="hl-string">"t_actor"</span>);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> add(Actor actor) {
        Map&lt;String, Object&gt; parameters = <span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;(<span class="hl-number">3</span>);
        parameters.put(<span class="hl-string">"id"</span>, actor.getId());
        parameters.put(<span class="hl-string">"first_name"</span>, actor.getFirstName());
        parameters.put(<span class="hl-string">"last_name"</span>, actor.getLastName());
        insertActor.execute(parameters);
    }

    <span class="hl-comment">// ... additional methods</span>
}</pre>

<p>The execute method used here takes a plain <code class="literal">java.utils.Map</code> as its only parameter. The
important thing to note here is that the keys used for the Map must match the column
names of the table as defined in the database. This is because we read the metadata in
order to construct the actual insert statement.</p>
</div>
<div class="section" title="13.5.2&nbsp;Retrieving auto-generated keys using SimpleJdbcInsert"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-simple-jdbc-insert-2"></a>13.5.2&nbsp;Retrieving auto-generated keys using SimpleJdbcInsert</h3></div></div></div>

<p>This example uses the same insert as the preceding, but instead of passing in the id it
retrieves the auto-generated key and sets it on the new Actor object. When you create
the <code class="literal">SimpleJdbcInsert</code>, in addition to specifying the table name, you specify the name
of the generated key column with the <code class="literal">usingGeneratedKeyColumns</code> method.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;
    <span class="hl-keyword">private</span> SimpleJdbcInsert insertActor;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        <span class="hl-keyword">this</span>.insertActor = <span class="hl-keyword">new</span> SimpleJdbcInsert(dataSource)
                .withTableName(<span class="hl-string">"t_actor"</span>)
                .usingGeneratedKeyColumns(<span class="hl-string">"id"</span>);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> add(Actor actor) {
        Map&lt;String, Object&gt; parameters = <span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;(<span class="hl-number">2</span>);
        parameters.put(<span class="hl-string">"first_name"</span>, actor.getFirstName());
        parameters.put(<span class="hl-string">"last_name"</span>, actor.getLastName());
        Number newId = insertActor.executeAndReturnKey(parameters);
        actor.setId(newId.longValue());
    }

    <span class="hl-comment">// ... additional methods</span>
}</pre>

<p>The main difference when executing the insert by this second approach is that you do not
add the id to the Map and you call the <code class="literal">executeReturningKey</code> method. This returns a
<code class="literal">java.lang.Number</code> object with which you can create an instance of the numerical type that
is used in our domain class. You cannot rely on all databases to return a specific Java
class here; <code class="literal">java.lang.Number</code> is the base class that you can rely on. If you have
multiple auto-generated columns, or the generated values are non-numeric, then you can
use a <code class="literal">KeyHolder</code> that is returned from the <code class="literal">executeReturningKeyHolder</code> method.</p>
</div>
<div class="section" title="13.5.3&nbsp;Specifying columns for a SimpleJdbcInsert"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-simple-jdbc-insert-3"></a>13.5.3&nbsp;Specifying columns for a SimpleJdbcInsert</h3></div></div></div>

<p>You can limit the columns for an insert by specifying a list of column names with the
<code class="literal">usingColumns</code> method:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;
    <span class="hl-keyword">private</span> SimpleJdbcInsert insertActor;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        <span class="hl-keyword">this</span>.insertActor = <span class="hl-keyword">new</span> SimpleJdbcInsert(dataSource)
                .withTableName(<span class="hl-string">"t_actor"</span>)
                .usingColumns(<span class="hl-string">"first_name"</span>, <span class="hl-string">"last_name"</span>)
                .usingGeneratedKeyColumns(<span class="hl-string">"id"</span>);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> add(Actor actor) {
        Map&lt;String, Object&gt; parameters = <span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;(<span class="hl-number">2</span>);
        parameters.put(<span class="hl-string">"first_name"</span>, actor.getFirstName());
        parameters.put(<span class="hl-string">"last_name"</span>, actor.getLastName());
        Number newId = insertActor.executeAndReturnKey(parameters);
        actor.setId(newId.longValue());
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>The execution of the insert is the same as if you had relied on the metadata to determine
which columns to use.</p>
</div>
<div class="section" title="13.5.4&nbsp;Using SqlParameterSource to provide parameter values"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-simple-jdbc-parameters"></a>13.5.4&nbsp;Using SqlParameterSource to provide parameter values</h3></div></div></div>

<p>Using a <code class="literal">Map</code> to provide parameter values works fine, but it&#8217;s not the most convenient
class to use. Spring provides a couple of implementations of the <code class="literal">SqlParameterSource</code>
interface that can be used instead.The first one is <code class="literal">BeanPropertySqlParameterSource</code>,
which is a very convenient class if you have a JavaBean-compliant class that contains
your values. It will use the corresponding getter method to extract the parameter
values. Here is an example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;
    <span class="hl-keyword">private</span> SimpleJdbcInsert insertActor;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        <span class="hl-keyword">this</span>.insertActor = <span class="hl-keyword">new</span> SimpleJdbcInsert(dataSource)
                .withTableName(<span class="hl-string">"t_actor"</span>)
                .usingGeneratedKeyColumns(<span class="hl-string">"id"</span>);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> add(Actor actor) {
        SqlParameterSource parameters = <span class="hl-keyword">new</span> BeanPropertySqlParameterSource(actor);
        Number newId = insertActor.executeAndReturnKey(parameters);
        actor.setId(newId.longValue());
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>Another option is the <code class="literal">MapSqlParameterSource</code> that resembles a Map but provides a more
convenient <code class="literal">addValue</code> method that can be chained.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;
    <span class="hl-keyword">private</span> SimpleJdbcInsert insertActor;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        <span class="hl-keyword">this</span>.insertActor = <span class="hl-keyword">new</span> SimpleJdbcInsert(dataSource)
                .withTableName(<span class="hl-string">"t_actor"</span>)
                .usingGeneratedKeyColumns(<span class="hl-string">"id"</span>);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> add(Actor actor) {
        SqlParameterSource parameters = <span class="hl-keyword">new</span> MapSqlParameterSource()
                .addValue(<span class="hl-string">"first_name"</span>, actor.getFirstName())
                .addValue(<span class="hl-string">"last_name"</span>, actor.getLastName());
        Number newId = insertActor.executeAndReturnKey(parameters);
        actor.setId(newId.longValue());
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>As you can see, the configuration is the same; only the executing code has to change to
use these alternative input classes.</p>
</div>
<div class="section" title="13.5.5&nbsp;Calling a stored procedure with SimpleJdbcCall"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-simple-jdbc-call-1"></a>13.5.5&nbsp;Calling a stored procedure with SimpleJdbcCall</h3></div></div></div>

<p>The <code class="literal">SimpleJdbcCall</code> class leverages metadata in the database to look up names of <code class="literal">in</code>
and <code class="literal">out</code> parameters, so that you do not have to declare them explicitly. You can
declare parameters if you prefer to do that, or if you have parameters such as <code class="literal">ARRAY</code>
or <code class="literal">STRUCT</code> that do not have an automatic mapping to a Java class. The first example
shows a simple procedure that returns only scalar values in <code class="literal">VARCHAR</code> and <code class="literal">DATE</code> format
from a MySQL database. The example procedure reads a specified actor entry and returns
<code class="literal">first_name</code>, <code class="literal">last_name</code>, and <code class="literal">birth_date</code> columns in the form of <code class="literal">out</code> parameters.</p>
<pre class="programlisting">CREATE PROCEDURE read_actor (
    IN in_id INTEGER,
    OUT out_first_name VARCHAR(100),
    OUT out_last_name VARCHAR(100),
    OUT out_birth_date DATE)
BEGIN
    SELECT first_name, last_name, birth_date
    INTO out_first_name, out_last_name, out_birth_date
    FROM t_actor where id = in_id;
END;</pre>

<p>The <code class="literal">in_id</code> parameter contains the <code class="literal">id</code> of the actor you are looking up. The <code class="literal">out</code>
parameters return the data read from the table.</p>
<p>The <code class="literal">SimpleJdbcCall</code> is declared in a similar manner to the <code class="literal">SimpleJdbcInsert</code>. You
should instantiate and configure the class in the initialization method of your data
access layer. Compared to the StoredProcedure class, you don&#8217;t have to create a subclass
and you don&#8217;t have to declare parameters that can be looked up in the database metadata.
Following is an example of a SimpleJdbcCall configuration using the above stored
procedure. The only configuration option, in addition to the <code class="literal">DataSource</code>, is the name
of the stored procedure.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;
    <span class="hl-keyword">private</span> SimpleJdbcCall procReadActor;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        <span class="hl-keyword">this</span>.procReadActor = <span class="hl-keyword">new</span> SimpleJdbcCall(dataSource)
                .withProcedureName(<span class="hl-string">"read_actor"</span>);
    }

    <span class="hl-keyword">public</span> Actor readActor(Long id) {
        SqlParameterSource in = <span class="hl-keyword">new</span> MapSqlParameterSource()
                .addValue(<span class="hl-string">"in_id"</span>, id);
        Map out = procReadActor.execute(in);
        Actor actor = <span class="hl-keyword">new</span> Actor();
        actor.setId(id);
        actor.setFirstName((String) out.get(<span class="hl-string">"out_first_name"</span>));
        actor.setLastName((String) out.get(<span class="hl-string">"out_last_name"</span>));
        actor.setBirthDate((Date) out.get(<span class="hl-string">"out_birth_date"</span>));
        <span class="hl-keyword">return</span> actor;
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>The code you write for the execution of the call involves creating an <code class="literal">SqlParameterSource</code>
containing the IN parameter. It&#8217;s important to match the name provided for the input value
with that of the parameter name declared in the stored procedure. The case does not have
to match because you use metadata to determine how database objects should be referred to
in a stored procedure. What is specified in the source for the stored procedure is not
necessarily the way it is stored in the database. Some databases transform names to all
upper case while others use lower case or use the case as specified.</p>
<p>The <code class="literal">execute</code> method takes the IN parameters and returns a Map containing any <code class="literal">out</code>
parameters keyed by the name as specified in the stored procedure. In this case they are
<code class="literal">out_first_name, out_last_name</code> and <code class="literal">out_birth_date</code>.</p>
<p>The last part of the <code class="literal">execute</code> method creates an Actor instance to use to return the
data retrieved. Again, it is important to use the names of the <code class="literal">out</code> parameters as they
are declared in the stored procedure. Also, the case in the names of the <code class="literal">out</code>
parameters stored in the results map matches that of the <code class="literal">out</code> parameter names in the
database, which could vary between databases. To make your code more portable you should
do a case-insensitive lookup or instruct Spring to use a <code class="literal">CaseInsensitiveMap</code> from the
Jakarta Commons project. To do the latter, you create your own <code class="literal">JdbcTemplate</code> and set
the <code class="literal">setResultsMapCaseInsensitive</code> property to <code class="literal">true</code>. Then you pass this customized
<code class="literal">JdbcTemplate</code> instance into the constructor of your <code class="literal">SimpleJdbcCall</code>. You must include
the <code class="literal">commons-collections.jar</code> in your classpath for this to work. Here is an example of
this configuration:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> SimpleJdbcCall procReadActor;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        JdbcTemplate jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        jdbcTemplate.setResultsMapCaseInsensitive(true);
        <span class="hl-keyword">this</span>.procReadActor = <span class="hl-keyword">new</span> SimpleJdbcCall(jdbcTemplate)
                .withProcedureName(<span class="hl-string">"read_actor"</span>);
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>By taking this action, you avoid conflicts in the case used for the names of your
returned <code class="literal">out</code> parameters.</p>
</div>
<div class="section" title="13.5.6&nbsp;Explicitly declaring parameters to use for a SimpleJdbcCall"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-simple-jdbc-call-2"></a>13.5.6&nbsp;Explicitly declaring parameters to use for a SimpleJdbcCall</h3></div></div></div>

<p>You have seen how the parameters are deduced based on metadata, but you can declare then
explicitly if you wish. You do this by creating and configuring <code class="literal">SimpleJdbcCall</code> with
the <code class="literal">declareParameters</code> method, which takes a variable number of <code class="literal">SqlParameter</code> objects
as input. See the next section for details on how to define an <code class="literal">SqlParameter</code>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Explicit declarations are necessary if the database you use is not a Spring-supported
database. Currently Spring supports metadata lookup of stored procedure calls for the
following databases: Apache Derby, DB2, MySQL, Microsoft SQL Server, Oracle, and Sybase.
We also support metadata lookup of stored functions for: MySQL, Microsoft SQL Server,
and Oracle.</p>
</td></tr></table></div>

<p>You can opt to declare one, some, or all the parameters explicitly. The parameter
metadata is still used where you do not declare parameters explicitly. To bypass all
processing of metadata lookups for potential parameters and only use the declared
parameters, you call the method <code class="literal">withoutProcedureColumnMetaDataAccess</code> as part of the
declaration. Suppose that you have two or more different call signatures declared for a
database function. In this case you call the <code class="literal">useInParameterNames</code> to specify the list
of IN parameter names to include for a given signature.</p>
<p>The following example shows a fully declared procedure call, using the information from
the preceding example.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> SimpleJdbcCall procReadActor;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        JdbcTemplate jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        jdbcTemplate.setResultsMapCaseInsensitive(true);
        <span class="hl-keyword">this</span>.procReadActor = <span class="hl-keyword">new</span> SimpleJdbcCall(jdbcTemplate)
                .withProcedureName(<span class="hl-string">"read_actor"</span>)
                .withoutProcedureColumnMetaDataAccess()
                .useInParameterNames(<span class="hl-string">"in_id"</span>)
                .declareParameters(
                        <span class="hl-keyword">new</span> SqlParameter(<span class="hl-string">"in_id"</span>, Types.NUMERIC),
                        <span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"out_first_name"</span>, Types.VARCHAR),
                        <span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"out_last_name"</span>, Types.VARCHAR),
                        <span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"out_birth_date"</span>, Types.DATE)
                );
    }

    <span class="hl-comment">// ... additional methods</span>
}</pre>

<p>The execution and end results of the two examples are the same; this one specifies all
details explicitly rather than relying on metadata.</p>
</div>
<div class="section" title="13.5.7&nbsp;How to define SqlParameters"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-params"></a>13.5.7&nbsp;How to define SqlParameters</h3></div></div></div>

<p>To define a parameter for the SimpleJdbc classes and also for the RDBMS operations
classes, covered in <a class="xref" href="#jdbc-object" title="13.6&nbsp;Modeling JDBC operations as Java objects">Section&nbsp;13.6, &#8220;Modeling JDBC operations as Java objects&#8221;</a>, you use an <code class="literal">SqlParameter</code> or one of its subclasses.
You typically specify the parameter name and SQL type in the constructor. The SQL type
is specified using the <code class="literal">java.sql.Types</code> constants. We have already seen declarations
like:</p>
<pre class="programlisting"><span class="hl-keyword">new</span> SqlParameter(<span class="hl-string">"in_id"</span>, Types.NUMERIC),
    <span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"out_first_name"</span>, Types.VARCHAR),</pre>

<p>The first line with the <code class="literal">SqlParameter</code> declares an IN parameter. IN parameters can be
used for both stored procedure calls and for queries using the <code class="literal">SqlQuery</code> and its
subclasses covered in the following section.</p>
<p>The second line with the <code class="literal">SqlOutParameter</code> declares an <code class="literal">out</code> parameter to be used in a
stored procedure call. There is also an <code class="literal">SqlInOutParameter</code> for <code class="literal">InOut</code> parameters,
parameters that provide an <code class="literal">IN</code> value to the procedure and that also return a value.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Only parameters declared as <code class="literal">SqlParameter</code> and <code class="literal">SqlInOutParameter</code> will be used to
provide input values. This is different from the <code class="literal">StoredProcedure</code> class, which for
backwards compatibility reasons allows input values to be provided for parameters
declared as <code class="literal">SqlOutParameter</code>.</p>
</td></tr></table></div>

<p>For IN parameters, in addition to the name and the SQL type, you can specify a scale for
numeric data or a type name for custom database types. For <code class="literal">out</code> parameters, you can
provide a <code class="literal">RowMapper</code> to handle mapping of rows returned from a <code class="literal">REF</code> cursor. Another
option is to specify an <code class="literal">SqlReturnType</code> that provides an opportunity to define
customized handling of the return values.</p>
</div>
<div class="section" title="13.5.8&nbsp;Calling a stored function using SimpleJdbcCall"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-simple-jdbc-call-3"></a>13.5.8&nbsp;Calling a stored function using SimpleJdbcCall</h3></div></div></div>

<p>You call a stored function in almost the same way as you call a stored procedure, except
that you provide a function name rather than a procedure name. You use the
<code class="literal">withFunctionName</code> method as part of the configuration to indicate that we want to make
a call to a function, and the corresponding string for a function call is generated. A
specialized execute call, <code class="literal">executeFunction,</code> is used to execute the function and it
returns the function return value as an object of a specified type, which means you do
not have to retrieve the return value from the results map. A similar convenience method
named <code class="literal">executeObject</code> is also available for stored procedures that only have one <code class="literal">out</code>
parameter. The following example is based on a stored function named <code class="literal">get_actor_name</code>
that returns an actor&#8217;s full name. Here is the MySQL source for this function:</p>
<pre class="programlisting">CREATE FUNCTION get_actor_name (in_id INTEGER)
RETURNS VARCHAR(200) READS SQL DATA
BEGIN
    DECLARE out_name VARCHAR(200);
    SELECT concat(first_name, ' ', last_name)
        INTO out_name
        FROM t_actor where id = in_id;
    RETURN out_name;
END;</pre>

<p>To call this function we again create a <code class="literal">SimpleJdbcCall</code> in the initialization method.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> JdbcTemplate jdbcTemplate;
    <span class="hl-keyword">private</span> SimpleJdbcCall funcGetActorName;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        JdbcTemplate jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        jdbcTemplate.setResultsMapCaseInsensitive(true);
        <span class="hl-keyword">this</span>.funcGetActorName = <span class="hl-keyword">new</span> SimpleJdbcCall(jdbcTemplate)
                .withFunctionName(<span class="hl-string">"get_actor_name"</span>);
    }

    <span class="hl-keyword">public</span> String getActorName(Long id) {
        SqlParameterSource in = <span class="hl-keyword">new</span> MapSqlParameterSource()
                .addValue(<span class="hl-string">"in_id"</span>, id);
        String name = funcGetActorName.executeFunction(String.<span class="hl-keyword">class</span>, in);
        <span class="hl-keyword">return</span> name;
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>The execute method used returns a <code class="literal">String</code> containing the return value from the function
call.</p>
</div>
<div class="section" title="13.5.9&nbsp;Returning ResultSet/REF Cursor from a SimpleJdbcCall"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-simple-jdbc-call-4"></a>13.5.9&nbsp;Returning ResultSet/REF Cursor from a SimpleJdbcCall</h3></div></div></div>

<p>Calling a stored procedure or function that returns a result set is a bit tricky. Some
databases return result sets during the JDBC results processing while others require an
explicitly registered <code class="literal">out</code> parameter of a specific type. Both approaches need
additional processing to loop over the result set and process the returned rows. With
the <code class="literal">SimpleJdbcCall</code> you use the <code class="literal">returningResultSet</code> method and declare a <code class="literal">RowMapper</code>
implementation to be used for a specific parameter. In the case where the result set is
returned during the results processing, there are no names defined, so the returned
results will have to match the order in which you declare the <code class="literal">RowMapper</code>
implementations. The name specified is still used to store the processed list of results
in the results map that is returned from the execute statement.</p>
<p>The next example uses a stored procedure that takes no IN parameters and returns all
rows from the t_actor table. Here is the MySQL source for this procedure:</p>
<pre class="programlisting">CREATE PROCEDURE read_all_actors()
BEGIN
 SELECT a.id, a.first_name, a.last_name, a.birth_date FROM t_actor a;
END;</pre>

<p>To call this procedure you declare the <code class="literal">RowMapper</code>. Because the class you want to map to
follows the JavaBean rules, you can use a <code class="literal">ParameterizedBeanPropertyRowMapper</code> that is
created by passing in the required class to map to in the <code class="literal">newInstance</code> method.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JdbcActorDao <span class="hl-keyword">implements</span> ActorDao {

    <span class="hl-keyword">private</span> SimpleJdbcCall procReadAllActors;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        JdbcTemplate jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
        jdbcTemplate.setResultsMapCaseInsensitive(true);
        <span class="hl-keyword">this</span>.procReadAllActors = <span class="hl-keyword">new</span> SimpleJdbcCall(jdbcTemplate)
                .withProcedureName(<span class="hl-string">"read_all_actors"</span>)
                .returningResultSet(<span class="hl-string">"actors"</span>,
                ParameterizedBeanPropertyRowMapper.newInstance(Actor.<span class="hl-keyword">class</span>));
    }

    <span class="hl-keyword">public</span> List getActorsList() {
        Map m = procReadAllActors.execute(<span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;(<span class="hl-number">0</span>));
        <span class="hl-keyword">return</span> (List) m.get(<span class="hl-string">"actors"</span>);
    }

    <span class="hl-comment">// ... additional methods</span>

}</pre>

<p>The execute call passes in an empty Map because this call does not take any parameters.
The list of Actors is then retrieved from the results map and returned to the caller.</p>
</div>
</div>
<div class="section" title="13.6&nbsp;Modeling JDBC operations as Java objects"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-object"></a>13.6&nbsp;Modeling JDBC operations as Java objects</h2></div></div></div>

<p>The <code class="literal">org.springframework.jdbc.object</code> package contains classes that allow you to access
the database in a more object-oriented manner. As an example, you can execute queries
and get the results back as a list containing business objects with the relational
column data mapped to the properties of the business object. You can also execute stored
procedures and run update, delete, and insert statements.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Many Spring developers believe that the various RDBMS operation classes described below
(with the exception of the <a class="link" href="#jdbc-StoredProcedure" title="13.6.4&nbsp;StoredProcedure"><code class="literal">StoredProcedure</code></a> class) can often
be replaced with straight <code class="literal">JdbcTemplate</code> calls. Often it is simpler to write a DAO
method that simply calls a method on a <code class="literal">JdbcTemplate</code> directly (as opposed to
encapsulating a query as a full-blown class).</p>
<p>However, if you are getting measurable value from using the RDBMS operation classes,
continue using these classes.</p>
</td></tr></table></div>

<div class="section" title="13.6.1&nbsp;SqlQuery"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-SqlQuery"></a>13.6.1&nbsp;SqlQuery</h3></div></div></div>

<p><code class="literal">SqlQuery</code> is a reusable, threadsafe class that encapsulates an SQL query. Subclasses
must implement the <code class="literal">newRowMapper(..)</code> method to provide a <code class="literal">RowMapper</code> instance that can
create one object per row obtained from iterating over the <code class="literal">ResultSet</code> that is created
during the execution of the query. The <code class="literal">SqlQuery</code> class is rarely used directly because
the <code class="literal">MappingSqlQuery</code> subclass provides a much more convenient implementation for
mapping rows to Java classes. Other implementations that extend <code class="literal">SqlQuery</code> are
<code class="literal">MappingSqlQueryWithParameters</code> and <code class="literal">UpdatableSqlQuery</code>.</p>
</div>
<div class="section" title="13.6.2&nbsp;MappingSqlQuery"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-MappingSqlQuery"></a>13.6.2&nbsp;MappingSqlQuery</h3></div></div></div>

<p><code class="literal">MappingSqlQuery</code> is a reusable query in which concrete subclasses must implement the
abstract <code class="literal">mapRow(..)</code> method to convert each row of the supplied <code class="literal">ResultSet</code> into an
object of the type specified. The following example shows a custom query that maps the
data from the <code class="literal">t_actor</code> relation to an instance of the <code class="literal">Actor</code> class.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ActorMappingQuery <span class="hl-keyword">extends</span> MappingSqlQuery&lt;Actor&gt; {

    <span class="hl-keyword">public</span> ActorMappingQuery(DataSource ds) {
        <span class="hl-keyword">super</span>(ds, <span class="hl-string">"select id, first_name, last_name from t_actor where id = ?"</span>);
        <span class="hl-keyword">super</span>.declareParameter(<span class="hl-keyword">new</span> SqlParameter(<span class="hl-string">"id"</span>, Types.INTEGER));
        compile();
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> Actor mapRow(ResultSet rs, <span class="hl-keyword">int</span> rowNumber) <span class="hl-keyword">throws</span> SQLException {
        Actor actor = <span class="hl-keyword">new</span> Actor();
        actor.setId(rs.getLong(<span class="hl-string">"id"</span>));
        actor.setFirstName(rs.getString(<span class="hl-string">"first_name"</span>));
        actor.setLastName(rs.getString(<span class="hl-string">"last_name"</span>));
        <span class="hl-keyword">return</span> actor;
    }

}</pre>

<p>The class extends <code class="literal">MappingSqlQuery</code> parameterized with the <code class="literal">Actor</code> type. The constructor
for this customer query takes the <code class="literal">DataSource</code> as the only parameter. In this
constructor you call the constructor on the superclass with the <code class="literal">DataSource</code> and the SQL
that should be executed to retrieve the rows for this query. This SQL will be used to
create a <code class="literal">PreparedStatement</code> so it may contain place holders for any parameters to be
passed in during execution.You must declare each parameter using the <code class="literal">declareParameter</code>
method passing in an <code class="literal">SqlParameter</code>. The <code class="literal">SqlParameter</code> takes a name and the JDBC type
as defined in <code class="literal">java.sql.Types</code>. After you define all parameters, you call the
<code class="literal">compile()</code> method so the statement can be prepared and later executed. This class is
thread-safe after it is compiled, so as long as these instances are created when the DAO
is initialized they can be kept as instance variables and be reused.</p>
<pre class="programlisting"><span class="hl-keyword">private</span> ActorMappingQuery actorMappingQuery;

<i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
    <span class="hl-keyword">this</span>.actorMappingQuery = <span class="hl-keyword">new</span> ActorMappingQuery(dataSource);
}

<span class="hl-keyword">public</span> Customer getCustomer(Long id) {
    <span class="hl-keyword">return</span> actorMappingQuery.findObject(id);
}</pre>

<p>The method in this example retrieves the customer with the id that is passed in as the
only parameter. Since we only want one object returned we simply call the convenience
method <code class="literal">findObject</code> with the id as parameter. If we had instead a query that returned a
list of objects and took additional parameters then we would use one of the execute
methods that takes an array of parameter values passed in as varargs.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> List&lt;Actor&gt; searchForActors(<span class="hl-keyword">int</span> age, String namePattern) {
    List&lt;Actor&gt; actors = actorSearchMappingQuery.execute(age, namePattern);
    <span class="hl-keyword">return</span> actors;
}</pre>

</div>
<div class="section" title="13.6.3&nbsp;SqlUpdate"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-SqlUpdate"></a>13.6.3&nbsp;SqlUpdate</h3></div></div></div>

<p>The <code class="literal">SqlUpdate</code> class encapsulates an SQL update. Like a query, an update object is
reusable, and like all <code class="literal">RdbmsOperation</code> classes, an update can have parameters and is
defined in SQL. This class provides a number of <code class="literal">update(..)</code> methods analogous to the
<code class="literal">execute(..)</code> methods of query objects. The <code class="literal">SQLUpdate</code> class is concrete. It can be
subclassed, for example, to add a custom update method, as in the following snippet
where it&#8217;s simply called <code class="literal">execute</code>. However, you don&#8217;t have to subclass the <code class="literal">SqlUpdate</code>
class since it can easily be parameterized by setting SQL and declaring parameters.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> java.sql.Types;

<span class="hl-keyword">import</span> javax.sql.DataSource;

<span class="hl-keyword">import</span> org.springframework.jdbc.core.SqlParameter;
<span class="hl-keyword">import</span> org.springframework.jdbc.object.SqlUpdate;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UpdateCreditRating <span class="hl-keyword">extends</span> SqlUpdate {

    <span class="hl-keyword">public</span> UpdateCreditRating(DataSource ds) {
        setDataSource(ds);
        setSql(<span class="hl-string">"update customer set credit_rating = ? where id = ?"</span>);
        declareParameter(<span class="hl-keyword">new</span> SqlParameter(<span class="hl-string">"creditRating"</span>, Types.NUMERIC));
        declareParameter(<span class="hl-keyword">new</span> SqlParameter(<span class="hl-string">"id"</span>, Types.NUMERIC));
        compile();
    }

    <b class="hl-tag" style="color: blue">/**
     * @param id for the Customer to be updated
     * @param rating the new value for credit rating
     * @return number of rows updated
     */</b>
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> execute(<span class="hl-keyword">int</span> id, <span class="hl-keyword">int</span> rating) {
        <span class="hl-keyword">return</span> update(rating, id);
    }
}</pre>

</div>
<div class="section" title="13.6.4&nbsp;StoredProcedure"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-StoredProcedure"></a>13.6.4&nbsp;StoredProcedure</h3></div></div></div>

<p>The <code class="literal">StoredProcedure</code> class is a superclass for object abstractions of RDBMS stored
procedures. This class is <code class="literal">abstract</code>, and its various <code class="literal">execute(..)</code> methods have
<code class="literal">protected</code> access, preventing use other than through a subclass that offers tighter
typing.</p>
<p>The inherited <code class="literal">sql</code> property will be the name of the stored procedure in the RDBMS.</p>
<p>To define a parameter for the <code class="literal">StoredProcedure</code> class, you use an <code class="literal">SqlParameter</code> or one
of its subclasses. You must specify the parameter name and SQL type in the constructor
like in the following code snippet. The SQL type is specified using the <code class="literal">java.sql.Types</code>
constants.</p>
<pre class="programlisting"><span class="hl-keyword">new</span> SqlParameter(<span class="hl-string">"in_id"</span>, Types.NUMERIC),
    <span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"out_first_name"</span>, Types.VARCHAR),</pre>

<p>The first line with the <code class="literal">SqlParameter</code> declares an IN parameter. IN parameters can be
used for both stored procedure calls and for queries using the <code class="literal">SqlQuery</code> and its
subclasses covered in the following section.</p>
<p>The second line with the <code class="literal">SqlOutParameter</code> declares an <code class="literal">out</code> parameter to be used in the
stored procedure call. There is also an <code class="literal">SqlInOutParameter</code> for <code class="literal">I</code> <code class="literal">nOut</code> parameters,
parameters that provide an <code class="literal">in</code> value to the procedure and that also return a value.</p>
<p>For <code class="literal">i</code> <code class="literal">n</code> parameters, in addition to the name and the SQL type, you can specify a
scale for numeric data or a type name for custom database types. For <code class="literal">out</code> parameters
you can provide a <code class="literal">RowMapper</code> to handle mapping of rows returned from a REF cursor.
Another option is to specify an <code class="literal">SqlReturnType</code> that enables you to define customized
handling of the return values.</p>
<p>Here is an example of a simple DAO that uses a <code class="literal">StoredProcedure</code> to call a function,
<code class="literal">sysdate()</code>,which comes with any Oracle database. To use the stored procedure
functionality you have to create a class that extends <code class="literal">StoredProcedure</code>. In this
example, the <code class="literal">StoredProcedure</code> class is an inner class, but if you need to reuse the
<code class="literal">StoredProcedure</code> you declare it as a top-level class. This example has no input
parameters, but an output parameter is declared as a date type using the class
<code class="literal">SqlOutParameter</code>. The <code class="literal">execute()</code> method executes the procedure and extracts the
returned date from the results <code class="literal">Map</code>. The results <code class="literal">Map</code> has an entry for each declared
output parameter, in this case only one, using the parameter name as the key.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> java.sql.Types;
<span class="hl-keyword">import</span> java.util.Date;
<span class="hl-keyword">import</span> java.util.HashMap;
<span class="hl-keyword">import</span> java.util.Map;

<span class="hl-keyword">import</span> javax.sql.DataSource;

<span class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hl-keyword">import</span> org.springframework.jdbc.core.SqlOutParameter;
<span class="hl-keyword">import</span> org.springframework.jdbc.object.StoredProcedure;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> StoredProcedureDao {

    <span class="hl-keyword">private</span> GetSysdateProcedure getSysdate;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init(DataSource dataSource) {
        <span class="hl-keyword">this</span>.getSysdate = <span class="hl-keyword">new</span> GetSysdateProcedure(dataSource);
    }

    <span class="hl-keyword">public</span> Date getSysdate() {
        <span class="hl-keyword">return</span> getSysdate.execute();
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">class</span> GetSysdateProcedure <span class="hl-keyword">extends</span> StoredProcedure {

        <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String SQL = <span class="hl-string">"sysdate"</span>;

        <span class="hl-keyword">public</span> GetSysdateProcedure(DataSource dataSource) {
            setDataSource(dataSource);
            setFunction(true);
            setSql(SQL);
            declareParameter(<span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"date"</span>, Types.DATE));
            compile();
        }

        <span class="hl-keyword">public</span> Date execute() {
            <span class="hl-comment">// the </span><span class="emphasis"><em>sysdate</em></span> sproc has no input parameters, so an empty Map is supplied...
            Map&lt;String, Object&gt; results = execute(<span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;());
            Date sysdate = (Date) results.get(<span class="hl-string">"date"</span>);
            <span class="hl-keyword">return</span> sysdate;
        }
    }

}</pre>

<p>The following example of a <code class="literal">StoredProcedure</code> has two output parameters (in this case,
Oracle REF cursors).</p>
<pre class="programlisting"><span class="hl-keyword">import</span> oracle.jdbc.OracleTypes;
<span class="hl-keyword">import</span> org.springframework.jdbc.core.SqlOutParameter;
<span class="hl-keyword">import</span> org.springframework.jdbc.object.StoredProcedure;

<span class="hl-keyword">import</span> javax.sql.DataSource;
<span class="hl-keyword">import</span> java.util.HashMap;
<span class="hl-keyword">import</span> java.util.Map;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TitlesAndGenresStoredProcedure <span class="hl-keyword">extends</span> StoredProcedure {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String SPROC_NAME = <span class="hl-string">"AllTitlesAndGenres"</span>;

    <span class="hl-keyword">public</span> TitlesAndGenresStoredProcedure(DataSource dataSource) {
        <span class="hl-keyword">super</span>(dataSource, SPROC_NAME);
        declareParameter(<span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"titles"</span>, OracleTypes.CURSOR, <span class="hl-keyword">new</span> TitleMapper()));
        declareParameter(<span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"genres"</span>, OracleTypes.CURSOR, <span class="hl-keyword">new</span> GenreMapper()));
        compile();
    }

    <span class="hl-keyword">public</span> Map&lt;String, Object&gt; execute() {
        <span class="hl-comment">// again, this sproc has no input parameters, so an empty Map is supplied</span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.execute(<span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;());
    }
}</pre>

<p>Notice how the overloaded variants of the <code class="literal">declareParameter(..)</code> method that have been
used in the <code class="literal">TitlesAndGenresStoredProcedure</code> constructor are passed <code class="literal">RowMapper</code>
implementation instances; this is a very convenient and powerful way to reuse existing
functionality. The code for the two <code class="literal">RowMapper</code> implementations is provided below.</p>
<p>The <code class="literal">TitleMapper</code> class maps a <code class="literal">ResultSet</code> to a <code class="literal">Title</code> domain object for each row in
the supplied <code class="literal">ResultSet</code>:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.jdbc.core.RowMapper;

<span class="hl-keyword">import</span> java.sql.ResultSet;
<span class="hl-keyword">import</span> java.sql.SQLException;

<span class="hl-keyword">import</span> com.foo.domain.Title;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> TitleMapper <span class="hl-keyword">implements</span> RowMapper&lt;Title&gt; {

    <span class="hl-keyword">public</span> Title mapRow(ResultSet rs, <span class="hl-keyword">int</span> rowNum) <span class="hl-keyword">throws</span> SQLException {
        Title title = <span class="hl-keyword">new</span> Title();
        title.setId(rs.getLong(<span class="hl-string">"id"</span>));
        title.setName(rs.getString(<span class="hl-string">"name"</span>));
        <span class="hl-keyword">return</span> title;
    }
}</pre>

<p>The <code class="literal">GenreMapper</code> class maps a <code class="literal">ResultSet</code> to a <code class="literal">Genre</code> domain object for each row in
the supplied <code class="literal">ResultSet</code>.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.jdbc.core.RowMapper;

<span class="hl-keyword">import</span> java.sql.ResultSet;
<span class="hl-keyword">import</span> java.sql.SQLException;

<span class="hl-keyword">import</span> com.foo.domain.Genre;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> GenreMapper <span class="hl-keyword">implements</span> RowMapper&lt;Genre&gt; {

    <span class="hl-keyword">public</span> Genre mapRow(ResultSet rs, <span class="hl-keyword">int</span> rowNum) <span class="hl-keyword">throws</span> SQLException {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Genre(rs.getString(<span class="hl-string">"name"</span>));
    }
}</pre>

<p>To pass parameters to a stored procedure that has one or more input parameters in its
definition in the RDBMS, you can code a strongly typed <code class="literal">execute(..)</code> method that would
delegate to the superclass' untyped <code class="literal">execute(Map parameters)</code> method (which has
<code class="literal">protected</code> access); for example:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> oracle.jdbc.OracleTypes;
<span class="hl-keyword">import</span> org.springframework.jdbc.core.SqlOutParameter;
<span class="hl-keyword">import</span> org.springframework.jdbc.core.SqlParameter;
<span class="hl-keyword">import</span> org.springframework.jdbc.object.StoredProcedure;

<span class="hl-keyword">import</span> javax.sql.DataSource;

<span class="hl-keyword">import</span> java.sql.Types;
<span class="hl-keyword">import</span> java.util.Date;
<span class="hl-keyword">import</span> java.util.HashMap;
<span class="hl-keyword">import</span> java.util.Map;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TitlesAfterDateStoredProcedure <span class="hl-keyword">extends</span> StoredProcedure {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String SPROC_NAME = <span class="hl-string">"TitlesAfterDate"</span>;
    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String CUTOFF_DATE_PARAM = <span class="hl-string">"cutoffDate"</span>;

    <span class="hl-keyword">public</span> TitlesAfterDateStoredProcedure(DataSource dataSource) {
        <span class="hl-keyword">super</span>(dataSource, SPROC_NAME);
        declareParameter(<span class="hl-keyword">new</span> SqlParameter(CUTOFF_DATE_PARAM, Types.DATE);
        declareParameter(<span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"titles"</span>, OracleTypes.CURSOR, <span class="hl-keyword">new</span> TitleMapper()));
        compile();
    }

    <span class="hl-keyword">public</span> Map&lt;String, Object&gt; execute(Date cutoffDate) {
        Map&lt;String, Object&gt; inputs = <span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;();
        inputs.put(CUTOFF_DATE_PARAM, cutoffDate);
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.execute(inputs);
    }
}</pre>

</div>
</div>
<div class="section" title="13.7&nbsp;Common problems with parameter and data value handling"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-parameter-handling"></a>13.7&nbsp;Common problems with parameter and data value handling</h2></div></div></div>

<p>Common problems with parameters and data values exist in the different approaches
provided by the Spring Framework JDBC.</p>
<div class="section" title="13.7.1&nbsp;Providing SQL type information for parameters"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-type-information"></a>13.7.1&nbsp;Providing SQL type information for parameters</h3></div></div></div>

<p>Usually Spring determines the SQL type of the parameters based on the type of parameter
passed in. It is possible to explicitly provide the SQL type to be used when setting
parameter values. This is sometimes necessary to correctly set NULL values.</p>
<p>You can provide SQL type information in several ways:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Many update and query methods of the <code class="literal">JdbcTemplate</code> take an additional parameter in
the form of an <code class="literal">int</code> array. This array is used to indicate the SQL type of the
corresponding parameter using constant values from the <code class="literal">java.sql.Types</code> class. Provide
one entry for each parameter.
</li><li class="listitem">
You can use the <code class="literal">SqlParameterValue</code> class to wrap the parameter value that needs this
additional information.Create a new instance for each value and pass in the SQL type
and parameter value in the constructor. You can also provide an optional scale
parameter for numeric values.
</li><li class="listitem">
For methods working with named parameters, use the <code class="literal">SqlParameterSource</code> classes
<code class="literal">BeanPropertySqlParameterSource</code> or <code class="literal">MapSqlParameterSource</code>. They both have methods
for registering the SQL type for any of the named parameter values.
</li></ul></div>

</div>
<div class="section" title="13.7.2&nbsp;Handling BLOB and CLOB objects"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-lob"></a>13.7.2&nbsp;Handling BLOB and CLOB objects</h3></div></div></div>

<p>You can store images, other binary objects, and large chunks of text. These large object
are called BLOB for binary data and CLOB for character data. In Spring you can handle
these large objects by using the JdbcTemplate directly and also when using the higher
abstractions provided by RDBMS Objects and the <code class="literal">SimpleJdbc</code> classes. All of these
approaches use an implementation of the <code class="literal">LobHandler</code> interface for the actual management
of the LOB data. The <code class="literal">LobHandler</code> provides access to a <code class="literal">LobCreator</code> class, through the
<code class="literal">getLobCreator</code> method, used for creating new LOB objects to be inserted.</p>
<p>The <code class="literal">LobCreator/LobHandler</code> provides the following support for LOB input and output:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
BLOB
</li><li class="listitem">
byte[]&#8201;&#8212;&#8201;getBlobAsBytes and setBlobAsBytes
</li><li class="listitem">
InputStream&#8201;&#8212;&#8201;getBlobAsBinaryStream and setBlobAsBinaryStream
</li><li class="listitem">
CLOB
</li><li class="listitem">
String&#8201;&#8212;&#8201;getClobAsString and setClobAsString
</li><li class="listitem">
InputStream&#8201;&#8212;&#8201;getClobAsAsciiStream and setClobAsAsciiStream
</li><li class="listitem">
Reader&#8201;&#8212;&#8201;getClobAsCharacterStream and setClobAsCharacterStream
</li></ul></div>

<p>The next example shows how to create and insert a BLOB. Later you will see how to read
it back from the database.</p>
<p>This example uses a <code class="literal">JdbcTemplate</code> and an implementation of the
<code class="literal">AbstractLobCreatingPreparedStatementCallbac</code> <code class="literal">k</code>. It implements one method,
<code class="literal">setValues</code>. This method provides a <code class="literal">LobCreator</code> that you use to set the values for the
LOB columns in your SQL insert statement.</p>
<p>For this example we assume that there is a variable, <code class="literal">lobHandle</code> <code class="literal">r</code>, that already is
set to an instance of a <code class="literal">DefaultLobHandler</code>. You typically set this value through
dependency injection.</p>
<pre class="programlisting"><span class="hl-keyword">final</span> File blobIn = <span class="hl-keyword">new</span> File(<span class="hl-string">"spring2004.jpg"</span>);
<span class="hl-keyword">final</span> InputStream blobIs = <span class="hl-keyword">new</span> FileInputStream(blobIn);
<span class="hl-keyword">final</span> File clobIn = <span class="hl-keyword">new</span> File(<span class="hl-string">"large.txt"</span>);
<span class="hl-keyword">final</span> InputStream clobIs = <span class="hl-keyword">new</span> FileInputStream(clobIn);
<span class="hl-keyword">final</span> InputStreamReader clobReader = <span class="hl-keyword">new</span> InputStreamReader(clobIs);
jdbcTemplate.execute(
    <span class="hl-string">"INSERT INTO lob_table (id, a_clob, a_blob) VALUES (?, ?, ?)"</span>,
    <span class="hl-keyword">new</span> AbstractLobCreatingPreparedStatementCallback(lobHandler) { &lt;&lt;<span class="hl-number">1</span>&gt;&gt;
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> setValues(PreparedStatement ps, LobCreator lobCreator) <span class="hl-keyword">throws</span> SQLException { ps.setLong(<span class="hl-number">1</span>, <span class="hl-number">1L</span>); lobCreator.setClobAsCharacterStream(ps, <span class="hl-number">2</span>, clobReader, (<span class="hl-keyword">int</span>)clobIn.length()); &lt;&lt;<span class="hl-number">2</span>&gt;&gt;
lobCreator.setBlobAsBinaryStream(ps, <span class="hl-number">3</span>, blobIs, (<span class="hl-keyword">int</span>)blobIn.length()); &lt;&lt;<span class="hl-number">3</span>&gt;&gt;
} }
);
blobIs.close();
clobReader.close();</pre>

<p><a class="xref" href="#">???</a>
Pass in the lobHandler that in this example is a plain <code class="literal">DefaultLobHandler</code></p>
<p><a class="xref" href="#">???</a>
Using the method <code class="literal">setClobAsCharacterStream</code>, pass in the contents of the CLOB.</p>
<p><a class="xref" href="#">???</a>
Using the method <code class="literal">setBlobAsBinaryStream</code>, pass in the contents of the BLOB.</p>
<p>Now it&#8217;s time to read the LOB data from the database. Again, you use a <code class="literal">JdbcTemplate</code>
with the same instance variable <code class="literal">l</code> <code class="literal">obHandler</code> and a reference to a <code class="literal">DefaultLobHandler</code>.</p>
<pre class="programlisting">List&lt;Map&lt;String, Object&gt;&gt; l = jdbcTemplate.query(<span class="hl-string">"select id, a_clob, a_blob from lob_table"</span>,
    <span class="hl-keyword">new</span> RowMapper&lt;Map&lt;String, Object&gt;&gt;() {
        <span class="hl-keyword">public</span> Map&lt;String, Object&gt; mapRow(ResultSet rs, <span class="hl-keyword">int</span> i) <span class="hl-keyword">throws</span> SQLException {
            Map&lt;String, Object&gt; results = <span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;();
            String clobText = lobHandler.getClobAsString(rs, <span class="hl-string">"a_clob"</span>); &lt;&lt;<span class="hl-number">1</span>&gt;&gt;
results.put(<span class="hl-string">"CLOB"</span>, clobText); <span class="hl-keyword">byte</span>[] blobBytes = lobHandler.getBlobAsBytes(rs, <span class="hl-string">"a_blob"</span>); &lt;&lt;<span class="hl-number">2</span>&gt;&gt;
results.put(<span class="hl-string">"BLOB"</span>, blobBytes); <span class="hl-keyword">return</span> results; } });</pre>

<p><a class="xref" href="#">???</a>
Using the method <code class="literal">getClobAsString</code>, retrieve the contents of the CLOB.</p>
<p><a class="xref" href="#">???</a>
Using the method <code class="literal">getBlobAsBytes</code>, retrieve the contents of the BLOB.</p>
</div>
<div class="section" title="13.7.3&nbsp;Passing in lists of values for IN clause"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-in-clause"></a>13.7.3&nbsp;Passing in lists of values for IN clause</h3></div></div></div>

<p>The SQL standard allows for selecting rows based on an expression that includes a
variable list of values. A typical example would be <code class="literal">select * from T_ACTOR where id in
(1, 2, 3)</code>. This variable list is not directly supported for prepared statements by the
JDBC standard; you cannot declare a variable number of placeholders. You need a number
of variations with the desired number of placeholders prepared, or you need to generate
the SQL string dynamically once you know how many placeholders are required. The named
parameter support provided in the <code class="literal">NamedParameterJdbcTemplate</code> and <code class="literal">JdbcTemplate</code> takes
the latter approach. Pass in the values as a <code class="literal">java.util.List</code> of primitive objects. This
list will be used to insert the required placeholders and pass in the values during the
statement execution.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Be careful when passing in many values. The JDBC standard does not guarantee that you
can use more than 100 values for an <code class="literal">in</code> expression list. Various databases exceed this
number, but they usually have a hard limit for how many values are allowed. Oracle&#8217;s
limit is 1000.</p>
</td></tr></table></div>

<p>In addition to the primitive values in the value list, you can create a <code class="literal">java.util.List</code>
of object arrays. This list would support multiple expressions defined for the <code class="literal">in</code>
clause such as <code class="literal">select * from T_ACTOR where (id, last_name) in ((1, 'Johnson'), (2,
'Harrop'))</code>. This of course requires that your database supports this syntax.</p>
</div>
<div class="section" title="13.7.4&nbsp;Handling complex types for stored procedure calls"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-complex-types"></a>13.7.4&nbsp;Handling complex types for stored procedure calls</h3></div></div></div>

<p>When you call stored procedures you can sometimes use complex types specific to the
database. To accommodate these types, Spring provides a <code class="literal">SqlReturnType</code> for handling
them when they are returned from the stored procedure call and <code class="literal">SqlTypeValue</code> when they
are passed in as a parameter to the stored procedure.</p>
<p>Here is an example of returning the value of an Oracle <code class="literal">STRUCT</code> object of the user
declared type <code class="literal">ITEM_TYPE</code>. The <code class="literal">SqlReturnType</code> interface has a single method named
<code class="literal">getTypeValue</code> that must be implemented. This interface is used as part of the
declaration of an <code class="literal">SqlOutParameter</code>.</p>
<pre class="programlisting"><span class="hl-keyword">final</span> TestItem = <span class="hl-keyword">new</span> TestItem(<span class="hl-number">123L</span>, <span class="hl-string">"A test item"</span>,
        <span class="hl-keyword">new</span> SimpleDateFormat(<span class="hl-string">"yyyy-M-d"</span>).parse(<span class="hl-string">"2010-12-31"</span>));

declareParameter(<span class="hl-keyword">new</span> SqlOutParameter(<span class="hl-string">"item"</span>, OracleTypes.STRUCT, <span class="hl-string">"ITEM_TYPE"</span>,
    <span class="hl-keyword">new</span> SqlReturnType() {
        <span class="hl-keyword">public</span> Object getTypeValue(CallableStatement cs, <span class="hl-keyword">int</span> colIndx, <span class="hl-keyword">int</span> sqlType, String typeName) <span class="hl-keyword">throws</span> SQLException {
            STRUCT struct = (STRUCT) cs.getObject(colIndx);
            Object[] attr = struct.getAttributes();
            TestItem item = <span class="hl-keyword">new</span> TestItem();
            item.setId(((Number) attr[<span class="hl-number">0</span>]).longValue());
            item.setDescription((String) attr[<span class="hl-number">1</span>]);
            item.setExpirationDate((java.util.Date) attr[<span class="hl-number">2</span>]);
            <span class="hl-keyword">return</span> item;
        }
    }));</pre>

<p>You use the <code class="literal">SqlTypeValue</code> to pass in the value of a Java object like <code class="literal">TestItem</code> into a
stored procedure. The <code class="literal">SqlTypeValue</code> interface has a single method named
<code class="literal">createTypeValue</code> that you must implement. The active connection is passed in, and you
can use it to create database-specific objects such as <code class="literal">StructDescriptor</code> s, as shown in
the following example, or <code class="literal">ArrayDescriptor</code> s.</p>
<pre class="programlisting"><span class="hl-keyword">final</span> TestItem = <span class="hl-keyword">new</span> TestItem(<span class="hl-number">123L</span>, <span class="hl-string">"A test item"</span>,
        <span class="hl-keyword">new</span> SimpleDateFormat(<span class="hl-string">"yyyy-M-d"</span>).parse(<span class="hl-string">"2010-12-31"</span>));

SqlTypeValue value = <span class="hl-keyword">new</span> AbstractSqlTypeValue() {
    <span class="hl-keyword">protected</span> Object createTypeValue(Connection conn, <span class="hl-keyword">int</span> sqlType, String typeName) <span class="hl-keyword">throws</span> SQLException {
        StructDescriptor itemDescriptor = <span class="hl-keyword">new</span> StructDescriptor(typeName, conn);
        Struct item = <span class="hl-keyword">new</span> STRUCT(itemDescriptor, conn,
        <span class="hl-keyword">new</span> Object[] {
            testItem.getId(),
            testItem.getDescription(),
            <span class="hl-keyword">new</span> java.sql.Date(testItem.getExpirationDate().getTime())
        });
        <span class="hl-keyword">return</span> item;
    }
};</pre>

<p>This <code class="literal">SqlTypeValue</code> can now be added to the Map containing the input parameters for the
execute call of the stored procedure.</p>
<p>Another use for the <code class="literal">SqlTypeValue</code> is passing in an array of values to an Oracle stored
procedure. Oracle has its own internal <code class="literal">ARRAY</code> class that must be used in this case, and
you can use the <code class="literal">SqlTypeValue</code> to create an instance of the Oracle <code class="literal">ARRAY</code> and populate
it with values from the Java <code class="literal">ARRAY</code>.</p>
<pre class="programlisting"><span class="hl-keyword">final</span> Long[] ids = <span class="hl-keyword">new</span> Long[] {<span class="hl-number">1L</span>, <span class="hl-number">2L</span>};

SqlTypeValue value = <span class="hl-keyword">new</span> AbstractSqlTypeValue() {
    <span class="hl-keyword">protected</span> Object createTypeValue(Connection conn, <span class="hl-keyword">int</span> sqlType, String typeName) <span class="hl-keyword">throws</span> SQLException {
        ArrayDescriptor arrayDescriptor = <span class="hl-keyword">new</span> ArrayDescriptor(typeName, conn);
        ARRAY idArray = <span class="hl-keyword">new</span> ARRAY(arrayDescriptor, conn, ids);
        <span class="hl-keyword">return</span> idArray;
    }
};</pre>

</div>
</div>
<div class="section" title="13.8&nbsp;Embedded database support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-embedded-database-support"></a>13.8&nbsp;Embedded database support</h2></div></div></div>

<p>The <code class="literal">org.springframework.jdbc.datasource.embedded</code> package provides support for embedded
Java database engines. Support for <a class="ulink" href="http://www.hsqldb.org" target="_top">HSQL</a>,
<a class="ulink" href="http://www.h2database.com" target="_top">H2</a>, and <a class="ulink" href="http://db.apache.org/derby" target="_top">Derby</a> is provided
natively. You can also use an extensible API to plug in new embedded database types and
<code class="literal">DataSource</code> implementations.</p>
<div class="section" title="13.8.1&nbsp;Why use an embedded database?"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-why-embedded-database"></a>13.8.1&nbsp;Why use an embedded database?</h3></div></div></div>

<p>An embedded database is useful during the development phase of a project because of its
lightweight nature. Benefits include ease of configuration, quick startup time,
testability, and the ability to rapidly evolve SQL during development.</p>
</div>
<div class="section" title="13.8.2&nbsp;Creating an embedded database instance using Spring XML"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-embedded-database-xml"></a>13.8.2&nbsp;Creating an embedded database instance using Spring XML</h3></div></div></div>

<p>If you want to expose an embedded database instance as a bean in a Spring
ApplicationContext, use the embedded-database tag in the spring-jdbc namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jdbc:embedded-database</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;jdbc:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:schema.sql"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;jdbc:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:test-data.sql"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/jdbc:embedded-database&gt;</span></pre>

<p>The preceding configuration creates an embedded HSQL database populated with SQL from
schema.sql and testdata.sql resources in the classpath. The database instance is made
available to the Spring container as a bean of type <code class="literal">javax.sql.DataSource</code>. This bean
can then be injected into data access objects as needed.</p>
</div>
<div class="section" title="13.8.3&nbsp;Creating an embedded database instance programmatically"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-embedded-database-java"></a>13.8.3&nbsp;Creating an embedded database instance programmatically</h3></div></div></div>

<p>The <code class="literal">EmbeddedDatabaseBuilder</code> class provides a fluent API for constructing an embedded
database programmatically. Use this when you need to create an embedded database
instance in a standalone environment, such as a data access object unit test:</p>
<pre class="programlisting">EmbeddedDatabaseBuilder builder = <span class="hl-keyword">new</span> EmbeddedDatabaseBuilder();
EmbeddedDatabase db = builder.setType(H2).addScript(<span class="hl-string">"my-schema.sql"</span>).addScript(<span class="hl-string">"my-test-data.sql"</span>).build();
<span class="hl-comment">// do stuff against the db (EmbeddedDatabase extends javax.sql.DataSource)</span>
db.shutdown()</pre>

</div>
<div class="section" title="13.8.4&nbsp;Extending the embedded database support"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-embedded-database-extension"></a>13.8.4&nbsp;Extending the embedded database support</h3></div></div></div>

<p>Spring JDBC embedded database support can be extended in two ways:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Implement <code class="literal">EmbeddedDatabaseConfigurer</code> to support a new embedded database type, such
as Apache Derby.
</li><li class="listitem">
Implement <code class="literal">DataSourceFactory</code> to support a new DataSource implementation, such as a
connection pool, to manage embedded database connections.
</li></ul></div>

<p>You are encouraged to contribute back extensions to the Spring community at
jira.springframework.org[jira.springframework.org].</p>
</div>
<div class="section" title="13.8.5&nbsp;Using HSQL"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-embedded-database-using-HSQL"></a>13.8.5&nbsp;Using HSQL</h3></div></div></div>

<p>Spring supports HSQL 1.8.0 and above. HSQL is the default embedded database if no type
is specified explicitly. To specify HSQL explicitly, set the <code class="literal">type</code> attribute of the
<code class="literal">embedded-database</code> tag to <code class="literal">HSQL</code>. If you are using the builder API, call the
<code class="literal">setType(EmbeddedDatabaseType)</code> method with <code class="literal">EmbeddedDatabaseType.HSQL</code>.</p>
</div>
<div class="section" title="13.8.6&nbsp;Using H2"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-embedded-database-using-H2"></a>13.8.6&nbsp;Using H2</h3></div></div></div>

<p>Spring supports the H2 database as well. To enable H2, set the <code class="literal">type</code> attribute of the
<code class="literal">embedded-database</code> tag to <code class="literal">H2</code>. If you are using the builder API, call the
<code class="literal">setType(EmbeddedDatabaseType)</code> method with <code class="literal">EmbeddedDatabaseType.H2</code>.</p>
</div>
<div class="section" title="13.8.7&nbsp;Using Derby"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-embedded-database-using-Derby"></a>13.8.7&nbsp;Using Derby</h3></div></div></div>

<p>Spring also supports Apache Derby 10.5 and above. To enable Derby, set the <code class="literal">type</code>
attribute of the <code class="literal">embedded-database</code> tag to <code class="literal">Derby</code>. If using the builder API, call the
<code class="literal">setType(EmbeddedDatabaseType)</code> method with <code class="literal">EmbeddedDatabaseType.Derby</code>.</p>
</div>
<div class="section" title="13.8.8&nbsp;Testing data access logic with an embedded database"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-embedded-database-dao-testing"></a>13.8.8&nbsp;Testing data access logic with an embedded database</h3></div></div></div>

<p>Embedded databases provide a lightweight way to test data access code. The following is
a data access unit test template that uses an embedded database:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DataAccessUnitTestTemplate {

    <span class="hl-keyword">private</span> EmbeddedDatabase db;

    <i><span class="hl-annotation" style="color: gray">@Before</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setUp() {
        <span class="hl-comment">// creates an HSQL in-memory database populated from default scripts</span>
        <span class="hl-comment">// classpath:schema.sql and classpath:data.sql</span>
        db = <span class="hl-keyword">new</span> EmbeddedDatabaseBuilder().addDefaultScripts().build();
    }

    <i><span class="hl-annotation" style="color: gray">@Test</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testDataAccess() {
        JdbcTemplate template = <span class="hl-keyword">new</span> JdbcTemplate(db);
        template.query(...);
    }

    <i><span class="hl-annotation" style="color: gray">@After</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> tearDown() {
        db.shutdown();
    }

}</pre>

</div>
</div>
<div class="section" title="13.9&nbsp;Initializing a DataSource"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-intializing-datasource"></a>13.9&nbsp;Initializing a DataSource</h2></div></div></div>

<p>The <code class="literal">org.springframework.jdbc.datasource.init</code> package provides support for initializing
an existing <code class="literal">DataSource</code>. The embedded database support provides one option for creating
and initializing a <code class="literal">DataSource</code> for an application, but sometimes you need to initialize
an instance running on a server somewhere.</p>
<div class="section" title="13.9.1&nbsp;Initializing a database instance using Spring XML"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-initializing-datasource-xml"></a>13.9.1&nbsp;Initializing a database instance using Spring XML</h3></div></div></div>

<p>If you want to initialize a database and you can provide a reference to a DataSource
bean, use the <code class="literal">initialize-database</code> tag in the <code class="literal">spring-jdbc</code> namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jdbc:initialize-database</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;jdbc:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/foo/sql/db-schema.sql"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;jdbc:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/foo/sql/db-test-data.sql"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/jdbc:initialize-database&gt;</span></pre>

<p>The example above runs the two scripts specified against the database: the first script
is a schema creation, and the second is a test data set insert. The script locations can
also be patterns with wildcards in the usual ant style used for resources in Spring
(e.g. <code class="literal">classpath*:/com/foo/**/sql/*-data.sql</code>). If a pattern is used the scripts are
executed in lexical order of their URL or filename.</p>
<p>The default behavior of the database initializer is to unconditionally execute the
scripts provided. This will not always be what you want, for instance if running against
an existing database that already has test data in it. The likelihood of accidentally
deleting data is reduced by the commonest pattern (as shown above) that creates the
tables first and then inserts the data - the first step will fail if the tables already
exist.</p>
<p>However, to get more control over the creation and deletion of existing data, the XML
namespace provides a couple more options. The first is flag to switch the initialization
on and off. This can be set according to the environment (e.g. to pull a boolean value
from system properties or an environment bean), e.g.</p>
<pre class="programlisting"><span class="hl-tag">&lt;jdbc:initialize-database</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="strong"><strong>enabled="#{systemProperties.INITIALIZE_DATABASE}"</strong></span>&gt;
    <span class="hl-tag">&lt;jdbc:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"..."</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/jdbc:initialize-database&gt;</span></pre>

<p>The second option to control what happens with existing data is to be more tolerant of
failures. To this end you can control the ability of the initializer to ignore certain
errors in the SQL it executes from the scripts, e.g.</p>
<pre class="programlisting"><span class="hl-tag">&lt;jdbc:initialize-database</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span> <span class="strong"><strong>ignore-failures="DROPS"</strong></span>&gt;
    <span class="hl-tag">&lt;jdbc:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"..."</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/jdbc:initialize-database&gt;</span></pre>

<p>In this example we are saying we expect that sometimes the scripts will be run against
an empty database and there are some DROP statements in the scripts which would
therefore fail. So failed SQL <code class="literal">DROP</code> statements will be ignored, but other failures will
cause an exception. This is useful if your SQL dialect doesn&#8217;t support <code class="literal">DROP ... IF
EXISTS</code> (or similar) but you want to unconditionally remove all test data before
re-creating it. In that case the first script is usually a set of drops, followed by a
set of <code class="literal">CREATE</code> statements.</p>
<p>The <code class="literal">ignore-failures</code> option can be set to <code class="literal">NONE</code> (the default), <code class="literal">DROPS</code> (ignore failed
drops) or <code class="literal">ALL</code> (ignore all failures).</p>
<p>If you need more control than you get from the XML namespace, you can simply use the
<code class="literal">DataSourceInitializer</code> directly, and define it as a component in your application.</p>
<div class="section" title="Initialization of Other Components that Depend on the Database"><div class="titlepage"><div><div><h4 class="title"><a name="jdbc-client-component-initialization"></a>Initialization of Other Components that Depend on the Database</h4></div></div></div>

<p>A large class of applications can just use the database initializer with no further
complications: those that do not use the database until after the Spring context has
started. If your application is <span class="emphasis"><em>not</em></span> one of those then you might need to read the
rest of this section.</p>
<p>The database initializer depends on a data source instance and runs the scripts provided
in its initialization callback (c.f. <code class="literal">init-method</code> in an XML bean definition or
<code class="literal">InitializingBean</code>). If other beans depend on the same data source and also use the data
source in an initialization callback then there might be a problem because the data has
not yet been initialized. A common example of this is a cache that initializes eagerly
and loads up data from the database on application startup.</p>
<p>To get round this issue you two options: change your cache initialization strategy to a
later phase, or ensure that the database initializer is initialized first.</p>
<p>The first option might be easy if the application is in your control, and not otherwise.
Some suggestions for how to implement this are</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Make the cache initialize lazily on first usage, which improves application startup time
</li><li class="listitem">
Have your cache or a separate component that initializes the cache implement
<code class="literal">Lifecycle</code> or <code class="literal">SmartLifecycle</code>. When the application context starts up a
<code class="literal">SmartLifecycle</code> can be automatically started if its <code class="literal">autoStartup</code> flag is set, and a
<code class="literal">Lifecycle</code> can be started manually by calling
<code class="literal">ConfigurableApplicationContext.start()</code> on the enclosing context.
</li><li class="listitem">
Use a Spring <code class="literal">ApplicationEvent</code> or similar custom observer mechanism to trigger the
cache initialization. <code class="literal">ContextRefreshedEvent</code> is always published by the context when
it is ready for use (after all beans have been initialized), so that is often a useful
hook (this is how the <code class="literal">SmartLifecycle</code> works by default).
</li></ul></div>

<p>The second option can also be easy. Some suggestions on how to implement this are</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Rely on Spring BeanFactory default behavior, which is that beans are initialized in
registration order. You can easily arrange that by adopting the common practice of a
set of &lt;import/&gt; elements that order your application modules, and ensure that the
database and database initialization are listed first
</li><li class="listitem">
Separate the datasource and the business components that use it and control their
startup order by putting them in separate ApplicationContext instances (e.g. parent
has the datasource and child has the business components). This structure is common in
Spring web applications, but can be more generally applied.
</li><li class="listitem">
Use a modular runtime like SpringSource dm Server and separate the data source and the
components that depend on it. E.g. specify the bundle start up order as datasource &#8594;
initializer &#8594; business components.
</li></ul></div>

</div>
</div>
</div>
</div>
<div class="chapter" title="14.&nbsp;Object Relational Mapping (ORM) Data Access"><div class="titlepage"><div><div><h2 class="title"><a name="orm"></a>14.&nbsp;Object Relational Mapping (ORM) Data Access</h2></div></div></div>

<div class="section" title="14.1&nbsp;Introduction to ORM with Spring"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-introduction"></a>14.1&nbsp;Introduction to ORM with Spring</h2></div></div></div>

<p>The Spring Framework supports integration with Hibernate, Java Persistence API (JPA)
and Java Data Objects (JDO) for resource management, data access object
(DAO) implementations, and transaction strategies. For example, for Hibernate there is
first-class support with several convenient IoC features that address many typical
Hibernate integration issues. You can configure all of the supported features for O/R
(object relational) mapping tools through Dependency Injection. They can participate in
Spring&#8217;s resource and transaction management, and they comply with Spring&#8217;s generic
transaction and DAO exception hierarchies. The recommended integration style is to code
DAOs against plain Hibernate, JPA, and JDO APIs. The older style of using Spring&#8217;s DAO
templates is no longer recommended; however, coverage of this style can be found in the
<a class="xref" href="#classic-spring-orm" title="31.1&nbsp;Classic ORM usage">Section&nbsp;31.1, &#8220;Classic ORM usage&#8221;</a> in the appendices.</p>
<p>Spring adds significant enhancements to the ORM layer of your choice when you create
data access applications. You can leverage as much of the integration support as you
wish, and you should compare this integration effort with the cost and risk of building
a similar infrastructure in-house. You can use much of the ORM support as you would a
library, regardless of technology, because everything is designed as a set of reusable
JavaBeans. ORM in a Spring IoC container facilitates configuration and deployment. Thus
most examples in this section show configuration inside a Spring container.</p>
<p>Benefits of using the Spring Framework to create your ORM DAOs include:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>Easier testing.</em></span> Spring&#8217;s IoC approach makes it easy to swap the implementations
and configuration locations of Hibernate <code class="literal">SessionFactory</code> instances, JDBC <code class="literal">DataSource</code>
instances, transaction managers, and mapped object implementations (if needed). This
in turn makes it much easier to test each piece of persistence-related code in
isolation.
</li><li class="listitem">
<span class="emphasis"><em>Common data access exceptions.</em></span> Spring can wrap exceptions from your ORM tool,
converting them from proprietary (potentially checked) exceptions to a common runtime
DataAccessException hierarchy. This feature allows you to handle most persistence
exceptions, which are non-recoverable, only in the appropriate layers, without
annoying boilerplate catches, throws, and exception declarations. You can still trap
and handle exceptions as necessary. Remember that JDBC exceptions (including
DB-specific dialects) are also converted to the same hierarchy, meaning that you can
perform some operations with JDBC within a consistent programming model.
</li><li class="listitem">
<span class="emphasis"><em>General resource management.</em></span> Spring application contexts can handle the location
and configuration of Hibernate <code class="literal">SessionFactory</code> instances, JPA <code class="literal">EntityManagerFactory</code>
instances, JDBC <code class="literal">DataSource</code> instances, and other related resources. This makes these
values easy to manage and change. Spring offers efficient, easy, and safe handling of
persistence resources. For example, related code that uses Hibernate generally needs to
use the same Hibernate <code class="literal">Session</code> to ensure efficiency and proper transaction handling.
Spring makes it easy to create and bind a <code class="literal">Session</code> to the current thread transparently,
by exposing a current <code class="literal">Session</code> through the Hibernate <code class="literal">SessionFactory</code>. Thus Spring
solves many chronic problems of typical Hibernate usage, for any local or JTA
transaction environment.
</li><li class="listitem">
<span class="emphasis"><em>Integrated transaction management.</em></span> You can wrap your ORM code with a declarative,
aspect-oriented programming (AOP) style method interceptor either through the
<code class="literal">@Transactional</code> annotation or by explicitly configuring the transaction AOP advice in
an XML configuration file. In both cases, transaction semantics and exception handling
(rollback, and so on) are handled for you. As discussed below, in
<a class="link" href="#orm-resource-mngmnt" title="14.2.1&nbsp;Resource and transaction management">Resource and transaction management</a>, you can also swap various
transaction managers, without affecting your ORM-related code. For example, you can
swap between local transactions and JTA, with the same full services (such as
declarative transactions) available in both scenarios. Additionally, JDBC-related code
can fully integrate transactionally with the code you use to do ORM. This is useful
for data access that is not suitable for ORM, such as batch processing and BLOB
streaming, which still need to share common transactions with ORM operations.
</li></ul></div>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>For more comprehensive ORM support, including support for alternative database
technologies such as MongoDB, you might want to check out the
<a class="ulink" href="http://projects.spring.io/spring-data/" target="_top">Spring Data</a> suite of projects. If you are
a JPA user, the <a class="ulink" href="https://spring.io/guides/gs/accessing-data-jpa/" target="_top">Getting Started Accessing
Data with JPA</a> guide from <a class="ulink" href="http://spring.io" target="_top">http://spring.io</a> provides a great introduction.</p>
</td></tr></table></div>

</div>
<div class="section" title="14.2&nbsp;General ORM integration considerations"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-general"></a>14.2&nbsp;General ORM integration considerations</h2></div></div></div>

<p>This section highlights considerations that apply to all ORM technologies. The
<a class="xref" href="#orm-hibernate" title="14.3&nbsp;Hibernate">Section&nbsp;14.3, &#8220;Hibernate&#8221;</a> section provides more details and also show these features and
configurations in a concrete context.</p>
<p>The major goal of Spring&#8217;s ORM integration is clear application layering, with any data
access and transaction technology, and for loose coupling of application objects. No
more business service dependencies on the data access or transaction strategy, no more
hard-coded resource lookups, no more hard-to-replace singletons, no more custom service
registries. One simple and consistent approach to wiring up application objects, keeping
them as reusable and free from container dependencies as possible. All the individual
data access features are usable on their own but integrate nicely with Spring&#8217;s
application context concept, providing XML-based configuration and cross-referencing of
plain JavaBean instances that need not be Spring-aware. In a typical Spring application,
many important objects are JavaBeans: data access templates, data access objects,
transaction managers, business services that use the data access objects and transaction
managers, web view resolvers, web controllers that use the business services,and so on.</p>
<div class="section" title="14.2.1&nbsp;Resource and transaction management"><div class="titlepage"><div><div><h3 class="title"><a name="orm-resource-mngmnt"></a>14.2.1&nbsp;Resource and transaction management</h3></div></div></div>

<p>Typical business applications are cluttered with repetitive resource management code.
Many projects try to invent their own solutions, sometimes sacrificing proper handling
of failures for programming convenience. Spring advocates simple solutions for proper
resource handling, namely IoC through templating in the case of JDBC and applying AOP
interceptors for the ORM technologies.</p>
<p>The infrastructure provides proper resource handling and appropriate conversion of
specific API exceptions to an unchecked infrastructure exception hierarchy. Spring
introduces a DAO exception hierarchy, applicable to any data access strategy. For direct
JDBC, the <code class="literal">JdbcTemplate</code> class mentioned in a previous section provides connection
handling and proper conversion of <code class="literal">SQLException</code> to the <code class="literal">DataAccessException</code> hierarchy,
including translation of database-specific SQL error codes to meaningful exception
classes. For ORM technologies, see the next section for how to get the same exception
translation benefits.</p>
<p>When it comes to transaction management, the <code class="literal">JdbcTemplate</code> class hooks in to the Spring
transaction support and supports both JTA and JDBC transactions, through respective
Spring transaction managers. For the supported ORM technologies Spring offers Hibernate,
JPA and JDO support through the Hibernate, JPA, and JDO transaction managers as well as
JTA support. For details on transaction support, see the <a class="xref" href="#transaction" title="11.&nbsp;Transaction Management">Chapter&nbsp;11, <i>Transaction Management</i></a> chapter.</p>
</div>
<div class="section" title="14.2.2&nbsp;Exception translation"><div class="titlepage"><div><div><h3 class="title"><a name="orm-exception-translation"></a>14.2.2&nbsp;Exception translation</h3></div></div></div>

<p>When you use Hibernate, JPA, or JDO in a DAO, you must decide how to handle the
persistence technology&#8217;s native exception classes. The DAO throws a subclass of a
<code class="literal">HibernateException</code>, <code class="literal">PersistenceException</code> or <code class="literal">JDOException</code> depending on the
technology. These exceptions are all run-time exceptions and do not have to be declared
or caught. You may also have to deal with <code class="literal">IllegalArgumentException</code> and
<code class="literal">IllegalStateException</code>. This means that callers can only treat exceptions as generally
fatal, unless they want to depend on the persistence technology&#8217;s own exception
structure. Catching specific causes such as an optimistic locking failure is not
possible without tying the caller to the implementation strategy. This trade off might
be acceptable to applications that are strongly ORM-based and/or do not need any special
exception treatment. However, Spring enables exception translation to be applied
transparently through the <code class="literal">@Repository</code> annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Repository</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-comment">// class body here...</span>

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-comment">&lt;!-- Exception translation bean post processor --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The postprocessor automatically looks for all exception translators (implementations of
the <code class="literal">PersistenceExceptionTranslator</code> interface) and advises all beans marked with the
<code class="literal">@Repository</code> annotation so that the discovered translators can intercept and apply the
appropriate translation on the thrown exceptions.</p>
<p>In summary: you can implement DAOs based on the plain persistence technology&#8217;s API and
annotations, while still benefiting from Spring-managed transactions, dependency
injection, and transparent exception conversion (if desired) to Spring&#8217;s custom
exception hierarchies.</p>
</div>
</div>
<div class="section" title="14.3&nbsp;Hibernate"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-hibernate"></a>14.3&nbsp;Hibernate</h2></div></div></div>

<p>We will start with a coverage of <a class="ulink" href="http://www.hibernate.org/" target="_top">Hibernate 3</a> in a Spring
environment, using it to demonstrate the approach that Spring takes towards integrating
O/R mappers. This section will cover many issues in detail and show different variations
of DAO implementations and transaction demarcation. Most of these patterns can be
directly translated to all other supported ORM tools. The following sections in this
chapter will then cover the other ORM technologies, showing briefer examples there.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As of Spring 4.0, Spring requires Hibernate 3.6 or later.</p>
</td></tr></table></div>

<div class="section" title="14.3.1&nbsp;SessionFactory setup in a Spring container"><div class="titlepage"><div><div><h3 class="title"><a name="orm-session-factory-setup"></a>14.3.1&nbsp;SessionFactory setup in a Spring container</h3></div></div></div>

<p>To avoid tying application objects to hard-coded resource lookups, you can define
resources such as a JDBC <code class="literal">DataSource</code> or a Hibernate <code class="literal">SessionFactory</code> as beans in the
Spring container. Application objects that need to access resources receive references
to such predefined instances through bean references, as illustrated in the DAO
definition in the next section.</p>
<p>The following excerpt from an XML application context definition shows how to set up a
JDBC <code class="literal">DataSource</code> and a Hibernate <code class="literal">SessionFactory</code> on top of it:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myDataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.hsqldb.jdbcDriver"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc:hsqldb:hsql://localhost:9001"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"sa"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myDataSource"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingResources"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>product.hbm.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hibernateProperties"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>
                hibernate.dialect=org.hibernate.dialect.HSQLDialect
            <span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Switching from a local Jakarta Commons DBCP <code class="literal">BasicDataSource</code> to a JNDI-located
<code class="literal">DataSource</code> (usually managed by an application server) is just a matter of
configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myDataSource"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/myds"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>You can also access a JNDI-located <code class="literal">SessionFactory</code>, using Spring&#8217;s
<code class="literal">JndiObjectFactoryBean</code> / <code class="literal">&lt;jee:jndi-lookup&gt;</code> to retrieve and expose it. However, that
is typically not common outside of an EJB context.</p>
</div>
<div class="section" title="14.3.2&nbsp;Implementing DAOs based on plain Hibernate 3 API"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-straight"></a>14.3.2&nbsp;Implementing DAOs based on plain Hibernate 3 API</h3></div></div></div>

<p>Hibernate 3 has a feature called contextual sessions, wherein Hibernate itself manages
one current <code class="literal">Session</code> per transaction. This is roughly equivalent to Spring&#8217;s
synchronization of one Hibernate <code class="literal">Session</code> per transaction. A corresponding DAO
implementation resembles the following example, based on the plain Hibernate API:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> SessionFactory sessionFactory;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSessionFactory(SessionFactory sessionFactory) {
        <span class="hl-keyword">this</span>.sessionFactory = sessionFactory;
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.sessionFactory.getCurrentSession()
                .createQuery(<span class="hl-string">"from test.Product product where product.category=?"</span>)
                .setParameter(<span class="hl-number">0</span>, category)
                .list();
    }
}</pre>

<p>This style is similar to that of the Hibernate reference documentation and examples,
except for holding the <code class="literal">SessionFactory</code> in an instance variable. We strongly recommend
such an instance-based setup over the old-school <code class="literal">static</code> <code class="literal">HibernateUtil</code> class from
Hibernate&#8217;s CaveatEmptor sample application. (In general, do not keep any resources in
<code class="literal">static</code> variables unless <span class="emphasis"><em>absolutely</em></span> necessary.)</p>
<p>The above DAO follows the dependency injection pattern: it fits nicely into a Spring IoC
container, just as it would if coded against Spring&#8217;s <code class="literal">HibernateTemplate</code>. Of course,
such a DAO can also be set up in plain Java (for example, in unit tests). Simply
instantiate it and call <code class="literal">setSessionFactory(..)</code> with the desired factory reference. As a
Spring bean definition, the DAO would resemble the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The main advantage of this DAO style is that it depends on Hibernate API only; no import
of any Spring class is required. This is of course appealing from a non-invasiveness
perspective, and will no doubt feel more natural to Hibernate developers.</p>
<p>However, the DAO throws plain <code class="literal">HibernateException</code> (which is unchecked, so does not have
to be declared or caught), which means that callers can only treat exceptions as
generally fatal - unless they want to depend on Hibernate&#8217;s own exception hierarchy.
Catching specific causes such as an optimistic locking failure is not possible without
tying the caller to the implementation strategy. This trade off might be acceptable to
applications that are strongly Hibernate-based and/or do not need any special exception
treatment.</p>
<p>Fortunately, Spring&#8217;s <code class="literal">LocalSessionFactoryBean</code> supports Hibernate&#8217;s
<code class="literal">SessionFactory.getCurrentSession()</code> method for any Spring transaction strategy,
returning the current Spring-managed transactional <code class="literal">Session</code> even with
<code class="literal">HibernateTransactionManager</code>. Of course, the standard behavior of that method remains
the return of the current <code class="literal">Session</code> associated with the ongoing JTA transaction, if any.
This behavior applies regardless of whether you are using Spring&#8217;s
<code class="literal">JtaTransactionManager</code>, EJB container managed transactions (CMTs), or JTA.</p>
<p>In summary: you can implement DAOs based on the plain Hibernate 3 API, while still being
able to participate in Spring-managed transactions.</p>
</div>
<div class="section" title="14.3.3&nbsp;Declarative transaction demarcation"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-tx-declarative"></a>14.3.3&nbsp;Declarative transaction demarcation</h3></div></div></div>

<p>We recommend that you use Spring&#8217;s declarative transaction support, which enables you to
replace explicit transaction demarcation API calls in your Java code with an AOP
transaction interceptor. This transaction interceptor can be configured in a Spring
container using either Java annotations or XML.This declarative transaction capability
allows you to keep business services free of repetitive transaction demarcation code and
to focus on adding business logic, which is the real value of your application.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Prior to continuing, you are <span class="emphasis"><em>strongly</em></span> encouraged to read <a class="xref" href="#transaction-declarative" title="11.5&nbsp;Declarative transaction management">Section&nbsp;11.5, &#8220;Declarative transaction management&#8221;</a>
if you have not done so.</p>
</td></tr></table></div>

<p>Furthermore, transaction semantics like propagation behavior and isolation level can be
changed in a configuration file and do not affect the business service implementations.</p>
<p>The following example shows how you can configure an AOP transaction interceptor, using
XML, for a simple service class:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- SessionFactory, DataSource, etc. omitted --&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"productServiceMethods"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* product.ProductService.</span><span class="strong"><strong>(..))"/&gt;
        &lt;aop:advisor advice-ref="txAdvice" pointcut-ref="productServiceMethods"/&gt;
    &lt;/aop:config&gt;

    &lt;tx:advice id="txAdvice" transaction-manager="myTxManager"&gt;
        &lt;tx:attributes&gt;
            &lt;tx:method name="increasePrice</strong></span>" propagation="REQUIRED"/&gt;
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someOtherBusinessMethod"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"SUPPORTS"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.SimpleProductService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>This is the service class that is advised:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductServiceImpl <span class="hl-keyword">implements</span> ProductService {

    <span class="hl-keyword">private</span> ProductDao productDao;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setProductDao(ProductDao productDao) {
        <span class="hl-keyword">this</span>.productDao = productDao;
    }

    <span class="hl-comment">// notice the absence of transaction demarcation code in this method</span>
    <span class="hl-comment">// Spring's declarative transaction infrastructure will be demarcating</span>
    <span class="hl-comment">// transactions on your behalf</span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> increasePriceOfAllProductsInCategory(<span class="hl-keyword">final</span> String category) {
        List productsToChange = <span class="hl-keyword">this</span>.productDao.loadProductsByCategory(category);
        <span class="hl-comment">// ...</span>
    }
}</pre>

<p>We also show an attribute-support based configuration, in the following example. You
annotate the service layer with @Transactional annotations and instruct the Spring
container to find these annotations and provide transactional semantics for these
annotated methods.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductServiceImpl <span class="hl-keyword">implements</span> ProductService {

    <span class="hl-keyword">private</span> ProductDao productDao;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setProductDao(ProductDao productDao) {
        <span class="hl-keyword">this</span>.productDao = productDao;
    }

    <i><span class="hl-annotation" style="color: gray">@Transactional</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> increasePriceOfAllProductsInCategory(<span class="hl-keyword">final</span> String category) {
        List productsToChange = <span class="hl-keyword">this</span>.productDao.loadProductsByCategory(category);
        <span class="hl-comment">// ...</span>
    }

    <i><span class="hl-annotation" style="color: gray">@Transactional(readOnly = true)</span></i>
    <span class="hl-keyword">public</span> List&lt;Product&gt; findAllProducts() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.productDao.findAllProducts();
    }

}</pre>

<p>As you can see from the following configuration example, the configuration is much
simplified, compared to the XML example above, while still providing the same
functionality driven by the annotations in the service layer code. All you need to
provide is the TransactionManager implementation and a "&lt;tx:annotation-driven/&gt;" entry.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- SessionFactory, DataSource, etc. omitted --&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;tx:annotation-driven/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.SimpleProductService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="14.3.4&nbsp;Programmatic transaction demarcation"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-tx-programmatic"></a>14.3.4&nbsp;Programmatic transaction demarcation</h3></div></div></div>

<p>You can demarcate transactions in a higher level of the application, on top of such
lower-level data access services spanning any number of operations. Nor do restrictions
exist on the implementation of the surrounding business service; it just needs a Spring
<code class="literal">PlatformTransactionManager</code>. Again, the latter can come from anywhere, but preferably
as a bean reference through a <code class="literal">setTransactionManager(..)</code> method, just as the
<code class="literal">productDAO</code> should be set by a <code class="literal">setProductDao(..)</code> method. The following snippets show
a transaction manager and a business service definition in a Spring application context,
and an example for a business method implementation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTxManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myTxManager"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductServiceImpl <span class="hl-keyword">implements</span> ProductService {

    <span class="hl-keyword">private</span> TransactionTemplate transactionTemplate;
    <span class="hl-keyword">private</span> ProductDao productDao;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTransactionManager(PlatformTransactionManager transactionManager) {
        <span class="hl-keyword">this</span>.transactionTemplate = <span class="hl-keyword">new</span> TransactionTemplate(transactionManager);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setProductDao(ProductDao productDao) {
        <span class="hl-keyword">this</span>.productDao = productDao;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> increasePriceOfAllProductsInCategory(<span class="hl-keyword">final</span> String category) {
        <span class="hl-keyword">this</span>.transactionTemplate.execute(<span class="hl-keyword">new</span> TransactionCallbackWithoutResult() {
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doInTransactionWithoutResult(TransactionStatus status) {
                List productsToChange = <span class="hl-keyword">this</span>.productDao.loadProductsByCategory(category);
                <span class="hl-comment">// do the price increase...</span>
            }
        });
    }
}</pre>

<p>Spring&#8217;s <code class="literal">TransactionInterceptor</code> allows any checked application exception to be thrown
with the callback code, while <code class="literal">TransactionTemplate</code> is restricted to unchecked
exceptions within the callback. <code class="literal">TransactionTemplate</code> triggers a rollback in case of an
unchecked application exception, or if the transaction is marked rollback-only by the
application (via <code class="literal">TransactionStatus</code>). <code class="literal">TransactionInterceptor</code> behaves the same way by
default but allows configurable rollback policies per method.</p>
</div>
<div class="section" title="14.3.5&nbsp;Transaction management strategies"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-tx-strategies"></a>14.3.5&nbsp;Transaction management strategies</h3></div></div></div>

<p>Both <code class="literal">TransactionTemplate</code> and <code class="literal">TransactionInterceptor</code> delegate the actual transaction
handling to a <code class="literal">PlatformTransactionManager</code> instance, which can be a
<code class="literal">HibernateTransactionManager</code> (for a single Hibernate <code class="literal">SessionFactory</code>, using a
<code class="literal">ThreadLocal</code> <code class="literal">Session</code> under the hood) or a <code class="literal">JtaTransactionManager</code> (delegating to the
JTA subsystem of the container) for Hibernate applications. You can even use a custom
<code class="literal">PlatformTransactionManager</code> implementation. Switching from native Hibernate transaction
management to JTA, such as when facing distributed transaction requirements for certain
deployments of your application, is just a matter of configuration. Simply replace
the Hibernate transaction manager with Spring&#8217;s JTA transaction implementation. Both
transaction demarcation and data access code will work without changes, because they
just use the generic transaction management APIs.</p>
<p>For distributed transactions across multiple Hibernate session factories, simply combine
<code class="literal">JtaTransactionManager</code> as a transaction strategy with multiple
<code class="literal">LocalSessionFactoryBean</code> definitions. Each DAO then gets one specific <code class="literal">SessionFactory</code>
reference passed into its corresponding bean property. If all underlying JDBC data
sources are transactional container ones, a business service can demarcate transactions
across any number of DAOs and any number of session factories without special regard, as
long as it is using <code class="literal">JtaTransactionManager</code> as the strategy.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource1"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/myds1"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource2"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/myds2"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySessionFactory1"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myDataSource1"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingResources"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>product.hbm.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hibernateProperties"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>
                hibernate.dialect=org.hibernate.dialect.MySQLDialect
                hibernate.show_sql=true
            <span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySessionFactory2"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myDataSource2"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingResources"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>inventory.hbm.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hibernateProperties"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>
                hibernate.dialect=org.hibernate.dialect.OracleDialect
            <span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTxManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myInventoryDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.InventoryDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"inventoryDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myInventoryDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"productServiceMethods"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* product.ProductService.</span><span class="strong"><strong>(..))"/&gt;
        &lt;aop:advisor advice-ref="txAdvice" pointcut-ref="productServiceMethods"/&gt;
    &lt;/aop:config&gt;

    &lt;tx:advice id="txAdvice" transaction-manager="myTxManager"&gt;
        &lt;tx:attributes&gt;
            &lt;tx:method name="increasePrice</strong></span>" propagation="REQUIRED"/&gt;
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someOtherBusinessMethod"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"SUPPORTS"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Both <code class="literal">HibernateTransactionManager</code> and <code class="literal">JtaTransactionManager</code> allow for proper
JVM-level cache handling with Hibernate, without container-specific transaction manager
lookup or a JCA connector (if you are not using EJB to initiate transactions).</p>
<p><code class="literal">HibernateTransactionManager</code> can export the Hibernate JDBC <code class="literal">Connection</code> to plain JDBC
access code, for a specific <code class="literal">DataSource</code>. This capability allows for high-level
transaction demarcation with mixed Hibernate and JDBC data access completely without
JTA, if you are accessing only one database. <code class="literal">HibernateTransactionManager</code> automatically
exposes the Hibernate transaction as a JDBC transaction if you have set up the passed-in
<code class="literal">SessionFactory</code> with a <code class="literal">DataSource</code> through the <code class="literal">dataSource</code> property of the
<code class="literal">LocalSessionFactoryBean</code> class. Alternatively, you can specify explicitly the
<code class="literal">DataSource</code> for which the transactions are supposed to be exposed through the
<code class="literal">dataSource</code> property of the <code class="literal">HibernateTransactionManager</code> class.</p>
</div>
<div class="section" title="14.3.6&nbsp;Comparing container-managed and locally defined resources"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-resources"></a>14.3.6&nbsp;Comparing container-managed and locally defined resources</h3></div></div></div>

<p>You can switch between a container-managed JNDI <code class="literal">SessionFactory</code> and a locally defined
one, without having to change a single line of application code. Whether to keep
resource definitions in the container or locally within the application is mainly a
matter of the transaction strategy that you use. Compared to a Spring-defined local
<code class="literal">SessionFactory</code>, a manually registered JNDI <code class="literal">SessionFactory</code> does not provide any
benefits. Deploying a <code class="literal">SessionFactory</code> through Hibernate&#8217;s JCA connector provides the
added value of participating in the Java EE server&#8217;s management infrastructure, but does
not add actual value beyond that.</p>
<p>Spring&#8217;s transaction support is not bound to a container. Configured with any strategy
other than JTA, transaction support also works in a stand-alone or test environment.
Especially in the typical case of single-database transactions, Spring&#8217;s single-resource
local transaction support is a lightweight and powerful alternative to JTA. When you use
local EJB stateless session beans to drive transactions, you depend both on an EJB
container and JTA, even if you access only a single database, and only use stateless
session beans to provide declarative transactions through container-managed
transactions. Also, direct use of JTA programmatically requires a Java EE environment as
well. JTA does not involve only container dependencies in terms of JTA itself and of
JNDI <code class="literal">DataSource</code> instances. For non-Spring, JTA-driven Hibernate transactions, you have
to use the Hibernate JCA connector, or extra Hibernate transaction code with the
<code class="literal">TransactionManagerLookup</code> configured for proper JVM-level caching.</p>
<p>Spring-driven transactions can work as well with a locally defined Hibernate
<code class="literal">SessionFactory</code> as they do with a local JDBC <code class="literal">DataSource</code> if they are accessing a
single database. Thus you only have to use Spring&#8217;s JTA transaction strategy when you
have distributed transaction requirements. A JCA connector requires container-specific
deployment steps, and obviously JCA support in the first place. This configuration
requires more work than deploying a simple web application with local resource
definitions and Spring-driven transactions. Also, you often need the Enterprise Edition
of your container if you are using, for example, WebLogic Express, which does not
provide JCA. A Spring application with local resources and transactions spanning one
single database works in any Java EE web container (without JTA, JCA, or EJB) such as
Tomcat, Resin, or even plain Jetty. Additionally, you can easily reuse such a middle
tier in desktop applications or test suites.</p>
<p>All things considered, if you do not use EJBs, stick with local <code class="literal">SessionFactory</code> setup
and Spring&#8217;s <code class="literal">HibernateTransactionManager</code> or <code class="literal">JtaTransactionManager</code>. You get all of
the benefits, including proper transactional JVM-level caching and distributed
transactions, without the inconvenience of container deployment. JNDI registration of a
Hibernate <code class="literal">SessionFactory</code> through the JCA connector only adds value when used in
conjunction with EJBs.</p>
</div>
<div class="section" title="14.3.7&nbsp;Spurious application server warnings with Hibernate"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-invalid-jdbc-access-error"></a>14.3.7&nbsp;Spurious application server warnings with Hibernate</h3></div></div></div>

<p>In some JTA environments with very strict <code class="literal">XADataSource</code> implementations&#8201;&#8212;&#8201;currently
only some WebLogic Server and WebSphere versions&#8201;&#8212;&#8201;when Hibernate is configured without
regard to the JTA <code class="literal">PlatformTransactionManager</code> object for that environment, it is
possible for spurious warning or exceptions to show up in the application server log.
These warnings or exceptions indicate that the connection being accessed is no longer
valid, or JDBC access is no longer valid, possibly because the transaction is no longer
active. As an example, here is an actual exception from WebLogic:</p>

<pre class="literallayout">java.sql.SQLException: The transaction is no longer active - status: <span class="emphasis"><em>Committed</em></span>. No
further JDBC access is allowed within this transaction.</pre>

<p>You resolve this warning by simply making Hibernate aware of the JTA
<code class="literal">PlatformTransactionManager</code> instance, to which it will synchronize (along with Spring).
You have two options for doing this:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
If in your application context you are already directly obtaining the JTA
<code class="literal">PlatformTransactionManager</code> object (presumably from JNDI through
<code class="literal">JndiObjectFactoryBean</code> or <code class="literal">&lt;jee:jndi-lookup&gt;</code>) and feeding it, for example, to
Spring&#8217;s <code class="literal">JtaTransactionManager</code>, then the easiest way is to specify a reference to
the bean defining this JTA <code class="literal">PlatformTransactionManager</code> instance as the value of the
<code class="literal">jtaTransactionManager</code> property for <code class="literal">LocalSessionFactoryBean.</code> Spring then makes the
object available to Hibernate.
</li><li class="listitem">
More likely you do not already have the JTA <code class="literal">PlatformTransactionManager</code> instance,
because Spring&#8217;s <code class="literal">JtaTransactionManager</code> can find it itself. Thus you need to
configure Hibernate to look up JTA <code class="literal">PlatformTransactionManager</code> directly. You do this
by configuring an application server- specific <code class="literal">TransactionManagerLookup</code> class in the
Hibernate configuration, as described in the Hibernate manual.
</li></ul></div>

<p>The remainder of this section describes the sequence of events that occur with and
without Hibernate&#8217;s awareness of the JTA <code class="literal">PlatformTransactionManager</code>.</p>
<p>When Hibernate is not configured with any awareness of the JTA
<code class="literal">PlatformTransactionManager</code>, the following events occur when a JTA transaction commits:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The JTA transaction commits.
</li><li class="listitem">
Spring&#8217;s <code class="literal">JtaTransactionManager</code> is synchronized to the JTA transaction, so it is
called back through an <span class="emphasis"><em>afterCompletion</em></span> callback by the JTA transaction manager.
</li><li class="listitem">
Among other activities, this synchronization can trigger a callback by Spring to
Hibernate, through Hibernate&#8217;s <code class="literal">afterTransactionCompletion</code> callback (used to clear
the Hibernate cache), followed by an explicit <code class="literal">close()</code> call on the Hibernate Session,
which causes Hibernate to attempt to <code class="literal">close()</code> the JDBC Connection.
</li><li class="listitem">
In some environments, this <code class="literal">Connection.close()</code> call then triggers the warning or
error, as the application server no longer considers the <code class="literal">Connection</code> usable at all,
because the transaction has already been committed.
</li></ul></div>

<p>When Hibernate is configured with awareness of the JTA <code class="literal">PlatformTransactionManager</code>, the
following events occur when a JTA transaction commits:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
the JTA transaction is ready to commit.
</li><li class="listitem">
Spring&#8217;s <code class="literal">JtaTransactionManager</code> is synchronized to the JTA transaction, so the
transaction is called back through a <span class="emphasis"><em>beforeCompletion</em></span> callback by the JTA
transaction manager.
</li><li class="listitem">
Spring is aware that Hibernate itself is synchronized to the JTA transaction, and
behaves differently than in the previous scenario. Assuming the Hibernate <code class="literal">Session</code>
needs to be closed at all, Spring will close it now.
</li><li class="listitem">
The JTA transaction commits.
</li><li class="listitem">
Hibernate is synchronized to the JTA transaction, so the transaction is called back
through an <span class="emphasis"><em>afterCompletion</em></span> callback by the JTA transaction manager, and can
properly clear its cache.
</li></ul></div>

</div>
</div>
<div class="section" title="14.4&nbsp;JDO"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-jdo"></a>14.4&nbsp;JDO</h2></div></div></div>

<p>Spring supports the standard JDO 2.0 and 2.1 APIs as data access strategy, following the
same style as the Hibernate support. The corresponding integration classes reside in the
<code class="literal">org.springframework.orm.jdo</code> package.</p>
<div class="section" title="14.4.1&nbsp;PersistenceManagerFactory setup"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jdo-setup"></a>14.4.1&nbsp;PersistenceManagerFactory setup</h3></div></div></div>

<p>Spring provides a <code class="literal">LocalPersistenceManagerFactoryBean</code> class that allows you to define a
local JDO <code class="literal">PersistenceManagerFactory</code> within a Spring application context:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPmf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jdo.LocalPersistenceManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"configLocation"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:kodo.properties"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Alternatively, you can set up a <code class="literal">PersistenceManagerFactory</code> through direct instantiation
of a <code class="literal">PersistenceManagerFactory</code> implementation class. A JDO <code class="literal">PersistenceManagerFactory</code>
implementation class follows the JavaBeans pattern, just like a JDBC <code class="literal">DataSource</code>
implementation class, which is a natural fit for a configuration that uses Spring. This
setup style usually supports a Spring-defined JDBC <code class="literal">DataSource</code>, passed into the
<code class="literal">connectionFactory</code> property. For example, for the open source JDO implementation
DataNucleus (formerly JPOX) ( <a class="ulink" href="http://www.datanucleus.org/" target="_top">http://www.datanucleus.org/</a>),
this is the XML configuration of the <code class="literal">PersistenceManagerFactory</code> implementation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

 <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.driverClassName}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.url}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.username}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.password}"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/bean&gt;</span>

 <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPmf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.datanucleus.jdo.JDOPersistenceManagerFactory"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"nontransactionalRead"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>You can also set up JDO <code class="literal">PersistenceManagerFactory</code> in the JNDI environment of a Java EE
application server, usually through the JCA connector provided by the particular JDO
implementation. Spring&#8217;s standard <code class="literal">JndiObjectFactoryBean</code> or <code class="literal">&lt;jee:jndi-lookup&gt;</code> can be
used to retrieve and expose such a <code class="literal">PersistenceManagerFactory</code>. However, outside an EJB
context, no real benefit exists in holding the <code class="literal">PersistenceManagerFactory</code> in JNDI: only
choose such a setup for a good reason. See <a class="xref" href="#orm-hibernate-resources" title="14.3.6&nbsp;Comparing container-managed and locally defined resources">Section&nbsp;14.3.6, &#8220;Comparing container-managed and locally defined resources&#8221;</a> for a discussion;
the arguments there apply to JDO as well.</p>
</div>
<div class="section" title="14.4.2&nbsp;Implementing DAOs based on the plain JDO API"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jdo-daos-straight"></a>14.4.2&nbsp;Implementing DAOs based on the plain JDO API</h3></div></div></div>

<p>DAOs can also be written directly against plain JDO API, without any Spring
dependencies, by using an injected <code class="literal">PersistenceManagerFactory</code>. The following is an
example of a corresponding DAO implementation:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> PersistenceManagerFactory persistenceManagerFactory;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPersistenceManagerFactory(PersistenceManagerFactory pmf) {
        <span class="hl-keyword">this</span>.persistenceManagerFactory = pmf;
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        PersistenceManager pm = <span class="hl-keyword">this</span>.persistenceManagerFactory.getPersistenceManager();
        <span class="hl-keyword">try</span> {
            Query query = pm.newQuery(Product.<span class="hl-keyword">class</span>, <span class="hl-string">"category = pCategory"</span>);
            query.declareParameters(<span class="hl-string">"String pCategory"</span>);
            <span class="hl-keyword">return</span> query.execute(category);
        }
        <span class="hl-keyword">finally</span> {
            pm.close();
        }
    }
}</pre>

<p>Because the above DAO follows the dependency injection pattern, it fits nicely into a
Spring container, just as it would if coded against Spring&#8217;s <code class="literal">JdoTemplate</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The main problem with such DAOs is that they always get a new <code class="literal">PersistenceManager</code> from
the factory. To access a Spring-managed transactional <code class="literal">PersistenceManager</code>, define a
<code class="literal">TransactionAwarePersistenceManagerFactoryProxy</code> (as included in Spring) in front of
your target <code class="literal">PersistenceManagerFactory</code>, then passing a reference to that proxy into
your DAOs as in the following example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPmfProxy"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jdo.TransactionAwarePersistenceManagerFactoryProxy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetPersistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmfProxy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Your data access code will receive a transactional <code class="literal">PersistenceManager</code> (if any) from
the <code class="literal">PersistenceManagerFactory.getPersistenceManager()</code> method that it calls. The latter
method call goes through the proxy, which first checks for a current transactional
<code class="literal">PersistenceManager</code> before getting a new one from the factory. Any <code class="literal">close()</code> calls on
the <code class="literal">PersistenceManager</code> are ignored in case of a transactional <code class="literal">PersistenceManager</code>.</p>
<p>If your data access code always runs within an active transaction (or at least within
active transaction synchronization), it is safe to omit the <code class="literal">PersistenceManager.close()</code>
call and thus the entire <code class="literal">finally</code> block, which you might do to keep your DAO
implementations concise:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> PersistenceManagerFactory persistenceManagerFactory;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPersistenceManagerFactory(PersistenceManagerFactory pmf) {
        <span class="hl-keyword">this</span>.persistenceManagerFactory = pmf;
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        PersistenceManager pm = <span class="hl-keyword">this</span>.persistenceManagerFactory.getPersistenceManager();
        Query query = pm.newQuery(Product.<span class="hl-keyword">class</span>, <span class="hl-string">"category = pCategory"</span>);
        query.declareParameters(<span class="hl-string">"String pCategory"</span>);
        <span class="hl-keyword">return</span> query.execute(category);
    }
}</pre>

<p>With such DAOs that rely on active transactions, it is recommended that you enforce
active transactions through turning off
<code class="literal">TransactionAwarePersistenceManagerFactoryProxy</code>'s <code class="literal">allowCreate</code> flag:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPmfProxy"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jdo.TransactionAwarePersistenceManagerFactoryProxy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetPersistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"allowCreate"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmfProxy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The main advantage of this DAO style is that it depends on JDO API only; no import of
any Spring class is required. This is of course appealing from a non-invasiveness
perspective, and might feel more natural to JDO developers.</p>
<p>However, the DAO throws plain <code class="literal">JDOException</code> (which is unchecked, so does not have to be
declared or caught), which means that callers can only treat exceptions as fatal, unless
you want to depend on JDO&#8217;s own exception structure. Catching specific causes such as an
optimistic locking failure is not possible without tying the caller to the
implementation strategy. This trade off might be acceptable to applications that are
strongly JDO-based and/or do not need any special exception treatment.</p>
<p>In summary, you can DAOs based on the plain JDO API, and they can still participate in
Spring-managed transactions. This strategy might appeal to you if you are already
familiar with JDO. However, such DAOs throw plain <code class="literal">JDOException</code>, and you would have to
convert explicitly to Spring&#8217;s <code class="literal">DataAccessException</code> (if desired).</p>
</div>
<div class="section" title="14.4.3&nbsp;Transaction management"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jdo-tx"></a>14.4.3&nbsp;Transaction management</h3></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You are <span class="emphasis"><em>strongly</em></span> encouraged to read <a class="xref" href="#transaction-declarative" title="11.5&nbsp;Declarative transaction management">Section&nbsp;11.5, &#8220;Declarative transaction management&#8221;</a> if you have not done
so, to get a more detailed coverage of Spring&#8217;s declarative transaction support.</p>
</td></tr></table></div>

<p>To execute service operations within transactions, you can use Spring&#8217;s common
declarative transaction facilities. For example:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTxManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jdo.JdoTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"increasePrice*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someOtherBusinessMethod"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"</span><span class="strong"><strong>" propagation="SUPPORTS" read-only="true"/&gt;
        &lt;/tx:attributes&gt;
    &lt;/tx:advice&gt;

    &lt;aop:config&gt;
        &lt;aop:pointcut id="productServiceMethods"
                expression="execution(</strong></span> product.ProductService.*(..))"/&gt;
        <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"productServiceMethods"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>JDO requires an active transaction to modify a persistent object. The non-transactional
flush concept does not exist in JDO, in contrast to Hibernate. For this reason, you need
to set up the chosen JDO implementation for a specific environment. Specifically, you
need to set it up explicitly for JTA synchronization, to detect an active JTA
transaction itself. This is not necessary for local transactions as performed by
Spring&#8217;s <code class="literal">JdoTransactionManager</code>, but it is necessary to participate in JTA
transactions, whether driven by Spring&#8217;s <code class="literal">JtaTransactionManager</code> or by EJB CMT and plain
JTA.</p>
<p><code class="literal">JdoTransactionManager</code> is capable of exposing a JDO transaction to JDBC access code
that accesses the same JDBC <code class="literal">DataSource</code>, provided that the registered <code class="literal">JdoDialect</code>
supports retrieval of the underlying JDBC <code class="literal">Connection</code>. This is the case for JDBC-based
JDO 2.0 implementations by default.</p>
</div>
<div class="section" title="14.4.4&nbsp;JdoDialect"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jdo-dialect"></a>14.4.4&nbsp;JdoDialect</h3></div></div></div>

<p>As an advanced feature, both <code class="literal">JdoTemplate</code> and <code class="literal">JdoTransactionManager</code> support a custom
<code class="literal">JdoDialect</code> that can be passed into the <code class="literal">jdoDialect</code> bean property. In this scenario,
the DAOs will not receive a <code class="literal">PersistenceManagerFactory</code> reference but rather a full
<code class="literal">JdoTemplate</code> instance (for example, passed into the <code class="literal">jdoTemplate</code> property of
<code class="literal">JdoDaoSupport</code>). Using a <code class="literal">JdoDialect</code> implementation, you can enable advanced features
supported by Spring, usually in a vendor-specific manner:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Applying specific transaction semantics such as custom isolation level or transaction
timeout
</li><li class="listitem">
Retrieving the transactional JDBC <code class="literal">Connection</code> for exposure to JDBC-based DAOs
</li><li class="listitem">
Applying query timeouts, which are automatically calculated from Spring-managed
transaction timeouts
</li><li class="listitem">
Eagerly flushing a <code class="literal">PersistenceManager,</code> to make transactional changes visible to
JDBC-based data access code
</li><li class="listitem">
Advanced translation of <code class="literal">JDOExceptions</code> to Spring <code class="literal">DataAccessExceptions</code>
</li></ul></div>

<p>See the <code class="literal">JdoDialect</code> Javadoc for more details on its operations and how to use them
within Spring&#8217;s JDO support.</p>
</div>
</div>
<div class="section" title="14.5&nbsp;JPA"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-jpa"></a>14.5&nbsp;JPA</h2></div></div></div>

<p>The Spring JPA, available under the <code class="literal">org.springframework.orm.jpa</code> package, offers
comprehensive support for the
<a class="ulink" href="http://www.oracle.com/technetwork/articles/javaee/jpa-137156.html" target="_top">Java Persistence
API</a> in a similar manner to the integration with Hibernate or JDO, while being aware of
the underlying implementation in order to provide additional features.</p>
<div class="section" title="14.5.1&nbsp;Three options for JPA setup in a Spring environment"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jpa-setup"></a>14.5.1&nbsp;Three options for JPA setup in a Spring environment</h3></div></div></div>

<p>The Spring JPA support offers three ways of setting up the JPA <code class="literal">EntityManagerFactory</code>
that will be used by the application to obtain an entity manager.</p>
<div class="section" title="LocalEntityManagerFactoryBean"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-setup-lemfb"></a>LocalEntityManagerFactoryBean</h4></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Only use this option in simple deployment environments such as stand-alone applications
and integration tests.</p>
</td></tr></table></div>

<p>The <code class="literal">LocalEntityManagerFactoryBean</code> creates an <code class="literal">EntityManagerFactory</code> suitable for
simple deployment environments where the application uses only JPA for data access. The
factory bean uses the JPA <code class="literal">PersistenceProvider</code> autodetection mechanism (according to
JPA&#8217;s Java SE bootstrapping) and, in most cases, requires you to specify only the
persistence unit name:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myEmf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceUnitName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myPersistenceUnit"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>This form of JPA deployment is the simplest and the most limited. You cannot refer to an
existing JDBC <code class="literal">DataSource</code> bean definition and no support for global transactions
exists. Furthermore, weaving (byte-code transformation) of persistent classes is
provider-specific, often requiring a specific JVM agent to specified on startup. This
option is sufficient only for stand-alone applications and test environments, for which
the JPA specification is designed.</p>
</div>
<div class="section" title="Obtaining an EntityManagerFactory from JNDI"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-setup-jndi"></a>Obtaining an EntityManagerFactory from JNDI</h4></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Use this option when deploying to a Java EE 5 server. Check your server&#8217;s documentation
on how to deploy a custom JPA provider into your server, allowing for a different
provider than the server&#8217;s default.</p>
</td></tr></table></div>

<p>Obtaining an <code class="literal">EntityManagerFactory</code> from JNDI (for example in a Java EE 5 environment),
is simply a matter of changing the XML configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myEmf"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"persistence/myPersistenceUnit"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>This action assumes standard Java EE 5 bootstrapping: the Java EE server autodetects
persistence units (in effect, <code class="literal">META-INF/persistence.xml</code> files in application jars) and
<code class="literal">persistence-unit-ref</code> entries in the Java EE deployment descriptor (for example,
<code class="literal">web.xml</code>) and defines environment naming context locations for those persistence units.</p>
<p>In such a scenario, the entire persistence unit deployment, including the weaving
(byte-code transformation) of persistent classes, is up to the Java EE server. The JDBC
<code class="literal">DataSource</code> is defined through a JNDI location in the <code class="literal">META-INF/persistence.xml</code> file;
EntityManager transactions are integrated with the server&#8217;s JTA subsystem. Spring merely
uses the obtained <code class="literal">EntityManagerFactory</code>, passing it on to application objects through
dependency injection, and managing transactions for the persistence unit, typically
through <code class="literal">JtaTransactionManager</code>.</p>
<p>If multiple persistence units are used in the same application, the bean names of such
JNDI-retrieved persistence units should match the persistence unit names that the
application uses to refer to them, for example, in <code class="literal">@PersistenceUnit</code> and
<code class="literal">@PersistenceContext</code> annotations.</p>
</div>
<div class="section" title="LocalContainerEntityManagerFactoryBean"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-setup-lcemfb"></a>LocalContainerEntityManagerFactoryBean</h4></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Use this option for full JPA capabilities in a Spring-based application environment.
This includes web containers such as Tomcat as well as stand-alone applications and
integration tests with sophisticated persistence requirements.</p>
</td></tr></table></div>

<p>The <code class="literal">LocalContainerEntityManagerFactoryBean</code> gives full control over
<code class="literal">EntityManagerFactory</code> configuration and is appropriate for environments where
fine-grained customization is required. The <code class="literal">LocalContainerEntityManagerFactoryBean</code>
creates a <code class="literal">PersistenceUnitInfo</code> instance based on the <code class="literal">persistence.xml</code> file, the
supplied <code class="literal">dataSourceLookup</code> strategy, and the specified <code class="literal">loadTimeWeaver</code>. It is thus
possible to work with custom data sources outside of JNDI and to control the weaving
process. The following example shows a typical bean definition for a
<code class="literal">LocalContainerEntityManagerFactoryBean</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myEmf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someDataSource"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"loadTimeWeaver"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.instrument.classloading.InstrumentationLoadTimeWeaver"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The following example shows a typical <code class="literal">persistence.xml</code> file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;persistence</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/persistence"</span> <span class="hl-attribute">version</span>=<span class="hl-value">"1.0"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;persistence-unit</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myUnit"</span> <span class="hl-attribute">transaction-type</span>=<span class="hl-value">"RESOURCE_LOCAL"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;mapping-file&gt;</span>META-INF/orm.xml<span class="hl-tag">&lt;/mapping-file&gt;</span>
        <span class="hl-tag">&lt;exclude-unlisted-classes/&gt;</span>
    <span class="hl-tag">&lt;/persistence-unit&gt;</span>
<span class="hl-tag">&lt;/persistence&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">exclude-unlisted-classes</code> element always indicates that <span class="emphasis"><em>no</em></span> scanning for
annotated entity classes is supposed to occur, in order to support the
<code class="literal">&lt;exclude-unlisted-classes/&gt;</code> shortcut. This is in line with the JPA specification,
which suggests that shortcut, but unfortunately is in conflict with the JPA XSD, which
implies <code class="literal">false</code> for that shortcut. Consequently, <code class="literal">&lt;exclude-unlisted-classes&gt; false
&lt;/exclude-unlisted-classes/&gt;</code> is not supported. Simply omit the
<code class="literal">exclude-unlisted-classes</code> element if you want entity class scanning to occur.</p>
</td></tr></table></div>

<p>Using the <code class="literal">LocalContainerEntityManagerFactoryBean</code> is the most powerful JPA setup
option, allowing for flexible local configuration within the application. It supports
links to an existing JDBC <code class="literal">DataSource</code>, supports both local and global transactions, and
so on. However, it also imposes requirements on the runtime environment, such as the
availability of a weaving-capable class loader if the persistence provider demands
byte-code transformation.</p>
<p>This option may conflict with the built-in JPA capabilities of a Java EE 5 server. In a
full Java EE 5 environment, consider obtaining your <code class="literal">EntityManagerFactory</code> from JNDI.
Alternatively, specify a custom <code class="literal">persistenceXmlLocation</code> on your
<code class="literal">LocalContainerEntityManagerFactoryBean</code> definition, for example,
META-INF/my-persistence.xml, and only include a descriptor with that name in your
application jar files. Because the Java EE 5 server only looks for default
<code class="literal">META-INF/persistence.xml</code> files, it ignores such custom persistence units and hence
avoid conflicts with a Spring-driven JPA setup upfront. (This applies to Resin 3.1, for
example.)</p>
<div class="sidebar" title="When is load-time weaving required?"><p class="title"><b>When is load-time weaving required?</b></p>

<p>Not all JPA providers require a JVM agent ; Hibernate is an example of one that does
not. If your provider does not require an agent or you have other alternatives, such as
applying enhancements at build time through a custom compiler or an ant task, the
load-time weaver <span class="emphasis"><em>should not</em></span> be used.</p>
</div>

<p>The <code class="literal">LoadTimeWeaver</code> interface is a Spring-provided class that allows JPA
<code class="literal">ClassTransformer</code> instances to be plugged in a specific manner, depending whether the
environment is a web container or application server. Hooking <code class="literal">ClassTransformers</code>
through an
<a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/java/lang/instrument/package-summary.html" target="_top">agent</a>
typically is not efficient. The agents work against the <span class="emphasis"><em>entire virtual machine</em></span> and
inspect <span class="emphasis"><em>every</em></span> class that is loaded, which is usually undesirable in a production
server environment.</p>
<p>Spring provides a number of <code class="literal">LoadTimeWeaver</code> implementations for various environments,
allowing <code class="literal">ClassTransformer</code> instances to be applied only <span class="emphasis"><em>per class loader</em></span> and not
per VM.</p>
<p>Refer to <a class="xref" href="#aop-aj-ltw-spring" title="Spring configuration">the section called &#8220;Spring configuration&#8221;</a> in the AOP chapter for more insight regarding the
<code class="literal">LoadTimeWeaver</code> implementations and their setup, either generic or customized to
various platforms (such as Tomcat, WebLogic, GlassFish, Resin and JBoss).</p>
<p>As described in the aforementioned section, you can configure a context-wide
<code class="literal">LoadTimeWeaver</code> using the <code class="literal">@EnableLoadTimeWeaving</code> annotation of
<code class="literal">context:load-time-weaver</code> XML element. Such a global weaver is picked up by all JPA
<code class="literal">LocalContainerEntityManagerFactoryBeans</code> automatically. This is the preferred way of
setting up a load-time weaver, delivering autodetection of the platform (WebLogic,
GlassFish, Tomcat, Resin, JBoss or VM agent) and automatic propagation of the weaver to
all weaver-aware beans:</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:load-time-weaver/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>However, if needed, one can manually specify a dedicated weaver through the
<code class="literal">loadTimeWeaver</code> property:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"loadTimeWeaver"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.instrument.classloading.ReflectiveLoadTimeWeaver"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>No matter how the LTW is configured, using this technique, JPA applications relying on
instrumentation can run in the target platform (ex: Tomcat) without needing an agent.
This is important especially when the hosting applications rely on different JPA
implementations because the JPA transformers are applied only at class loader level and
thus are isolated from each other.</p>
</div>
<div class="section" title="Dealing with multiple persistence units"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-multiple-pu"></a>Dealing with multiple persistence units</h4></div></div></div>

<p>For applications that rely on multiple persistence units locations, stored in various
JARS in the classpath, for example, Spring offers the <code class="literal">PersistenceUnitManager</code> to act as
a central repository and to avoid the persistence units discovery process, which can be
expensive. The default implementation allows multiple locations to be specified that are
parsed and later retrieved through the persistence unit name. (By default, the classpath
is searched for <code class="literal">META-INF/persistence.xml</code> files.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pum"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceXmlLocations"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>org/springframework/orm/jpa/domain/persistence-multi.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>classpath:/my/package/<span class="strong"><strong>*/custom-persistence.xml&lt;/value&gt;
            &lt;value&gt;classpath</strong></span>:META-INF/persistence.xml<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSources"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"localDataSource"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"local-db"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"remoteDataSource"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"remote-db"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-comment">&lt;!-- if no datasource is specified, use this one --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"defaultDataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"remoteDataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceUnitManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"pum"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceUnitName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myCustomUnit"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The default implementation allows customization of the <code class="literal">PersistenceUnitInfo</code> instances,
before they are fed to the JPA provider, declaratively through its properties, which
affect <span class="emphasis"><em>all</em></span> hosted units, or programmatically, through the
<code class="literal">PersistenceUnitPostProcessor</code>, which allows persistence unit selection. If no
<code class="literal">PersistenceUnitManager</code> is specified, one is created and used internally by
<code class="literal">LocalContainerEntityManagerFactoryBean</code>.</p>
</div>
</div>
<div class="section" title="14.5.2&nbsp;Implementing DAOs based on plain JPA"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jpa-straight"></a>14.5.2&nbsp;Implementing DAOs based on plain JPA</h3></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Although <code class="literal">EntityManagerFactory</code> instances are thread-safe, <code class="literal">EntityManager</code> instances are
not. The injected JPA <code class="literal">EntityManager</code> behaves like an <code class="literal">EntityManager</code> fetched from an
application server&#8217;s JNDI environment, as defined by the JPA specification. It delegates
all calls to the current transactional <code class="literal">EntityManager</code>, if any; otherwise, it falls back
to a newly created <code class="literal">EntityManager</code> per operation, in effect making its usage thread-safe.</p>
</td></tr></table></div>

<p>It is possible to write code against the plain JPA without any Spring dependencies, by
using an injected <code class="literal">EntityManagerFactory</code> or <code class="literal">EntityManager</code>. Spring can understand
<code class="literal">@PersistenceUnit</code> and <code class="literal">@PersistenceContext</code> annotations both at field and method level
if a <code class="literal">PersistenceAnnotationBeanPostProcessor</code> is enabled. A plain JPA DAO implementation
using the <code class="literal">@PersistenceUnit</code> annotation might look like this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> EntityManagerFactory emf;

    <i><span class="hl-annotation" style="color: gray">@PersistenceUnit</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setEntityManagerFactory(EntityManagerFactory emf) {
        <span class="hl-keyword">this</span>.emf = emf;
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        EntityManager em = <span class="hl-keyword">this</span>.emf.createEntityManager();
        <span class="hl-keyword">try</span> {
            Query query = em.createQuery(<span class="hl-string">"from Product as p where p.category = ?1"</span>);
            query.setParameter(<span class="hl-number">1</span>, category);
            <span class="hl-keyword">return</span> query.getResultList();
        }
        <span class="hl-keyword">finally</span> {
            <span class="hl-keyword">if</span> (em != null) {
                em.close();
            }
        }
    }
}</pre>

<p>The DAO above has no dependency on Spring and still fits nicely into a Spring
application context. Moreover, the DAO takes advantage of annotations to require the
injection of the default <code class="literal">EntityManagerFactory</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-comment">&lt;!-- bean post-processor for JPA annotations --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>As an alternative to defining a <code class="literal">PersistenceAnnotationBeanPostProcessor</code> explicitly,
consider using the Spring <code class="literal">context:annotation-config</code> XML element in your application
context configuration. Doing so automatically registers all Spring standard
post-processors for annotation-based configuration, including
<code class="literal">CommonAnnotationBeanPostProcessor</code> and so on.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-comment">&lt;!-- post-processors for all standard config annotations --&gt;</span>
    <span class="hl-tag">&lt;context:annotation-config/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The main problem with such a DAO is that it always creates a new <code class="literal">EntityManager</code> through
the factory. You can avoid this by requesting a transactional <code class="literal">EntityManager</code> (also
called "shared EntityManager" because it is a shared, thread-safe proxy for the actual
transactional EntityManager) to be injected instead of the factory:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <i><span class="hl-annotation" style="color: gray">@PersistenceContext</span></i>
    <span class="hl-keyword">private</span> EntityManager em;

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        Query query = em.createQuery(<span class="hl-string">"from Product as p where p.category = :category"</span>);
        query.setParameter(<span class="hl-string">"category"</span>, category);
        <span class="hl-keyword">return</span> query.getResultList();
    }
}</pre>

<p>The <code class="literal">@PersistenceContext</code> annotation has an optional attribute <code class="literal">type</code>, which defaults to
<code class="literal">PersistenceContextType.TRANSACTION</code>. This default is what you need to receive a shared
EntityManager proxy. The alternative, <code class="literal">PersistenceContextType.EXTENDED</code>, is a completely
different affair: This results in a so-called extended EntityManager, which is <span class="emphasis"><em>not
thread-safe</em></span> and hence must not be used in a concurrently accessed component such as a
Spring-managed singleton bean. Extended EntityManagers are only supposed to be used in
stateful components that, for example, reside in a session, with the lifecycle of the
EntityManager not tied to a current transaction but rather being completely up to the
application.</p>
<div class="sidebar" title="Method- and field-level Injection"><p class="title"><b>Method- and field-level Injection</b></p>

<p>Annotations that indicate dependency injections (such as <code class="literal">@PersistenceUnit</code> and
<code class="literal">@PersistenceContext</code>) can be applied on field or methods inside a class, hence the
expressions <span class="emphasis"><em>method-level injection</em></span> and <span class="emphasis"><em>field-level injection</em></span>. Field-level
annotations are concise and easier to use while method-level allows for further
processing of the injected dependency. In both cases the member visibility (public,
protected, private) does not matter.</p>
<p>What about class-level annotations?</p>
<p>On the Java EE 5 platform, they are used for dependency declaration and not for resource
injection.</p>
</div>

<p>The injected <code class="literal">EntityManager</code> is Spring-managed (aware of the ongoing transaction). It is
important to note that even though the new DAO implementation uses method level
injection of an <code class="literal">EntityManager</code> instead of an <code class="literal">EntityManagerFactory</code>, no change is
required in the application context XML due to annotation usage.</p>
<p>The main advantage of this DAO style is that it only depends on Java Persistence API; no
import of any Spring class is required. Moreover, as the JPA annotations are understood,
the injections are applied automatically by the Spring container. This is appealing from
a non-invasiveness perspective, and might feel more natural to JPA developers.</p>
</div>
<div class="section" title="14.5.3&nbsp;Transaction Management"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jpa-tx"></a>14.5.3&nbsp;Transaction Management</h3></div></div></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You are <span class="emphasis"><em>strongly</em></span> encouraged to read <a class="xref" href="#transaction-declarative" title="11.5&nbsp;Declarative transaction management">Section&nbsp;11.5, &#8220;Declarative transaction management&#8221;</a> if you have not done
so, to get a more detailed coverage of Spring&#8217;s declarative transaction support.</p>
</td></tr></table></div>

<p>To execute service operations within transactions, you can use Spring&#8217;s common
declarative transaction facilities. For example:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTxManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.JpaTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"entityManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myEmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"productServiceMethods"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* product.ProductService.</span><span class="strong"><strong>(..))"/&gt;
        &lt;aop:advisor advice-ref="txAdvice" pointcut-ref="productServiceMethods"/&gt;
    &lt;/aop:config&gt;

    &lt;tx:advice id="txAdvice" transaction-manager="myTxManager"&gt;
        &lt;tx:attributes&gt;
            &lt;tx:method name="increasePrice</strong></span>" propagation="REQUIRED"/&gt;
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someOtherBusinessMethod"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"SUPPORTS"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Spring JPA allows a configured <code class="literal">JpaTransactionManager</code> to expose a JPA transaction to
JDBC access code that accesses the same JDBC <code class="literal">DataSource</code>, provided that the registered
<code class="literal">JpaDialect</code> supports retrieval of the underlying JDBC <code class="literal">Connection</code>. Out of the box,
Spring provides dialects for the Toplink, Hibernate and OpenJPA JPA implementations. See
the next section for details on the <code class="literal">JpaDialect</code> mechanism.</p>
</div>
<div class="section" title="14.5.4&nbsp;JpaDialect"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jpa-dialect"></a>14.5.4&nbsp;JpaDialect</h3></div></div></div>

<p>As an advanced feature <code class="literal">JpaTemplate</code>, <code class="literal">JpaTransactionManager</code> and subclasses of
<code class="literal">AbstractEntityManagerFactoryBean</code> support a custom <code class="literal">JpaDialect</code>, to be passed into the
<code class="literal">jpaDialect</code> bean property. In such a scenario, the DAOs do not receive an
<code class="literal">EntityManagerFactory</code> reference but rather a full <code class="literal">JpaTemplate</code> instance (for example,
passed into the <code class="literal">jpaTemplate</code> property of <code class="literal">JpaDaoSupport</code>). A <code class="literal">JpaDialect</code>
implementation can enable some advanced features supported by Spring, usually in a
vendor-specific manner:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Applying specific transaction semantics such as custom isolation level or transaction
timeout)
</li><li class="listitem">
Retrieving the transactional JDBC <code class="literal">Connection</code> for exposure to JDBC-based DAOs)
</li><li class="listitem">
Advanced translation of <code class="literal">PersistenceExceptions</code> to Spring <code class="literal">DataAccessExceptions</code>
</li></ul></div>

<p>This is particularly valuable for special transaction semantics and for advanced
translation of exception. The default implementation used ( <code class="literal">DefaultJpaDialect</code>) does
not provide any special capabilities and if the above features are required, you have to
specify the appropriate dialect.</p>
<p>See the <code class="literal">JpaDialect</code> Javadoc for more details of its operations and how they are used
within Spring&#8217;s JPA support.</p>
</div>
</div>
</div>
<div class="chapter" title="15.&nbsp;Marshalling XML using O/X Mappers"><div class="titlepage"><div><div><h2 class="title"><a name="oxm"></a>15.&nbsp;Marshalling XML using O/X Mappers</h2></div></div></div>

<div class="section" title="15.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-introduction"></a>15.1&nbsp;Introduction</h2></div></div></div>

<p>In this chapter, we will describe Spring&#8217;s Object/XML Mapping support. Object/XML
Mapping, or O/X mapping for short, is the act of converting an XML document to and from
an object. This conversion process is also known as XML Marshalling, or XML
Serialization. This chapter uses these terms interchangeably.</p>
<p>Within the field of O/X mapping, a <span class="emphasis"><em>marshaller</em></span> is responsible for serializing an
object (graph) to XML. In similar fashion, an <span class="emphasis"><em>unmarshaller</em></span> deserializes the XML to
an object graph. This XML can take the form of a DOM document, an input or output
stream, or a SAX handler.</p>
<p>Some of the benefits of using Spring for your O/X mapping needs are:</p>
<div class="section" title="15.1.1&nbsp;Ease of configuration"><div class="titlepage"><div><div><h3 class="title"><a name="_ease_of_configuration"></a>15.1.1&nbsp;Ease of configuration</h3></div></div></div>

<p>Spring&#8217;s bean factory makes it easy to configure marshallers, without needing to
construct JAXB context, JiBX binding factories, etc. The marshallers can be configured
as any other bean in your application context. Additionally, XML Schema-based
configuration is available for a number of marshallers, making the configuration even
simpler.</p>
</div>
<div class="section" title="15.1.2&nbsp;Consistent Interfaces"><div class="titlepage"><div><div><h3 class="title"><a name="_consistent_interfaces"></a>15.1.2&nbsp;Consistent Interfaces</h3></div></div></div>

<p>Spring&#8217;s O/X mapping operates through two global interfaces: the <code class="literal">Marshaller</code> and
<code class="literal">Unmarshaller</code> interface. These abstractions allow you to switch O/X mapping frameworks
with relative ease, with little or no changes required on the classes that do the
marshalling. This approach has the additional benefit of making it possible to do XML
marshalling with a mix-and-match approach (e.g. some marshalling performed using JAXB,
other using XMLBeans) in a non-intrusive fashion, leveraging the strength of each
technology.</p>
</div>
<div class="section" title="15.1.3&nbsp;Consistent Exception Hierarchy"><div class="titlepage"><div><div><h3 class="title"><a name="_consistent_exception_hierarchy"></a>15.1.3&nbsp;Consistent Exception Hierarchy</h3></div></div></div>

<p>Spring provides a conversion from exceptions from the underlying O/X mapping tool to its
own exception hierarchy with the <code class="literal">XmlMappingException</code> as the root exception. As can be
expected, these runtime exceptions wrap the original exception so no information is lost.</p>
</div>
</div>
<div class="section" title="15.2&nbsp;Marshaller and Unmarshaller"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-marshaller-unmarshaller"></a>15.2&nbsp;Marshaller and Unmarshaller</h2></div></div></div>

<p>As stated in the introduction, a <span class="emphasis"><em>marshaller</em></span> serializes an object to XML, and an
<span class="emphasis"><em>unmarshaller</em></span> deserializes XML stream to an object. In this section, we will describe
the two Spring interfaces used for this purpose.</p>
<div class="section" title="15.2.1&nbsp;Marshaller"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-marshaller"></a>15.2.1&nbsp;Marshaller</h3></div></div></div>

<p>Spring abstracts all marshalling operations behind the
<code class="literal">org.springframework.oxm.Marshaller</code> interface, the main methods of which is listed
below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Marshaller {

    <b class="hl-tag" style="color: blue">/**
     * Marshals the object graph with the given root into the provided Result.
     */</b>
    <span class="hl-keyword">void</span> marshal(Object graph, Result result) <span class="hl-keyword">throws</span> XmlMappingException, IOException;

}</pre>

<p>The <code class="literal">Marshaller</code> interface has one main method, which marshals the given object to a
given <code class="literal">javax.xml.transform.Result</code>. Result is a tagging interface that basically
represents an XML output abstraction: concrete implementations wrap various XML
representations, as indicated in the table below.</p>
<div class="informaltable"><a name="oxm-marshller-tbl"></a>
  <table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Result implementation</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Wraps XML representation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DOMResult</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org.w3c.dom.Node</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SAXResult</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org.xml.sax.ContentHandler</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">StreamResult</code></p></td><td style="" align="left" valign="top"><p><code class="literal">java.io.File</code>, <code class="literal">java.io.OutputStream</code>, or <code class="literal">java.io.Writer</code></p></td></tr></tbody></table>
</div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Although the <code class="literal">marshal()</code> method accepts a plain object as its first parameter, most
<code class="literal">Marshaller</code> implementations cannot handle arbitrary objects. Instead, an object class
must be mapped in a mapping file, marked with an annotation, registered with the
marshaller, or have a common base class. Refer to the further sections in this chapter
to determine how your O/X technology of choice manages this.</p>
</td></tr></table></div>

</div>
<div class="section" title="15.2.2&nbsp;Unmarshaller"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-unmarshaller"></a>15.2.2&nbsp;Unmarshaller</h3></div></div></div>

<p>Similar to the <code class="literal">Marshaller</code>, there is the <code class="literal">org.springframework.oxm.Unmarshaller</code>
interface.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Unmarshaller {

    <b class="hl-tag" style="color: blue">/**
     * Unmarshals the given provided Source into an object graph.
     */</b>
    Object unmarshal(Source source) <span class="hl-keyword">throws</span> XmlMappingException, IOException;
}</pre>

<p>This interface also has one method, which reads from the given
<code class="literal">javax.xml.transform.Source</code> (an XML input abstraction), and returns the object read. As
with Result, Source is a tagging interface that has three concrete implementations. Each
wraps a different XML representation, as indicated in the table below.</p>
<div class="informaltable"><a name="oxm-unmarshller-tbl"></a>
  <table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Source implementation</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Wraps XML representation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DOMSource</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org.w3c.dom.Node</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SAXSource</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">org.xml.sax.InputSource</code>, and <code class="literal">org.xml.sax.XMLReader</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">StreamSource</code></p></td><td style="" align="left" valign="top"><p><code class="literal">java.io.File</code>, <code class="literal">java.io.InputStream</code>, or <code class="literal">java.io.Reader</code></p></td></tr></tbody></table>
</div>

<p>Even though there are two separate marshalling interfaces ( <code class="literal">Marshaller</code> and
<code class="literal">Unmarshaller</code>), all implementations found in Spring-WS implement both in one class.
This means that you can wire up one marshaller class and refer to it both as a
marshaller and an unmarshaller in your <code class="literal">applicationContext.xml</code>.</p>
</div>
<div class="section" title="15.2.3&nbsp;XmlMappingException"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-xmlmappingexception"></a>15.2.3&nbsp;XmlMappingException</h3></div></div></div>

<p>Spring converts exceptions from the underlying O/X mapping tool to its own exception
hierarchy with the <code class="literal">XmlMappingException</code> as the root exception. As can be expected,
these runtime exceptions wrap the original exception so no information will be lost.</p>
<p>Additionally, the <code class="literal">MarshallingFailureException</code> and <code class="literal">UnmarshallingFailureException</code>
provide a distinction between marshalling and unmarshalling operations, even though the
underlying O/X mapping tool does not do so.</p>
<p>The O/X Mapping exception hierarchy is shown in the following figure:
image::images/oxm-exceptions.png[width=400]</p>
<p>O/X Mapping exception hierarchy</p>
</div>
</div>
<div class="section" title="15.3&nbsp;Using Marshaller and Unmarshaller"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-usage"></a>15.3&nbsp;Using Marshaller and Unmarshaller</h2></div></div></div>

<p>Spring&#8217;s OXM can be used for a wide variety of situations. In the following example, we
will use it to marshal the settings of a Spring-managed application as an XML file. We
will use a simple JavaBean to represent the settings:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Settings {

    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> fooEnabled;

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isFooEnabled() {
        <span class="hl-keyword">return</span> fooEnabled;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setFooEnabled(<span class="hl-keyword">boolean</span> fooEnabled) {
        <span class="hl-keyword">this</span>.fooEnabled = fooEnabled;
    }
}</pre>

<p>The application class uses this bean to store its settings. Besides a main method, the
class has two methods: <code class="literal">saveSettings()</code> saves the settings bean to a file named
<code class="literal">settings.xml</code>, and <code class="literal">loadSettings()</code> loads these settings again. A <code class="literal">main()</code> method
constructs a Spring application context, and calls these two methods.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> java.io.FileInputStream;
<span class="hl-keyword">import</span> java.io.FileOutputStream;
<span class="hl-keyword">import</span> java.io.IOException;
<span class="hl-keyword">import</span> javax.xml.transform.stream.StreamResult;
<span class="hl-keyword">import</span> javax.xml.transform.stream.StreamSource;

<span class="hl-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;
<span class="hl-keyword">import</span> org.springframework.oxm.Marshaller;
<span class="hl-keyword">import</span> org.springframework.oxm.Unmarshaller;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Application {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String FILE_NAME = <span class="hl-string">"settings.xml"</span>;
    <span class="hl-keyword">private</span> Settings settings = <span class="hl-keyword">new</span> Settings();
    <span class="hl-keyword">private</span> Marshaller marshaller;
    <span class="hl-keyword">private</span> Unmarshaller unmarshaller;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMarshaller(Marshaller marshaller) {
        <span class="hl-keyword">this</span>.marshaller = marshaller;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setUnmarshaller(Unmarshaller unmarshaller) {
        <span class="hl-keyword">this</span>.unmarshaller = unmarshaller;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> saveSettings() <span class="hl-keyword">throws</span> IOException {
        FileOutputStream os = null;
        <span class="hl-keyword">try</span> {
            os = <span class="hl-keyword">new</span> FileOutputStream(FILE_NAME);
            <span class="hl-keyword">this</span>.marshaller.marshal(settings, <span class="hl-keyword">new</span> StreamResult(os));
        } <span class="hl-keyword">finally</span> {
            <span class="hl-keyword">if</span> (os != null) {
                os.close();
            }
        }
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> loadSettings() <span class="hl-keyword">throws</span> IOException {
        FileInputStream is = null;
        <span class="hl-keyword">try</span> {
            is = <span class="hl-keyword">new</span> FileInputStream(FILE_NAME);
            <span class="hl-keyword">this</span>.settings = (Settings) <span class="hl-keyword">this</span>.unmarshaller.unmarshal(<span class="hl-keyword">new</span> StreamSource(is));
        } <span class="hl-keyword">finally</span> {
            <span class="hl-keyword">if</span> (is != null) {
                is.close();
            }
        }
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) <span class="hl-keyword">throws</span> IOException {
        ApplicationContext appContext =
                <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"applicationContext.xml"</span>);
        Application application = (Application) appContext.getBean(<span class="hl-string">"application"</span>);
        application.saveSettings();
        application.loadSettings();
    }
}</pre>

<p>The <code class="literal">Application</code> requires both a <code class="literal">marshaller</code> and <code class="literal">unmarshaller</code> property to be set. We
can do so using the following <code class="literal">applicationContext.xml</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"application"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"Application"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"castorMarshaller"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"unmarshaller"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"castorMarshaller"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"castorMarshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.castor.CastorMarshaller"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>This application context uses Castor, but we could have used any of the other marshaller
instances described later in this chapter. Note that Castor does not require any further
configuration by default, so the bean definition is rather simple. Also note that the
<code class="literal">CastorMarshaller</code> implements both <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code>, so we can refer to the
<code class="literal">castorMarshaller</code> bean in both the <code class="literal">marshaller</code> and <code class="literal">unmarshaller</code> property of the
application.</p>
<p>This sample application produces the following <code class="literal">settings.xml</code> file:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;settings</span> <span class="hl-attribute">foo-enabled</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="15.4&nbsp;XML Schema-based Configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-schema-based-config"></a>15.4&nbsp;XML Schema-based Configuration</h2></div></div></div>

<p>Marshallers could be configured more concisely using tags from the OXM namespace. To
make these tags available, the appropriate schema has to be referenced first in the
preamble of the XML configuration file. Note the <span class="emphasis"><em>oxm</em></span> related text below:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="strong"><strong>xmlns:oxm="http://www.springframework.org/schema/oxm"</strong></span> xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd <span class="strong"><strong>http://www.springframework.org/schema/oxm http://www.springframework.org/schema/oxm/spring-oxm.xsd"</strong></span>&gt;</pre>

<p>Currently, the following tags are available:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="link" href="#oxm-jaxb2-xsd" title="XML Schema-based Configuration"><code class="literal">jaxb2-marshaller</code></a>
</li><li class="listitem">
<a class="link" href="#oxm-xmlbeans-xsd" title="XML Schema-based Configuration"><code class="literal">xmlbeans-marshaller</code></a>
</li><li class="listitem">
<a class="link" href="#oxm-castor-xsd" title="XML Schema-based Configuration"><code class="literal">castor-marshaller</code></a>
</li><li class="listitem">
<a class="link" href="#oxm-jibx-xsd" title="XML Schema-based Configuration"><code class="literal">jibx-marshaller</code></a>
</li></ul></div>

<p>Each tag will be explained in its respective marshaller&#8217;s section. As an example though,
here is how the configuration of a JAXB2 marshaller might look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;oxm:jaxb2-marshaller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">contextPath</span>=<span class="hl-value">"org.springframework.ws.samples.airline.schema"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="15.5&nbsp;JAXB"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-jaxb"></a>15.5&nbsp;JAXB</h2></div></div></div>

<p>The JAXB binding compiler translates a W3C XML Schema into one or more Java classes, a
<code class="literal">jaxb.properties</code> file, and possibly some resource files. JAXB also offers a way to
generate a schema from annotated Java classes.</p>
<p>Spring supports the JAXB 2.0 API as XML marshalling strategies, following the
<code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code> interfaces described in <a class="xref" href="#oxm-marshaller-unmarshaller" title="15.2&nbsp;Marshaller and Unmarshaller">Section&nbsp;15.2, &#8220;Marshaller and Unmarshaller&#8221;</a>.
The corresponding integration classes reside in the <code class="literal">org.springframework.oxm.jaxb</code>
package.</p>
<div class="section" title="15.5.1&nbsp;Jaxb2Marshaller"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-jaxb2"></a>15.5.1&nbsp;Jaxb2Marshaller</h3></div></div></div>

<p>The <code class="literal">Jaxb2Marshaller</code> class implements both the Spring <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code>
interface. It requires a context path to operate, which you can set using the
<code class="literal">contextPath</code> property. The context path is a list of colon (:) separated Java package
names that contain schema derived classes. It also offers a <code class="literal">classesToBeBound</code> property,
which allows you to set an array of classes to be supported by the marshaller. Schema
validation is performed by specifying one or more schema resource to the bean, like so:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jaxb2Marshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.jaxb.Jaxb2Marshaller"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"classesToBeBound"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>org.springframework.oxm.jaxb.Flight<span class="hl-tag">&lt;/value&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>org.springframework.oxm.jaxb.Flights<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"schema"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:org/springframework/oxm/schema.xsd"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    ...

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="section" title="XML Schema-based Configuration"><div class="titlepage"><div><div><h4 class="title"><a name="oxm-jaxb2-xsd"></a>XML Schema-based Configuration</h4></div></div></div>

<p>The <code class="literal">jaxb2-marshaller</code> tag configures a <code class="literal">org.springframework.oxm.jaxb.Jaxb2Marshaller</code>.
Here is an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;oxm:jaxb2-marshaller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">contextPath</span>=<span class="hl-value">"org.springframework.ws.samples.airline.schema"</span><span class="hl-tag">/&gt;</span></pre>

<p>Alternatively, the list of classes to bind can be provided to the marshaller via the
<code class="literal">class-to-be-bound</code> child tag:</p>
<pre class="programlisting"><span class="hl-tag">&lt;oxm:jaxb2-marshaller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshaller"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;oxm:class-to-be-bound</span> <span class="hl-attribute">name</span>=<span class="hl-value">"org.springframework.ws.samples.airline.schema.Airport"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;oxm:class-to-be-bound</span> <span class="hl-attribute">name</span>=<span class="hl-value">"org.springframework.ws.samples.airline.schema.Flight"</span><span class="hl-tag">/&gt;</span>
    ...
<span class="hl-tag">&lt;/oxm:jaxb2-marshaller&gt;</span></pre>

<p>Available attributes are:</p>
<div class="informaltable">
  <table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Required</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">id</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>the id of the marshaller</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">contextPath</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>the JAXB Context path</p></td><td style="" align="left" valign="top"><p>no</p></td></tr></tbody></table>
</div>

</div>
</div>
</div>
<div class="section" title="15.6&nbsp;Castor"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-castor"></a>15.6&nbsp;Castor</h2></div></div></div>

<p>Castor XML mapping is an open source XML binding framework. It allows you to transform
the data contained in a java object model into/from an XML document. By default, it does
not require any further configuration, though a mapping file can be used to have more
control over the behavior of Castor.</p>
<p>For more information on Castor, refer to the
<a class="ulink" href="http://castor.codehaus.org/xml-framework.html" target="_top"><span class="emphasis"><em>Castor web site</em></span></a>. The Spring
integration classes reside in the <code class="literal">org.springframework.oxm.castor</code> package.</p>
<div class="section" title="15.6.1&nbsp;CastorMarshaller"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-castor-marshaller"></a>15.6.1&nbsp;CastorMarshaller</h3></div></div></div>

<p>As with JAXB, the <code class="literal">CastorMarshaller</code> implements both the <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code>
interface. It can be wired up as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"castorMarshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.castor.CastorMarshaller"</span><span class="hl-tag"> /&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="15.6.2&nbsp;Mapping"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-castor-mapping"></a>15.6.2&nbsp;Mapping</h3></div></div></div>

<p>Although it is possible to rely on Castor&#8217;s default marshalling behavior, it might be
necessary to have more control over it. This can be accomplished using a Castor mapping
file. For more information, refer to <a class="ulink" href="http://castor.codehaus.org/xml-mapping.html" target="_top">Castor
XML Mapping</a>.</p>
<p>The mapping can be set using the <code class="literal">mappingLocation</code> resource property, indicated below
with a classpath resource.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"castorMarshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.castor.CastorMarshaller"</span><span class="hl-tag"> &gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingLocation"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:mapping.xml"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="section" title="XML Schema-based Configuration"><div class="titlepage"><div><div><h4 class="title"><a name="oxm-castor-xsd"></a>XML Schema-based Configuration</h4></div></div></div>

<p>The <code class="literal">castor-marshaller</code> tag configures a
<code class="literal">org.springframework.oxm.castor.CastorMarshaller</code>. Here is an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;oxm:castor-marshaller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">mapping-location</span>=<span class="hl-value">"classpath:org/springframework/oxm/castor/mapping.xml"</span><span class="hl-tag">/&gt;</span></pre>

<p>The marshaller instance can be configured in two ways, by specifying either the location
of a mapping file (through the <code class="literal">mapping-location</code> property), or by identifying Java
POJOs (through the <code class="literal">target-class</code> or <code class="literal">target-package</code> properties) for which there exist
corresponding XML descriptor classes. The latter way is usually used in conjunction with
XML code generation from XML schemas.</p>
<p>Available attributes are:</p>
<div class="informaltable">
  <table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Required</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">id</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>the id of the marshaller</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">encoding</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>the encoding to use for unmarshalling from XML</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">target-class</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>a Java class name for a POJO for which an XML class descriptor is available (as
  generated through code generation)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">target-package</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>a Java package name that identifies a package that contains POJOs and their
  corresponding Castor XML descriptor classes (as generated through code generation from
  XML schemas)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">mapping-location</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>location of a Castor XML mapping file</p></td><td style="" align="left" valign="top"><p>no</p></td></tr></tbody></table>
</div>

</div>
</div>
</div>
<div class="section" title="15.7&nbsp;XMLBeans"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-xmlbeans"></a>15.7&nbsp;XMLBeans</h2></div></div></div>

<p>XMLBeans is an XML binding tool that has full XML Schema support, and offers full XML
Infoset fidelity. It takes a different approach to that of most other O/X mapping
frameworks, in that all classes that are generated from an XML Schema are all derived
from <code class="literal">XmlObject</code>, and contain XML binding information in them.</p>
<p>For more information on XMLBeans, refer to the <a class="ulink" href="http://xmlbeans.apache.org/" target="_top"><span class="emphasis"><em>XMLBeans
web site </em></span></a>. The Spring-WS integration classes reside in the
<code class="literal">org.springframework.oxm.xmlbeans</code> package.</p>
<div class="section" title="15.7.1&nbsp;XmlBeansMarshaller"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-xmlbeans-marshaller"></a>15.7.1&nbsp;XmlBeansMarshaller</h3></div></div></div>

<p>The <code class="literal">XmlBeansMarshaller</code> implements both the <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code> interfaces.
It can be configured as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xmlBeansMarshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.xmlbeans.XmlBeansMarshaller"</span><span class="hl-tag"> /&gt;</span>
    ...

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Note that the <code class="literal">XmlBeansMarshaller</code> can only marshal objects of type <code class="literal">XmlObject</code>, and not
every <code class="literal">java.lang.Object</code>.</p>
</td></tr></table></div>

<div class="section" title="XML Schema-based Configuration"><div class="titlepage"><div><div><h4 class="title"><a name="oxm-xmlbeans-xsd"></a>XML Schema-based Configuration</h4></div></div></div>

<p>The <code class="literal">xmlbeans-marshaller</code> tag configures a
<code class="literal">org.springframework.oxm.xmlbeans.XmlBeansMarshaller</code>. Here is an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;oxm:xmlbeans-marshaller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshaller"</span><span class="hl-tag">/&gt;</span></pre>

<p>Available attributes are:</p>
<div class="informaltable">
  <table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Required</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">id</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>the id of the marshaller</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">options</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>the bean name of the XmlOptions that is to be used for this marshaller. Typically a
  <code class="literal">XmlOptionsFactoryBean</code> definition</p></td><td style="" align="left" valign="top"><p>no</p></td></tr></tbody></table>
</div>

</div>
</div>
</div>
<div class="section" title="15.8&nbsp;JiBX"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-jibx"></a>15.8&nbsp;JiBX</h2></div></div></div>

<p>The JiBX framework offers a solution similar to that which JDO provides for ORM: a
binding definition defines the rules for how your Java objects are converted to or from
XML. After preparing the binding and compiling the classes, a JiBX binding compiler
enhances the class files, and adds code to handle converting instances of the classes
from or to XML.</p>
<p>For more information on JiBX, refer to the <a class="ulink" href="http://jibx.sourceforge.net/" target="_top"><span class="emphasis"><em>JiBX web
site</em></span></a>. The Spring integration classes reside in the <code class="literal">org.springframework.oxm.jibx</code>
package.</p>
<div class="section" title="15.8.1&nbsp;JibxMarshaller"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-jibx-marshaller"></a>15.8.1&nbsp;JibxMarshaller</h3></div></div></div>

<p>The <code class="literal">JibxMarshaller</code> class implements both the <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code>
interface. To operate, it requires the name of the class to marshal in, which you can
set using the <code class="literal">targetClass</code> property. Optionally, you can set the binding name using the
<code class="literal">bindingName</code> property. In the next sample, we bind the <code class="literal">Flights</code> class:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jibxFlightsMarshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.jibx.JibxMarshaller"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetClass"</span><span class="hl-tag">&gt;</span>org.springframework.oxm.jibx.Flights<span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>A <code class="literal">JibxMarshaller</code> is configured for a single class. If you want to marshal multiple
classes, you have to configure multiple <code class="literal">JibxMarshaller</code> s with different <code class="literal">targetClass</code>
property values.</p>
<div class="section" title="XML Schema-based Configuration"><div class="titlepage"><div><div><h4 class="title"><a name="oxm-jibx-xsd"></a>XML Schema-based Configuration</h4></div></div></div>

<p>The <code class="literal">jibx-marshaller</code> tag configures a <code class="literal">org.springframework.oxm.jibx.JibxMarshaller</code>.
Here is an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;oxm:jibx-marshaller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">target-class</span>=<span class="hl-value">"org.springframework.ws.samples.airline.schema.Flight"</span><span class="hl-tag">/&gt;</span></pre>

<p>Available attributes are:</p>
<div class="informaltable">
  <table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Required</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">id</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>the id of the marshaller</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">target-class</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>the target class for this marshaller</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>yes</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">bindingName</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>the binding name used by this marshaller</p></td><td style="" align="left" valign="top"><p>no</p></td></tr></tbody></table>
</div>

</div>
</div>
</div>
<div class="section" title="15.9&nbsp;XStream"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oxm-xstream"></a>15.9&nbsp;XStream</h2></div></div></div>

<p>XStream is a simple library to serialize objects to XML and back again. It does not
require any mapping, and generates clean XML.</p>
<p>For more information on XStream, refer to the <a class="ulink" href="http://xstream.codehaus.org/" target="_top"><span class="emphasis"><em>XStream
web site</em></span></a>. The Spring integration classes reside in the
<code class="literal">org.springframework.oxm.xstream</code> package.</p>
<div class="section" title="15.9.1&nbsp;XStreamMarshaller"><div class="titlepage"><div><div><h3 class="title"><a name="oxm-xstream-marshaller"></a>15.9.1&nbsp;XStreamMarshaller</h3></div></div></div>

<p>The <code class="literal">XStreamMarshaller</code> does not require any configuration, and can be configured in an
application context directly. To further customize the XML, you can set an<span class="emphasis"><em>alias map</em></span>,
which consists of string aliases mapped to classes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xstreamMarshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.xstream.XStreamMarshaller"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"aliases"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;props&gt;</span>
                <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"Flight"</span><span class="hl-tag">&gt;</span>org.springframework.oxm.xstream.Flight<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;/props&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>By default, XStream allows for arbitrary classes to be unmarshalled, which can result in
security vulnerabilities. As such, it is <span class="emphasis"><em>not recommended to use the
<code class="literal">XStreamMarshaller</code> to unmarshal XML from external sources</em></span> (i.e. the Web), as this can
result in <span class="emphasis"><em>security vulnerabilities</em></span>. If you do use the <code class="literal">XStreamMarshaller</code> to
unmarshal XML from an external source, set the <code class="literal">supportedClasses</code> property on the
<code class="literal">XStreamMarshaller</code>, like so:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xstreamMarshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.xstream.XStreamMarshaller"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"supportedClasses"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.oxm.xstream.Flight"</span><span class="hl-tag">/&gt;</span>
    ...
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This will make sure that only the registered classes are eligible for unmarshalling.</p>
<p>Additionally, you can register
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/oxm/xstream/XStreamMarshaller.html#setConverters(com.thoughtworks.xstream.converters.ConverterMatcher%E2%80%A6)" target="_top">custom
converters</a> to make sure that only your supported classes can be unmarshalled. You might
want to add a <code class="literal">CatchAllConverter</code> as the last converter in the list, in addition to
converters that explicitly support the domain classes that should be supported. As a
result, default XStream converters with lower priorities and possible security
vulnerabilities do not get invoked.</p>
</td></tr></table></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Note that XStream is an XML serialization library, not a data binding library.
Therefore, it has limited namespace support. As such, it is rather unsuitable for usage
within Web services.</p>
</td></tr></table></div>

</div>
</div>
</div>
</div>
<div class="part" title="Part&nbsp;V.&nbsp;The Web"><div class="titlepage"><div><div><h1 class="title"><a name="spring-web"></a>Part&nbsp;V.&nbsp;The Web</h1></div></div></div>

<div class="partintro" title="The Web"><div></div>
<p>This part of the reference documentation covers Spring Framework&#8217;s support for the
presentation tier (and specifically web-based presentation tiers) including support
for WebSocket-style messaging in web applications.</p>
<p>Spring Framework&#8217;s own web framework, <a class="link" href="#mvc" title="16.&nbsp;Web MVC framework">Spring Web MVC</a>, is covered in the
first couple of chapters. Subsequent chapters are concerned with Spring Framework&#8217;s
integration with other web technologies, such as <a class="link" href="#struts" title="18.4&nbsp;Apache Struts 2.x">Struts</a> <a class="link" href="#jsf" title="18.3&nbsp;JavaServer Faces 1.2">JSF</a> and
others.</p>
<p>Following that is coverage of Spring Framework&#8217;s MVC <a class="link" href="#portlet" title="19.&nbsp;Portlet MVC Framework">portlet framework</a>.</p>
<p>The section then concludes with comprehensive coverage of the Spring Framework
<a class="xref" href="#websocket" title="20.&nbsp;WebSocket Support">Chapter&nbsp;20, <i>WebSocket Support</i></a> (including <a class="xref" href="#websocket-stomp" title="20.4&nbsp;STOMP Messaging">Section&nbsp;20.4, &#8220;STOMP Messaging&#8221;</a>).</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#mvc" title="16.&nbsp;Web MVC framework">Chapter&nbsp;16, <i>Web MVC framework</i></a>
</li><li class="listitem">
<a class="xref" href="#view" title="17.&nbsp;View technologies">Chapter&nbsp;17, <i>View technologies</i></a>
</li><li class="listitem">
<a class="xref" href="#web-integration" title="18.&nbsp;Integrating with other web frameworks">Chapter&nbsp;18, <i>Integrating with other web frameworks</i></a>
</li><li class="listitem">
<a class="xref" href="#portlet" title="19.&nbsp;Portlet MVC Framework">Chapter&nbsp;19, <i>Portlet MVC Framework</i></a>
</li><li class="listitem">
<a class="xref" href="#websocket" title="20.&nbsp;WebSocket Support">Chapter&nbsp;20, <i>WebSocket Support</i></a>
</li></ul></div>

</div>
<div class="chapter" title="16.&nbsp;Web MVC framework"><div class="titlepage"><div><div><h2 class="title"><a name="mvc"></a>16.&nbsp;Web MVC framework</h2></div></div></div>

<div class="section" title="16.1&nbsp;Introduction to Spring Web MVC framework"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-introduction"></a>16.1&nbsp;Introduction to Spring Web MVC framework</h2></div></div></div>

<p>The Spring Web model-view-controller (MVC) framework is designed around a
<code class="literal">DispatcherServlet</code> that dispatches requests to handlers, with configurable handler
mappings, view resolution, locale, time zone and theme resolution as well as support for
uploading files. The default handler is based on the <code class="literal">@Controller</code> and <code class="literal">@RequestMapping</code>
annotations, offering a wide range of flexible handling methods. With the introduction
of Spring 3.0, the <code class="literal">@Controller</code> mechanism also allows you to create RESTful Web sites
and applications, through the <code class="literal">@PathVariable</code> annotation and other features.</p>
<div class="sidebar"><p class="title"><b></b></p>
<p>"Open for extension&#8230;"
A key design principle in Spring Web MVC and in Spring in general is the "<span class="emphasis"><em>Open for
extension, closed for modification</em></span>" principle.</p>
<p>Some methods in the core classes of Spring Web MVC are marked <code class="literal">final</code>. As a developer
you cannot override these methods to supply your own behavior. This has not been done
arbitrarily, but specifically with this principle in mind.</p>
<p>For an explanation of this principle, refer to <span class="emphasis"><em>Expert Spring Web MVC and Web Flow</em></span> by
Seth Ladd and others; specifically see the section "A Look At Design," on page 117 of
the first edition. Alternatively, see</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="ulink" href="http://www.objectmentor.com/resources/articles/ocp.pdf" target="_top">Bob Martin, The Open-Closed
Principle (PDF)</a>
</li></ul></div>

<p>You cannot add advice to final methods when you use Spring MVC. For example, you cannot
add advice to the <code class="literal">AbstractController.setSynchronizeOnSession()</code> method. Refer to
<a class="xref" href="#aop-understanding-aop-proxies" title="8.6.1&nbsp;Understanding AOP proxies">Section&nbsp;8.6.1, &#8220;Understanding AOP proxies&#8221;</a> for more information on AOP proxies and why you cannot
add advice to final methods.</p>
</div>

<p>In Spring Web MVC you can use any object as a command or form-backing object; you do not
need to implement a framework-specific interface or base class. Spring&#8217;s data binding is
highly flexible: for example, it treats type mismatches as validation errors that can be
evaluated by the application, not as system errors. Thus you need not duplicate your
business objects' properties as simple, untyped strings in your form objects simply to
handle invalid submissions, or to convert the Strings properly. Instead, it is often
preferable to bind directly to your business objects.</p>
<p>Spring&#8217;s view resolution is extremely flexible. A <code class="literal">Controller</code> is typically responsible
for preparing a model <code class="literal">Map</code> with data and selecting a view name but it can also write
directly to the response stream and complete the request. View name resolution is highly
configurable through file extension or Accept header content type negotiation, through
bean names, a properties file, or even a custom <code class="literal">ViewResolver</code> implementation. The model
(the M in MVC) is a <code class="literal">Map</code> interface, which allows for the complete abstraction of the
view technology. You can integrate directly with template based rendering technologies
such as JSP, Velocity and Freemarker, or directly generate XML, JSON, Atom, and many
other types of content. The model <code class="literal">Map</code> is simply transformed into an appropriate
format, such as JSP request attributes, a Velocity template model.</p>
<div class="section" title="16.1.1&nbsp;Features of Spring Web MVC"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-features"></a>16.1.1&nbsp;Features of Spring Web MVC</h3></div></div></div>

<div class="sidebar" title="Spring Web Flow"><p class="title"><b>Spring Web Flow</b></p>

<p>Spring Web Flow (SWF) aims to be the best solution for the management of web application
page flow.</p>
<p>SWF integrates with existing frameworks like Spring MVC, Struts, and JSF, in both
servlet and portlet environments. If you have a business process (or processes) that
would benefit from a conversational model as opposed to a purely request model, then SWF
may be the solution.</p>
<p>SWF allows you to capture logical page flows as self-contained modules that are reusable
in different situations, and as such is ideal for building web application modules that
guide the user through controlled navigations that drive business processes.</p>
<p>For more information about SWF, consult the
<a class="ulink" href="http://projects.spring.io/spring-webflow/" target="_top">Spring Web Flow website</a>.</p>
</div>

<p>Spring&#8217;s web module includes many unique web support features:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>Clear separation of roles</em></span>. Each role&#8201;&#8212;&#8201;controller, validator, command object,
form object, model object, <code class="literal">DispatcherServlet</code>, handler mapping, view resolver, and so
on&#8201;&#8212;&#8201;can be fulfilled by a specialized object.
</li><li class="listitem">
<span class="emphasis"><em>Powerful and straightforward configuration of both framework and application classes
as JavaBeans</em></span>. This configuration capability includes easy referencing across
contexts, such as from web controllers to business objects and validators.
</li><li class="listitem">
<span class="emphasis"><em>Adaptability, non-intrusiveness, and flexibility.</em></span> Define any controller method
signature you need, possibly using one of the parameter annotations (such as
@RequestParam, @RequestHeader, @PathVariable, and more) for a given scenario.
</li><li class="listitem">
<span class="emphasis"><em>Reusable business code, no need for duplication</em></span>. Use existing business objects
as command or form objects instead of mirroring them to extend a particular framework
base class.
</li><li class="listitem">
<span class="emphasis"><em>Customizable binding and validation</em></span>. Type mismatches as application-level
validation errors that keep the offending value, localized date and number binding,
and so on instead of String-only form objects with manual parsing and conversion to
business objects.
</li><li class="listitem">
<span class="emphasis"><em>Customizable handler mapping and view resolution</em></span>. Handler mapping and view
resolution strategies range from simple URL-based configuration, to sophisticated,
purpose-built resolution strategies. Spring is more flexible than web MVC frameworks
that mandate a particular technique.
</li><li class="listitem">
<span class="emphasis"><em>Flexible model transfer</em></span>. Model transfer with a name/value <code class="literal">Map</code> supports easy
integration with any view technology.
</li><li class="listitem">
<span class="emphasis"><em>Customizable locale, time zone and theme resolution, support for JSPs with or without
Spring tag library, support for JSTL, support for Velocity without the need for extra
bridges, and so on.</em></span>
</li><li class="listitem">
<span class="emphasis"><em>A simple yet powerful JSP tag library known as the Spring tag library that provides
support for features such as data binding and themes</em></span>. The custom tags allow for
maximum flexibility in terms of markup code. For information on the tag library
descriptor, see the appendix entitled <a class="xref" href="#spring.tld" title="35.&nbsp;spring.tld">Chapter&nbsp;35, <i>spring.tld</i></a>
</li><li class="listitem">
<span class="emphasis"><em>A JSP form tag library, introduced in Spring 2.0, that makes writing forms in JSP
pages much easier.</em></span> For information on the tag library descriptor, see the appendix
entitled <a class="xref" href="#spring-form.tld" title="36.&nbsp;spring-form.tld">Chapter&nbsp;36, <i>spring-form.tld</i></a>
</li><li class="listitem">
<span class="emphasis"><em>Beans whose lifecycle is scoped to the current HTTP request or HTTP <code class="literal">Session</code>.</em></span>
This is not a specific feature of Spring MVC itself, but rather of the
<code class="literal">WebApplicationContext</code> container(s) that Spring MVC uses. These bean scopes are
described in <a class="xref" href="#beans-factory-scopes-other" title="4.5.4&nbsp;Request, session, and global session scopes">Section&nbsp;4.5.4, &#8220;Request, session, and global session scopes&#8221;</a>
</li></ul></div>

</div>
<div class="section" title="16.1.2&nbsp;Pluggability of other MVC implementations"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-introduction-pluggability"></a>16.1.2&nbsp;Pluggability of other MVC implementations</h3></div></div></div>

<p>Non-Spring MVC implementations are preferable for some projects. Many teams expect to
leverage their existing investment in skills and tools. A large body of knowledge and
experience exist for the Struts framework. If you can abide Struts' architectural flaws,
it can be a viable choice for the web layer; the same applies to JSF and other web
MVC frameworks.</p>
<p>If you do not want to use Spring&#8217;s web MVC, but intend to leverage other solutions that
Spring offers, you can integrate the web MVC framework of your choice with Spring
easily. Simply start up a Spring root application context through its
<code class="literal">ContextLoaderListener</code>, and access it through its <code class="literal">ServletContext</code> attribute (or
Spring&#8217;s respective helper method) from within a Struts action. No "plug-ins"
are involved, so no dedicated integration is necessary. From the web layer&#8217;s point of
view, you simply use Spring as a library, with the root application context instance as
the entry point.</p>
<p>Your registered beans and Spring&#8217;s services can be at your fingertips even without
Spring&#8217;s Web MVC. Spring does not compete with Struts in this scenario. It
simply addresses the many areas that the pure web MVC frameworks do not, from bean
configuration to data access and transaction handling. So you can enrich your
application with a Spring middle tier and/or data access tier, even if you just want to
use, for example, the transaction abstraction with JDBC or Hibernate.</p>
</div>
</div>
<div class="section" title="16.2&nbsp;The DispatcherServlet"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-servlet"></a>16.2&nbsp;The DispatcherServlet</h2></div></div></div>

<p>Spring&#8217;s web MVC framework is, like many other web MVC frameworks, request-driven,
designed around a central Servlet that dispatches requests to controllers and offers
other functionality that facilitates the development of web applications. Spring&#8217;s
<code class="literal">DispatcherServlet</code> however, does more than just that. It is completely integrated with
the Spring IoC container and as such allows you to use every other feature that Spring
has.</p>
<p>The request processing workflow of the Spring Web MVC <code class="literal">DispatcherServlet</code> is illustrated
in the following diagram. The pattern-savvy reader will recognize that the
<code class="literal">DispatcherServlet</code> is an expression of the "Front Controller" design pattern (this is a
pattern that Spring Web MVC shares with many other leading web frameworks).</p>
<div class="figure"><a name="d4e12864"></a><p class="title"><b>Figure&nbsp;16.1.&nbsp;</b></p><div class="figure-contents">
  <div class="mediaobject"><img src="images/mvc.png" alt="mvc"></div>
</div></div><br class="figure-break">

<p>The request processing workflow in Spring Web MVC (high level)</p>
<p>The <code class="literal">DispatcherServlet</code> is an actual <code class="literal">Servlet</code> (it inherits from the <code class="literal">HttpServlet</code> base
class), and as such is declared in the <code class="literal">web.xml</code> of your web application. You need to
map requests that you want the <code class="literal">DispatcherServlet</code> to handle, by using a URL mapping in
the same <code class="literal">web.xml</code> file. This is standard Java EE Servlet configuration; the following
example shows such a <code class="literal">DispatcherServlet</code> declaration and mapping:</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app&gt;</span>
    <span class="hl-tag">&lt;servlet&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>example<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
        <span class="hl-tag">&lt;load-on-startup&gt;</span>1<span class="hl-tag">&lt;/load-on-startup&gt;</span>
    <span class="hl-tag">&lt;/servlet&gt;</span>

    <span class="hl-tag">&lt;servlet-mapping&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>example<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;url-pattern&gt;</span>/example/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
    <span class="hl-tag">&lt;/servlet-mapping&gt;</span>

<span class="hl-tag">&lt;/web-app&gt;</span></pre>

<p>In the preceding example, all requests starting with <code class="literal">/example</code> will be handled by the
<code class="literal">DispatcherServlet</code> instance named <code class="literal">example</code>. In a Servlet 3.0+ environment, you also
have the option of configuring the Servlet container programmatically. Below is the code
based equivalent of the above <code class="literal">web.xml</code> example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebApplicationInitializer <span class="hl-keyword">implements</span> WebApplicationInitializer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onStartup(ServletContext container) {
        ServletRegistration.Dynamic registration = container.addServlet(<span class="hl-string">"dispatcher"</span>, <span class="hl-keyword">new</span> DispatcherServlet());
        registration.setLoadOnStartup(<span class="hl-number">1</span>);
        registration.addMapping(<span class="hl-string">"/example/*"</span>);
    }

}</pre>

<p><code class="literal">WebApplicationInitializer</code> is an interface provided by Spring MVC that ensures your
code-based configuration is detected and automatically used to initialize any Servlet 3
container. An abstract base class implementation of this interace named
<code class="literal">AbstractDispatcherServletInitializer</code> makes it even easier to register the
<code class="literal">DispatcherServlet</code> by simply specifying its servlet mapping.
See <a class="link" href="#mvc-container-config" title="16.15&nbsp;Code-based Servlet container initialization">Code-based Servlet container initialization</a> for more details.</p>
<p>The above is only the first step in setting up Spring Web MVC. You now need to configure
the various beans used by the Spring Web MVC framework (over and above the
<code class="literal">DispatcherServlet</code> itself).</p>
<p>As detailed in <a class="xref" href="#context-introduction" title="4.16&nbsp;Additional Capabilities of the ApplicationContext">Section&nbsp;4.16, &#8220;Additional Capabilities of the ApplicationContext&#8221;</a>, <code class="literal">ApplicationContext</code> instances in Spring can be
scoped. In the Web MVC framework, each <code class="literal">DispatcherServlet</code> has its own
<code class="literal">WebApplicationContext</code>, which inherits all the beans already defined in the root
<code class="literal">WebApplicationContext</code>. These inherited beans can be overridden in the servlet-specific
scope, and you can define new scope-specific beans local to a given Servlet instance.</p>
<div class="figure"><a name="d4e12899"></a><p class="title"><b>Figure&nbsp;16.2.&nbsp;Context hierarchy in Spring Web MVC</b></p><div class="figure-contents">

  <div class="mediaobject"><img src="images/mvc-contexts.gif" alt="mvc contexts"></div>
</div></div><br class="figure-break">

<p>Upon initialization of a <code class="literal">DispatcherServlet</code>, Spring MVC looks for a file named
<span class="emphasis"><em>[servlet-name]-servlet.xml</em></span> in the <code class="literal">WEB-INF</code> directory of your web application and
creates the beans defined there, overriding the definitions of any beans defined with
the same name in the global scope.</p>
<p>Consider the following <code class="literal">DispatcherServlet</code> Servlet configuration (in the <code class="literal">web.xml</code> file):</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app&gt;</span>
    <span class="hl-tag">&lt;servlet&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span><span class="strong"><strong>golfing</strong></span><span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
        <span class="hl-tag">&lt;load-on-startup&gt;</span>1<span class="hl-tag">&lt;/load-on-startup&gt;</span>
    <span class="hl-tag">&lt;/servlet&gt;</span>
    <span class="hl-tag">&lt;servlet-mapping&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span><span class="strong"><strong>golfing</strong></span><span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;url-pattern&gt;</span>/golfing/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
    <span class="hl-tag">&lt;/servlet-mapping&gt;</span>
<span class="hl-tag">&lt;/web-app&gt;</span></pre>

<p>With the above Servlet configuration in place, you will need to have a file called
<code class="literal">/WEB-INF/golfing-servlet.xml</code> in your application; this file will contain all of your
Spring Web MVC-specific components (beans). You can change the exact location of this
configuration file through a Servlet initialization parameter (see below for details).</p>
<p>The <code class="literal">WebApplicationContext</code> is an extension of the plain <code class="literal">ApplicationContext</code> that has
some extra features necessary for web applications. It differs from a normal
<code class="literal">ApplicationContext</code> in that it is capable of resolving themes (see
<a class="xref" href="#mvc-themeresolver" title="16.10&nbsp;Using themes">Section&nbsp;16.10, &#8220;Using themes&#8221;</a>), and that it knows which Servlet it is associated with (by having
a link to the <code class="literal">ServletContext</code>). The <code class="literal">WebApplicationContext</code> is bound in the
<code class="literal">ServletContext</code>, and by using static methods on the <code class="literal">RequestContextUtils</code> class you can
always look up the <code class="literal">WebApplicationContext</code> if you need access to it.</p>
<div class="section" title="16.2.1&nbsp;Special Bean Types In the WebApplicationContext"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-servlet-special-bean-types"></a>16.2.1&nbsp;Special Bean Types In the WebApplicationContext</h3></div></div></div>

<p>The Spring <code class="literal">DispatcherServlet</code> uses special beans to process requests and render the
appropriate views. These beans are part of Spring MVC. You can choose which special
beans to use by simply configuring one or more of them in the <code class="literal">WebApplicationContext</code>.
However, you don&#8217;t need to do that initially since Spring MVC maintains a list of
default beans to use if you don&#8217;t configure any. More on that in the next section. First
see the table below listing the special bean types the <code class="literal">DispatcherServlet</code> relies on.</p>
<div class="table"><a name="mvc-webappctx-special-beans-tbl"></a><p class="title"><b>Table&nbsp;16.1.&nbsp;Special bean types in the WebApplicationContext</b></p><div class="table-contents">

  <table summary="Special bean types in the WebApplicationContext" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Bean type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#mvc-handlermapping" title="16.4&nbsp;Handler mappings">HandlerMapping</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maps incoming requests to handlers and a list of pre- and post-processors (handler
  interceptors) based on some criteria the details of which vary by <code class="literal">HandlerMapping</code>
  implementation. The most popular implementation supports annotated controllers but
  other implementations exists as well.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HandlerAdapter</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Helps the <code class="literal">DispatcherServlet</code> to invoke a handler mapped to a request regardless of
  the handler is actually invoked. For example, invoking an annotated controller
  requires resolving various annotations. Thus the main purpose of a <code class="literal">HandlerAdapter</code> is
  to shield the <code class="literal">DispatcherServlet</code> from such details.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#mvc-exceptionhandlers" title="16.12&nbsp;Handling exceptions">HandlerExceptionResolver</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maps exceptions to views also allowing for more complex exception handling code.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#mvc-viewresolver" title="16.5&nbsp;Resolving views">ViewResolver</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Resolves logical String-based view names to actual <code class="literal">View</code> types.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#mvc-localeresolver" title="16.9&nbsp;Using locales">LocaleResolver</a> &amp; <a class="link" href="#mvc-timezone" title="16.9.1&nbsp;Obtaining Time Zone Information">LocaleContextResolver</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Resolves the locale a client is using and possibly their time zone, in order to be able
  to offer internationalized views</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#mvc-themeresolver" title="16.10&nbsp;Using themes">ThemeResolver</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Resolves themes your web application can use, for example, to offer personalized layouts</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#mvc-multipart" title="16.11&nbsp;Spring&#8217;s multipart (file upload) support">MultipartResolver</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Parses multi-part requests for example to support processing file uploads from HTML
  forms.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="link" href="#mvc-flash-attributes" title="16.6&nbsp;Using flash attributes">FlashMapManager</a></p></td><td style="" align="left" valign="top"><p>Stores and retrieves the "input" and the "output" <code class="literal">FlashMap</code> that can be used to pass
  attributes from one request to another, usually across a redirect.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="16.2.2&nbsp;Default DispatcherServlet Configuration"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-servlet-config"></a>16.2.2&nbsp;Default DispatcherServlet Configuration</h3></div></div></div>

<p>As mentioned in the previous section for each special bean the <code class="literal">DispatcherServlet</code>
maintains a list of implementations to use by default. This information is kept in the
file <code class="literal">DispatcherServlet.properties</code> in the package <code class="literal">org.springframework.web.servlet</code>.</p>
<p>All special beans have some reasonable defaults of their own. Sooner or later though
you&#8217;ll need to customize one or more of the properties these beans provide. For example
it&#8217;s quite common to configure an <code class="literal">InternalResourceViewResolver</code> settings its <code class="literal">prefix</code>
property to the parent location of view files.</p>
<p>Regardless of the details, the important concept to understand here is that once
you	configure a special bean such as an <code class="literal">InternalResourceViewResolver</code> in your
<code class="literal">WebApplicationContext</code>, you effectively override the list of default implementations
that would have been used otherwise for that special bean type. For example if you
configure an <code class="literal">InternalResourceViewResolver</code>, the default list of <code class="literal">ViewResolver</code>
implementations is ignored.</p>
<p>In <a class="xref" href="#mvc-config" title="16.16&nbsp;Configuring Spring MVC">Section&nbsp;16.16, &#8220;Configuring Spring MVC&#8221;</a> you&#8217;ll learn about other options for configuring Spring MVC including
MVC Java config and the MVC XML namespace both of which provide a simple starting point
and assume little knowledge of how Spring MVC works. Regardless of how you choose to
configure your application, the concepts explained in this section are fundamental
should be of help to you.</p>
</div>
<div class="section" title="16.2.3&nbsp;DispatcherServlet Processing Sequence"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-servlet-sequence"></a>16.2.3&nbsp;DispatcherServlet Processing Sequence</h3></div></div></div>

<p>After you set up a <code class="literal">DispatcherServlet</code>, and a request comes in for that specific
<code class="literal">DispatcherServlet</code>, the <code class="literal">DispatcherServlet</code> starts processing the request as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <code class="literal">WebApplicationContext</code> is searched for and bound in the request as an attribute
that the controller and other elements in the process can use. It is bound by default
under the key <code class="literal">DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE</code>.
</li><li class="listitem">
The locale resolver is bound to the request to enable elements in the process to
resolve the locale to use when processing the request (rendering the view, preparing
data, and so on). If you do not need locale resolving, you do not need it.
</li><li class="listitem">
The theme resolver is bound to the request to let elements such as views determine
which theme to use. If you do not use themes, you can ignore it.
</li><li class="listitem">
If you specify a multipart file resolver, the request is inspected for multiparts; if
multiparts are found, the request is wrapped in a <code class="literal">MultipartHttpServletRequest</code> for
further processing by other elements in the process. See <a class="xref" href="#mvc-multipart" title="16.11&nbsp;Spring&#8217;s multipart (file upload) support">Section&nbsp;16.11, &#8220;Spring&#8217;s multipart (file upload) support&#8221;</a> for further
information about multipart handling.
</li><li class="listitem">
An appropriate handler is searched for. If a handler is found, the execution chain
associated with the handler (preprocessors, postprocessors, and controllers) is
executed in order to prepare a model or rendering.
</li><li class="listitem">
If a model is returned, the view is rendered. If no model is returned, (may be due to
a preprocessor or postprocessor intercepting the request, perhaps for security
reasons), no view is rendered, because the request could already have been fulfilled.
</li></ul></div>

<p>Handler exception resolvers that are declared in the <code class="literal">WebApplicationContext</code> pick up
exceptions that are thrown during processing of the request. Using these exception
resolvers allows you to define custom behaviors to address exceptions.</p>
<p>The Spring <code class="literal">DispatcherServlet</code> also supports the return of the
<span class="emphasis"><em>last-modification-date</em></span>, as specified by the Servlet API. The process of determining
the last modification date for a specific request is straightforward: the
<code class="literal">DispatcherServlet</code> looks up an appropriate handler mapping and tests whether the
handler that is found implements the <span class="emphasis"><em>LastModified</em></span> interface. If so, the value of the
<code class="literal">long getLastModified(request)</code> method of the <code class="literal">LastModified</code> interface is returned to
the client.</p>
<p>You can customize individual <code class="literal">DispatcherServlet</code> instances by adding Servlet
initialization parameters ( <code class="literal">init-param</code> elements) to the Servlet declaration in the
<code class="literal">web.xml</code> file. See the following table for the list of supported parameters.</p>
<div class="table"><a name="mvc-disp-servlet-init-params-tbl"></a><p class="title"><b>Table&nbsp;16.2.&nbsp;DispatcherServlet initialization parameters</b></p><div class="table-contents">

  <table summary="DispatcherServlet initialization parameters" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Parameter</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">contextClass</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Class that implements <code class="literal">WebApplicationContext</code>, which instantiates the context used by
  this Servlet. By default, the <code class="literal">XmlWebApplicationContext</code> is used.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">contextConfigLocation</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>String that is passed to the context instance (specified by <code class="literal">contextClass</code>) to
  indicate where context(s) can be found. The string consists potentially of multiple
  strings (using a comma as a delimiter) to support multiple contexts. In case of
  multiple context locations with beans that are defined twice, the latest location
  takes precedence.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">namespace</code></p></td><td style="" align="left" valign="top"><p>Namespace of the <code class="literal">WebApplicationContext</code>. Defaults to <code class="literal">[servlet-name]-servlet</code>.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
</div>
<div class="section" title="16.3&nbsp;Implementing Controllers"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-controller"></a>16.3&nbsp;Implementing Controllers</h2></div></div></div>

<p>Controllers provide access to the application behavior that you typically define through
a service interface. Controllers interpret user input and transform it into a model that
is represented to the user by the view. Spring implements a controller in a very
abstract way, which enables you to create a wide variety of controllers.</p>
<p>Spring 2.5 introduced an annotation-based programming model for MVC controllers that
uses annotations such as <code class="literal">@RequestMapping</code>, <code class="literal">@RequestParam</code>, <code class="literal">@ModelAttribute</code>, and so
on. This annotation support is available for both Servlet MVC and Portlet MVC.
Controllers implemented in this style do not have to extend specific base classes or
implement specific interfaces. Furthermore, they do not usually have direct dependencies
on Servlet or Portlet APIs, although you can easily configure access to Servlet or
Portlet facilities.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Available in the <a class="ulink" href="https://github.com/spring-projects/" target="_top">spring-projects Org on Github</a>,
a number of web applications leverage the annotation support described in this section
including <span class="emphasis"><em>MvcShowcase</em></span>, <span class="emphasis"><em>MvcAjax</em></span>, <span class="emphasis"><em>MvcBasic</em></span>, <span class="emphasis"><em>PetClinic</em></span>, <span class="emphasis"><em>PetCare</em></span>,
and others.</p>
</td></tr></table></div>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HelloWorldController {

    <i><span class="hl-annotation" style="color: gray">@RequestMapping("/helloWorld")</span></i>
    <span class="hl-keyword">public</span> String helloWorld(Model model) {
        model.addAttribute(<span class="hl-string">"message"</span>, <span class="hl-string">"Hello World!"</span>);
        <span class="hl-keyword">return</span> <span class="hl-string">"helloWorld"</span>;
    }
}</pre>

<p>As you can see, the <code class="literal">@Controller</code> and <code class="literal">@RequestMapping</code> annotations allow flexible
method names and signatures. In this particular example the method accepts a <code class="literal">Model</code> and
returns a view name as a <code class="literal">String</code>, but various other method parameters and return values
can be used as explained later in this section. <code class="literal">@Controller</code> and <code class="literal">@RequestMapping</code> and
a number of other annotations form the basis for the Spring MVC implementation. This
section documents these annotations and how they are most commonly used in a Servlet
environment.</p>
<div class="section" title="16.3.1&nbsp;Defining a controller with @Controller"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-controller"></a>16.3.1&nbsp;Defining a controller with @Controller</h3></div></div></div>

<p>The <code class="literal">@Controller</code> annotation indicates that a particular class serves the role of
a <span class="emphasis"><em>controller</em></span>. Spring does not require you to extend any controller base class or
reference the Servlet API. However, you can still reference Servlet-specific features if
you need to.</p>
<p>The <code class="literal">@Controller</code> annotation acts as a stereotype for the annotated class, indicating
its role. The dispatcher scans such annotated classes for mapped methods and detects
<code class="literal">@RequestMapping</code> annotations (see the next section).</p>
<p>You can define annotated controller beans explicitly, using a standard Spring bean
definition in the dispatcher&#8217;s context. However, the <code class="literal">@Controller</code> stereotype also
allows for autodetection, aligned with Spring general support for detecting component
classes in the classpath and auto-registering bean definitions for them.</p>
<p>To enable autodetection of such annotated controllers, you add component scanning to
your configuration. Use the <span class="emphasis"><em>spring-context</em></span> schema as shown in the following XML
snippet:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:p</span>=<span class="hl-value">"http://www.springframework.org/schema/p"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.springframework.samples.petclinic.web"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- ... --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="16.3.2&nbsp;Mapping Requests With Using @RequestMapping"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-requestmapping"></a>16.3.2&nbsp;Mapping Requests With Using @RequestMapping</h3></div></div></div>

<p>You use the <code class="literal">@RequestMapping</code> annotation to map URLs such as <code class="literal">/appointments</code> onto an
entire class or a particular handler method. Typically the class-level annotation maps a
specific request path (or path pattern) onto a form controller, with additional
method-level annotations narrowing the primary mapping for a specific HTTP method
request method ("GET", "POST", etc.) or an HTTP request parameter condition.</p>
<p>The following example from the <span class="emphasis"><em>Petcare</em></span> sample shows a controller in a Spring MVC
application that uses this annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="strong"><strong>@RequestMapping("/appointments")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppointmentsController {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> AppointmentBook appointmentBook;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> AppointmentsController(AppointmentBook appointmentBook) {
        <span class="hl-keyword">this</span>.appointmentBook = appointmentBook;
    }

    <span class="strong"><strong>@RequestMapping(method = RequestMethod.GET)</strong></span>
    <span class="hl-keyword">public</span> Map&lt;String, Appointment&gt; get() {
        <span class="hl-keyword">return</span> appointmentBook.getAppointmentsForToday();
    }

    <span class="strong"><strong>@RequestMapping(value="/{day}", method = RequestMethod.GET)</strong></span>
    <span class="hl-keyword">public</span> Map&lt;String, Appointment&gt; getForDay(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> <i><span class="hl-annotation" style="color: gray">@DateTimeFormat(iso=ISO.DATE)</span></i> Date day, Model model) {
        <span class="hl-keyword">return</span> appointmentBook.getAppointmentsForDay(day);
    }

    <span class="strong"><strong>@RequestMapping(value="/new", method = RequestMethod.GET)</strong></span>
    <span class="hl-keyword">public</span> AppointmentForm getNewForm() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AppointmentForm();
    }

    <span class="strong"><strong>@RequestMapping(method = RequestMethod.POST)</strong></span>
    <span class="hl-keyword">public</span> String add(<i><span class="hl-annotation" style="color: gray">@Valid</span></i> AppointmentForm appointment, BindingResult result) {
        <span class="hl-keyword">if</span> (result.hasErrors()) {
            <span class="hl-keyword">return</span> <span class="hl-string">"appointments/new"</span>;
        }
        appointmentBook.addAppointment(appointment);
        <span class="hl-keyword">return</span> <span class="hl-string">"redirect:/appointments"</span>;
    }
}</pre>

<p>In the example, the <code class="literal">@RequestMapping</code> is used in a number of places. The first usage is
on the type (class) level, which indicates that all handling methods on this controller
are relative to the <code class="literal">/appointments</code> path. The <code class="literal">get()</code> method has a further
<code class="literal">@RequestMapping</code> refinement: it only accepts GET requests, meaning that an HTTP GET for
<code class="literal">/appointments</code> invokes this method. The <code class="literal">post()</code> has a similar refinement, and the
<code class="literal">getNewForm()</code> combines the definition of HTTP method and path into one, so that GET
requests for <code class="literal">appointments/new</code> are handled by that method.</p>
<p>The <code class="literal">getForDay()</code> method shows another usage of <code class="literal">@RequestMapping</code>: URI templates. (See
<a class="link" href="#mvc-ann-requestmapping-uri-templates" title="URI Template Patterns">the next section</a>).</p>
<p>A <code class="literal">@RequestMapping</code> on the class level is not required. Without it, all paths are simply
absolute, and not relative. The following example from the <span class="emphasis"><em>PetClinic</em></span> sample
application shows a multi-action controller using <code class="literal">@RequestMapping</code>:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ClinicController {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> Clinic clinic;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> ClinicController(Clinic clinic) {
        <span class="hl-keyword">this</span>.clinic = clinic;
    }

    <span class="strong"><strong>@RequestMapping("/")</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> welcomeHandler() {
    }

    <span class="strong"><strong>@RequestMapping("/vets")</strong></span>
    <span class="hl-keyword">public</span> ModelMap vetsHandler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ModelMap(<span class="hl-keyword">this</span>.clinic.getVets());
    }

}</pre>

<div class="tip" title="@RequestMapping On Interface Methods" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: @RequestMapping On Interface Methods"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">@RequestMapping On Interface Methods</th></tr><tr><td align="left" valign="top">

<p>A common pitfall when working with annotated controller classes happens when applying
functionality that requires creating a proxy for the controller object (e.g.
<code class="literal">@Transactional</code> methods). Usually you will introduce an interface for the controller in
order to use JDK dynamic proxies. To make this work you must move the <code class="literal">@RequestMapping</code>
annotations, as well as any other type and method-level annotations (e.g.
<code class="literal">@ModelAttribute</code>, <code class="literal">@InitBinder</code>) to the interface as well as the mapping mechanism can
only "see" the interface exposed by the proxy. Alternatively, you could activate
<code class="literal">proxy-target-class="true"</code> in the configuration for the functionality applied to the
controller (in our transaction scenario in <code class="literal">&lt;tx:annotation-driven /&gt;</code>). Doing so
indicates that CGLIB-based subclass proxies should be used instead of interface-based
JDK proxies. For more information on various proxying mechanisms see <a class="xref" href="#aop-proxying" title="8.6&nbsp;Proxying mechanisms">Section&nbsp;8.6, &#8220;Proxying mechanisms&#8221;</a>.</p>
<p>Note however that method argument annotations, e.g. <code class="literal">@RequestParam</code>, must be present in
the method signatures of the controller class.</p>
</td></tr></table></div>

<div class="section" title="New Support Classes for @RequestMapping methods in Spring MVC 3.1"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestmapping-31-vs-30"></a>New Support Classes for @RequestMapping methods in Spring MVC 3.1</h4></div></div></div>

<p>Spring 3.1 introduced a new set of support classes for <code class="literal">@RequestMapping</code> methods called
<code class="literal">RequestMappingHandlerMapping</code> and <code class="literal">RequestMappingHandlerAdapter</code> respectively. They are
recommended for use and even required to take advantage of new features in Spring MVC
3.1 and going forward. The new support classes are enabled by default by the MVC
namespace and the MVC Java config but must be configured explicitly if using neither.
This section describes a few important differences between the old and the new support
classes.</p>
<p>Prior to Spring 3.1, type and method-level request mappings were examined in two
separate stages&#8201;&#8212;&#8201;a controller was selected first by the
<code class="literal">DefaultAnnotationHandlerMapping</code> and the actual method to invoke was narrowed down
second by the <code class="literal">AnnotationMethodHandlerAdapter</code>.</p>
<p>With the new support classes in Spring 3.1, the <code class="literal">RequestMappingHandlerMapping</code> is the
only place where a decision is made about which method should process the request. Think
of controller methods as a collection of unique endpoints with mappings for each method
derived from type and method-level <code class="literal">@RequestMapping</code> information.</p>
<p>This enables some new possibilities. For once a <code class="literal">HandlerInterceptor</code> or a
<code class="literal">HandlerExceptionResolver</code> can now expect the Object-based handler to be a
<code class="literal">HandlerMethod</code>, which allows them to examine the exact method, its parameters and
associated annotations. The processing for a URL no longer needs to be split across
different controllers.</p>
<p>There are also several things no longer possible:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Select a controller first with a <code class="literal">SimpleUrlHandlerMapping</code> or
<code class="literal">BeanNameUrlHandlerMapping</code> and then narrow the method based on <code class="literal">@RequestMapping</code>
annotations.
</li><li class="listitem">
Rely on method names as a fall-back mechanism to disambiguate between two
<code class="literal">@RequestMapping</code> methods that don&#8217;t have an explicit path mapping URL path but
otherwise match equally, e.g. by HTTP method. In the new support classes
<code class="literal">@RequestMapping</code> methods have to be mapped uniquely.
</li><li class="listitem">
Have a single default method (without an explicit path mapping) with which requests
are processed if no other controller method matches more concretely. In the new
support classes if a matching method is not found a 404 error is raised.
</li></ul></div>

<p>The above features are still supported with the existing support classes. However to
take advantage of new Spring MVC 3.1 features you&#8217;ll need to use the new support classes.</p>
</div>
<div class="section" title="URI Template Patterns"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestmapping-uri-templates"></a>URI Template Patterns</h4></div></div></div>

<p><span class="emphasis"><em>URI templates</em></span> can be used for convenient access to selected parts of a URL in a
<code class="literal">@RequestMapping</code> method.</p>
<p>A URI Template is a URI-like string, containing one or more variable names. When you
substitute values for these variables, the template becomes a URI. The
<a class="ulink" href="http://bitworking.org/projects/URI-Templates/" target="_top">proposed RFC</a> for URI Templates defines
how a URI is parameterized. For example, the URI Template
<code class="literal">http://www.example.com/users/{userId}</code> contains the variable <span class="emphasis"><em>userId</em></span>. Assigning the
value <span class="emphasis"><em>fred</em></span> to the variable yields <code class="literal">http://www.example.com/users/fred</code>.</p>
<p>In Spring MVC you can use the <code class="literal">@PathVariable</code> annotation on a method argument to bind it
to the value of a URI template variable:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/owners/{ownerId}", method=RequestMethod.GET)</span></i>
<span class="hl-keyword">public</span> String findOwner(<span class="strong"><strong>@PathVariable</strong></span> String ownerId, Model model) {
    Owner owner = ownerService.findOwner(ownerId);
    model.addAttribute(<span class="hl-string">"owner"</span>, owner);
    <span class="hl-keyword">return</span> <span class="hl-string">"displayOwner"</span>;
}</pre>

<p>The URI Template " <code class="literal">/owners/{ownerId}</code>" specifies the variable name <code class="literal">ownerId</code>. When the
controller handles this request, the value of <code class="literal">ownerId</code> is set to the value found in the
appropriate part of the URI. For example, when a request comes in for <code class="literal">/owners/fred</code>,
the value of <code class="literal">ownerId</code> is <code class="literal">fred</code>.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>To process the @PathVariable annotation, Spring MVC needs to find the matching URI
template variable by name. You can specify it in the annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/owners/{ownerId}", method=RequestMethod.GET)</span></i>
<span class="hl-keyword">public</span> String findOwner(<span class="strong"><strong>@PathVariable("ownerId")</strong></span> String theOwner, Model model) {
    <span class="hl-comment">// implementation omitted</span>
}</pre>

<p>Or if the URI template variable name matches the method argument name you can omit that
detail. As long as your code is not compiled without debugging information, Spring MVC
will match the method argument name to the URI template variable name:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/owners/{ownerId}", method=RequestMethod.GET)</span></i>
<span class="hl-keyword">public</span> String findOwner(<span class="strong"><strong>@PathVariable</strong></span> String ownerId, Model model) {
    <span class="hl-comment">// implementation omitted</span>
}</pre>

</td></tr></table></div>

<p>A method can have any number of <code class="literal">@PathVariable</code> annotations:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/owners/{ownerId}/pets/{petId}", method=RequestMethod.GET)</span></i>
<span class="hl-keyword">public</span> String findPet(<span class="strong"><strong>@PathVariable</strong></span> String ownerId, <span class="strong"><strong>@PathVariable</strong></span> String petId, Model model) {
    Owner owner = ownerService.findOwner(ownerId);
    Pet pet = owner.getPet(petId);
    model.addAttribute(<span class="hl-string">"pet"</span>, pet);
    <span class="hl-keyword">return</span> <span class="hl-string">"displayPet"</span>;
}</pre>

<p>When a <code class="literal">@PathVariable</code> annotation is used on a <code class="literal">Map&lt;String, String&gt;</code> argument, the map
is populated with all URI template variables.</p>
<p>A URI template can be assembled from type and path level <span class="emphasis"><em>@RequestMapping</em></span>
annotations. As a result the <code class="literal">findPet()</code> method can be invoked with a URL such as
<code class="literal">/owners/42/pets/21</code>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
@RequestMapping(<span class="strong"><strong>"/owners/{ownerId}"</strong></span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RelativePathUriTemplateController {

    @RequestMapping(<span class="strong"><strong>"/pets/{petId}"</strong></span>)
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findPet(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String ownerId, <i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String petId, Model model) {
        <span class="hl-comment">// implementation omitted</span>
    }

}</pre>

<p>A <code class="literal">@PathVariable</code> argument can be of <span class="emphasis"><em>any simple type</em></span> such as int, long, Date, etc.
Spring automatically converts to the appropriate type or throws a
<code class="literal">TypeMismatchException</code> if it fails to do so. You can also register support for parsing
additional data types. See <a class="xref" href="#mvc-ann-typeconversion" title="Method Parameters And Type Conversion">the section called &#8220;Method Parameters And Type Conversion&#8221;</a> and <a class="xref" href="#mvc-ann-webdatabinder" title="Customizing WebDataBinder initialization">the section called &#8220;Customizing WebDataBinder initialization&#8221;</a>.</p>
</div>
<div class="section" title="URI Template Patterns with Regular Expressions"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestmapping-uri-templates-regex"></a>URI Template Patterns with Regular Expressions</h4></div></div></div>

<p>Sometimes you need more precision in defining URI template variables. Consider the URL
<code class="literal">"/spring-web/spring-web-3.0.5.jar"</code>. How do you break it down into multiple parts?</p>
<p>The <code class="literal">@RequestMapping</code> annotation supports the use of regular expressions in URI template
variables. The syntax is <code class="literal">{varName:regex}</code> where the first part defines the variable
name and the second - the regular expression.For example:</p>
<pre class="programlisting">@RequestMapping(<span class="hl-string">"/spring-web/{symbolicName:[a-z-]</span><code class="literal">}-{version:\\d\\.\\d\\.\\d}{extension:\\.[a-z]</code>}<span class="hl-string">")
</span>    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String version, <i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String extension) {
        <span class="hl-comment">// ...</span>
    }
}</pre>

</div>
<div class="section" title="Path Patterns"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestmapping-patterns"></a>Path Patterns</h4></div></div></div>

<p>In addition to URI templates, the <code class="literal">@RequestMapping</code> annotation also supports Ant-style
path patterns (for example, <code class="literal">/myPath/*.do</code>). A combination of URI templates and
Ant-style globs is also supported (for example, <code class="literal">/owners/*/pets/{petId}</code>).</p>
</div>
<div class="section" title="Patterns with Placeholders"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestmapping-placeholders"></a>Patterns with Placeholders</h4></div></div></div>

<p>Patterns in <code class="literal">@RequestMapping</code> annotations support ${&#8230;} placeholders against local
properties and/or system properties and environment variables. This may be useful in
cases where the path a controller is mapped to may need to be customized through
configuration. For more information on placeholders see the Javadoc for
<code class="literal">PropertyPlaceholderConfigurer</code>.</p>
</div>
<div class="section" title="Matrix Variables"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-matrix-variables"></a>Matrix Variables</h4></div></div></div>

<p>The URI specification <a class="ulink" href="http://tools.ietf.org/html/rfc3986#section-3.3" target="_top">RFC 3986</a> defines
the possibility of including name-value pairs within path segments. There is no specific
term used in the spec. The general "URI path parameters" could be applied although the
more unique <a class="ulink" href="http://www.w3.org/DesignIssues/MatrixURIs.html" target="_top">"Matrix URIs"</a>, originating
from an old post by Tim Berners-Lee, is also frequently used and fairly well known.
Within Spring MVC these are referred to as matrix variables.</p>
<p>Matrix variables can appear in any path segment, each matrix variable separated with a
";" (semicolon). For example: <code class="literal">"/cars;color=red;year=2012"</code>. Multiple values may be
either "," (comma) separated <code class="literal">"color=red,green,blue"</code> or the variable name may be
repeated <code class="literal">"color=red;color=green;color=blue"</code>.</p>
<p>If a URL is expected to contain matrix variables, the request mapping pattern must
represent them with a URI template. This ensures the request can be matched correctly
regardless of whether matrix variables are present or not and in what order they are
provided.</p>
<p>Below is an example of extracting the matrix variable "q":</p>
<pre class="programlisting"><span class="hl-comment">// GET /pets/42;q=11;r=22</span>

<i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/pets/{petId}", method = RequestMethod.GET)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findPet(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String petId, <i><span class="hl-annotation" style="color: gray">@MatrixVariable</span></i> <span class="hl-keyword">int</span> q) {

    <span class="hl-comment">// petId == 42</span>
    <span class="hl-comment">// q == 11</span>

}</pre>

<p>Since all path segments may contain matrix variables, in some cases you need to be more
specific to identify where the variable is expected to be:</p>
<pre class="programlisting"><span class="hl-comment">// GET /owners/42;q=11/pets/21;q=22</span>

<i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/owners/{ownerId}/pets/{petId}", method = RequestMethod.GET)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findPet(
        <i><span class="hl-annotation" style="color: gray">@MatrixVariable(value="q", pathVar="ownerId")</span></i> <span class="hl-keyword">int</span> q1,
        <i><span class="hl-annotation" style="color: gray">@MatrixVariable(value="q", pathVar="petId")</span></i> <span class="hl-keyword">int</span> q2) {

    <span class="hl-comment">// q1 == 11</span>
    <span class="hl-comment">// q2 == 22</span>

}</pre>

<p>A matrix variable may be defined as optional and a default value specified:</p>
<pre class="programlisting"><span class="hl-comment">// GET /pets/42</span>

<i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/pets/{petId}", method = RequestMethod.GET)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findPet(<i><span class="hl-annotation" style="color: gray">@MatrixVariable(required=false, defaultValue="1")</span></i> <span class="hl-keyword">int</span> q) {

    <span class="hl-comment">// q == 1</span>

}</pre>

<p>All matrix variables may be obtained in a Map:</p>
<pre class="programlisting"><span class="hl-comment">// GET /owners/42;q=11;r=12/pets/21;q=22;s=23</span>

<i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/owners/{ownerId}/pets/{petId}", method = RequestMethod.GET)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findPet(
        <i><span class="hl-annotation" style="color: gray">@MatrixVariable</span></i> Map&lt;String, String&gt; matrixVars,
        <i><span class="hl-annotation" style="color: gray">@MatrixVariable(pathVar="petId"")</span></i> Map&lt;String, String&gt; petMatrixVars) {

    <span class="hl-comment">// matrixVars: ["q" : [11,22], "r" : 12, "s" : 23]</span>
    <span class="hl-comment">// petMatrixVars: ["q" : 11, "s" : 23]</span>

}</pre>

<p>Note that to enable the use of matrix variables, you must set the
<code class="literal">removeSemicolonContent</code> property of <code class="literal">RequestMappingHandlerMapping</code> to <code class="literal">false</code>. By
default it is set to <code class="literal">true</code>.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The MVC Java config and the MVC namespace both provide options for enabling the use of
matrix variables.</p>
<p>If you are using Java config, The <a class="link" href="#mvc-config-advanced-java" title="16.16.9&nbsp;Advanced Customizations with MVC Java Config">Advanced Customizations
with MVC Java Config</a> section describes how the <code class="literal">RequestMappingHandlerMapping</code> can
be customized.</p>
<p>In the MVC namespace, the <code class="literal">&lt;mvc:annotation-driven&gt;</code> element has an
<code class="literal">enable-matrix-variables</code> attribute that should be set to <code class="literal">true</code>. By default it is set
to <code class="literal">false</code>.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:mvc</span>=<span class="hl-value">"http://www.springframework.org/schema/mvc"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;mvc:annotation-driven</span> <span class="hl-attribute">enable-matrix-variables</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</td></tr></table></div>

</div>
<div class="section" title="Consumable Media Types"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestmapping-consumes"></a>Consumable Media Types</h4></div></div></div>

<p>You can narrow the primary mapping by specifying a list of consumable media types. The
request will be matched only if the <span class="emphasis"><em>Content-Type</em></span> request header matches the specified
media type. For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
@RequestMapping(value = <span class="hl-string">"/pets"</span>, method = RequestMethod.POST, <span class="strong"><strong>consumes="application/json"</strong></span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addPet(<i><span class="hl-annotation" style="color: gray">@RequestBody</span></i> Pet pet, Model model) {
    <span class="hl-comment">// implementation omitted</span>
}</pre>

<p>Consumable media type expressions can also be negated as in <span class="emphasis"><em>!text/plain</em></span> to match to
all requests other than those with <span class="emphasis"><em>Content-Type</em></span> of <span class="emphasis"><em>text/plain</em></span>.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>consumes</em></span> condition is supported on the type and on the method level. Unlike most
other conditions, when used at the type level, method-level consumable types override
rather than extend type-level consumable types.</p>
</td></tr></table></div>

</div>
<div class="section" title="Producible Media Types"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestmapping-produces"></a>Producible Media Types</h4></div></div></div>

<p>You can narrow the primary mapping by specifying a list of producible media types. The
request will be matched only if the <span class="emphasis"><em>Accept</em></span> request header matches one of these
values. Furthermore, use of the <span class="emphasis"><em>produces</em></span> condition ensures the actual content type
used to generate the response respects the media types specified in the <span class="emphasis"><em>produces</em></span>
condition. For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
@RequestMapping(value = <span class="hl-string">"/pets/{petId}"</span>, method = RequestMethod.GET, <span class="strong"><strong>produces="application/json"</strong></span>)
<i><span class="hl-annotation" style="color: gray">@ResponseBody</span></i>
<span class="hl-keyword">public</span> Pet getPet(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String petId, Model model) {
    <span class="hl-comment">// implementation omitted</span>
}</pre>

<p>Just like with <span class="emphasis"><em>consumes</em></span>, producible media type expressions can be negated as in
<span class="emphasis"><em>!text/plain</em></span> to match to all requests other than those with an <span class="emphasis"><em>Accept</em></span> header
value of <span class="emphasis"><em>text/plain</em></span>.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>produces</em></span> condition is supported on the type and on the method level. Unlike most
other conditions, when used at the type level, method-level producible types override
rather than extend type-level producible types.</p>
</td></tr></table></div>

</div>
<div class="section" title="Request Parameters and Header Values"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestmapping-params-and-headers"></a>Request Parameters and Header Values</h4></div></div></div>

<p>You can narrow request matching through request parameter conditions such as
<code class="literal">"myParam"</code>, <code class="literal">"!myParam"</code>, or <code class="literal">"myParam=myValue"</code>. The first two test for request
parameter presence/absence and the third for a specific parameter value. Here is an
example with a request parameter value condition:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("/owners/{ownerId}")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RelativePathUriTemplateController {

    @RequestMapping(value = <span class="hl-string">"/pets/{petId}"</span>, method = RequestMethod.GET, <span class="strong"><strong>params="myParam=myValue"</strong></span>)
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findPet(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String ownerId, <i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String petId, Model model) {
        <span class="hl-comment">// implementation omitted</span>
    }

}</pre>

<p>The same can be done to test for request header presence/absence or to match based on a
specific request header value:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("/owners/{ownerId}")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RelativePathUriTemplateController {

    @RequestMapping(value = <span class="hl-string">"/pets"</span>, method = RequestMethod.GET, <span class="strong"><strong>headers="myHeader=myValue"</strong></span>)
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findPet(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String ownerId, <i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> String petId, Model model) {
        <span class="hl-comment">// implementation omitted</span>
    }

}</pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Although you can match to <span class="emphasis"><em>Content-Type</em></span> and <span class="emphasis"><em>Accept</em></span> header values using media type
wild cards (for example <span class="emphasis"><em>"content-type=text/*"</em></span> will match to <span class="emphasis"><em>"text/plain"</em></span> and
<span class="emphasis"><em>"text/html"</em></span>), it is recommended to use the <span class="emphasis"><em>consumes</em></span> and <span class="emphasis"><em>produces</em></span> conditions
respectively instead. They are intended specifically for that purpose.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="16.3.3&nbsp;Defining @RequestMapping handler methods"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-methods"></a>16.3.3&nbsp;Defining @RequestMapping handler methods</h3></div></div></div>

<p>An <code class="literal">@RequestMapping</code> handler method can have a very flexible signatures. The supported
method arguments and return values are described in the following section. Most
arguments can be used in arbitrary order with the only exception of <code class="literal">BindingResult</code>
arguments. This is described in the next section.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring 3.1 introduced a new set of support classes for <code class="literal">@RequestMapping</code> methods called
<code class="literal">RequestMappingHandlerMapping</code> and <code class="literal">RequestMappingHandlerAdapter</code> respectively. They are
recommended for use and even required to take advantage of new features in Spring MVC
3.1 and going forward. The new support classes are enabled by default from the MVC
namespace and with use of the MVC Java config but must be configured explicitly if using
neither.</p>
</td></tr></table></div>

<div class="section" title="Supported method argument types"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-arguments"></a>Supported method argument types</h4></div></div></div>

<p>The following are the supported method arguments:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Request or response objects (Servlet API). Choose any specific request or response
type, for example <code class="literal">ServletRequest</code> or <code class="literal">HttpServletRequest</code>.
</li><li class="listitem">
Session object (Servlet API): of type <code class="literal">HttpSession</code>. An argument of this type enforces
the presence of a corresponding session. As a consequence, such an argument is never
<code class="literal">null</code>.
</li></ul></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Session access may not be thread-safe, in particular in a Servlet environment. Consider
setting the <code class="literal">RequestMappingHandlerAdapter</code>'s "synchronizeOnSession" flag to "true" if
multiple requests are allowed to access a session concurrently.</p>
</td></tr></table></div>

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">org.springframework.web.context.request.WebRequest</code> or
<code class="literal">org.springframework.web.context.request.NativeWebRequest</code>. Allows for generic request
parameter access as well as request/session attribute access, without ties to the
native Servlet/Portlet API.
</li><li class="listitem">
<code class="literal">java.util.Locale</code> for the current request locale, determined by the most specific
locale resolver available, in effect, the configured <code class="literal">LocaleResolver</code> in a Servlet
environment.
</li><li class="listitem">
<code class="literal">java.io.InputStream</code> / <code class="literal">java.io.Reader</code> for access to the request&#8217;s content. This
value is the raw InputStream/Reader as exposed by the Servlet API.
</li><li class="listitem">
<code class="literal">java.io.OutputStream</code> / <code class="literal">java.io.Writer</code> for generating the response&#8217;s content. This
value is the raw OutputStream/Writer as exposed by the Servlet API.
</li><li class="listitem">
<code class="literal">java.security.Principal</code> containing the currently authenticated user.
</li><li class="listitem">
<code class="literal">@PathVariable</code> annotated parameters for access to URI template variables. See
<a class="xref" href="#mvc-ann-requestmapping-uri-templates" title="URI Template Patterns">the section called &#8220;URI Template Patterns&#8221;</a>.
</li><li class="listitem">
<code class="literal">@MatrixVariable</code> annotated parameters for access to name-value pairs located in URI
path segments. See <a class="xref" href="#mvc-ann-matrix-variables" title="Matrix Variables">the section called &#8220;Matrix Variables&#8221;</a>.
</li><li class="listitem">
<code class="literal">@RequestParam</code> annotated parameters for access to specific Servlet request
parameters. Parameter values are converted to the declared method argument type. See
<a class="xref" href="#mvc-ann-requestparam" title="Binding request parameters to method parameters with @RequestParam">the section called &#8220;Binding request parameters to method parameters with @RequestParam&#8221;</a>.
</li><li class="listitem">
<code class="literal">@RequestHeader</code> annotated parameters for access to specific Servlet request HTTP
headers. Parameter values are converted to the declared method argument type.
</li><li class="listitem">
<code class="literal">@RequestBody</code> annotated parameters for access to the HTTP request body. Parameter
values are converted to the declared method argument type using
<code class="literal">HttpMessageConverter</code> s. See <a class="xref" href="#mvc-ann-requestbody" title="Mapping the request body with the @RequestBody annotation">the section called &#8220;Mapping the request body with the @RequestBody annotation&#8221;</a>.
</li><li class="listitem">
<code class="literal">@RequestPart</code> annotated parameters for access to the content of a
"multipart/form-data" request part. See <a class="xref" href="#mvc-multipart-forms-non-browsers" title="16.11.5&nbsp;Handling a file upload request from programmatic clients">Section&nbsp;16.11.5, &#8220;Handling a file upload request from programmatic clients&#8221;</a> and
<a class="xref" href="#mvc-multipart" title="16.11&nbsp;Spring&#8217;s multipart (file upload) support">Section&nbsp;16.11, &#8220;Spring&#8217;s multipart (file upload) support&#8221;</a>.
</li><li class="listitem">
<code class="literal">HttpEntity&lt;?&gt;</code> parameters for access to the Servlet request HTTP headers and
contents. The request stream will be converted to the entity body using
<code class="literal">HttpMessageConverter</code> s. See <a class="xref" href="#mvc-ann-httpentity" title="Using HttpEntity">the section called &#8220;Using HttpEntity&#8221;</a>.
</li><li class="listitem">
<code class="literal">java.util.Map</code> / <code class="literal">org.springframework.ui.Model</code> / <code class="literal">org.springframework.ui.ModelMap</code>
for enriching the implicit model that is exposed to the web view.
</li><li class="listitem">
<code class="literal">org.springframework.web.servlet.mvc.support.RedirectAttributes</code> to specify the exact
set of attributes to use in case of a redirect and also to add flash attributes
(attributes stored temporarily on the server-side to make them available to the
request after the redirect). <code class="literal">RedirectAttributes</code> is used instead of the implicit
model if the method returns a "redirect:" prefixed view name or <code class="literal">RedirectView</code>.
</li><li class="listitem">
Command or form objects to bind request parameters to bean properties (via setters) or
directly to fields, with customizable type conversion, depending on <code class="literal">@InitBinder</code>
methods and/or the HandlerAdapter configuration. See the <code class="literal">webBindingInitializer</code>
property on <code class="literal">RequestMappingHandlerAdapter</code>. Such command objects along with their
validation results will be exposed as model attributes by default, using the command
class class name - e.g. model attribute "orderAddress" for a command object of type
"some.package.OrderAddress". The <code class="literal">ModelAttribute</code> annotation can be used on a method
argument to customize the model attribute name used.
</li><li class="listitem">
<code class="literal">org.springframework.validation.Errors</code> /
<code class="literal">org.springframework.validation.BindingResult</code> validation results for a preceding
command or form object (the immediately preceding method argument).
</li><li class="listitem">
<code class="literal">org.springframework.web.bind.support.SessionStatus</code> status handle for marking form
processing as complete, which triggers the cleanup of session attributes that have
been indicated by the <code class="literal">@SessionAttributes</code> annotation at the handler type level.
</li><li class="listitem">
<code class="literal">org.springframework.web.util.UriComponentsBuilder</code> a builder for preparing a URL
relative to the current request&#8217;s host, port, scheme, context path, and the literal
part of the servlet mapping.
</li></ul></div>

<p>The <code class="literal">Errors</code> or <code class="literal">BindingResult</code> parameters have to follow the model object that is being
bound immediately as the method signature might have more that one model object and
Spring will create a separate <code class="literal">BindingResult</code> instance for each of them so the following
sample won&#8217;t work:</p>
<p title="Invalid ordering of BindingResult and @ModelAttribute">
<b>Invalid ordering of BindingResult and @ModelAttribute.&nbsp;</b>

</p><pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(method = RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> String processSubmit(<span class="strong"><strong>@ModelAttribute("pet") Pet pet</strong></span>, Model model, <span class="strong"><strong>BindingResult result</strong></span>) { ... }</pre><p title="Invalid ordering of BindingResult and @ModelAttribute">

</p>

<p>Note, that there is a <code class="literal">Model</code> parameter in between <code class="literal">Pet</code> and <code class="literal">BindingResult</code>. To get
this working you have to reorder the parameters as follows:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(method = RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> String processSubmit(<span class="strong"><strong>@ModelAttribute("pet") Pet pet</strong></span>, <span class="strong"><strong>BindingResult result</strong></span>, Model model) { ... }</pre>

</div>
<div class="section" title="Supported method return types"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-return-types"></a>Supported method return types</h4></div></div></div>

<p>The following are the supported return types:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
A <code class="literal">ModelAndView</code> object, with the model implicitly enriched with command objects and
the results of <code class="literal">@ModelAttribute</code> annotated reference data accessor methods.
</li><li class="listitem">
A <code class="literal">Model</code> object, with the view name implicitly determined through a
<code class="literal">RequestToViewNameTranslator</code> and the model implicitly enriched with command objects
and the results of <code class="literal">@ModelAttribute</code> annotated reference data accessor methods.
</li><li class="listitem">
A <code class="literal">Map</code> object for exposing a model, with the view name implicitly determined through
a <code class="literal">RequestToViewNameTranslator</code> and the model implicitly enriched with command objects
and the results of <code class="literal">@ModelAttribute</code> annotated reference data accessor methods.
</li><li class="listitem">
A <code class="literal">View</code> object, with the model implicitly determined through command objects and
<code class="literal">@ModelAttribute</code> annotated reference data accessor methods. The handler method may
also programmatically enrich the model by declaring a <code class="literal">Model</code> argument (see above).
</li><li class="listitem">
A <code class="literal">String</code> value that is interpreted as the logical view name, with the model
implicitly determined through command objects and <code class="literal">@ModelAttribute</code> annotated
reference data accessor methods. The handler method may also programmatically enrich
the model by declaring a <code class="literal">Model</code> argument (see above).
</li><li class="listitem">
<code class="literal">void</code> if the method handles the response itself (by writing the response content
directly, declaring an argument of type <code class="literal">ServletResponse</code> / <code class="literal">HttpServletResponse</code> for
that purpose) or if the view name is supposed to be implicitly determined through a
<code class="literal">RequestToViewNameTranslator</code> (not declaring a response argument in the handler method
signature).
</li><li class="listitem">
If the method is annotated with <code class="literal">@ResponseBody</code>, the return type is written to the
response HTTP body. The return value will be converted to the declared method argument
type using <code class="literal">HttpMessageConverter</code> s. See <a class="xref" href="#mvc-ann-responsebody" title="Mapping the response body with the @ResponseBody annotation">the section called &#8220;Mapping the response body with the @ResponseBody annotation&#8221;</a>.
</li><li class="listitem">
An <code class="literal">HttpEntity&lt;?&gt;</code> or <code class="literal">ResponseEntity&lt;?&gt;</code> object to provide access to the Servlet
response HTTP headers and contents. The entity body will be converted to the response
stream using <code class="literal">HttpMessageConverter</code> s. See <a class="xref" href="#mvc-ann-httpentity" title="Using HttpEntity">the section called &#8220;Using HttpEntity&#8221;</a>.
</li><li class="listitem">
An <code class="literal">HttpHeaders</code> object to return a response with no body.
</li><li class="listitem">
A <code class="literal">Callable&lt;?&gt;</code> can be returned when the application wants to produce the return value
asynchronously in a thread managed by Spring MVC.
</li><li class="listitem">
A <code class="literal">DeferredResult&lt;?&gt;</code> can be returned when the application wants to produce the return
value from a thread of its own choosing.
</li><li class="listitem">
Any other return type is considered to be a single model attribute to be exposed to
the view, using the attribute name specified through <code class="literal">@ModelAttribute</code> at the method
level (or the default attribute name based on the return type class name). The model
is implicitly enriched with command objects and the results of <code class="literal">@ModelAttribute</code>
annotated reference data accessor methods.
</li></ul></div>

</div>
<div class="section" title="Binding request parameters to method parameters with @RequestParam"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestparam"></a>Binding request parameters to method parameters with @RequestParam</h4></div></div></div>

<p>Use the <code class="literal">@RequestParam</code> annotation to bind request parameters to a method parameter in
your controller.</p>
<p>The following code snippet shows the usage:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("/pets")</span></i>
<i><span class="hl-annotation" style="color: gray">@SessionAttributes("pet")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> EditPetForm {

    <span class="hl-comment">// ...</span>

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(method = RequestMethod.GET)</span></i>
    <span class="hl-keyword">public</span> String setupForm(<span class="strong"><strong>@RequestParam("petId") int petId</strong></span>, ModelMap model) {
        Pet pet = <span class="hl-keyword">this</span>.clinic.loadPet(petId);
        model.addAttribute(<span class="hl-string">"pet"</span>, pet);
        <span class="hl-keyword">return</span> <span class="hl-string">"petForm"</span>;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>Parameters using this annotation are required by default, but you can specify that a
parameter is optional by setting <code class="literal">@RequestParam</code>'s <code class="literal">required</code> attribute to <code class="literal">false</code>
(e.g., <code class="literal">@RequestParam(value="id", required=false)</code>).</p>
<p>Type conversion is applied automatically if the target method parameter type is not
<code class="literal">String</code>. See <a class="xref" href="#mvc-ann-typeconversion" title="Method Parameters And Type Conversion">the section called &#8220;Method Parameters And Type Conversion&#8221;</a>.</p>
</div>
<div class="section" title="Mapping the request body with the @RequestBody annotation"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestbody"></a>Mapping the request body with the @RequestBody annotation</h4></div></div></div>

<p>The <code class="literal">@RequestBody</code> method parameter annotation indicates that a method parameter should
be bound to the value of the HTTP request body. For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/something", method = RequestMethod.PUT)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(<i><span class="hl-annotation" style="color: gray">@RequestBody</span></i> String body, Writer writer) <span class="hl-keyword">throws</span> IOException {
    writer.write(body);
}</pre>

<p>You convert the request body to the method argument by using an <code class="literal">HttpMessageConverter</code>.
<code class="literal">HttpMessageConverter</code> is responsible for converting from the HTTP request message to an
object and converting from an object to the HTTP response body. The
<code class="literal">RequestMappingHandlerAdapter</code> supports the <code class="literal">@RequestBody</code> annotation with the following
default <code class="literal">HttpMessageConverters</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">ByteArrayHttpMessageConverter</code> converts byte arrays.
</li><li class="listitem">
<code class="literal">StringHttpMessageConverter</code> converts strings.
</li><li class="listitem">
<code class="literal">FormHttpMessageConverter</code> converts form data to/from a MultiValueMap&lt;String, String&gt;.
</li><li class="listitem">
<code class="literal">SourceHttpMessageConverter</code> converts to/from a javax.xml.transform.Source.
</li></ul></div>

<p>For more information on these converters, see <a class="link" href="#rest-message-conversion" title="21.10.2&nbsp;HTTP Message Conversion">Message
Converters</a>. Also note that if using the MVC namespace or the MVC Java config, a wider
range of message converters are registered by default. See <a class="xref" href="#mvc-config-enable" title="16.16.1&nbsp;Enabling the MVC Java Config or the MVC XML Namespace">Section&nbsp;16.16.1, &#8220;Enabling the MVC Java Config or the MVC XML Namespace&#8221;</a> for more information.</p>
<p>If you intend to read and write XML, you will need to configure the
<code class="literal">MarshallingHttpMessageConverter</code> with a specific <code class="literal">Marshaller</code> and an <code class="literal">Unmarshaller</code>
implementation from the <code class="literal">org.springframework.oxm</code> package. The example below shows how
to do that directly in your configuration but if your application is configured through
the MVC namespace or the MVC Java config see <a class="xref" href="#mvc-config-enable" title="16.16.1&nbsp;Enabling the MVC Java Config or the MVC XML Namespace">Section&nbsp;16.16.1, &#8220;Enabling the MVC Java Config or the MVC XML Namespace&#8221;</a> instead.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageConverters"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;util:list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"beanList"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"stringHttpMessageConverter"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"marshallingHttpMessageConverter"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/util:list&gt;</span>
    <span class="hl-tag">&lt;/property
&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stringHttpMessageConverter"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.converter.StringHttpMessageConverter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingHttpMessageConverter"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.converter.xml.MarshallingHttpMessageConverter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"castorMarshaller"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"unmarshaller"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"castorMarshaller"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"castorMarshaller"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.castor.CastorMarshaller"</span><span class="hl-tag">/&gt;</span></pre>

<p>An <code class="literal">@RequestBody</code> method parameter can be annotated with <code class="literal">@Valid</code>, in which case it will
be validated using the configured <code class="literal">Validator</code> instance. When using the MVC namespace or
the MVC Java config, a JSR-303 validator is configured automatically assuming a JSR-303
implementation is available on the classpath.</p>
<p>Just like with <code class="literal">@ModelAttribute</code> parameters, an <code class="literal">Errors</code> argument can be used to examine
the errors. If such an argument is not declared, a <code class="literal">MethodArgumentNotValidException</code>
will be raised. The exception is handled in the <code class="literal">DefaultHandlerExceptionResolver</code>, which
sends a <code class="literal">400</code> error back to the client.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Also see <a class="xref" href="#mvc-config-enable" title="16.16.1&nbsp;Enabling the MVC Java Config or the MVC XML Namespace">Section&nbsp;16.16.1, &#8220;Enabling the MVC Java Config or the MVC XML Namespace&#8221;</a> for
information on configuring message converters and a validator through the MVC namespace
or the MVC Java config.</p>
</td></tr></table></div>

</div>
<div class="section" title="Mapping the response body with the @ResponseBody annotation"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-responsebody"></a>Mapping the response body with the @ResponseBody annotation</h4></div></div></div>

<p>The <code class="literal">@ResponseBody</code> annotation is similar to <code class="literal">@RequestBody</code>. This annotation can be put
on a method and indicates that the return type should be written straight to the HTTP
response body (and not placed in a Model, or interpreted as a view name). For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/something", method = RequestMethod.PUT)</span></i>
<i><span class="hl-annotation" style="color: gray">@ResponseBody</span></i>
<span class="hl-keyword">public</span> String helloWorld() {
    <span class="hl-keyword">return</span> <span class="hl-string">"Hello World"</span>;
}</pre>

<p>The above example will result in the text <code class="literal">Hello World</code> being written to the HTTP
response stream.</p>
<p>As with <code class="literal">@RequestBody</code>, Spring converts the returned object to a response body by using
an <code class="literal">HttpMessageConverter</code>. For more information on these converters, see the previous
section and <a class="link" href="#rest-message-conversion" title="21.10.2&nbsp;HTTP Message Conversion">Message Converters</a>.</p>
</div>
<div class="section" title="Creating REST Controllers with the @RestController annotation"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-restcontroller"></a>Creating REST Controllers with the @RestController annotation</h4></div></div></div>

<p>It&#8217;s a very common use case to have Controllers implement a REST API, thus serving only
JSON, XML or custom MediaType content. For convenience, instead of annotating all your
<code class="literal">@RequestMapping</code> methods with <code class="literal">@ResponseBody</code>, you can annotate your Controller Class
with <code class="literal">@RestController</code>.</p>
<p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-apiorg/springframework/web/bind/annotation/RestController.html" target="_top"><code class="literal">@RestController</code></a>
is a stereotype annotation that combines <code class="literal">@ResponseBody</code> and <code class="literal">@Controller</code>. More than
that, it gives more meaning to your Controller and also may carry additional semantics
in future releases of the framework.</p>
<p>As with regular <code class="literal">@Controllers</code>, a <code class="literal">@RestController</code> may be assisted by a
<code class="literal">@ControllerAdvice</code> Bean. See the <a class="xref" href="#mvc-ann-controller-advice" title="Assisting Controllers with the @ControllerAdvice annotation">the section called &#8220;Assisting Controllers with the @ControllerAdvice annotation&#8221;</a> section for more details.</p>
</div>
<div class="section" title="Using HttpEntity"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-httpentity"></a>Using HttpEntity</h4></div></div></div>

<p>The <code class="literal">HttpEntity</code> is similar to <code class="literal">@RequestBody</code> and <code class="literal">@ResponseBody</code>. Besides getting
access to the request and response body, <code class="literal">HttpEntity</code> (and the response-specific
subclass <code class="literal">ResponseEntity</code>) also allows access to the request and response headers, like
so:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping("/something")</span></i>
<span class="hl-keyword">public</span> ResponseEntity&lt;String&gt; handle(HttpEntity&lt;<span class="hl-keyword">byte</span>[]&gt; requestEntity) <span class="hl-keyword">throws</span> UnsupportedEncodingException {
    String requestHeader = requestEntity.getHeaders().getFirst(<span class="hl-string">"MyRequestHeader"</span>));
    <span class="hl-keyword">byte</span>[] requestBody = requestEntity.getBody();

    <span class="hl-comment">// do something with request header and body</span>

    HttpHeaders responseHeaders = <span class="hl-keyword">new</span> HttpHeaders();
    responseHeaders.set(<span class="hl-string">"MyResponseHeader"</span>, <span class="hl-string">"MyValue"</span>);
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ResponseEntity&lt;String&gt;(<span class="hl-string">"Hello World"</span>, responseHeaders, HttpStatus.CREATED);
}</pre>

<p>The above example gets the value of the <code class="literal">MyRequestHeader</code> request header, and reads the
body as a byte array. It adds the <code class="literal">MyResponseHeader</code> to the response, writes <code class="literal">Hello
World</code> to the response stream, and sets the response status code to 201 (Created).</p>
<p>As with <code class="literal">@RequestBody</code> and <code class="literal">@ResponseBody</code>, Spring uses <code class="literal">HttpMessageConverter</code> to
convert from and to the request and response streams. For more information on these
converters, see the previous section and <a class="link" href="#rest-message-conversion" title="21.10.2&nbsp;HTTP Message Conversion">Message Converters</a>.</p>
</div>
<div class="section" title="Using @ModelAttribute on a method"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-modelattrib-methods"></a>Using @ModelAttribute on a method</h4></div></div></div>

<p>The <code class="literal">@ModelAttribute</code> annotation can be used on methods or on method arguments. This
section explains its usage on methods while the next section explains its usage on
method arguments.</p>
<p>An <code class="literal">@ModelAttribute</code> on a method indicates the purpose of that method is to add one or
more model attributes. Such methods support the same argument types as <code class="literal">@RequestMapping</code>
methods but cannot be mapped directly to requests. Instead <code class="literal">@ModelAttribute</code> methods in
a controller are invoked before <code class="literal">@RequestMapping</code> methods, within the same controller. A
couple of examples:</p>
<pre class="programlisting"><span class="hl-comment">// Add one attribute</span>
<span class="hl-comment">// The return value of the method is added to the model under the name "account"</span>
<span class="hl-comment">// You can customize the name via @ModelAttribute("myAccount")</span>

<i><span class="hl-annotation" style="color: gray">@ModelAttribute</span></i>
<span class="hl-keyword">public</span> Account addAccount(<i><span class="hl-annotation" style="color: gray">@RequestParam</span></i> String number) {
    <span class="hl-keyword">return</span> accountManager.findAccount(number);
}

<span class="hl-comment">// Add multiple attributes</span>

<i><span class="hl-annotation" style="color: gray">@ModelAttribute</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> populateModel(<i><span class="hl-annotation" style="color: gray">@RequestParam</span></i> String number, Model model) {
    model.addAttribute(accountManager.findAccount(number));
    <span class="hl-comment">// add more ...</span>
}</pre>

<p><code class="literal">@ModelAttribute</code> methods are used to populate the model with commonly needed attributes
for example to fill a drop-down with states or with pet types, or to retrieve a command
object like Account in order to use it to represent the data on an HTML form. The latter
case is further discussed in the next section.</p>
<p>Note the two styles of <code class="literal">@ModelAttribute</code> methods. In the first, the method adds an
attribute implicitly by returning it. In the second, the method accepts a <code class="literal">Model</code> and
adds any number of model attributes to it. You can choose between the two styles
depending on your needs.</p>
<p>A controller can have any number of <code class="literal">@ModelAttribute</code> methods. All such methods are
invoked before <code class="literal">@RequestMapping</code> methods of the same controller.</p>
<p><code class="literal">@ModelAttribute</code> methods can also be defined in an <code class="literal">@ControllerAdvice</code>-annotated class
and such methods apply to many controllers. See the <a class="xref" href="#mvc-ann-controller-advice" title="Assisting Controllers with the @ControllerAdvice annotation">the section called &#8220;Assisting Controllers with the @ControllerAdvice annotation&#8221;</a> section
for more details.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>What happens when a model attribute name is not explicitly specified? In such cases a
default name is assigned to the model attribute based on its type. For example if the
method returns an object of type <code class="literal">Account</code>, the default name used is "account". You can
change that through the value of the <code class="literal">@ModelAttribute</code> annotation. If adding attributes
directly to the <code class="literal">Model</code>, use the appropriate overloaded <code class="literal">addAttribute(..)</code> method -
i.e., with or without an attribute name.</p>
</td></tr></table></div>

<p>The <code class="literal">@ModelAttribute</code> annotation can be used on <code class="literal">@RequestMapping</code> methods as well. In
that case the return value of the <code class="literal">@RequestMapping</code> method is interpreted as a model
attribute rather than as a view name. The view name is derived from view name
conventions instead much like for methods returning void&#8201;&#8212;&#8201;see <a class="xref" href="#mvc-coc-r2vnt" title="16.13.3&nbsp;The View - RequestToViewNameTranslator">Section&nbsp;16.13.3, &#8220;The View - RequestToViewNameTranslator&#8221;</a>.</p>
</div>
<div class="section" title="Using @ModelAttribute on a method argument"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-modelattrib-method-args"></a>Using @ModelAttribute on a method argument</h4></div></div></div>

<p>As explained in the previous section <code class="literal">@ModelAttribute</code> can be used on methods or on
method arguments. This section explains its usage on method arguments.</p>
<p>An <code class="literal">@ModelAttribute</code> on a method argument indicates the argument should be retrieved
from the model. If not present in the model, the argument should be instantiated first
and then added to the model. Once present in the model, the argument&#8217;s fields should be
populated from all request parameters that have matching names. This is known as data
binding in Spring MVC, a very useful mechanism that saves you from having to parse each
form field individually.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/owners/{ownerId}/pets/{petId}/edit", method = RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> String processSubmit(<span class="strong"><strong>@ModelAttribute Pet pet</strong></span>) { }</pre>

<p>Given the above example where can the Pet instance come from? There are several options:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
It may already be in the model due to use of <code class="literal">@SessionAttributes</code>&#8201;&#8212;&#8201;see
<a class="xref" href="#mvc-ann-sessionattrib" title="Using @SessionAttributes to store model attributes in the HTTP session between requests">the section called &#8220;Using @SessionAttributes to store model attributes in the HTTP session between requests&#8221;</a>.
</li><li class="listitem">
It may already be in the model due to an <code class="literal">@ModelAttribute</code> method in the same
controller&#8201;&#8212;&#8201;as explained in the previous section.
</li><li class="listitem">
It may be retrieved based on a URI template variable and type converter (explained in
more detail below).
</li><li class="listitem">
It may be instantiated using its default constructor.
</li></ul></div>

<p>An <code class="literal">@ModelAttribute</code> method is a common way to to retrieve an attribute from the
database, which may optionally be stored between requests through the use of
<code class="literal">@SessionAttributes</code>. In some cases it may be convenient to retrieve the attribute by
using an URI template variable and a type converter. Here is an example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/accounts/{account}", method = RequestMethod.PUT)</span></i>
<span class="hl-keyword">public</span> String save(<i><span class="hl-annotation" style="color: gray">@ModelAttribute("account")</span></i> Account account) {

}</pre>

<p>In this example the name of the model attribute (i.e. "account") matches the name of a
URI template variable. If you register <code class="literal">Converter&lt;String, Account&gt;</code> that can turn the
<code class="literal">String</code> account value into an <code class="literal">Account</code> instance, then the above example will work
without the need for an <code class="literal">@ModelAttribute</code> method.</p>
<p>The next step is data binding. The <code class="literal">WebDataBinder</code> class matches request parameter names&#8201;&#8212;&#8201;including query string parameters and form fields&#8201;&#8212;&#8201;to model attribute fields by
name. Matching fields are populated after type conversion (from String to the target
field type) has been applied where necessary. Data binding and validation are covered in
<a class="xref" href="#validation" title="6.&nbsp;Validation, Data Binding, and Type Conversion">Chapter&nbsp;6, <i>Validation, Data Binding, and Type Conversion</i></a>. Customizing the data binding process for a controller level is covered
in <a class="xref" href="#mvc-ann-webdatabinder" title="Customizing WebDataBinder initialization">the section called &#8220;Customizing WebDataBinder initialization&#8221;</a>.</p>
<p>As a result of data binding there may be errors such as missing required fields or type
conversion errors. To check for such errors add a <code class="literal">BindingResult</code> argument immediately
following the <code class="literal">@ModelAttribute</code> argument:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/owners/{ownerId}/pets/{petId}/edit", method = RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> String processSubmit(<span class="strong"><strong>@ModelAttribute("pet") Pet pet</strong></span>, BindingResult result) {

    <span class="hl-keyword">if</span> (result.hasErrors()) {
        <span class="hl-keyword">return</span> <span class="hl-string">"petForm"</span>;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>With a <code class="literal">BindingResult</code> you can check if errors were found in which case it&#8217;s common to
render the same form where the errors can be shown with the help of Spring&#8217;s <code class="literal">&lt;errors&gt;</code>
form tag.</p>
<p>In addition to data binding you can also invoke validation using your own custom
validator passing the same <code class="literal">BindingResult</code> that was used to record data binding errors.
That allows for data binding and validation errors to be accumulated in one place and
subsequently reported back to the user:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/owners/{ownerId}/pets/{petId}/edit", method = RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> String processSubmit(<span class="strong"><strong>@ModelAttribute("pet") Pet pet</strong></span>, BindingResult result) {

    <span class="hl-keyword">new</span> PetValidator().validate(pet, result);
    <span class="hl-keyword">if</span> (result.hasErrors()) {
        <span class="hl-keyword">return</span> <span class="hl-string">"petForm"</span>;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>Or you can have validation invoked automatically by adding the JSR-303 <code class="literal">@Valid</code>
annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/owners/{ownerId}/pets/{petId}/edit", method = RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> String processSubmit(<span class="strong"><strong>@Valid @ModelAttribute("pet") Pet pet</strong></span>, BindingResult result) {

    <span class="hl-keyword">if</span> (result.hasErrors()) {
        <span class="hl-keyword">return</span> <span class="hl-string">"petForm"</span>;
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>See <a class="xref" href="#validation-beanvalidation" title="6.8&nbsp;Spring Validation">Section&nbsp;6.8, &#8220;Spring Validation&#8221;</a> and <a class="xref" href="#validation" title="6.&nbsp;Validation, Data Binding, and Type Conversion">Chapter&nbsp;6, <i>Validation, Data Binding, and Type Conversion</i></a> for details on how to configure and
use validation.</p>
</div>
<div class="section" title="Using @SessionAttributes to store model attributes in the HTTP session between requests"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-sessionattrib"></a>Using @SessionAttributes to store model attributes in the HTTP session between requests</h4></div></div></div>

<p>The type-level <code class="literal">@SessionAttributes</code> annotation declares session attributes used by a
specific handler. This will typically list the names of model attributes or types of
model attributes which should be transparently stored in the session or some
conversational storage, serving as form-backing beans between subsequent requests.</p>
<p>The following code snippet shows the usage of this annotation, specifying the model
attribute name:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("/editPet.do")</span></i>
<span class="strong"><strong>@SessionAttributes("pet")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> EditPetForm {
    <span class="hl-comment">// ...</span>
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using controller interfaces (e.g., for AOP proxying), make sure to consistently put
<span class="emphasis"><em>all</em></span> your mapping annotations - such as <code class="literal">@RequestMapping</code> and <code class="literal">@SessionAttributes</code> -
on the controller <span class="emphasis"><em>interface</em></span> rather than on the implementation class.</p>
</td></tr></table></div>

</div>
<div class="section" title="Specifying redirect and flash attributes"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-redirect-attributes"></a>Specifying redirect and flash attributes</h4></div></div></div>

<p>By default all model attributes are considered to be exposed as URI template variables
in the redirect URL. Of the remaining attributes those that are primitive types or
collections/arrays of primitive types are automatically appended as query parameters.</p>
<p>In annotated controllers however the model may contain additional attributes originally
added for rendering purposes (e.g. drop-down field values). To gain precise control over
the attributes used in a redirect scenario, an <code class="literal">@RequestMapping</code> method can declare an
argument of type <code class="literal">RedirectAttributes</code> and use it to add attributes for use in
<code class="literal">RedirectView</code>. If the controller method does redirect, the content of
<code class="literal">RedirectAttributes</code> is used. Otherwise the content of the default <code class="literal">Model</code> is used.</p>
<p>The <code class="literal">RequestMappingHandlerAdapter</code> provides a flag called
<code class="literal">"ignoreDefaultModelOnRedirect"</code> that can be used to indicate the content of the default
<code class="literal">Model</code> should never be used if a controller method redirects. Instead the controller
method should declare an attribute of type <code class="literal">RedirectAttributes</code> or if it doesn&#8217;t do so
no attributes should be passed on to <code class="literal">RedirectView</code>. Both the MVC namespace and the MVC
Java config keep this flag set to <code class="literal">false</code> in order to maintain backwards compatibility.
However, for new applications we recommend setting it to <code class="literal">true</code></p>
<p>The <code class="literal">RedirectAttributes</code> interface can also be used to add flash attributes. Unlike
other redirect attributes, which end up in the target redirect URL, flash attributes are
saved in the HTTP session (and hence do not appear in the URL). The model of the
controller serving the target redirect URL automatically receives these flash attributes
after which they are removed from the session. See <a class="xref" href="#mvc-flash-attributes" title="16.6&nbsp;Using flash attributes">Section&nbsp;16.6, &#8220;Using flash attributes&#8221;</a> for an
overview of the general support for flash attributes in Spring MVC.</p>
</div>
<div class="section" title="Working with &#34;application/x-www-form-urlencoded&#34; data"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-form-urlencoded-data"></a>Working with "application/x-www-form-urlencoded" data</h4></div></div></div>

<p>The previous sections covered use of <code class="literal">@ModelAttribute</code> to support form submission
requests from browser clients. The same annotation is recommended for use with requests
from non-browser clients as well. However there is one notable difference when it comes
to working with HTTP PUT requests. Browsers can submit form data via HTTP GET or HTTP
POST. Non-browser clients can also submit forms via HTTP PUT. This presents a challenge
because the Servlet specification requires the <code class="literal">ServletRequest.getParameter*()</code> family
of methods to support form field access only for HTTP POST, not for HTTP PUT.</p>
<p>To support HTTP PUT and PATCH requests, the <code class="literal">spring-web</code> module provides the filter
<code class="literal">HttpPutFormContentFilter</code>, which can be configured in <code class="literal">web.xml</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;filter&gt;</span>
    <span class="hl-tag">&lt;filter-name&gt;</span>httpPutFormFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
    <span class="hl-tag">&lt;filter-class&gt;</span>org.springframework.web.filter.HttpPutFormContentFilter<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>

<span class="hl-tag">&lt;filter-mapping&gt;</span>
    <span class="hl-tag">&lt;filter-name&gt;</span>httpPutFormFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>dispatcherServlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span>

<span class="hl-tag">&lt;servlet&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>dispatcherServlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
<span class="hl-tag">&lt;/servlet&gt;</span></pre>

<p>The above filter intercepts HTTP PUT and PATCH requests with content type
<code class="literal">application/x-www-form-urlencoded</code>, reads the form data from the body of the request,
and wraps the <code class="literal">ServletRequest</code> in order to make the form data available through the
<code class="literal">ServletRequest.getParameter*()</code> family of methods.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As <code class="literal">HttpPutFormContentFilter</code> consumes the body of the request, it should not be
configured for PUT or PATCH URLs that rely on other converters for
<code class="literal">application/x-www-form-urlencoded</code>. This includes <code class="literal">@RequestBody MultiValueMap&lt;String,
String&gt;</code> and <code class="literal">HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt;</code>.</p>
</td></tr></table></div>

</div>
<div class="section" title="Mapping cookie values with the @CookieValue annotation"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-cookievalue"></a>Mapping cookie values with the @CookieValue annotation</h4></div></div></div>

<p>The <code class="literal">@CookieValue</code> annotation allows a method parameter to be bound to the value of an
HTTP cookie.</p>
<p>Let us consider that the following cookie has been received with an http request:</p>

<pre class="literallayout">JSESSIONID=415A4AC178C59DACE0B2C9CA727CDD84</pre>

<p>The following code sample demonstrates how to get the value of the <code class="literal">JSESSIONID</code> cookie:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping("/displayHeaderInfo.do")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> displayHeaderInfo(<span class="strong"><strong>@CookieValue("JSESSIONID")</strong></span> String cookie) {
    <span class="hl-comment">//...</span>
}</pre>

<p>Type conversion is applied automatically if the target method parameter type is not
<code class="literal">String</code>. See <a class="xref" href="#mvc-ann-typeconversion" title="Method Parameters And Type Conversion">the section called &#8220;Method Parameters And Type Conversion&#8221;</a>.</p>
<p>This annotation is supported for annotated handler methods in Servlet and Portlet
environments.</p>
</div>
<div class="section" title="Mapping request header attributes with the @RequestHeader annotation"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-requestheader"></a>Mapping request header attributes with the @RequestHeader annotation</h4></div></div></div>

<p>The <code class="literal">@RequestHeader</code> annotation allows a method parameter to be bound to a request header.</p>
<p>Here is a sample request header:</p>

<pre class="literallayout">Host                    localhost:8080
Accept                  text/html,application/xhtml+xml,application/xml;q=0.9
Accept-Language         fr,en-gb;q=0.7,en;q=0.3
Accept-Encoding         gzip,deflate
Accept-Charset          ISO-8859-1,utf-8;q=0.7,*;q=0.7
Keep-Alive              300</pre>

<p>The following code sample demonstrates how to get the value of the <code class="literal">Accept-Encoding</code> and
<code class="literal">Keep-Alive</code> headers:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping("/displayHeaderInfo.do")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> displayHeaderInfo(<span class="strong"><strong>@RequestHeader("Accept-Encoding")</strong></span> String encoding,
        <span class="strong"><strong>@RequestHeader("Keep-Alive")</strong></span> <span class="hl-keyword">long</span> keepAlive) {
    <span class="hl-comment">//...</span>
}</pre>

<p>Type conversion is applied automatically if the method parameter is not <code class="literal">String</code>. See
<a class="xref" href="#mvc-ann-typeconversion" title="Method Parameters And Type Conversion">the section called &#8220;Method Parameters And Type Conversion&#8221;</a>.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Built-in support is available for converting a comma-separated string into an
array/collection of strings or other types known to the type conversion system. For
example a method parameter annotated with <code class="literal">@RequestHeader("Accept")</code> may be of type
<code class="literal">String</code> but also <code class="literal">String[]</code> or <code class="literal">List&lt;String&gt;</code>.</p>
</td></tr></table></div>

<p>This annotation is supported for annotated handler methods in Servlet and Portlet
environments.</p>
</div>
<div class="section" title="Method Parameters And Type Conversion"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-typeconversion"></a>Method Parameters And Type Conversion</h4></div></div></div>

<p>String-based values extracted from the request including request parameters, path
variables, request headers, and cookie values may need to be converted to the target
type of the method parameter or field (e.g., binding a request parameter to a field in
an <code class="literal">@ModelAttribute</code> parameter) they&#8217;re bound to. If the target type is not <code class="literal">String</code>,
Spring automatically converts to the appropriate type. All simple types such as int,
long, Date, etc. are supported. You can further customize the conversion process through
a <code class="literal">WebDataBinder</code> (see <a class="xref" href="#mvc-ann-webdatabinder" title="Customizing WebDataBinder initialization">the section called &#8220;Customizing WebDataBinder initialization&#8221;</a>) or by registering <code class="literal">Formatters</code> with
the <code class="literal">FormattingConversionService</code> (see <a class="xref" href="#format" title="6.6&nbsp;Spring Field Formatting">Section&nbsp;6.6, &#8220;Spring Field Formatting&#8221;</a>).</p>
</div>
<div class="section" title="Customizing WebDataBinder initialization"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-webdatabinder"></a>Customizing WebDataBinder initialization</h4></div></div></div>

<p>To customize request parameter binding with PropertyEditors through Spring&#8217;s
<code class="literal">WebDataBinder</code>, you can use <code class="literal">@InitBinder</code>-annotated methods within your controller,
<code class="literal">@InitBinder</code> methods within an <code class="literal">@ControllerAdvice</code> class, or provide a custom
<code class="literal">WebBindingInitializer</code>. See the <a class="xref" href="#mvc-ann-controller-advice" title="Assisting Controllers with the @ControllerAdvice annotation">the section called &#8220;Assisting Controllers with the @ControllerAdvice annotation&#8221;</a> section for more details.</p>
<div class="section" title="Customizing data binding with @InitBinder"><div class="titlepage"><div><div><h5 class="title"><a name="mvc-ann-initbinder"></a>Customizing data binding with @InitBinder</h5></div></div></div>

<p>Annotating controller methods with <code class="literal">@InitBinder</code> allows you to configure web data
binding directly within your controller class. <code class="literal">@InitBinder</code> identifies methods that
initialize the <code class="literal">WebDataBinder</code> that will be used to populate command and form object
arguments of annotated handler methods.</p>
<p>Such init-binder methods support all arguments that <code class="literal">@RequestMapping</code> supports, except
for command/form objects and corresponding validation result objects. Init-binder
methods must not have a return value. Thus, they are usually declared as <code class="literal">void</code>. Typical
arguments include <code class="literal">WebDataBinder</code> in combination with <code class="literal">WebRequest</code> or
<code class="literal">java.util.Locale</code>, allowing code to register context-specific editors.</p>
<p>The following example demonstrates the use of <code class="literal">@InitBinder</code> to configure a
<code class="literal">CustomDateEditor</code> for all <code class="literal">java.util.Date</code> form properties.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFormController {

    <span class="strong"><strong>@InitBinder</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> initBinder(WebDataBinder binder) {
        SimpleDateFormat dateFormat = <span class="hl-keyword">new</span> SimpleDateFormat(<span class="hl-string">"yyyy-MM-dd"</span>);
        dateFormat.setLenient(false);
        binder.registerCustomEditor(Date.<span class="hl-keyword">class</span>, <span class="hl-keyword">new</span> CustomDateEditor(dateFormat, false));
    }

    <span class="hl-comment">// ...</span>

}</pre>

</div>
<div class="section" title="Configuring a custom WebBindingInitializer"><div class="titlepage"><div><div><h5 class="title"><a name="mvc-ann-webbindinginitializer"></a>Configuring a custom WebBindingInitializer</h5></div></div></div>

<p>To externalize data binding initialization, you can provide a custom implementation of
the <code class="literal">WebBindingInitializer</code> interface, which you then enable by supplying a custom bean
configuration for an <code class="literal">AnnotationMethodHandlerAdapter</code>, thus overriding the default
configuration.</p>
<p>The following example from the PetClinic application shows a configuration using a
custom implementation of the <code class="literal">WebBindingInitializer</code> interface,
<code class="literal">org.springframework.samples.petclinic.web.ClinicBindingInitializer</code>, which configures
PropertyEditors required by several of the PetClinic controllers.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheSeconds"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"webBindingInitializer"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.petclinic.web.ClinicBindingInitializer"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p><code class="literal">@InitBinder</code> methods can also be defined in an <code class="literal">@ControllerAdvice</code>-annotated class in
which case they apply to matching controllers. This provides an alternative to using a
<code class="literal">WebBindingInitializer</code>. See the <a class="xref" href="#mvc-ann-controller-advice" title="Assisting Controllers with the @ControllerAdvice annotation">the section called &#8220;Assisting Controllers with the @ControllerAdvice annotation&#8221;</a> section for more details.</p>
</div>
</div>
<div class="section" title="Support for the Last-Modified Response Header To Facilitate Content Caching"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-lastmodified"></a>Support for the Last-Modified Response Header To Facilitate Content Caching</h4></div></div></div>

<p>An <code class="literal">@RequestMapping</code> method may wish to support <code class="literal">'Last-Modified'</code> HTTP requests, as
defined in the contract for the Servlet API&#8217;s <code class="literal">getLastModified</code> method, to facilitate
content caching. This involves calculating a lastModified <code class="literal">long</code> value for a given
request, comparing it against the <code class="literal">'If-Modified-Since'</code> request header value, and
potentially returning a response with status code 304 (Not Modified). An annotated
controller method can achieve that as follows:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping</span></i>
<span class="hl-keyword">public</span> String myHandleMethod(WebRequest webRequest, Model model) {

    <span class="hl-keyword">long</span> lastModified = <span class="hl-comment">// 1. application-specific calculation</span>

    <span class="hl-keyword">if</span> (request.checkNotModified(lastModified)) {
        <span class="hl-comment">// 2. shortcut exit - no further processing necessary</span>
        <span class="hl-keyword">return</span> null;
    }

    <span class="hl-comment">// 3. or otherwise further request processing, actually preparing content</span>
    model.addAttribute(...);
    <span class="hl-keyword">return</span> <span class="hl-string">"myViewName"</span>;
}</pre>

<p>There are two key elements to note: calling <code class="literal">request.checkNotModified(lastModified)</code> and
returning <code class="literal">null</code>. The former sets the response status to 304 before it returns <code class="literal">true</code>.
The latter, in combination with the former, causes Spring MVC to do no further
processing of the request.</p>
</div>
<div class="section" title="Assisting Controllers with the @ControllerAdvice annotation"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-controller-advice"></a>Assisting Controllers with the @ControllerAdvice annotation</h4></div></div></div>

<p>The <code class="literal">@ControllerAdvice</code> annotation is a component annotation allowing implementation
classes to be autodetected through classpath scanning. It is automatically enabled when
using the MVC namespace or the MVC Java config.</p>
<p>Classes annotated with <code class="literal">@ControllerAdvice</code> can contain <code class="literal">@ExceptionHandler</code>,
<code class="literal">@InitBinder</code>, and <code class="literal">@ModelAttribute</code> annotated methods and those will apply to
<code class="literal">@RequestMapping</code> methods across controller hierarchies as opposed to the controller
hierarchy within which they are declared.</p>
<p>The <code class="literal">@ControllerAdvice</code> annotation can also target a subset of controllers with its
attributes:</p>
<pre class="programlisting"><span class="hl-comment">// Target all Controllers annotated with @RestController</span>
<i><span class="hl-annotation" style="color: gray">@ControllerAdvice(annotations = RestController.class)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnnotationAdvice {}

<span class="hl-comment">// Target all Controllers within specific packages</span>
<i><span class="hl-annotation" style="color: gray">@ControllerAdvice("org.example.controllers")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BasePackageAdvice {}

<span class="hl-comment">// Target all Controllers assignable to specific classes</span>
<i><span class="hl-annotation" style="color: gray">@ControllerAdvice(assignableTypes = {ControllerInterface.class, AbstractController.class})</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AssignableTypesAdvice {}</pre>

<p>Check out the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/bind/annotation/ControllerAdvice.html" target="_top"><code class="literal">@ControllerAdvice</code>
documentation</a> for more details.</p>
</div>
</div>
<div class="section" title="16.3.4&nbsp;Asynchronous Request Processing"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-async"></a>16.3.4&nbsp;Asynchronous Request Processing</h3></div></div></div>

<p>Spring MVC 3.2 introduced Servlet 3 based asynchronous request processing. Instead of
returning a value, as usual, a controller method can now return a
<code class="literal">java.util.concurrent.Callable</code> and produce the return value from a separate thread.
Meanwhile the main Servlet container thread is released and allowed to process other
requests. Spring MVC invokes the <code class="literal">Callable</code> in a separate thread with the help of a
<code class="literal">TaskExecutor</code> and when the <code class="literal">Callable</code> returns, the request is dispatched back to the
Servlet container to resume processing with the value returned by the <code class="literal">Callable</code>. Here
is an example controller method:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(method=RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> Callable&lt;String&gt; processUpload(<span class="hl-keyword">final</span> MultipartFile file) {

    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Callable&lt;String&gt;() {
        <span class="hl-keyword">public</span> String call() <span class="hl-keyword">throws</span> Exception {
            <span class="hl-comment">// ...</span>
            <span class="hl-keyword">return</span> <span class="hl-string">"someView"</span>;
        }
    };

}</pre>

<p>A second option is for the controller to return an instance of <code class="literal">DeferredResult</code>. In this
case the return value will also be produced from a separate thread. However, that thread
is not known to Spring MVC. For example the result may be produced in response to some
external event such as a JMS message, a scheduled task, etc. Here is an example
controller method:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping("/quotes")</span></i>
<i><span class="hl-annotation" style="color: gray">@ResponseBody</span></i>
<span class="hl-keyword">public</span> DeferredResult&lt;String&gt; quotes() {
    DeferredResult&lt;String&gt; deferredResult = <span class="hl-keyword">new</span> DeferredResult&lt;String&gt;();
    <span class="hl-comment">// Save the deferredResult in in-memory queue ...</span>
    <span class="hl-keyword">return</span> deferredResult;
}

<span class="hl-comment">// In some other thread...</span>
deferredResult.setResult(data);</pre>

<p>This may be difficult to understand without any knowledge of the Servlet 3 async
processing feature. It would certainly help to read up on it. At a very minimum consider
the following basic facts:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
A <code class="literal">ServletRequest</code> can be put in asynchronous mode by calling <code class="literal">request.startAsync()</code>.
The main effect of doing so is that the Servlet, as well as any Filters, can exit but
the response will remain open allowing some other thread to complete processing.
</li><li class="listitem">
The call to <code class="literal">request.startAsync()</code> returns an <code class="literal">AsyncContext</code>, which can be used for
further control over async processing. For example it provides the method <code class="literal">dispatch</code>,
which can be called from an application thread in order to "dispatch" the request back
to the Servlet container. An async dispatch is similar to a forward except it is made
from one (application) thread to another (Servlet container) thread whereas a forward
occurs synchronously in the same (Servlet container) thread.
</li><li class="listitem">
<code class="literal">ServletRequest</code> provides access to the current <code class="literal">DispatcherType</code>, which can be used to
distinguish if a <code class="literal">Servlet</code> or a <code class="literal">Filter</code> is processing on the initial request
processing thread and when it is processing in an async dispatch.
</li></ul></div>

<p>With the above in mind, the following is the sequence of events for async request
processing with a <code class="literal">Callable</code>: (1) Controller returns a <code class="literal">Callable</code>, (2) Spring MVC starts
async processing and submits the <code class="literal">Callable</code> to a <code class="literal">TaskExecutor</code> for processing in a
separate thread, (3) the <code class="literal">DispatcherServlet</code> and all Filter&#8217;s exit the request
processing thread but the response remains open, (4) the <code class="literal">Callable</code> produces a result
and Spring MVC dispatches the request back to the Servlet container, (5) the
<code class="literal">DispatcherServlet</code> is invoked again and processing resumes with the asynchronously
produced result from the <code class="literal">Callable</code>. The exact sequencing of (2), (3), and (4) may vary
depending on the speed of execution of the concurrent threads.</p>
<p>The sequence of events for async request processing with a <code class="literal">DeferredResult</code> is the same
in principal except it&#8217;s up to the application to produce the asynchronous result from
some thread: (1) Controller returns a <code class="literal">DeferredResult</code> and saves it in some in-memory
queue or list where it can be accessed, (2) Spring MVC starts async processing, (3) the
<code class="literal">DispatcherServlet</code> and all configured Filter&#8217;s exit the request processing thread but
the response remains open, (4) the application sets the <code class="literal">DeferredResult</code> from some
thread and Spring MVC dispatches the request back to the Servlet container, (5) the
<code class="literal">DispatcherServlet</code> is invoked again and processing resumes with the asynchronously
produced result.</p>
<p>Explaining the motivation for async request processing and when or why to use it are
beyond the scope of this document. For further information you may wish to read
<a class="ulink" href="http://spring.io/blog/2012/05/07/spring-mvc-3-2-preview-introducing-servlet-3-async-support" target="_top">this
blog post series</a>.</p>
<div class="section" title="Exception Handling for Async Requests"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-async-exceptions"></a>Exception Handling for Async Requests</h4></div></div></div>

<p>What happens if a <code class="literal">Callable</code> returned from a controller method raises an Exception while
being executed? The effect is similar to what happens when any controller method raises
an exception. It is handled by a matching <code class="literal">@ExceptionHandler</code> method in the same
controller or by one of the configured <code class="literal">HandlerExceptionResolver</code> instances.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Under the covers, when a <code class="literal">Callable</code> raises an Exception, Spring MVC still dispatches to
the Servlet container to resume processing. The only difference is that the result of
executing the <code class="literal">Callable</code> is an <code class="literal">Exception</code> that must be processed with the configured
<code class="literal">HandlerExceptionResolver</code> instances.</p>
</td></tr></table></div>

<p>When using a <code class="literal">DeferredResult</code>, you have a choice of calling its <code class="literal">setErrorResult(Object)</code>
method and provide an <code class="literal">Exception</code> or any other Object you&#8217;d like to use as the result.
If the result is an <code class="literal">Exception</code>, it will be processed with a matching
<code class="literal">@ExceptionHandler</code> method in the same controller or with any configured
<code class="literal">HandlerExceptionResolver</code> instance.</p>
</div>
<div class="section" title="Intercepting Async Requests"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-async-interception"></a>Intercepting Async Requests</h4></div></div></div>

<p>An existing <code class="literal">HandlerInterceptor</code> can implement <code class="literal">AsyncHandlerInterceptor</code>, which provides
one additional method <code class="literal">afterConcurrentHandlingStarted</code>. It is invoked after async
processing starts and when the initial request processing thread is being exited. See
the Javadoc of <code class="literal">AsyncHandlerInterceptor</code> for more details on that.</p>
<p>Further options for async request lifecycle callbacks are provided directly on
<code class="literal">DeferredResult</code>, which has the methods <code class="literal">onTimeout(Runnable)</code> and
<code class="literal">onCompletion(Runnable)</code>. Those are called when the async request is about to time out
or has completed respectively. The timeout event can be handled by setting the
<code class="literal">DeferredResult</code> to some value. The completion callback however is final and the result
can no longer be set.</p>
<p>Similar callbacks are also available with a <code class="literal">Callable</code>. However, you will need to wrap
the <code class="literal">Callable</code> in an instance of <code class="literal">WebAsyncTask</code> and then use that to register the
timeout and completion callbacks. Just like with <code class="literal">DeferredResult</code>, the timeout event can
be handled and a value can be returned while the completion event is final.</p>
<p>You can also register a <code class="literal">CallableProcessingInterceptor</code> or a
<code class="literal">DeferredResultProcessingInterceptor</code> globally through the MVC Java config or the MVC
namespace. Those interceptors provide a full set of callbacks and apply every time a
<code class="literal">Callable</code> or a <code class="literal">DeferredResult</code> is used.</p>
</div>
<div class="section" title="Configuration for Async Request Processing"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-ann-async-configuration"></a>Configuration for Async Request Processing</h4></div></div></div>

<div class="section" title="Servlet 3 Async Config"><div class="titlepage"><div><div><h5 class="title"><a name="mvc-ann-async-configuration-servlet3"></a>Servlet 3 Async Config</h5></div></div></div>

<p>To use Servlet 3 async request processing, you need to update <code class="literal">web.xml</code> to version 3.0:</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span>
    <span class="hl-attribute">version</span>=<span class="hl-value">"3.0"</span><span class="hl-tag">&gt;</span>

    ...

<span class="hl-tag">&lt;/web-app&gt;</span></pre>

<p>The <code class="literal">DispatcherServlet</code> and any <code class="literal">Filter</code> configuration need to have the
<code class="literal">&lt;async-supported&gt;true&lt;/async-supported&gt;</code> sub-element. Additionally, any <code class="literal">Filter</code> that
also needs to get involved in async dispatches should also be configured to support the
ASYNC dispatcher type. Note that it is safe to enable the ASYNC dispatcher type for all
filters provided with the Spring Framework since they will not get involved in async
dispatches unless needed.</p>
<p>If using Servlet 3, Java based configuration, e.g. via <code class="literal">WebApplicationInitializer</code>,
you&#8217;ll also need to set the "asyncSupported" flag as well as the ASYNC dispatcher type
just like with <code class="literal">web.xml</code>. To simplify all this configuration, consider extending
<code class="literal">AbstractDispatcherServletInitializer</code> or
<code class="literal">AbstractAnnotationConfigDispatcherServletInitializer</code>, which automatically set those
options and make it very easy to register <code class="literal">Filter</code> instances.</p>
</div>
<div class="section" title="Spring MVC Async Config"><div class="titlepage"><div><div><h5 class="title"><a name="mvc-ann-async-configuration-spring-mvc"></a>Spring MVC Async Config</h5></div></div></div>

<p>The MVC Java config and the MVC namespace both provide options for configuring async
request processing. <code class="literal">WebMvcConfigurer</code> has the method <code class="literal">configureAsyncSupport</code> while
&lt;mvc:annotation-driven&gt; has an &lt;async-support&gt; sub-element.</p>
<p>Those allow you to configure the default timeout value to use for async requests, which
if not set depends on the underlying Servlet container (e.g. 10 seconds on Tomcat). You
can also configure an <code class="literal">AsyncTaskExecutor</code> to use for executing <code class="literal">Callable</code> instances
returned from controller methods. It is highly recommended to configure this property
since by default Spring MVC uses <code class="literal">SimpleAsyncTaskExecutor</code>. The MVC Java config and the
MVC namespace also allow you to register <code class="literal">CallableProcessingInterceptor</code> and
<code class="literal">DeferredResultProcessingInterceptor</code> instances.</p>
<p>If you need to override the default timeout value for a specific <code class="literal">DeferredResult</code>, you
can do so by using the appropriate class constructor. Similarly, for a <code class="literal">Callable</code>, you
can wrap it in a <code class="literal">WebAsyncTask</code> and use the appropriate class constructor to customize
the timeout value. The class constructor of <code class="literal">WebAsyncTask</code> also allows providing an
<code class="literal">AsyncTaskExecutor</code>.</p>
</div>
</div>
</div>
<div class="section" title="16.3.5&nbsp;Testing Controllers"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-tests"></a>16.3.5&nbsp;Testing Controllers</h3></div></div></div>

<p>The <code class="literal">spring-test</code> module offers first class support for testing annotated controllers.
See <a class="xref" href="#spring-mvc-test-framework" title="10.3.6&nbsp;Spring MVC Test Framework">Section&nbsp;10.3.6, &#8220;Spring MVC Test Framework&#8221;</a>.</p>
</div>
</div>
<div class="section" title="16.4&nbsp;Handler mappings"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-handlermapping"></a>16.4&nbsp;Handler mappings</h2></div></div></div>

<p>In previous versions of Spring, users were required to define one or more
<code class="literal">HandlerMapping</code> beans in the web application context to map incoming web requests to
appropriate handlers. With the introduction of annotated controllers, you generally
don&#8217;t need to do that because the <code class="literal">RequestMappingHandlerMapping</code> automatically looks for
<code class="literal">@RequestMapping</code> annotations on all <code class="literal">@Controller</code> beans. However, do keep in mind that
all <code class="literal">HandlerMapping</code> classes extending from <code class="literal">AbstractHandlerMapping</code> have the following
properties that you can use to customize their behavior:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">interceptors</code> List of interceptors to use. <code class="literal">HandlerInterceptor</code> s are discussed in
<a class="xref" href="#mvc-handlermapping-interceptor" title="16.4.1&nbsp;Intercepting requests with a HandlerInterceptor">Section&nbsp;16.4.1, &#8220;Intercepting requests with a HandlerInterceptor&#8221;</a>.
</li><li class="listitem">
<code class="literal">defaultHandler</code> Default handler to use, when this handler mapping does not result in
a matching handler.
</li><li class="listitem">
<code class="literal">order</code> Based on the value of the order property (see the
<code class="literal">org.springframework.core.Ordered</code> interface), Spring sorts all handler mappings
available in the context and applies the first matching handler.
</li><li class="listitem">
<code class="literal">alwaysUseFullPath</code> If <code class="literal">true</code> , Spring uses the full path within the current Servlet
context to find an appropriate handler. If <code class="literal">false</code> (the default), the path within the
current Servlet mapping is used. For example, if a Servlet is mapped using
<code class="literal">/testing/*</code> and the <code class="literal">alwaysUseFullPath</code> property is set to true,
<code class="literal">/testing/viewPage.html</code> is used, whereas if the property is set to false,
<code class="literal">/viewPage.html</code> is used.
</li><li class="listitem">
<code class="literal">urlDecode</code> Defaults to <code class="literal">true</code>, as of Spring 2.5. If you prefer to compare encoded
paths, set this flag to <code class="literal">false</code>. However, the <code class="literal">HttpServletRequest</code> always exposes the
Servlet path in decoded form. Be aware that the Servlet path will not match when
compared with encoded paths.
</li></ul></div>

<p>The following example shows how to configure an interceptor:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"handlerMapping"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptors"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.MyInterceptor"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;beans&gt;</span></pre>

<div class="section" title="16.4.1&nbsp;Intercepting requests with a HandlerInterceptor"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-handlermapping-interceptor"></a>16.4.1&nbsp;Intercepting requests with a HandlerInterceptor</h3></div></div></div>

<p>Spring&#8217;s handler mapping mechanism includes handler interceptors, which are useful when
you want to apply specific functionality to certain requests, for example, checking for
a principal.</p>
<p>Interceptors located in the handler mapping must implement <code class="literal">HandlerInterceptor</code> from the
<code class="literal">org.springframework.web.servlet</code> package. This interface defines three methods:
<code class="literal">preHandle(..)</code> is called <span class="emphasis"><em>before</em></span> the actual handler is executed; <code class="literal">postHandle(..)</code> is
called <span class="emphasis"><em>after</em></span> the handler is executed; and <code class="literal">afterCompletion(..)</code> is called <span class="emphasis"><em>after
the complete request has finished</em></span>. These three methods should provide enough
flexibility to do all kinds of preprocessing and postprocessing.</p>
<p>The <code class="literal">preHandle(..)</code> method returns a boolean value. You can use this method to break or
continue the processing of the execution chain. When this method returns <code class="literal">true</code>, the
handler execution chain will continue; when it returns false, the <code class="literal">DispatcherServlet</code>
assumes the interceptor itself has taken care of requests (and, for example, rendered an
appropriate view) and does not continue executing the other interceptors and the actual
handler in the execution chain.</p>
<p>Interceptors can be configured using the <code class="literal">interceptors</code> property, which is present on
all <code class="literal">HandlerMapping</code> classes extending from <code class="literal">AbstractHandlerMapping</code>. This is shown in
the example below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"handlerMapping"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptors"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"officeHoursInterceptor"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"officeHoursInterceptor"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"samples.TimeBasedAccessInterceptor"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"openingTime"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"9"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"closingTime"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"18"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">package</span> samples;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TimeBasedAccessInterceptor <span class="hl-keyword">extends</span> HandlerInterceptorAdapter {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> openingTime;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> closingTime;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setOpeningTime(<span class="hl-keyword">int</span> openingTime) {
        <span class="hl-keyword">this</span>.openingTime = openingTime;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setClosingTime(<span class="hl-keyword">int</span> closingTime) {
        <span class="hl-keyword">this</span>.closingTime = closingTime;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> preHandle(HttpServletRequest request, HttpServletResponse response,
            Object handler) <span class="hl-keyword">throws</span> Exception {
        Calendar cal = Calendar.getInstance();
        <span class="hl-keyword">int</span> hour = cal.get(HOUR_OF_DAY);
        <span class="hl-keyword">if</span> (openingTime &lt;= hour &amp;&amp; hour &lt; closingTime) {
            <span class="hl-keyword">return</span> true;
        }
        response.sendRedirect(<span class="hl-string">"http://host.com/outsideOfficeHours.html"</span>);
        <span class="hl-keyword">return</span> false;
    }
}</pre>

<p>Any request handled by this mapping is intercepted by the <code class="literal">TimeBasedAccessInterceptor</code>.
If the current time is outside office hours, the user is redirected to a static HTML
file that says, for example, you can only access the website during office hours.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <code class="literal">RequestMappingHandlerMapping</code> the actual handler is an instance of
<code class="literal">HandlerMethod</code> which identifies the specific controller method that will be invoked.</p>
</td></tr></table></div>

<p>As you can see, the Spring adapter class <code class="literal">HandlerInterceptorAdapter</code> makes it easier to
extend the <code class="literal">HandlerInterceptor</code> interface.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>In the example above, the configured interceptor will apply to all requests handled with
annotated controller methods. If you want to narrow down the URL paths to which an
interceptor applies, you can use the MVC namespace or the MVC Java config, or declare
bean instances of type <code class="literal">MappedInterceptor</code> to do that. See <a class="xref" href="#mvc-config-enable" title="16.16.1&nbsp;Enabling the MVC Java Config or the MVC XML Namespace">Section&nbsp;16.16.1, &#8220;Enabling the MVC Java Config or the MVC XML Namespace&#8221;</a>.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="16.5&nbsp;Resolving views"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-viewresolver"></a>16.5&nbsp;Resolving views</h2></div></div></div>

<p>All MVC frameworks for web applications provide a way to address views. Spring provides
view resolvers, which enable you to render models in a browser without tying you to a
specific view technology. Out of the box, Spring enables you to use JSPs, Velocity
templates and XSLT views, for example. See <a class="xref" href="#view" title="17.&nbsp;View technologies">Chapter&nbsp;17, <i>View technologies</i></a> for a discussion of how to integrate
and use a number of disparate view technologies.</p>
<p>The two interfaces that are important to the way Spring handles views are <code class="literal">ViewResolver</code>
and <code class="literal">View</code>. The <code class="literal">ViewResolver</code> provides a mapping between view names and actual views.
The <code class="literal">View</code> interface addresses the preparation of the request and hands the request over
to one of the view technologies.</p>
<div class="section" title="16.5.1&nbsp;Resolving views with the ViewResolver interface"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-viewresolver-resolver"></a>16.5.1&nbsp;Resolving views with the ViewResolver interface</h3></div></div></div>

<p>As discussed in <a class="xref" href="#mvc-controller" title="16.3&nbsp;Implementing Controllers">Section&nbsp;16.3, &#8220;Implementing Controllers&#8221;</a>, all handler methods in the Spring Web MVC
controllers must resolve to a logical view name, either explicitly (e.g., by returning a
<code class="literal">String</code>, <code class="literal">View</code>, or <code class="literal">ModelAndView</code>) or implicitly (i.e., based on conventions). Views
in Spring are addressed by a logical view name and are resolved by a view resolver.
Spring comes with quite a few view resolvers. This table lists most of them; a couple of
examples follow.</p>
<div class="table"><a name="mvc-view-resolvers-tbl"></a><p class="title"><b>Table&nbsp;16.3.&nbsp;View resolvers</b></p><div class="table-contents">

  <table summary="View resolvers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">ViewResolver</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">AbstractCachingViewResolver</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Abstract view resolver that caches views. Often views need preparation before they can
  be used; extending this view resolver provides caching.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">XmlViewResolver</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Implementation of <code class="literal">ViewResolver</code> that accepts a configuration file written in XML with
  the same DTD as Spring&#8217;s XML bean factories. The default configuration file is
  <code class="literal">/WEB-INF/views.xml</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ResourceBundleViewResolver</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Implementation of <code class="literal">ViewResolver</code> that uses bean definitions in a <code class="literal">ResourceBundle</code>,
  specified by the bundle base name. Typically you define the bundle in a properties
  file, located in the classpath. The default file name is <code class="literal">views.properties</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">UrlBasedViewResolver</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple implementation of the <code class="literal">ViewResolver</code> interface that effects the direct
  resolution of logical view names to URLs, without an explicit mapping definition. This
  is appropriate if your logical names match the names of your view resources in a
  straightforward manner, without the need for arbitrary mappings.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">InternalResourceViewResolver</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Convenient subclass of <code class="literal">UrlBasedViewResolver</code> that supports <code class="literal">InternalResourceView</code> (in
  effect, Servlets and JSPs) and subclasses such as <code class="literal">JstlView</code> and <code class="literal">TilesView</code>. You can
  specify the view class for all views generated by this resolver by using
  <code class="literal">setViewClass(..)</code>. See the Javadocs for the <code class="literal">UrlBasedViewResolver</code> class for details.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">VelocityViewResolver</code> / <code class="literal">FreeMarkerViewResolver</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Convenient subclass of <code class="literal">UrlBasedViewResolver</code> that supports <code class="literal">VelocityView</code> (in effect,
  Velocity templates) or <code class="literal">FreeMarkerView</code> ,respectively, and custom subclasses of them.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ContentNegotiatingViewResolver</code></p></td><td style="" align="left" valign="top"><p>Implementation of the <code class="literal">ViewResolver</code> interface that resolves a view based on the
  request file name or <code class="literal">Accept</code> header. See <a class="xref" href="#mvc-multiple-representations" title="16.5.4&nbsp;ContentNegotiatingViewResolver">Section&nbsp;16.5.4, &#8220;ContentNegotiatingViewResolver&#8221;</a>.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>As an example, with JSP as a view technology, you can use the <code class="literal">UrlBasedViewResolver</code>.
This view resolver translates a view name to a URL and hands the request over to the
RequestDispatcher to render the view.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.UrlBasedViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"viewClass"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.web.servlet.view.JstlView"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/jsp/"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".jsp"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>When returning <code class="literal">test</code> as a logical view name, this view resolver forwards the request to
the <code class="literal">RequestDispatcher</code> that will send the request to <code class="literal">/WEB-INF/jsp/test.jsp</code>.</p>
<p>When you combine different view technologies in a web application, you can use the
<code class="literal">ResourceBundleViewResolver</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.ResourceBundleViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"views"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"defaultParentView"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"parentView"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">ResourceBundleViewResolver</code> inspects the <code class="literal">ResourceBundle</code> identified by the
basename, and for each view it is supposed to resolve, it uses the value of the property
<code class="literal">[viewname].(class)</code> as the view class and the value of the property <code class="literal">[viewname].url</code> as
the view url. Examples can be found in the next chapter which covers view technologies.
As you can see, you can identify a parent view, from which all views in the properties
file "extend". This way you can specify a default view class, for example.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Subclasses of <code class="literal">AbstractCachingViewResolver</code> cache view instances that they resolve.
Caching improves performance of certain view technologies. It&#8217;s possible to turn off the
cache by setting the <code class="literal">cache</code> property to <code class="literal">false</code>. Furthermore, if you must refresh a
certain view at runtime (for example when a Velocity template is modified), you can use
the <code class="literal">removeFromCache(String viewName, Locale loc)</code> method.</p>
</td></tr></table></div>

</div>
<div class="section" title="16.5.2&nbsp;Chaining ViewResolvers"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-viewresolver-chaining"></a>16.5.2&nbsp;Chaining ViewResolvers</h3></div></div></div>

<p>Spring supports multiple view resolvers. Thus you can chain resolvers and, for example,
override specific views in certain circumstances. You chain view resolvers by adding
more than one resolver to your application context and, if necessary, by setting the
<code class="literal">order</code> property to specify ordering. Remember, the higher the order property, the later
the view resolver is positioned in the chain.</p>
<p>In the following example, the chain of view resolvers consists of two resolvers, an
<code class="literal">InternalResourceViewResolver</code>, which is always automatically positioned as the last
resolver in the chain, and an <code class="literal">XmlViewResolver</code> for specifying Excel views. Excel views
are not supported by the <code class="literal">InternalResourceViewResolver</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jspViewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"viewClass"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.web.servlet.view.JstlView"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/jsp/"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".jsp"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"excelViewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.XmlViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"order"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"location"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/views.xml"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-comment">&lt;!-- in views.xml --&gt;</span>

<span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"report"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.example.ReportExcelView"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>If a specific view resolver does not result in a view, Spring examines the context for
other view resolvers. If additional view resolvers exist, Spring continues to inspect
them until a view is resolved. If no view resolver returns a view, Spring throws a
<code class="literal">ServletException</code>.</p>
<p>The contract of a view resolver specifies that a view resolver <span class="emphasis"><em>can</em></span> return null to
indicate the view could not be found. Not all view resolvers do this, however, because
in some cases, the resolver simply cannot detect whether or not the view exists. For
example, the <code class="literal">InternalResourceViewResolver</code> uses the <code class="literal">RequestDispatcher</code> internally, and
dispatching is the only way to figure out if a JSP exists, but this action can only
execute once. The same holds for the <code class="literal">VelocityViewResolver</code> and some others. Check the
Javadoc for the view resolver to see whether it reports non-existing views. Thus,
putting an <code class="literal">InternalResourceViewResolver</code> in the chain in a place other than the last,
results in the chain not being fully inspected, because the
<code class="literal">InternalResourceViewResolver</code> will <span class="emphasis"><em>always</em></span> return a view!</p>
</div>
<div class="section" title="16.5.3&nbsp;Redirecting to views"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-redirecting"></a>16.5.3&nbsp;Redirecting to views</h3></div></div></div>

<p>As mentioned previously, a controller typically returns a logical view name, which a
view resolver resolves to a particular view technology. For view technologies such as
JSPs that are processed through the Servlet or JSP engine, this resolution is usually
handled through the combination of <code class="literal">InternalResourceViewResolver</code> and
<code class="literal">InternalResourceView</code>, which issues an internal forward or include via the Servlet
API&#8217;s <code class="literal">RequestDispatcher.forward(..)</code> method or <code class="literal">RequestDispatcher.include()</code> method.
For other view technologies, such as Velocity, XSLT, and so on, the view itself writes
the content directly to the response stream.</p>
<p>It is sometimes desirable to issue an HTTP redirect back to the client, before the view
is rendered. This is desirable, for example, when one controller has been called with
<code class="literal">POST</code> data, and the response is actually a delegation to another controller (for
example on a successful form submission). In this case, a normal internal forward will
mean that the other controller will also see the same <code class="literal">POST</code> data, which is potentially
problematic if it can confuse it with other expected data. Another reason to perform a
redirect before displaying the result is to eliminate the possibility of the user
submitting the form data multiple times. In this scenario, the browser will first send
an initial <code class="literal">POST</code>; it will then receive a response to redirect to a different URL; and
finally the browser will perform a subsequent <code class="literal">GET</code> for the URL named in the redirect
response. Thus, from the perspective of the browser, the current page does not reflect
the result of a <code class="literal">POST</code> but rather of a <code class="literal">GET</code>. The end effect is that there is no way the
user can accidentally re- <code class="literal">POST</code> the same data by performing a refresh. The refresh
forces a <code class="literal">GET</code> of the result page, not a resend of the initial <code class="literal">POST</code> data.</p>
<div class="section" title="RedirectView"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-redirecting-redirect-view"></a>RedirectView</h4></div></div></div>

<p>One way to force a redirect as the result of a controller response is for the controller
to create and return an instance of Spring&#8217;s <code class="literal">RedirectView</code>. In this case,
<code class="literal">DispatcherServlet</code> does not use the normal view resolution mechanism. Rather because it
has been given the (redirect) view already, the <code class="literal">DispatcherServlet</code> simply instructs the
view to do its work.</p>
<p>The <code class="literal">RedirectView</code> issues an <code class="literal">HttpServletResponse.sendRedirect()</code> call that returns to
the client browser as an HTTP redirect. By default all model attributes are considered
to be exposed as URI template variables in the redirect URL. Of the remaining attributes
those that are primitive types or collections/arrays of primitive types are
automatically appended as query parameters.</p>
<p>Appending primitive type attributes as query parameters may be the desired result if a
model instance was prepared specifically for the redirect. However, in annotated
controllers the model may contain additional attributes added for rendering purposes
(e.g. drop-down field values). To avoid the possibility of having such attributes appear
in the URL an annotated controller can declare an argument of type <code class="literal">RedirectAttributes</code>
and use it to specify the exact attributes to make available to <code class="literal">RedirectView</code>. If the
controller method decides to redirect, the content of <code class="literal">RedirectAttributes</code> is used.
Otherwise the content of the model is used.</p>
<p>Note that URI template variables from the present request are automatically made
available when expanding a redirect URL and do not need to be added explicitly neither
through <code class="literal">Model</code> nor <code class="literal">RedirectAttributes</code>. For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/files/{path}", method = RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> String upload(...) {
    <span class="hl-comment">// ...</span>
    <span class="hl-keyword">return</span> <span class="hl-string">"redirect:files/{path}"</span>;
}</pre>

<p>If you use <code class="literal">RedirectView</code> and the view is created by the controller itself, it is
recommended that you configure the redirect URL to be injected into the controller so
that it is not baked into the controller but configured in the context along with the
view names. The next section discusses this process.</p>
</div>
<div class="section" title="The redirect: prefix"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-redirecting-redirect-prefix"></a>The redirect: prefix</h4></div></div></div>

<p>While the use of <code class="literal">RedirectView</code> works fine, if the controller itself creates the
<code class="literal">RedirectView</code>, there is no avoiding the fact that the controller is aware that a
redirection is happening. This is really suboptimal and couples things too tightly. The
controller should not really care about how the response gets handled. In general it
should operate only in terms of view names that have been injected into it.</p>
<p>The special <code class="literal">redirect:</code> prefix allows you to accomplish this. If a view name is returned
that has the prefix <code class="literal">redirect:</code>, the <code class="literal">UrlBasedViewResolver</code> (and all subclasses) will
recognize this as a special indication that a redirect is needed. The rest of the view
name will be treated as the redirect URL.</p>
<p>The net effect is the same as if the controller had returned a <code class="literal">RedirectView</code>, but now
the controller itself can simply operate in terms of logical view names. A logical view
name such as <code class="literal">redirect:/myapp/some/resource</code> will redirect relative to the current
Servlet context, while a name such as <code class="literal">redirect:http://myhost.com/some/arbitrary/path</code>
will redirect to an absolute URL.</p>
</div>
<div class="section" title="The forward: prefix"><div class="titlepage"><div><div><h4 class="title"><a name="mvc-redirecting-forward-prefix"></a>The forward: prefix</h4></div></div></div>

<p>It is also possible to use a special <code class="literal">forward:</code> prefix for view names that are
ultimately resolved by <code class="literal">UrlBasedViewResolver</code> and subclasses. This creates an
<code class="literal">InternalResourceView</code> (which ultimately does a <code class="literal">RequestDispatcher.forward()</code>) around
the rest of the view name, which is considered a URL. Therefore, this prefix is not
useful with <code class="literal">InternalResourceViewResolver</code> and <code class="literal">InternalResourceView</code> (for JSPs for
example). But the prefix can be helpful when you are primarily using another view
technology, but still want to force a forward of a resource to be handled by the
Servlet/JSP engine. (Note that you may also chain multiple view resolvers, instead.)</p>
<p>As with the <code class="literal">redirect:</code> prefix, if the view name with the <code class="literal">forward:</code> prefix is injected
into the controller, the controller does not detect that anything special is happening
in terms of handling the response.</p>
</div>
</div>
<div class="section" title="16.5.4&nbsp;ContentNegotiatingViewResolver"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-multiple-representations"></a>16.5.4&nbsp;ContentNegotiatingViewResolver</h3></div></div></div>

<p>The <code class="literal">ContentNegotiatingViewResolver</code> does not resolve views itself but rather delegates
to other view resolvers, selecting the view that resembles the representation requested
by the client. Two strategies exist for a client to request a representation from the
server:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Use a distinct URI for each resource, typically by using a different file extension in
the URI. For example, the URI <code class="literal">http://www.example.com/users/fred.pdf</code> requests a PDF
representation of the user fred, and <code class="literal">http://www.example.com/users/fred.xml</code> requests
an XML representation.
</li><li class="listitem">
Use the same URI for the client to locate the resource, but set the <code class="literal">Accept</code> HTTP
request header to list the <a class="ulink" href="http://en.wikipedia.org/wiki/Internet_media_type" target="_top">media
types</a> that it understands. For example, an HTTP request for
<code class="literal">http://www.example.com/users/fred</code> with an <code class="literal">Accept</code> header set to <code class="literal">application/pdf</code>
requests a PDF representation of the user fred, while
<code class="literal">http://www.example.com/users/fred</code> with an <code class="literal">Accept</code> header set to <code class="literal">text/xml</code> requests
an XML representation. This strategy is known as
<a class="ulink" href="http://en.wikipedia.org/wiki/Content_negotiation" target="_top">content negotiation</a>.
</li></ul></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>One issue with the <code class="literal">Accept</code> header is that it is impossible to set it in a web browser
within HTML. For example, in Firefox, it is fixed to:</p>

<pre class="literallayout">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<span class="strong"><strong>/</strong></span>;q=0.8</pre>

<p>For this reason it is common to see the use of a distinct URI for each representation
when developing browser based web applications.</p>
</td></tr></table></div>

<p>To support multiple representations of a resource, Spring provides the
<code class="literal">ContentNegotiatingViewResolver</code> to resolve a view based on the file extension or
<code class="literal">Accept</code> header of the HTTP request. <code class="literal">ContentNegotiatingViewResolver</code> does not perform
the view resolution itself but instead delegates to a list of view resolvers that you
specify through the bean property <code class="literal">ViewResolvers</code>.</p>
<p>The <code class="literal">ContentNegotiatingViewResolver</code> selects an appropriate <code class="literal">View</code> to handle the request
by comparing the request media type(s) with the media type (also known as
<code class="literal">Content-Type</code>) supported by the <code class="literal">View</code> associated with each of its <code class="literal">ViewResolvers</code>. The
first <code class="literal">View</code> in the list that has a compatible <code class="literal">Content-Type</code> returns the representation
to the client. If a compatible view cannot be supplied by the <code class="literal">ViewResolver</code> chain, then
the list of views specified through the <code class="literal">DefaultViews</code> property will be consulted. This
latter option is appropriate for singleton <code class="literal">Views</code> that can render an appropriate
representation of the current resource regardless of the logical view name. The <code class="literal">Accept</code>
header may include wild cards, for example <code class="literal">text/*</code>, in which case a <code class="literal">View</code> whose
Content-Type was <code class="literal">text/xml</code> is a compatible match.</p>
<p>To support the resolution of a view based on a file extension, use the
<code class="literal">ContentNegotiatingViewResolver</code> bean property <code class="literal">mediaTypes</code> to specify a mapping of file
extensions to media types. For more information on the algorithm used to determine the
request media type, refer to the API documentation for <code class="literal">ContentNegotiatingViewResolver</code>.</p>
<p>Here is an example configuration of a <code class="literal">ContentNegotiatingViewResolver:</code></p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.ContentNegotiatingViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mediaTypes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"atom"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"application/atom+xml"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"html"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"text/html"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"json"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"application/json"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"viewResolvers"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.BeanNameViewResolver"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/jsp/"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".jsp"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"defaultViews"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.json.MappingJackson2JsonView"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"content"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.springsource.samples.rest.SampleContentAtomView"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">InternalResourceViewResolver</code> handles the translation of view names and JSP pages,
while the <code class="literal">BeanNameViewResolver</code> returns a view based on the name of a bean. (See
"<a class="link" href="#mvc-viewresolver-resolver" title="16.5.1&nbsp;Resolving views with the ViewResolver interface">Resolving views with the ViewResolver interface</a>" for more
details on how Spring looks up and instantiates a view.) In this example, the <code class="literal">content</code>
bean is a class that inherits from <code class="literal">AbstractAtomFeedView</code>, which returns an Atom RSS
feed. For more information on creating an Atom Feed representation, see the section Atom
Views.</p>
<p>In the above configuration, if a request is made with an <code class="literal">.html</code> extension, the view
resolver looks for a view that matches the <code class="literal">text/html</code> media type. The
<code class="literal">InternalResourceViewResolver</code> provides the matching view for <code class="literal">text/html</code>. If the
request is made with the file extension <code class="literal">.atom</code>, the view resolver looks for a view that
matches the <code class="literal">application/atom+xml</code> media type. This view is provided by the
<code class="literal">BeanNameViewResolver</code> that maps to the <code class="literal">SampleContentAtomView</code> if the view name
returned is <code class="literal">content</code>. If the request is made with the file extension <code class="literal">.json</code>, the
<code class="literal">MappingJackson2JsonView</code> instance from the <code class="literal">DefaultViews</code> list will be selected
regardless of the view name. Alternatively, client requests can be made without a file
extension but with the <code class="literal">Accept</code> header set to the preferred media-type, and the same
resolution of request to views would occur.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If <code class="literal">ContentNegotiatingViewResolver</code>'s list of ViewResolvers is not configured
explicitly, it automatically uses any ViewResolvers defined in the application context.</p>
</td></tr></table></div>

<p>The corresponding controller code that returns an Atom RSS feed for a URI of the form
<code class="literal">http://localhost/content.atom</code> or <code class="literal">http://localhost/content</code> with an <code class="literal">Accept</code> header of
application/atom+xml is shown below.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContentController {

    <span class="hl-keyword">private</span> List&lt;SampleContent&gt; contentList = <span class="hl-keyword">new</span> ArrayList&lt;SampleContent&gt;();

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/content", method=RequestMethod.GET)</span></i>
    <span class="hl-keyword">public</span> ModelAndView getContent() {
        ModelAndView mav = <span class="hl-keyword">new</span> ModelAndView();
        mav.setViewName(<span class="hl-string">"content"</span>);
        mav.addObject(<span class="hl-string">"sampleContentList"</span>, contentList);
        <span class="hl-keyword">return</span> mav;
    }

}</pre>

</div>
</div>
<div class="section" title="16.6&nbsp;Using flash attributes"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-flash-attributes"></a>16.6&nbsp;Using flash attributes</h2></div></div></div>

<p>Flash attributes provide a way for one request to store attributes intended for use in
another. This is most commonly needed when redirecting&#8201;&#8212;&#8201;for example, the
<span class="emphasis"><em>Post/Redirect/Get</em></span> pattern. Flash attributes are saved temporarily before the
redirect (typically in the session) to be made available to the request after the
redirect and removed immediately.</p>
<p>Spring MVC has two main abstractions in support of flash attributes. <code class="literal">FlashMap</code> is used
to hold flash attributes while <code class="literal">FlashMapManager</code> is used to store, retrieve, and manage
<code class="literal">FlashMap</code> instances.</p>
<p>Flash attribute support is always "on" and does not need to enabled explicitly although
if not used, it never causes HTTP session creation. On each request there is an "input"
<code class="literal">FlashMap</code> with attributes passed from a previous request (if any) and an "output"
<code class="literal">FlashMap</code> with attributes to save for a subsequent request. Both <code class="literal">FlashMap</code> instances
are accessible from anywhere in Spring MVC through static methods in
<code class="literal">RequestContextUtils</code>.</p>
<p>Annotated controllers typically do not need to work with <code class="literal">FlashMap</code> directly. Instead an
<code class="literal">@RequestMapping</code> method can accept an argument of type <code class="literal">RedirectAttributes</code> and use it
to add flash attributes for a redirect scenario. Flash attributes added via
<code class="literal">RedirectAttributes</code> are automatically propagated to the "output" FlashMap. Similarly
after the redirect attributes from the "input" <code class="literal">FlashMap</code> are automatically added to the
<code class="literal">Model</code> of the controller serving the target URL.</p>
<div class="sidebar" title="Matching requests to flash attributes"><p class="title"><b>Matching requests to flash attributes</b></p>

<p>The concept of flash attributes exists in many other Web frameworks and has proven to be
exposed sometimes to concurrency issues. This is because by definition flash attributes
are to be stored until the next request. However the very "next" request may not be the
intended recipient but another asynchronous request (e.g. polling or resource requests)
in which case the flash attributes are removed too early.</p>
<p>To reduce the possibility of such issues, <code class="literal">RedirectView</code> automatically "stamps"
<code class="literal">FlashMap</code> instances with the path and query parameters of the target redirect URL. In
turn the default <code class="literal">FlashMapManager</code> matches that information to incoming requests when
looking up the "input" <code class="literal">FlashMap</code>.</p>
<p>This does not eliminate the possibility of a concurrency issue entirely but nevertheless
reduces it greatly with information that is already available in the redirect URL.
Therefore the use of flash attributes is recommended mainly for redirect scenarios .</p>
</div>

</div>
<div class="section" title="16.7&nbsp;Building URIs"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-construct-encode-uri"></a>16.7&nbsp;Building URIs</h2></div></div></div>

<p>Spring MVC provides a mechanism for building and encoding a URI using
<code class="literal">UriComponentsBuilder</code> and <code class="literal">UriComponents</code>.</p>
<p>For example you can expand and encode a URI template string:</p>
<pre class="programlisting">UriComponents uriComponents = UriComponentsBuilder.fromUriString(
        <span class="hl-string">"http://example.com/hotels/{hotel}/bookings/{booking}"</span>).build();

URI uri = uriComponents.expand(<span class="hl-string">"42"</span>, <span class="hl-string">"21"</span>).encode().toUri();</pre>

<p>Note that <code class="literal">UriComponents</code> is immutable and the <code class="literal">expand()</code> and <code class="literal">encode()</code> operations
return new instances if necessary.</p>
<p>You can also expand and encode using individual URI components:</p>
<pre class="programlisting">UriComponents uriComponents = UriComponentsBuilder.newInstance()
        .scheme(<span class="hl-string">"http"</span>).host(<span class="hl-string">"example.com"</span>).path(<span class="hl-string">"/hotels/{hotel}/bookings/{booking}"</span>).build()
        .expand(<span class="hl-string">"42"</span>, <span class="hl-string">"21"</span>)
        .encode();</pre>

<p>In a Servlet environment the <code class="literal">ServletUriComponentsBuilder</code> sub-class provides static
factory methods to copy available URL information from a Servlet requests:</p>
<pre class="programlisting">HttpServletRequest request = ...

<span class="hl-comment">// Re-use host, scheme, port, path and query string</span>
<span class="hl-comment">// Replace the "accountId" query param</span>

ServletUriComponentsBuilder ucb = ServletUriComponentsBuilder.fromRequest(request)
        .replaceQueryParam(<span class="hl-string">"accountId"</span>, <span class="hl-string">"{id}"</span>).build()
        .expand(<span class="hl-string">"123"</span>)
        .encode();</pre>

<p>Alternatively, you may choose to copy a subset of the available information up to and
including the context path:</p>
<pre class="programlisting"><span class="hl-comment">// Re-use host, port and context path</span>
<span class="hl-comment">// Append "/accounts" to the path</span>

ServletUriComponentsBuilder ucb = ServletUriComponentsBuilder.fromContextPath(request)
        .path(<span class="hl-string">"/accounts"</span>).build()</pre>

<p>Or in cases where the <code class="literal">DispatcherServlet</code> is mapped by name (e.g. <code class="literal">/main/*</code>), you can
also have the literal part of the servlet mapping included:</p>
<pre class="programlisting"><span class="hl-comment">// Re-use host, port, context path</span>
<span class="hl-comment">// Append the literal part of the servlet mapping to the path</span>
<span class="hl-comment">// Append "/accounts" to the path</span>

ServletUriComponentsBuilder ucb = ServletUriComponentsBuilder.fromServletMapping(request)
        .path(<span class="hl-string">"/accounts"</span>).build()</pre>

</div>
<div class="section" title="16.8&nbsp;Building URIs to Controllers and methods"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-construct-uri-controllers"></a>16.8&nbsp;Building URIs to Controllers and methods</h2></div></div></div>

<p>Spring MVC provides another mechanism for building and encoding URIs that link to
Controllers and methods defined within an application.
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/MvcUriComponentsBuilder.html" target="_top"><code class="literal">MvcUriComponentsBuilder</code></a>
extends <code class="literal">UriComponentsBuilder</code> and provides such possibilities.</p>
<p>Given this Controller:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("/hotels/{hotel}")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BookingController {

    <i><span class="hl-annotation" style="color: gray">@RequestMapping("/bookings/{booking}")</span></i>
    <span class="hl-keyword">public</span> String getBooking(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> Long booking) {

    <span class="hl-comment">// ...</span>

}</pre>

<p>and using the <code class="literal">MvcUriComponentsBuilder</code>, the previous example is now:</p>
<pre class="programlisting">UriComponents uriComponents = MvcUriComponentsBuilder
    .fromMethodName(BookingController.<span class="hl-keyword">class</span>, <span class="hl-string">"getBooking"</span>,<span class="hl-number">21</span>).buildAndExpand(<span class="hl-number">42</span>);

URI uri = uriComponents.encode().toUri();</pre>

<p>The <code class="literal">MvcUriComponentsBuilder</code> can also create "mock Controllers", thus enabling to create
URIs by coding against the actual Controller&#8217;s API:</p>
<pre class="programlisting">UriComponents uriComponents = MvcUriComponentsBuilder
    .fromMethodCall(on(BookingController.<span class="hl-keyword">class</span>).getBooking(<span class="hl-number">21</span>)).buildAndExpand(<span class="hl-number">42</span>);

URI uri = uriComponents.encode().toUri();</pre>

</div>
<div class="section" title="16.9&nbsp;Using locales"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-localeresolver"></a>16.9&nbsp;Using locales</h2></div></div></div>

<p>Most parts of Spring&#8217;s architecture support internationalization, just as the Spring web
MVC framework does. <code class="literal">DispatcherServlet</code> enables you to automatically resolve messages
using the client&#8217;s locale. This is done with <code class="literal">LocaleResolver</code> objects.</p>
<p>When a request comes in, the <code class="literal">DispatcherServlet</code> looks for a locale resolver, and if it
finds one it tries to use it to set the locale. Using the <code class="literal">RequestContext.getLocale()</code>
method, you can always retrieve the locale that was resolved by the locale resolver.</p>
<p>In addition to automatic locale resolution, you can also attach an interceptor to the
handler mapping (see <a class="xref" href="#mvc-handlermapping-interceptor" title="16.4.1&nbsp;Intercepting requests with a HandlerInterceptor">Section&nbsp;16.4.1, &#8220;Intercepting requests with a HandlerInterceptor&#8221;</a> for more information on handler
mapping interceptors) to change the locale under specific circumstances, for example,
based on a parameter in the request.</p>
<p>Locale resolvers and interceptors are defined in the
<code class="literal">org.springframework.web.servlet.i18n</code> package and are configured in your application
context in the normal way. Here is a selection of the locale resolvers included in
Spring.</p>
<div class="section" title="16.9.1&nbsp;Obtaining Time Zone Information"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-timezone"></a>16.9.1&nbsp;Obtaining Time Zone Information</h3></div></div></div>

<p>In addition to obtaining the client&#8217;s locale, it is often useful to know their time zone.
The <code class="literal">LocaleContextResolver</code> interface offers an extension to <code class="literal">LocaleResolver</code> that allows
resolvers to provide a richer <code class="literal">LocaleContext</code>, which may include time zone information.</p>
<p>When available, the user&#8217;s <code class="literal">TimeZone</code> can be obtained using the
<code class="literal">RequestContext.getTimeZone()</code> method. Time zone information will automatically be used
by Date/Time <code class="literal">Converter</code> and <code class="literal">Formatter</code> objects registered with Spring&#8217;s
<code class="literal">ConversionService</code>.</p>
</div>
<div class="section" title="16.9.2&nbsp;AcceptHeaderLocaleResolver"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-localeresolver-acceptheader"></a>16.9.2&nbsp;AcceptHeaderLocaleResolver</h3></div></div></div>

<p>This locale resolver inspects the <code class="literal">accept-language</code> header in the request that was sent
by the client (e.g., a web browser). Usually this header field contains the locale of
the client&#8217;s operating system. <span class="emphasis"><em>Note that this resolver does not support time zone
information.</em></span></p>
</div>
<div class="section" title="16.9.3&nbsp;CookieLocaleResolver"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-localeresolver-cookie"></a>16.9.3&nbsp;CookieLocaleResolver</h3></div></div></div>

<p>This locale resolver inspects a <code class="literal">Cookie</code> that might exist on the client to see if a
<code class="literal">Locale</code> or <code class="literal">TimeZone</code> is specified. If so, it uses the specified details. Using the
properties of this locale resolver, you can specify the name of the cookie as well as the
maximum age. Find below an example of defining a <code class="literal">CookieLocaleResolver</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"localeResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.i18n.CookieLocaleResolver"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cookieName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"clientlanguage"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- in seconds. If set to -1, the cookie is not persisted (deleted when browser shuts down) --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cookieMaxAge"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100000"</span><span class="hl-tag">&gt;</span>

<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="table"><a name="mvc-cookie-locale-resolver-props-tbl"></a><p class="title"><b>Table&nbsp;16.4.&nbsp;CookieLocaleResolver properties</b></p><div class="table-contents">

  <table summary="CookieLocaleResolver properties" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Default</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cookieName</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>classname + LOCALE</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the cookie</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cookieMaxAge</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Integer.MAX_INT</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The maximum time a cookie will stay persistent on the client. If -1 is specified, the
  cookie will not be persisted; it will only be available until the client shuts down
  their browser.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>cookiePath</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>/</p></td><td style="" align="left" valign="top"><p>Limits the visibility of the cookie to a certain part of your site. When cookiePath is
  specified, the cookie will only be visible to that path and the paths below it.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="16.9.4&nbsp;SessionLocaleResolver"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-localeresolver-session"></a>16.9.4&nbsp;SessionLocaleResolver</h3></div></div></div>

<p>The <code class="literal">SessionLocaleResolver</code> allows you to retrieve <code class="literal">Locale</code> and <code class="literal">TimeZone</code> from the
session that might be associated with the user&#8217;s request.</p>
</div>
<div class="section" title="16.9.5&nbsp;LocaleChangeInterceptor"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-localeresolver-interceptor"></a>16.9.5&nbsp;LocaleChangeInterceptor</h3></div></div></div>

<p>You can enable changing of locales by adding the <code class="literal">LocaleChangeInterceptor</code> to one of the
handler mappings (see <a class="xref" href="#mvc-handlermapping" title="16.4&nbsp;Handler mappings">Section&nbsp;16.4, &#8220;Handler mappings&#8221;</a>). It will detect a parameter in the request
and change the locale. It calls <code class="literal">setLocale()</code> on the <code class="literal">LocaleResolver</code> that also exists
in the context. The following example shows that calls to all <code class="literal">*.view</code> resources
containing a parameter named <code class="literal">siteLanguage</code> will now change the locale. So, for example,
a request for the following URL, <code class="literal">http://www.sf.net/home.view?siteLanguage=nl</code> will
change the site language to Dutch.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"localeChangeInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.i18n.LocaleChangeInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"paramName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"siteLanguage"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"localeResolver"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.i18n.CookieLocaleResolver"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"urlMapping"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptors"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"localeChangeInterceptor"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappings"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;value&gt;</span>/<span class="strong"><strong>*/</strong></span>.view=someController<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
</div>
<div class="section" title="16.10&nbsp;Using themes"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-themeresolver"></a>16.10&nbsp;Using themes</h2></div></div></div>

<div class="section" title="16.10.1&nbsp;Overview of themes"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-themeresolver-introduction"></a>16.10.1&nbsp;Overview of themes</h3></div></div></div>

<p>You can apply Spring Web MVC framework themes to set the overall look-and-feel of your
application, thereby enhancing user experience. A theme is a collection of static
resources, typically style sheets and images, that affect the visual style of the
application.</p>
</div>
<div class="section" title="16.10.2&nbsp;Defining themes"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-themeresolver-defining"></a>16.10.2&nbsp;Defining themes</h3></div></div></div>

<p>To use themes in your web application, you must set up an implementation of the
<code class="literal">org.springframework.ui.context.ThemeSource</code> interface. The <code class="literal">WebApplicationContext</code>
interface extends <code class="literal">ThemeSource</code> but delegates its responsibilities to a dedicated
implementation. By default the delegate will be an
<code class="literal">org.springframework.ui.context.support.ResourceBundleThemeSource</code> implementation that
loads properties files from the root of the classpath. To use a custom <code class="literal">ThemeSource</code>
implementation or to configure the base name prefix of the <code class="literal">ResourceBundleThemeSource</code>,
you can register a bean in the application context with the reserved name <code class="literal">themeSource</code>.
The web application context automatically detects a bean with that name and uses it.</p>
<p>When using the <code class="literal">ResourceBundleThemeSource</code>, a theme is defined in a simple properties
file. The properties file lists the resources that make up the theme. Here is an example:</p>

<pre class="literallayout">styleSheet=/themes/cool/style.css
background=/themes/cool/img/coolBg.jpg</pre>

<p>The keys of the properties are the names that refer to the themed elements from view
code. For a JSP, you typically do this using the <code class="literal">spring:theme</code> custom tag, which is
very similar to the <code class="literal">spring:message</code> tag. The following JSP fragment uses the theme
defined in the previous example to customize the look and feel:</p>
<pre class="programlisting"><span class="hl-tag">&lt;%@</span> <span class="hl-attribute">taglib</span> <span class="hl-attribute">prefix</span>=<span class="hl-value">"spring"</span> <span class="hl-attribute">uri</span>=<span class="hl-value">"http://www.springframework.org/tags"</span><span class="hl-attribute">%&gt;</span>
<span class="hl-attribute">&lt;html&gt;</span>
    <span class="hl-attribute">&lt;head&gt;</span>
        <span class="hl-attribute">&lt;link</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">href</span>=<span class="hl-value">"&lt;spring:theme code=</span><span class="emphasis"><em>styleSheet</em></span>/&gt;" type="text/css"/&gt;
    <span class="hl-tag">&lt;/head&gt;</span>
    <span class="hl-tag">&lt;body</span> <span class="hl-attribute">style</span>=<span class="hl-value">"background=&lt;spring:theme code=</span><span class="emphasis"><em>background</em></span>/&gt;"&gt;
        ...
    <span class="hl-tag">&lt;/body&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span></pre>

<p>By default, the <code class="literal">ResourceBundleThemeSource</code> uses an empty base name prefix. As a result,
the properties files are loaded from the root of the classpath. Thus you would put the
<code class="literal">cool.properties</code> theme definition in a directory at the root of the classpath, for
example, in <code class="literal">/WEB-INF/classes</code>. The <code class="literal">ResourceBundleThemeSource</code> uses the standard Java
resource bundle loading mechanism, allowing for full internationalization of themes. For
example, we could have a <code class="literal">/WEB-INF/classes/cool_nl.properties</code> that references a special
background image with Dutch text on it.</p>
</div>
<div class="section" title="16.10.3&nbsp;Theme resolvers"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-themeresolver-resolving"></a>16.10.3&nbsp;Theme resolvers</h3></div></div></div>

<p>After you define themes, as in the preceding section, you decide which theme to use. The
<code class="literal">DispatcherServlet</code> will look for a bean named <code class="literal">themeResolver</code> to find out which
<code class="literal">ThemeResolver</code> implementation to use. A theme resolver works in much the same way as a
<code class="literal">LocaleResolver</code>. It detects the theme to use for a particular request and can also
alter the request&#8217;s theme. The following theme resolvers are provided by Spring:</p>
<div class="table"><a name="mvc-theme-resolver-impls-tbl"></a><p class="title"><b>Table&nbsp;16.5.&nbsp;ThemeResolver implementations</b></p><div class="table-contents">

  <table summary="ThemeResolver implementations" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Class</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">FixedThemeResolver</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Selects a fixed theme, set using the <code class="literal">defaultThemeName</code> property.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SessionThemeResolver</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The theme is maintained in the user&#8217;s HTTP session. It only needs to be set once for
  each session, but is not persisted between sessions.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">CookieThemeResolver</code></p></td><td style="" align="left" valign="top"><p>The selected theme is stored in a cookie on the client.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>Spring also provides a <code class="literal">ThemeChangeInterceptor</code> that allows theme changes on every
request with a simple request parameter.</p>
</div>
</div>
<div class="section" title="16.11&nbsp;Spring&#8217;s multipart (file upload) support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-multipart"></a>16.11&nbsp;Spring&#8217;s multipart (file upload) support</h2></div></div></div>

<div class="section" title="16.11.1&nbsp;Introduction"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-multipart-introduction"></a>16.11.1&nbsp;Introduction</h3></div></div></div>

<p>Spring&#8217;s built-in multipart support handles file uploads in web applications. You enable
this multipart support with pluggable <code class="literal">MultipartResolver</code> objects, defined in the
<code class="literal">org.springframework.web.multipart</code> package. Spring provides one <code class="literal">MultipartResolver</code>
implementation for use with <a class="ulink" href="http://jakarta.apache.org/commons/fileupload" target="_top"><span class="emphasis"><em>Commons
FileUpload</em></span></a> and another for use with Servlet 3.0 multipart request parsing.</p>
<p>By default, Spring does no multipart handling, because some developers want to handle
multiparts themselves. You enable Spring multipart handling by adding a multipart
resolver to the web application&#8217;s context. Each request is inspected to see if it
contains a multipart. If no multipart is found, the request continues as expected. If a
multipart is found in the request, the <code class="literal">MultipartResolver</code> that has been declared in
your context is used. After that, the multipart attribute in your request is treated
like any other attribute.</p>
</div>
<div class="section" title="16.11.2&nbsp;Using a MultipartResolver with Commons FileUpload"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-multipart-resolver-commons"></a>16.11.2&nbsp;Using a MultipartResolver with <span class="emphasis"><em>Commons FileUpload</em></span></h3></div></div></div>

<p>The following example shows how to use the <code class="literal">CommonsMultipartResolver</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"multipartResolver"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- one of the properties available; the maximum file size in bytes --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxUploadSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Of course you also need to put the appropriate jars in your classpath for the multipart
resolver to work. In the case of the <code class="literal">CommonsMultipartResolver</code>, you need to use
<code class="literal">commons-fileupload.jar</code>.</p>
<p>When the Spring <code class="literal">DispatcherServlet</code> detects a multi-part request, it activates the
resolver that has been declared in your context and hands over the request. The resolver
then wraps the current <code class="literal">HttpServletRequest</code> into a <code class="literal">MultipartHttpServletRequest</code> that
supports multipart file uploads. Using the <code class="literal">MultipartHttpServletRequest</code>, you can get
information about the multiparts contained by this request and actually get access to
the multipart files themselves in your controllers.</p>
</div>
<div class="section" title="16.11.3&nbsp;Using a MultipartResolver with Servlet 3.0"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-multipart-resolver-standard"></a>16.11.3&nbsp;Using a MultipartResolver with <span class="emphasis"><em>Servlet 3.0</em></span></h3></div></div></div>

<p>In order to use Servlet 3.0 based multipart parsing, you need to mark the
<code class="literal">DispatcherServlet</code> with a <code class="literal">"multipart-config"</code> section in <code class="literal">web.xml</code>, or with a
<code class="literal">javax.servlet.MultipartConfigElement</code> in programmatic Servlet registration, or in case
of a custom Servlet class possibly with a <code class="literal">javax.servlet.annotation.MultipartConfig</code>
annotation on your Servlet class. Configuration settings such as maximum sizes or
storage locations need to be applied at that Servlet registration level as Servlet 3.0
does not allow for those settings to be done from the MultipartResolver.</p>
<p>Once Servlet 3.0 multipart parsing has been enabled in one of the above mentioned ways
you can add the <code class="literal">StandardServletMultipartResolver</code> to your Spring configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"multipartResolver"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.multipart.support.StandardServletMultipartResolver"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="16.11.4&nbsp;Handling a file upload in a form"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-multipart-forms"></a>16.11.4&nbsp;Handling a file upload in a form</h3></div></div></div>

<p>After the <code class="literal">MultipartResolver</code> completes its job, the request is processed like any
other. First, create a form with a file input that will allow the user to upload a form.
The encoding attribute ( <code class="literal">enctype="multipart/form-data"</code>) lets the browser know how to
encode the form as multipart request:</p>
<pre class="programlisting"><span class="hl-tag">&lt;html&gt;</span>
    <span class="hl-tag">&lt;head&gt;</span>
        <span class="hl-tag">&lt;title&gt;</span>Upload a file please<span class="hl-tag">&lt;/title&gt;</span>
    <span class="hl-tag">&lt;/head&gt;</span>
    <span class="hl-tag">&lt;body&gt;</span>
        <span class="hl-tag">&lt;h1&gt;</span>Please upload a file<span class="hl-tag">&lt;/h1&gt;</span>
        <span class="hl-tag">&lt;form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span> <span class="hl-attribute">action</span>=<span class="hl-value">"/form"</span> <span class="hl-attribute">enctype</span>=<span class="hl-value">"multipart/form-data"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"file"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"file"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/form&gt;</span>
    <span class="hl-tag">&lt;/body&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span></pre>

<p>The next step is to create a controller that handles the file upload. This controller is
very similar to a <a class="link" href="#mvc-ann-controller" title="16.3.1&nbsp;Defining a controller with @Controller">normal annotated <code class="literal">@Controller</code></a>, except that we
use <code class="literal">MultipartHttpServletRequest</code> or <code class="literal">MultipartFile</code> in the method parameters:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadController {

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/form", method = RequestMethod.POST)</span></i>
    <span class="hl-keyword">public</span> String handleFormUpload(<i><span class="hl-annotation" style="color: gray">@RequestParam("name")</span></i> String name,
            <i><span class="hl-annotation" style="color: gray">@RequestParam("file")</span></i> MultipartFile file) {

        <span class="hl-keyword">if</span> (!file.isEmpty()) {
            <span class="hl-keyword">byte</span>[] bytes = file.getBytes();
            <span class="hl-comment">// store the bytes somewhere</span>
            <span class="hl-keyword">return</span> <span class="hl-string">"redirect:uploadSuccess"</span>;
        }

        <span class="hl-keyword">return</span> <span class="hl-string">"redirect:uploadFailure"</span>;
    }

}</pre>

<p>Note how the <code class="literal">@RequestParam</code> method parameters map to the input elements declared in the
form. In this example, nothing is done with the <code class="literal">byte[]</code>, but in practice you can save
it in a database, store it on the file system, and so on.</p>
<p>When using Servlet 3.0 multipart parsing you can also use <code class="literal">javax.servlet.http.Part</code> for
the method parameter:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadController {

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(value = "/form", method = RequestMethod.POST)</span></i>
    <span class="hl-keyword">public</span> String handleFormUpload(<i><span class="hl-annotation" style="color: gray">@RequestParam("name")</span></i> String name,
            <i><span class="hl-annotation" style="color: gray">@RequestParam("file")</span></i> Part file) {

        InputStream inputStream = file.getInputStream();
        <span class="hl-comment">// store bytes from uploaded file somewhere</span>

        <span class="hl-keyword">return</span> <span class="hl-string">"redirect:uploadSuccess"</span>;
    }

}</pre>

</div>
<div class="section" title="16.11.5&nbsp;Handling a file upload request from programmatic clients"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-multipart-forms-non-browsers"></a>16.11.5&nbsp;Handling a file upload request from programmatic clients</h3></div></div></div>

<p>Multipart requests can also be submitted from non-browser clients in a RESTful service
scenario. All of the above examples and configuration apply here as well. However,
unlike browsers that typically submit files and simple form fields, a programmatic
client can also send more complex data of a specific content type&#8201;&#8212;&#8201;for example a
multipart request with a file and second part with JSON formatted data:</p>

<pre class="literallayout">POST /someUrl
Content-Type: multipart/mixed

--edt7Tfrdusa7r3lNQc79vXuhIIMlatb7PQg7Vp
Content-Disposition: form-data; name="meta-data"
Content-Type: application/json; charset=UTF-8
Content-Transfer-Encoding: 8bit

{
	"name": "value"
}
--edt7Tfrdusa7r3lNQc79vXuhIIMlatb7PQg7Vp
Content-Disposition: form-data; name="file-data"; filename="file.properties"
Content-Type: text/xml
Content-Transfer-Encoding: 8bit
... File Data ...</pre>

<p>You could access the part named "meta-data" with a <code class="literal">@RequestParam("meta-data") String
metadata</code> controller method argument. However, you would probably prefer to accept a
strongly typed object initialized from the JSON formatted data in the body of the
request part, very similar to the way <code class="literal">@RequestBody</code> converts the body of a
non-multipart request to a target object with the help of an <code class="literal">HttpMessageConverter</code>.</p>
<p>You can use the <code class="literal">@RequestPart</code> annotation instead of the <code class="literal">@RequestParam</code> annotation for
this purpose. It allows you to have the content of a specific multipart passed through
an <code class="literal">HttpMessageConverter</code> taking into consideration the <code class="literal">'Content-Type'</code> header of the
multipart:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/someUrl", method = RequestMethod.POST)</span></i>
<span class="hl-keyword">public</span> String onSubmit(<span class="strong"><strong>@RequestPart("meta-data") MetaData metadata,
        @RequestPart("file-data") MultipartFile file</strong></span>) {

    <span class="hl-comment">// ...</span>

}</pre>

<p>Notice how <code class="literal">MultipartFile</code> method arguments can be accessed with <code class="literal">@RequestParam</code> or with
<code class="literal">@RequestPart</code> interchangeably. However, the <code class="literal">@RequestPart("meta-data") MetaData</code> method
argument in this case is read as JSON content based on its <code class="literal">'Content-Type'</code> header and
converted with the help of the <code class="literal">MappingJackson2HttpMessageConverter</code>.</p>
</div>
</div>
<div class="section" title="16.12&nbsp;Handling exceptions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-exceptionhandlers"></a>16.12&nbsp;Handling exceptions</h2></div></div></div>

<div class="section" title="16.12.1&nbsp;HandlerExceptionResolver"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-exceptionhandlers-resolver"></a>16.12.1&nbsp;HandlerExceptionResolver</h3></div></div></div>

<p>Spring <code class="literal">HandlerExceptionResolver</code> implementations deal with unexpected exceptions that
occur during controller execution. A <code class="literal">HandlerExceptionResolver</code> somewhat resembles the
exception mappings you can define in the web application descriptor <code class="literal">web.xml</code>. However,
they provide a more flexible way to do so. For example they provide information about
which handler was executing when the exception was thrown. Furthermore, a programmatic
way of handling exceptions gives you more options for responding appropriately before
the request is forwarded to another URL (the same end result as when you use the Servlet
specific exception mappings).</p>
<p>Besides implementing the <code class="literal">HandlerExceptionResolver</code> interface, which is only a matter of
implementing the <code class="literal">resolveException(Exception, Handler)</code> method and returning a
<code class="literal">ModelAndView</code>, you may also use the provided <code class="literal">SimpleMappingExceptionResolver</code> or create
<code class="literal">@ExceptionHandler</code> methods. The <code class="literal">SimpleMappingExceptionResolver</code> enables you to take
the class name of any exception that might be thrown and map it to a view name. This is
functionally equivalent to the exception mapping feature from the Servlet API, but it is
also possible to implement more finely grained mappings of exceptions from different
handlers. The <code class="literal">@ExceptionHandler</code> annotation on the other hand can be used on methods
that should be invoked to handle an exception. Such methods may be defined locally
within an <code class="literal">@Controller</code> or may apply to many <code class="literal">@Controller</code> classes when defined within an
<code class="literal">@ControllerAdvice</code> class. The following sections explain this in more detail.</p>
</div>
<div class="section" title="16.12.2&nbsp;@ExceptionHandler"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-exceptionhandler"></a>16.12.2&nbsp;@ExceptionHandler</h3></div></div></div>

<p>The <code class="literal">HandlerExceptionResolver</code> interface and the <code class="literal">SimpleMappingExceptionResolver</code>
implementations allow you to map Exceptions to specific views declaratively along with
some optional Java logic before forwarding to those views. However, in some cases,
especially when relying on <code class="literal">@ResponseBody</code> methods rather than on view resolution, it
may be more convenient to directly set the status of the response and optionally write
error content to the body of the response.</p>
<p>You can do that with <code class="literal">@ExceptionHandler</code> methods. When declared within a controller such
methods apply to exceptions raised by <code class="literal">@RequestMapping</code> methods of that contoroller (or
any of its sub-classes). You can also declare an <code class="literal">@ExceptionHandler</code> method within an
<code class="literal">@ControllerAdvice</code> class in which case it handles exceptions from <code class="literal">@RequestMapping</code>
methods from many controllers. Below is an example of a controller-local
<code class="literal">@ExceptionHandler</code> method:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleController {

    <span class="hl-comment">// @RequestMapping methods omitted ...</span>

    <i><span class="hl-annotation" style="color: gray">@ExceptionHandler(IOException.class)</span></i>
    <span class="hl-keyword">public</span> ResponseEntity&lt;String&gt; handleIOException(IOException ex) {
        <span class="hl-comment">// prepare responseEntity</span>
        <span class="hl-keyword">return</span> responseEntity;
    }

}</pre>

<p>The <code class="literal">@ExceptionHandler</code> value can be set to an array of Exception types. If an exception
is thrown that matches one of the types in the list, then the method annotated with the
matching <code class="literal">@ExceptionHandler</code> will be invoked. If the annotation value is not set then
the exception types listed as method arguments are used.</p>
<p>Much like standard controller methods annotated with a <code class="literal">@RequestMapping</code> annotation, the
method arguments and return values of <code class="literal">@ExceptionHandler</code> methods can be flexible. For
example, the <code class="literal">HttpServletRequest</code> can be accessed in Servlet environments and the
<code class="literal">PortletRequest</code> in Portlet environments. The return type can be a <code class="literal">String</code>, which is
interpreted as a view name, a <code class="literal">ModelAndView</code> object, a <code class="literal">ResponseEntity</code>, or you can also
add the <code class="literal">@ResponseBody</code> to have the method return value converted with message
converters and written to the response stream.</p>
</div>
<div class="section" title="16.12.3&nbsp;Handling Standard Spring MVC Exceptions"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-rest-spring-mvc-exceptions"></a>16.12.3&nbsp;Handling Standard Spring MVC Exceptions</h3></div></div></div>

<p>Spring MVC may raise a number of exceptions while processing a request. The
<code class="literal">SimpleMappingExceptionResolver</code> can easily map any exception to a default error view as
needed. However, when working with clients that interpret responses in an automated way
you will want to set specific status code on the response. Depending on the exception
raised the status code may indicate a client error (4xx) or a server error (5xx).</p>
<p>The <code class="literal">DefaultHandlerExceptionResolver</code> translates Spring MVC exceptions to specific error
status codes. It is registered by default with the MVC namespace, the MVC Java config,
and also by the the <code class="literal">DispatcherServlet</code> (i.e. when not using the MVC namespace or Java
config). Listed below are some of the exceptions handled by this resolver and the
corresponding status codes:</p>
<div class="informaltable">
  <table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Exception</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">HTTP Status Code</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BindException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>400 (Bad Request)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ConversionNotSupportedException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>500 (Internal Server Error)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">HttpMediaTypeNotAcceptableException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>406 (Not Acceptable)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">HttpMediaTypeNotSupportedException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>415 (Unsupported Media Type)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">HttpMessageNotReadableException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>400 (Bad Request)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">HttpMessageNotWritableException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>500 (Internal Server Error)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">HttpRequestMethodNotSupportedException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>405 (Method Not Allowed)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">MethodArgumentNotValidException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>400 (Bad Request)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">MissingServletRequestParameterException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>400 (Bad Request)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">MissingServletRequestPartException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>400 (Bad Request)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">NoHandlerFoundException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>404 (Not Found)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">NoSuchRequestHandlingMethodException</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>404 (Not Found)</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">TypeMismatchException</code></p></td><td style="" align="left" valign="top"><p>400 (Bad Request)</p></td></tr></tbody></table>
</div>

<p>The <code class="literal">DefaultHandlerExceptionResolver</code> works transparently by setting the status of the
response. However, it stops short of writing any error content to the body of the
response while your application may need to add developer-friendly content to every
error response for example when providing a REST API. You can prepare a <code class="literal">ModelAndView</code>
and render error content through view resolution&#8201;&#8212;&#8201;i.e. by configuring a
<code class="literal">ContentNegotiatingViewResolver</code>, <code class="literal">MappingJacksonJsonView</code>, and so on. However, you may
prefer to use <code class="literal">@ExceptionHandler</code> methods instead.</p>
<p>If you prefer to write error content via <code class="literal">@ExceptionHandler</code> methods you can extend
<code class="literal">ResponseEntityExceptionHandler</code> instead. This is a convenient base for
<code class="literal">@ControllerAdvice</code> classes providing an <code class="literal">@ExceptionHandler</code> method to handle standard
Spring MVC exceptions and return <code class="literal">ResponseEntity</code>. That allows you to customize the
response and write error content with message converters. See the Javadoc of
<code class="literal">ResponseEntityExceptionHandler</code> for more details.</p>
</div>
<div class="section" title="16.12.4&nbsp;Annotating Business Exceptions With @ResponseStatus"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-annotated-exceptions"></a>16.12.4&nbsp;Annotating Business Exceptions With @ResponseStatus</h3></div></div></div>

<p>A business exception can be annotated with <code class="literal">@ResponseStatus</code>. When the exception is
raised, the <code class="literal">ResponseStatusExceptionResolver</code> handles it by setting the status of the
response accordingly. By default the <code class="literal">DispatcherServlet</code> registers the
<code class="literal">ResponseStatusExceptionResolver</code> and it is available for use.</p>
</div>
<div class="section" title="16.12.5&nbsp;Customizing the Default Servlet Container Error Page"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-ann-customer-servlet-container-error-page"></a>16.12.5&nbsp;Customizing the Default Servlet Container Error Page</h3></div></div></div>

<p>When the status of the response is set to an error status code and the body of the
response is empty, Servlet containers commonly render an HTML formatted error page. To
customize the default error page of the container, you can declare an <code class="literal">&lt;error-page&gt;</code>
element in <code class="literal">web.xml</code>. Up until Servlet 3, that element had to be mapped to a specific
status code or exception type. Starting with Servlet 3 an error page does not need to be
mapped, which effectively means the specified location customizes the default Servlet
container error page.</p>
<pre class="programlisting"><span class="hl-tag">&lt;error-page&gt;</span>
    <span class="hl-tag">&lt;location&gt;</span>/error<span class="hl-tag">&lt;/location&gt;</span>
<span class="hl-tag">&lt;/error-page&gt;</span></pre>

<p>Note that the actual location for the error page can be a JSP page or some other URL
within the container including one handled through an <code class="literal">@Controller</code> method:</p>
<p>When writing error information, the status code and the error message set on the
<code class="literal">HttpServletResponse</code> can be accessed through request attributes in a controller:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ErrorController {

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/error", produces="application/json")</span></i>
    <i><span class="hl-annotation" style="color: gray">@ResponseBody</span></i>
    <span class="hl-keyword">public</span> Map&lt;String, Object&gt; handle(HttpServletRequest request) {

        Map&lt;String, Object&gt; map = <span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;();
        map.put(<span class="hl-string">"status"</span>, request.getAttribute(<span class="hl-string">"javax.servlet.error.status_code"</span>));
        map.put(<span class="hl-string">"reason"</span>, request.getAttribute(<span class="hl-string">"javax.servlet.error.message"</span>));

        <span class="hl-keyword">return</span> map;
    }

}</pre>

<p>or in a JSP:</p>
<pre class="programlisting"><span class="hl-tag">&lt;%@</span> <span class="hl-attribute">page</span> <span class="hl-attribute">contentType</span>=<span class="hl-value">"application/json"</span> <span class="hl-attribute">pageEncoding</span>=<span class="hl-value">"UTF-8"</span><span class="hl-attribute">%&gt;</span>
<span class="hl-attribute">{</span>
    <span class="hl-attribute">status:&lt;%</span>=<span class="hl-value">request.getAttribute("javax.servlet.error.status_code")</span> <span class="hl-attribute">%&gt;,</span>
    <span class="hl-attribute">reason:&lt;%</span>=<span class="hl-value">request.getAttribute("javax.servlet.error.message")</span> <span class="hl-attribute">%&gt;</span>
<span class="hl-attribute">}</span></pre>

</div>
</div>
<div class="section" title="16.13&nbsp;Convention over configuration support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-coc"></a>16.13&nbsp;Convention over configuration support</h2></div></div></div>

<p>For a lot of projects, sticking to established conventions and having reasonable
defaults is just what they (the projects) need, and Spring Web MVC now has explicit
support for <span class="emphasis"><em>convention over configuration</em></span>. What this means is that if you establish
a set of naming conventions and suchlike, you can <span class="emphasis"><em>substantially</em></span> cut down on the
amount of configuration that is required to set up handler mappings, view resolvers,
<code class="literal">ModelAndView</code> instances, etc. This is a great boon with regards to rapid prototyping,
and can also lend a degree of (always good-to-have) consistency across a codebase should
you choose to move forward with it into production.</p>
<p>Convention-over-configuration support addresses the three core areas of MVC: models,
views, and controllers.</p>
<div class="section" title="16.13.1&nbsp;The Controller ControllerClassNameHandlerMapping"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-coc-ccnhm"></a>16.13.1&nbsp;The Controller ControllerClassNameHandlerMapping</h3></div></div></div>

<p>The <code class="literal">ControllerClassNameHandlerMapping</code> class is a <code class="literal">HandlerMapping</code> implementation that
uses a convention to determine the mapping between request URLs and the <code class="literal">Controller</code>
instances that are to handle those requests.</p>
<p>Consider the following simple <code class="literal">Controller</code> implementation. Take special notice of the
<span class="emphasis"><em>name</em></span> of the class.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> <span class="strong"><strong>ViewShoppingCartController</strong></span> <span class="hl-keyword">implements</span> Controller {

    <span class="hl-keyword">public</span> ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) {
        <span class="hl-comment">// the implementation is not hugely important for this example...</span>
    }

}</pre>

<p>Here is a snippet from the corresponding Spring Web MVC configuration file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"</span><span class="strong"><strong>viewShoppingCart</strong></span>" class="x.y.z.ViewShoppingCartController"&gt;
    <span class="hl-comment">&lt;!-- inject dependencies as required... --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">ControllerClassNameHandlerMapping</code> finds all of the various handler (or
<code class="literal">Controller</code>) beans defined in its application context and strips <code class="literal">Controller</code> off the
name to define its handler mappings. Thus, <code class="literal">ViewShoppingCartController</code> maps to the
<code class="literal">/viewshoppingcart*</code> request URL.</p>
<p>Let&#8217;s look at some more examples so that the central idea becomes immediately familiar.
(Notice all lowercase in the URLs, in contrast to camel-cased <code class="literal">Controller</code> class names.)</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">WelcomeController</code> maps to the <code class="literal">/welcome*</code> request URL
</li><li class="listitem">
<code class="literal">HomeController</code> maps to the <code class="literal">/home*</code> request URL
</li><li class="listitem">
<code class="literal">IndexController</code> maps to the <code class="literal">/index*</code> request URL
</li><li class="listitem">
<code class="literal">RegisterController</code> maps to the <code class="literal">/register*</code> request URL
</li></ul></div>

<p>In the case of <code class="literal">MultiActionController</code> handler classes, the mappings generated are
slightly more complex. The <code class="literal">Controller</code> names in the following examples are assumed to
be <code class="literal">MultiActionController</code> implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">AdminController</code> maps to the <code class="literal">/admin/*</code> request URL
</li><li class="listitem">
<code class="literal">CatalogController</code> maps to the <code class="literal">/catalog/*</code> request URL
</li></ul></div>

<p>If you follow the convention of naming your <code class="literal">Controller</code> implementations as
<code class="literal">xxxController</code>, the <code class="literal">ControllerClassNameHandlerMapping</code> saves you the tedium of
defining and maintaining a potentially <span class="emphasis"><em>looooong</em></span> <code class="literal">SimpleUrlHandlerMapping</code> (or
suchlike).</p>
<p>The <code class="literal">ControllerClassNameHandlerMapping</code> class extends the <code class="literal">AbstractHandlerMapping</code> base
class so you can define <code class="literal">HandlerInterceptor</code> instances and everything else just as you
would with many other <code class="literal">HandlerMapping</code> implementations.</p>
</div>
<div class="section" title="16.13.2&nbsp;The Model ModelMap (ModelAndView)"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-coc-modelmap"></a>16.13.2&nbsp;The Model ModelMap (ModelAndView)</h3></div></div></div>

<p>The <code class="literal">ModelMap</code> class is essentially a glorified <code class="literal">Map</code> that can make adding objects that
are to be displayed in (or on) a <code class="literal">View</code> adhere to a common naming convention. Consider
the following <code class="literal">Controller</code> implementation; notice that objects are added to the
<code class="literal">ModelAndView</code> without any associated name specified.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DisplayShoppingCartController <span class="hl-keyword">implements</span> Controller {

    <span class="hl-keyword">public</span> ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) {

        List cartItems = <span class="hl-comment">// get a List of CartItem objects</span>
        User user = <span class="hl-comment">// get the User doing the shopping</span>

        ModelAndView mav = <span class="hl-keyword">new</span> ModelAndView(<span class="hl-string">"displayShoppingCart"</span>); &lt;-- the logical view name

        mav.addObject(cartItems); &lt;-- look ma, no name, just the object
        mav.addObject(user); &lt;-- and again ma!

        <span class="hl-keyword">return</span> mav;
    }
}</pre>

<p>The <code class="literal">ModelAndView</code> class uses a <code class="literal">ModelMap</code> class that is a custom <code class="literal">Map</code> implementation
that automatically generates a key for an object when an object is added to it. The
strategy for determining the name for an added object is, in the case of a scalar object
such as <code class="literal">User</code>, to use the short class name of the object&#8217;s class. The following
examples are names that are generated for scalar objects put into a <code class="literal">ModelMap</code> instance.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
An <code class="literal">x.y.User</code> instance added will have the name <code class="literal">user</code> generated.
</li><li class="listitem">
An <code class="literal">x.y.Registration</code> instance added will have the name <code class="literal">registration</code> generated.
</li><li class="listitem">
An <code class="literal">x.y.Foo</code> instance added will have the name <code class="literal">foo</code> generated.
</li><li class="listitem">
A <code class="literal">java.util.HashMap</code> instance added will have the name <code class="literal">hashMap</code> generated. You
probably want to be explicit about the name in this case because <code class="literal">hashMap</code> is less
than intuitive.
</li><li class="listitem">
Adding <code class="literal">null</code> will result in an <code class="literal">IllegalArgumentException</code> being thrown. If the object
(or objects) that you are adding could be <code class="literal">null</code>, then you will also want to be
explicit about the name.
</li></ul></div>

<div class="sidebar" title="What, no automatic pluralization?"><p class="title"><b>What, no automatic pluralization?</b></p>

<p>Spring Web MVC&#8217;s convention-over-configuration support does not support automatic
pluralization. That is, you cannot add a <code class="literal">List</code> of <code class="literal">Person</code> objects to a <code class="literal">ModelAndView</code>
and have the generated name be <code class="literal">people</code>.</p>
<p>This decision was made after some debate, with the "Principle of Least Surprise" winning
out in the end.</p>
</div>

<p>The strategy for generating a name after adding a <code class="literal">Set</code> or a <code class="literal">List</code> is to peek into the
collection, take the short class name of the first object in the collection, and use
that with <code class="literal">List</code> appended to the name. The same applies to arrays although with arrays
it is not necessary to peek into the array contents. A few examples will make the
semantics of name generation for collections clearer:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
An <code class="literal">x.y.User[]</code> array with zero or more <code class="literal">x.y.User</code> elements added will have the name
<code class="literal">userList</code> generated.
</li><li class="listitem">
An <code class="literal">x.y.Foo[]</code> array with zero or more <code class="literal">x.y.User</code> elements added will have the name
<code class="literal">fooList</code> generated.
</li><li class="listitem">
A <code class="literal">java.util.ArrayList</code> with one or more <code class="literal">x.y.User</code> elements added will have the name
<code class="literal">userList</code> generated.
</li><li class="listitem">
A <code class="literal">java.util.HashSet</code> with one or more <code class="literal">x.y.Foo</code> elements added will have the name
<code class="literal">fooList</code> generated.
</li><li class="listitem">
An <span class="emphasis"><em>empty</em></span> <code class="literal">java.util.ArrayList</code> will not be added at all (in effect, the
<code class="literal">addObject(..)</code> call will essentially be a no-op).
</li></ul></div>

</div>
<div class="section" title="16.13.3&nbsp;The View - RequestToViewNameTranslator"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-coc-r2vnt"></a>16.13.3&nbsp;The View - RequestToViewNameTranslator</h3></div></div></div>

<p>The <code class="literal">RequestToViewNameTranslator</code> interface determines a logical <code class="literal">View</code> name when no
such logical view name is explicitly supplied. It has just one implementation, the
<code class="literal">DefaultRequestToViewNameTranslator</code> class.</p>
<p>The <code class="literal">DefaultRequestToViewNameTranslator</code> maps request URLs to logical view names, as
with this example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RegistrationController <span class="hl-keyword">implements</span> Controller {

    <span class="hl-keyword">public</span> ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) {
        <span class="hl-comment">// process the request...</span>
        ModelAndView mav = <span class="hl-keyword">new</span> ModelAndView();
        <span class="hl-comment">// add data as necessary to the model...</span>
        <span class="hl-keyword">return</span> mav;
        <span class="hl-comment">// notice that no View or logical view name has been set</span>
    }

}</pre>

<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- this bean with the well known name generates view names for us --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewNameTranslator"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.RegistrationController"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- inject dependencies as necessary --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- maps request URLs to Controller names --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.mvc.support.ControllerClassNameHandlerMapping"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/jsp/"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".jsp"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Notice how in the implementation of the <code class="literal">handleRequest(..)</code> method no <code class="literal">View</code> or logical
view name is ever set on the <code class="literal">ModelAndView</code> that is returned. The
<code class="literal">DefaultRequestToViewNameTranslator</code> is tasked with generating a <span class="emphasis"><em>logical view name</em></span>
from the URL of the request. In the case of the above <code class="literal">RegistrationController</code>, which is
used in conjunction with the <code class="literal">ControllerClassNameHandlerMapping</code>, a request URL of
<code class="literal">http://localhost/registration.html</code> results in a logical view name of <code class="literal">registration</code>
being generated by the <code class="literal">DefaultRequestToViewNameTranslator</code>. This logical view name is
then resolved into the <code class="literal">/WEB-INF/jsp/registration.jsp</code> view by the
<code class="literal">InternalResourceViewResolver</code> bean.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>You do not need to define a <code class="literal">DefaultRequestToViewNameTranslator</code> bean explicitly. If you
like the default settings of the <code class="literal">DefaultRequestToViewNameTranslator</code>, you can rely on
the Spring Web MVC <code class="literal">DispatcherServlet</code> to instantiate an instance of this class if one
is not explicitly configured.</p>
</td></tr></table></div>

<p>Of course, if you need to change the default settings, then you do need to configure
your own <code class="literal">DefaultRequestToViewNameTranslator</code> bean explicitly. Consult the comprehensive
Javadoc for the <code class="literal">DefaultRequestToViewNameTranslator</code> class for details of the various
properties that can be configured.</p>
</div>
</div>
<div class="section" title="16.14&nbsp;ETag support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-etag"></a>16.14&nbsp;ETag support</h2></div></div></div>

<p>An <a class="ulink" href="http://en.wikipedia.org/wiki/HTTP_ETag" target="_top">ETag</a> (entity tag) is an HTTP response header
returned by an HTTP/1.1 compliant web server used to determine change in content at a
given URL. It can be considered to be the more sophisticated successor to the
<code class="literal">Last-Modified</code> header. When a server returns a representation with an ETag header, the
client can use this header in subsequent GETs, in an <code class="literal">If-None-Match</code> header. If the
content has not changed, the server returns <code class="literal">304: Not Modified</code>.</p>
<p>Support for ETags is provided by the Servlet filter <code class="literal">ShallowEtagHeaderFilter</code>. It is a
plain Servlet Filter, and thus can be used in combination with any web framework. The
<code class="literal">ShallowEtagHeaderFilter</code> filter creates so-called shallow ETags (as opposed to deep
ETags, more about that later).The filter caches the content of the rendered JSP (or
other content), generates an MD5 hash over that, and returns that as an ETag header in
the response. The next time a client sends a request for the same resource, it uses that
hash as the <code class="literal">If-None-Match</code> value. The filter detects this, renders the view again, and
compares the two hashes. If they are equal, a <code class="literal">304</code> is returned. This filter will not
save processing power, as the view is still rendered. The only thing it saves is
bandwidth, as the rendered response is not sent back over the wire.</p>
<p>You configure the <code class="literal">ShallowEtagHeaderFilter</code> in <code class="literal">web.xml</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;filter&gt;</span>
    <span class="hl-tag">&lt;filter-name&gt;</span>etagFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
    <span class="hl-tag">&lt;filter-class&gt;</span>org.springframework.web.filter.ShallowEtagHeaderFilter<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>

<span class="hl-tag">&lt;filter-mapping&gt;</span>
    <span class="hl-tag">&lt;filter-name&gt;</span>etagFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>petclinic<span class="hl-tag">&lt;/servlet-name&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span></pre>

</div>
<div class="section" title="16.15&nbsp;Code-based Servlet container initialization"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-container-config"></a>16.15&nbsp;Code-based Servlet container initialization</h2></div></div></div>

<p>In a Servlet 3.0+ environment, you have the option of configuring the Servlet container
programmatically as an alternative or in combination with a <code class="literal">web.xml</code> file. Below is an
example of registering a <code class="literal">DispatcherServlet</code>:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.web.WebApplicationInitializer;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebApplicationInitializer <span class="hl-keyword">implements</span> WebApplicationInitializer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onStartup(ServletContext container) {
        XmlWebApplicationContext appContext = <span class="hl-keyword">new</span> XmlWebApplicationContext();
        appContext.setConfigLocation(<span class="hl-string">"/WEB-INF/spring/dispatcher-config.xml"</span>);

        ServletRegistration.Dynamic registration = container.addServlet(<span class="hl-string">"dispatcher"</span>, <span class="hl-keyword">new</span> DispatcherServlet(appContext));
        registration.setLoadOnStartup(<span class="hl-number">1</span>);
        registration.addMapping(<span class="hl-string">"/"</span>);
    }

}</pre>

<p><code class="literal">WebApplicationInitializer</code> is an interface provided by Spring MVC that ensures your
implementation is detected and automatically used to initialize any Servlet 3 container.
An abstract base class implementation of <code class="literal">WebApplicationInitializer</code> named
<code class="literal">AbstractDispatcherServletInitializer</code> makes it even easier to register the
<code class="literal">DispatcherServlet</code> by simply overriding methods to specify the servlet mapping and the
location of the <code class="literal">DispatcherServlet</code> configuration:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebAppInitializer <span class="hl-keyword">extends</span> AbstractAnnotationConfigDispatcherServletInitializer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() {
        <span class="hl-keyword">return</span> null;
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Class[] { MyWebConfig.<span class="hl-keyword">class</span> };
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> String[] getServletMappings() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String[] { <span class="hl-string">"/"</span> };
    }

}</pre>

<p>The above example is for an application that uses Java-based Spring configuration. If
using XML-based Spring configuration, extend directly from
<code class="literal">AbstractDispatcherServletInitializer</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebAppInitializer <span class="hl-keyword">extends</span> AbstractDispatcherServletInitializer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> WebApplicationContext createRootApplicationContext() {
        <span class="hl-keyword">return</span> null;
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> WebApplicationContext createServletApplicationContext() {
        XmlWebApplicationContext cxt = <span class="hl-keyword">new</span> XmlWebApplicationContext();
        cxt.setConfigLocation(<span class="hl-string">"/WEB-INF/spring/dispatcher-config.xml"</span>);
        <span class="hl-keyword">return</span> cxt;
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> String[] getServletMappings() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String[] { <span class="hl-string">"/"</span> };
    }

}</pre>

<p><code class="literal">AbstractDispatcherServletInitializer</code> also provides a convenient way to add <code class="literal">Filter</code>
instances and have them automatically mapped to the <code class="literal">DispatcherServlet</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebAppInitializer <span class="hl-keyword">extends</span> AbstractDispatcherServletInitializer {

    <span class="hl-comment">// ...</span>

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> Filter[] getServletFilters() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Filter[] { <span class="hl-keyword">new</span> HiddenHttpMethodFilter(), <span class="hl-keyword">new</span> CharacterEncodingFilter() };
    }

}</pre>

<p>Each filter is added with a default name based on its concrete type and automatically
mapped to the <code class="literal">DispatcherServlet</code>.</p>
<p>The <code class="literal">isAsyncSupported</code> protected method of <code class="literal">AbstractDispatcherServletInitializer</code>
provides a single place to enable async support on the <code class="literal">DispatcherServlet</code> and all
filters mapped to it. By default this flag is set to <code class="literal">true</code>.</p>
</div>
<div class="section" title="16.16&nbsp;Configuring Spring MVC"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-config"></a>16.16&nbsp;Configuring Spring MVC</h2></div></div></div>

<p><a class="xref" href="#mvc-servlet-special-bean-types" title="16.2.1&nbsp;Special Bean Types In the WebApplicationContext">Section&nbsp;16.2.1, &#8220;Special Bean Types In the WebApplicationContext&#8221;</a> and <a class="xref" href="#mvc-servlet-config" title="16.2.2&nbsp;Default DispatcherServlet Configuration">Section&nbsp;16.2.2, &#8220;Default DispatcherServlet Configuration&#8221;</a> explained about Spring
MVC&#8217;s special beans and the default implementations used by the <code class="literal">DispatcherServlet</code>. In
this section you&#8217;ll learn about two additional ways of configuring Spring MVC. Namely
the MVC Java config and the MVC XML namespace.</p>
<p>The MVC Java config and the MVC namespace provide similar default configuration that
overrides the <code class="literal">DispatcherServlet</code> defaults. The goal is to spare most applications from
having to having to create the same configuration and also to provide higher-level
constructs for configuring Spring MVC that serve as a simple starting point and require
little or no prior knowledge of the underlying configuration.</p>
<p>You can choose either the MVC Java config or the MVC namespace depending on your
preference. Also as you will see further below, with the MVC Java config it is easier to
see the underlying configuration as well as to make fine-grained customizations directly
to the created Spring MVC beans. But let&#8217;s start from the beginning.</p>
<div class="section" title="16.16.1&nbsp;Enabling the MVC Java Config or the MVC XML Namespace"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-config-enable"></a>16.16.1&nbsp;Enabling the MVC Java Config or the MVC XML Namespace</h3></div></div></div>

<p>To enable MVC Java config add the annotation <code class="literal">@EnableWebMvc</code> to one of your
<code class="literal">@Configuration</code> classes:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig {

}</pre>

<p>To achieve the same in XML use the <code class="literal">mvc:annotation-driven</code> element:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:mvc</span>=<span class="hl-value">"http://www.springframework.org/schema/mvc"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;mvc:annotation-driven /&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The above registers a <code class="literal">RequestMappingHandlerMapping</code>, a <code class="literal">RequestMappingHandlerAdapter</code>,
and an <code class="literal">ExceptionHandlerExceptionResolver</code> (among others) in support of processing
requests with annotated controller methods using annotations such as <code class="literal">@RequestMapping</code>,
<code class="literal">@ExceptionHandler</code>, and others.</p>
<p>It also enables the following:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Spring 3 style type conversion through a <a class="link" href="#core-convert" title="6.5&nbsp;Spring Type Conversion">ConversionService</a> instance
in addition to the JavaBeans PropertyEditors used for Data Binding.
</li><li class="listitem">
Support for <a class="link" href="#format" title="6.6&nbsp;Spring Field Formatting">formatting</a> Number fields using the <code class="literal">@NumberFormat</code> annotation
through the <code class="literal">ConversionService</code>.
</li><li class="listitem">
Support for <a class="link" href="#format" title="6.6&nbsp;Spring Field Formatting">formatting</a> Date, Calendar, Long, and Joda Time fields using the
<code class="literal">@DateTimeFormat</code> annotation.
</li><li class="listitem">
Support for <a class="link" href="#validation-mvc-jsr303" title="Configuring a JSR-303/JSR-349 Validator for use by Spring MVC">validating</a> @Controller inputs with <code class="literal">@Valid</code>, if
a JSR-303 Provider is present on the classpath.
</li><li class="listitem">
<p class="simpara">HttpMessageConverter support for <code class="literal">@RequestBody</code> method parameters and <code class="literal">@ResponseBody</code>
method return values from <code class="literal">@RequestMapping</code> or <code class="literal">@ExceptionHandler</code> methods.</p>
<p class="simpara">This is the complete list of HttpMessageConverters set up by mvc:annotation-driven:</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<code class="literal">ByteArrayHttpMessageConverter</code> converts byte arrays.
</li><li class="listitem">
<code class="literal">StringHttpMessageConverter</code> converts strings.
</li><li class="listitem">
<code class="literal">ResourceHttpMessageConverter</code> converts to/from
<code class="literal">org.springframework.core.io.Resource</code> for all media types.
</li><li class="listitem">
<code class="literal">SourceHttpMessageConverter</code> converts to/from a <code class="literal">javax.xml.transform.Source</code>.
</li><li class="listitem">
<code class="literal">FormHttpMessageConverter</code> converts form data to/from a <code class="literal">MultiValueMap&lt;String,
String&gt;</code>.
</li><li class="listitem">
<code class="literal">Jaxb2RootElementHttpMessageConverter</code> converts Java objects to/from XML&#8201;&#8212;&#8201;added if
JAXB2 is present on the classpath.
</li><li class="listitem">
<code class="literal">MappingJackson2HttpMessageConverter</code> (or <code class="literal">MappingJacksonHttpMessageConverter</code>)
converts to/from JSON&#8201;&#8212;&#8201;added if Jackson 2 (or Jackson) is present on the classpath.
</li><li class="listitem">
<code class="literal">AtomFeedHttpMessageConverter</code> converts Atom feeds&#8201;&#8212;&#8201;added if Rome is present on the
classpath.
</li><li class="listitem">
<code class="literal">RssChannelHttpMessageConverter</code> converts RSS feeds&#8201;&#8212;&#8201;added if Rome is present on
the classpath.
</li></ol></div>

</li></ol></div>

</div>
<div class="section" title="16.16.2&nbsp;Customizing the Provided Configuration"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-config-customize"></a>16.16.2&nbsp;Customizing the Provided Configuration</h3></div></div></div>

<p>To customize the default configuration in Java you simply implement the
<code class="literal">WebMvcConfigurer</code> interface or more likely extend the class <code class="literal">WebMvcConfigurerAdapter</code>
and override the methods you need. Below is an example of some of the available methods
to override. See
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/config/annotation/WebMvcConfigurer.html" target="_top"><code class="literal">WebMvcConfigurer</code></a>
for a list of all methods and the Javadoc for further details:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> addFormatters(FormatterRegistry registry) {
        <span class="hl-comment">// Add formatters and/or converters</span>
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {
        <span class="hl-comment">// Configure the list of HttpMessageConverters to use</span>
    }

}</pre>

<p>To customize the default configuration of <code class="literal">&lt;mvc:annotation-driven /&gt;</code> check what
attributes and sub-elements it supports. You can view the
<a class="ulink" href="http://schema.spring.io/mvc/spring-mvc.xsd" target="_top">Spring MVC XML schema</a> or use the code
completion feature of your IDE to discover what attributes and sub-elements are
available. The sample below shows a subset of what is available:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:annotation-driven</span> <span class="hl-attribute">conversion-service</span>=<span class="hl-value">"conversionService"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;mvc:message-converters&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyHttpMessageConverter"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyOtherHttpMessageConverter"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/mvc:message-converters&gt;</span>
<span class="hl-tag">&lt;/mvc:annotation-driven&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"conversionService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.format.support.FormattingConversionServiceFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"formatters"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyFormatter"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyOtherFormatter"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="16.16.3&nbsp;Configuring Interceptors"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-config-interceptors"></a>16.16.3&nbsp;Configuring Interceptors</h3></div></div></div>

<p>You can configure <code class="literal">HandlerInterceptors</code> or <code class="literal">WebRequestInterceptors</code> to be applied to all
incoming requests or restricted to specific URL path patterns.</p>
<p>An example of registering interceptors in Java:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(<span class="hl-keyword">new</span> LocaleInterceptor());
        registry.addInterceptor(<span class="hl-keyword">new</span> ThemeInterceptor()).addPathPatterns(<span class="hl-string">"/</span><span class="strong"><strong>").excludePathPatterns("/admin/</strong></span><span class="hl-string">");
</span>        registry.addInterceptor(<span class="hl-keyword">new</span> SecurityInterceptor()).addPathPatterns(<span class="hl-string">"/secure/*"</span>);
    }

}</pre>

<p>And in XML use the <code class="literal">&lt;mvc:interceptors&gt;</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:interceptors&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.i18n.LocaleChangeInterceptor"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;mvc:interceptor&gt;</span>
        <span class="hl-tag">&lt;mvc:mapping</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/</span><span class="strong"><strong>"/&gt;
        &lt;mvc:exclude-mapping path="/admin/</strong></span>"/&gt;
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.theme.ThemeChangeInterceptor"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/mvc:interceptor&gt;</span>
    <span class="hl-tag">&lt;mvc:interceptor&gt;</span>
        <span class="hl-tag">&lt;mvc:mapping</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/secure/*"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.SecurityInterceptor"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/mvc:interceptor&gt;</span>
<span class="hl-tag">&lt;/mvc:interceptors&gt;</span></pre>

</div>
<div class="section" title="16.16.4&nbsp;Configuring Content Negotiation"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-config-content-negotiation"></a>16.16.4&nbsp;Configuring Content Negotiation</h3></div></div></div>

<p>You can configure how Spring MVC determines the requested media types from the client
for request mapping as well as for content negotiation purposes. The available options
are to check the file extension in the request URI, the "Accept" header, a request
parameter, as well as to fall back on a default content type. By default, file extension
in the request URI is checked first and the "Accept" header is checked next.</p>
<p>For file extensions in the request URI, the MVC Java config and the MVC namespace,
automatically register extensions such as <code class="literal">.json</code>, <code class="literal">.xml</code>, <code class="literal">.rss</code>, and <code class="literal">.atom</code> if the
corresponding dependencies such as Jackson, JAXB2, or Rome are present on the classpath.
Additional extensions may be not need to be registered explicitly if they can be
discovered via <code class="literal">ServletContext.getMimeType(String)</code> or the <span class="emphasis"><em>Java Activation Framework</em></span>
(see <code class="literal">javax.activation.MimetypesFileTypeMap</code>). You can register more extensions with the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/RequestMappingHandlerMapping.html#setUseRegisteredSuffixPatternMatch(boolean)" target="_top">setUseRegisteredSuffixPatternMatch
method</a>.</p>
<p>The introduction of <code class="literal">ContentNegotiationManger</code> also enables selective suffix pattern
matching for incoming requests. For more details, see the Javadoc of</p>
<p>Below is an example of customizing content negotiation options through the MVC Java
config:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureContentNegotiation(ContentNegotiationConfigurer configurer) {
        configurer.favorPathExtension(false).favorParameter(true);
    }
}</pre>

<p>In the MVC namespace, the <code class="literal">&lt;mvc:annotation-driven&gt;</code> element has a
<code class="literal">content-negotiation-manager</code> attribute, which expects a <code class="literal">ContentNegotiationManager</code>
that in turn can be created with a <code class="literal">ContentNegotiationManagerFactoryBean</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:annotation-driven</span> <span class="hl-attribute">content-negotiation-manager</span>=<span class="hl-value">"contentNegotiationManager"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"contentNegotiationManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.accept.ContentNegotiationManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"favorPathExtension"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"favorParameter"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mediaTypes"</span><span class="hl-tag"> &gt;</span>
        <span class="hl-tag">&lt;value&gt;</span>
            json=application/json
            xml=application/xml
        <span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>If not using the MVC Java config or the MVC namespace, you&#8217;ll need to create an instance
of <code class="literal">ContentNegotiationManager</code> and use it to configure <code class="literal">RequestMappingHandlerMapping</code>
for request mapping purposes, and <code class="literal">RequestMappingHandlerAdapter</code> and
<code class="literal">ExceptionHandlerExceptionResolver</code> for content negotiation purposes.</p>
<p>Note that <code class="literal">ContentNegotiatingViewResolver</code> now can also be configured with a
<code class="literal">ContentNegotiatingViewResolver</code>, so you can use one instance throughout Spring MVC.</p>
<p>In more advanced cases, it may be useful to configure multiple
<code class="literal">ContentNegotiationManager</code> instances that in turn may contain custom
<code class="literal">ContentNegotiationStrategy</code> implementations. For example you could configure
<code class="literal">ExceptionHandlerExceptionResolver</code> with a <code class="literal">ContentNegotiationManager</code> that always
resolves the requested media type to <code class="literal">"application/json"</code>. Or you may want to plug a
custom strategy that has some logic to select a default content type (e.g. either XML or
JSON) if no content types were requested.</p>
</div>
<div class="section" title="16.16.5&nbsp;Configuring View Controllers"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-config-view-controller"></a>16.16.5&nbsp;Configuring View Controllers</h3></div></div></div>

<p>This is a shortcut for defining a <code class="literal">ParameterizableViewController</code> that immediately
forwards to a view when invoked. Use it in static cases when there is no Java controller
logic to execute before the view generates the response.</p>
<p>An example of forwarding a request for <code class="literal">"/"</code> to a view called <code class="literal">"home"</code> in Java:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController(<span class="hl-string">"/"</span>).setViewName(<span class="hl-string">"home"</span>);
    }

}</pre>

<p>And the same in XML use the <code class="literal">&lt;mvc:view-controller&gt;</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:view-controller</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/"</span> <span class="hl-attribute">view-name</span>=<span class="hl-value">"home"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="16.16.6&nbsp;Configuring Serving of Resources"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-config-static-resources"></a>16.16.6&nbsp;Configuring Serving of Resources</h3></div></div></div>

<p>This option allows static resource requests following a particular URL pattern to be
served by a <code class="literal">ResourceHttpRequestHandler</code> from any of a list of <code class="literal">Resource</code> locations.
This provides a convenient way to serve static resources from locations other than the
web application root, including locations on the classpath. The <code class="literal">cache-period</code> property
may be used to set far future expiration headers (1 year is the recommendation of
optimization tools such as Page Speed and YSlow) so that they will be more efficiently
utilized by the client. The handler also properly evaluates the <code class="literal">Last-Modified</code> header
(if present) so that a <code class="literal">304</code> status code will be returned as appropriate, avoiding
unnecessary overhead for resources that are already cached by the client. For example,
to serve resource requests with a URL pattern of <code class="literal">/resources/**</code> from a
<code class="literal">public-resources</code> directory within the web application root you would use:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler(<span class="hl-string">"/resources/**"</span>).addResourceLocations(<span class="hl-string">"/public-resources/"</span>);
    }

}</pre>

<p>And the same in XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:resources</span> <span class="hl-attribute">mapping</span>=<span class="hl-value">"/resources/**"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"/public-resources/"</span><span class="hl-tag">/&gt;</span></pre>

<p>To serve these resources with a 1-year future expiration to ensure maximum use of the
browser cache and a reduction in HTTP requests made by the browser:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler(<span class="hl-string">"/resources/**"</span>).addResourceLocations(<span class="hl-string">"/public-resources/"</span>).setCachePeriod(<span class="hl-number">31556926</span>);
    }

}</pre>

<p>And in XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:resources</span> <span class="hl-attribute">mapping</span>=<span class="hl-value">"/resources/**"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"/public-resources/"</span> <span class="hl-attribute">cache-period</span>=<span class="hl-value">"31556926"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">mapping</code> attribute must be an Ant pattern that can be used by
<code class="literal">SimpleUrlHandlerMapping</code>, and the <code class="literal">location</code> attribute must specify one or more valid
resource directory locations. Multiple resource locations may be specified using a
comma-separated list of values. The locations specified will be checked in the specified
order for the presence of the resource for any given request. For example, to enable the
serving of resources from both the web application root and from a known path of
<code class="literal">/META-INF/public-web-resources/</code> in any jar on the classpath use:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler(<span class="hl-string">"/resources/**"</span>)
                .addResourceLocations(<span class="hl-string">"/"</span>, <span class="hl-string">"classpath:/META-INF/public-web-resources/"</span>);
    }

}</pre>

<p>And in XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:resources</span> <span class="hl-attribute">mapping</span>=<span class="hl-value">"/resources/**"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"/, classpath:/META-INF/public-web-resources/"</span><span class="hl-tag">/&gt;</span></pre>

<p>When serving resources that may change when a new version of the application is
deployed, it is recommended that you incorporate a version string into the mapping
pattern used to request the resources, so that you may force clients to request the
newly deployed version of your application&#8217;s resources. Such a version string can be
parameterized and accessed using SpEL so that it may be easily managed in a single place
when deploying new versions.</p>
<p>As an example, let&#8217;s consider an application that uses a performance-optimized custom
build (as recommended) of the Dojo JavaScript library in production, and that the build
is generally deployed within the web application at a path of
<code class="literal">/public-resources/dojo/dojo.js</code>. Since different parts of Dojo may be incorporated into
the custom build for each new version of the application, the client web browsers need
to be forced to re-download that custom-built <code class="literal">dojo.js</code> resource any time a new version
of the application is deployed. A simple way to achieve this would be to manage the
version of the application in a properties file, such as:</p>

<pre class="literallayout">application.version=1.0.0</pre>

<p>and then to make the properties file&#8217;s values accessible to SpEL as a bean using the
<code class="literal">util:properties</code> tag:</p>
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"applicationProps"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"/WEB-INF/spring/application.properties"</span><span class="hl-tag">/&gt;</span></pre>

<p>With the application version now accessible via SpEL, we can incorporate this into the
use of the <code class="literal">resources</code> tag:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:resources</span> <span class="hl-attribute">mapping</span>=<span class="hl-value">"/resources-#{applicationProps[</span><span class="emphasis"><em>application.version</em></span>]}/**" location="/public-resources/"/&gt;</pre>

<p>In Java, you can use the <code class="literal">@PropertySouce</code> annotation and then inject the <code class="literal">Environment</code>
abstraction for access to all defined properties:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<i><span class="hl-annotation" style="color: gray">@PropertySource("/WEB-INF/spring/application.properties")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Inject</span></i> Environment env;

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler(
                <span class="hl-string">"/resources-"</span> + env.getProperty(<span class="hl-string">"application.version"</span>) + <span class="hl-string">"/**"</span>)
                .addResourceLocations(<span class="hl-string">"/public-resources/"</span>);
    }

}</pre>

<p>and finally, to request the resource with the proper URL, we can take advantage of the
Spring JSP tags:</p>
<pre class="programlisting"><span class="hl-tag">&lt;spring:eval</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@applicationProps[</span><span class="emphasis"><em>application.version</em></span>]" var="applicationVersion"/&gt;

<span class="hl-tag">&lt;spring:url</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/resources-{applicationVersion}"</span> <span class="hl-attribute">var</span>=<span class="hl-value">"resourceUrl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;spring:param</span> <span class="hl-attribute">name</span>=<span class="hl-value">"applicationVersion"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${applicationVersion}"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/spring:url&gt;</span>

<span class="hl-tag">&lt;script</span> <span class="hl-attribute">src</span>=<span class="hl-value">"${resourceUrl}/dojo/dojo.js"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/javascript"</span><span class="hl-tag">&gt;</span> <span class="hl-tag">&lt;/script&gt;</span></pre>

</div>
<div class="section" title="16.16.7&nbsp;mvc:default-servlet-handler"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-default-servlet-handler"></a>16.16.7&nbsp;mvc:default-servlet-handler</h3></div></div></div>

<p>This tag allows for mapping the <code class="literal">DispatcherServlet</code> to "/" (thus overriding the mapping
of the container&#8217;s default Servlet), while still allowing static resource requests to be
handled by the container&#8217;s default Servlet. It configures a
<code class="literal">DefaultServletHttpRequestHandler</code> with a URL mapping of "/**" and the lowest priority
relative to other URL mappings.</p>
<p>This handler will forward all requests to the default Servlet. Therefore it is important
that it remains last in the order of all other URL <code class="literal">HandlerMappings</code>. That will be the
case if you use <code class="literal">&lt;mvc:annotation-driven&gt;</code> or alternatively if you are setting up your
own customized <code class="literal">HandlerMapping</code> instance be sure to set its <code class="literal">order</code> property to a value
lower than that of the <code class="literal">DefaultServletHttpRequestHandler</code>, which is <code class="literal">Integer.MAX_VALUE</code>.</p>
<p>To enable the feature using the default setup use:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureDefaultServletHandling(DefaultServletHandlerConfigurer configurer) {
        configurer.enable();
    }

}</pre>

<p>Or in XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:default-servlet-handler/&gt;</span></pre>

<p>The caveat to overriding the "/" Servlet mapping is that the <code class="literal">RequestDispatcher</code> for the
default Servlet must be retrieved by name rather than by path. The
<code class="literal">DefaultServletHttpRequestHandler</code> will attempt to auto-detect the default Servlet for
the container at startup time, using a list of known names for most of the major Servlet
containers (including Tomcat, Jetty, GlassFish, JBoss, Resin, WebLogic, and WebSphere).
If the default Servlet has been custom configured with a different name, or if a
different Servlet container is being used where the default Servlet name is unknown,
then the default Servlet&#8217;s name must be explicitly provided as in the following example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> WebMvcConfigurerAdapter {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureDefaultServletHandling(DefaultServletHandlerConfigurer configurer) {
        configurer.enable(<span class="hl-string">"myCustomDefaultServlet"</span>);
    }

}</pre>

<p>Or in XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:default-servlet-handler</span> <span class="hl-attribute">default-servlet-name</span>=<span class="hl-value">"myCustomDefaultServlet"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="16.16.8&nbsp;More Spring Web MVC Resources"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-resources"></a>16.16.8&nbsp;More Spring Web MVC Resources</h3></div></div></div>

<p>See the following links and pointers for more resources about Spring Web MVC:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
There are many excellent articles and tutorials that show how to build web
applications with Spring MVC. Read them at the <a class="ulink" href="http://spring.io/docs" target="_top">Spring
Documentation</a> page.
</li><li class="listitem">
"Expert Spring Web MVC and Web Flow" by Seth Ladd and others (published by Apress) is
an excellent hard copy source of Spring Web MVC goodness.
</li></ul></div>

</div>
<div class="section" title="16.16.9&nbsp;Advanced Customizations with MVC Java Config"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-config-advanced-java"></a>16.16.9&nbsp;Advanced Customizations with MVC Java Config</h3></div></div></div>

<p>As you can see from the above examples, MVC Java config and the MVC namespace provide
higher level constructs that do not require deep knowledge of the underlying beans
created for you. Instead it helps you to focus on your application needs. However, at
some point you may need more fine-grained control or you may simply wish to understand
the underlying configuration.</p>
<p>The first step towards more fine-grained control is to see the underlying beans created
for you. In MVC Java config you can see the Javadoc and the <code class="literal">@Bean</code> methods in
<code class="literal">WebMvcConfigurationSupport</code>. The configuration in this class is automatically imported
through the <code class="literal">@EnableWebMvc</code> annotation. In fact if you open <code class="literal">@EnableWebMvc</code> you can see
the <code class="literal">@Import</code> statement.</p>
<p>The next step towards more fine-grained control is to customize a property on one of the
beans created in <code class="literal">WebMvcConfigurationSupport</code> or perhaps to provide your own instance.
This requires two things&#8201;&#8212;&#8201;remove the <code class="literal">@EnableWebMvc</code> annotation in order to prevent
the import and then extend from <code class="literal">DelegatingWebMvcConfiguration</code>, a subclass of
<code class="literal">WebMvcConfigurationSupport</code>.
Here is an example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebConfig <span class="hl-keyword">extends</span> DelegatingWebMvcConfiguration {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addInterceptors(InterceptorRegistry registry){
        <span class="hl-comment">// ...</span>
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> RequestMappingHandlerAdapter requestMappingHandlerAdapter() {
        <span class="hl-comment">// Create or let "super" create the adapter</span>
        <span class="hl-comment">// Then customize one of its properties</span>
    }

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>An application should have only one configuration extending <code class="literal">DelegatingWebMvcConfiguration</code>
or a single <code class="literal">@EnableWebMvc</code> annotated class, since they both register the same underlying
beans.</p>
<p>Modifying beans in this way does not prevent you from using any of the higher-level
constructs shown earlier in this section. <code class="literal">WebMvcConfigurerAdapter</code> subclasses and
<code class="literal">WebMvcConfigurer</code> implementations are still being used.</p>
</td></tr></table></div>

</div>
<div class="section" title="16.16.10&nbsp;Advanced Customizations with the MVC Namespace"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-config-advanced-xml"></a>16.16.10&nbsp;Advanced Customizations with the MVC Namespace</h3></div></div></div>

<p>Fine-grained control over the configuration created for you is a bit harder with the MVC
namespace.</p>
<p>If you do need to do that, rather than replicating the configuration it provides,
consider configuring a <code class="literal">BeanPostProcessor</code> that detects the bean you want to customize
by type and then modifying its properties as necessary. For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Component</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyPostProcessor <span class="hl-keyword">implements</span> BeanPostProcessor {

    <span class="hl-keyword">public</span> Object postProcessBeforeInitialization(Object bean, String name) <span class="hl-keyword">throws</span> BeansException {
        <span class="hl-keyword">if</span> (bean <span class="hl-keyword">instanceof</span> RequestMappingHandlerAdapter) {
            <span class="hl-comment">// Modify properties of the adapter</span>
        }
    }

}</pre>

<p>Note that <code class="literal">MyPostProcessor</code> needs to be included in an <code class="literal">&lt;component scan /&gt;</code> in order for
it to be detected or if you prefer you can declare it explicitly with an XML bean
declaration.</p>
</div>
</div>
</div>
<div class="chapter" title="17.&nbsp;View technologies"><div class="titlepage"><div><div><h2 class="title"><a name="view"></a>17.&nbsp;View technologies</h2></div></div></div>

<div class="section" title="17.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-introduction"></a>17.1&nbsp;Introduction</h2></div></div></div>

<p>One of the areas in which Spring excels is in the separation of view technologies from
the rest of the MVC framework. For example, deciding to use Velocity or XSLT in place of
an existing JSP is primarily a matter of configuration. This chapter covers the major
view technologies that work with Spring and touches briefly on how to add new ones. This
chapter assumes you are already familiar with <a class="xref" href="#mvc-viewresolver" title="16.5&nbsp;Resolving views">Section&nbsp;16.5, &#8220;Resolving views&#8221;</a> which covers the
basics of how views in general are coupled to the MVC framework.</p>
</div>
<div class="section" title="17.2&nbsp;JSP &amp; JSTL"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-jsp"></a>17.2&nbsp;JSP &amp; JSTL</h2></div></div></div>

<p>Spring provides a couple of out-of-the-box solutions for JSP and JSTL views. Using JSP
or JSTL is done using a normal view resolver defined in the <code class="literal">WebApplicationContext</code>.
Furthermore, of course you need to write some JSPs that will actually render the view.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Setting up your application to use JSTL is a common source of error, mainly caused by
confusion over the different servlet spec., JSP and JSTL version numbers, what they mean
and how to declare the taglibs correctly. The article
<a class="ulink" href="http://www.mularien.com/blog/2008/04/24/how-to-reference-and-use-jstl-in-your-web-application/" target="_top">How
to Reference and Use JSTL in your Web Application</a> provides a useful guide to the common
pitfalls and how to avoid them. Note that as of Spring 3.0, the minimum supported
servlet version is 2.4 (JSP 2.0 and JSTL 1.1), which reduces the scope for confusion
somewhat.</p>
</td></tr></table></div>

<div class="section" title="17.2.1&nbsp;View resolvers"><div class="titlepage"><div><div><h3 class="title"><a name="view-jsp-resolver"></a>17.2.1&nbsp;View resolvers</h3></div></div></div>

<p>Just as with any other view technology you&#8217;re integrating with Spring, for JSPs you&#8217;ll
need a view resolver that will resolve your views. The most commonly used view resolvers
when developing with JSPs are the <code class="literal">InternalResourceViewResolver</code> and the
<code class="literal">ResourceBundleViewResolver</code>. Both are declared in the <code class="literal">WebApplicationContext</code>:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- the ResourceBundleViewResolver --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.ResourceBundleViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"views"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

# And a sample properties file is uses (views.properties in WEB-INF/classes):
welcome.(class)=org.springframework.web.servlet.view.JstlView
welcome.url=/WEB-INF/jsp/welcome.jsp

productList.(class)=org.springframework.web.servlet.view.JstlView
productList.url=/WEB-INF/jsp/productlist.jsp</pre>

<p>As you can see, the <code class="literal">ResourceBundleViewResolver</code> needs a properties file defining the
view names mapped to 1) a class and 2) a URL. With a <code class="literal">ResourceBundleViewResolver</code> you
can mix different types of views using only one resolver.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"viewClass"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.web.servlet.view.JstlView"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/jsp/"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".jsp"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">InternalResourceBundleViewResolver</code> can be configured for using JSPs as described
above. As a best practice, we strongly encourage placing your JSP files in a directory
under the <code class="literal">'WEB-INF'</code> directory, so there can be no direct access by clients.</p>
</div>
<div class="section" title="17.2.2&nbsp;Plain-old JSPs versus JSTL"><div class="titlepage"><div><div><h3 class="title"><a name="view-jsp-jstl"></a>17.2.2&nbsp;<span class="emphasis"><em>Plain-old</em></span> JSPs versus JSTL</h3></div></div></div>

<p>When using the Java Standard Tag Library you must use a special view class, the
<code class="literal">JstlView</code>, as JSTL needs some preparation before things such as the I18N features will
work.</p>
</div>
<div class="section" title="17.2.3&nbsp;Additional tags facilitating development"><div class="titlepage"><div><div><h3 class="title"><a name="view-jsp-tags"></a>17.2.3&nbsp;Additional tags facilitating development</h3></div></div></div>

<p>Spring provides data binding of request parameters to command objects as described in
earlier chapters. To facilitate the development of JSP pages in combination with those
data binding features, Spring provides a few tags that make things even easier. All
Spring tags have<span class="emphasis"><em>HTML escaping</em></span> features to enable or disable escaping of characters.</p>
<p>The tag library descriptor (TLD) is included in the <code class="literal">spring-webmvc.jar</code>. Further
information about the individual tags can be found in the appendix entitled
<a class="xref" href="#spring.tld" title="35.&nbsp;spring.tld">Chapter&nbsp;35, <i>spring.tld</i></a>.</p>
</div>
<div class="section" title="17.2.4&nbsp;Using Spring&#8217;s form tag library"><div class="titlepage"><div><div><h3 class="title"><a name="view-jsp-formtaglib"></a>17.2.4&nbsp;Using Spring&#8217;s form tag library</h3></div></div></div>

<p>As of version 2.0, Spring provides a comprehensive set of data binding-aware tags for
handling form elements when using JSP and Spring Web MVC. Each tag provides support for
the set of attributes of its corresponding HTML tag counterpart, making the tags
familiar and intuitive to use. The tag-generated HTML is HTML 4.01/XHTML 1.0 compliant.</p>
<p>Unlike other form/input tag libraries, Spring&#8217;s form tag library is integrated with
Spring Web MVC, giving the tags access to the command object and reference data your
controller deals with. As you will see in the following examples, the form tags make
JSPs easier to develop, read and maintain.</p>
<p>Let&#8217;s go through the form tags and look at an example of how each tag is used. We have
included generated HTML snippets where certain tags require further commentary.</p>
<div class="section" title="Configuration"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-configuration"></a>Configuration</h4></div></div></div>

<p>The form tag library comes bundled in <code class="literal">spring-webmvc.jar</code>. The library descriptor is
called <code class="literal">spring-form.tld</code>.</p>
<p>To use the tags from this library, add the following directive to the top of your JSP
page:</p>
<pre class="programlisting"><span class="hl-tag">&lt;%@</span> <span class="hl-attribute">taglib</span> <span class="hl-attribute">prefix</span>=<span class="hl-value">"form"</span> <span class="hl-attribute">uri</span>=<span class="hl-value">"http://www.springframework.org/tags/form"</span> <span class="hl-attribute">%&gt;</span></pre>

<p>where <code class="literal">form</code> is the tag name prefix you want to use for the tags from this library.</p>
</div>
<div class="section" title="The form tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-formtag"></a>The form tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>form</em></span> tag and exposes a binding path to inner tags for
binding. It puts the command object in the <code class="literal">PageContext</code> so that the command object can
be accessed by inner tags. <span class="emphasis"><em>All the other tags in this library are nested tags of the
<code class="literal">form</code> tag</em></span>.</p>
<p>Let&#8217;s assume we have a domain object called <code class="literal">User</code>. It is a JavaBean with properties
such as <code class="literal">firstName</code> and <code class="literal">lastName</code>. We will use it as the form backing object of our
form controller which returns <code class="literal">form.jsp</code>. Below is an example of what <code class="literal">form.jsp</code> would
look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form:form&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>First Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:input</span> <span class="hl-attribute">path</span>=<span class="hl-value">"firstName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Last Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:input</span> <span class="hl-attribute">path</span>=<span class="hl-value">"lastName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td</span> <span class="hl-attribute">colspan</span>=<span class="hl-value">"2"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Save Changes"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
    <span class="hl-tag">&lt;/table&gt;</span>
<span class="hl-tag">&lt;/form:form&gt;</span></pre>

<p>The <code class="literal">firstName</code> and <code class="literal">lastName</code> values are retrieved from the command object placed in
the <code class="literal">PageContext</code> by the page controller. Keep reading to see more complex examples of
how inner tags are used with the <code class="literal">form</code> tag.</p>
<p>The generated HTML looks like a standard form:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"POST"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>First Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Harry"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Last Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Potter"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td</span> <span class="hl-attribute">colspan</span>=<span class="hl-value">"2"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Save Changes"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
    <span class="hl-tag">&lt;/table&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span></pre>

<p>The preceding JSP assumes that the variable name of the form backing object is
<code class="literal">'command'</code>. If you have put the form backing object into the model under another name
(definitely a best practice), then you can bind the form to the named variable like so:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form:form</span> <span class="hl-attribute">commandName</span>=<span class="hl-value">"user"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>First Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:input</span> <span class="hl-attribute">path</span>=<span class="hl-value">"firstName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Last Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:input</span> <span class="hl-attribute">path</span>=<span class="hl-value">"lastName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td</span> <span class="hl-attribute">colspan</span>=<span class="hl-value">"2"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Save Changes"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
    <span class="hl-tag">&lt;/table&gt;</span>
<span class="hl-tag">&lt;/form:form&gt;</span></pre>

</div>
<div class="section" title="The input tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-inputtag"></a>The input tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>input</em></span> tag using the bound value and type=<span class="emphasis"><em>text</em></span> by default.
For an example of this tag, see <a class="xref" href="#view-jsp-formtaglib-formtag" title="The form tag">the section called &#8220;The form tag&#8221;</a>. Starting with Spring
3.1 you can use other types such HTML5-specific types like <span class="emphasis"><em>email</em></span>, <span class="emphasis"><em>tel</em></span>, <span class="emphasis"><em>date</em></span>, and
others.</p>
</div>
<div class="section" title="The checkbox tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-checkboxtag"></a>The checkbox tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>checkbox</em></span>.</p>
<p>Let&#8217;s assume our <code class="literal">User</code> has preferences such as newsletter subscription and a list of
hobbies. Below is an example of the <code class="literal">Preferences</code> class:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Preferences {

    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> receiveNewsletter;
    <span class="hl-keyword">private</span> String[] interests;
    <span class="hl-keyword">private</span> String favouriteWord;

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isReceiveNewsletter() {
        <span class="hl-keyword">return</span> receiveNewsletter;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setReceiveNewsletter(<span class="hl-keyword">boolean</span> receiveNewsletter) {
        <span class="hl-keyword">this</span>.receiveNewsletter = receiveNewsletter;
    }

    <span class="hl-keyword">public</span> String[] getInterests() {
        <span class="hl-keyword">return</span> interests;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setInterests(String[] interests) {
        <span class="hl-keyword">this</span>.interests = interests;
    }

    <span class="hl-keyword">public</span> String getFavouriteWord() {
        <span class="hl-keyword">return</span> favouriteWord;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setFavouriteWord(String favouriteWord) {
        <span class="hl-keyword">this</span>.favouriteWord = favouriteWord;
    }
}</pre>

<p>The <code class="literal">form.jsp</code> would look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form:form&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Subscribe to newsletter?:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;%--</span> <span class="hl-attribute">Approach</span> <span class="hl-attribute">1:</span> <span class="hl-attribute">Property</span> <span class="hl-attribute">is</span> <span class="hl-attribute">of</span> <span class="hl-attribute">type</span> <span class="hl-attribute">java.lang.Boolean</span> <span class="hl-attribute">--%&gt;</span>
            <span class="hl-attribute">&lt;td&gt;&lt;form:checkbox</span> <span class="hl-attribute">path</span>=<span class="hl-value">"preferences.receiveNewsletter"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>

        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Interests:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;%--</span> <span class="hl-attribute">Approach</span> <span class="hl-attribute">2:</span> <span class="hl-attribute">Property</span> <span class="hl-attribute">is</span> <span class="hl-attribute">of</span> <span class="hl-attribute">an</span> <span class="hl-attribute">array</span> <span class="hl-attribute">or</span> <span class="hl-attribute">of</span> <span class="hl-attribute">type</span> <span class="hl-attribute">java.util.Collection</span> <span class="hl-attribute">--%&gt;</span>
            <span class="hl-attribute">&lt;td&gt;</span>
                <span class="hl-attribute">Quidditch:</span> <span class="hl-attribute">&lt;form:checkbox</span> <span class="hl-attribute">path</span>=<span class="hl-value">"preferences.interests"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Quidditch"</span><span class="hl-tag">/&gt;</span>
                Herbology: <span class="hl-tag">&lt;form:checkbox</span> <span class="hl-attribute">path</span>=<span class="hl-value">"preferences.interests"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Herbology"</span><span class="hl-tag">/&gt;</span>
                Defence Against the Dark Arts: <span class="hl-tag">&lt;form:checkbox</span> <span class="hl-attribute">path</span>=<span class="hl-value">"preferences.interests"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Defence Against the Dark Arts"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>

        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Favourite Word:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;%--</span> <span class="hl-attribute">Approach</span> <span class="hl-attribute">3:</span> <span class="hl-attribute">Property</span> <span class="hl-attribute">is</span> <span class="hl-attribute">of</span> <span class="hl-attribute">type</span> <span class="hl-attribute">java.lang.Object</span> <span class="hl-attribute">--%&gt;</span>
            <span class="hl-attribute">&lt;td&gt;</span>
                <span class="hl-attribute">Magic:</span> <span class="hl-attribute">&lt;form:checkbox</span> <span class="hl-attribute">path</span>=<span class="hl-value">"preferences.favouriteWord"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Magic"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
    <span class="hl-tag">&lt;/table&gt;</span>
<span class="hl-tag">&lt;/form:form&gt;</span></pre>

<p>There are 3 approaches to the <code class="literal">checkbox</code> tag which should meet all your checkbox needs.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Approach One - When the bound value is of type <code class="literal">java.lang.Boolean</code>, the
<code class="literal">input(checkbox)</code> is marked as <span class="emphasis"><em>checked</em></span> if the bound value is <code class="literal">true</code>. The <code class="literal">value</code>
attribute corresponds to the resolved value of the <code class="literal">setValue(Object)</code> value property.
</li><li class="listitem">
Approach Two - When the bound value is of type <code class="literal">array</code> or <code class="literal">java.util.Collection</code>, the
<code class="literal">input(checkbox)</code> is marked as <span class="emphasis"><em>checked</em></span> if the configured <code class="literal">setValue(Object)</code> value is
present in the bound <code class="literal">Collection</code>.
</li><li class="listitem">
Approach Three - For any other bound value type, the <code class="literal">input(checkbox)</code> is marked as
<span class="emphasis"><em>checked</em></span> if the configured <code class="literal">setValue(Object)</code> is equal to the bound value.
</li></ul></div>

<p>Note that regardless of the approach, the same HTML structure is generated. Below is an
HTML snippet of some checkboxes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Interests:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        Quidditch: <span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"preferences.interests"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"checkbox"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Quidditch"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"_preferences.interests"</span><span class="hl-tag">/&gt;</span>
        Herbology: <span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"preferences.interests"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"checkbox"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Herbology"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"_preferences.interests"</span><span class="hl-tag">/&gt;</span>
        Defence Against the Dark Arts: <span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"preferences.interests"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"checkbox"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Defence Against the Dark Arts"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"_preferences.interests"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

<p>What you might not expect to see is the additional hidden field after each checkbox.
When a checkbox in an HTML page is <span class="emphasis"><em>not</em></span> checked, its value will not be sent to the
server as part of the HTTP request parameters once the form is submitted, so we need a
workaround for this quirk in HTML in order for Spring form data binding to work. The
<code class="literal">checkbox</code> tag follows the existing Spring convention of including a hidden parameter
prefixed by an underscore ("_") for each checkbox. By doing this, you are effectively
telling Spring that "<span class="emphasis"><em>the checkbox was visible in the form and I want my object to
which the form data will be bound to reflect the state of the checkbox no matter what</em></span>".</p>
</div>
<div class="section" title="The checkboxes tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-checkboxestag"></a>The checkboxes tag</h4></div></div></div>

<p>This tag renders multiple HTML <span class="emphasis"><em>input</em></span> tags with type <span class="emphasis"><em>checkbox</em></span>.</p>
<p>Building on the example from the previous <code class="literal">checkbox</code> tag section. Sometimes you prefer
not to have to list all the possible hobbies in your JSP page. You would rather provide
a list at runtime of the available options and pass that in to the tag. That is the
purpose of the <code class="literal">checkboxes</code> tag. You pass in an <code class="literal">Array</code>, a <code class="literal">List</code> or a <code class="literal">Map</code> containing
the available options in the "items" property. Typically the bound property is a
collection so it can hold multiple values selected by the user. Below is an example of
the JSP using this tag:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form:form&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Interests:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>
                <span class="hl-tag">&lt;%--</span> <span class="hl-attribute">Property</span> <span class="hl-attribute">is</span> <span class="hl-attribute">of</span> <span class="hl-attribute">an</span> <span class="hl-attribute">array</span> <span class="hl-attribute">or</span> <span class="hl-attribute">of</span> <span class="hl-attribute">type</span> <span class="hl-attribute">java.util.Collection</span> <span class="hl-attribute">--%&gt;</span>
                <span class="hl-attribute">&lt;form:checkboxes</span> <span class="hl-attribute">path</span>=<span class="hl-value">"preferences.interests"</span> <span class="hl-attribute">items</span>=<span class="hl-value">"${interestList}"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
    <span class="hl-tag">&lt;/table&gt;</span>
<span class="hl-tag">&lt;/form:form&gt;</span></pre>

<p>This example assumes that the "interestList" is a <code class="literal">List</code> available as a model attribute
containing strings of the values to be selected from. In the case where you use a Map,
the map entry key will be used as the value and the map entry&#8217;s value will be used as
the label to be displayed. You can also use a custom object where you can provide the
property names for the value using "itemValue" and the label using "itemLabel".</p>
</div>
<div class="section" title="The radiobutton tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-radiobuttontag"></a>The radiobutton tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>radio</em></span>.</p>
<p>A typical usage pattern will involve multiple tag instances bound to the same property
but with different values.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Sex:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        Male: <span class="hl-tag">&lt;form:radiobutton</span> <span class="hl-attribute">path</span>=<span class="hl-value">"sex"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"M"</span><span class="hl-tag">/&gt;</span> <span class="hl-tag">&lt;br/&gt;</span>
        Female: <span class="hl-tag">&lt;form:radiobutton</span> <span class="hl-attribute">path</span>=<span class="hl-value">"sex"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"F"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

</div>
<div class="section" title="The radiobuttons tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-radiobuttonstag"></a>The radiobuttons tag</h4></div></div></div>

<p>This tag renders multiple HTML <span class="emphasis"><em>input</em></span> tags with type <span class="emphasis"><em>radio</em></span>.</p>
<p>Just like the <code class="literal">checkboxes</code> tag above, you might want to pass in the available options as
a runtime variable. For this usage you would use the <code class="literal">radiobuttons</code> tag. You pass in an
<code class="literal">Array</code>, a <code class="literal">List</code> or a <code class="literal">Map</code> containing the available options in the "items" property.
In the case where you use a Map, the map entry key will be used as the value and the map
entry&#8217;s value will be used as the label to be displayed. You can also use a custom
object where you can provide the property names for the value using "itemValue" and the
label using "itemLabel".</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Sex:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:radiobuttons</span> <span class="hl-attribute">path</span>=<span class="hl-value">"sex"</span> <span class="hl-attribute">items</span>=<span class="hl-value">"${sexOptions}"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

</div>
<div class="section" title="The password tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-passwordtag"></a>The password tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>password</em></span> using the bound value.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Password:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        <span class="hl-tag">&lt;form:password</span> <span class="hl-attribute">path</span>=<span class="hl-value">"password"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

<p>Please note that by default, the password value is <span class="emphasis"><em>not</em></span> shown. If you do want the
password value to be shown, then set the value of the <code class="literal">'showPassword'</code> attribute to
true, like so.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Password:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        <span class="hl-tag">&lt;form:password</span> <span class="hl-attribute">path</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"^76525bvHGq"</span> <span class="hl-attribute">showPassword</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

</div>
<div class="section" title="The select tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-selecttag"></a>The select tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>select</em></span> element. It supports data binding to the selected
option as well as the use of nested <code class="literal">option</code> and <code class="literal">options</code> tags.</p>
<p>Let&#8217;s assume a <code class="literal">User</code> has a list of skills.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Skills:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:select</span> <span class="hl-attribute">path</span>=<span class="hl-value">"skills"</span> <span class="hl-attribute">items</span>=<span class="hl-value">"${skills}"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

<p>If the <code class="literal">User's</code> skill were in Herbology, the HTML source of the <span class="emphasis"><em>Skills</em></span> row would look
like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Skills:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        <span class="hl-tag">&lt;select</span> <span class="hl-attribute">name</span>=<span class="hl-value">"skills"</span> <span class="hl-attribute">multiple</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Potions"</span><span class="hl-tag">&gt;</span>Potions<span class="hl-tag">&lt;/option&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Herbology"</span> <span class="hl-attribute">selected</span>=<span class="hl-value">"selected"</span><span class="hl-tag">&gt;</span>Herbology<span class="hl-tag">&lt;/option&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Quidditch"</span><span class="hl-tag">&gt;</span>Quidditch<span class="hl-tag">&lt;/option&gt;</span>
        <span class="hl-tag">&lt;/select&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

</div>
<div class="section" title="The option tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-optiontag"></a>The option tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>option</em></span>. It sets <span class="emphasis"><em>selected</em></span> as appropriate based on the bound
value.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>House:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        <span class="hl-tag">&lt;form:select</span> <span class="hl-attribute">path</span>=<span class="hl-value">"house"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;form:option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Gryffindor"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;form:option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Hufflepuff"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;form:option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Ravenclaw"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;form:option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Slytherin"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/form:select&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

<p>If the <code class="literal">User's</code> house was in Gryffindor, the HTML source of the <span class="emphasis"><em>House</em></span> row would look
like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>House:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        <span class="hl-tag">&lt;select</span> <span class="hl-attribute">name</span>=<span class="hl-value">"house"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Gryffindor"</span> <span class="hl-attribute">selected</span>=<span class="hl-value">"selected"</span><span class="hl-tag">&gt;</span>Gryffindor<span class="hl-tag">&lt;/option&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Hufflepuff"</span><span class="hl-tag">&gt;</span>Hufflepuff<span class="hl-tag">&lt;/option&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Ravenclaw"</span><span class="hl-tag">&gt;</span>Ravenclaw<span class="hl-tag">&lt;/option&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Slytherin"</span><span class="hl-tag">&gt;</span>Slytherin<span class="hl-tag">&lt;/option&gt;</span>
        <span class="hl-tag">&lt;/select&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

</div>
<div class="section" title="The options tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-optionstag"></a>The options tag</h4></div></div></div>

<p>This tag renders a list of HTML <span class="emphasis"><em>option</em></span> tags. It sets the <span class="emphasis"><em>selected</em></span> attribute as
appropriate based on the bound value.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Country:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        <span class="hl-tag">&lt;form:select</span> <span class="hl-attribute">path</span>=<span class="hl-value">"country"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;form:option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"-"</span> <span class="hl-attribute">label</span>=<span class="hl-value">"--Please Select"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;form:options</span> <span class="hl-attribute">items</span>=<span class="hl-value">"${countryList}"</span> <span class="hl-attribute">itemValue</span>=<span class="hl-value">"code"</span> <span class="hl-attribute">itemLabel</span>=<span class="hl-value">"name"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/form:select&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

<p>If the <code class="literal">User</code> lived in the UK, the HTML source of the <span class="emphasis"><em>Country</em></span> row would look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Country:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>
        <span class="hl-tag">&lt;select</span> <span class="hl-attribute">name</span>=<span class="hl-value">"country"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"-"</span><span class="hl-tag">&gt;</span>--Please Select<span class="hl-tag">&lt;/option&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"AT"</span><span class="hl-tag">&gt;</span>Austria<span class="hl-tag">&lt;/option&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"UK"</span> <span class="hl-attribute">selected</span>=<span class="hl-value">"selected"</span><span class="hl-tag">&gt;</span>United Kingdom<span class="hl-tag">&lt;/option&gt;</span>
            <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"US"</span><span class="hl-tag">&gt;</span>United States<span class="hl-tag">&lt;/option&gt;</span>
        <span class="hl-tag">&lt;/select&gt;</span>
    <span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

<p>As the example shows, the combined usage of an <code class="literal">option</code> tag with the <code class="literal">options</code> tag
generates the same standard HTML, but allows you to explicitly specify a value in the
JSP that is for display only (where it belongs) such as the default string in the
example: "-- Please Select".</p>
<p>The <code class="literal">items</code> attribute is typically populated with a collection or array of item objects.
<code class="literal">itemValue</code> and <code class="literal">itemLabel</code> simply refer to bean properties of those item objects, if
specified; otherwise, the item objects themselves will be stringified. Alternatively,
you may specify a <code class="literal">Map</code> of items, in which case the map keys are interpreted as option
values and the map values correspond to option labels. If <code class="literal">itemValue</code> and/or <code class="literal">itemLabel</code>
happen to be specified as well, the item value property will apply to the map key and
the item label property will apply to the map value.</p>
</div>
<div class="section" title="The textarea tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-textAreatag"></a>The textarea tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>textarea</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;tr&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span>Notes:<span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:textarea</span> <span class="hl-attribute">path</span>=<span class="hl-value">"notes"</span> <span class="hl-attribute">rows</span>=<span class="hl-value">"3"</span> <span class="hl-attribute">cols</span>=<span class="hl-value">"20"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
    <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:errors</span> <span class="hl-attribute">path</span>=<span class="hl-value">"notes"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
<span class="hl-tag">&lt;/tr&gt;</span></pre>

</div>
<div class="section" title="The hidden tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-hiddeninputtag"></a>The hidden tag</h4></div></div></div>

<p>This tag renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>hidden</em></span> using the bound value. To submit
an unbound hidden value, use the HTML <code class="literal">input</code> tag with type <span class="emphasis"><em>hidden</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;form:hidden</span> <span class="hl-attribute">path</span>=<span class="hl-value">"house"</span><span class="hl-tag"> /&gt;</span>

</pre>

<p>If we choose to submit the <span class="emphasis"><em>house</em></span> value as a hidden one, the HTML would look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"house"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Gryffindor"</span><span class="hl-tag">/&gt;</span>

</pre>

</div>
<div class="section" title="The errors tag"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-errorstag"></a>The errors tag</h4></div></div></div>

<p>This tag renders field errors in an HTML <span class="emphasis"><em>span</em></span> tag. It provides access to the errors
created in your controller or those that were created by any validators associated with
your controller.</p>
<p>Let&#8217;s assume we want to display all error messages for the <code class="literal">firstName</code> and <code class="literal">lastName</code>
fields once we submit the form. We have a validator for instances of the <code class="literal">User</code> class
called <code class="literal">UserValidator</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UserValidator <span class="hl-keyword">implements</span> Validator {

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> supports(Class candidate) {
        <span class="hl-keyword">return</span> User.<span class="hl-keyword">class</span>.isAssignableFrom(candidate);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> validate(Object obj, Errors errors) {
        ValidationUtils.rejectIfEmptyOrWhitespace(errors, <span class="hl-string">"firstName"</span>, <span class="hl-string">"required"</span>, <span class="hl-string">"Field is required."</span>);
        ValidationUtils.rejectIfEmptyOrWhitespace(errors, <span class="hl-string">"lastName"</span>, <span class="hl-string">"required"</span>, <span class="hl-string">"Field is required."</span>);
    }
}</pre>

<p>The <code class="literal">form.jsp</code> would look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form:form&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>First Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:input</span> <span class="hl-attribute">path</span>=<span class="hl-value">"firstName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;%--</span> <span class="hl-attribute">Show</span> <span class="hl-attribute">errors</span> <span class="hl-attribute">for</span> <span class="hl-attribute">firstName</span> <span class="hl-attribute">field</span> <span class="hl-attribute">--%&gt;</span>
            <span class="hl-attribute">&lt;td&gt;&lt;form:errors</span> <span class="hl-attribute">path</span>=<span class="hl-value">"firstName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>

        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Last Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:input</span> <span class="hl-attribute">path</span>=<span class="hl-value">"lastName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;%--</span> <span class="hl-attribute">Show</span> <span class="hl-attribute">errors</span> <span class="hl-attribute">for</span> <span class="hl-attribute">lastName</span> <span class="hl-attribute">field</span> <span class="hl-attribute">--%&gt;</span>
            <span class="hl-attribute">&lt;td&gt;&lt;form:errors</span> <span class="hl-attribute">path</span>=<span class="hl-value">"lastName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td</span> <span class="hl-attribute">colspan</span>=<span class="hl-value">"3"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Save Changes"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
    <span class="hl-tag">&lt;/table&gt;</span>
<span class="hl-tag">&lt;/form:form&gt;</span></pre>

<p>If we submit a form with empty values in the <code class="literal">firstName</code> and <code class="literal">lastName</code> fields, this is
what the HTML would look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"POST"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>First Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;%--</span> <span class="hl-attribute">Associated</span> <span class="hl-attribute">errors</span> <span class="hl-attribute">to</span> <span class="hl-attribute">firstName</span> <span class="hl-attribute">field</span> <span class="hl-attribute">displayed</span> <span class="hl-attribute">--%&gt;</span>
            <span class="hl-attribute">&lt;td&gt;&lt;span</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName.errors"</span><span class="hl-tag">&gt;</span>Field is required.<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>

        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Last Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;%--</span> <span class="hl-attribute">Associated</span> <span class="hl-attribute">errors</span> <span class="hl-attribute">to</span> <span class="hl-attribute">lastName</span> <span class="hl-attribute">field</span> <span class="hl-attribute">displayed</span> <span class="hl-attribute">--%&gt;</span>
            <span class="hl-attribute">&lt;td&gt;&lt;span</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName.errors"</span><span class="hl-tag">&gt;</span>Field is required.<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td</span> <span class="hl-attribute">colspan</span>=<span class="hl-value">"3"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Save Changes"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
    <span class="hl-tag">&lt;/table&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span></pre>

<p>What if we want to display the entire list of errors for a given page? The example below
shows that the <code class="literal">errors</code> tag also supports some basic wildcarding functionality.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">path="*"</code> - displays all errors
</li><li class="listitem">
<code class="literal">path="lastName"</code> - displays all errors associated with the <code class="literal">lastName</code> field
</li><li class="listitem">
if <code class="literal">path</code> is omitted - object errors only are displayed
</li></ul></div>

<p>The example below will display a list of errors at the top of the page, followed by
field-specific errors next to the fields:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form:form&gt;</span>
    <span class="hl-tag">&lt;form:errors</span> <span class="hl-attribute">path</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">cssClass</span>=<span class="hl-value">"errorBox"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>First Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:input</span> <span class="hl-attribute">path</span>=<span class="hl-value">"firstName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:errors</span> <span class="hl-attribute">path</span>=<span class="hl-value">"firstName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Last Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:input</span> <span class="hl-attribute">path</span>=<span class="hl-value">"lastName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;form:errors</span> <span class="hl-attribute">path</span>=<span class="hl-value">"lastName"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td</span> <span class="hl-attribute">colspan</span>=<span class="hl-value">"3"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Save Changes"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
    <span class="hl-tag">&lt;/table&gt;</span>
<span class="hl-tag">&lt;/form:form&gt;</span></pre>

<p>The HTML would look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"POST"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;span</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*.errors"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"errorBox"</span><span class="hl-tag">&gt;</span>Field is required.<span class="hl-tag">&lt;br/&gt;</span>Field is required.<span class="hl-tag">&lt;/span&gt;</span>
    <span class="hl-tag">&lt;table&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>First Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;span</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName.errors"</span><span class="hl-tag">&gt;</span>Field is required.<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>

        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span>Last Name:<span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
            <span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;span</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName.errors"</span><span class="hl-tag">&gt;</span>Field is required.<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
        <span class="hl-tag">&lt;tr&gt;</span>
            <span class="hl-tag">&lt;td</span> <span class="hl-attribute">colspan</span>=<span class="hl-value">"3"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Save Changes"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/td&gt;</span>
        <span class="hl-tag">&lt;/tr&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span></pre>

</div>
<div class="section" title="HTTP Method Conversion"><div class="titlepage"><div><div><h4 class="title"><a name="rest-method-conversion"></a>HTTP Method Conversion</h4></div></div></div>

<p>A key principle of REST is the use of the Uniform Interface. This means that all
resources (URLs) can be manipulated using the same four HTTP methods: GET, PUT, POST,
and DELETE. For each method, the HTTP specification defines the exact semantics. For
instance, a GET should always be a safe operation, meaning that is has no side effects,
and a PUT or DELETE should be idempotent, meaning that you can repeat these operations
over and over again, but the end result should be the same. While HTTP defines these
four methods, HTML only supports two: GET and POST. Fortunately, there are two possible
workarounds: you can either use JavaScript to do your PUT or DELETE, or simply do a POST
with the <span class="emphasis"><em>real</em></span> method as an additional parameter (modeled as a hidden input field in an
HTML form). This latter trick is what Spring&#8217;s <code class="literal">HiddenHttpMethodFilter</code> does. This
filter is a plain Servlet Filter and therefore it can be used in combination with any
web framework (not just Spring MVC). Simply add this filter to your web.xml, and a POST
with a hidden _method parameter will be converted into the corresponding HTTP method
request.</p>
<p>To support HTTP method conversion the Spring MVC form tag was updated to support setting
the HTTP method. For example, the following snippet taken from the updated Petclinic
sample</p>
<pre class="programlisting"><span class="hl-tag">&lt;form:form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"delete"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">class</span>=<span class="hl-value">"submit"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Delete Pet"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/p&gt;</span>
<span class="hl-tag">&lt;/form:form&gt;</span></pre>

<p>This will actually perform an HTTP POST, with the <span class="emphasis"><em>real</em></span> DELETE method hidden behind a
request parameter, to be picked up by the <code class="literal">HiddenHttpMethodFilter</code>, as defined in
web.xml:</p>
<pre class="programlisting">&lt;filter&gt;
    &lt;filter-name&gt;httpMethodFilter&lt;/filter-name&gt;
    &lt;filter-<span class="hl-keyword">class</span>&gt;org.springframework.web.filter.HiddenHttpMethodFilter&lt;/filter-<span class="hl-keyword">class</span>&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;httpMethodFilter&lt;/filter-name&gt;
    &lt;servlet-name&gt;petclinic&lt;/servlet-name&gt;
&lt;/filter-mapping&gt;</pre>

<p>The corresponding @Controller method is shown below:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@RequestMapping(method = RequestMethod.DELETE)</span></i>
<span class="hl-keyword">public</span> String deletePet(<i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> <span class="hl-keyword">int</span> ownerId, <i><span class="hl-annotation" style="color: gray">@PathVariable</span></i> <span class="hl-keyword">int</span> petId) {
    <span class="hl-keyword">this</span>.clinic.deletePet(petId);
    <span class="hl-keyword">return</span> <span class="hl-string">"redirect:/owners/"</span> + ownerId;
}</pre>

</div>
<div class="section" title="HTML5 Tags"><div class="titlepage"><div><div><h4 class="title"><a name="view-jsp-formtaglib-html5"></a>HTML5 Tags</h4></div></div></div>

<p>Starting with Spring 3, the Spring form tag library allows entering dynamic attributes,
which means you can enter any HTML5 specific attributes.</p>
<p>In Spring 3.1, the form input tag supports entering a type attribute other than <span class="emphasis"><em>text</em></span>.
This is intended to allow rendering new HTML5 specific input types such as <span class="emphasis"><em>email</em></span>,
<span class="emphasis"><em>date</em></span>, <span class="emphasis"><em>range</em></span>, and others. Note that entering type=<span class="emphasis"><em>text</em></span> is not required since <span class="emphasis"><em>text</em></span>
is the default type.</p>
</div>
</div>
</div>
<div class="section" title="17.3&nbsp;Tiles"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-tiles"></a>17.3&nbsp;Tiles</h2></div></div></div>

<p>It is possible to integrate Tiles - just as any other view technology - in web
applications using Spring. The following describes in a broad way how to do this.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This section focuses on Spring&#8217;s support for Tiles v3 in the
<code class="literal">org.springframework.web.servlet.view.tiles3</code> package. Tiles v1 (a.k.a. "Struts Tiles")
as well as Tiles v2 are no longer supported by Spring.</p>
</td></tr></table></div>

<div class="section" title="17.3.1&nbsp;Dependencies"><div class="titlepage"><div><div><h3 class="title"><a name="view-tiles-dependencies"></a>17.3.1&nbsp;Dependencies</h3></div></div></div>

<p>To be able to use Tiles you have to have a couple of additional dependencies included in
your project. The following is the list of dependencies you need.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">Tiles version 2.1.2 or higher</code>
</li><li class="listitem">
<code class="literal">Commons BeanUtils</code>
</li><li class="listitem">
<code class="literal">Commons Digester</code>
</li><li class="listitem">
<code class="literal">Commons Logging</code>
</li></ul></div>

</div>
<div class="section" title="17.3.2&nbsp;How to integrate Tiles"><div class="titlepage"><div><div><h3 class="title"><a name="view-tiles-integrate"></a>17.3.2&nbsp;How to integrate Tiles</h3></div></div></div>

<p>To be able to use Tiles, you have to configure it using files containing definitions
(for basic information on definitions and other Tiles concepts, please have a look at
<a class="ulink" href="http://tiles.apache.org" target="_top">http://tiles.apache.org</a>). In Spring this is done using the <code class="literal">TilesConfigurer</code>. Have a
look at the following piece of example ApplicationContext configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"tilesConfigurer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.tiles2.TilesConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"definitions"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/general.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/widgets.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/administrator.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/customer.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/templates.xml<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>As you can see, there are five files containing definitions, which are all located in
the <code class="literal">'WEB-INF/defs'</code> directory. At initialization of the <code class="literal">WebApplicationContext</code>, the
files will be loaded and the definitions factory will be initialized. After that has
been done, the Tiles includes in the definition files can be used as views within your
Spring web application. To be able to use the views you have to have a <code class="literal">ViewResolver</code>
just as with any other view technology used with Spring. Below you can find two
possibilities, the <code class="literal">UrlBasedViewResolver</code> and the <code class="literal">ResourceBundleViewResolver</code>.</p>
<div class="section" title="UrlBasedViewResolver"><div class="titlepage"><div><div><h4 class="title"><a name="view-tiles-url"></a>UrlBasedViewResolver</h4></div></div></div>

<p>The <code class="literal">UrlBasedViewResolver</code> instantiates the given <code class="literal">viewClass</code> for each view it has to
resolve.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.UrlBasedViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"viewClass"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.web.servlet.view.tiles2.TilesView"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="ResourceBundleViewResolver"><div class="titlepage"><div><div><h4 class="title"><a name="view-tiles-resource"></a>ResourceBundleViewResolver</h4></div></div></div>

<p>The <code class="literal">ResourceBundleViewResolver</code> has to be provided with a property file containing
viewnames and viewclasses the resolver can use:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.ResourceBundleViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"views"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<pre class="programlisting">...
welcomeView.(<span class="hl-keyword">class</span>)=org.springframework.web.servlet.view.tiles2.TilesView
welcomeView.url=welcome (<span class="hl-keyword">this</span> is the name of a Tiles definition)

vetsView.(<span class="hl-keyword">class</span>)=org.springframework.web.servlet.view.tiles2.TilesView
vetsView.url=vetsView (again, <span class="hl-keyword">this</span> is the name of a Tiles definition)

findOwnersForm.(<span class="hl-keyword">class</span>)=org.springframework.web.servlet.view.JstlView
findOwnersForm.url=/WEB-INF/jsp/findOwners.jsp
...</pre>

<p>As you can see, when using the <code class="literal">ResourceBundleViewResolver</code>, you can easily mix
different view technologies.</p>
<p>Note that the <code class="literal">TilesView</code> class supports JSTL (the JSP Standard Tag Library) out of the
box.</p>
</div>
<div class="section" title="SimpleSpringPreparerFactory and SpringBeanPreparerFactory"><div class="titlepage"><div><div><h4 class="title"><a name="view-tiles-preparer"></a>SimpleSpringPreparerFactory and SpringBeanPreparerFactory</h4></div></div></div>

<p>As an advanced feature, Spring also supports two special Tiles <code class="literal">PreparerFactory</code>
implementations. Check out the Tiles documentation for details on how to use
<code class="literal">ViewPreparer</code> references in your Tiles definition files.</p>
<p>Specify <code class="literal">SimpleSpringPreparerFactory</code> to autowire ViewPreparer instances based on
specified preparer classes, applying Spring&#8217;s container callbacks as well as applying
configured Spring BeanPostProcessors. If Spring&#8217;s context-wide annotation-config has
been activated, annotations in ViewPreparer classes will be automatically detected and
applied. Note that this expects preparer <span class="emphasis"><em>classes</em></span> in the Tiles definition files, just
like the default <code class="literal">PreparerFactory</code> does.</p>
<p>Specify <code class="literal">SpringBeanPreparerFactory</code> to operate on specified preparer <span class="emphasis"><em>names</em></span> instead
of classes, obtaining the corresponding Spring bean from the DispatcherServlet&#8217;s
application context. The full bean creation process will be in the control of the Spring
application context in this case, allowing for the use of explicit dependency injection
configuration, scoped beans etc. Note that you need to define one Spring bean definition
per preparer name (as used in your Tiles definitions).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"tilesConfigurer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.tiles2.TilesConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"definitions"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/general.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/widgets.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/administrator.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/customer.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>/WEB-INF/defs/templates.xml<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>

    <span class="hl-comment">&lt;!-- resolving preparer names as Spring bean definition names --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"preparerFactoryClass"</span>
            <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.web.servlet.view.tiles2.SpringBeanPreparerFactory"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
</div>
</div>
<div class="section" title="17.4&nbsp;Velocity &amp; FreeMarker"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-velocity"></a>17.4&nbsp;Velocity &amp; FreeMarker</h2></div></div></div>

<p><a class="ulink" href="http://velocity.apache.org" target="_top">Velocity</a> and <a class="ulink" href="http://www.freemarker.org" target="_top">FreeMarker</a> are two
templating languages that can be used as view technologies within Spring MVC
applications. The languages are quite similar and serve similar needs and so are
considered together in this section. For semantic and syntactic differences between the
two languages, see the <a class="ulink" href="http://www.freemarker.org" target="_top">FreeMarker</a> web site.</p>
<div class="section" title="17.4.1&nbsp;Dependencies"><div class="titlepage"><div><div><h3 class="title"><a name="view-velocity-dependencies"></a>17.4.1&nbsp;Dependencies</h3></div></div></div>

<p>Your web application will need to include <code class="literal">velocity-1.x.x.jar</code> or <code class="literal">freemarker-2.x.jar</code>
in order to work with Velocity or FreeMarker respectively and <code class="literal">commons-collections.jar</code>
is required for Velocity. Typically they are included in the <code class="literal">WEB-INF/lib</code> folder where
they are guaranteed to be found by a Java EE server and added to the classpath for your
application. It is of course assumed that you already have the <code class="literal">spring-webmvc.jar</code> in
your <code class="literal">'WEB-INF/lib'</code> directory too! If you make use of Spring&#8217;s <span class="emphasis"><em>dateToolAttribute</em></span> or
<span class="emphasis"><em>numberToolAttribute</em></span> in your Velocity views, you will also need to include the
<code class="literal">velocity-tools-generic-1.x.jar</code></p>
</div>
<div class="section" title="17.4.2&nbsp;Context configuration"><div class="titlepage"><div><div><h3 class="title"><a name="view-velocity-contextconfig"></a>17.4.2&nbsp;Context configuration</h3></div></div></div>

<p>A suitable configuration is initialized by adding the relevant configurer bean
definition to your <code class="literal">'*-servlet.xml'</code> as shown below:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!--
This bean sets up the Velocity environment for us based on a root path for templates.
Optionally, a properties file can be specified for more control over the Velocity
environment, but the defaults are pretty sane for file based template loading.
--&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"velocityConfig"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.velocity.VelocityConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceLoaderPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/velocity/"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-comment">&lt;!--
View resolvers can also be configured with ResourceBundles or XML files. If you need
different view resolving based on Locale, you have to use the resource bundle resolver.
--&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.velocity.VelocityViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cache"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".vm"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<pre class="programlisting"><span class="hl-comment">&lt;!-- freemarker config --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"freemarkerConfig"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"templateLoaderPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/freemarker/"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-comment">&lt;!--
View resolvers can also be configured with ResourceBundles or XML files. If you need
different view resolving based on Locale, you have to use the resource bundle resolver.
--&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.freemarker.FreeMarkerViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cache"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".ftl"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For non web-apps add a <code class="literal">VelocityConfigurationFactoryBean</code> or a
<code class="literal">FreeMarkerConfigurationFactoryBean</code> to your application context definition file.</p>
</td></tr></table></div>

</div>
<div class="section" title="17.4.3&nbsp;Creating templates"><div class="titlepage"><div><div><h3 class="title"><a name="view-velocity-createtemplates"></a>17.4.3&nbsp;Creating templates</h3></div></div></div>

<p>Your templates need to be stored in the directory specified by the <code class="literal">*Configurer</code> bean
shown above. This document does not cover details of creating templates for the two
languages - please see their relevant websites for information. If you use the view
resolvers highlighted, then the logical view names relate to the template file names in
similar fashion to <code class="literal">InternalResourceViewResolver</code> for JSP&#8217;s. So if your controller
returns a ModelAndView object containing a view name of "welcome" then the resolvers
will look for the <code class="literal">/WEB-INF/freemarker/welcome.ftl</code> or <code class="literal">/WEB-INF/velocity/welcome.vm</code>
template as appropriate.</p>
</div>
<div class="section" title="17.4.4&nbsp;Advanced configuration"><div class="titlepage"><div><div><h3 class="title"><a name="view-velocity-advancedconfig"></a>17.4.4&nbsp;Advanced configuration</h3></div></div></div>

<p>The basic configurations highlighted above will be suitable for most application
requirements, however additional configuration options are available for when unusual or
advanced requirements dictate.</p>
<div class="section" title="velocity.properties"><div class="titlepage"><div><div><h4 class="title"><a name="view-velocity-example-velocityproperties"></a>velocity.properties</h4></div></div></div>

<p>This file is completely optional, but if specified, contains the values that are passed
to the Velocity runtime in order to configure velocity itself. Only required for
advanced configurations, if you need this file, specify its location on the
<code class="literal">VelocityConfigurer</code> bean definition above.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"velocityConfig"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.velocity.VelocityConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"configLocation"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/velocity.properties"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Alternatively, you can specify velocity properties directly in the bean definition for
the Velocity config bean by replacing the "configLocation" property with the following
inline properties.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"velocityConfig"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.velocity.VelocityConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"velocityProperties"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"resource.loader"</span><span class="hl-tag">&gt;</span>file<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"file.resource.loader.class"</span><span class="hl-tag">&gt;</span>
                org.apache.velocity.runtime.resource.loader.FileResourceLoader
            <span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"file.resource.loader.path"</span><span class="hl-tag">&gt;</span>${webapp.root}/WEB-INF/velocity<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"file.resource.loader.cache"</span><span class="hl-tag">&gt;</span>false<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Refer to the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/ui/velocity/VelocityEngineFactory.html" target="_top">API
documentation</a> for Spring configuration of Velocity, or the Velocity documentation for
examples and definitions of the <code class="literal">'velocity.properties'</code> file itself.</p>
</div>
<div class="section" title="FreeMarker"><div class="titlepage"><div><div><h4 class="title"><a name="views-freemarker"></a>FreeMarker</h4></div></div></div>

<p>FreeMarker <span class="emphasis"><em>Settings</em></span> and <span class="emphasis"><em>SharedVariables</em></span> can be passed directly to the FreeMarker
<code class="literal">Configuration</code> object managed by Spring by setting the appropriate bean properties on
the <code class="literal">FreeMarkerConfigurer</code> bean. The <code class="literal">freemarkerSettings</code> property requires a
<code class="literal">java.util.Properties</code> object and the <code class="literal">freemarkerVariables</code> property requires a
<code class="literal">java.util.Map</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"freemarkerConfig"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"templateLoaderPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/freemarker/"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"freemarkerVariables"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"xml_escape"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"fmXmlEscape"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fmXmlEscape"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"freemarker.template.utility.XmlEscape"</span><span class="hl-tag">/&gt;</span></pre>

<p>See the FreeMarker documentation for details of settings and variables as they apply to
the <code class="literal">Configuration</code> object.</p>
</div>
</div>
<div class="section" title="17.4.5&nbsp;Bind support and form handling"><div class="titlepage"><div><div><h3 class="title"><a name="view-velocity-forms"></a>17.4.5&nbsp;Bind support and form handling</h3></div></div></div>

<p>Spring provides a tag library for use in JSP&#8217;s that contains (amongst other things) a
<code class="literal">&lt;spring:bind/&gt;</code> tag. This tag primarily enables forms to display values from form
backing objects and to show the results of failed validations from a <code class="literal">Validator</code> in the
web or business tier. From version 1.1, Spring now has support for the same
functionality in both Velocity and FreeMarker, with additional convenience macros for
generating form input elements themselves.</p>
<div class="section" title="The bind macros"><div class="titlepage"><div><div><h4 class="title"><a name="view-bind-macros"></a>The bind macros</h4></div></div></div>

<p>A standard set of macros are maintained within the <code class="literal">spring-webmvc.jar</code> file for both
languages, so they are always available to a suitably configured application.</p>
<p>Some of the macros defined in the Spring libraries are considered internal (private) but
no such scoping exists in the macro definitions making all macros visible to calling
code and user templates. The following sections concentrate only on the macros you need
to be directly calling from within your templates. If you wish to view the macro code
directly, the files are called spring.vm / spring.ftl and are in the packages
<code class="literal">org.springframework.web.servlet.view.velocity</code> or
<code class="literal">org.springframework.web.servlet.view.freemarker</code> respectively.</p>
</div>
<div class="section" title="Simple binding"><div class="titlepage"><div><div><h4 class="title"><a name="view-simple-binding"></a>Simple binding</h4></div></div></div>

<p>In your html forms (vm / ftl templates) that act as the <span class="emphasis"><em>formView</em></span> for a Spring form
controller, you can use code similar to the following to bind to field values and
display error messages for each input field in similar fashion to the JSP equivalent.
Note that the name of the command object is "command" by default, but can be overridden
in your MVC configuration by setting the <span class="emphasis"><em>commandName</em></span> bean property on your form
controller. Example code is shown below for the <code class="literal">personFormV</code> and <code class="literal">personFormF</code> views
configured earlier;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- velocity macros are automatically available --&gt;</span>
<span class="hl-tag">&lt;html&gt;</span>
    ...
    <span class="hl-tag">&lt;form</span> <span class="hl-attribute">action</span>=<span class="hl-value">""</span> <span class="hl-attribute">method</span>=<span class="hl-value">"POST"</span><span class="hl-tag">&gt;</span>
        Name:
        #springBind( "command.name" )
        <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span>
            <span class="hl-attribute">name</span>=<span class="hl-value">"${status.expression}"</span>
            <span class="hl-attribute">value</span>=<span class="hl-value">"$!status.value"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;br&gt;</span>
        #foreach($error in $status.errorMessages) <span class="hl-tag">&lt;b&gt;</span>$error<span class="hl-tag">&lt;/b&gt;</span> <span class="hl-tag">&lt;br&gt;</span> #end
        <span class="hl-tag">&lt;br&gt;</span>
        ...
        <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"submit"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/form&gt;</span>
    ...
<span class="hl-tag">&lt;/html&gt;</span></pre>

<pre class="programlisting"><span class="hl-comment">&lt;!-- freemarker macros have to be imported into a namespace. We strongly
recommend sticking to </span><span class="emphasis"><em>spring</em></span> --&gt;
<span class="hl-tag">&lt;#import</span> <span class="hl-attribute">"/spring.ftl"</span> <span class="hl-attribute">as</span> <span class="hl-attribute">spring</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;html&gt;</span>
    ...
    <span class="hl-tag">&lt;form</span> <span class="hl-attribute">action</span>=<span class="hl-value">""</span> <span class="hl-attribute">method</span>=<span class="hl-value">"POST"</span><span class="hl-tag">&gt;</span>
        Name:
        <span class="hl-tag">&lt;@spring.bind</span> <span class="hl-attribute">"command.name"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span>
            <span class="hl-attribute">name</span>=<span class="hl-value">"${spring.status.expression}"</span>
            <span class="hl-attribute">value</span>=<span class="hl-value">"${spring.status.value?default("</span><span class="hl-attribute">")}"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;br&gt;</span>
        <span class="hl-tag">&lt;#list</span> <span class="hl-attribute">spring.status.errorMessages</span> <span class="hl-attribute">as</span> <span class="hl-attribute">error&gt;</span> <span class="hl-attribute">&lt;b&gt;${error}&lt;/b&gt;</span> <span class="hl-attribute">&lt;br&gt;</span> <span class="hl-attribute">&lt;/#list&gt;</span>
        <span class="hl-attribute">&lt;br&gt;</span>
        <span class="hl-attribute">...</span>
        <span class="hl-attribute">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"submit"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/form&gt;</span>
    ...
<span class="hl-tag">&lt;/html&gt;</span></pre>

<p><code class="literal">#springBind</code> / <code class="literal">&lt;@spring.bind&gt;</code> requires a <span class="emphasis"><em>path</em></span> argument which consists of the name
of your command object (it will be <span class="emphasis"><em>command</em></span> unless you changed it in your
FormController properties) followed by a period and the name of the field on the command
object you wish to bind to. Nested fields can be used too such as
"command.address.street". The <code class="literal">bind</code> macro assumes the default HTML escaping behavior
specified by the ServletContext parameter <code class="literal">defaultHtmlEscape</code> in web.xml</p>
<p>The optional form of the macro called <code class="literal">#springBindEscaped</code> / <code class="literal">&lt;@spring.bindEscaped&gt;</code>
takes a second argument and explicitly specifies whether HTML escaping should be used in
the status error messages or values. Set to true or false as required. Additional form
handling macros simplify the use of HTML escaping and these macros should be used
wherever possible. They are explained in the next section.</p>
</div>
<div class="section" title="Form input generation macros"><div class="titlepage"><div><div><h4 class="title"><a name="views-form-macros"></a>Form input generation macros</h4></div></div></div>

<p>Additional convenience macros for both languages simplify both binding and form
generation (including validation error display). It is never necessary to use these
macros to generate form input fields, and they can be mixed and matched with simple HTML
or calls direct to the spring bind macros highlighted previously.</p>
<p>The following table of available macros show the VTL and FTL definitions and the
parameter list that each takes.</p>
<div class="table"><a name="views-macros-defs-tbl"></a><p class="title"><b>Table&nbsp;17.1.&nbsp;Table of macro definitions</b></p><div class="table-contents">

  <table summary="Table of macro definitions" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">macro</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">VTL definition</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">FTL definition</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>message</strong></span> (output a string from a resource bundle based on the code parameter)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springMessage($code)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.message code/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>messageText</strong></span> (output a string from a resource bundle based on the code parameter,
  falling back to the value of the default parameter)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springMessageText($code $text)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.messageText code, text/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>url</strong></span> (prefix a relative URL with the application&#8217;s context root)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springUrl($relativeUrl)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.url relativeUrl/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formInput</strong></span> (standard input field for gathering user input)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormInput($path $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formInput path, attributes, fieldType/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formHiddenInput </strong></span>* (hidden input field for submitting non-user input)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormHiddenInput($path $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formHiddenInput path, attributes/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formPasswordInput</strong></span> * (standard input field for gathering passwords. Note that no
  value will ever be populated in fields of this type)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormPasswordInput($path $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formPasswordInput path, attributes/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formTextarea</strong></span> (large text field for gathering long, freeform text input)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormTextarea($path $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formTextarea path, attributes/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formSingleSelect</strong></span> (drop down box of options allowing a single required value to be
  selected)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormSingleSelect( $path $options $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formSingleSelect path, options, attributes/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formMultiSelect</strong></span> (a list box of options allowing the user to select 0 or more values)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormMultiSelect($path $options $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formMultiSelect path, options, attributes/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formRadioButtons</strong></span> (a set of radio buttons allowing a single selection to be made
  from the available choices)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormRadioButtons($path $options $separator $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formRadioButtons path, options separator, attributes/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formCheckboxes</strong></span> (a set of checkboxes allowing 0 or more values to be selected)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormCheckboxes($path $options $separator $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formCheckboxes path, options, separator, attributes/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>formCheckbox</strong></span> (a single checkbox)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>#springFormCheckbox($path $attributes)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;@spring.formCheckbox path, attributes/&gt;</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>showErrors</strong></span> (simplify display of validation errors for the bound field)</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>#springShowErrors($separator $classOrStyle)</p></td><td style="" align="left" valign="top"><p>&lt;@spring.showErrors separator, classOrStyle/&gt;</p></td></tr></tbody></table>
</div></div><br class="table-break">

<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
In FTL (FreeMarker), these two macros are not actually required as you can use the
normal <code class="literal">formInput</code> macro, specifying ' <code class="literal">hidden</code>' or ' <code class="literal">password</code>' as the value for the
<code class="literal">fieldType</code> parameter.
</li></ul></div>

<p>The parameters to any of the above macros have consistent meanings:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
path: the name of the field to bind to (ie "command.name")
</li><li class="listitem">
options: a Map of all the available values that can be selected from in the input
field. The keys to the map represent the values that will be POSTed back from the form
and bound to the command object. Map objects stored against the keys are the labels
displayed on the form to the user and may be different from the corresponding values
posted back by the form. Usually such a map is supplied as reference data by the
controller. Any Map implementation can be used depending on required behavior. For
strictly sorted maps, a <code class="literal">SortedMap</code> such as a <code class="literal">TreeMap</code> with a suitable Comparator may
be used and for arbitrary Maps that should return values in insertion order, use a
<code class="literal">LinkedHashMap</code> or a <code class="literal">LinkedMap</code> from commons-collections.
</li><li class="listitem">
separator: where multiple options are available as discreet elements (radio buttons or
checkboxes), the sequence of characters used to separate each one in the list (ie
"&lt;br&gt;").
</li><li class="listitem">
attributes: an additional string of arbitrary tags or text to be included within the
HTML tag itself. This string is echoed literally by the macro. For example, in a
textarea field you may supply attributes as <span class="emphasis"><em>rows="5" cols="60"</em></span> or you could pass
style information such as <span class="emphasis"><em>style="border:1px solid silver"</em></span>.
</li><li class="listitem">
classOrStyle: for the showErrors macro, the name of the CSS class that the span tag
wrapping each error will use. If no information is supplied (or the value is empty)
then the errors will be wrapped in &lt;b&gt;&lt;/b&gt; tags.
</li></ul></div>

<p>Examples of the macros are outlined below some in FTL and some in VTL. Where usage
differences exist between the two languages, they are explained in the notes.</p>
<div class="section" title="Input Fields"><div class="titlepage"><div><div><h5 class="title"><a name="views-form-macros-input"></a>Input Fields</h5></div></div></div>

<pre class="programlisting"><span class="hl-comment">&lt;!-- the Name field example from above using form macros in VTL --&gt;</span>
...
Name:
#springFormInput("command.name" "")<span class="hl-tag">&lt;br&gt;</span>
#springShowErrors("<span class="hl-tag">&lt;br&gt;</span>" "")<span class="hl-tag">&lt;br&gt;</span></pre>

<p>The formInput macro takes the path parameter (command.name) and an additional attributes
parameter which is empty in the example above. The macro, along with all other form
generation macros, performs an implicit spring bind on the path parameter. The binding
remains valid until a new bind occurs so the showErrors macro doesn&#8217;t need to pass the
path parameter again - it simply operates on whichever field a bind was last created for.</p>
<p>The showErrors macro takes a separator parameter (the characters that will be used to
separate multiple errors on a given field) and also accepts a second parameter, this
time a class name or style attribute. Note that FreeMarker is able to specify default
values for the attributes parameter, unlike Velocity, and the two macro calls above
could be expressed as follows in FTL:</p>
<pre class="programlisting"><span class="hl-tag">&lt;@spring.formInput</span> <span class="hl-attribute">"command.name"/&gt;</span>
<span class="hl-attribute">&lt;@spring.showErrors</span> <span class="hl-attribute">"&lt;br&gt;"/&gt;</span></pre>

<p>Output is shown below of the form fragment generating the name field, and displaying a
validation error after the form was submitted with no value in the field. Validation
occurs through Spring&#8217;s Validation framework.</p>
<p>The generated HTML looks like this:</p>
<pre class="programlisting">Name:
&lt;input type="text" name="name" value=""&gt;
&lt;br&gt;
    &lt;b&gt;required&lt;/b&gt;
&lt;br&gt;
&lt;br&gt;</pre>

<p>The formTextarea macro works the same way as the formInput macro and accepts the same
parameter list. Commonly, the second parameter (attributes) will be used to pass style
information or rows and cols attributes for the textarea.</p>
</div>
<div class="section" title="Selection Fields"><div class="titlepage"><div><div><h5 class="title"><a name="views-form-macros-select"></a>Selection Fields</h5></div></div></div>

<p>Four selection field macros can be used to generate common UI value selection inputs in
your HTML forms.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
formSingleSelect
</li><li class="listitem">
formMultiSelect
</li><li class="listitem">
formRadioButtons
</li><li class="listitem">
formCheckboxes
</li></ul></div>

<p>Each of the four macros accepts a Map of options containing the value for the form
field, and the label corresponding to that value. The value and the label can be the
same.</p>
<p>An example of radio buttons in FTL is below. The form backing object specifies a default
value of <span class="emphasis"><em>London</em></span> for this field and so no validation is necessary. When the form is
rendered, the entire list of cities to choose from is supplied as reference data in the
model under the name <span class="emphasis"><em>cityMap</em></span>.</p>
<pre class="programlisting">...
Town:
&lt;@spring.formRadioButtons "command.address.town", cityMap, "" /&gt;&lt;br&gt;&lt;br&gt;</pre>

<p>This renders a line of radio buttons, one for each value in <code class="literal">cityMap</code> using the
separator "". No additional attributes are supplied (the last parameter to the macro is
missing). The cityMap uses the same String for each key-value pair in the map. The map&#8217;s
keys are what the form actually submits as POSTed request parameters, map values are the
labels that the user sees. In the example above, given a list of three well known cities
and a default value in the form backing object, the HTML would be</p>
<pre class="programlisting">Town:
&lt;input type="radio" name="address.town" value="London"&gt;London&lt;/input&gt;
&lt;input type="radio" name="address.town" value="Paris" checked="checked"&gt;Paris&lt;/input&gt;
&lt;input type="radio" name="address.town" value="New York"&gt;New York&lt;/input&gt;</pre>

<p>If your application expects to handle cities by internal codes for example, the map of
codes would be created with suitable keys like the example below.</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> Map referenceData(HttpServletRequest request) <span class="hl-keyword">throws</span> Exception {
    Map cityMap = <span class="hl-keyword">new</span> LinkedHashMap();
    cityMap.put(<span class="hl-string">"LDN"</span>, <span class="hl-string">"London"</span>);
    cityMap.put(<span class="hl-string">"PRS"</span>, <span class="hl-string">"Paris"</span>);
    cityMap.put(<span class="hl-string">"NYC"</span>, <span class="hl-string">"New York"</span>);

    Map m = <span class="hl-keyword">new</span> HashMap();
    m.put(<span class="hl-string">"cityMap"</span>, cityMap);
    <span class="hl-keyword">return</span> m;
}</pre>

<p>The code would now produce output where the radio values are the relevant codes but the
user still sees the more user friendly city names.</p>
<pre class="programlisting">Town:
&lt;input type="radio" name="address.town" value="LDN"&gt;London&lt;/input&gt;
&lt;input type="radio" name="address.town" value="PRS" checked="checked"&gt;Paris&lt;/input&gt;
&lt;input type="radio" name="address.town" value="NYC"&gt;New York&lt;/input&gt;</pre>

</div>
</div>
<div class="section" title="HTML escaping and XHTML compliance"><div class="titlepage"><div><div><h4 class="title"><a name="views-form-macros-html-escaping"></a>HTML escaping and XHTML compliance</h4></div></div></div>

<p>Default usage of the form macros above will result in HTML tags that are HTML 4.01
compliant and that use the default value for HTML escaping defined in your web.xml as
used by Spring&#8217;s bind support. In order to make the tags XHTML compliant or to override
the default HTML escaping value, you can specify two variables in your template (or in
your model where they will be visible to your templates). The advantage of specifying
them in the templates is that they can be changed to different values later in the
template processing to provide different behavior for different fields in your form.</p>
<p>To switch to XHTML compliance for your tags, specify a value of <span class="emphasis"><em>true</em></span> for a
model/context variable named xhtmlCompliant:</p>
<pre class="programlisting"># for Velocity..
#set($springXhtmlCompliant = true)

&lt;-- for FreeMarker --&gt;
&lt;#assign xhtmlCompliant = true in spring&gt;</pre>

<p>Any tags generated by the Spring macros will now be XHTML compliant after processing
this directive.</p>
<p>In similar fashion, HTML escaping can be specified per field:</p>
<pre class="programlisting"><span class="hl-tag">&lt;#--</span> <span class="hl-attribute">until</span> <span class="hl-attribute">this</span> <span class="hl-attribute">point,</span> <span class="hl-attribute">default</span> <span class="hl-attribute">HTML</span> <span class="hl-attribute">escaping</span> <span class="hl-attribute">is</span> <span class="hl-attribute">used</span> <span class="hl-attribute">--&gt;</span>

<span class="hl-attribute">&lt;#assign</span> <span class="hl-attribute">htmlEscape</span> = <span class="hl-value">true</span> <span class="hl-attribute">in</span> <span class="hl-attribute">spring&gt;</span>
<span class="hl-attribute">&lt;#--</span> <span class="hl-attribute">next</span> <span class="hl-attribute">field</span> <span class="hl-attribute">will</span> <span class="hl-attribute">use</span> <span class="hl-attribute">HTML</span> <span class="hl-attribute">escaping</span> <span class="hl-attribute">--&gt;</span>
<span class="hl-attribute">&lt;@spring.formInput</span> <span class="hl-attribute">"command.name"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;#assign</span> <span class="hl-attribute">htmlEscape</span> = <span class="hl-value">false</span> <span class="hl-attribute">in</span> <span class="hl-attribute">spring&gt;</span>
<span class="hl-attribute">&lt;#--</span> <span class="hl-attribute">all</span> <span class="hl-attribute">future</span> <span class="hl-attribute">fields</span> <span class="hl-attribute">will</span> <span class="hl-attribute">be</span> <span class="hl-attribute">bound</span> <span class="hl-attribute">with</span> <span class="hl-attribute">HTML</span> <span class="hl-attribute">escaping</span> <span class="hl-attribute">off</span> <span class="hl-attribute">--&gt;</span></pre>

</div>
</div>
</div>
<div class="section" title="17.5&nbsp;XSLT"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-xslt"></a>17.5&nbsp;XSLT</h2></div></div></div>

<p>XSLT is a transformation language for XML and is popular as a view technology within web
applications. XSLT can be a good choice as a view technology if your application
naturally deals with XML, or if your model can easily be converted to XML. The following
section shows how to produce an XML document as model data and have it transformed with
XSLT in a Spring Web MVC application.</p>
<div class="section" title="17.5.1&nbsp;My First Words"><div class="titlepage"><div><div><h3 class="title"><a name="view-xslt-firstwords"></a>17.5.1&nbsp;My First Words</h3></div></div></div>

<p>This example is a trivial Spring application that creates a list of words in the
<code class="literal">Controller</code> and adds them to the model map. The map is returned along with the view
name of our XSLT view. See <a class="xref" href="#mvc-controller" title="16.3&nbsp;Implementing Controllers">Section&nbsp;16.3, &#8220;Implementing Controllers&#8221;</a> for details of Spring Web MVC&#8217;s
<code class="literal">Controller</code> interface. The XSLT view will turn the list of words into a simple XML
document ready for transformation.</p>
<div class="section" title="Bean definitions"><div class="titlepage"><div><div><h4 class="title"><a name="view-xslt-beandefs"></a>Bean definitions</h4></div></div></div>

<p>Configuration is standard for a simple Spring application. The dispatcher servlet config
file contains a reference to a <code class="literal">ViewResolver</code>, URL mappings and a single controller
bean&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"homeController"</span><span class="hl-attribute">class</span>=<span class="hl-value">"xslt.HomeController"</span><span class="hl-tag">/&gt;</span></pre>

<div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem">
that encapsulates our word generation logic.
</li></ol></div>

</div>
<div class="section" title="Standard MVC controller code"><div class="titlepage"><div><div><h4 class="title"><a name="view-xslt-controllercode"></a>Standard MVC controller code</h4></div></div></div>

<p>The controller logic is encapsulated in a subclass of <code class="literal">AbstractController</code>, with the
handler method being defined like so&#8230;</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> ModelAndView handleRequestInternal(HttpServletRequest request,
        HttpServletResponse response) <span class="hl-keyword">throws</span> Exception {

    Map map = <span class="hl-keyword">new</span> HashMap();
    List wordList = <span class="hl-keyword">new</span> ArrayList();

    wordList.add(<span class="hl-string">"hello"</span>);
    wordList.add(<span class="hl-string">"world"</span>);

    map.put(<span class="hl-string">"wordList"</span>, wordList);

    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ModelAndView(<span class="hl-string">"home"</span>, map);
}</pre>

<p>So far we&#8217;ve done nothing that&#8217;s XSLT specific. The model data has been created in the
same way as you would for any other Spring MVC application. Depending on the
configuration of the application now, that list of words could be rendered by JSP/JSTL
by having them added as request attributes, or they could be handled by Velocity by
adding the object to the <code class="literal">VelocityContext</code>. In order to have XSLT render them, they of
course have to be converted into an XML document somehow. There are software packages
available that will automatically <span class="emphasis"><em>domify</em></span> an object graph, but within Spring, you have
complete flexibility to create the DOM from your model in any way you choose. This
prevents the transformation of XML playing too great a part in the structure of your
model data which is a danger when using tools to manage the domification process.</p>
</div>
<div class="section" title="Convert the model data to XML"><div class="titlepage"><div><div><h4 class="title"><a name="view-xslt-subclassing"></a>Convert the model data to XML</h4></div></div></div>

<p>In order to create a DOM document from our list of words or any other model data, we
must subclass the (provided)
<code class="literal">org.springframework.web.servlet.view.xslt.AbstractXsltView</code> class. In doing so, we must
also typically implement the abstract method <code class="literal">createXsltSource(..)</code> method. The first
parameter passed to this method is our model map. Here&#8217;s the complete listing of the
<code class="literal">HomePage</code> class in our trivial word application:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> xslt;

<span class="hl-comment">// imports omitted for brevity</span>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HomePage <span class="hl-keyword">extends</span> AbstractXsltView {

    <span class="hl-keyword">protected</span> Source createXsltSource(Map model, String rootName,
            HttpServletRequest request, HttpServletResponse response) <span class="hl-keyword">throws</span> Exception {

        Document document = DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();
        Element root = document.createElement(rootName);

        List words = (List) model.get(<span class="hl-string">"wordList"</span>);
        <span class="hl-keyword">for</span> (Iterator it = words.iterator(); it.hasNext();) {
            String nextWord = (String) it.next();
            Element wordNode = document.createElement(<span class="hl-string">"word"</span>);
            Text textNode = document.createTextNode(nextWord);
            wordNode.appendChild(textNode);
            root.appendChild(wordNode);
        }
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DOMSource(root);
    }

}</pre>

<p>A series of parameter name/value pairs can optionally be defined by your subclass which
will be added to the transformation object. The parameter names must match those defined
in your XSLT template declared with <code class="literal">&lt;xsl:param
name="myParam"&gt;defaultValue&lt;/xsl:param&gt;</code>. To specify the parameters, override the
<code class="literal">getParameters()</code> method of the <code class="literal">AbstractXsltView</code> class and return a <code class="literal">Map</code> of the
name/value pairs. If your parameters need to derive information from the current
request, you can override the <code class="literal">getParameters(HttpServletRequest request)</code> method instead.</p>
</div>
<div class="section" title="Defining the view properties"><div class="titlepage"><div><div><h4 class="title"><a name="view-xslt-viewdefinitions"></a>Defining the view properties</h4></div></div></div>

<p>The views.properties file (or equivalent xml definition if you&#8217;re using an XML based
view resolver as we did in the Velocity examples above) looks like this for the one-view
application that is <span class="emphasis"><em>My First Words</em></span>:</p>

<pre class="literallayout">home.(class)=xslt.HomePage
home.stylesheetLocation=/WEB-INF/xsl/home.xslt
home.root=words</pre>

<p>Here, you can see how the view is tied in with the <code class="literal">HomePage</code> class just written which
handles the model domification in the first property <code class="literal">'.(class)'</code>. The
<code class="literal">'stylesheetLocation'</code> property points to the XSLT file which will handle the XML
transformation into HTML for us and the final property <code class="literal">'.root'</code> is the name that will
be used as the root of the XML document. This gets passed to the <code class="literal">HomePage</code> class above
in the second parameter to the <code class="literal">createXsltSource(..)</code> method(s).</p>
</div>
<div class="section" title="Document transformation"><div class="titlepage"><div><div><h4 class="title"><a name="view-xslt-transforming"></a>Document transformation</h4></div></div></div>

<p>Finally, we have the XSLT code used for transforming the above document. As shown in the
above <code class="literal">'views.properties'</code> file, the stylesheet is called <code class="literal">'home.xslt'</code> and it lives in
the war file in the <code class="literal">'WEB-INF/xsl'</code> directory.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="hl-tag">&lt;xsl:stylesheet</span> <span class="hl-attribute">version</span>=<span class="hl-value">"1.0"</span> <span class="hl-attribute">xmlns:xsl</span>=<span class="hl-value">"http://www.w3.org/1999/XSL/Transform"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;xsl:output</span> <span class="hl-attribute">method</span>=<span class="hl-value">"html"</span> <span class="hl-attribute">omit-xml-declaration</span>=<span class="hl-value">"yes"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;xsl:template</span> <span class="hl-attribute">match</span>=<span class="hl-value">"/"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;html&gt;</span>
            <span class="hl-tag">&lt;head&gt;</span><span class="hl-tag">&lt;title&gt;</span>Hello!<span class="hl-tag">&lt;/title&gt;</span><span class="hl-tag">&lt;/head&gt;</span>
            <span class="hl-tag">&lt;body&gt;</span>
                <span class="hl-tag">&lt;h1&gt;</span>My First Words<span class="hl-tag">&lt;/h1&gt;</span>
                <span class="hl-tag">&lt;xsl:apply-templates/&gt;</span>
            <span class="hl-tag">&lt;/body&gt;</span>
        <span class="hl-tag">&lt;/html&gt;</span>
    <span class="hl-tag">&lt;/xsl:template&gt;</span>

    <span class="hl-tag">&lt;xsl:template</span> <span class="hl-attribute">match</span>=<span class="hl-value">"word"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;xsl:value-of</span> <span class="hl-attribute">select</span>=<span class="hl-value">"."</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
    <span class="hl-tag">&lt;/xsl:template&gt;</span>

<span class="hl-tag">&lt;/xsl:stylesheet&gt;</span></pre>

</div>
</div>
<div class="section" title="17.5.2&nbsp;Summary"><div class="titlepage"><div><div><h3 class="title"><a name="view-xslt-summary"></a>17.5.2&nbsp;Summary</h3></div></div></div>

<p>A summary of the files discussed and their location in the WAR file is shown in the
simplified WAR structure below.</p>

<pre class="literallayout">ProjectRoot
  |
  +- WebContent
      |
      +- WEB-INF
          |
          +- classes
          |    |
          |    +- xslt
          |    |   |
          |    |   +- HomePageController.class
          |    |   +- HomePage.class
          |    |
          |    +- views.properties
          |
          +- lib
          |   |
          |   +- spring-*.jar
          |
          +- xsl
          |   |
          |   +- home.xslt
          |
          +- frontcontroller-servlet.xml</pre>

<p>You will also need to ensure that an XML parser and an XSLT engine are available on the
classpath. JDK 1.4 provides them by default, and most Java EE containers will also make
them available by default, but it&#8217;s a possible source of errors to be aware of.</p>
</div>
</div>
<div class="section" title="17.6&nbsp;Document views (PDF/Excel)"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-document"></a>17.6&nbsp;Document views (PDF/Excel)</h2></div></div></div>

<div class="section" title="17.6.1&nbsp;Introduction"><div class="titlepage"><div><div><h3 class="title"><a name="view-document-intro"></a>17.6.1&nbsp;Introduction</h3></div></div></div>

<p>Returning an HTML page isn&#8217;t always the best way for the user to view the model output,
and Spring makes it simple to generate a PDF document or an Excel spreadsheet
dynamically from the model data. The document is the view and will be streamed from the
server with the correct content type to (hopefully) enable the client PC to run their
spreadsheet or PDF viewer application in response.</p>
<p>In order to use Excel views, you need to add the <span class="emphasis"><em>poi</em></span> library to your classpath, and
for PDF generation, the iText library.</p>
</div>
<div class="section" title="17.6.2&nbsp;Configuration and setup"><div class="titlepage"><div><div><h3 class="title"><a name="view-document-config"></a>17.6.2&nbsp;Configuration and setup</h3></div></div></div>

<p>Document based views are handled in an almost identical fashion to XSLT views, and the
following sections build upon the previous one by demonstrating how the same controller
used in the XSLT example is invoked to render the same model as both a PDF document and
an Excel spreadsheet (which can also be viewed or manipulated in Open Office).</p>
<div class="section" title="Document view definitions"><div class="titlepage"><div><div><h4 class="title"><a name="view-document-configviews"></a>Document view definitions</h4></div></div></div>

<p>First, let&#8217;s amend the views.properties file (or xml equivalent) and add a simple view
definition for both document types. The entire file now looks like this with the XSLT
view shown from earlier:</p>

<pre class="literallayout">home.(class)=xslt.HomePage
home.stylesheetLocation=/WEB-INF/xsl/home.xslt
home.root=words

xl.(class)=excel.HomePage

pdf.(class)=pdf.HomePage</pre>

<p><span class="emphasis"><em>If you want to start with a template spreadsheet or a fillable PDF form to add your
model data to, specify the location as the <span class="emphasis"><em>url</em></span> property in the view definition</em></span></p>
</div>
<div class="section" title="Controller code"><div class="titlepage"><div><div><h4 class="title"><a name="view-document-configcontroller"></a>Controller code</h4></div></div></div>

<p>The controller code we&#8217;ll use remains exactly the same from the XSLT example earlier
other than to change the name of the view to use. Of course, you could be clever and
have this selected based on a URL parameter or some other logic - proof that Spring
really is very good at decoupling the views from the controllers!</p>
</div>
<div class="section" title="Subclassing for Excel views"><div class="titlepage"><div><div><h4 class="title"><a name="view-document-configsubclasses"></a>Subclassing for Excel views</h4></div></div></div>

<p>Exactly as we did for the XSLT example, we&#8217;ll subclass suitable abstract classes in
order to implement custom behavior in generating our output documents. For Excel, this
involves writing a subclass of
<code class="literal">org.springframework.web.servlet.view.document.AbstractExcelView</code> (for Excel files
generated by POI) or <code class="literal">org.springframework.web.servlet.view.document.AbstractJExcelView</code>
(for JExcelApi-generated Excel files) and implementing the <code class="literal">buildExcelDocument()</code> method.</p>
<p>Here&#8217;s the complete listing for our POI Excel view which displays the word list from the
model map in consecutive rows of the first column of a new spreadsheet:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> excel;

<span class="hl-comment">// imports omitted for brevity</span>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HomePage <span class="hl-keyword">extends</span> AbstractExcelView {

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> buildExcelDocument(Map model, HSSFWorkbook wb, HttpServletRequest req,
            HttpServletResponse resp) <span class="hl-keyword">throws</span> Exception {

        HSSFSheet sheet;
        HSSFRow sheetRow;
        HSSFCell cell;

        <span class="hl-comment">// Go to the first sheet</span>
        <span class="hl-comment">// getSheetAt: only if wb is created from an existing document</span>
        <span class="hl-comment">// sheet = wb.getSheetAt(0);</span>
        sheet = wb.createSheet(<span class="hl-string">"Spring"</span>);
        sheet.setDefaultColumnWidth((<span class="hl-keyword">short</span>) <span class="hl-number">12</span>);

        <span class="hl-comment">// write a text at A1</span>
        cell = getCell(sheet, <span class="hl-number">0</span>, <span class="hl-number">0</span>);
        setText(cell, <span class="hl-string">"Spring-Excel test"</span>);

        List words = (List) model.get(<span class="hl-string">"wordList"</span>);
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i=<span class="hl-number">0</span>; i &lt; words.size(); i++) {
            cell = getCell(sheet, <span class="hl-number">2</span>+i, <span class="hl-number">0</span>);
            setText(cell, (String) words.get(i));
        }
    }

}</pre>

<p>And the following is a view generating the same Excel file, now using JExcelApi:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> excel;

<span class="hl-comment">// imports omitted for brevity</span>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HomePage <span class="hl-keyword">extends</span> AbstractJExcelView {

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> buildExcelDocument(Map model, WritableWorkbook wb,
            HttpServletRequest request, HttpServletResponse response) <span class="hl-keyword">throws</span> Exception {

        WritableSheet sheet = wb.createSheet(<span class="hl-string">"Spring"</span>, <span class="hl-number">0</span>);

        sheet.addCell(<span class="hl-keyword">new</span> Label(<span class="hl-number">0</span>, <span class="hl-number">0</span>, <span class="hl-string">"Spring-Excel test"</span>));

        List words = (List) model.get(<span class="hl-string">"wordList"</span>);
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i = <span class="hl-number">0</span>; i &lt; words.size(); i++) {
            sheet.addCell(<span class="hl-keyword">new</span> Label(<span class="hl-number">2</span>+i, <span class="hl-number">0</span>, (String) words.get(i)));
        }
    }
}</pre>

<p>Note the differences between the APIs. We&#8217;ve found that the JExcelApi is somewhat more
intuitive, and furthermore, JExcelApi has slightly better image-handling capabilities.
There have been memory problems with large Excel files when using JExcelApi however.</p>
<p>If you now amend the controller such that it returns <code class="literal">xl</code> as the name of the view (
<code class="literal">return new ModelAndView("xl", map);</code>) and run your application again, you should find
that the Excel spreadsheet is created and downloaded automatically when you request the
same page as before.</p>
</div>
<div class="section" title="Subclassing for PDF views"><div class="titlepage"><div><div><h4 class="title"><a name="view-document-configsubclasspdf"></a>Subclassing for PDF views</h4></div></div></div>

<p>The PDF version of the word list is even simpler. This time, the class extends
<code class="literal">org.springframework.web.servlet.view.document.AbstractPdfView</code> and implements the
<code class="literal">buildPdfDocument()</code> method as follows:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> pdf;

<span class="hl-comment">// imports omitted for brevity</span>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PDFPage <span class="hl-keyword">extends</span> AbstractPdfView {

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> buildPdfDocument(Map model, Document doc, PdfWriter writer,
        HttpServletRequest req, HttpServletResponse resp) <span class="hl-keyword">throws</span> Exception {
        List words = (List) model.get(<span class="hl-string">"wordList"</span>);
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i=<span class="hl-number">0</span>; i&lt;words.size(); i++) {
            doc.add( <span class="hl-keyword">new</span> Paragraph((String) words.get(i)));
        }
    }

}</pre>

<p>Once again, amend the controller to return the <code class="literal">pdf</code> view with <code class="literal">return new
ModelAndView("pdf", map);</code>, and reload the URL in your application. This time a PDF
document should appear listing each of the words in the model map.</p>
</div>
</div>
</div>
<div class="section" title="17.7&nbsp;JasperReports"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-jasper-reports"></a>17.7&nbsp;JasperReports</h2></div></div></div>

<p>JasperReports ( <a class="ulink" href="http://jasperreports.sourceforge.net" target="_top">http://jasperreports.sourceforge.net</a>) is a powerful open-source
reporting engine that supports the creation of report designs using an easily understood
XML file format. JasperReports is capable of rendering reports in four different
formats: CSV, Excel, HTML and PDF.</p>
<div class="section" title="17.7.1&nbsp;Dependencies"><div class="titlepage"><div><div><h3 class="title"><a name="view-jasper-reports-dependencies"></a>17.7.1&nbsp;Dependencies</h3></div></div></div>

<p>Your application will need to include the latest release of JasperReports, which at the
time of writing was 0.6.1. JasperReports itself depends on the following projects:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
BeanShell
</li><li class="listitem">
Commons BeanUtils
</li><li class="listitem">
Commons Collections
</li><li class="listitem">
Commons Digester
</li><li class="listitem">
Commons Logging
</li><li class="listitem">
iText
</li><li class="listitem">
POI
</li></ul></div>

<p>JasperReports also requires a JAXP compliant XML parser.</p>
</div>
<div class="section" title="17.7.2&nbsp;Configuration"><div class="titlepage"><div><div><h3 class="title"><a name="view-jasper-reports-configuration"></a>17.7.2&nbsp;Configuration</h3></div></div></div>

<p>To configure JasperReports views in your Spring container configuration you need to
define a <code class="literal">ViewResolver</code> to map view names to the appropriate view class depending on
which format you want your report rendered in.</p>
<div class="section" title="Configuring the ViewResolver"><div class="titlepage"><div><div><h4 class="title"><a name="view-jasper-reports-configuration-resolver"></a>Configuring the ViewResolver</h4></div></div></div>

<p>Typically, you will use the <code class="literal">ResourceBundleViewResolver</code> to map view names to view
classes and files in a properties file.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"viewResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.ResourceBundleViewResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"views"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Here we&#8217;ve configured an instance of the <code class="literal">ResourceBundleViewResolver</code> class that will
look for view mappings in the resource bundle with base name <code class="literal">views</code>. (The content of
this file is described in the next section.)</p>
</div>
<div class="section" title="Configuring the Views"><div class="titlepage"><div><div><h4 class="title"><a name="view-jasper-reports-configuration-views"></a>Configuring the Views</h4></div></div></div>

<p>The Spring Framework contains five different <code class="literal">View</code> implementations for JasperReports,
four of which correspond to one of the four output formats supported by JasperReports,
and one that allows for the format to be determined at runtime:</p>
<div class="table"><a name="view-jasper-reports-configuration-views-classes"></a><p class="title"><b>Table&nbsp;17.2.&nbsp;JasperReports View classes</b></p><div class="table-contents">

  <table summary="JasperReports View classes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Class Name</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Render Format</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JasperReportsCsvView</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CSV</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JasperReportsHtmlView</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JasperReportsPdfView</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PDF</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JasperReportsXlsView</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Microsoft Excel</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JasperReportsMultiFormatView</code></p></td><td style="" align="left" valign="top"><p>The view is <a class="link" href="#view-jasper-reports-configuration-multiformat-view" title="Using JasperReportsMultiFormatView">decided upon at
  runtime</a></p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>Mapping one of these classes to a view name and a report file is a matter of adding the
appropriate entries in the resource bundle configured in the previous section as shown
here:</p>

<pre class="literallayout">simpleReport.(class)=org.springframework.web.servlet.view.jasperreports.JasperReportsPdfView
simpleReport.url=/WEB-INF/reports/DataSourceReport.jasper</pre>

<p>Here you can see that the view with name <code class="literal">simpleReport</code> is mapped to the
<code class="literal">JasperReportsPdfView</code> class, causing the output of this report to be rendered in PDF
format. The <code class="literal">url</code> property of the view is set to the location of the underlying report
file.</p>
</div>
<div class="section" title="About Report Files"><div class="titlepage"><div><div><h4 class="title"><a name="view-jasper-reports-configuration-report-files"></a>About Report Files</h4></div></div></div>

<p>JasperReports has two distinct types of report file: the design file, which has a
<code class="literal">.jrxml</code> extension, and the compiled report file, which has a <code class="literal">.jasper</code> extension.
Typically, you use the JasperReports Ant task to compile your <code class="literal">.jrxml</code> design file into
a <code class="literal">.jasper</code> file before deploying it into your application. With the Spring Framework
you can map either of these files to your report file and the framework will take care
of compiling the <code class="literal">.jrxml</code> file on the fly for you. You should note that after a <code class="literal">.jrxml</code>
file is compiled by the Spring Framework, the compiled report is cached for the lifetime
of the application. Thus, to make changes to the file you will need to restart your
application.</p>
</div>
<div class="section" title="Using JasperReportsMultiFormatView"><div class="titlepage"><div><div><h4 class="title"><a name="view-jasper-reports-configuration-multiformat-view"></a>Using JasperReportsMultiFormatView</h4></div></div></div>

<p>The <code class="literal">JasperReportsMultiFormatView</code> allows for the report format to be specified at
runtime. The actual rendering of the report is delegated to one of the other
JasperReports view classes - the <code class="literal">JasperReportsMultiFormatView</code> class simply adds a
wrapper layer that allows for the exact implementation to be specified at runtime.</p>
<p>The <code class="literal">JasperReportsMultiFormatView</code> class introduces two concepts: the format key and the
discriminator key. The <code class="literal">JasperReportsMultiFormatView</code> class uses the mapping key to look
up the actual view implementation class, and it uses the format key to lookup up the
mapping key. From a coding perspective you add an entry to your model with the format
key as the key and the mapping key as the value, for example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> ModelAndView handleSimpleReportMulti(HttpServletRequest request,
HttpServletResponse response) <span class="hl-keyword">throws</span> Exception {

    String uri = request.getRequestURI();
    String format = uri.substring(uri.lastIndexOf(<span class="hl-string">"."</span>) + <span class="hl-number">1</span>);

    Map model = getModel();
    model.put(<span class="hl-string">"format"</span>, format);

    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ModelAndView(<span class="hl-string">"simpleReportMulti"</span>, model);

}</pre>

<p>In this example, the mapping key is determined from the extension of the request URI and
is added to the model under the default format key: <code class="literal">format</code>. If you wish to use a
different format key then you can configure this using the <code class="literal">formatKey</code> property of the
<code class="literal">JasperReportsMultiFormatView</code> class.</p>
<p>By default the following mapping key mappings are configured in
<code class="literal">JasperReportsMultiFormatView</code>:</p>
<div class="table"><a name="view-jasper-reports-configuration-multiformat-view-mappings"></a><p class="title"><b>Table&nbsp;17.3.&nbsp;JasperReportsMultiFormatView Default Mapping Key Mappings</b></p><div class="table-contents">

  <table summary="JasperReportsMultiFormatView Default Mapping Key Mappings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Mapping Key</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">View Class</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>csv</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JasperReportsCsvView</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>html</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JasperReportsHtmlView</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pdf</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JasperReportsPdfView</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>xls</p></td><td style="" align="left" valign="top"><p><code class="literal">JasperReportsXlsView</code></p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>So in the example above a request to URI /foo/myReport.pdf would be mapped to the
<code class="literal">JasperReportsPdfView</code> class. You can override the mapping key to view class mappings
using the <code class="literal">formatMappings</code> property of <code class="literal">JasperReportsMultiFormatView</code>.</p>
</div>
</div>
<div class="section" title="17.7.3&nbsp;Populating the ModelAndView"><div class="titlepage"><div><div><h3 class="title"><a name="view-jasper-reports-model"></a>17.7.3&nbsp;Populating the ModelAndView</h3></div></div></div>

<p>In order to render your report correctly in the format you have chosen, you must supply
Spring with all of the data needed to populate your report. For JasperReports this means
you must pass in all report parameters along with the report datasource. Report
parameters are simple name/value pairs and can be added to the <code class="literal">Map</code> for your model as
you would add any name/value pair.</p>
<p>When adding the datasource to the model you have two approaches to choose from. The
first approach is to add an instance of <code class="literal">JRDataSource</code> or a <code class="literal">Collection</code> type to the
model <code class="literal">Map</code> under any arbitrary key. Spring will then locate this object in the model
and treat it as the report datasource. For example, you may populate your model like so:</p>
<pre class="programlisting"><span class="hl-keyword">private</span> Map getModel() {
    Map model = <span class="hl-keyword">new</span> HashMap();
    Collection beanData = getBeanData();
    model.put(<span class="hl-string">"myBeanData"</span>, beanData);
    <span class="hl-keyword">return</span> model;
}</pre>

<p>The second approach is to add the instance of <code class="literal">JRDataSource</code> or <code class="literal">Collection</code> under a
specific key and then configure this key using the <code class="literal">reportDataKey</code> property of the view
class. In both cases Spring will wrap instances of <code class="literal">Collection</code> in a
<code class="literal">JRBeanCollectionDataSource</code> instance. For example:</p>
<pre class="programlisting"><span class="hl-keyword">private</span> Map getModel() {
    Map model = <span class="hl-keyword">new</span> HashMap();
    Collection beanData = getBeanData();
    Collection someData = getSomeData();
    model.put(<span class="hl-string">"myBeanData"</span>, beanData);
    model.put(<span class="hl-string">"someData"</span>, someData);
    <span class="hl-keyword">return</span> model;
}</pre>

<p>Here you can see that two <code class="literal">Collection</code> instances are being added to the model. To ensure
that the correct one is used, we simply modify our view configuration as appropriate:</p>

<pre class="literallayout">simpleReport.(class)=org.springframework.web.servlet.view.jasperreports.JasperReportsPdfView
simpleReport.url=/WEB-INF/reports/DataSourceReport.jasper
simpleReport.reportDataKey=myBeanData</pre>

<p>Be aware that when using the first approach, Spring will use the first instance of
<code class="literal">JRDataSource</code> or <code class="literal">Collection</code> that it encounters. If you need to place multiple
instances of <code class="literal">JRDataSource</code> or <code class="literal">Collection</code> into the model you need to use the second
approach.</p>
</div>
<div class="section" title="17.7.4&nbsp;Working with Sub-Reports"><div class="titlepage"><div><div><h3 class="title"><a name="view-jasper-reports-subreports"></a>17.7.4&nbsp;Working with Sub-Reports</h3></div></div></div>

<p>JasperReports provides support for embedded sub-reports within your master report files.
There are a wide variety of mechanisms for including sub-reports in your report files.
The easiest way is to hard code the report path and the SQL query for the sub report
into your design files. The drawback of this approach is obvious: the values are
hard-coded into your report files reducing reusability and making it harder to modify
and update report designs. To overcome this you can configure sub-reports declaratively,
and you can include additional data for these sub-reports directly from your controllers.</p>
<div class="section" title="Configuring Sub-Report Files"><div class="titlepage"><div><div><h4 class="title"><a name="view-jasper-reports-subreports-config-reports"></a>Configuring Sub-Report Files</h4></div></div></div>

<p>To control which sub-report files are included in a master report using Spring, your
report file must be configured to accept sub-reports from an external source. To do this
you declare a parameter in your report file like so:</p>
<pre class="programlisting"><span class="hl-tag">&lt;parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ProductsSubReport"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"net.sf.jasperreports.engine.JasperReport"</span><span class="hl-tag">/&gt;</span></pre>

<p>Then, you define your sub-report to use this sub-report parameter:</p>
<pre class="programlisting"><span class="hl-tag">&lt;subreport&gt;</span>
    <span class="hl-tag">&lt;reportElement</span> <span class="hl-attribute">isPrintRepeatedValues</span>=<span class="hl-value">"false"</span> <span class="hl-attribute">x</span>=<span class="hl-value">"5"</span> <span class="hl-attribute">y</span>=<span class="hl-value">"25"</span> <span class="hl-attribute">width</span>=<span class="hl-value">"325"</span>
        <span class="hl-attribute">height</span>=<span class="hl-value">"20"</span> <span class="hl-attribute">isRemoveLineWhenBlank</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">backcolor</span>=<span class="hl-value">"#ffcc99"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;subreportParameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"City"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;subreportParameterExpression&gt;</span><span class="hl-tag">&lt;![CDATA[</span>$F{city}<span class="hl-tag">]]&gt;</span><span class="hl-tag">&lt;/subreportParameterExpression&gt;</span>
    <span class="hl-tag">&lt;/subreportParameter&gt;</span>
    <span class="hl-tag">&lt;dataSourceExpression&gt;</span><span class="hl-tag">&lt;![CDATA[</span>$P{SubReportData}<span class="hl-tag">]]&gt;</span><span class="hl-tag">&lt;/dataSourceExpression&gt;</span>
    <span class="hl-tag">&lt;subreportExpression</span> <span class="hl-attribute">class</span>=<span class="hl-value">"net.sf.jasperreports.engine.JasperReport"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;![CDATA[</span>$P{ProductsSubReport}<span class="hl-tag">]]&gt;</span><span class="hl-tag">&lt;/subreportExpression&gt;</span>
<span class="hl-tag">&lt;/subreport&gt;</span></pre>

<p>This defines a master report file that expects the sub-report to be passed in as an
instance of <code class="literal">net.sf.jasperreports.engine.JasperReports</code> under the parameter
<code class="literal">ProductsSubReport</code>. When configuring your Jasper view class, you can instruct Spring to
load a report file and pass it into the JasperReports engine as a sub-report using the
<code class="literal">subReportUrls</code> property:</p>
<pre class="programlisting"><span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"subReportUrls"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;map&gt;</span>
        <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ProductsSubReport"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/reports/subReportChild.jrxml"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/map&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span></pre>

<p>Here, the key of the <code class="literal">Map</code> corresponds to the name of the sub-report parameter in the
report design file, and the entry is the URL of the report file. Spring will load this
report file, compiling it if necessary, and pass it into the JasperReports engine under
the given key.</p>
</div>
<div class="section" title="Configuring Sub-Report Data Sources"><div class="titlepage"><div><div><h4 class="title"><a name="view-jasper-reports-subreports-config-datasources"></a>Configuring Sub-Report Data Sources</h4></div></div></div>

<p>This step is entirely optional when using Spring to configure your sub-reports. If you
wish, you can still configure the data source for your sub-reports using static queries.
However, if you want Spring to convert data returned in your <code class="literal">ModelAndView</code> into
instances of <code class="literal">JRDataSource</code> then you need to specify which of the parameters in your
<code class="literal">ModelAndView</code> Spring should convert. To do this, configure the list of parameter names
using the <code class="literal">subReportDataKeys</code> property of your chosen view class:</p>
<pre class="programlisting"><span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"subReportDataKeys"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SubReportData"</span><span class="hl-tag">/&gt;</span></pre>

<p>Here, the key you supply <span class="emphasis"><em>must</em></span> correspond to both the key used in your <code class="literal">ModelAndView</code>
and the key used in your report design file.</p>
</div>
</div>
<div class="section" title="17.7.5&nbsp;Configuring Exporter Parameters"><div class="titlepage"><div><div><h3 class="title"><a name="view-jasper-reports-exporter-parameters"></a>17.7.5&nbsp;Configuring Exporter Parameters</h3></div></div></div>

<p>If you have special requirements for exporter configuration&#8201;&#8212;&#8201;perhaps you want a
specific page size for your PDF report&#8201;&#8212;&#8201;you can configure these exporter parameters
declaratively in your Spring configuration file using the <code class="literal">exporterParameters</code> property
of the view class. The <code class="literal">exporterParameters</code> property is typed as a <code class="literal">Map</code>. In your
configuration the key of an entry should be the fully-qualified name of a static field
that contains the exporter parameter definition, and the value of an entry should be the
value you want to assign to the parameter. An example of this is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"htmlReport"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.view.jasperreports.JasperReportsHtmlView"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/reports/simpleReport.jrxml"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"exporterParameters"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"net.sf.jasperreports.engine.export.JRHtmlExporterParameter.HTML_FOOTER"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>Footer by Spring!
                    &amp;lt;/td&amp;gt;&amp;lt;td width="50%"&amp;gt;&amp;amp;nbsp; &amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
                    &amp;lt;/table&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
                <span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/entry&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Here you can see that the <code class="literal">JasperReportsHtmlView</code> is configured with an exporter
parameter for <code class="literal">net.sf.jasperreports.engine.export.JRHtmlExporterParameter.HTML_FOOTER</code>
which will output a footer in the resulting HTML.</p>
</div>
</div>
<div class="section" title="17.8&nbsp;Feed Views"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-feeds"></a>17.8&nbsp;Feed Views</h2></div></div></div>

<p>Both <code class="literal">AbstractAtomFeedView</code> and <code class="literal">AbstractRssFeedView</code> inherit from the base class
<code class="literal">AbstractFeedView</code> and are used to provide Atom and RSS Feed views respectfully. They
are based on java.net&#8217;s <a class="ulink" href="https://rome.dev.java.net" target="_top">ROME</a> project and are located in the
package <code class="literal">org.springframework.web.servlet.view.feed</code>.</p>
<p><code class="literal">AbstractAtomFeedView</code> requires you to implement the <code class="literal">buildFeedEntries()</code> method and
optionally override the <code class="literal">buildFeedMetadata()</code> method (the default implementation is
empty), as shown below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SampleContentAtomView <span class="hl-keyword">extends</span> AbstractAtomFeedView {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> buildFeedMetadata(Map&lt;String, Object&gt; model,
            Feed feed, HttpServletRequest request) {
        <span class="hl-comment">// implementation omitted</span>
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> List&lt;Entry&gt; buildFeedEntries(Map&lt;String, Object&gt; model,
            HttpServletRequest request, HttpServletResponse response) <span class="hl-keyword">throws</span> Exception {
        <span class="hl-comment">// implementation omitted</span>
    }

}</pre>

<p>Similar requirements apply for implementing <code class="literal">AbstractRssFeedView</code>, as shown below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SampleContentAtomView <span class="hl-keyword">extends</span> AbstractRssFeedView {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> buildFeedMetadata(Map&lt;String, Object&gt; model,
            Channel feed, HttpServletRequest request) {
        <span class="hl-comment">// implementation omitted</span>
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">protected</span> List&lt;Item&gt; buildFeedItems(Map&lt;String, Object&gt; model,
            HttpServletRequest request, HttpServletResponse response) <span class="hl-keyword">throws</span> Exception {
        <span class="hl-comment">// implementation omitted</span>
    }

}</pre>

<p>The <code class="literal">buildFeedItems()</code> and <code class="literal">buildFeedEntires()</code> methods pass in the HTTP request in case
you need to access the Locale. The HTTP response is passed in only for the setting of
cookies or other HTTP headers. The feed will automatically be written to the response
object after the method returns.</p>
<p>For an example of creating an Atom view please refer to Alef Arendsen&#8217;s SpringSource
Team Blog
<a class="ulink" href="http://spring.io/blog/2009/03/16/adding-an-atom-view-to-an-application-using-spring-s-rest-support" target="_top">entry</a>.</p>
</div>
<div class="section" title="17.9&nbsp;XML Marshalling View"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-xml-marshalling"></a>17.9&nbsp;XML Marshalling View</h2></div></div></div>

<p>The <code class="literal">MarhsallingView</code> uses an XML <code class="literal">Marshaller</code> defined in the <code class="literal">org.springframework.oxm</code>
package to render the response content as XML. The object to be marshalled can be set
explicitly using <code class="literal">MarhsallingView</code>'s <code class="literal">modelKey</code> bean property. Alternatively, the view
will iterate over all model properties and marshal only those types that are supported
by the <code class="literal">Marshaller</code>. For more information on the functionality in the
<code class="literal">org.springframework.oxm</code> package refer to the chapter <a class="link" href="#oxm" title="15.&nbsp;Marshalling XML using O/X Mappers">Marshalling XML using O/X
Mappers</a>.</p>
</div>
<div class="section" title="17.10&nbsp;JSON Mapping View"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-json-mapping"></a>17.10&nbsp;JSON Mapping View</h2></div></div></div>

<p>The <code class="literal">MappingJackson2JsonView</code> (or <code class="literal">MappingJacksonJsonView</code> depending on the the Jackson
version you have) uses the Jackson library&#8217;s <code class="literal">ObjectMapper</code> to render the response
content as JSON. By default, the entire contents of the model map (with the exception of
framework-specific classes) will be encoded as JSON. For cases where the contents of the
map need to be filtered, users may specify a specific set of model attributes to encode
via the <code class="literal">RenderedAttributes</code> property. The <code class="literal">extractValueFromSingleKeyModel</code> property may
also be used to have the value in single-key models extracted and serialized directly
rather than as a map of model attributes.</p>
<p>JSON mapping can be customized as needed through the use of Jackson&#8217;s provided
annotations. When further control is needed, a custom <code class="literal">ObjectMapper</code> can be injected
through the <code class="literal">ObjectMapper</code> property for cases where custom JSON
serializers/deserializers need to be provided for specific types.</p>
</div>
</div>
<div class="chapter" title="18.&nbsp;Integrating with other web frameworks"><div class="titlepage"><div><div><h2 class="title"><a name="web-integration"></a>18.&nbsp;Integrating with other web frameworks</h2></div></div></div>

<div class="section" title="18.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro"></a>18.1&nbsp;Introduction</h2></div></div></div>

<div class="sidebar" title="Spring Web Flow"><p class="title"><b>Spring Web Flow</b></p>

<p>Spring Web Flow (SWF) aims to be the best solution for the management of web application
page flow.</p>
<p>SWF integrates with existing frameworks like Spring MVC, Struts, and JSF, in both
servlet and portlet environments. If you have a business process (or processes) that
would benefit from a conversational model as opposed to a purely request model, then SWF
may be the solution.</p>
<p>SWF allows you to capture logical page flows as self-contained modules that are reusable
in different situations, and as such is ideal for building web application modules that
guide the user through controlled navigations that drive business processes.</p>
<p>For more information about SWF, consult the
<a class="ulink" href="http://projects.spring.io/spring-webflow/" target="_top">Spring Web Flow website</a>.</p>
</div>

<p>This chapter details Spring&#8217;s integration with third party web frameworks such as
<a class="ulink" href="http://www.oracle.com/technetwork/java/javaee/javaserverfaces-139869.html" target="_top">JSF</a>,
<a class="ulink" href="http://struts.apache.org/" target="_top">Struts</a>, and <a class="ulink" href="http://tapestry.apache.org/" target="_top">Tapestry</a>.</p>
<p>One of the core value propositions of the Spring Framework is that of enabling
<span class="emphasis"><em>choice</em></span>. In a general sense, Spring does not force one to use or buy into any
particular architecture, technology, or methodology (although it certainly recommends
some over others). This freedom to pick and choose the architecture, technology, or
methodology that is most relevant to a developer and their development team is
arguably most evident in the web area, where Spring provides its own web framework
(<a class="link" href="#mvc" title="16.&nbsp;Web MVC framework">Spring MVC</a>), while at the same time providing integration with a number of
popular third party web frameworks. This allows one to continue to leverage any and all
of the skills one may have acquired in a particular web framework such as Struts, while
at the same time being able to enjoy the benefits afforded by Spring in other areas such
as data access, declarative transaction management, and flexible configuration and
application assembly.</p>
<p>Having dispensed with the woolly sales patter (c.f. the previous paragraph), the
remainder of this chapter will concentrate upon the meaty details of integrating your
favorite web framework with Spring. One thing that is often commented upon by developers
coming to Java from other languages is the seeming super-abundance of web frameworks
available in Java. There are indeed a great number of web frameworks in the Java space;
in fact there are far too many to cover with any semblance of detail in a single
chapter. This chapter thus picks four of the more popular web frameworks in Java,
starting with the Spring configuration that is common to all of the supported web
frameworks, and then detailing the specific integration options for each supported web
framework.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please note that this chapter does not attempt to explain how to use any of the
supported web frameworks. For example, if you want to use Struts for the presentation
layer of your web application, the assumption is that you are already familiar with
Struts. If you need further details about any of the supported web frameworks
themselves, please do consult <a class="xref" href="#web-integration-resources" title="18.6&nbsp;Further Resources">Section&nbsp;18.6, &#8220;Further Resources&#8221;</a> at the end of this chapter.</p>
</td></tr></table></div>

</div>
<div class="section" title="18.2&nbsp;Common configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-integration-common"></a>18.2&nbsp;Common configuration</h2></div></div></div>

<p>Before diving into the integration specifics of each supported web framework, let us
first take a look at the Spring configuration that is <span class="emphasis"><em>not</em></span> specific to any one web
framework. (This section is equally applicable to Spring&#8217;s own web framework, Spring
MVC.)</p>
<p>One of the concepts (for want of a better word) espoused by (Spring&#8217;s) lightweight
application model is that of a layered architecture. Remember that in a <span class="emphasis"><em>classic</em></span>
layered architecture, the web layer is but one of many layers; it serves as one of the
entry points into a server side application and it delegates to service objects
(facades) defined in a service layer to satisfy business specific (and
presentation-technology agnostic) use cases. In Spring, these service objects, any other
business-specific objects, data access objects, etc. exist in a distinct <span class="emphasis"><em>business
context</em></span>, which contains <span class="emphasis"><em>no</em></span> web or presentation layer objects (presentation objects
such as Spring MVC controllers are typically configured in a distinct <span class="emphasis"><em>presentation
context</em></span>). This section details how one configures a Spring container (a
<code class="literal">WebApplicationContext</code>) that contains all of the <span class="emphasis"><em>business beans</em></span> in one&#8217;s application.</p>
<p>On to specifics: all that one need do is to declare a
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/ContextLoaderListener.html" target="_top"><code class="literal">ContextLoaderListener</code></a>
in the standard Java EE servlet <code class="literal">web.xml</code> file of one&#8217;s web application, and add a
<code class="literal">contextConfigLocation</code>&lt;context-param/&gt; section (in the same file) that defines which
set of Spring XML configuration files to load.</p>
<p>Find below the &lt;listener/&gt; configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;listener&gt;</span>
    <span class="hl-tag">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hl-tag">&lt;/listener-class&gt;</span>
<span class="hl-tag">&lt;/listener&gt;</span></pre>

<p>Find below the &lt;context-param/&gt; configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;context-param&gt;</span>
    <span class="hl-tag">&lt;param-name&gt;</span>contextConfigLocation<span class="hl-tag">&lt;/param-name&gt;</span>
    <span class="hl-tag">&lt;param-value&gt;</span>/WEB-INF/applicationContext*.xml<span class="hl-tag">&lt;/param-value&gt;</span>
<span class="hl-tag">&lt;/context-param&gt;</span></pre>

<p>If you don&#8217;t specify the <code class="literal">contextConfigLocation</code> context parameter, the
<code class="literal">ContextLoaderListener</code> will look for a file called <code class="literal">/WEB-INF/applicationContext.xml</code> to
load. Once the context files are loaded, Spring creates a
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/WebApplicationContext.html" target="_top"><code class="literal">WebApplicationContext</code></a>
object based on the bean definitions and stores it in the <code class="literal">ServletContext</code> of the web
application.</p>
<p>All Java web frameworks are built on top of the Servlet API, and so one can use the
following code snippet to get access to this <span class="emphasis"><em>business context</em></span> <code class="literal">ApplicationContext</code>
created by the <code class="literal">ContextLoaderListener</code>.</p>
<pre class="programlisting">WebApplicationContext ctx = WebApplicationContextUtils.getWebApplicationContext(servletContext);</pre>

<p>The
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/support/WebApplicationContextUtils.html" target="_top"><code class="literal">WebApplicationContextUtils</code></a>
class is for convenience, so you don&#8217;t have to remember the name of the <code class="literal">ServletContext</code>
attribute. Its <span class="emphasis"><em>getWebApplicationContext()</em></span> method will return <code class="literal">null</code> if an object
doesn&#8217;t exist under the <code class="literal">WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</code>
key. Rather than risk getting <code class="literal">NullPointerExceptions</code> in your application, it&#8217;s better
to use the <code class="literal">getRequiredWebApplicationContext()</code> method. This method throws an exception
when the <code class="literal">ApplicationContext</code> is missing.</p>
<p>Once you have a reference to the <code class="literal">WebApplicationContext</code>, you can retrieve beans by
their name or type. Most developers retrieve beans by name and then cast them to one of
their implemented interfaces.</p>
<p>Fortunately, most of the frameworks in this section have simpler ways of looking up
beans. Not only do they make it easy to get beans from a Spring container, but they also
allow you to use dependency injection on their controllers. Each web framework section
has more detail on its specific integration strategies.</p>
</div>
<div class="section" title="18.3&nbsp;JavaServer Faces 1.2"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jsf"></a>18.3&nbsp;JavaServer Faces 1.2</h2></div></div></div>

<p>JavaServer Faces (JSF) is the JCP&#8217;s standard component-based, event-driven web user
interface framework. As of Java EE 5, it is an official part of the Java EE umbrella.</p>
<p>For a popular JSF runtime as well as for popular JSF component libraries, check out the
<a class="ulink" href="http://myfaces.apache.org/" target="_top">Apache MyFaces project</a>. The MyFaces project also provides
common JSF extensions such as <a class="ulink" href="http://myfaces.apache.org/orchestra/" target="_top">MyFaces Orchestra</a>:
a Spring-based JSF extension that provides rich conversation scope support.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Web Flow 2.0 provides rich JSF support through its newly established Spring Faces
module, both for JSF-centric usage (as described in this section) and for Spring-centric
usage (using JSF views within a Spring MVC dispatcher). Check out the
<a class="ulink" href="http://projects.spring.io/spring-webflow" target="_top">Spring Web Flow website</a> for details!</p>
</td></tr></table></div>

<p>The key element in Spring&#8217;s JSF integration is the JSF <code class="literal">ELResolver</code> mechanism.</p>
<div class="section" title="18.3.1&nbsp;SpringBeanFacesELResolver (JSF 1.2+)"><div class="titlepage"><div><div><h3 class="title"><a name="jsf-springbeanfaceselresolver"></a>18.3.1&nbsp;SpringBeanFacesELResolver (JSF 1.2+)</h3></div></div></div>

<p><code class="literal">SpringBeanFacesELResolver</code> is a JSF 1.2 compliant <code class="literal">ELResolver</code> implementation,
integrating with the standard Unified EL as used by JSF 1.2 and JSP 2.1. Like
<code class="literal">SpringBeanVariableResolver</code>, it delegates to the Spring&#8217;s <span class="emphasis"><em>business context</em></span>
<code class="literal">WebApplicationContext</code> <span class="emphasis"><em>first</em></span>, then to the default resolver of the underlying JSF
implementation.</p>
<p>Configuration-wise, simply define <code class="literal">SpringBeanFacesELResolver</code> in your JSF 1.2
<span class="emphasis"><em>faces-context.xml</em></span> file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;faces-config&gt;</span>
    <span class="hl-tag">&lt;application&gt;</span>
        <span class="hl-tag">&lt;el-resolver&gt;</span>org.springframework.web.jsf.el.SpringBeanFacesELResolver<span class="hl-tag">&lt;/el-resolver&gt;</span>
        ...
    <span class="hl-tag">&lt;/application&gt;</span>
<span class="hl-tag">&lt;/faces-config&gt;</span></pre>

</div>
<div class="section" title="18.3.2&nbsp;FacesContextUtils"><div class="titlepage"><div><div><h3 class="title"><a name="jsf-facescontextutils"></a>18.3.2&nbsp;FacesContextUtils</h3></div></div></div>

<p>A custom <code class="literal">VariableResolver</code> works well when mapping one&#8217;s properties to beans
in <span class="emphasis"><em>faces-config.xml</em></span>, but at times one may need to grab a bean explicitly. The
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/jsf/FacesContextUtils.html" target="_top"><code class="literal">FacesContextUtils</code></a>
class makes this easy. It is similar to <code class="literal">WebApplicationContextUtils</code>, except that it
takes a <code class="literal">FacesContext</code> parameter rather than a <code class="literal">ServletContext</code> parameter.</p>
<pre class="programlisting">ApplicationContext ctx = FacesContextUtils.getWebApplicationContext(FacesContext.getCurrentInstance());</pre>

</div>
</div>
<div class="section" title="18.4&nbsp;Apache Struts 2.x"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="struts"></a>18.4&nbsp;Apache Struts 2.x</h2></div></div></div>

<p>Invented by Craig McClanahan, <a class="ulink" href="http://struts.apache.org" target="_top">Struts</a> is an open source project
hosted by the Apache Software Foundation. At the time, it greatly simplified the
JSP/Servlet programming paradigm and won over many developers who were using proprietary
frameworks. It simplified the programming model, it was open source (and thus free as in
beer), and it had a large community, which allowed the project to grow and become popular
among Java web developers.</p>
<p>Check out the Struts
<a class="ulink" href="https://struts.apache.org/release/2.3.x/docs/spring-plugin.html" target="_top">Spring Plugin</a> for the
built-in Spring integration shipped with Struts.</p>
</div>
<div class="section" title="18.5&nbsp;Tapestry 5.x"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tapestry"></a>18.5&nbsp;Tapestry 5.x</h2></div></div></div>

<p>From the <a class="ulink" href="http://tapestry.apache.org/" target="_top">Tapestry homepage</a>:</p>
<p>Tapestry is a "<span class="emphasis"><em>Component oriented framework for creating dynamic, robust,
highly scalable web applications in Java.</em></span>"</p>
<p>While Spring has its own <a class="link" href="#mvc" title="16.&nbsp;Web MVC framework">powerful web layer</a>, there are a number of unique
advantages to building an enterprise Java application using a combination of Tapestry
for the web user interface and the Spring container for the lower layers.</p>
<p>For more information, check out Tapestry&#8217;s dedicated
<a class="ulink" href="https://tapestry.apache.org/integrating-with-spring-framework.html" target="_top">integration module for
Spring</a>.</p>
</div>
<div class="section" title="18.6&nbsp;Further Resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-integration-resources"></a>18.6&nbsp;Further Resources</h2></div></div></div>

<p>Find below links to further resources about the various web frameworks described in this
chapter.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <a class="ulink" href="http://www.oracle.com/technetwork/java/javaee/javaserverfaces-139869.html" target="_top">JSF</a> homepage
</li><li class="listitem">
The <a class="ulink" href="http://struts.apache.org/" target="_top">Struts</a> homepage
</li><li class="listitem">
The <a class="ulink" href="http://tapestry.apache.org/" target="_top">Tapestry</a> homepage
</li></ul></div>

</div>
</div>
<div class="chapter" title="19.&nbsp;Portlet MVC Framework"><div class="titlepage"><div><div><h2 class="title"><a name="portlet"></a>19.&nbsp;Portlet MVC Framework</h2></div></div></div>

<div class="section" title="19.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-introduction"></a>19.1&nbsp;Introduction</h2></div></div></div>

<div class="sidebar" title="JSR-168 The Java Portlet Specification"><p class="title"><b>JSR-168 The Java Portlet Specification</b></p>

<p>For more general information about portlet development, please review a whitepaper from
Oracle entitled
<a class="ulink" href="http://www.oracle.com/technetwork/java/index-raji-test-141933.html" target="_top">"Introduction
to JSR 168"</a>, and of course the
<a class="ulink" href="http://jcp.org/aboutJava/communityprocess/final/jsr168/" target="_top">JSR-168 Specification</a> itself.</p>
</div>

<p>In addition to supporting conventional (servlet-based) Web development, Spring also
supports JSR-168 Portlet development. As much as possible, the Portlet MVC framework is
a mirror image of the Web MVC framework, and also uses the same underlying view
abstractions and integration technology. So, be sure to review the chapters entitled
<a class="xref" href="#mvc" title="16.&nbsp;Web MVC framework">Chapter&nbsp;16, <i>Web MVC framework</i></a> and <a class="xref" href="#view" title="17.&nbsp;View technologies">Chapter&nbsp;17, <i>View technologies</i></a> before continuing with this chapter.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Bear in mind that while the concepts of Spring MVC are the same in Spring Portlet MVC,
there are some notable differences created by the unique workflow of JSR-168 portlets.</p>
</td></tr></table></div>

<p>The main way in which portlet workflow differs from servlet workflow is that the request
to the portlet can have two distinct phases: the action phase and the render phase. The
action phase is executed only once and is where any <span class="emphasis"><em>backend</em></span> changes or actions occur,
such as making changes in a database. The render phase then produces what is displayed
to the user each time the display is refreshed. The critical point here is that for a
single overall request, the action phase is executed only once, but the render phase may
be executed multiple times. This provides (and requires) a clean separation between the
activities that modify the persistent state of your system and the activities that
generate what is displayed to the user.</p>
<div class="sidebar" title="Spring Web Flow"><p class="title"><b>Spring Web Flow</b></p>

<p>Spring Web Flow (SWF) aims to be the best solution for the management of web application
page flow.</p>
<p>SWF integrates with existing frameworks like Spring MVC, Struts, and JSF, in both
servlet and portlet environments. If you have a business process (or processes) that
would benefit from a conversational model as opposed to a purely request model, then SWF
may be the solution.</p>
<p>SWF allows you to capture logical page flows as self-contained modules that are reusable
in different situations, and as such is ideal for building web application modules that
guide the user through controlled navigations that drive business processes.</p>
<p>For more information about SWF, consult the Spring Web Flow website.</p>
</div>

<p>The dual phases of portlet requests are one of the real strengths of the JSR-168
specification. For example, dynamic search results can be updated routinely on the
display without the user explicitly rerunning the search. Most other portlet MVC
frameworks attempt to completely hide the two phases from the developer and make it look
as much like traditional servlet development as possible - we think this approach
removes one of the main benefits of using portlets. So, the separation of the two phases
is preserved throughout the Spring Portlet MVC framework. The primary manifestation of
this approach is that where the servlet version of the MVC classes will have one method
that deals with the request, the portlet version of the MVC classes will have two
methods that deal with the request: one for the action phase and one for the render
phase. For example, where the servlet version of <code class="literal">AbstractController</code> has the
<code class="literal">handleRequestInternal(..)</code> method, the portlet version of <code class="literal">AbstractController</code> has
<code class="literal">handleActionRequestInternal(..)</code> and <code class="literal">handleRenderRequestInternal(..)</code> methods.</p>
<p>The framework is designed around a <code class="literal">DispatcherPortlet</code> that dispatches requests to
handlers, with configurable handler mappings and view resolution, just as the
<code class="literal">DispatcherServlet</code> in the web framework does. File upload is also supported in the same
way.</p>
<p>Locale resolution and theme resolution are not supported in Portlet MVC - these areas
are in the purview of the portal/portlet container and are not appropriate at the Spring
level. However, all mechanisms in Spring that depend on the locale (such as
internationalization of messages) will still function properly because
<code class="literal">DispatcherPortlet</code> exposes the current locale in the same way as <code class="literal">DispatcherServlet</code>.</p>
<div class="section" title="19.1.1&nbsp;Controllers - The C in MVC"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-introduction-controller"></a>19.1.1&nbsp;Controllers - The C in MVC</h3></div></div></div>

<p>The default handler is still a very simple <code class="literal">Controller</code> interface, offering just two
methods:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">void handleActionRequest(request,response)</code>
</li><li class="listitem">
<code class="literal">ModelAndView handleRenderRequest(request,response)</code>
</li></ul></div>

<p>The framework also includes most of the same controller implementation hierarchy, such
as <code class="literal">AbstractController</code>, <code class="literal">SimpleFormController</code>, and so on. Data binding, command object
usage, model handling, and view resolution are all the same as in the servlet framework.</p>
</div>
<div class="section" title="19.1.2&nbsp;Views - The V in MVC"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-introduction-view"></a>19.1.2&nbsp;Views - The V in MVC</h3></div></div></div>

<p>All the view rendering capabilities of the servlet framework are used directly via a
special bridge servlet named <code class="literal">ViewRendererServlet</code>. By using this servlet, the portlet
request is converted into a servlet request and the view can be rendered using the
entire normal servlet infrastructure. This means all the existing renderers, such as
JSP, Velocity, etc., can still be used within the portlet.</p>
</div>
<div class="section" title="19.1.3&nbsp;Web-scoped beans"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-introduction-scope"></a>19.1.3&nbsp;Web-scoped beans</h3></div></div></div>

<p>Spring Portlet MVC supports beans whose lifecycle is scoped to the current HTTP request
or HTTP <code class="literal">Session</code> (both normal and global). This is not a specific feature of Spring
Portlet MVC itself, but rather of the <code class="literal">WebApplicationContext</code> container(s) that Spring
Portlet MVC uses. These bean scopes are described in detail in
<a class="xref" href="#beans-factory-scopes-other" title="4.5.4&nbsp;Request, session, and global session scopes">Section&nbsp;4.5.4, &#8220;Request, session, and global session scopes&#8221;</a></p>
</div>
</div>
<div class="section" title="19.2&nbsp;The DispatcherPortlet"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-dispatcher"></a>19.2&nbsp;The DispatcherPortlet</h2></div></div></div>

<p>Portlet MVC is a request-driven web MVC framework, designed around a portlet that
dispatches requests to controllers and offers other functionality facilitating the
development of portlet applications. Spring&#8217;s <code class="literal">DispatcherPortlet</code> however, does more
than just that. It is completely integrated with the Spring <code class="literal">ApplicationContext</code> and
allows you to use every other feature Spring has.</p>
<p>Like ordinary portlets, the <code class="literal">DispatcherPortlet</code> is declared in the <code class="literal">portlet.xml</code> file of
your web application:</p>
<pre class="programlisting"><span class="hl-tag">&lt;portlet&gt;</span>
    <span class="hl-tag">&lt;portlet-name&gt;</span>sample<span class="hl-tag">&lt;/portlet-name&gt;</span>
    <span class="hl-tag">&lt;portlet-class&gt;</span>org.springframework.web.portlet.DispatcherPortlet<span class="hl-tag">&lt;/portlet-class&gt;</span>
    <span class="hl-tag">&lt;supports&gt;</span>
        <span class="hl-tag">&lt;mime-type&gt;</span>text/html<span class="hl-tag">&lt;/mime-type&gt;</span>
        <span class="hl-tag">&lt;portlet-mode&gt;</span>view<span class="hl-tag">&lt;/portlet-mode&gt;</span>
    <span class="hl-tag">&lt;/supports&gt;</span>
    <span class="hl-tag">&lt;portlet-info&gt;</span>
        <span class="hl-tag">&lt;title&gt;</span>Sample Portlet<span class="hl-tag">&lt;/title&gt;</span>
    <span class="hl-tag">&lt;/portlet-info&gt;</span>
<span class="hl-tag">&lt;/portlet&gt;</span></pre>

<p>The <code class="literal">DispatcherPortlet</code> now needs to be configured.</p>
<p>In the Portlet MVC framework, each <code class="literal">DispatcherPortlet</code> has its own
<code class="literal">WebApplicationContext</code>, which inherits all the beans already defined in the Root
<code class="literal">WebApplicationContext</code>. These inherited beans can be overridden in the portlet-specific
scope, and new scope-specific beans can be defined local to a given portlet instance.</p>
<p>The framework will, on initialization of a <code class="literal">DispatcherPortlet</code>, look for a file named
<code class="literal">[portlet-name]-portlet.xml</code> in the <code class="literal">WEB-INF</code> directory of your web application and
create the beans defined there (overriding the definitions of any beans defined with the
same name in the global scope).</p>
<p>The config location used by the <code class="literal">DispatcherPortlet</code> can be modified through a portlet
initialization parameter (see below for details).</p>
<p>The Spring <code class="literal">DispatcherPortlet</code> has a few special beans it uses, in order to be able to
process requests and render the appropriate views. These beans are included in the
Spring framework and can be configured in the <code class="literal">WebApplicationContext</code>, just as any other
bean would be configured. Each of those beans is described in more detail below. Right
now, we&#8217;ll just mention them, just to let you know they exist and to enable us to go on
talking about the <code class="literal">DispatcherPortlet</code>. For most of the beans, defaults are provided so
you don&#8217;t have to worry about configuring them.</p>
<div class="table"><a name="portlet-webappctx-special-beans-tbl"></a><p class="title"><b>Table&nbsp;19.1.&nbsp;Special beans in the WebApplicationContext</b></p><div class="table-contents">

  <table summary="Special beans in the WebApplicationContext" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Expression</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>handler mapping(s)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>(<a class="xref" href="#portlet-handlermapping" title="19.5&nbsp;Handler mappings">Section&nbsp;19.5, &#8220;Handler mappings&#8221;</a>) a list of pre- and post-processors and controllers that
  will be executed if they match certain criteria (for instance a matching portlet mode
  specified with the controller)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>controller(s)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>(<a class="xref" href="#portlet-controller" title="19.4&nbsp;Controllers">Section&nbsp;19.4, &#8220;Controllers&#8221;</a>) the beans providing the actual functionality (or at least,
  access to the functionality) as part of the MVC triad</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>view resolver</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>(<a class="xref" href="#portlet-viewresolver" title="19.6&nbsp;Views and resolving them">Section&nbsp;19.6, &#8220;Views and resolving them&#8221;</a>) capable of resolving view names to view definitions</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>multipart resolver</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>(<a class="xref" href="#portlet-multipart" title="19.7&nbsp;Multipart (file upload) support">Section&nbsp;19.7, &#8220;Multipart (file upload) support&#8221;</a>) offers functionality to process file uploads from HTML forms</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>handler exception resolver</p></td><td style="" align="left" valign="top"><p>(<a class="xref" href="#portlet-exceptionresolver" title="19.8&nbsp;Handling exceptions">Section&nbsp;19.8, &#8220;Handling exceptions&#8221;</a>) offers functionality to map exceptions to views or
  implement other more complex exception handling code</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>When a <code class="literal">DispatcherPortlet</code> is setup for use and a request comes in for that specific
<code class="literal">DispatcherPortlet</code>, it starts processing the request. The list below describes the
complete process a request goes through if handled by a <code class="literal">DispatcherPortlet</code>:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
The locale returned by <code class="literal">PortletRequest.getLocale()</code> is bound to the request to let
elements in the process resolve the locale to use when processing the request (rendering
the view, preparing data, etc.).
</li><li class="listitem">
If a multipart resolver is specified and this is an <code class="literal">ActionRequest</code>, the request is
inspected for multiparts and if they are found, it is wrapped in a
<code class="literal">MultipartActionRequest</code> for further processing by other elements in the process. (See
<a class="xref" href="#portlet-multipart" title="19.7&nbsp;Multipart (file upload) support">Section&nbsp;19.7, &#8220;Multipart (file upload) support&#8221;</a> for further information about multipart handling).
</li><li class="listitem">
An appropriate handler is searched for. If a handler is found, the execution chain
associated with the handler (pre-processors, post-processors, controllers) will be
executed in order to prepare a model.
</li><li class="listitem">
If a model is returned, the view is rendered, using the view resolver that has been
configured with the <code class="literal">WebApplicationContext</code>. If no model is returned (which could be due
to a pre- or post-processor intercepting the request, for example, for security
reasons), no view is rendered, since the request could already have been fulfilled.
</li></ol></div>

<p>Exceptions that are thrown during processing of the request get picked up by any of the
handler exception resolvers that are declared in the <code class="literal">WebApplicationContext</code>. Using
these exception resolvers you can define custom behavior in case such exceptions get
thrown.</p>
<p>You can customize Spring&#8217;s <code class="literal">DispatcherPortlet</code> by adding context parameters in the
<code class="literal">portlet.xml</code> file or portlet init-parameters. The possibilities are listed below.</p>
<div class="table"><a name="portlet-dpp-init-params"></a><p class="title"><b>Table&nbsp;19.2.&nbsp;DispatcherPortlet initialization parameters</b></p><div class="table-contents">

  <table summary="DispatcherPortlet initialization parameters" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Parameter</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">contextClass</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Class that implements <code class="literal">WebApplicationContext</code>, which will be used to instantiate the
  context used by this portlet. If this parameter isn&#8217;t specified, the
  <code class="literal">XmlPortletApplicationContext</code> will be used.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">contextConfigLocation</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>String which is passed to the context instance (specified by <code class="literal">contextClass</code>) to
  indicate where context(s) can be found. The String is potentially split up into
  multiple Strings (using a comma as a delimiter) to support multiple contexts (in case
  of multiple context locations, for beans that are defined twice, the latest takes
  precedence).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">namespace</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The namespace of the <code class="literal">WebApplicationContext</code>. Defaults to <code class="literal">[portlet-name]-portlet</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">viewRendererUrl</code></p></td><td style="" align="left" valign="top"><p>The URL at which <code class="literal">DispatcherPortlet</code> can access an instance of <code class="literal">ViewRendererServlet</code>
  (see <a class="xref" href="#portlet-viewservlet" title="19.3&nbsp;The ViewRendererServlet">Section&nbsp;19.3, &#8220;The ViewRendererServlet&#8221;</a>).</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="19.3&nbsp;The ViewRendererServlet"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-viewservlet"></a>19.3&nbsp;The ViewRendererServlet</h2></div></div></div>

<p>The rendering process in Portlet MVC is a bit more complex than in Web MVC. In order to
reuse all the <a class="link" href="#view" title="17.&nbsp;View technologies">view technologies</a> from Spring Web MVC, we must convert the
<code class="literal">PortletRequest</code> / <code class="literal">PortletResponse</code> to <code class="literal">HttpServletRequest</code> / <code class="literal">HttpServletResponse</code> and
then call the <code class="literal">render</code> method of the <code class="literal">View</code>. To do this, <code class="literal">DispatcherPortlet</code> uses a
special servlet that exists for just this purpose: the <code class="literal">ViewRendererServlet</code>.</p>
<p>In order for <code class="literal">DispatcherPortlet</code> rendering to work, you must declare an instance of the
<code class="literal">ViewRendererServlet</code> in the <code class="literal">web.xml</code> file for your web application as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;servlet&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>ViewRendererServlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.ViewRendererServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
<span class="hl-tag">&lt;/servlet&gt;</span>

<span class="hl-tag">&lt;servlet-mapping&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>ViewRendererServlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;url-pattern&gt;</span>/WEB-INF/servlet/view<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/servlet-mapping&gt;</span></pre>

<p>To perform the actual rendering, <code class="literal">DispatcherPortlet</code> does the following:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Binds the <code class="literal">WebApplicationContext</code> to the request as an attribute under the same
<code class="literal">WEB_APPLICATION_CONTEXT_ATTRIBUTE</code> key that <code class="literal">DispatcherServlet</code> uses.
</li><li class="listitem">
Binds the <code class="literal">Model</code> and <code class="literal">View</code> objects to the request to make them available to the
<code class="literal">ViewRendererServlet</code>.
</li><li class="listitem">
Constructs a <code class="literal">PortletRequestDispatcher</code> and performs an <code class="literal">include</code> using the <code class="literal">/WEB-
INF/servlet/view</code> URL that is mapped to the <code class="literal">ViewRendererServlet</code>.
</li></ol></div>

<p>The <code class="literal">ViewRendererServlet</code> is then able to call the <code class="literal">render</code> method on the <code class="literal">View</code> with
the appropriate arguments.</p>
<p>The actual URL for the <code class="literal">ViewRendererServlet</code> can be changed using <code class="literal">DispatcherPortlet</code>'s
<code class="literal">viewRendererUrl</code> configuration parameter.</p>
</div>
<div class="section" title="19.4&nbsp;Controllers"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-controller"></a>19.4&nbsp;Controllers</h2></div></div></div>

<p>The controllers in Portlet MVC are very similar to the Web MVC Controllers, and porting
code from one to the other should be simple.</p>
<p>The basis for the Portlet MVC controller architecture is the
<code class="literal">org.springframework.web.portlet.mvc.Controller</code> interface, which is listed below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Controller {

    <b class="hl-tag" style="color: blue">/**
     * Process the render request and return a ModelAndView object which the
     * DispatcherPortlet will render.
     */</b>
    ModelAndView handleRenderRequest(RenderRequest request,
            RenderResponse response) <span class="hl-keyword">throws</span> Exception;

    <b class="hl-tag" style="color: blue">/**
     * Process the action request. There is nothing to return.
     */</b>
    <span class="hl-keyword">void</span> handleActionRequest(ActionRequest request,
            ActionResponse response) <span class="hl-keyword">throws</span> Exception;

}</pre>

<p>As you can see, the Portlet <code class="literal">Controller</code> interface requires two methods that handle the
two phases of a portlet request: the action request and the render request. The action
phase should be capable of handling an action request, and the render phase should be
capable of handling a render request and returning an appropriate model and view. While
the <code class="literal">Controller</code> interface is quite abstract, Spring Portlet MVC offers several
controllers that already contain a lot of the functionality you might need; most of
these are very similar to controllers from Spring Web MVC. The <code class="literal">Controller</code> interface
just defines the most common functionality required of every controller: handling an
action request, handling a render request, and returning a model and a view.</p>
<div class="section" title="19.4.1&nbsp;AbstractController and PortletContentGenerator"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-controller-abstractcontroller"></a>19.4.1&nbsp;AbstractController and PortletContentGenerator</h3></div></div></div>

<p>Of course, just a <code class="literal">Controller</code> interface isn&#8217;t enough. To provide a basic
infrastructure, all of Spring Portlet MVC&#8217;s <code class="literal">Controller</code> s inherit from
<code class="literal">AbstractController</code>, a class offering access to Spring&#8217;s <code class="literal">ApplicationContext</code> and
control over caching.</p>
<div class="table"><a name="portlet-ac-features"></a><p class="title"><b>Table&nbsp;19.3.&nbsp;Features offered by the AbstractController</b></p><div class="table-contents">

  <table summary="Features offered by the AbstractController" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Parameter</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">requireSession</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates whether or not this <code class="literal">Controller</code> requires a session to do its work. This
  feature is offered to all controllers. If a session is not present when such a
  controller receives a request, the user is informed using a <code class="literal">SessionRequiredException</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">synchronizeSession</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Use this if you want handling by this controller to be synchronized on the user&#8217;s
  session. To be more specific, the extending controller will override the
  <code class="literal">handleRenderRequestInternal(..)</code> and <code class="literal">handleActionRequestInternal(..)</code> methods, which
  will be synchronized on the user&#8217;s session if you specify this variable.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">renderWhenMinimized</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If you want your controller to actually render the view when the portlet is in a
  minimized state, set this to true. By default, this is set to false so that portlets
  that are in a minimized state don&#8217;t display any content.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">cacheSeconds</code></p></td><td style="" align="left" valign="top"><p>When you want a controller to override the default cache expiration defined for the
  portlet, specify a positive integer here. By default it is set to <code class="literal">-1</code>, which does not
  change the default caching. Setting it to <code class="literal">0</code> will ensure the result is never cached.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>The <code class="literal">requireSession</code> and <code class="literal">cacheSeconds</code> properties are declared on the
<code class="literal">PortletContentGenerator</code> class, which is the superclass of <code class="literal">AbstractController</code>) but
are included here for completeness.</p>
<p>When using the <code class="literal">AbstractController</code> as a base class for your controllers (which is not
recommended since there are a lot of other controllers that might already do the job for
you) you only have to override either the <code class="literal">handleActionRequestInternal(ActionRequest,
ActionResponse)</code> method or the <code class="literal">handleRenderRequestInternal(RenderRequest,
RenderResponse)</code> method (or both), implement your logic, and return a <code class="literal">ModelAndView</code>
object (in the case of <code class="literal">handleRenderRequestInternal</code>).</p>
<p>The default implementations of both <code class="literal">handleActionRequestInternal(..)</code> and
<code class="literal">handleRenderRequestInternal(..)</code> throw a <code class="literal">PortletException</code>. This is consistent with
the behavior of <code class="literal">GenericPortlet</code> from the JSR- 168 Specification API. So you only need
to override the method that your controller is intended to handle.</p>
<p>Here is short example consisting of a class and a declaration in the web application
context.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> samples;

<span class="hl-keyword">import</span> javax.portlet.RenderRequest;
<span class="hl-keyword">import</span> javax.portlet.RenderResponse;

<span class="hl-keyword">import</span> org.springframework.web.portlet.mvc.AbstractController;
<span class="hl-keyword">import</span> org.springframework.web.portlet.ModelAndView;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SampleController <span class="hl-keyword">extends</span> AbstractController {

    <span class="hl-keyword">public</span> ModelAndView handleRenderRequestInternal(RenderRequest request, RenderResponse response) {
        ModelAndView mav = <span class="hl-keyword">new</span> ModelAndView(<span class="hl-string">"foo"</span>);
        mav.addObject(<span class="hl-string">"message"</span>, <span class="hl-string">"Hello World!"</span>);
        <span class="hl-keyword">return</span> mav;
    }

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sampleController"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"samples.SampleController"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheSeconds"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"120"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The class above and the declaration in the web application context is all you need
besides setting up a handler mapping (see <a class="xref" href="#portlet-handlermapping" title="19.5&nbsp;Handler mappings">Section&nbsp;19.5, &#8220;Handler mappings&#8221;</a>) to get this very
simple controller working.</p>
</div>
<div class="section" title="19.4.2&nbsp;Other simple controllers"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-controller-simple"></a>19.4.2&nbsp;Other simple controllers</h3></div></div></div>

<p>Although you can extend <code class="literal">AbstractController</code>, Spring Portlet MVC provides a number of
concrete implementations which offer functionality that is commonly used in simple MVC
applications.</p>
<p>The <code class="literal">ParameterizableViewController</code> is basically the same as the example above, except
for the fact that you can specify the view name that it will return in the web
application context (no need to hard-code the view name).</p>
<p>The <code class="literal">PortletModeNameViewController</code> uses the current mode of the portlet as the view
name. So, if your portlet is in View mode (i.e. <code class="literal">PortletMode.VIEW</code>) then it uses "view"
as the view name.</p>
</div>
<div class="section" title="19.4.3&nbsp;Command Controllers"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-controller-command"></a>19.4.3&nbsp;Command Controllers</h3></div></div></div>

<p>Spring Portlet MVC has the exact same hierarchy of <span class="emphasis"><em>command controllers</em></span> as Spring Web
MVC. They provide a way to interact with data objects and dynamically bind parameters
from the <code class="literal">PortletRequest</code> to the data object specified. Your data objects don&#8217;t have to
implement a framework-specific interface, so you can directly manipulate your persistent
objects if you desire. Let&#8217;s examine what command controllers are available, to get an
overview of what you can do with them:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">AbstractCommandController</code> - a command controller you can use to create your own
command controller, capable of binding request parameters to a data object you
specify. This class does not offer form functionality, it does however offer
validation features and lets you specify in the controller itself what to do with the
command object that has been filled with the parameters from the request.
</li><li class="listitem">
<code class="literal">AbstractFormController</code> - an abstract controller offering form submission support.
Using this controller you can model forms and populate them using a command object you
retrieve in the controller. After a user has filled the form, <code class="literal">AbstractFormController</code>
binds the fields, validates, and hands the object back to the controller to take
appropriate action. Supported features are: invalid form submission (resubmission),
validation, and normal form workflow. You implement methods to determine which views
are used for form presentation and success. Use this controller if you need forms, but
don&#8217;t want to specify what views you&#8217;re going to show the user in the application
context.
</li><li class="listitem">
<code class="literal">SimpleFormController</code> - a concrete <code class="literal">AbstractFormController</code> that provides even more
support when creating a form with a corresponding command object. The
<code class="literal">SimpleFormController</code> lets you specify a command object, a viewname for the form, a
viewname for the page you want to show the user when form submission has succeeded,
and more.
</li><li class="listitem">
<code class="literal">AbstractWizardFormController</code>&#8201;&#8212;&#8201;a concrete <code class="literal">AbstractFormController</code> that provides a
wizard-style interface for editing the contents of a command object across multiple
display pages. Supports multiple user actions: finish, cancel, or page change, all of
which are easily specified in request parameters from the view.
</li></ul></div>

<p>These command controllers are quite powerful, but they do require a detailed
understanding of how they operate in order to use them efficiently. Carefully review the
Javadocs for this entire hierarchy and then look at some sample implementations before
you start using them.</p>
</div>
<div class="section" title="19.4.4&nbsp;PortletWrappingController"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-controller-wrapping"></a>19.4.4&nbsp;PortletWrappingController</h3></div></div></div>

<p>Instead of developing new controllers, it is possible to use existing portlets and map
requests to them from a <code class="literal">DispatcherPortlet</code>. Using the <code class="literal">PortletWrappingController</code>, you
can instantiate an existing <code class="literal">Portlet</code> as a <code class="literal">Controller</code> as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPortlet"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.mvc.PortletWrappingController"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"portletClass"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"sample.MyPortlet"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"portletName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"my-portlet"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"initParameters"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;value&gt;</span>config=/WEB-INF/my-portlet-config.xml<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This can be very valuable since you can then use interceptors to pre-process and
post-process requests going to these portlets. Since JSR-168 does not support any kind
of filter mechanism, this is quite handy. For example, this can be used to wrap the
Hibernate <code class="literal">OpenSessionInViewInterceptor</code> around a MyFaces JSF Portlet.</p>
</div>
</div>
<div class="section" title="19.5&nbsp;Handler mappings"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-handlermapping"></a>19.5&nbsp;Handler mappings</h2></div></div></div>

<p>Using a handler mapping you can map incoming portlet requests to appropriate handlers.
There are some handler mappings you can use out of the box, for example, the
<code class="literal">PortletModeHandlerMapping</code>, but let&#8217;s first examine the general concept of a
<code class="literal">HandlerMapping</code>.</p>
<p>Note: We are intentionally using the term "Handler" here instead of "Controller".
<code class="literal">DispatcherPortlet</code> is designed to be used with other ways to process requests than just
Spring Portlet MVC&#8217;s own Controllers. A Handler is any Object that can handle portlet
requests. Controllers are an example of Handlers, and they are of course the default. To
use some other framework with <code class="literal">DispatcherPortlet</code>, a corresponding implementation of
<code class="literal">HandlerAdapter</code> is all that is needed.</p>
<p>The functionality a basic <code class="literal">HandlerMapping</code> provides is the delivering of a
<code class="literal">HandlerExecutionChain</code>, which must contain the handler that matches the incoming
request, and may also contain a list of handler interceptors that are applied to the
request. When a request comes in, the <code class="literal">DispatcherPortlet</code> will hand it over to the
handler mapping to let it inspect the request and come up with an appropriate
<code class="literal">HandlerExecutionChain</code>. Then the <code class="literal">DispatcherPortlet</code> will execute the handler and
interceptors in the chain (if any). These concepts are all exactly the same as in Spring
Web MVC.</p>
<p>The concept of configurable handler mappings that can optionally contain interceptors
(executed before or after the actual handler was executed, or both) is extremely
powerful. A lot of supporting functionality can be built into a custom <code class="literal">HandlerMapping</code>.
Think of a custom handler mapping that chooses a handler not only based on the portlet
mode of the request coming in, but also on a specific state of the session associated
with the request.</p>
<p>In Spring Web MVC, handler mappings are commonly based on URLs. Since there is really no
such thing as a URL within a Portlet, we must use other mechanisms to control mappings.
The two most common are the portlet mode and a request parameter, but anything available
to the portlet request can be used in a custom handler mapping.</p>
<p>The rest of this section describes three of Spring Portlet MVC&#8217;s most commonly used
handler mappings. They all extend <code class="literal">AbstractHandlerMapping</code> and share the following
properties:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">interceptors</code>: The list of interceptors to use. <code class="literal">HandlerInterceptor</code> s are discussed
in <a class="xref" href="#portlet-handlermapping-interceptor" title="19.5.4&nbsp;Adding HandlerInterceptors">Section&nbsp;19.5.4, &#8220;Adding HandlerInterceptors&#8221;</a>.
</li><li class="listitem">
<code class="literal">defaultHandler</code>: The default handler to use, when this handler mapping does not
result in a matching handler.
</li><li class="listitem">
<code class="literal">order</code>: Based on the value of the order property (see the
<code class="literal">org.springframework.core.Ordered</code> interface), Spring will sort all handler mappings
available in the context and apply the first matching handler.
</li><li class="listitem">
<code class="literal">lazyInitHandlers</code>: Allows for lazy initialization of singleton handlers (prototype
handlers are always lazily initialized). Default value is false. This property is
directly implemented in the three concrete Handlers.
</li></ul></div>

<div class="section" title="19.5.1&nbsp;PortletModeHandlerMapping"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-handlermapping-portletmode"></a>19.5.1&nbsp;PortletModeHandlerMapping</h3></div></div></div>

<p>This is a simple handler mapping that maps incoming requests based on the current mode
of the portlet (e.g. <span class="emphasis"><em>view</em></span>, <span class="emphasis"><em>edit</em></span>, <span class="emphasis"><em>help</em></span>). An example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.handler.PortletModeHandlerMapping"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"portletModeMap"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"view"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"viewHandler"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"edit"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"editHandler"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"help"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"helpHandler"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="19.5.2&nbsp;ParameterHandlerMapping"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-handlermapping-parameter"></a>19.5.2&nbsp;ParameterHandlerMapping</h3></div></div></div>

<p>If we need to navigate around to multiple controllers without changing portlet mode, the
simplest way to do this is with a request parameter that is used as the key to control
the mapping.</p>
<p><code class="literal">ParameterHandlerMapping</code> uses the value of a specific request parameter to control the
mapping. The default name of the parameter is <code class="literal">'action'</code>, but can be changed using the
<code class="literal">'parameterName'</code> property.</p>
<p>The bean configuration for this mapping will look something like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.handler.ParameterHandlerMapping"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"parameterMap"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"add"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"addItemHandler"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"edit"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"editItemHandler"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"delete"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"deleteItemHandler"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="19.5.3&nbsp;PortletModeParameterHandlerMapping"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-handlermapping-portletmodeparameter"></a>19.5.3&nbsp;PortletModeParameterHandlerMapping</h3></div></div></div>

<p>The most powerful built-in handler mapping, <code class="literal">PortletModeParameterHandlerMapping</code>
combines the capabilities of the two previous ones to allow different navigation within
each portlet mode.</p>
<p>Again the default name of the parameter is "action", but can be changed using the
<code class="literal">parameterName</code> property.</p>
<p>By default, the same parameter value may not be used in two different portlet modes.
This is so that if the portal itself changes the portlet mode, the request will no
longer be valid in the mapping. This behavior can be changed by setting the
<code class="literal">allowDupParameters</code> property to true. However, this is not recommended.</p>
<p>The bean configuration for this mapping will look something like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.handler.PortletModeParameterHandlerMapping"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"portletModeParameterMap"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"view"</span><span class="hl-tag">&gt;</span> <span class="hl-comment">&lt;!-- </span><span class="emphasis"><em>view</em></span> portlet mode --&gt;
                <span class="hl-tag">&lt;map&gt;</span>
                    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"add"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"addItemHandler"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"edit"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"editItemHandler"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"delete"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"deleteItemHandler"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/map&gt;</span>
            <span class="hl-tag">&lt;/entry&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"edit"</span><span class="hl-tag">&gt;</span> <span class="hl-comment">&lt;!-- </span><span class="emphasis"><em>edit</em></span> portlet mode --&gt;
                <span class="hl-tag">&lt;map&gt;</span>
                    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"prefs"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"prefsHandler"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"resetPrefs"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"resetPrefsHandler"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/map&gt;</span>
            <span class="hl-tag">&lt;/entry&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This mapping can be chained ahead of a <code class="literal">PortletModeHandlerMapping</code>, which can then
provide defaults for each mode and an overall default as well.</p>
</div>
<div class="section" title="19.5.4&nbsp;Adding HandlerInterceptors"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-handlermapping-interceptor"></a>19.5.4&nbsp;Adding HandlerInterceptors</h3></div></div></div>

<p>Spring&#8217;s handler mapping mechanism has a notion of handler interceptors, which can be
extremely useful when you want to apply specific functionality to certain requests, for
example, checking for a principal. Again Spring Portlet MVC implements these concepts in
the same way as Web MVC.</p>
<p>Interceptors located in the handler mapping must implement <code class="literal">HandlerInterceptor</code> from the
<code class="literal">org.springframework.web.portlet</code> package. Just like the servlet version, this interface
defines three methods: one that will be called before the actual handler will be
executed ( <code class="literal">preHandle</code>), one that will be called after the handler is executed (
<code class="literal">postHandle</code>), and one that is called after the complete request has finished (
<code class="literal">afterCompletion</code>). These three methods should provide enough flexibility to do all
kinds of pre- and post- processing.</p>
<p>The <code class="literal">preHandle</code> method returns a boolean value. You can use this method to break or
continue the processing of the execution chain. When this method returns <code class="literal">true</code>, the
handler execution chain will continue. When it returns <code class="literal">false</code>, the <code class="literal">DispatcherPortlet</code>
assumes the interceptor itself has taken care of requests (and, for example, rendered an
appropriate view) and does not continue executing the other interceptors and the actual
handler in the execution chain.</p>
<p>The <code class="literal">postHandle</code> method is only called on a <code class="literal">RenderRequest</code>. The <code class="literal">preHandle</code> and
<code class="literal">afterCompletion</code> methods are called on both an <code class="literal">ActionRequest</code> and a <code class="literal">RenderRequest</code>.
If you need to execute logic in these methods for just one type of request, be sure to
check what kind of request it is before processing it.</p>
</div>
<div class="section" title="19.5.5&nbsp;HandlerInterceptorAdapter"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-handlermapping-interceptoradapter"></a>19.5.5&nbsp;HandlerInterceptorAdapter</h3></div></div></div>

<p>As with the servlet package, the portlet package has a concrete implementation of
<code class="literal">HandlerInterceptor</code> called <code class="literal">HandlerInterceptorAdapter</code>. This class has empty versions
of all the methods so that you can inherit from this class and implement just one or two
methods when that is all you need.</p>
</div>
<div class="section" title="19.5.6&nbsp;ParameterMappingInterceptor"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-handlermapping-parameterinterceptor"></a>19.5.6&nbsp;ParameterMappingInterceptor</h3></div></div></div>

<p>The portlet package also has a concrete interceptor named <code class="literal">ParameterMappingInterceptor</code>
that is meant to be used directly with <code class="literal">ParameterHandlerMapping</code> and
<code class="literal">PortletModeParameterHandlerMapping</code>. This interceptor will cause the parameter that is
being used to control the mapping to be forwarded from an <code class="literal">ActionRequest</code> to the
subsequent <code class="literal">RenderRequest</code>. This will help ensure that the <code class="literal">RenderRequest</code> is mapped to
the same Handler as the <code class="literal">ActionRequest</code>. This is done in the <code class="literal">preHandle</code> method of the
interceptor, so you can still modify the parameter value in your handler to change where
the <code class="literal">RenderRequest</code> will be mapped.</p>
<p>Be aware that this interceptor is calling <code class="literal">setRenderParameter</code> on the <code class="literal">ActionResponse</code>,
which means that you cannot call <code class="literal">sendRedirect</code> in your handler when using this
interceptor. If you need to do external redirects then you will either need to forward
the mapping parameter manually or write a different interceptor to handle this for you.</p>
</div>
</div>
<div class="section" title="19.6&nbsp;Views and resolving them"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-viewresolver"></a>19.6&nbsp;Views and resolving them</h2></div></div></div>

<p>As mentioned previously, Spring Portlet MVC directly reuses all the view technologies
from Spring Web MVC. This includes not only the various <code class="literal">View</code> implementations
themselves, but also the <code class="literal">ViewResolver</code> implementations. For more information, refer to
<a class="xref" href="#view" title="17.&nbsp;View technologies">Chapter&nbsp;17, <i>View technologies</i></a> and <a class="xref" href="#mvc-viewresolver" title="16.5&nbsp;Resolving views">Section&nbsp;16.5, &#8220;Resolving views&#8221;</a> respectively.</p>
<p>A few items on using the existing <code class="literal">View</code> and <code class="literal">ViewResolver</code> implementations are worth
mentioning:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Most portals expect the result of rendering a portlet to be an HTML fragment. So,
things like JSP/JSTL, Velocity, FreeMarker, and XSLT all make sense. But it is
unlikely that views that return other document types will make any sense in a portlet
context.
</li><li class="listitem">
There is no such thing as an HTTP redirect from within a portlet (the
<code class="literal">sendRedirect(..)</code> method of <code class="literal">ActionResponse</code> cannot be used to stay within the
portal). So, <code class="literal">RedirectView</code> and use of the <code class="literal">'redirect:'</code> prefix will <span class="emphasis"><em>not</em></span> work
correctly from within Portlet MVC.
</li><li class="listitem">
It may be possible to use the <code class="literal">'forward:'</code> prefix from within Portlet MVC. However,
remember that since you are in a portlet, you have no idea what the current URL looks
like. This means you cannot use a relative URL to access other resources in your web
application and that you will have to use an absolute URL.
</li></ul></div>

<p>Also, for JSP development, the new Spring Taglib and the new Spring Form Taglib both
work in portlet views in exactly the same way that they work in servlet views.</p>
</div>
<div class="section" title="19.7&nbsp;Multipart (file upload) support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-multipart"></a>19.7&nbsp;Multipart (file upload) support</h2></div></div></div>

<p>Spring Portlet MVC has built-in multipart support to handle file uploads in portlet
applications, just like Web MVC does. The design for the multipart support is done with
pluggable <code class="literal">PortletMultipartResolver</code> objects, defined in the
<code class="literal">org.springframework.web.portlet.multipart</code> package. Spring provides a
<code class="literal">PortletMultipartResolver</code> for use with
<a class="ulink" href="http://jakarta.apache.org/commons/fileupload" target="_top">Commons FileUpload</a>. How uploading files is
supported will be described in the rest of this section.</p>
<p>By default, no multipart handling will be done by Spring Portlet MVC, as some developers
will want to handle multiparts themselves. You will have to enable it yourself by adding
a multipart resolver to the web application&#8217;s context. After you have done that,
<code class="literal">DispatcherPortlet</code> will inspect each request to see if it contains a multipart. If no
multipart is found, the request will continue as expected. However, if a multipart is
found in the request, the <code class="literal">PortletMultipartResolver</code> that has been declared in your
context will be used. After that, the multipart attribute in your request will be
treated like any other attribute.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Any configured <code class="literal">PortletMultipartResolver</code> bean <span class="emphasis"><em>must</em></span> have the following id (or name):
" <code class="literal">portletMultipartResolver</code>". If you have defined your <code class="literal">PortletMultipartResolver</code> with
any other name, then the <code class="literal">DispatcherPortlet</code> will <span class="emphasis"><em>not</em></span> find your
<code class="literal">PortletMultipartResolver</code>, and consequently no multipart support will be in effect.</p>
</td></tr></table></div>

<div class="section" title="19.7.1&nbsp;Using the PortletMultipartResolver"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-multipart-resolver"></a>19.7.1&nbsp;Using the PortletMultipartResolver</h3></div></div></div>

<p>The following example shows how to use the <code class="literal">CommonsPortletMultipartResolver</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"portletMultipartResolver"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.multipart.CommonsPortletMultipartResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- one of the properties available; the maximum file size in bytes --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxUploadSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Of course you also need to put the appropriate jars in your classpath for the multipart
resolver to work. In the case of the <code class="literal">CommonsMultipartResolver</code>, you need to use
<code class="literal">commons-fileupload.jar</code>. Be sure to use at least version 1.1 of Commons FileUpload as
previous versions do not support JSR-168 Portlet applications.</p>
<p>Now that you have seen how to set Portlet MVC up to handle multipart requests, let&#8217;s
talk about how to actually use it. When <code class="literal">DispatcherPortlet</code> detects a multipart request,
it activates the resolver that has been declared in your context and hands over the
request. What the resolver then does is wrap the current <code class="literal">ActionRequest</code> in a
<code class="literal">MultipartActionRequest</code> that has support for multipart file uploads. Using the
<code class="literal">MultipartActionRequest</code> you can get information about the multiparts contained by this
request and actually get access to the multipart files themselves in your controllers.</p>
<p>Note that you can only receive multipart file uploads as part of an <code class="literal">ActionRequest</code>, not
as part of a <code class="literal">RenderRequest</code>.</p>
</div>
<div class="section" title="19.7.2&nbsp;Handling a file upload in a form"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-multipart-forms"></a>19.7.2&nbsp;Handling a file upload in a form</h3></div></div></div>

<p>After the <code class="literal">PortletMultipartResolver</code> has finished doing its job, the request will be
processed like any other. To use the <code class="literal">PortletMultipartResolver</code>, create a form with an
upload field (see example below), then let Spring bind the file onto your form (backing
object). To actually let the user upload a file, we have to create a (JSP/HTML) form:</p>
<pre class="programlisting"><span class="hl-tag">&lt;h1&gt;</span>Please upload a file<span class="hl-tag">&lt;/h1&gt;</span>
<span class="hl-tag">&lt;form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span> <span class="hl-attribute">action</span>=<span class="hl-value">"&lt;portlet:actionURL/&gt;"</span> <span class="hl-attribute">enctype</span>=<span class="hl-value">"multipart/form-data"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"file"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"file"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span></pre>

<p>As you can see, we&#8217;ve created a field named "file" that matches the property of the bean
that holds the <code class="literal">byte[]</code> array. Furthermore we&#8217;ve added the encoding attribute (
<code class="literal">enctype="multipart/form-data"</code>), which is necessary to let the browser know how to
encode the multipart fields (do not forget this!).</p>
<p>Just as with any other property that&#8217;s not automagically convertible to a string or
primitive type, to be able to put binary data in your objects you have to register a
custom editor with the <code class="literal">PortletRequestDataBinder</code>. There are a couple of editors
available for handling files and setting the results on an object. There&#8217;s a
<code class="literal">StringMultipartFileEditor</code> capable of converting files to Strings (using a user-defined
character set), and there is a <code class="literal">ByteArrayMultipartFileEditor</code> which converts files to
byte arrays. They function analogous to the <code class="literal">CustomDateEditor</code>.</p>
<p>So, to be able to upload files using a form, declare the resolver, a mapping to a
controller that will process the bean, and the controller itself.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"portletMultipartResolver"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.multipart.CommonsPortletMultipartResolver"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.handler.PortletModeHandlerMapping"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"portletModeMap"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"view"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"fileUploadController"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fileUploadController"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.FileUploadController"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"commandClass"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"examples.FileUploadBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"formView"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"fileuploadform"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"successView"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"confirmation"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>After that, create the controller and the actual class to hold the file property.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadController <span class="hl-keyword">extends</span> SimpleFormController {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onSubmitAction(ActionRequest request, ActionResponse response,
            Object command, BindException errors) <span class="hl-keyword">throws</span> Exception {

        <span class="hl-comment">// cast the bean</span>
        FileUploadBean bean = (FileUploadBean) command;

        <span class="hl-comment">// let's see if there's content there</span>
        <span class="hl-keyword">byte</span>[] file = bean.getFile();
        <span class="hl-keyword">if</span> (file == null) {
            <span class="hl-comment">// hmm, that's strange, the user did not upload anything</span>
        }

        <span class="hl-comment">// do something with the file here</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> initBinder(PortletRequest request,
            PortletRequestDataBinder binder) <span class="hl-keyword">throws</span> Exception {
        <span class="hl-comment">// to actually be able to convert Multipart instance to byte[]</span>
        <span class="hl-comment">// we have to register a custom editor</span>
        binder.registerCustomEditor(<span class="hl-keyword">byte</span>[].<span class="hl-keyword">class</span>, <span class="hl-keyword">new</span> ByteArrayMultipartFileEditor());
        <span class="hl-comment">// now Spring knows how to handle multipart object and convert</span>
    }

}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadBean {

    <span class="hl-keyword">private</span> <span class="hl-keyword">byte</span>[] file;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setFile(<span class="hl-keyword">byte</span>[] file) {
        <span class="hl-keyword">this</span>.file = file;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">byte</span>[] getFile() {
        <span class="hl-keyword">return</span> file;
    }

}</pre>

<p>As you can see, the <code class="literal">FileUploadBean</code> has a property of type <code class="literal">byte[]</code> that holds the
file. The controller registers a custom editor to let Spring know how to actually
convert the multipart objects the resolver has found to properties specified by the
bean. In this example, nothing is done with the <code class="literal">byte[]</code> property of the bean itself,
but in practice you can do whatever you want (save it in a database, mail it to
somebody, etc).</p>
<p>An equivalent example in which a file is bound straight to a String-typed property on a
form backing object might look like this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadController <span class="hl-keyword">extends</span> SimpleFormController {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onSubmitAction(ActionRequest request, ActionResponse response,
            Object command, BindException errors) <span class="hl-keyword">throws</span> Exception {

        <span class="hl-comment">// cast the bean</span>
        FileUploadBean bean = (FileUploadBean) command;

        <span class="hl-comment">// let's see if there's content there</span>
        String file = bean.getFile();
        <span class="hl-keyword">if</span> (file == null) {
            <span class="hl-comment">// hmm, that's strange, the user did not upload anything</span>
        }

        <span class="hl-comment">// do something with the file here</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> initBinder(PortletRequest request,
            PortletRequestDataBinder binder) <span class="hl-keyword">throws</span> Exception {

        <span class="hl-comment">// to actually be able to convert Multipart instance to a String</span>
        <span class="hl-comment">// we have to register a custom editor</span>
        binder.registerCustomEditor(String.<span class="hl-keyword">class</span>, <span class="hl-keyword">new</span> StringMultipartFileEditor());
        <span class="hl-comment">// now Spring knows how to handle multipart objects and convert</span>
    }
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadBean {

    <span class="hl-keyword">private</span> String file;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setFile(String file) {
        <span class="hl-keyword">this</span>.file = file;
    }

    <span class="hl-keyword">public</span> String getFile() {
        <span class="hl-keyword">return</span> file;
    }
}</pre>

<p>Of course, this last example only makes (logical) sense in the context of uploading a
plain text file (it wouldn&#8217;t work so well in the case of uploading an image file).</p>
<p>The third (and final) option is where one binds directly to a <code class="literal">MultipartFile</code> property
declared on the (form backing) object&#8217;s class. In this case one does not need to
register any custom property editor because there is no type conversion to be performed.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadController <span class="hl-keyword">extends</span> SimpleFormController {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onSubmitAction(ActionRequest request, ActionResponse response,
            Object command, BindException errors) <span class="hl-keyword">throws</span> Exception {

        <span class="hl-comment">// cast the bean</span>
        FileUploadBean bean = (FileUploadBean) command;

        <span class="hl-comment">// let's see if there's content there</span>
        MultipartFile file = bean.getFile();
        <span class="hl-keyword">if</span> (file == null) {
            <span class="hl-comment">// hmm, that's strange, the user did not upload anything</span>
        }

        <span class="hl-comment">// do something with the file here</span>
    }
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileUploadBean {

    <span class="hl-keyword">private</span> MultipartFile file;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setFile(MultipartFile file) {
        <span class="hl-keyword">this</span>.file = file;
    }

    <span class="hl-keyword">public</span> MultipartFile getFile() {
        <span class="hl-keyword">return</span> file;
    }

}</pre>

</div>
</div>
<div class="section" title="19.8&nbsp;Handling exceptions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-exceptionresolver"></a>19.8&nbsp;Handling exceptions</h2></div></div></div>

<p>Just like Servlet MVC, Portlet MVC provides <code class="literal">HandlerExceptionResolver</code> s to ease the
pain of unexpected exceptions that occur while your request is being processed by a
handler that matched the request. Portlet MVC also provides a portlet-specific, concrete
<code class="literal">SimpleMappingExceptionResolver</code> that enables you to take the class name of any
exception that might be thrown and map it to a view name.</p>
</div>
<div class="section" title="19.9&nbsp;Annotation-based controller configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-annotation"></a>19.9&nbsp;Annotation-based controller configuration</h2></div></div></div>

<p>Spring 2.5 introduced an annotation-based programming model for MVC controllers, using
annotations such as <code class="literal">@RequestMapping</code>, <code class="literal">@RequestParam</code>, <code class="literal">@ModelAttribute</code>, etc. This
annotation support is available for both Servlet MVC and Portlet MVC. Controllers
implemented in this style do not have to extend specific base classes or implement
specific interfaces. Furthermore, they do not usually have direct dependencies on
Servlet or Portlet API&#8217;s, although they can easily get access to Servlet or Portlet
facilities if desired.</p>
<p>The following sections document these annotations and how they are most commonly used in
a Portlet environment.</p>
<div class="section" title="19.9.1&nbsp;Setting up the dispatcher for annotation support"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-ann-setup"></a>19.9.1&nbsp;Setting up the dispatcher for annotation support</h3></div></div></div>

<p><span class="emphasis"><em> <code class="literal">@RequestMapping</code> will only be processed if a corresponding <code class="literal">HandlerMapping</code> (for
type level annotations) and/or <code class="literal">HandlerAdapter</code> (for method level annotations) is
present in the dispatcher.</em></span> This is the case by default in both <code class="literal">DispatcherServlet</code> and
<code class="literal">DispatcherPortlet</code>.</p>
<p>However, if you are defining custom <code class="literal">HandlerMappings</code> or <code class="literal">HandlerAdapters</code>, then you
need to make sure that a corresponding custom <code class="literal">DefaultAnnotationHandlerMapping</code> and/or
<code class="literal">AnnotationMethodHandlerAdapter</code> is defined as well - provided that you intend to use
<code class="literal">@RequestMapping</code>.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.mvc.annotation.DefaultAnnotationHandlerMapping"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.portlet.mvc.annotation.AnnotationMethodHandlerAdapter"</span><span class="hl-tag">/&gt;</span>

    // ... (controller bean definitions) ...

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Defining a <code class="literal">DefaultAnnotationHandlerMapping</code> and/or <code class="literal">AnnotationMethodHandlerAdapter</code>
explicitly also makes sense if you would like to customize the mapping strategy, e.g.
specifying a custom <code class="literal">WebBindingInitializer</code> (see below).</p>
</div>
<div class="section" title="19.9.2&nbsp;Defining a controller with @Controller"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-ann-controller"></a>19.9.2&nbsp;Defining a controller with @Controller</h3></div></div></div>

<p>The <code class="literal">@Controller</code> annotation indicates that a particular class serves the role of a
<span class="emphasis"><em>controller</em></span>. There is no need to extend any controller base class or reference the
Portlet API. You are of course still able to reference Portlet-specific features if you
need to.</p>
<p>The basic purpose of the <code class="literal">@Controller</code> annotation is to act as a stereotype for the
annotated class, indicating its role. The dispatcher will scan such annotated classes
for mapped methods, detecting <code class="literal">@RequestMapping</code> annotations (see the next section).</p>
<p>Annotated controller beans may be defined explicitly, using a standard Spring bean
definition in the dispatcher&#8217;s context. However, the <code class="literal">@Controller</code> stereotype also
allows for autodetection, aligned with Spring 2.5&#8217;s general support for detecting
component classes in the classpath and auto-registering bean definitions for them.</p>
<p>To enable autodetection of such annotated controllers, you have to add component
scanning to your configuration. This is easily achieved by using the <span class="emphasis"><em>spring-context</em></span>
schema as shown in the following XML snippet:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:p</span>=<span class="hl-value">"http://www.springframework.org/schema/p"</span>
    <span class="hl-attribute">xmlns:context</span>=<span class="hl-value">"http://www.springframework.org/schema/context"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;context:component-scan</span> <span class="hl-attribute">base-package</span>=<span class="hl-value">"org.springframework.samples.petportal.portlet"</span><span class="hl-tag">/&gt;</span>

    // ...

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="19.9.3&nbsp;Mapping requests with @RequestMapping"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-ann-requestmapping"></a>19.9.3&nbsp;Mapping requests with @RequestMapping</h3></div></div></div>

<p>The <code class="literal">@RequestMapping</code> annotation is used to map portlet modes like <span class="emphasis"><em>VIEW</em></span>/<span class="emphasis"><em>EDIT</em></span> onto an
entire class or a particular handler method. Typically the type-level annotation maps a
specific mode (or mode plus parameter condition) onto a form controller, with additional
method-level annotations <span class="emphasis"><em>narrowing</em></span> the primary mapping for specific portlet request
parameters.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@RequestMapping</code> at the type level may be used for plain implementations of the
<code class="literal">Controller</code> interface as well. In this case, the request processing code would follow
the traditional <code class="literal">handle(Action|Render)Request</code> signature, while the controller&#8217;s mapping
would be expressed through an <code class="literal">@RequestMapping</code> annotation. This works for pre-built
<code class="literal">Controller</code> base classes, such as <code class="literal">SimpleFormController</code>, too.</p>
<p>In the following discussion, we&#8217;ll focus on controllers that are based on annotated
handler methods.</p>
</td></tr></table></div>

<p>The following is an example of a form controller from the PetPortal sample application
using this annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("EDIT")</span></i>
<i><span class="hl-annotation" style="color: gray">@SessionAttributes("site")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PetSitesEditController {

    <span class="hl-keyword">private</span> Properties petSites;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPetSites(Properties petSites) {
        <span class="hl-keyword">this</span>.petSites = petSites;
    }

    <i><span class="hl-annotation" style="color: gray">@ModelAttribute("petSites")</span></i>
    <span class="hl-keyword">public</span> Properties getPetSites() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.petSites;
    }

    <i><span class="hl-annotation" style="color: gray">@RequestMapping</span></i> <span class="hl-comment">// default (action=list)</span>
    <span class="hl-keyword">public</span> String showPetSites() {
        <span class="hl-keyword">return</span> <span class="hl-string">"petSitesEdit"</span>;
    }

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(params = "action=add")</span></i> <span class="hl-comment">// render phase</span>
    <span class="hl-keyword">public</span> String showSiteForm(Model model) {
        <span class="hl-comment">// Used for the initial form as well as for redisplaying with errors.</span>
        <span class="hl-keyword">if</span> (!model.containsAttribute(<span class="hl-string">"site"</span>)) {
            model.addAttribute(<span class="hl-string">"site"</span>, <span class="hl-keyword">new</span> PetSite());
        }

        <span class="hl-keyword">return</span> <span class="hl-string">"petSitesAdd"</span>;
    }

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(params = "action=add")</span></i> <span class="hl-comment">// action phase</span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> populateSite(<i><span class="hl-annotation" style="color: gray">@ModelAttribute("site")</span></i> PetSite petSite,
            BindingResult result, SessionStatus status, ActionResponse response) {
        <span class="hl-keyword">new</span> PetSiteValidator().validate(petSite, result);
        <span class="hl-keyword">if</span> (!result.hasErrors()) {
            <span class="hl-keyword">this</span>.petSites.put(petSite.getName(), petSite.getUrl());
            status.setComplete();
            response.setRenderParameter(<span class="hl-string">"action"</span>, <span class="hl-string">"list"</span>);
        }
    }

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(params = "action=delete")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> removeSite(<i><span class="hl-annotation" style="color: gray">@RequestParam("site")</span></i> String site, ActionResponse response) {
        <span class="hl-keyword">this</span>.petSites.remove(site);
        response.setRenderParameter(<span class="hl-string">"action"</span>, <span class="hl-string">"list"</span>);
    }
}</pre>

</div>
<div class="section" title="19.9.4&nbsp;Supported handler method arguments"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-ann-requestmapping-arguments"></a>19.9.4&nbsp;Supported handler method arguments</h3></div></div></div>

<p>Handler methods which are annotated with <code class="literal">@RequestMapping</code> are allowed to have very
flexible signatures. They may have arguments of the following types, in arbitrary order
(except for validation results, which need to follow right after the corresponding
command object, if desired):</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Request and/or response objects (Portlet API). You may choose any specific
request/response type, e.g. PortletRequest / ActionRequest / RenderRequest. An
explicitly declared action/render argument is also used for mapping specific request
types onto a handler method (in case of no other information given that differentiates
between action and render requests).
</li><li class="listitem">
Session object (Portlet API): of type PortletSession. An argument of this type will
enforce the presence of a corresponding session. As a consequence, such an argument
will never be <code class="literal">null</code>.
</li><li class="listitem">
<code class="literal">org.springframework.web.context.request.WebRequest</code> or
<code class="literal">org.springframework.web.context.request.NativeWebRequest</code>. Allows for generic request
parameter access as well as request/session attribute access, without ties to the
native Servlet/Portlet API.
</li><li class="listitem">
<code class="literal">java.util.Locale</code> for the current request locale (the portal locale in a Portlet
environment).
</li><li class="listitem">
<code class="literal">java.util.TimeZone</code> / <code class="literal">java.time.ZoneId</code> for the current request time zone.
</li><li class="listitem">
<code class="literal">java.io.InputStream</code> / <code class="literal">java.io.Reader</code> for access to the request&#8217;s content. This
will be the raw InputStream/Reader as exposed by the Portlet API.
</li><li class="listitem">
<code class="literal">java.io.OutputStream</code> / <code class="literal">java.io.Writer</code> for generating the response&#8217;s content. This
will be the raw OutputStream/Writer as exposed by the Portlet API.
</li><li class="listitem">
<code class="literal">@RequestParam</code> annotated parameters for access to specific Portlet request
parameters. Parameter values will be converted to the declared method argument type.
</li><li class="listitem">
<code class="literal">java.util.Map</code> / <code class="literal">org.springframework.ui.Model</code> / <code class="literal">org.springframework.ui.ModelMap</code>
for enriching the implicit model that will be exposed to the web view.
</li><li class="listitem">
Command/form objects to bind parameters to: as bean properties or fields, with
customizable type conversion, depending on <code class="literal">@InitBinder</code> methods and/or the
HandlerAdapter configuration - see the " <code class="literal">webBindingInitializer</code>" property on
<code class="literal">AnnotationMethodHandlerAdapter</code>. Such command objects along with their validation
results will be exposed as model attributes, by default using the non-qualified
command class name in property notation (e.g. "orderAddress" for type
"mypackage.OrderAddress"). Specify a parameter-level <code class="literal">ModelAttribute</code> annotation for
declaring a specific model attribute name.
</li><li class="listitem">
<code class="literal">org.springframework.validation.Errors</code> /
<code class="literal">org.springframework.validation.BindingResult</code> validation results for a preceding
command/form object (the immediate preceding argument).
</li><li class="listitem">
<code class="literal">org.springframework.web.bind.support.SessionStatus</code> status handle for marking form
processing as complete (triggering the cleanup of session attributes that have been
indicated by the <code class="literal">@SessionAttributes</code> annotation at the handler type level).
</li></ul></div>

<p>The following return types are supported for handler methods:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
A <code class="literal">ModelAndView</code> object, with the model implicitly enriched with command objects and
the results of <code class="literal">@ModelAttribute</code> annotated reference data accessor methods.
</li><li class="listitem">
A <code class="literal">Model</code> object, with the view name implicitly determined through a
<code class="literal">RequestToViewNameTranslator</code> and the model implicitly enriched with command objects
and the results of <code class="literal">@ModelAttribute</code> annotated reference data accessor methods.
</li><li class="listitem">
A <code class="literal">Map</code> object for exposing a model, with the view name implicitly determined through
a <code class="literal">RequestToViewNameTranslator</code> and the model implicitly enriched with command objects
and the results of <code class="literal">@ModelAttribute</code> annotated reference data accessor methods.
</li><li class="listitem">
A <code class="literal">View</code> object, with the model implicitly determined through command objects and
<code class="literal">@ModelAttribute</code> annotated reference data accessor methods. The handler method may
also programmatically enrich the model by declaring a <code class="literal">Model</code> argument (see above).
</li><li class="listitem">
A <code class="literal">String</code> value which is interpreted as view name, with the model implicitly
determined through command objects and <code class="literal">@ModelAttribute</code> annotated reference data
accessor methods. The handler method may also programmatically enrich the model by
declaring a <code class="literal">Model</code> argument (see above).
</li><li class="listitem">
<code class="literal">void</code> if the method handles the response itself (e.g. by writing the response content
directly).
</li><li class="listitem">
Any other return type will be considered a single model attribute to be exposed to the
view, using the attribute name specified through <code class="literal">@ModelAttribute</code> at the method level
(or the default attribute name based on the return type&#8217;s class name otherwise). The
model will be implicitly enriched with command objects and the results of
<code class="literal">@ModelAttribute</code> annotated reference data accessor methods.
</li></ul></div>

</div>
<div class="section" title="19.9.5&nbsp;Binding request parameters to method parameters with @RequestParam"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-ann-requestparam"></a>19.9.5&nbsp;Binding request parameters to method parameters with @RequestParam</h3></div></div></div>

<p>The <code class="literal">@RequestParam</code> annotation is used to bind request parameters to a method parameter
in your controller.</p>
<p>The following code snippet from the PetPortal sample application shows the usage:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("EDIT")</span></i>
<i><span class="hl-annotation" style="color: gray">@SessionAttributes("site")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PetSitesEditController {

    <span class="hl-comment">// ...</span>

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> removeSite(<i><span class="hl-annotation" style="color: gray">@RequestParam("site")</span></i> String site, ActionResponse response) {
        <span class="hl-keyword">this</span>.petSites.remove(site);
        response.setRenderParameter(<span class="hl-string">"action"</span>, <span class="hl-string">"list"</span>);
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>Parameters using this annotation are required by default, but you can specify that a
parameter is optional by setting <code class="literal">@RequestParam</code>'s <code class="literal">required</code> attribute to <code class="literal">false</code>
(e.g., <code class="literal">@RequestParam(value="id", required=false)</code>).</p>
</div>
<div class="section" title="19.9.6&nbsp;Providing a link to data from the model with @ModelAttribute"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-ann-modelattrib"></a>19.9.6&nbsp;Providing a link to data from the model with @ModelAttribute</h3></div></div></div>

<p><code class="literal">@ModelAttribute</code> has two usage scenarios in controllers. When placed on a method
parameter, <code class="literal">@ModelAttribute</code> is used to map a model attribute to the specific, annotated
method parameter (see the <code class="literal">populateSite()</code> method below). This is how the controller
gets a reference to the object holding the data entered in the form. In addition, the
parameter can be declared as the specific type of the form backing object rather than as
a generic <code class="literal">java.lang.Object</code>, thus increasing type safety.</p>
<p><code class="literal">@ModelAttribute</code> is also used at the method level to provide <span class="emphasis"><em>reference data</em></span> for the
model (see the <code class="literal">getPetSites()</code> method below). For this usage the method signature can
contain the same types as documented above for the <code class="literal">@RequestMapping</code> annotation.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@ModelAttribute</code> annotated methods will be executed <span class="emphasis"><em>before</em></span> the chosen
<code class="literal">@RequestMapping</code> annotated handler method. They effectively pre-populate the implicit
model with specific attributes, often loaded from a database. Such an attribute can then
already be accessed through <code class="literal">@ModelAttribute</code> annotated handler method parameters in the
chosen handler method, potentially with binding and validation applied to it.</p>
</td></tr></table></div>

<p>The following code snippet shows these two usages of this annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("EDIT")</span></i>
<i><span class="hl-annotation" style="color: gray">@SessionAttributes("site")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PetSitesEditController {

    <span class="hl-comment">// ...</span>

    <i><span class="hl-annotation" style="color: gray">@ModelAttribute("petSites")</span></i>
    <span class="hl-keyword">public</span> Properties getPetSites() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.petSites;
    }

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(params = "action=add")</span></i> <span class="hl-comment">// action phase</span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> populateSite( <i><span class="hl-annotation" style="color: gray">@ModelAttribute("site")</span></i> PetSite petSite, BindingResult result, SessionStatus status, ActionResponse response) {
        <span class="hl-keyword">new</span> PetSiteValidator().validate(petSite, result);
        <span class="hl-keyword">if</span> (!result.hasErrors()) {
            <span class="hl-keyword">this</span>.petSites.put(petSite.getName(), petSite.getUrl());
            status.setComplete();
            response.setRenderParameter(<span class="hl-string">"action"</span>, <span class="hl-string">"list"</span>);
        }
    }
}</pre>

</div>
<div class="section" title="19.9.7&nbsp;Specifying attributes to store in a Session with @SessionAttributes"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-ann-sessionattrib"></a>19.9.7&nbsp;Specifying attributes to store in a Session with @SessionAttributes</h3></div></div></div>

<p>The type-level <code class="literal">@SessionAttributes</code> annotation declares session attributes used by a
specific handler. This will typically list the names of model attributes or types of
model attributes which should be transparently stored in the session or some
conversational storage, serving as form-backing beans between subsequent requests.</p>
<p>The following code snippet shows the usage of this annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<i><span class="hl-annotation" style="color: gray">@RequestMapping("EDIT")</span></i>
<i><span class="hl-annotation" style="color: gray">@SessionAttributes("site")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PetSitesEditController {
    <span class="hl-comment">// ...</span>
}</pre>

</div>
<div class="section" title="19.9.8&nbsp;Customizing WebDataBinder initialization"><div class="titlepage"><div><div><h3 class="title"><a name="portlet-ann-webdatabinder"></a>19.9.8&nbsp;Customizing WebDataBinder initialization</h3></div></div></div>

<p>To customize request parameter binding with PropertyEditors, etc. via Spring&#8217;s
<code class="literal">WebDataBinder</code>, you can either use <code class="literal">@InitBinder</code>-annotated methods within your
controller or externalize your configuration by providing a custom
<code class="literal">WebBindingInitializer</code>.</p>
<div class="section" title="Customizing data binding with @InitBinder"><div class="titlepage"><div><div><h4 class="title"><a name="portlet-ann-initbinder"></a>Customizing data binding with @InitBinder</h4></div></div></div>

<p>Annotating controller methods with <code class="literal">@InitBinder</code> allows you to configure web data
binding directly within your controller class. <code class="literal">@InitBinder</code> identifies methods which
initialize the <code class="literal">WebDataBinder</code> which will be used for populating command and form object
arguments of annotated handler methods.</p>
<p>Such init-binder methods support all arguments that <code class="literal">@RequestMapping</code> supports, except
for command/form objects and corresponding validation result objects. Init-binder
methods must not have a return value. Thus, they are usually declared as <code class="literal">void</code>. Typical
arguments include <code class="literal">WebDataBinder</code> in combination with <code class="literal">WebRequest</code> or
<code class="literal">java.util.Locale</code>, allowing code to register context-specific editors.</p>
<p>The following example demonstrates the use of <code class="literal">@InitBinder</code> for configuring a
<code class="literal">CustomDateEditor</code> for all <code class="literal">java.util.Date</code> form properties.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFormController {

    <i><span class="hl-annotation" style="color: gray">@InitBinder</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> initBinder(WebDataBinder binder) {
    SimpleDateFormat dateFormat = <span class="hl-keyword">new</span> SimpleDateFormat(<span class="hl-string">"yyyy-MM-dd"</span>);
        dateFormat.setLenient(false);
        binder.registerCustomEditor(Date.<span class="hl-keyword">class</span>, <span class="hl-keyword">new</span> CustomDateEditor(dateFormat, false));
    }

    <span class="hl-comment">// ...</span>

}</pre>

</div>
<div class="section" title="Configuring a custom WebBindingInitializer"><div class="titlepage"><div><div><h4 class="title"><a name="portlet-ann-webbindinginitializer"></a>Configuring a custom WebBindingInitializer</h4></div></div></div>

<p>To externalize data binding initialization, you can provide a custom implementation of
the <code class="literal">WebBindingInitializer</code> interface, which you then enable by supplying a custom bean
configuration for an <code class="literal">AnnotationMethodHandlerAdapter</code>, thus overriding the default
configuration.</p>
</div>
</div>
</div>
<div class="section" title="19.10&nbsp;Portlet application deployment"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="portlet-deployment"></a>19.10&nbsp;Portlet application deployment</h2></div></div></div>

<p>The process of deploying a Spring Portlet MVC application is no different than deploying
any JSR-168 Portlet application. However, this area is confusing enough in general that
it is worth talking about here briefly.</p>
<p>Generally, the portal/portlet container runs in one webapp in your servlet container and
your portlets run in another webapp in your servlet container. In order for the portlet
container webapp to make calls into your portlet webapp it must make cross-context calls
to a well-known servlet that provides access to the portlet services defined in your
<code class="literal">portlet.xml</code> file.</p>
<p>The JSR-168 specification does not specify exactly how this should happen, so each
portlet container has its own mechanism for this, which usually involves some kind of
"deployment process" that makes changes to the portlet webapp itself and then registers
the portlets within the portlet container.</p>
<p>At a minimum, the <code class="literal">web.xml</code> file in your portlet webapp is modified to inject the
well-known servlet that the portlet container will call. In some cases a single servlet
will service all portlets in the webapp, in other cases there will be an instance of the
servlet for each portlet.</p>
<p>Some portlet containers will also inject libraries and/or configuration files into the
webapp as well. The portlet container must also make its implementation of the Portlet
JSP Tag Library available to your webapp.</p>
<p>The bottom line is that it is important to understand the deployment needs of your
target portal and make sure they are met (usually by following the automated deployment
process it provides). Be sure to carefully review the documentation from your portal for
this process.</p>
<p>Once you have deployed your portlet, review the resulting <code class="literal">web.xml</code> file for sanity.
Some older portals have been known to corrupt the definition of the
<code class="literal">ViewRendererServlet</code>, thus breaking the rendering of your portlets.</p>
</div>
</div>
<div class="chapter" title="20.&nbsp;WebSocket Support"><div class="titlepage"><div><div><h2 class="title"><a name="websocket"></a>20.&nbsp;WebSocket Support</h2></div></div></div>

<p>This part of the reference documentation covers Spring Framework&#8217;s support for
WebSocket-style messaging in web applications including use of STOMP as an
application level WebSocket sub-protocol.</p>
<p><a class="xref" href="#websocket-intro" title="20.1&nbsp;Introduction">Section&nbsp;20.1, &#8220;Introduction&#8221;</a> establishes a frame of mind in which to think about
WebSocket, covering adoption challenges, design considerations, and thoughts on
when it is a good fit.</p>
<p><a class="xref" href="#websocket-server" title="20.2&nbsp;WebSocket Server">Section&nbsp;20.2, &#8220;WebSocket Server&#8221;</a> reviews the Spring WebSocket API on the
server-side while <a class="xref" href="#websocket-fallback" title="20.3&nbsp;Fallback Options">Section&nbsp;20.3, &#8220;Fallback Options&#8221;</a> explains the SockJS protocol and shows
how to configure and use it.</p>
<p><a class="xref" href="#websocket-stomp-overview" title="20.4.1&nbsp;Overview of STOMP">Section&nbsp;20.4.1, &#8220;Overview of STOMP&#8221;</a> introduces the STOMP messaging protocol.
<a class="xref" href="#websocket-stomp-enable" title="20.4.2&nbsp;Enable STOMP (over WebSocket)">Section&nbsp;20.4.2, &#8220;Enable STOMP (over WebSocket)&#8221;</a> demonstrates how to configure STOMP support in Spring.
<a class="xref" href="#websocket-stomp-handle" title="20.4.3&nbsp;Overview of STOMP Message Handling">Section&nbsp;20.4.3, &#8220;Overview of STOMP Message Handling&#8221;</a> explains how to use it including writing annotated message
handling methods, sending messages, choosing message broker options, as
well as working with the special "user" destinations. Finally
<a class="xref" href="#websocket-stomp-testing" title="Testing Message Handling Controllers">the section called &#8220;Testing Message Handling Controllers&#8221;</a> lists three approaches to testing STOMP/WebSocket
applications.</p>
<div class="section" title="20.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-intro"></a>20.1&nbsp;Introduction</h2></div></div></div>

<p>The WebSocket protocol <a class="ulink" href="http://tools.ietf.org/html/rfc6455" target="_top">RFC 6455</a> defines an important
new capability for web applications: full-duplex, two-way communication between client
and server. It is an exciting new capability on the heels of a long history of
techniques to make the web more interactive including Java applets, XMLHttpRequest,
Adobe Flash, ActiveXObject, various Comet techniques, server-sent events, and others.</p>
<p>A proper introduction of the WebSocket protocol is beyond the scope of this
document. At a minimum however it&#8217;s important to understand that HTTP is used only for
the initial handshake, which relies on a mechanism built into HTTP to request
a protocol upgrade (or in this case a protocol switch) to which the server can respond with
HTTP status 101 (switching protocols) if it agrees. Assuming the handshake succeeds
the TCP socket underlying the HTTP upgrade request remains open and both client and
server can use it to send messages to each other.</p>
<p>Spring Framework 4 includes a new <code class="literal">spring-websocket</code> module with comprehensive
WebSocket support. It is compatible with the Java WebSocket API standard
(<a class="ulink" href="http://jcp.org/en/jsr/detail?id=356" target="_top">JSR-356</a>)
and also provides additional value-add as explained in the rest of the introduction.</p>
<div class="section" title="20.1.1&nbsp;Fallback Options"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-into-fallback-options"></a>20.1.1&nbsp;Fallback Options</h3></div></div></div>

<p>An important challenge to adoption is the lack of support for WebSocket in some
browsers. Notably the first Internet Explorer version to support WebSocket is
version 10 (see <a class="ulink" href="http://caniuse.com/websockets" target="_top">http://caniuse.com/websockets</a> for support by browser versions).
Furthermore, some restrictive proxies
may be configured in ways that either preclude the attempt to do HTTP upgrade
or otherwise break connection after some time because it has remained opened
for too long. A good overview on this topic from Peter Lubbers is available in
the InfoQ article
<a class="ulink" href="http://www.infoq.com/articles/Web-Sockets-Proxy-Servers" target="_top">"How HTML5 Web Sockets Interact With Proxy Servers"</a>.</p>
<p>Therefore to build a WebSocket application today, fallback options are required
to simulate the WebSocket API where necessary.
Spring Framework provides such transparent fallback
options based on the <a class="ulink" href="https://github.com/sockjs/sockjs-protocol" target="_top">SockJS protocol</a>.
These options can be enabled through configuration and do not require
modifying the application otherwise.</p>
</div>
<div class="section" title="20.1.2&nbsp;Messaging Architecture"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-intro-architecture"></a>20.1.2&nbsp;Messaging Architecture</h3></div></div></div>

<p>Aside from short-to-midterm adoption challenges, using WebSocket
brings up important design considerations that are important to recognize
early on, especially in contrast to what we know about building web applications today.</p>
<p>Today REST is a widely accepted, understood, and supported
architecture for building web applications. It is an architecture that relies
on having many URLs (<span class="emphasis"><em>nouns</em></span>), a handful of HTTP methods (<span class="emphasis"><em>verbs</em></span>), and
other principles such as using hypermedia (<span class="emphasis"><em>links</em></span>), remaining stateless, etc.</p>
<p>By contrast a WebSocket application may use a single URL only for the
initial HTTP handshake. All messages thereafter share and flow on the
same TCP connection. This points to an entirely different, asynchronous,
event-driven, messaging architecture. One that is much closer
to traditional messaging applications (e.g. JMS, AMQP).</p>
<p>Spring Framework 4 includes a new <code class="literal">spring-messaging</code> module with key
abstractions from the
<a class="ulink" href="http://projects.spring.io/spring-integration/" target="_top">Spring Integration</a> project
such as <code class="literal">Message</code>, <code class="literal">MessageChannel</code>, <code class="literal">MessageHandler</code> and others that can serve as
a foundation for such a messaging architecture. The module also includes a
set of annotations for mapping messages to methods, similar to the Spring MVC
annotation based programming model.</p>
</div>
<div class="section" title="20.1.3&nbsp;Sub-Protocol Support"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-intro-sub-protocol"></a>20.1.3&nbsp;Sub-Protocol Support</h3></div></div></div>

<p>WebSocket does imply a <span class="emphasis"><em>messaging architecture</em></span> but does not mandate the
use of any specific <span class="emphasis"><em>messaging protocol</em></span>. It is a very thin layer over TCP
that transforms a stream of bytes into a stream of messages
(either text or binary) and not much more. It is up to applications
to interpret the meaning of a message.</p>
<p>Unlike HTTP, which is an application-level protocol, in the WebSocket protocol
there is simply not enough information in an incoming message for a framework
or container to know how to route it or process it. Therefore WebSocket is arguably
too low level for anything but a very trivial application. It can be done, but
it will likely lead to creating a framework on top. This is comparable to how
most web applications today are written using a web framework rather than the
Servlet API alone.</p>
<p>For this reason the WebSocket RFC defines the use of
<a class="ulink" href="http://tools.ietf.org/html/rfc6455#section-1.9" target="_top">sub-protocols</a>.
During the handshake, client and server can use the header
<code class="literal">Sec-WebSocket-Protocol</code> to agree on a sub-protocol, i.e. a higher, application-level
protocol to use. The use of a sub-protocol is not required, but
even if not used, applications will still need to choose a message
format that both client and server can understand. That format can be custom,
framework-specific, or a standard messaging protocol.</p>
<p>Spring Framework provides support for using
<a class="ulink" href="http://stomp.github.io/stomp-specification-1.2.html#Abstract" target="_top">STOMP</a>&#8201;&#8212;&#8201;a simple, messaging protocol
originally created for use in scripting languages with frames inspired
by HTTP. STOMP is widely support and well suited for use over
WebSocket and over the web.</p>
</div>
<div class="section" title="20.1.4&nbsp;When To Use WebSocket?"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-intro-when-to-use"></a>20.1.4&nbsp;When To Use WebSocket?</h3></div></div></div>

<p>With all the design considerations surrounding the use of WebSocket, it is
reasonable to ask when is it appropriate to use?</p>
<p>The best fit for WebSocket is in web applications where client and
server need to exchange events at high frequency and at low latency. Prime
candidates include but are not limited to applications in finance, games,
collaboration, and others. Such applications are both very sensitive to time
delays and also need to exchange a wide variety of messages at high
frequency.</p>
<p>For other application types, however, this may not be the case.
For example, a news or social feed that shows breaking news as they become
available may be perfectly okay with simple polling once every few minutes.
Here latency is important, but it is acceptable if the news takes a
few minutes to appear.</p>
<p>Even in cases where latency is crucial, if the volume of messages is
relatively low (e.g. monitoring network failures) the use of
<a class="ulink" href="http://spring.io/blog/2012/05/08/spring-mvc-3-2-preview-techniques-for-real-time-updates" target="_top">long polling</a>
should be considered as a relatively simple alternative that
works reliably and is comparable by efficiency (again assuming the volume of
messages is relatively low).</p>
<p>It is the combination of both low latency and high frequency of messages that can make
the use of the WebSocket protocol critical. Even in such applications,
the choice remains whether all client-server
communication should be done through WebSocket messages as opposed to using
HTTP and REST? The answer is going to vary by application, however, it is likely
that some functionality may be exposed over both WebSocket and as a REST API in
order to provide clients with alternatives. Furthermore, a REST API call may need
to broadcast a message to interested clients connected via WebSocket.</p>
<p>Spring Framework allows <code class="literal">@Controller</code> classes to have both
HTTP request handling and WebSocket message handling methods.
Furthermore, a Spring MVC request handling method, or any application
method for that matter, can easily broadcast a message to all interested
WebSocket clients or to a specific user.</p>
</div>
</div>
<div class="section" title="20.2&nbsp;WebSocket Server"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-server"></a>20.2&nbsp;WebSocket Server</h2></div></div></div>

<p>The Spring Framework provides a WebSocket API designed to adapt to various WebSocket engines.
For example, it runs on JSR-356 runtimes such as Tomcat (7.0.47+) and GlassFish (4.0+) but
can also adapt to other WebSocket runtimes such as the Jetty (9.0+) native WebSocket support.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As explained in the <a class="link" href="#websocket-intro-sub-protocol" title="20.1.3&nbsp;Sub-Protocol Support">introduction</a>, direct use of a
WebSocket API is too low level for applications&#8201;&#8212;&#8201;until assumptions are made about the
format of a message there is little a framework can do to interpret messages or route
them via annotations. This is why applications should consider using a sub-protocol
and Spring&#8217;s <a class="link" href="#websocket-stomp" title="20.4&nbsp;STOMP Messaging">STOMP over WebSocket</a> support.</p>
<p>When using a higher level protocol, the details of the WebSocket API become less
relevant, much like the details of TCP communication are not exposed to applications
when using HTTP. Nevertheless this section covers the details of using WebSocket
directly.</p>
</td></tr></table></div>

<div class="section" title="20.2.1&nbsp;Create and Configure a WebSocketHandler"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-server-handler"></a>20.2.1&nbsp;Create and Configure a WebSocketHandler</h3></div></div></div>

<p>Creating a WebSocket server is as simple as implementing <code class="literal">WebSocketHandler</code> or more
likely extending either <code class="literal">TextWebSocketHandler</code> or <code class="literal">BinaryWebSocketHandler</code>:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.web.socket.WebSocketHandler;
<span class="hl-keyword">import</span> org.springframework.web.socket.WebSocketSession;
<span class="hl-keyword">import</span> org.springframework.web.socket.TextMessage;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyHandler <span class="hl-keyword">extends</span> TextWebSocketHandler {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleTextMessage(WebSocketSession session, TextMessage message) {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<p>There is dedicated WebSocket Java-config and XML namespace support for mapping the above
WebSocket handler at a specific URL:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;
<span class="hl-keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketConfigurer;
<span class="hl-keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebSocket</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketConfig <span class="hl-keyword">implements</span> WebSocketConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(myHandler(), <span class="hl-string">"/myHandler"</span>);
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> WebSocketHandler myHandler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MyHandler();
    }

}</pre>

<p>XML configuration equivalent:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/websocket"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/websocket
        http://www.springframework.org/schema/websocket/spring-websocket-4.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;websocket:handlers&gt;</span>
        <span class="hl-tag">&lt;websocket:mapping</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myHandler"</span> <span class="hl-attribute">handler</span>=<span class="hl-value">"myHandler"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/websocket:handlers&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myHandler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MyHandler"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The above is for use in Spring MVC applications and should be included in the
configuration of a <a class="link" href="#">DispatcherServlet</a>. However, Spring&#8217;s WebSocket
support does not depend on Spring MVC. It is relatively simple to integrate a <code class="literal">WebSocketHandler</code>
into other HTTP serving environments with the help of
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/socket/server/support/WebSocketHttpRequestHandler.html" target="_top">WebSocketHttpRequestHandler</a>.</p>
</div>
<div class="section" title="20.2.2&nbsp;Customizing the WebSocket Handshake"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-server-handshake"></a>20.2.2&nbsp;Customizing the WebSocket Handshake</h3></div></div></div>

<p>The easiest way to customize the initial HTTP WebSocket handshake request is through
a <code class="literal">HandshakeInterceptor</code>, which exposes "before" and "after" the handshake methods.
Such an interceptor can be used to preclude the handshake or to make any attributes
available to the <code class="literal">WebSocketSession</code>. For example, there is a built-in interceptor
for passing HTTP session attributes to the WebSocket session:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebSocket</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketConfig <span class="hl-keyword">implements</span> WebSocketConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(<span class="hl-keyword">new</span> MyHandler(), <span class="hl-string">"/myHandler"</span>)
            .addInterceptors(<span class="hl-keyword">new</span> HttpSessionHandshakeInterceptor());
    }

}</pre>

<p>And the XML configuration equivalent:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/websocket"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/websocket
        http://www.springframework.org/schema/websocket/spring-websocket-4.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;websocket:handlers&gt;</span>
        <span class="hl-tag">&lt;websocket:mapping</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myHandler"</span> <span class="hl-attribute">handler</span>=<span class="hl-value">"myHandler"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;websocket:handshake-interceptors&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.socket.server.support.HttpSessionHandshakeInterceptor"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/websocket:handshake-interceptors&gt;</span>
    <span class="hl-tag">&lt;/websocket:handlers&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myHandler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MyHandler"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>A more advanced option is to extend the <code class="literal">DefaultHandshakeHandler</code> that performs
the steps of the WebSocket handshake, including validating the client origin,
negotiating a sub-protocol, and others. An application may also need to use this
option if it needs to configure a custom <code class="literal">RequestUpgradeStrategy</code> in order to
adapt to a WebSocket server engine and version that is not yet supported
(also see <a class="xref" href="#websocket-server-deployment" title="20.2.4&nbsp;Deployment Considerations">Section&nbsp;20.2.4, &#8220;Deployment Considerations&#8221;</a> for more on this subject).
Both the Java-config and XML namespace make it possible to configure a custom
<code class="literal">HandshakeHandler</code>.</p>
</div>
<div class="section" title="20.2.3&nbsp;WebSocketHandler Decoration"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-server-decorators"></a>20.2.3&nbsp;WebSocketHandler Decoration</h3></div></div></div>

<p>Spring provides a <code class="literal">WebSocketHandlerDecorator</code> base class that can be used to decorate
a <code class="literal">WebSocketHandler</code> with additional behavior. Logging and exception handling
implementations are provided and added by default when using the WebSocket Java-config
or XML namespace. The <code class="literal">ExceptionWebSocketHandlerDecorator</code> catches all uncaught
exceptions arising from any WebSocketHandler method and closes the WebSocket
session with status <code class="literal">1011</code> that indicates a server error.</p>
</div>
<div class="section" title="20.2.4&nbsp;Deployment Considerations"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-server-deployment"></a>20.2.4&nbsp;Deployment Considerations</h3></div></div></div>

<p>The Spring WebSocket API is easy to integrate into a Spring MVC application where
the <code class="literal">DispatcherServlet</code> serves both HTTP WebSocket handshake as well as other
HTTP requests. It is also easy to integrate into other HTTP processing scenarios
by invoking <code class="literal">WebSocketHttpRequestHandler</code>. This is convenient and easy to
understand. However, special considerations apply with regards to JSR-356 runtimes.</p>
<p>The Java WebSocket API (JSR-356) provides two deployment mechanisms. The first
involves a Servlet container classpath scan (Servlet 3 feature) at startup; and
the other is a registration API to use at Servlet container initialization.
Neither of these mechanism make it possible to use a single "front controller"
for all HTTP processing&#8201;&#8212;&#8201;including WebSocket handshake and all other HTTP
requests&#8201;&#8212;&#8201;such as Spring MVC&#8217;s <code class="literal">DispatcherServlet</code>.</p>
<p>This is a significant limitation of JSR-356 that Spring&#8217;s WebSocket support
addresses by providing a server-specific <code class="literal">RequestUpgradeStrategy</code> even when
running in a JSR-356 runtime. At present such support is available on
Tomcat 7.0.47+, Jetty 9.0+, and GlassFish 4.0+. Additional support will be
added as more WebSocket runtimes become available.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A request to overcome the above limitation in the Java WebSocket API has been
created and can be followed at
<a class="ulink" href="https://java.net/jira/browse/WEBSOCKET_SPEC-211" target="_top">WEBSOCKET_SPEC-211</a>.
Also note that Tomcat and Jetty already provide native API alternatives that
makes it easy to overcome the limitation. We are hopeful that more servers
will follow their example regardless of when it is addressed in the
Java WebSocket API.</p>
</td></tr></table></div>

<p>A secondary consideration is that Servlet containers with JSR-356 support
are expected to perform an SCI scan that can slow down application startup,
in some cases dramatically. If a significant impact is observed after an
upgrade to a Servlet container version with JSR-356 support, it should
be possible to selectively enable or disable web fragments (and SCI scanning)
through the use of an <code class="literal">&lt;absolute-ordering /&gt;</code> element in <code class="literal">web.xml</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://java.sun.com/xml/ns/javaee
        http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span>
    <span class="hl-attribute">version</span>=<span class="hl-value">"3.0"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;absolute-ordering/&gt;</span>

<span class="hl-tag">&lt;/web-app&gt;</span></pre>

<p>You can then selectively enable web fragments by name, such as Spring&#8217;s own
<code class="literal">SpringServletContainerInitializer</code> that provides support for the Servlet 3
Java initialization API, if required:</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://java.sun.com/xml/ns/javaee
        http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span>
    <span class="hl-attribute">version</span>=<span class="hl-value">"3.0"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;absolute-ordering&gt;</span>
        <span class="hl-tag">&lt;name&gt;</span>spring_web<span class="hl-tag">&lt;/name&gt;</span>
    <span class="hl-tag">&lt;/absolute-ordering&gt;</span>

<span class="hl-tag">&lt;/web-app&gt;</span></pre>

</div>
<div class="section" title="20.2.5&nbsp;Configuring the WebSocket Engine"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-server-runtime-configuration"></a>20.2.5&nbsp;Configuring the WebSocket Engine</h3></div></div></div>

<p>Each underlying WebSocket engine exposes configuration properties that control
runtime characteristics such as the size of message buffer sizes, idle timeout,
and others.</p>
<p>For Tomcat, WildFly, and Glassfish add a <code class="literal">WebSocketContainerFactoryBean</code> to your
WebSocket Java config:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebSocket</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketConfig <span class="hl-keyword">implements</span> WebSocketConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> WebSocketContainerFactoryBean createWebSocketContainer() {
        WebSocketContainerFactoryBean container = <span class="hl-keyword">new</span> WebSocketContainerFactoryBean();
        container.setMaxTextMessageBufferSize(<span class="hl-number">8192</span>);
        container.setMaxBinaryMessageBufferSize(<span class="hl-number">8192</span>);
        <span class="hl-keyword">return</span> container;
    }

}</pre>

<p>or WebSocket XML namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/websocket"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/websocket
        http://www.springframework.org/schema/websocket/spring-websocket.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework...WebSocketContainerFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxTextMessageBufferSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"8192"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxBinaryMessageBufferSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"8192"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>For Jetty, you&#8217;ll need to supply a pre-configured Jetty <code class="literal">WebSocketServerFactory</code> and plug
that into Spring&#8217;s <code class="literal">DefaultHandshakeHandler</code> through your WebSocket Java config:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebSocket</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketConfig <span class="hl-keyword">implements</span> WebSocketConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(echoWebSocketHandler(),
            <span class="hl-string">"/echo"</span>).setHandshakeHandler(handshakeHandler());
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> DefaultHandshakeHandler handshakeHandler() {

        WebSocketPolicy policy = <span class="hl-keyword">new</span> WebSocketPolicy(WebSocketBehavior.SERVER);
        policy.setInputBufferSize(<span class="hl-number">8192</span>);
        policy.setIdleTimeout(<span class="hl-number">600000</span>);

        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultHandshakeHandler(
                <span class="hl-keyword">new</span> JettyRequestUpgradeStrategy(<span class="hl-keyword">new</span> WebSocketServerFactory(policy)));
    }

}</pre>

<p>or WebSocket XML namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/websocket"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/websocket
        http://www.springframework.org/schema/websocket/spring-websocket.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;websocket:handlers&gt;</span>
        <span class="hl-tag">&lt;websocket:mapping</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/echo"</span> <span class="hl-attribute">handler</span>=<span class="hl-value">"echoHandler"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;websocket:handshake-handler</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"handshakeHandler"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/websocket:handlers&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"handshakeHandler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework...DefaultHandshakeHandler"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"upgradeStrategy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"upgradeStrategy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework...JettyRequestUpgradeStrategy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"serverFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serverFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.eclipse.jetty...WebSocketServerFactory"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.eclipse.jetty...WebSocketPolicy"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SERVER"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"inputBufferSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"8092"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"idleTimeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"600000"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
</div>
<div class="section" title="20.3&nbsp;Fallback Options"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-fallback"></a>20.3&nbsp;Fallback Options</h2></div></div></div>

<p>As explained in the <a class="link" href="#websocket-into-fallback-options" title="20.1.1&nbsp;Fallback Options">introduction</a>, WebSocket is not
supported in all browsers yet and may be precluded by restrictive network proxies.
This is why Spring provides fallback options that emulate the WebSocket API as close
as possible based on the <a class="ulink" href="https://github.com/sockjs/sockjs-protocol" target="_top">SockJS protocol</a>.</p>
<div class="section" title="20.3.1&nbsp;Enable SockJS"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-fallback-sockjs-enable"></a>20.3.1&nbsp;Enable SockJS</h3></div></div></div>

<p>SockJS is easy to enable through a configuration:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebSocket</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketConfig <span class="hl-keyword">implements</span> WebSocketConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(myHandler(), <span class="hl-string">"/myHandler"</span>).withSockJS();
    }

    <i><span class="hl-annotation" style="color: gray">@Bean</span></i>
    <span class="hl-keyword">public</span> WebSocketHandler myHandler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MyHandler();
    }

}</pre>

<p>and the XML configuration equivalent:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/websocket"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/websocket
        http://www.springframework.org/schema/websocket/spring-websocket-4.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;websocket:handlers&gt;</span>
        <span class="hl-tag">&lt;websocket:mapping</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myHandler"</span> <span class="hl-attribute">handler</span>=<span class="hl-value">"myHandler"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;websocket:sockjs/&gt;</span>
    <span class="hl-tag">&lt;/websocket:handlers&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myHandler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MyHandler"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The above is for use in Spring MVC applications and should be included in the
configuration of a <a class="link" href="#">DispatcherServlet</a>. However, Spring&#8217;s WebSocket
and SockJS support does not depend on Spring MVC. It is relatively simple to
integrate into other HTTP serving environments with the help of
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/socket/sockjs/support/SockJsHttpRequestHandler.html" target="_top">SockJsHttpRequestHandler</a>.</p>
<p>On the browser side, applications can use the
<a class="ulink" href="https://github.com/sockjs/sockjs-client" target="_top">sockjs-client</a> that emulates the W3C
WebSocket API and communicates with the server to select the best
transport option depending on the browser it&#8217;s running in. Review the
<a class="ulink" href="https://github.com/sockjs/sockjs-client" target="_top">sockjs-client</a> page and the list of
transport types supported by browser. The client also provides several
configuration options, for example, to specify which transports to include.</p>
</div>
<div class="section" title="20.3.2&nbsp;How SockJS Works"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-fallback-sockjs-explained"></a>20.3.2&nbsp;How SockJS Works</h3></div></div></div>

<p>An in-depth description of how SockJS works is beyond the scope of this document.
This section summarizes a few key facts to aid with understanding.
The SockJS protocol itself is defined in a
<a class="ulink" href="https://github.com/sockjs/sockjs-protocol/blob/master/sockjs-protocol-0.3.3.py" target="_top">test suite</a>,
with comments explaining the protocol. There is also an
<a class="ulink" href="http://sockjs.github.io/sockjs-protocol/sockjs-protocol-0.3.3.html" target="_top">HTML version of that test</a>
showing comments on the right and code on the left.</p>
<p>The SockJS client issues HTTP requests with this URL structure:</p>
<p title="SockJS URL">
<b>SockJS URL.&nbsp;</b>

</p><pre class="screen">http://host:port/{path-to-sockjs-endpoint}/{server-id}/{session-id}/{transport}</pre><p title="SockJS URL">

</p>

<p>The WebSocket transport type uses a single HTTP connection to perform a
WebSocket handshake and establish an actual WebSocket session. HTTP-based
transports on the other hand must simulate the WebSocket API and at any time
may use two HTTP connections&#8201;&#8212;&#8201;one for server-to-client messages, via
<a class="ulink" href="https://spring.io/blog/2012/05/08/spring-mvc-3-2-preview-techniques-for-real-time-updates" target="_top">HTTP streaming or long polling</a>,
and another for sending client messages to the server via HTTP POST.</p>
<p>The session id is useful with HTTP transports to associate individual HTTP
requests that belong to the same SockJS session. The server id is not used in the
protocol but is added to help in clustered environments.</p>
<p>SockJS adds a minimal amount of message framing. For example, the server can send
an "open frame" (the letter <code class="literal">o</code>), a "heartbeat frame" (the letter <code class="literal">h</code>), or a
"close frame" (the letter <code class="literal">c</code>); while the client sends messages as a JSON-encoded
array prepended with the letter <code class="literal">a</code> (e.g. <code class="literal">a["message1","message2"]</code>).</p>
<p>By default the server sends a heartbeat frame every 25 seconds to keep proxies
and loadbalancers from timing out the connection.</p>
</div>
<div class="section" title="20.3.3&nbsp;Spring&#8217;s SockJS Support"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-fallback-sockjs-spring"></a>20.3.3&nbsp;Spring&#8217;s SockJS Support</h3></div></div></div>

<p>In the Spring Framework, server-side support for the SockJS protocol is provided through a
hierarchy of classes that implement the <code class="literal">SockJsService</code> interface, while
<code class="literal">SockJsHttpRequestHandler</code> integrates the service into HTTP request processing.</p>
<p>To implement HTTP streaming and long polling in Servlet containers (both of which require
an HTTP connection to remain open longer than usual),  Spring&#8217;s SockJS support
relies on Servlet 3 async support.</p>
<div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>Servlet 3 async support does not expose a notification when a client disconnects,
e.g. a browser tab is closed, page is refreshed, etc
(see <a class="ulink" href="https://java.net/jira/browse/SERVLET_SPEC-44" target="_top">SERVLET_SPEC-44</a>). However, the
Serlvet container will usually raise an IOException on the next attempt to write
to the response; at which point the SockJS session will be closed. Since the
SockJsService sends a heartbeat every 25 seconds, typically a disconnected
client will be detected within that time period.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="20.4&nbsp;STOMP Messaging"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-stomp"></a>20.4&nbsp;STOMP Messaging</h2></div></div></div>

<p>The WebSocket protocol defines two main types of messages&#8201;&#8212;&#8201;text and binary&#8201;&#8212;&#8201;but leaves their content undefined. Instead it&#8217;s expected that client and
server may agree on using a sub-protocol, i.e. a higher-level protocol that defines
the message content. Using a sub-protocol is optional but either way client
and server both need to understand how to interpret messages.</p>
<div class="section" title="20.4.1&nbsp;Overview of STOMP"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-stomp-overview"></a>20.4.1&nbsp;Overview of STOMP</h3></div></div></div>

<p><a class="ulink" href="http://stomp.github.io/stomp-specification-1.2.html#Abstract" target="_top">STOMP</a> is a simple
messaging protocol originally created for scripting languages (such as Ruby, Python and
Perl) to connect to enterprise message brokers. It is designed to address a
subset of commonly used patterns in messaging protocols. STOMP can be used over
any reliable 2-way streaming network protocol such as TCP and WebSocket.</p>
<p>STOMP is a frame based protocol with frames modelled on HTTP. This is the
structure of a frame:</p>
<pre class="screen">COMMAND
header1:value1
header2:value2

Body^@</pre>

<p>For example, a client can use the <code class="literal">SEND</code> command to send a message or the
<code class="literal">SUBSCRIBE</code> command to express interest in receiving messages. Both of these commands
require a <code class="literal">"destination"</code> header that indicates where to send a message to, or likewise
what to subscribe to.</p>
<p>Here is an example of a client sending a request to buy stock shares:</p>
<pre class="screen">SEND
destination:/queue/trade
content-type:application/json
content-length:44

{"action":"BUY","ticker":"MMM","shares",44}^@</pre>

<p>Here is an example of a client subscribing to receive stock quotes:</p>
<pre class="screen">SUBSCRIBE
id:sub-1
destination:/topic/price.stock.*

^@</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The meaning of a destination is intentionally left opaque in the STOMP spec. It can
be any string and it&#8217;s entirely up to STOMP servers to define the semantics and
the syntax of the destinations that they support. It is very common however, for
destinations to be path-like strings where <code class="literal">"/topic/.."</code> implies publish-subscribe
(<span class="emphasis"><em>one-to-many</em></span>) and <code class="literal">"/queue/"</code> to implies point-to-point (<span class="emphasis"><em>one-to-one</em></span>) message
exchanges.</p>
</td></tr></table></div>

<p>STOMP servers can use the <code class="literal">MESSAGE</code> command to broadcast messages to all subscribers.
Here is an example of a server sending a stock quote to a subscribed client:</p>
<pre class="screen">MESSAGE
message-id:nxahklf6-1
subscription:sub-1
destination:/topic/price.stock.MMM

{"ticker":"MMM","price":129.45}^@</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It&#8217;s important to know that a server cannot send unsolicited messages.
All messages from a server must be in response to a specific client subscription
and the <code class="literal">"subscription-id"</code> header of the server message must match
the <code class="literal">"id"</code> header of the client subscription.</p>
</td></tr></table></div>

<p>The above overview is intended to provide the most basic understanding of the
STOMP protocol. It is recommended to review the protocol
<a class="ulink" href="http://stomp.github.io/stomp-specification-1.2.html" target="_top">specification</a>, which is
easy to follow and manageable in terms of size.</p>
<p>The following summarizes the benefits for an application from using STOMP over WebSocket:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Standard message format
</li><li class="listitem">
Application-level protocol with support for common messaging patterns
</li><li class="listitem">
Client-side support, e.g. <a class="ulink" href="https://github.com/jmesnil/stomp-websocket" target="_top">stomp.js</a>, <a class="ulink" href="https://github.com/cujojs/msgs" target="_top">msgs.js</a>
</li><li class="listitem">
The ability to interpret, route, and process messages on both client and server-side
</li><li class="listitem">
The option to plug a message broker&#8201;&#8212;&#8201;RabbitMQ, ActiveMQ, many others&#8201;&#8212;&#8201;to broadcast messages (explained later)
</li></ul></div>

<p>Most importantly the use of STOMP (vs plain WebSocket) enables the Spring Framework
to provide a programming model for application-level use in the same way that
Spring MVC provides a programming model based on HTTP.</p>
</div>
<div class="section" title="20.4.2&nbsp;Enable STOMP (over WebSocket)"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-stomp-enable"></a>20.4.2&nbsp;Enable STOMP (over WebSocket)</h3></div></div></div>

<p>The Spring Framework provides support for using STOMP over WebSocket through
the <code class="literal">spring-messaging</code> and <code class="literal">spring-websocket</code> modules. It&#8217;s easy to enable it.</p>
<p>Here is an example of configuring a STOMP WebSocket endpoint with SockJS fallback
options. The endpoint is available for clients to connect to at URL path <code class="literal">/portfolio</code>:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
<span class="hl-keyword">import</span> org.springframework.web.socket.config.annotation.StompEndpointRegistry;

<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebSocketMessageBroker</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketConfig <span class="hl-keyword">implements</span> WebSocketMessageBrokerConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint(<span class="hl-string">"/portfolio"</span>).withSockJS();
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>XML configuration equivalent:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/websocket"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/websocket
        http://www.springframework.org/schema/websocket/spring-websocket-4.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;websocket:message-broker&gt;</span>
        <span class="hl-tag">&lt;websocket:stomp-endpoint</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/portfolio"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;websocket:sockjs/&gt;</span>
        <span class="hl-tag">&lt;/websocket:stomp-endpoint&gt;</span>
        ...
    <span class="hl-tag">&lt;/websocket:message-broker&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>On the browser side, a client might connect as follows using
<a class="ulink" href="https://github.com/jmesnil/stomp-websocket" target="_top">stomp.js</a> and the
<a class="ulink" href="https://github.com/sockjs/sockjs-client" target="_top">sockjs-client</a>:</p>
<pre class="programlisting"><span class="hl-keyword">var</span> socket = <span class="hl-keyword">new</span> SockJS(<span class="hl-string">"/spring-websocket-portfolio/portfolio"</span>);
<span class="hl-keyword">var</span> stompClient = Stomp.over(socket);</pre>

<p>Or if connecting via WebSocket (without SockJS):</p>
<pre class="programlisting"><span class="hl-keyword">var</span> socket = <span class="hl-keyword">new</span> WebSocket(<span class="hl-string">"/spring-websocket-portfolio/portfolio"</span>);
<span class="hl-keyword">var</span> stompClient = Stomp.over(socket);</pre>

</div>
<div class="section" title="20.4.3&nbsp;Overview of STOMP Message Handling"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-stomp-handle"></a>20.4.3&nbsp;Overview of STOMP Message Handling</h3></div></div></div>

<p>When a STOMP endpoint is configured, the Spring application effectively becomes
the broker to connected clients, handling incoming messages and broadcasting
messages back to them. This part of the documentation describes how STOMP
messages are handled within the application.</p>
<p>As mentioned in the <a class="link" href="#websocket-intro-architecture" title="20.1.2&nbsp;Messaging Architecture">introduction</a> the
<code class="literal">spring-messaging</code> module contains key abstractions from the
<a class="ulink" href="https://spring.io/spring-integration" target="_top">Spring Integration</a> project, including
<code class="literal">Message</code>, <code class="literal">MessageChannel</code>, <code class="literal">MessageHandler</code> and a few others.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 4 will be the first version to start using the abstractions
from the package structure of the <code class="literal">spring-messaging</code> module as opposed to its
own present packages. Spring Integration also provides many additional
abstractions and implementations in support of the well-known
EAI patterns (<a class="ulink" href="http://www.eaipatterns.com/" target="_top">enterprise integration patterns</a>).</p>
</td></tr></table></div>

<p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/MessageChannel.html" target="_top">MessageChannel</a>
is a simple contract for passing messages between components without
creating tight coupling among them.
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/SubscribableChannel.html" target="_top">SubscribableChannel</a> extends
it, with the ability to register subscribers; and
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/support/ExecutorSubscribableChannel.html" target="_top">ExecutorSubscribableChannel</a>
is an implementation that passes messages to subscribers in
the same thread or a different thread depending on whether it has been provided with
a <code class="literal">java.util.concurrent.Executor</code>. This enables assembling message
handling flows from various components and modifying them through configuration.</p>
<p>The provided Java-config <code class="literal">@EnableWebSocketMessageBroker</code> and XML namespace
<code class="literal">&lt;websocket:message-broker&gt;</code> each put together a default message handling
flow for applications to use, as explained next. This flow can be modified,
customized, or extended. For example, an application can add a
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/support/ChannelInterceptor.html" target="_top">ChannelInterceptor</a>
to any message channel in order to intercept messages passing through it;
it can register additional message handling components, alternate between
synchronous and asynchronous message passing, and so on.</p>
<p>Incoming client STOMP messages are passed to a message channel with the name
<code class="literal">"clientInboundChannel"</code>. By default the messages are routed to annotated
methods as well as to a "simple" message broker. This simple message broker
automatically records subscriptions, in-memory, and broadcasts messages as
necessary. As explained later, you can also use a full-featured message broker
(e.g. RabbitMQ, ActiveMQ, and any other broker that supports STOMP) to manage
subscriptions and broadcast messages.</p>
<p>Below is example configuration:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebSocketMessageBroker</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketConfig <span class="hl-keyword">implements</span> WebSocketMessageBrokerConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint(<span class="hl-string">"/portfolio"</span>).withSockJS();
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableSimpleBroker(<span class="hl-string">"/topic/"</span>);
        registry.setApplicationDestinationPrefixes(<span class="hl-string">"/app"</span>);
    }

}</pre>

<p>XML configuration equivalent:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/websocket"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/websocket
        http://www.springframework.org/schema/websocket/spring-websocket-4.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;websocket:message-broker</span> <span class="hl-attribute">application-destination-prefix</span>=<span class="hl-value">"/app"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;websocket:stomp-endpoint</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/portfolio"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;websocket:sockjs/&gt;</span>
        <span class="hl-tag">&lt;/websocket:stomp-endpoint&gt;</span>
        <span class="hl-tag">&lt;websocket:simple-broker</span> <span class="hl-attribute">prefix</span>=<span class="hl-value">"/topic"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/websocket:message-broker&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The configuration example assigns destination prefixes&#8201;&#8212;&#8201;<code class="literal">/app</code> for filtering
messages to annotated methods and <code class="literal">/topic</code> for messages to the broker. The
examples below demonstrate how this can be used.</p>
<p>The destination prefix should not be included in annotation mappings. For
example, this method handles messages to destination <code class="literal">/app/greetings</code>:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> GreetingController {

    <i><span class="hl-annotation" style="color: gray">@MessageMapping("/greetings")</span></i> {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(String greeting) {
        <span class="hl-comment">// ...</span>
    }

}

</pre>

<p>The method accepts a String extracted from the payload of the message,
possibly converted based on its content type. The method can also return a
value, which is wrapped as the payload of a new message and sent to a message
channel named <code class="literal">"brokerChannel"</code> (which is used for sending messages to the broker
from within the application). The new message is sent to the same destination
as that of the client message, but with the default prefix <code class="literal">/topic</code>
(you can also use <code class="literal">@SendTo</code> for any other target destination):</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> GreetingController {

    <i><span class="hl-annotation" style="color: gray">@MessageMapping("/greetings")</span></i> {
    <span class="hl-keyword">public</span> String handle(String greeting) {
        <span class="hl-keyword">return</span> <span class="hl-string">"["</span> + getTimestamp() + <span class="hl-string">": "</span> + greeting;
    }

}

</pre>

<p>As a result, to put it all together, a client sends a greeting message to
destination <code class="literal">/app/greetings</code>. The message is routed to <code class="literal">GreetingController</code>,
which enriches the greeting with a timestamp and sends a new message to the
broker with destination <code class="literal">/topic/greetings</code>. The broker then broadcasts the
message to all subscribed, connected clients.</p>
<div class="section" title="Annotation-based Message Handling"><div class="titlepage"><div><div><h4 class="title"><a name="websocket-stomp-handle-annotations"></a>Annotation-based Message Handling</h4></div></div></div>

<p>The <code class="literal">@MessageMapping</code> annotation is supported on methods of <code class="literal">@Controller</code>-annotated classes.
It can be used for mapping methods to path-like message destinations. It is also
possible to combine with a type-level <code class="literal">@MessageMapping</code> for expressing shared
mappings across all annotated methods within a controller.</p>
<p>Destination mappings can contain Ant-style patterns (e.g. "/foo*", "/foo/**")
and template variables (e.g. "/foo/{id}"), which can then be accessed via
<code class="literal">@DestinationVariable</code> method arguments. This should be familiar to Spring MVC
users, in fact the same <code class="literal">AntPathMatcher</code> is used for matching destinations based
on patterns and for extracting template variables.</p>
<p>The following method arguments are supported for <code class="literal">@MessageMapping</code> methods:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">Message</code> method argument to get access to the complete message being processed.
</li><li class="listitem">
<code class="literal">@Payload</code>-annotated argument for access to the payload of a message, converted with
a <code class="literal">org.springframework.messaging.converter.MessageConverter</code>.
The presence of the annotation is not required since it is assumed by default.
Payload method arguments annotated with Validation annotations (like <code class="literal">@Validated</code>) will
be subject to JSR-303 validation.
</li><li class="listitem">
<code class="literal">@Header</code>-annotated arguments for access to a specific header value along with
type conversion using an <code class="literal">org.springframework.core.convert.converter.Converter</code>
if necessary.
</li><li class="listitem">
<code class="literal">@Headers</code>-annotated method argument that must also be assignable to <code class="literal">java.util.Map</code>
for access to all headers in the message.
</li><li class="listitem">
<code class="literal">MessageHeaders</code> method argument for getting access to a map of all headers.
</li><li class="listitem">
<code class="literal">MessageHeaderAccessor</code>, <code class="literal">SimpMessageHeaderAccessor</code>, or <code class="literal">StompHeaderAccessor</code>
for access to headers via typed accessor methods.
</li><li class="listitem">
<code class="literal">@DestinationVariable</code>-annotated arguments for access to template
variables extracted from the message destination. Values will be converted to
the declared method argument type as necessary.
</li><li class="listitem">
<code class="literal">java.security.Principal</code> method arguments reflecting the user logged in at
the time of the WebSocket HTTP handshake.
</li></ul></div>

<p>The return value from an <code class="literal">@MessageMapping</code> method is converted with a
<code class="literal">org.springframework.messaging.converter.MessageConverter</code> and used as the body
of a new message that is then sent, by default, to the <code class="literal">"brokerChannel"</code> with
the same destination as the client message but using the prefix "/topic" by
default. An <code class="literal">@SendTo</code> message level annotation can be used to specify any
other destination instead.</p>
<p>An <code class="literal">@SubscribeMapping</code> annotation can also be used to map subscription requests
to <code class="literal">@Controller</code> methods. It is supported on the method level, but can also be
combined with a type level <code class="literal">@MessageMapping</code> annotation that expresses shared
mappings across all message handling methods within the same controller.</p>
<p>By default the return value from an <code class="literal">@SubscribeMapping</code> method is sent as a
message directly back to the connected client and does not pass through the
broker. This is useful for implementing request-reply message interactions; for
example, to fetch application data when the application UI is being initialized.
Or alternatively an <code class="literal">@SubscribeMapping</code> method can be annotated with <code class="literal">@SendTo</code>
in which case the resulting message is sent to the <code class="literal">"brokerChannel"</code> using
the specified target destination.</p>
</div>
<div class="section" title="Sending Messages From Anywhere"><div class="titlepage"><div><div><h4 class="title"><a name="websocket-stomp-handle-send"></a>Sending Messages From Anywhere</h4></div></div></div>

<p>What if you wanted to send messages to connected clients from any part of the
application? Any application component can send messages to the <code class="literal">"brokerChannel"</code>.
The easist way to do that is to have a <code class="literal">SimpMessagingTemplate</code> injected, and
use it to send messages. Typically it should be easy to have it injected by
type, for example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Controller</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> GreetingController {

    <span class="hl-keyword">private</span> SimpMessagingTemplate template;

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">public</span> GreetingController(SimpMessagingTemplate template) {
        <span class="hl-keyword">this</span>.template = template;
    }

    <i><span class="hl-annotation" style="color: gray">@RequestMapping(value="/greetings", method=POST)</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> greet(String greeting) {
        String text = <span class="hl-string">"["</span> + getTimestamp() + <span class="hl-string">"]:"</span> + greeting;
        <span class="hl-keyword">this</span>.template.convertAndSend(<span class="hl-string">"/topic/greetings"</span>, text);
    }

}</pre>

<p>But it can also be qualified by its name "brokerMessagingTemplate" if another
bean of the same type exists.</p>
</div>
<div class="section" title="Simple Message Broker"><div class="titlepage"><div><div><h4 class="title"><a name="websocket-stomp-handle-simple-broker"></a>Simple Message Broker</h4></div></div></div>

<p>The built-in, simple, message broker handles subscription requests from clients,
stores them in memory, and broadcasts messages to connected clients with matching
destinations. The broker supports path-like destinations, including subscriptions
to Ant-style destination patterns.</p>
</div>
<div class="section" title="Using a Full-Featured Message Broker"><div class="titlepage"><div><div><h4 class="title"><a name="websocket-stomp-handle-broker-relay"></a>Using a Full-Featured Message Broker</h4></div></div></div>

<p>The simple broker is great for getting started but supports only a subset of
STOMP commands (e.g. no acks, receipts, etc), relies on a simple message
sending loop, and is not suitable for clustering.</p>
<p>Instead, applications can use a full-featured message broker and use it for
managing client subscriptions and broadcasting messages; while annotated
methods can still be used for application processing. In other words, all
else remains the same, except a full-featured broker replaces the simple
broker.</p>
<p>Check your message broker STOMP documentation (e.g.
<a class="ulink" href="http://www.rabbitmq.com/stomp.html" target="_top">RabbitMQ</a>,
<a class="ulink" href="http://activemq.apache.org/stomp.html" target="_top">ActiveMQ</a>), install and run the broker with
STOMP support enabled. Then enable the STOMP broker relay in the Spring
configuration as an alternative to the simple broker.</p>
<p>Below is example configuration that enables use of a full-featured broker:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableWebSocketMessageBroker</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketConfig <span class="hl-keyword">implements</span> WebSocketMessageBrokerConfigurer {

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint(<span class="hl-string">"/portfolio"</span>).withSockJS();
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableStompBrokerRelay(<span class="hl-string">"/topic/"</span>, <span class="hl-string">"/queue/"</span>);
        registry.setApplicationDestinationPrefixes(<span class="hl-string">"/app"</span>);
    }

}</pre>

<p>XML configuration equivalent:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/websocket"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/websocket
        http://www.springframework.org/schema/websocket/spring-websocket-4.0.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;websocket:message-broker</span> <span class="hl-attribute">application-destination-prefix</span>=<span class="hl-value">"/app"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;websocket:stomp-endpoint</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/portfolio"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;websocket:sockjs/&gt;</span>
        <span class="hl-tag">&lt;/websocket:stomp-endpoint&gt;</span>
        <span class="hl-tag">&lt;websocket:stomp-broker-relay</span> <span class="hl-attribute">prefix</span>=<span class="hl-value">"/topic,/queue"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/websocket:message-broker&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The STOMP "broker relay" from the above configuration manages TCP connections
to the external broker, and forwards messages with matching destination prefixes
to it. Likewise, any messages received from the external broker are matched and
routed to connected clients.</p>
<p>In effect, messages are now broadcast through a full-featured, robust and
scalable message broker.</p>
</div>
<div class="section" title="Handling Messages to User Destinations"><div class="titlepage"><div><div><h4 class="title"><a name="websocket-stomp-handle-user"></a>Handling Messages to User Destinations</h4></div></div></div>

<p>An application can also send messages targeting a specific user.</p>
<p>To do so a user must first be authenticated. Although the STOMP <code class="literal">CONNECT</code> frame
has authentication headers when used over WebSocket, it makes more sense to use
the same HTTP-based authentication already used to secure the application.</p>
<p>For example, an application can use Spring Security as usual to protect HTTP URLs,
including paths to STOMP WebSocket endpoint(s). The authenticanted user, based
on the value returned from <code class="literal">HttpServletRequest.getUserPrincipal()</code>, will be
saved in the WebSocket session and subsequently added as a header named <code class="literal">user</code>
to all incoming messages for that STOMP/WebSocket session.</p>
<p>Spring&#8217;s STOMP support recognizes destinations prefixed with <code class="literal">/user/</code>.
For example, a client can subscribe to destination <code class="literal">/user/position-updates</code>.
This destination will be handled by the <code class="literal">UserDestinationMessageHandler</code> and
transformed into a destination unique to the user&#8217;s session,
e.g. <code class="literal">/user/position-updates-123</code>. This provides the convenience of subscribing
to a generically named destination, while also ensuring that it doesn&#8217;t "collide"
with any other user that also subscribes to <code class="literal">/user/position-updates</code>
in order to receive stock position updates unique to them.</p>
<p>On the sending side, messages can be sent to a destination such as
<code class="literal">/user/{username}/position-updates</code>, which in turn will be translated
by the <code class="literal">UserDestinationMessageHandler</code> into the same unique destination
belonging to the specified user name.</p>
<p>This allows any component within the application to send messages to a specific
user without necessarily knowing anything more than their name and a generic
destination.</p>
<p>When this is used with an external message broker, check the broker documentation
on how to manage inactive queues, so that when the user session is over, all
unique user queues are removed. For example, RabbitMQ creates auto-delete queues
when destinations like <code class="literal">/exchange/amq.direct/position-updates</code> are used.
So in that case the client could subscribe to <code class="literal">/user/exchange/amq.direct/position-updates</code>.
ActiveMQ has <a class="ulink" href="http://activemq.apache.org/delete-inactive-destinations.html" target="_top">configuration options</a>
for purging inactive destinations.</p>
</div>
<div class="section" title="Testing Message Handling Controllers"><div class="titlepage"><div><div><h4 class="title"><a name="websocket-stomp-testing"></a>Testing Message Handling Controllers</h4></div></div></div>

<p>There are two main approaches to testing applications using Spring&#8217;s STOMP over
WebSocket support. The first is to write server-side tests verifying the functionality
of controllers and their annotated message handling methods. The second is to write
full end-to-end tests that involve running a client and a server.</p>
<p>The two approaches are not mutually exclusive. On the contrary each has a place
in an overall test strategy. Server-side tests are more focused and easier to write
and maintain. End-to-end integration tests on the other hand are more complete and
test much more but they&#8217;re also more involved to write and maintain.</p>
<p>The simplest form of server-side tests is to write controller unit tests. However
this is not useful enough since much of what a controller does depends on its
annotations. Pure unit tests simply can&#8217;t test that.</p>
<p>Ideally controllers under test should be invoked as they are at runtime, much like
the approach to testing controllers handling HTTP requests using the Spring MVC Test
framework. i.e. without running a Servlet container but relying on the Spring Framework
to invoke the annotated controllers. Just like with Spring MVC Test here there are two
two possible alternatives, either using a "context-based" or "standalone" setup:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Load the actual Spring configuration with the help of the
Spring TestContext framework, inject "clientInboundChannel" as a test field, and
use it to send messages to be handled by controller methods.
</li><li class="listitem">
Manually set up the minimum Spring framework infrastructure required to invoke
controllers (namely the <code class="literal">SimpAnnotationMethodMessageHandler</code>) and pass messages for
controllers directly to it.
</li></ol></div>

<p>Both of these setup scenarios are demonstrated in the
<a class="ulink" href="https://github.com/rstoyanchev/spring-websocket-portfolio/tree/master/src/test/java/org/springframework/samples/portfolio/web" target="_top">tests for the stock portfolio</a>
sample application.</p>
<p>The second approach is to create end-to-end integration tests. For that you will need
to run a WebSocket server in embedded mode and connect to it as a WebSocket client
sending WebSocket messages containing STOMP frames.
The <a class="ulink" href="https://github.com/rstoyanchev/spring-websocket-portfolio/tree/master/src/test/java/org/springframework/samples/portfolio/web" target="_top">tests for the stock portfolio</a>
sample application also demonstrate this approach using Tomcat as the embedded
WebSocket server and a simple STOMP client for test purposes.</p>
</div>
</div>
</div>
</div>
</div>
<div class="part" title="Part&nbsp;VI.&nbsp;Integration"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration"></a>Part&nbsp;VI.&nbsp;Integration</h1></div></div></div>

<div class="partintro" title="Integration"><div></div>
<p>This part of the reference documentation covers the Spring Framework&#8217;s integration with
a number of Java EE (and related) technologies.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#remoting" title="21.&nbsp;Remoting and web services using Spring">Chapter&nbsp;21, <i>Remoting and web services using Spring</i></a>
</li><li class="listitem">
<a class="xref" href="#ejb" title="22.&nbsp;Enterprise JavaBeans (EJB) integration">Chapter&nbsp;22, <i>Enterprise JavaBeans (EJB) integration</i></a>
</li><li class="listitem">
<a class="xref" href="#jms" title="23.&nbsp;JMS (Java Message Service)">Chapter&nbsp;23, <i>JMS (Java Message Service)</i></a>
</li><li class="listitem">
<a class="xref" href="#jmx" title="24.&nbsp;JMX">Chapter&nbsp;24, <i>JMX</i></a>
</li><li class="listitem">
<a class="xref" href="#cci" title="25.&nbsp;JCA CCI">Chapter&nbsp;25, <i>JCA CCI</i></a>
</li><li class="listitem">
<a class="xref" href="#mail" title="26.&nbsp;Email">Chapter&nbsp;26, <i>Email</i></a>
</li><li class="listitem">
<a class="xref" href="#scheduling" title="27.&nbsp;Task Execution and Scheduling">Chapter&nbsp;27, <i>Task Execution and Scheduling</i></a>
</li><li class="listitem">
<a class="xref" href="#dynamic-language" title="28.&nbsp;Dynamic language support">Chapter&nbsp;28, <i>Dynamic language support</i></a>
</li><li class="listitem">
<a class="xref" href="#cache" title="29.&nbsp;Cache Abstraction">Chapter&nbsp;29, <i>Cache Abstraction</i></a>
</li></ul></div>

</div>
<div class="chapter" title="21.&nbsp;Remoting and web services using Spring"><div class="titlepage"><div><div><h2 class="title"><a name="remoting"></a>21.&nbsp;Remoting and web services using Spring</h2></div></div></div>

<div class="section" title="21.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-introduction"></a>21.1&nbsp;Introduction</h2></div></div></div>

<p>Spring features integration classes for remoting support using various technologies. The
remoting support eases the development of remote-enabled services, implemented by your
usual (Spring) POJOs. Currently, Spring supports the following remoting technologies:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="emphasis"><em>Remote Method Invocation (RMI)</em></span>. Through the use of the <code class="literal">RmiProxyFactoryBean</code> and
the <code class="literal">RmiServiceExporter</code> Spring supports both traditional RMI (with <code class="literal">java.rmi.Remote</code>
interfaces and <code class="literal">java.rmi.RemoteException</code>) and transparent remoting via RMI invokers
(with any Java interface).
</li><li class="listitem">
<span class="emphasis"><em>Spring&#8217;s HTTP invoker</em></span>. Spring provides a special remoting strategy which allows
for Java serialization via HTTP, supporting any Java interface (just like the RMI
invoker). The corresponding support classes are <code class="literal">HttpInvokerProxyFactoryBean</code> and
<code class="literal">HttpInvokerServiceExporter</code>.
</li><li class="listitem">
<span class="emphasis"><em>Hessian</em></span>. By using Spring&#8217;s <code class="literal">HessianProxyFactoryBean</code> and the
<code class="literal">HessianServiceExporter</code> you can transparently expose your services using the
lightweight binary HTTP-based protocol provided by Caucho.
</li><li class="listitem">
<span class="emphasis"><em>Burlap</em></span>. Burlap is Caucho&#8217;s XML-based alternative to Hessian. Spring provides
support classes such as <code class="literal">BurlapProxyFactoryBean</code> and <code class="literal">BurlapServiceExporter</code>.
</li><li class="listitem">
<span class="emphasis"><em>JAX-WS</em></span>. Spring provides remoting support for web services via JAX-WS (the
successor of JAX-RPC, as introduced in Java EE 5 and Java 6).
</li><li class="listitem">
<span class="emphasis"><em>JMS</em></span>. Remoting using JMS as the underlying protocol is supported via the
<code class="literal">JmsInvokerServiceExporter</code> and <code class="literal">JmsInvokerProxyFactoryBean</code> classes.
</li><li class="listitem">
<span class="emphasis"><em>AMQP</em></span>. Remoting using AMQP as the underlying protocol is supported by the Spring
AMQP project.
</li></ul></div>

<p>While discussing the remoting capabilities of Spring, we&#8217;ll use the following domain
model and corresponding services:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Account <span class="hl-keyword">implements</span> Serializable{

    <span class="hl-keyword">private</span> String name;

    <span class="hl-keyword">public</span> String getName(){
        <span class="hl-keyword">return</span> name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AccountService {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> insertAccount(Account account);

    <span class="hl-keyword">public</span> List&lt;Account&gt; getAccounts(String name);

}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RemoteAccountService <span class="hl-keyword">extends</span> Remote {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> insertAccount(Account account) <span class="hl-keyword">throws</span> RemoteException;

    <span class="hl-keyword">public</span> List&lt;Account&gt; getAccounts(String name) <span class="hl-keyword">throws</span> RemoteException;

}</pre>

<pre class="programlisting"><span class="hl-comment">// the implementation doing nothing at the moment</span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AccountServiceImpl <span class="hl-keyword">implements</span> AccountService {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> insertAccount(Account acc) {
        <span class="hl-comment">// do something...</span>
    }

    <span class="hl-keyword">public</span> List&lt;Account&gt; getAccounts(String name) {
        <span class="hl-comment">// do something...</span>
    }

}</pre>

<p>We will start exposing the service to a remote client by using RMI and talk a bit about
the drawbacks of using RMI. We&#8217;ll then continue to show an example using Hessian as the
protocol.</p>
</div>
<div class="section" title="21.2&nbsp;Exposing services using RMI"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-rmi"></a>21.2&nbsp;Exposing services using RMI</h2></div></div></div>

<p>Using Spring&#8217;s support for RMI, you can transparently expose your services through the
RMI infrastructure. After having this set up, you basically have a configuration similar
to remote EJBs, except for the fact that there is no standard support for security
context propagation or remote transaction propagation. Spring does provide hooks for
such additional invocation context when using the RMI invoker, so you can for example
plug in security frameworks or custom security credentials here.</p>
<div class="section" title="21.2.1&nbsp;Exporting the service using the RmiServiceExporter"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-rmi-server"></a>21.2.1&nbsp;Exporting the service using the RmiServiceExporter</h3></div></div></div>

<p>Using the <code class="literal">RmiServiceExporter</code>, we can expose the interface of our AccountService object
as RMI object. The interface can be accessed by using <code class="literal">RmiProxyFactoryBean</code>, or via
plain RMI in case of a traditional RMI service. The <code class="literal">RmiServiceExporter</code> explicitly
supports the exposing of any non-RMI services via RMI invokers.</p>
<p>Of course, we first have to set up our service in the Spring container:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.AccountServiceImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- any additional properties, maybe a DAO? --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Next we&#8217;ll have to expose our service using the <code class="literal">RmiServiceExporter</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.rmi.RmiServiceExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- does not necessarily have to be the same name as the bean to be exported --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"AccountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-comment">&lt;!-- defaults to 1099 --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"registryPort"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1199"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>As you can see, we&#8217;re overriding the port for the RMI registry. Often, your application
server also maintains an RMI registry and it is wise to not interfere with that one.
Furthermore, the service name is used to bind the service under. So right now, the
service will be bound at <code class="literal">'rmi://HOST:1199/AccountService'</code>. We&#8217;ll use the URL later on
to link in the service at the client side.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">servicePort</code> property has been omitted (it defaults to 0). This means that an
anonymous port will be used to communicate with the service.</p>
</td></tr></table></div>

</div>
<div class="section" title="21.2.2&nbsp;Linking in the service at the client"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-rmi-client"></a>21.2.2&nbsp;Linking in the service at the client</h3></div></div></div>

<p>Our client is a simple object using the <code class="literal">AccountService</code> to manage accounts:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleObject {

    <span class="hl-keyword">private</span> AccountService accountService;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setAccountService(AccountService accountService) {
        <span class="hl-keyword">this</span>.accountService = accountService;
    }

    <span class="hl-comment">// additional methods using the accountService</span>

}</pre>

<p>To link in the service on the client, we&#8217;ll create a separate Spring container,
containing the simple object and the service linking configuration bits:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleObject"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.rmi.RmiProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"rmi://HOST:1199/AccountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>That&#8217;s all we need to do to support the remote account service on the client. Spring
will transparently create an invoker and remotely enable the account service through the
<code class="literal">RmiServiceExporter</code>. At the client we&#8217;re linking it in using the <code class="literal">RmiProxyFactoryBean</code>.</p>
</div>
</div>
<div class="section" title="21.3&nbsp;Using Hessian or Burlap to remotely call services via HTTP"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-caucho-protocols"></a>21.3&nbsp;Using Hessian or Burlap to remotely call services via HTTP</h2></div></div></div>

<p>Hessian offers a binary HTTP-based remoting protocol. It is developed by Caucho and more
information about Hessian itself can be found at <a class="ulink" href="http://www.caucho.com" target="_top">http://www.caucho.com</a>.</p>
<div class="section" title="21.3.1&nbsp;Wiring up the DispatcherServlet for Hessian and co."><div class="titlepage"><div><div><h3 class="title"><a name="remoting-caucho-protocols-hessian"></a>21.3.1&nbsp;Wiring up the DispatcherServlet for Hessian and co.</h3></div></div></div>

<p>Hessian communicates via HTTP and does so using a custom servlet. Using Spring&#8217;s
<code class="literal">DispatcherServlet</code> principles, as known from Spring Web MVC usage, you can easily wire
up such a servlet exposing your services. First we&#8217;ll have to create a new servlet in
your application (this is an excerpt from <code class="literal">'web.xml'</code>):</p>
<pre class="programlisting"><span class="hl-tag">&lt;servlet&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>remoting<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
    <span class="hl-tag">&lt;load-on-startup&gt;</span>1<span class="hl-tag">&lt;/load-on-startup&gt;</span>
<span class="hl-tag">&lt;/servlet&gt;</span>

<span class="hl-tag">&lt;servlet-mapping&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>remoting<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;url-pattern&gt;</span>/remoting/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/servlet-mapping&gt;</span></pre>

<p>You&#8217;re probably familiar with Spring&#8217;s <code class="literal">DispatcherServlet</code> principles and if so, you
know that now you&#8217;ll have to create a Spring container configuration resource named
<code class="literal">'remoting-servlet.xml'</code> (after the name of your servlet) in the <code class="literal">'WEB-INF'</code> directory.
The application context will be used in the next section.</p>
<p>Alternatively, consider the use of Spring&#8217;s simpler <code class="literal">HttpRequestHandlerServlet</code>. This
allows you to embed the remote exporter definitions in your root application context (by
default in <code class="literal">'WEB-INF/applicationContext.xml'</code>), with individual servlet definitions
pointing to specific exporter beans. Each servlet name needs to match the bean name of
its target exporter in this case.</p>
</div>
<div class="section" title="21.3.2&nbsp;Exposing your beans by using the HessianServiceExporter"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-caucho-protocols-hessian-server"></a>21.3.2&nbsp;Exposing your beans by using the HessianServiceExporter</h3></div></div></div>

<p>In the newly created application context called <code class="literal">remoting-servlet.xml</code>, we&#8217;ll create a
<code class="literal">HessianServiceExporter</code> exporting your services:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.AccountServiceImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- any additional properties, maybe a DAO? --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"/AccountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.caucho.HessianServiceExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Now we&#8217;re ready to link in the service at the client. No explicit handler mapping is
specified, mapping request URLs onto services, so <code class="literal">BeanNameUrlHandlerMapping</code> will be
used: Hence, the service will be exported at the URL indicated through its bean name
within the containing <code class="literal">DispatcherServlet</code>'s mapping (as defined above):
<code class="literal">'http://HOST:8080/remoting/AccountService'</code>.</p>
<p>Alternatively, create a <code class="literal">HessianServiceExporter</code> in your root application context (e.g.
in <code class="literal">'WEB-INF/applicationContext.xml'</code>):</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accountExporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.caucho.HessianServiceExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In the latter case, define a corresponding servlet for this exporter in <code class="literal">'web.xml'</code>,
with the same end result: The exporter getting mapped to the request path
<code class="literal">/remoting/AccountService</code>. Note that the servlet name needs to match the bean name of
the target exporter.</p>
<pre class="programlisting"><span class="hl-tag">&lt;servlet&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>accountExporter<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.context.support.HttpRequestHandlerServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
<span class="hl-tag">&lt;/servlet&gt;</span>

<span class="hl-tag">&lt;servlet-mapping&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>accountExporter<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;url-pattern&gt;</span>/remoting/AccountService<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/servlet-mapping&gt;</span></pre>

</div>
<div class="section" title="21.3.3&nbsp;Linking in the service on the client"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-caucho-protocols-hessian-client"></a>21.3.3&nbsp;Linking in the service on the client</h3></div></div></div>

<p>Using the <code class="literal">HessianProxyFactoryBean</code> we can link in the service at the client. The same
principles apply as with the RMI example. We&#8217;ll create a separate bean factory or
application context and mention the following beans where the <code class="literal">SimpleObject</code> is using
the <code class="literal">AccountService</code> to manage accounts:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleObject"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.caucho.HessianProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://remotehost:8080/remoting/AccountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="21.3.4&nbsp;Using Burlap"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-caucho-protocols-burlap"></a>21.3.4&nbsp;Using Burlap</h3></div></div></div>

<p>We won&#8217;t discuss Burlap, the XML-based equivalent of Hessian, in detail here, since it
is configured and set up in exactly the same way as the Hessian variant explained above.
Just replace the word <code class="literal">Hessian</code> with <code class="literal">Burlap</code> and you&#8217;re all set to go.</p>
</div>
<div class="section" title="21.3.5&nbsp;Applying HTTP basic authentication to a service exposed through Hessian or Burlap"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-caucho-protocols-security"></a>21.3.5&nbsp;Applying HTTP basic authentication to a service exposed through Hessian or Burlap</h3></div></div></div>

<p>One of the advantages of Hessian and Burlap is that we can easily apply HTTP basic
authentication, because both protocols are HTTP-based. Your normal HTTP server security
mechanism can easily be applied through using the <code class="literal">web.xml</code> security features, for
example. Usually, you don&#8217;t use per-user security credentials here, but rather shared
credentials defined at the <code class="literal">Hessian/BurlapProxyFactoryBean</code> level (similar to a JDBC
<code class="literal">DataSource</code>).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptors"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authorizationInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"authorizationInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.servlet.handler.UserRoleAuthorizationInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authorizedRoles"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"administrator,operator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This is an example where we explicitly mention the <code class="literal">BeanNameUrlHandlerMapping</code> and set
an interceptor allowing only administrators and operators to call the beans mentioned in
this application context.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Of course, this example doesn&#8217;t show a flexible kind of security infrastructure. For
more options as far as security is concerned, have a look at the Spring Security project
at <a class="ulink" href="http://projects.spring.io/spring-security/" target="_top">http://projects.spring.io/spring-security/</a>.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="21.4&nbsp;Exposing services using HTTP invokers"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-httpinvoker"></a>21.4&nbsp;Exposing services using HTTP invokers</h2></div></div></div>

<p>As opposed to Burlap and Hessian, which are both lightweight protocols using their own
slim serialization mechanisms, Spring HTTP invokers use the standard Java serialization
mechanism to expose services through HTTP. This has a huge advantage if your arguments
and return types are complex types that cannot be serialized using the serialization
mechanisms Hessian and Burlap use (refer to the next section for more considerations
when choosing a remoting technology).</p>
<p>Under the hood, Spring uses either the standard facilities provided by J2SE to perform
HTTP calls or Commons <code class="literal">HttpClient</code>. Use the latter if you need more advanced and
easy-to-use functionality. Refer to
<a class="ulink" href="http://jakarta.apache.org/commons/httpclient" target="_top">jakarta.apache.org/commons/httpclient</a> for
more info.</p>
<div class="section" title="21.4.1&nbsp;Exposing the service object"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-httpinvoker-server"></a>21.4.1&nbsp;Exposing the service object</h3></div></div></div>

<p>Setting up the HTTP invoker infrastructure for a service object resembles closely the
way you would do the same using Hessian or Burlap. Just as Hessian support provides the
<code class="literal">HessianServiceExporter</code>, Spring&#8217;s HttpInvoker support provides the
<code class="literal">org.springframework.remoting.httpinvoker.HttpInvokerServiceExporter</code>.</p>
<p>To expose the <code class="literal">AccountService</code> (mentioned above) within a Spring Web MVC
<code class="literal">DispatcherServlet</code>, the following configuration needs to be in place in the
dispatcher&#8217;s application context:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"/AccountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.httpinvoker.HttpInvokerServiceExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Such an exporter definition will be exposed through the <code class="literal">DispatcherServlet</code>'s standard
mapping facilities, as explained in the section on Hessian.</p>
<p>Alternatively, create an <code class="literal">HttpInvokerServiceExporter</code> in your root application context
(e.g. in <code class="literal">'WEB-INF/applicationContext.xml'</code>):</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accountExporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.httpinvoker.HttpInvokerServiceExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In addition, define a corresponding servlet for this exporter in <code class="literal">'web.xml'</code>, with the
servlet name matching the bean name of the target exporter:</p>
<pre class="programlisting"><span class="hl-tag">&lt;servlet&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>accountExporter<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.context.support.HttpRequestHandlerServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
<span class="hl-tag">&lt;/servlet&gt;</span>

<span class="hl-tag">&lt;servlet-mapping&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>accountExporter<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;url-pattern&gt;</span>/remoting/AccountService<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/servlet-mapping&gt;</span></pre>

<p>If you are running outside of a servlet container and are using Oracle&#8217;s Java 6, then you
can use the built-in HTTP server implementation. You can configure the
<code class="literal">SimpleHttpServerFactoryBean</code> together with a <code class="literal">SimpleHttpInvokerServiceExporter</code> as is
shown in this example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accountExporter"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.httpinvoker.SimpleHttpInvokerServiceExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpServer"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.support.SimpleHttpServerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"contexts"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;util:map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"/remoting/AccountService"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"accountExporter"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/util:map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"8080"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="21.4.2&nbsp;Linking in the service at the client"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-httpinvoker-client"></a>21.4.2&nbsp;Linking in the service at the client</h3></div></div></div>

<p>Again, linking in the service from the client much resembles the way you would do it
when using Hessian or Burlap. Using a proxy, Spring will be able to translate your calls
to HTTP POST requests to the URL pointing to the exported service.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpInvokerProxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://remotehost:8080/remoting/AccountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>As mentioned before, you can choose what HTTP client you want to use. By default, the
<code class="literal">HttpInvokerProxy</code> uses the J2SE HTTP functionality, but you can also use the Commons
<code class="literal">HttpClient</code> by setting the <code class="literal">httpInvokerRequestExecutor</code> property:</p>
<pre class="programlisting"><span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"httpInvokerRequestExecutor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.httpinvoker.CommonsHttpInvokerRequestExecutor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span></pre>

</div>
</div>
<div class="section" title="21.5&nbsp;Web services"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-web-services"></a>21.5&nbsp;Web services</h2></div></div></div>

<p>Spring provides full support for standard Java web services APIs:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Exposing web services using JAX-WS
</li><li class="listitem">
Accessing web services using JAX-WS
</li></ul></div>

<p>In addition to stock support for JAX-WS in Spring Core, the Spring portfolio also
features <a class="ulink" href="http://www.springframework.org/spring-ws" target="_top">Spring Web Services</a>, a solution for
contract-first, document-driven web services - highly recommended for building modern,
future-proof web services.</p>
<div class="section" title="21.5.1&nbsp;Exposing servlet-based web services using JAX-WS"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-web-services-jaxws-export-servlet"></a>21.5.1&nbsp;Exposing servlet-based web services using JAX-WS</h3></div></div></div>

<p>Spring provides a convenient base class for JAX-WS servlet endpoint implementations -
<code class="literal">SpringBeanAutowiringSupport</code>. To expose our <code class="literal">AccountService</code> we extend Spring&#8217;s
<code class="literal">SpringBeanAutowiringSupport</code> class and implement our business logic here, usually
delegating the call to the business layer. We&#8217;ll simply use Spring&#8217;s <code class="literal">@Autowired</code>
annotation for expressing such dependencies on Spring-managed beans.</p>
<pre class="programlisting"><b class="hl-tag" style="color: blue">/**
 * JAX-WS compliant AccountService implementation that simply delegates
 * to the AccountService implementation in the root web application context.
 *
 * This wrapper class is necessary because JAX-WS requires working with dedicated
 * endpoint classes. If an existing service needs to be exported, a wrapper that
 * extends SpringBeanAutowiringSupport for simple Spring bean autowiring (through
 * the @Autowired annotation) is the simplest JAX-WS compliant way.
 *
 * This is the class registered with the server-side JAX-WS implementation.
 * In the case of a Java EE 5 server, this would simply be defined as a servlet
 * in web.xml, with the server detecting that this is a JAX-WS endpoint and reacting
 * accordingly. The servlet name usually needs to match the specified WS service name.
 *
 * The web service engine manages the lifecycle of instances of this class.
 * Spring bean references will just be wired in here.
 */</b>
<span class="hl-keyword">import</span> org.springframework.web.context.support.SpringBeanAutowiringSupport;

<i><span class="hl-annotation" style="color: gray">@WebService(serviceName="AccountService")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AccountServiceEndpoint <span class="hl-keyword">extends</span> SpringBeanAutowiringSupport {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> AccountService biz;

    <i><span class="hl-annotation" style="color: gray">@WebMethod</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> insertAccount(Account acc) {
        biz.insertAccount(acc);
    }

    <i><span class="hl-annotation" style="color: gray">@WebMethod</span></i>
    <span class="hl-keyword">public</span> Account[] getAccounts(String name) {
        <span class="hl-keyword">return</span> biz.getAccounts(name);
    }

}</pre>

<p>Our <code class="literal">AccountServletEndpoint</code> needs to run in the same web application as the Spring
context to allow for access to Spring&#8217;s facilities. This is the case by default in Java
EE 5 environments, using the standard contract for JAX-WS servlet endpoint deployment.
See Java EE 5 web service tutorials for details.</p>
</div>
<div class="section" title="21.5.2&nbsp;Exporting standalone web services using JAX-WS"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-web-services-jaxws-export-standalone"></a>21.5.2&nbsp;Exporting standalone web services using JAX-WS</h3></div></div></div>

<p>The built-in JAX-WS provider that comes with Oracle&#8217;s JDK 1.6 supports exposure of web
services using the built-in HTTP server that&#8217;s included in JDK 1.6 as well. Spring&#8217;s
<code class="literal">SimpleJaxWsServiceExporter</code> detects all <code class="literal">@WebService</code> annotated beans in the Spring
application context, exporting them through the default JAX-WS server (the JDK 1.6 HTTP
server).</p>
<p>In this scenario, the endpoint instances are defined and managed as Spring beans
themselves; they will be registered with the JAX-WS engine but their lifecycle will be
up to the Spring application context. This means that Spring functionality like explicit
dependency injection may be applied to the endpoint instances. Of course,
annotation-driven injection through <code class="literal">@Autowired</code> will work as well.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.jaxws.SimpleJaxWsServiceExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"baseAddress"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://localhost:8080/"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountServiceEndpoint"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.AccountServiceEndpoint"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/bean&gt;</span>

...</pre>

<p>The <code class="literal">AccountServiceEndpoint</code> may derive from Spring&#8217;s <code class="literal">SpringBeanAutowiringSupport</code> but
doesn&#8217;t have to since the endpoint is a fully Spring-managed bean here. This means that
the endpoint implementation may look like as follows, without any superclass declared -
and Spring&#8217;s <code class="literal">@Autowired</code> configuration annotation still being honored:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@WebService(serviceName="AccountService")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AccountServiceEndpoint {

    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> AccountService biz;

    <i><span class="hl-annotation" style="color: gray">@WebMethod</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> insertAccount(Account acc) {
        biz.insertAccount(acc);
    }

    <i><span class="hl-annotation" style="color: gray">@WebMethod</span></i>
    <span class="hl-keyword">public</span> List&lt;Account&gt; getAccounts(String name) {
        <span class="hl-keyword">return</span> biz.getAccounts(name);
    }

}</pre>

</div>
<div class="section" title="21.5.3&nbsp;Exporting web services using the JAX-WS RI&#8217;s Spring support"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-web-services-jaxws-export-ri"></a>21.5.3&nbsp;Exporting web services using the JAX-WS RI&#8217;s Spring support</h3></div></div></div>

<p>Oracle&#8217;s JAX-WS RI, developed as part of the GlassFish project, ships Spring support as
part of its JAX-WS Commons project. This allows for defining JAX-WS endpoints as
Spring-managed beans, similar to the standalone mode discussed in the previous section -
but this time in a Servlet environment. <span class="emphasis"><em>Note that this is not portable in a Java EE 5
environment; it is mainly intended for non-EE environments such as Tomcat, embedding the
JAX-WS RI as part of the web application.</em></span></p>
<p>The difference to the standard style of exporting servlet-based endpoints is that the
lifecycle of the endpoint instances themselves will be managed by Spring here, and that
there will be only one JAX-WS servlet defined in <code class="literal">web.xml</code>. With the standard Java EE 5
style (as illustrated above), you&#8217;ll have one servlet definition per service endpoint,
with each endpoint typically delegating to Spring beans (through the use of
<code class="literal">@Autowired</code>, as shown above).</p>
<p>Check out
<a class="ulink" href="https://jax-ws-commons.dev.java.net/spring/" target="_top">https://jax-ws-commons.dev.java.net/spring/</a>
for the details on setup and usage style.</p>
</div>
<div class="section" title="21.5.4&nbsp;Accessing web services using JAX-WS"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-web-services-jaxws-access"></a>21.5.4&nbsp;Accessing web services using JAX-WS</h3></div></div></div>

<p>Spring provides two factory beans to create JAX-WS web service proxies, namely
<code class="literal">LocalJaxWsServiceFactoryBean</code> and <code class="literal">JaxWsPortProxyFactoryBean</code>. The former can only
return a JAX-WS service class for us to work with. The latter is the full-fledged
version that can return a proxy that implements our business service interface. In this
example we use the latter to create a proxy for the <code class="literal">AccountService</code> endpoint (again):</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountWebService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.jaxws.JaxWsPortProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.AccountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"wsdlDocumentUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://localhost:8888/AccountServiceEndpoint?WSDL"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"namespaceUri"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://example/"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"AccountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"portName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"AccountServiceEndpointPort"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Where <code class="literal">serviceInterface</code> is our business interface the clients will use.
<code class="literal">wsdlDocumentUrl</code> is the URL for the WSDL file. Spring needs this a startup time to
create the JAX-WS Service. <code class="literal">namespaceUri</code> corresponds to the targetNamespace in the
.wsdl file. <code class="literal">serviceName</code> corresponds to the service name in the .wsdl file. <code class="literal">portName</code>
corresponds to the port name in the .wsdl file.</p>
<p>Accessing the web service is now very easy as we have a bean factory for it that will
expose it as <code class="literal">AccountService</code> interface. We can wire this up in Spring:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.AccountClientImpl"</span><span class="hl-tag">&gt;</span>
    ...
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountWebService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>From the client code we can access the web service just as if it was a normal class:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AccountClientImpl {

    <span class="hl-keyword">private</span> AccountService service;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setService(AccountService service) {
        <span class="hl-keyword">this</span>.service = service;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> foo() {
        service.insertAccount(...);
    }
}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The above is slightly simplified in that JAX-WS requires endpoint interfaces
and implementation classes to be annotated with <code class="literal">@WebService</code>, <code class="literal">@SOAPBinding</code> etc
annotations. This means that you cannot (easily) use plain Java interfaces and
implementation classes as JAX-WS endpoint artifacts; you need to annotate them
accordingly first. Check the JAX-WS documentation for details on those requirements.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="21.6&nbsp;JMS"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-jms"></a>21.6&nbsp;JMS</h2></div></div></div>

<p>It is also possible to expose services transparently using JMS as the underlying
communication protocol. The JMS remoting support in the Spring Framework is pretty basic
- it sends and receives on the <code class="literal">same thread</code> and in the <span class="emphasis"><em>same non-transactional</em></span>
<code class="literal">Session</code>, and as such throughput will be very implementation dependent. Note that these
single-threaded and non-transactional constraints apply only to Spring&#8217;s JMS
<span class="emphasis"><em>remoting</em></span> support. See <a class="xref" href="#jms" title="23.&nbsp;JMS (Java Message Service)">Chapter&nbsp;23, <i>JMS (Java Message Service)</i></a> for information on Spring&#8217;s rich support for JMS-based
<span class="emphasis"><em>messaging</em></span>.</p>
<p>The following interface is used on both the server and the client side.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> CheckingAccountService {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> cancelAccount(Long accountId);

}</pre>

<p>The following simple implementation of the above interface is used on the server-side.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleCheckingAccountService <span class="hl-keyword">implements</span> CheckingAccountService {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> cancelAccount(Long accountId) {
        System.out.println(<span class="hl-string">"Cancelling account ["</span> + accountId + <span class="hl-string">"]"</span>);
    }

}</pre>

<p>This configuration file contains the JMS-infrastructure beans that are shared on both
the client and server.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.activemq.ActiveMQConnectionFactory"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"brokerURL"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"tcp://ep-t43:61616"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queue"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.activemq.command.ActiveMQQueue"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"mmm"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="section" title="21.6.1&nbsp;Server-side configuration"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-jms-server"></a>21.6.1&nbsp;Server-side configuration</h3></div></div></div>

<p>On the server, you just need to expose the service object using the
<code class="literal">JmsInvokerServiceExporter</code>.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkingAccountService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.remoting.JmsInvokerServiceExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.foo.CheckingAccountService"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.SimpleCheckingAccountService"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.SimpleMessageListenerContainer"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destination"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queue"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"concurrentConsumers"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageListener"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"checkingAccountService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Server {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) <span class="hl-keyword">throws</span> Exception {
        <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-keyword">new</span> String[]{<span class="hl-string">"com/foo/server.xml"</span>, <span class="hl-string">"com/foo/jms.xml"</span>});
    }

}</pre>

</div>
<div class="section" title="21.6.2&nbsp;Client-side configuration"><div class="titlepage"><div><div><h3 class="title"><a name="remoting-jms-client"></a>21.6.2&nbsp;Client-side configuration</h3></div></div></div>

<p>The client merely needs to create a client-side proxy that will implement the agreed
upon interface ( <code class="literal">CheckingAccountService</code>). The resulting object created off the back of
the following bean definition can be injected into other client side objects, and the
proxy will take care of forwarding the call to the server-side object via JMS.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkingAccountService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.remoting.JmsInvokerProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.foo.CheckingAccountService"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queue"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queue"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Client {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) <span class="hl-keyword">throws</span> Exception {
        ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(
                <span class="hl-keyword">new</span> String[] {<span class="hl-string">"com/foo/client.xml"</span>, <span class="hl-string">"com/foo/jms.xml"</span>});
        CheckingAccountService service = (CheckingAccountService) ctx.getBean(<span class="hl-string">"checkingAccountService"</span>);
        service.cancelAccount(<span class="hl-keyword">new</span> Long(<span class="hl-number">10</span>));
    }

}</pre>

<p>You may also wish to investigate the support provided by the
<a class="ulink" href="http://lingo.codehaus.org/" target="_top">Lingo</a> project, which (to quote the homepage blurb) "<span class="emphasis"><em>&#8230; is
a lightweight POJO based remoting and messaging library based on the Spring Framework&#8217;s
remoting libraries which extends it to support JMS.</em></span>"</p>
</div>
</div>
<div class="section" title="21.7&nbsp;AMQP"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-amqp"></a>21.7&nbsp;AMQP</h2></div></div></div>

<p>Refer to the <a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/amqp.html#remoting" target="_top">Spring
AMQP Reference Document <span class="emphasis"><em>Spring Remoting with AMQP</em></span> section</a> for more information.</p>
</div>
<div class="section" title="21.8&nbsp;Auto-detection is not implemented for remote interfaces"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-autodection-remote-interfaces"></a>21.8&nbsp;Auto-detection is not implemented for remote interfaces</h2></div></div></div>

<p>The main reason why auto-detection of implemented interfaces does not occur for remote
interfaces is to avoid opening too many doors to remote callers. The target object might
implement internal callback interfaces like <code class="literal">InitializingBean</code> or <code class="literal">DisposableBean</code> which
one would not want to expose to callers.</p>
<p>Offering a proxy with all interfaces implemented by the target usually does not matter
in the local case. But when exporting a remote service, you should expose a specific
service interface, with specific operations intended for remote usage. Besides internal
callback interfaces, the target might implement multiple business interfaces, with just
one of them intended for remote exposure. For these reasons, we <span class="emphasis"><em>require</em></span> such a
service interface to be specified.</p>
<p>This is a trade-off between configuration convenience and the risk of accidental
exposure of internal methods. Always specifying a service interface is not too much
effort, and puts you on the safe side regarding controlled exposure of specific methods.</p>
</div>
<div class="section" title="21.9&nbsp;Considerations when choosing a technology"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remoting-considerations"></a>21.9&nbsp;Considerations when choosing a technology</h2></div></div></div>

<p>Each and every technology presented here has its drawbacks. You should carefully
consider your needs, the services you are exposing and the objects you&#8217;ll be sending
over the wire when choosing a technology.</p>
<p>When using RMI, it&#8217;s not possible to access the objects through the HTTP protocol,
unless you&#8217;re tunneling the RMI traffic. RMI is a fairly heavy-weight protocol in that
it supports full-object serialization which is important when using a complex data model
that needs serialization over the wire. However, RMI-JRMP is tied to Java clients: It is
a Java-to-Java remoting solution.</p>
<p>Spring&#8217;s HTTP invoker is a good choice if you need HTTP-based remoting but also rely on
Java serialization. It shares the basic infrastructure with RMI invokers, just using
HTTP as transport. Note that HTTP invokers are not only limited to Java-to-Java remoting
but also to Spring on both the client and server side. (The latter also applies to
Spring&#8217;s RMI invoker for non-RMI interfaces.)</p>
<p>Hessian and/or Burlap might provide significant value when operating in a heterogeneous
environment, because they explicitly allow for non-Java clients. However, non-Java
support is still limited. Known issues include the serialization of Hibernate objects in
combination with lazily-initialized collections. If you have such a data model, consider
using RMI or HTTP invokers instead of Hessian.</p>
<p>JMS can be useful for providing clusters of services and allowing the JMS broker to take
care of load balancing, discovery and auto-failover. By default: Java serialization is
used when using JMS remoting but the JMS provider could use a different mechanism for
the wire formatting, such as XStream to allow servers to be implemented in other
technologies.</p>
<p>Last but not least, EJB has an advantage over RMI in that it supports standard
role-based authentication and authorization and remote transaction propagation. It is
possible to get RMI invokers or HTTP invokers to support security context propagation as
well, although this is not provided by core Spring: There are just appropriate hooks for
plugging in third-party or custom solutions here.</p>
</div>
<div class="section" title="21.10&nbsp;Accessing RESTful services on the Client"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-client-access"></a>21.10&nbsp;Accessing RESTful services on the Client</h2></div></div></div>

<p>The <code class="literal">RestTemplate</code> is the core class for client-side access to RESTful services. It is
conceptually similar to other template classes in Spring, such as <code class="literal">JdbcTemplate</code> and
<code class="literal">JmsTemplate</code> and other template classes found in other Spring portfolio projects.
<code class="literal">RestTemplate</code>'s behavior is customized by providing callback methods and configuring
the <code class="literal">HttpMessageConverter</code> used to marshal objects into the HTTP request body and to
unmarshal any response back into an object. As it is common to use XML as a message
format, Spring provides a <code class="literal">MarshallingHttpMessageConverter</code> that uses the Object-to-XML
framework that is part of the <code class="literal">org.springframework.oxm</code> package. This gives you a wide
range of choices of XML to Object mapping technologies to choose from.</p>
<p>This section describes how to use the <code class="literal">RestTemplate</code> and its associated
<code class="literal">HttpMessageConverters</code>.</p>
<div class="section" title="21.10.1&nbsp;RestTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="rest-resttemplate"></a>21.10.1&nbsp;RestTemplate</h3></div></div></div>

<p>Invoking RESTful services in Java is typically done using a helper class such as Apache
HttpComponents <code class="literal">HttpClient</code>. For common REST operations this approach is too low level as
shown below.</p>
<pre class="programlisting">String uri = <span class="hl-string">"http://example.com/hotels/1/bookings"</span>;

PostMethod post = <span class="hl-keyword">new</span> PostMethod(uri);
String request = <span class="hl-comment">// create booking request content</span>
post.setRequestEntity(<span class="hl-keyword">new</span> StringRequestEntity(request));

httpClient.executeMethod(post);

<span class="hl-keyword">if</span> (HttpStatus.SC_CREATED == post.getStatusCode()) {
    Header location = post.getRequestHeader(<span class="hl-string">"Location"</span>);
    <span class="hl-keyword">if</span> (location != null) {
        System.out.println(<span class="hl-string">"Created new booking at :"</span> + location.getValue());
    }
}</pre>

<p>RestTemplate provides higher level methods that correspond to each of the six main HTTP
methods that make invoking many RESTful services a one-liner and enforce REST best
practices.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>RestTemplate has an asynchronous counter-part: see <a class="xref" href="#rest-async-resttemplate" title="21.10.3&nbsp;Async RestTemplate">Section&nbsp;21.10.3, &#8220;Async RestTemplate&#8221;</a>.</p>
</td></tr></table></div>

<div class="table"><a name="rest-overview-of-resttemplate-methods-tbl"></a><p class="title"><b>Table&nbsp;21.1.&nbsp;Overview of RestTemplate methods</b></p><div class="table-contents">

  <table summary="Overview of RestTemplate methods" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">HTTP Method</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">RestTemplate Method</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DELETE</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#delete(String,%20Object%E2%80%A6)" target="_top">delete</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>GET</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#getForObject(String,%20Class,%20Object%E2%80%A6)" target="_top">getForObject</a>
  <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#getForEntity(String,%20Class,%20Object%E2%80%A6)" target="_top">getForEntity</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HEAD</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#headForHeaders(String,%20Object%E2%80%A6)" target="_top">headForHeaders(String
  url, String&#8230; urlVariables)</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>OPTIONS</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#optionsForAllow(String,%20Object%E2%80%A6)" target="_top">optionsForAllow(String
  url, String&#8230; urlVariables)</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>POST</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#postForLocation(String,%20Object,%20Object%E2%80%A6)" target="_top">postForLocation(String
  url, Object request, String&#8230; urlVariables)</a>
  <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#postForObject(java.lang.String,%20java.lang.Object,%20java.lang.Class,%20java.lang.String%E2%80%A6)" target="_top">postForObject(String
  url, Object request, Class&lt;T&gt; responseType, String&#8230; uriVariables)</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PUT</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#put(String,%20Object,%20Object%E2%80%A6)" target="_top">put(String
  url, Object request, String&#8230;urlVariables)</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>PATCH and others</p></td><td style="" align="left" valign="top"><p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#exchange(java.lang.String,%20org.springframework.http.HttpMethod,%20org.springframework.http.HttpEntity,%20java.lang.Class,%20java.lang.Object%E2%80%A6)" target="_top">exchange</a>
  <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html#execute(java.lang.String,%20org.springframework.http.HttpMethod,%20org.springframework.web.client.RequestCallback,%20org.springframework.web.client.ResponseExtractor,%20java.lang.Object%E2%80%A6)" target="_top">execute</a></p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>The names of <code class="literal">RestTemplate</code> methods follow a naming convention, the first part indicates
what HTTP method is being invoked and the second part indicates what is returned. For
example, the method <code class="literal">getForObject()</code> will perform a GET, convert the HTTP response into
an object type of your choice and return that object. The method <code class="literal">postForLocation()</code>
will do a POST, converting the given object into a HTTP request and return the response
HTTP Location header where the newly created object can be found. In case of an
exception processing the HTTP request, an exception of the type <code class="literal">RestClientException</code>
will be thrown; this behavior can be changed by plugging in another
<code class="literal">ResponseErrorHandler</code> implementation into the <code class="literal">RestTemplate</code>.</p>
<p>The <code class="literal">exchange</code> and <code class="literal">execute</code> methods are generalized versions of the more
specific methods listed above them and can support additional combinations and methods,
like HTTP PATCH. However, note that the underlying HTTP library must also support the
desired combination. The JDK <code class="literal">HttpURLConnection</code> does not support the <code class="literal">PATCH</code> method, but
Apache HttpComponents HttpClient version 4.2 or later does. They also enable
<code class="literal">RestTemplate</code> to read an HTTP response to a generic type (e.g. <code class="literal">List&lt;Account&gt;</code>), using a
<code class="literal">ParameterizedTypeReference</code>, a new class that enables capturing and passing generic
type info.</p>
<p>Objects passed to and returned from these methods are converted to and from HTTP
messages by <code class="literal">HttpMessageConverter</code> instances. Converters for the main mime types are
registered by default, but you can also write your own converter and register it via the
<code class="literal">messageConverters()</code> bean property. The default converter instances registered with the
template are <code class="literal">ByteArrayHttpMessageConverter</code>, <code class="literal">StringHttpMessageConverter</code>,
<code class="literal">FormHttpMessageConverter</code> and <code class="literal">SourceHttpMessageConverter</code>. You can override these
defaults using the <code class="literal">messageConverters()</code> bean property as would be required if using the
<code class="literal">MarshallingHttpMessageConverter</code> or <code class="literal">MappingJackson2HttpMessageConverter</code>.</p>
<p>Each method takes URI template arguments in two forms, either as a <code class="literal">String</code> variable
length argument or a <code class="literal">Map&lt;String,String&gt;</code>. For example,</p>
<pre class="programlisting">String result = restTemplate.getForObject(
        <span class="hl-string">"http://example.com/hotels/{hotel}/bookings/{booking}"</span>, String.<span class="hl-keyword">class</span>,<span class="hl-string">"42"</span>, <span class="hl-string">"21"</span>);</pre>

<p>using variable length arguments and</p>
<pre class="programlisting">Map&lt;String, String&gt; vars = Collections.singletonMap(<span class="hl-string">"hotel"</span>, <span class="hl-string">"42"</span>);
String result = restTemplate.getForObject(
        <span class="hl-string">"http://example.com/hotels/{hotel}/rooms/{hotel}"</span>, String.<span class="hl-keyword">class</span>, vars);</pre>

<p>using a <code class="literal">Map&lt;String,String&gt;</code>.</p>
<p>To create an instance of <code class="literal">RestTemplate</code> you can simply call the default no-arg
constructor. This will use standard Java classes from the <code class="literal">java.net</code> package as the
underlying implementation to create HTTP requests. This can be overridden by specifying
an implementation of <code class="literal">ClientHttpRequestFactory</code>. Spring provides the implementation
<code class="literal">HttpComponentsClientHttpRequestFactory</code> that uses the Apache HttpComponents
<code class="literal">HttpClient</code> to create requests. <code class="literal">HttpComponentsClientHttpRequestFactory</code> is configured
using an instance of <code class="literal">org.apache.http.client.HttpClient</code> which can in turn be configured
with credentials information or connection pooling functionality.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Note that the <code class="literal">java.net</code> implementation for HTTP requests may raise an exception when
accessing the status of a response that represents an error (e.g. 401). If this is an
issue, switch to <code class="literal">HttpComponentsClientHttpRequestFactory</code> instead.</p>
</td></tr></table></div>

<p>The previous example using Apache HttpComponents <code class="literal">HttpClient</code> directly rewritten to use
the <code class="literal">RestTemplate</code> is shown below</p>
<pre class="programlisting">uri = <span class="hl-string">"http://example.com/hotels/{id}/bookings"</span>;

RestTemplate template = <span class="hl-keyword">new</span> RestTemplate();

Booking booking = <span class="hl-comment">// create booking object</span>

URI location = template.postForLocation(uri, booking, <span class="hl-string">"1"</span>);</pre>

<p>To use Apache HttpComponents instead of the native <code class="literal">java.net</code> functionality, construct
the <code class="literal">RestTemplate</code> as follows:</p>
<pre class="programlisting">RestTemplate template = <span class="hl-keyword">new</span> RestTemplate(<span class="hl-keyword">new</span> HttpComponentsClientHttpRequestFactory());</pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Apache HttpClient supports gzip encoding via the <code class="literal">DecompressingHttpClient</code>. To use it,
construct a <code class="literal">HttpComponentsClientHttpRequestFactory</code> like so:</p>
<pre class="programlisting">HttpClient httpClient = <span class="hl-keyword">new</span> DecompressingHttpClient(<span class="hl-keyword">new</span> DefaultHttpClient());
ClientHttpRequestFactory requestFactory = <span class="hl-keyword">new</span> HttpComponentsClientHttpRequestFactory(httpClient);
RestTemplate template = <span class="hl-keyword">new</span> RestTemplate(requestFactory);</pre>

</td></tr></table></div>

<p>The general callback interface is <code class="literal">RequestCallback</code> and is called when the execute
method is invoked.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> &lt;T&gt; T execute(String url, HttpMethod method, RequestCallback requestCallback,
        ResponseExtractor&lt;T&gt; responseExtractor, String... urlVariables)

<span class="hl-comment">// also has an overload with urlVariables as a Map&lt;String, String&gt;.</span></pre>

<p>The <code class="literal">RequestCallback</code> interface is defined as</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RequestCallback {
 <span class="hl-keyword">void</span> doWithRequest(ClientHttpRequest request) <span class="hl-keyword">throws</span> IOException;
}</pre>

<p>and allows you to manipulate the request headers and write to the request body. When
using the execute method you do not have to worry about any resource management, the
template will always close the request and handle any errors. Refer to the API
documentation for more information on using the execute method and the meaning of its
other method arguments.</p>
<div class="section" title="Working with the URI"><div class="titlepage"><div><div><h4 class="title"><a name="rest-resttemplate-uri"></a>Working with the URI</h4></div></div></div>

<p>For each of the main HTTP methods, the <code class="literal">RestTemplate</code> provides variants that either take
a String URI or <code class="literal">java.net.URI</code> as the first argument.</p>
<p>The String URI variants accept template arguments as a String variable length argument
or as a <code class="literal">Map&lt;String,String&gt;</code>. They also assume the URL String is not encoded and needs
to be encoded. For example the following:</p>
<pre class="programlisting">restTemplate.getForObject(<span class="hl-string">"http://example.com/hotel list"</span>, String.<span class="hl-keyword">class</span>);</pre>

<p>will perform a GET on <code class="literal">http://example.com/hotel%20list</code>. That means if the input URL
String is already encoded, it will be encoded twice&#8201;&#8212;&#8201;i.e.
<code class="literal">http://example.com/hotel%20list</code> will become <code class="literal">http://example.com/hotel%2520list</code>. If
this is not the intended effect, use the <code class="literal">java.net.URI</code> method variant, which assumes
the URL is already encoded is also generally useful if you want to reuse a single (fully
expanded) <code class="literal">URI</code> multiple times.</p>
<p>The <code class="literal">UriComponentsBuilder</code> class can be used to build and encode the <code class="literal">URI</code> including
support for URI templates. For example you can start with a URL String:</p>
<pre class="programlisting">UriComponents uriComponents = UriComponentsBuilder.fromUriString(
        <span class="hl-string">"http://example.com/hotels/{hotel}/bookings/{booking}"</span>).build()
        .expand(<span class="hl-string">"42"</span>, <span class="hl-string">"21"</span>)
        .encode();

URI uri = uriComponents.toUri();</pre>

<p>Or specify each URI component individually:</p>
<pre class="programlisting">UriComponents uriComponents = UriComponentsBuilder.newInstance()
        .scheme(<span class="hl-string">"http"</span>).host(<span class="hl-string">"example.com"</span>).path(<span class="hl-string">"/hotels/{hotel}/bookings/{booking}"</span>).build()
        .expand(<span class="hl-string">"42"</span>, <span class="hl-string">"21"</span>)
        .encode();

URI uri = uriComponents.toUri();</pre>

</div>
<div class="section" title="Dealing with request and response headers"><div class="titlepage"><div><div><h4 class="title"><a name="rest-template-headers"></a>Dealing with request and response headers</h4></div></div></div>

<p>Besides the methods described above, the <code class="literal">RestTemplate</code> also has the <code class="literal">exchange()</code>
method, which can be used for arbitrary HTTP method execution based on the <code class="literal">HttpEntity</code>
class.</p>
<p>Perhaps most importantly, the <code class="literal">exchange()</code> method can be used to add request headers and
read response headers. For example:</p>
<pre class="programlisting">HttpHeaders requestHeaders = <span class="hl-keyword">new</span> HttpHeaders();
requestHeaders.set(<span class="hl-string">"MyRequestHeader"</span>, <span class="hl-string">"MyValue"</span>);
HttpEntity&lt;?&gt; requestEntity = <span class="hl-keyword">new</span> HttpEntity(requestHeaders);

HttpEntity&lt;String&gt; response = template.exchange(
        <span class="hl-string">"http://example.com/hotels/{hotel}"</span>,
        HttpMethod.GET, requestEntity, String.<span class="hl-keyword">class</span>, <span class="hl-string">"42"</span>);

String responseHeader = response.getHeaders().getFirst(<span class="hl-string">"MyResponseHeader"</span>);
String body = response.getBody();</pre>

<p>In the above example, we first prepare a request entity that contains the
<code class="literal">MyRequestHeader</code> header. We then retrieve the response, and read the <code class="literal">MyResponseHeader</code>
and body.</p>
</div>
</div>
<div class="section" title="21.10.2&nbsp;HTTP Message Conversion"><div class="titlepage"><div><div><h3 class="title"><a name="rest-message-conversion"></a>21.10.2&nbsp;HTTP Message Conversion</h3></div></div></div>

<p>Objects passed to and returned from the methods <code class="literal">getForObject()</code>, <code class="literal">postForLocation()</code>,
and <code class="literal">put()</code> are converted to HTTP requests and from HTTP responses by
<code class="literal">HttpMessageConverters</code>. The <code class="literal">HttpMessageConverter</code> interface is shown below to give you
a better feel for its functionality</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> HttpMessageConverter&lt;T&gt; {

    <span class="hl-comment">// Indicate whether the given class and media type can be read by this converter.</span>
    <span class="hl-keyword">boolean</span> canRead(Class&lt;?&gt; clazz, MediaType mediaType);

    <span class="hl-comment">// Indicate whether the given class and media type can be written by this converter.</span>
    <span class="hl-keyword">boolean</span> canWrite(Class&lt;?&gt; clazz, MediaType mediaType);

    <span class="hl-comment">// Return the list of MediaType objects supported by this converter.</span>
    List&lt;MediaType&gt; getSupportedMediaTypes();

    <span class="hl-comment">// Read an object of the given type from the given input message, and returns it.</span>
    T read(Class&lt;T&gt; clazz, HttpInputMessage inputMessage) <span class="hl-keyword">throws</span> IOException, HttpMessageNotReadableException;

    <span class="hl-comment">// Write an given object to the given output message.</span>
    <span class="hl-keyword">void</span> write(T t, HttpOutputMessage outputMessage) <span class="hl-keyword">throws</span> IOException, HttpMessageNotWritableException;

}</pre>

<p>Concrete implementations for the main media (mime) types are provided in the framework
and are registered by default with the <code class="literal">RestTemplate</code> on the client-side and with
<code class="literal">AnnotationMethodHandlerAdapter</code> on the server-side.</p>
<p>The implementations of <code class="literal">HttpMessageConverter</code> s are described in the following sections.
For all converters a default media type is used but can be overridden by setting the
<code class="literal">supportedMediaTypes</code> bean property</p>
<div class="section" title="StringHttpMessageConverter"><div class="titlepage"><div><div><h4 class="title"><a name="rest-string-converter"></a>StringHttpMessageConverter</h4></div></div></div>

<p>An <code class="literal">HttpMessageConverter</code> implementation that can read and write Strings from the HTTP
request and response. By default, this converter supports all text media types (
<code class="literal">text/*</code>), and writes with a <code class="literal">Content-Type</code> of <code class="literal">text/plain</code>.</p>
</div>
<div class="section" title="FormHttpMessageConverter"><div class="titlepage"><div><div><h4 class="title"><a name="rest-form-converter"></a>FormHttpMessageConverter</h4></div></div></div>

<p>An <code class="literal">HttpMessageConverter</code> implementation that can read and write form data from the HTTP
request and response. By default, this converter reads and writes the media type
<code class="literal">application/x-www-form-urlencoded</code>. Form data is read from and written into a
<code class="literal">MultiValueMap&lt;String, String&gt;</code>.</p>
</div>
<div class="section" title="ByteArrayHttpMessageConverter"><div class="titlepage"><div><div><h4 class="title"><a name="rest-byte-converter"></a>ByteArrayHttpMessageConverter</h4></div></div></div>

<p>An <code class="literal">HttpMessageConverter</code> implementation that can read and write byte arrays from the
HTTP request and response. By default, this converter supports all media types ( <code class="literal">*/*</code>),
and writes with a <code class="literal">Content-Type</code> of <code class="literal">application/octet-stream</code>. This can be overridden
by setting the <code class="literal">supportedMediaTypes</code> property, and overriding <code class="literal">getContentType(byte[])</code>.</p>
</div>
<div class="section" title="MarshallingHttpMessageConverter"><div class="titlepage"><div><div><h4 class="title"><a name="rest-marhsalling-converter"></a>MarshallingHttpMessageConverter</h4></div></div></div>

<p>An <code class="literal">HttpMessageConverter</code> implementation that can read and write XML using Spring&#8217;s
<code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code> abstractions from the <code class="literal">org.springframework.oxm</code> package.
This converter requires a <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code> before it can be used. These
can be injected via constructor or bean properties. By default this converter supports (
<code class="literal">text/xml</code>) and ( <code class="literal">application/xml</code>).</p>
</div>
<div class="section" title="MappingJackson2HttpMessageConverter (or MappingJacksonHttpMessageConverter with Jackson 1.x)"><div class="titlepage"><div><div><h4 class="title"><a name="rest-mapping-json-converter"></a>MappingJackson2HttpMessageConverter (or MappingJacksonHttpMessageConverter with Jackson 1.x)</h4></div></div></div>

<p>An <code class="literal">HttpMessageConverter</code> implementation that can read and write JSON using Jackson&#8217;s
<code class="literal">ObjectMapper</code>. JSON mapping can be customized as needed through the use of Jackson&#8217;s
provided annotations. When further control is needed, a custom <code class="literal">ObjectMapper</code> can be
injected through the <code class="literal">ObjectMapper</code> property for cases where custom JSON
serializers/deserializers need to be provided for specific types. By default this
converter supports ( <code class="literal">application/json</code>).</p>
</div>
<div class="section" title="SourceHttpMessageConverter"><div class="titlepage"><div><div><h4 class="title"><a name="rest-source-converter"></a>SourceHttpMessageConverter</h4></div></div></div>

<p>An <code class="literal">HttpMessageConverter</code> implementation that can read and write
<code class="literal">javax.xml.transform.Source</code> from the HTTP request and response. Only <code class="literal">DOMSource</code>,
<code class="literal">SAXSource</code>, and <code class="literal">StreamSource</code> are supported. By default, this converter supports (
<code class="literal">text/xml</code>) and ( <code class="literal">application/xml</code>).</p>
</div>
<div class="section" title="BufferedImageHttpMessageConverter"><div class="titlepage"><div><div><h4 class="title"><a name="rest-buffered-image-converter"></a>BufferedImageHttpMessageConverter</h4></div></div></div>

<p>An <code class="literal">HttpMessageConverter</code> implementation that can read and write
<code class="literal">java.awt.image.BufferedImage</code> from the HTTP request and response. This converter reads
and writes the media type supported by the Java I/O API.</p>
</div>
</div>
<div class="section" title="21.10.3&nbsp;Async RestTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="rest-async-resttemplate"></a>21.10.3&nbsp;Async RestTemplate</h3></div></div></div>

<p>Web applications often need to query external REST services those days. The very nature of
HTTP and synchronous calls can lead up to challenges when scaling applications for those
needs: multiple threads may be blocked, waiting for remote HTTP responses.</p>
<p><code class="literal">AsyncRestTemplate</code> and <a class="xref" href="#rest-resttemplate" title="21.10.1&nbsp;RestTemplate">Section&nbsp;21.10.1, &#8220;RestTemplate&#8221;</a>'s APIs are very similar; see
<a class="xref" href="#rest-overview-of-resttemplate-methods-tbl" title="Table&nbsp;21.1.&nbsp;Overview of RestTemplate methods">Table&nbsp;21.1, &#8220;Overview of RestTemplate methods&#8221;</a>. The main difference between those APIs is
that <code class="literal">AsyncRestTemplate</code> returns
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/util/concurrent/ListenableFuture.html" target="_top"><code class="literal">ListenableFuture</code></a>
wrappers as opposed to concrete results.</p>
<p>The previous <code class="literal">RestTemplate</code> example translates to:</p>
<pre class="programlisting"><span class="hl-comment">// async call</span>
Future&lt;ResponseEntity&lt;String&gt;&gt; futureEntity = template.getForEntity(
    <span class="hl-string">"http://example.com/hotels/{hotel}/bookings/{booking}"</span>, String.<span class="hl-keyword">class</span>, <span class="hl-string">"42"</span>, <span class="hl-string">"21"</span>);

<span class="hl-comment">// get the concrete result - synchronous call</span>
ResponseEntity&lt;String&gt; entity = futureEntity.get();</pre>

<p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/util/concurrent/ListenableFuture.html" target="_top"><code class="literal">ListenableFuture</code></a>
accepts completion callbacks:</p>
<pre class="programlisting">ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; futureEntity = template.getForEntity(
    <span class="hl-string">"http://example.com/hotels/{hotel}/bookings/{booking}"</span>, String.<span class="hl-keyword">class</span>, <span class="hl-string">"42"</span>, <span class="hl-string">"21"</span>);

<span class="hl-comment">// register a callback</span>
futureEntity.addCallback(<span class="hl-keyword">new</span> ListenableFutureCallback&lt;ResponseEntity&lt;String&gt;&gt;() {
    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onSuccess(ResponseEntity&lt;String&gt; entity) {
        <span class="hl-comment">//...</span>
    }

    <i><span class="hl-annotation" style="color: gray">@Override</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onFailure(Throwable t) {
        <span class="hl-comment">//...</span>
    }
});</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The default <code class="literal">AsyncRestTemplate</code> constructor registers a
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/task/SimpleAsyncTaskExecutor.html" target="_top"><code class="literal">SimpleAsyncTaskExecutor</code>
</a> for executing HTTP requests.
When dealing with a large number of short-lived requests, a thread-pooling TaskExecutor
implementation like
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html" target="_top"><code class="literal">ThreadPoolTaskExecutor</code></a>
may be a good choice.</p>
</td></tr></table></div>

<p>See <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/util/concurrent/ListenableFuture.html" target="_top"><code class="literal">ListenableFuture</code>
Javadoc</a> and
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/AsyncRestTemplate.html" target="_top"><code class="literal">AsyncRestTemplate</code>
Javadoc</a> for more details.</p>
</div>
</div>
</div>
<div class="chapter" title="22.&nbsp;Enterprise JavaBeans (EJB) integration"><div class="titlepage"><div><div><h2 class="title"><a name="ejb"></a>22.&nbsp;Enterprise JavaBeans (EJB) integration</h2></div></div></div>

<div class="section" title="22.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ejb-introduction"></a>22.1&nbsp;Introduction</h2></div></div></div>

<p>As a lightweight container, Spring is often considered an EJB replacement. We do believe
that for many if not most applications and use cases, Spring as a container, combined
with its rich supporting functionality in the area of transactions, ORM and JDBC access,
is a better choice than implementing equivalent functionality via an EJB container and
EJBs.</p>
<p>However, it is important to note that using Spring does not prevent you from using EJBs.
In fact, Spring makes it much easier to access EJBs and implement EJBs and functionality
within them. Additionally, using Spring to access services provided by EJBs allows the
implementation of those services to later transparently be switched between local EJB,
remote EJB, or POJO (plain old Java object) variants, without the client code having to
be changed.</p>
<p>In this chapter, we look at how Spring can help you access and implement EJBs. Spring
provides particular value when accessing stateless session beans (SLSBs), so we&#8217;ll begin
by discussing this.</p>
</div>
<div class="section" title="22.2&nbsp;Accessing EJBs"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ejb-access"></a>22.2&nbsp;Accessing EJBs</h2></div></div></div>

<div class="section" title="22.2.1&nbsp;Concepts"><div class="titlepage"><div><div><h3 class="title"><a name="ejb-access-concepts"></a>22.2.1&nbsp;Concepts</h3></div></div></div>

<p>To invoke a method on a local or remote stateless session bean, client code must
normally perform a JNDI lookup to obtain the (local or remote) EJB Home object, then use
a <span class="emphasis"><em>create</em></span> method call on that object to obtain the actual (local or remote) EJB object.
One or more methods are then invoked on the EJB.</p>
<p>To avoid repeated low-level code, many EJB applications use the Service Locator and
Business Delegate patterns. These are better than spraying JNDI lookups throughout
client code, but their usual implementations have significant disadvantages. For example:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Typically code using EJBs depends on Service Locator or Business Delegate singletons,
making it hard to test.
</li><li class="listitem">
In the case of the Service Locator pattern used without a Business Delegate,
application code still ends up having to invoke the create() method on an EJB home,
and deal with the resulting exceptions. Thus it remains tied to the EJB API and the
complexity of the EJB programming model.
</li><li class="listitem">
Implementing the Business Delegate pattern typically results in significant code
duplication, where we have to write numerous methods that simply call the same method
on the EJB.
</li></ul></div>

<p>The Spring approach is to allow the creation and use of proxy objects, normally
configured inside a Spring container, which act as codeless business delegates. You do
not need	to write another Service Locator, another JNDI lookup, or duplicate methods in
a hand-coded Business Delegate unless you are actually adding real value in such code.</p>
</div>
<div class="section" title="22.2.2&nbsp;Accessing local SLSBs"><div class="titlepage"><div><div><h3 class="title"><a name="ejb-access-local"></a>22.2.2&nbsp;Accessing local SLSBs</h3></div></div></div>

<p>Assume that we have a web controller that needs to use a local EJB. We&#8217;ll follow best
practice and use the EJB Business Methods Interface pattern, so that the EJB&#8217;s local
interface extends a non EJB-specific business methods interface. Let&#8217;s call this
business methods interface <code class="literal">MyComponent</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyComponent {
    ...
}</pre>

<p>One of the main reasons to use the Business Methods Interface pattern is to ensure that
synchronization between method signatures in local interface and bean implementation
class is automatic. Another reason is that it later makes it much easier for us to
switch to a POJO (plain old Java object) implementation of the service if it makes sense
to do so. Of course we&#8217;ll also need to implement the local home interface and provide an
implementation class that implements <code class="literal">SessionBean</code> and the <code class="literal">MyComponent</code> business
methods interface. Now the only Java coding we&#8217;ll need to do to hook up our web tier
controller to the EJB implementation is to expose a setter method of type <code class="literal">MyComponent</code>
on the controller. This will save the reference as an instance variable in the
controller:</p>
<pre class="programlisting"><span class="hl-keyword">private</span> MyComponent myComponent;

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMyComponent(MyComponent myComponent) {
    <span class="hl-keyword">this</span>.myComponent = myComponent;
}</pre>

<p>We can subsequently use this instance variable in any business method in the controller.
Now assuming we are obtaining our controller object out of a Spring container, we can
(in the same context) configure a <code class="literal">LocalStatelessSessionProxyFactoryBean</code> instance,
which will be the EJB proxy object. The configuration of the proxy, and setting of the
<code class="literal">myComponent</code> property of the controller is done with a configuration entry such as:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myComponent"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.ejb.access.LocalStatelessSessionProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ejb/myBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"businessInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.mycom.MyComponent"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myController"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycom.myController"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myComponent"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myComponent"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>There&#8217;s a lot of work happening behind the scenes, courtesy of the Spring AOP framework,
although you aren&#8217;t forced to work with AOP concepts to enjoy the results. The
<code class="literal">myComponent</code> bean definition creates a proxy for the EJB, which implements the business
method interface. The EJB local home is cached on startup, so there&#8217;s only a single JNDI
lookup. Each time the EJB is invoked, the proxy invokes the <code class="literal">classname</code> method on the
local EJB and invokes the	corresponding business method on the EJB.</p>
<p>The <code class="literal">myController</code> bean definition sets the <code class="literal">myComponent</code> property of the controller
class to the EJB proxy.</p>
<p>Alternatively (and preferably in case of many such proxy definitions), consider using
the <code class="literal">&lt;jee:local-slsb&gt;</code> configuration element in Spring&#8217;s "jee" namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:local-slsb</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myComponent"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"ejb/myBean"</span>
        <span class="hl-attribute">business-interface</span>=<span class="hl-value">"com.mycom.MyComponent"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myController"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycom.myController"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myComponent"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myComponent"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This EJB access mechanism delivers huge simplification of application code: the web tier
code (or other EJB client code) has no dependence on the use of EJB. If we want to
replace this EJB reference with a POJO or a mock object or other test stub, we could
simply change the <code class="literal">myComponent</code> bean definition without changing a line of Java code.
Additionally, we haven&#8217;t had to write a single line of JNDI lookup or other EJB plumbing
code as part of our application.</p>
<p>Benchmarks and experience in real applications indicate that the performance overhead of
this approach (which involves reflective invocation of the target EJB) is minimal, and
is typically undetectable in typical use. Remember that we don&#8217;t want to make
fine-grained calls to EJBs anyway, as there&#8217;s a cost associated with the EJB
infrastructure in the application server.</p>
<p>There is one caveat with regards to the JNDI lookup. In a bean container, this class is
normally best used as a singleton (there simply is no reason to make it a prototype).
However, if that bean container pre-instantiates singletons (as do the various XML
<code class="literal">ApplicationContext</code> variants) you may have a problem if the bean container is loaded
before the EJB container loads the target EJB. That is because the JNDI lookup will be
performed in the <code class="literal">init()</code> method of this class and then cached, but the EJB will not
have been bound at the target location yet. The solution is to not pre-instantiate this
factory object, but allow it to be created on first use. In the XML containers, this is
controlled via the <code class="literal">lazy-init</code> attribute.</p>
<p>Although this will not be of interest to the majority of Spring users, those doing
programmatic AOP work with EJBs may want to look at <code class="literal">LocalSlsbInvokerInterceptor</code>.</p>
</div>
<div class="section" title="22.2.3&nbsp;Accessing remote SLSBs"><div class="titlepage"><div><div><h3 class="title"><a name="ejb-access-remote"></a>22.2.3&nbsp;Accessing remote SLSBs</h3></div></div></div>

<p>Accessing remote EJBs is essentially identical to accessing local EJBs, except that the
<code class="literal">SimpleRemoteStatelessSessionProxyFactoryBean</code> or <code class="literal">&lt;jee:remote-slsb&gt;</code> configuration
element is used. Of course, with or without Spring, remote invocation semantics apply; a
call to a method on an object in another VM in another computer does sometimes have to
be treated differently in terms of usage scenarios and failure handling.</p>
<p>Spring&#8217;s EJB client support adds one more advantage over the non-Spring approach.
Normally it is problematic for EJB client code to be easily switched back and forth
between calling EJBs locally or remotely. This is because the remote interface methods
must declare that they throw <code class="literal">RemoteException</code>, and client code must deal with this,
while the local interface methods don&#8217;t. Client code written for local EJBs which needs
to be moved to remote EJBs typically has to be modified to add handling for the remote
exceptions, and client code written for remote EJBs which needs to be moved to local
EJBs, can either stay the same but do a lot of unnecessary handling of remote
exceptions, or needs to be modified to remove that code. With the Spring remote EJB
proxy, you can instead not declare any thrown <code class="literal">RemoteException</code> in your Business Method
Interface and implementing EJB code, have a remote interface which is identical except
that it does throw <code class="literal">RemoteException</code>, and rely on the proxy to dynamically treat the two
interfaces as if they were the same. That is, client code does not have to deal with the
checked <code class="literal">RemoteException</code> class. Any actual <code class="literal">RemoteException</code> that is thrown during the
EJB invocation will be re-thrown as the non-checked <code class="literal">RemoteAccessException</code> class, which
is a subclass of <code class="literal">RuntimeException</code>. The target service can then be switched at will
between a local EJB or remote EJB (or even plain Java object) implementation, without
the client code knowing or caring. Of course, this is optional; there is nothing
stopping you from declaring <code class="literal">RemoteExceptions</code> in your business interface.</p>
</div>
<div class="section" title="22.2.4&nbsp;Accessing EJB 2.x SLSBs versus EJB 3 SLSBs"><div class="titlepage"><div><div><h3 class="title"><a name="ejb-access-ejb2-ejb3"></a>22.2.4&nbsp;Accessing EJB 2.x SLSBs versus EJB 3 SLSBs</h3></div></div></div>

<p>Accessing EJB 2.x Session Beans and EJB 3 Session Beans via Spring is largely
transparent. Spring&#8217;s EJB accessors, including the <code class="literal">&lt;jee:local-slsb&gt;</code> and
<code class="literal">&lt;jee:remote-slsb&gt;</code> facilities, transparently adapt to the actual component at runtime.
They handle a home interface if found (EJB 2.x style), or perform straight component
invocations if no home interface is available (EJB 3 style).</p>
<p>Note: For EJB 3 Session Beans, you could effectively use a <code class="literal">JndiObjectFactoryBean</code> /
<code class="literal">&lt;jee:jndi-lookup&gt;</code> as well, since fully usable component references are exposed for
plain JNDI lookups there. Defining explicit <code class="literal">&lt;jee:local-slsb&gt;</code> / <code class="literal">&lt;jee:remote-slsb&gt;</code>
lookups simply provides consistent and more explicit EJB access configuration.</p>
</div>
</div>
<div class="section" title="22.3&nbsp;Using Spring&#8217;s EJB implementation support classes"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ejb-implementation"></a>22.3&nbsp;Using Spring&#8217;s EJB implementation support classes</h2></div></div></div>

<div class="section" title="22.3.1&nbsp;EJB 3 injection interceptor"><div class="titlepage"><div><div><h3 class="title"><a name="ejb-implementation-ejb3"></a>22.3.1&nbsp;EJB 3 injection interceptor</h3></div></div></div>

<p>For EJB 3 Session Beans and Message-Driven Beans, Spring provides a convenient
interceptor that resolves Spring&#8217;s <code class="literal">@Autowired</code> annotation in the EJB component
class: <code class="literal">org.springframework.ejb.interceptor.SpringBeanAutowiringInterceptor</code>. This
interceptor can be applied through an <code class="literal">@Interceptors</code> annotation in the EJB component
class, or through an <code class="literal">interceptor-binding</code> XML element in the EJB deployment descriptor.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Stateless</span></i>
<i><span class="hl-annotation" style="color: gray">@Interceptors(SpringBeanAutowiringInterceptor.class)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFacadeEJB <span class="hl-keyword">implements</span> MyFacadeLocal {

    <span class="hl-comment">// automatically injected with a matching Spring bean</span>
    <i><span class="hl-annotation" style="color: gray">@Autowired</span></i>
    <span class="hl-keyword">private</span> MyComponent myComp;

    <span class="hl-comment">// for business method, delegate to POJO service impl.</span>
    <span class="hl-keyword">public</span> String myFacadeMethod(...) {
        <span class="hl-keyword">return</span> myComp.myMethod(...);
    }

    ...

}</pre>

<p><code class="literal">SpringBeanAutowiringInterceptor</code> by default obtains target beans from a
<code class="literal">ContextSingletonBeanFactoryLocator</code>, with the context defined in a bean definition file
named <code class="literal">beanRefContext.xml</code>. By default, a single context definition is expected, which
is obtained by type rather than by name. However, if you need to choose between multiple
context definitions, a specific locator key is required. The locator key (i.e. the name
of the context definition in <code class="literal">beanRefContext.xml</code>) can be explicitly specified either
through overriding the <code class="literal">getBeanFactoryLocatorKey</code> method in a custom
<code class="literal">SpringBeanAutowiringInterceptor</code> subclass.</p>
<p>Alternatively, consider overriding <code class="literal">SpringBeanAutowiringInterceptor</code>'s <code class="literal">getBeanFactory</code>
method, e.g. obtaining a shared <code class="literal">ApplicationContext</code> from a custom holder class.</p>
</div>
</div>
</div>
<div class="chapter" title="23.&nbsp;JMS (Java Message Service)"><div class="titlepage"><div><div><h2 class="title"><a name="jms"></a>23.&nbsp;JMS (Java Message Service)</h2></div></div></div>

<div class="section" title="23.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-introduction"></a>23.1&nbsp;Introduction</h2></div></div></div>

<p>Spring provides a JMS integration framework that simplifies the use of the JMS API much
like Spring&#8217;s integration does for the JDBC API.</p>
<p>JMS can be roughly divided into two areas of functionality, namely the production and
consumption of messages. The <code class="literal">JmsTemplate</code> class is used for message production and
synchronous message reception. For asynchronous reception similar to Java EE&#8217;s
message-driven bean style, Spring provides a number of message listener containers that
are used to create Message-Driven POJOs (MDPs).</p>
<p>The package <code class="literal">org.springframework.jms.core</code> provides the core functionality for using
JMS. It contains JMS template classes that simplify the use of the JMS by handling the
creation and release of resources, much like the <code class="literal">JdbcTemplate</code> does for JDBC. The
design principle common to Spring template classes is to provide helper methods to
perform common operations and for more sophisticated usage, delegate the essence of the
processing task to user implemented callback interfaces. The JMS template follows the
same design. The classes offer various convenience methods for the sending of messages,
consuming a message synchronously, and exposing the JMS session and message producer to
the user.</p>
<p>The package <code class="literal">org.springframework.jms.support</code> provides <code class="literal">JMSException</code> translation
functionality. The translation converts the checked <code class="literal">JMSException</code> hierarchy to a
mirrored hierarchy of unchecked exceptions. If there are any provider specific
subclasses of the checked <code class="literal">javax.jms.JMSException</code>, this exception is wrapped in the
unchecked <code class="literal">UncategorizedJmsException</code>.</p>
<p>The package <code class="literal">org.springframework.jms.support.converter</code> provides a <code class="literal">MessageConverter</code>
abstraction to convert between Java objects and JMS messages.</p>
<p>The package <code class="literal">org.springframework.jms.support.destination</code> provides various strategies
for managing JMS destinations, such as providing a service locator for destinations
stored in JNDI.</p>
<p>Finally, the package <code class="literal">org.springframework.jms.connection</code> provides an implementation of
the <code class="literal">ConnectionFactory</code> suitable for use in standalone applications. It also contains an
implementation of Spring&#8217;s <code class="literal">PlatformTransactionManager</code> for JMS (the cunningly named
<code class="literal">JmsTransactionManager</code>). This allows for seamless integration of JMS as a transactional
resource into Spring&#8217;s transaction management mechanisms.</p>
</div>
<div class="section" title="23.2&nbsp;Using Spring JMS"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-using"></a>23.2&nbsp;Using Spring JMS</h2></div></div></div>

<div class="section" title="23.2.1&nbsp;JmsTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="jms-jmstemplate"></a>23.2.1&nbsp;JmsTemplate</h3></div></div></div>

<p>The <code class="literal">JmsTemplate</code> class is the central class in the JMS core package. It simplifies the
use of JMS since it handles the creation and release of resources when sending or
synchronously receiving messages.</p>
<p>Code that uses the <code class="literal">JmsTemplate</code> only needs to implement callback interfaces giving them
a clearly defined high level contract. The <code class="literal">MessageCreator</code> callback interface creates a
message given a <code class="literal">Session</code> provided by the calling code in <code class="literal">JmsTemplate</code>. In order to
allow for more complex usage of the JMS API, the callback <code class="literal">SessionCallback</code> provides the
user with the JMS session and the callback <code class="literal">ProducerCallback</code> exposes a <code class="literal">Session</code> and
<code class="literal">MessageProducer</code> pair.</p>
<p>The JMS API exposes two types of send methods, one that takes delivery mode, priority,
and time-to-live as Quality of Service (QOS) parameters and one that takes no QOS
parameters which uses default values. Since there are many send methods in
<code class="literal">JmsTemplate</code>, the setting of the QOS parameters have been exposed as bean properties to
avoid duplication in the number of send methods. Similarly, the timeout value for
synchronous receive calls is set using the property <code class="literal">setReceiveTimeout</code>.</p>
<p>Some JMS providers allow the setting of default QOS values administratively through the
configuration of the ConnectionFactory. This has the effect that a call to
<code class="literal">MessageProducer</code>'s send method <code class="literal">send(Destination destination, Message message)</code> will
use different QOS default values than those specified in the JMS specification. In order
to provide consistent management of QOS values, the <code class="literal">JmsTemplate</code> must therefore be
specifically enabled to use its own QOS values by setting the boolean property
<code class="literal">isExplicitQosEnabled</code> to <code class="literal">true</code>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Instances of the <code class="literal">JmsTemplate</code> class are <span class="emphasis"><em>thread-safe once configured</em></span>. This is
important because it means that you can configure a single instance of a <code class="literal">JmsTemplate</code>
and then safely inject this <span class="emphasis"><em>shared</em></span> reference into multiple collaborators. To be
clear, the <code class="literal">JmsTemplate</code> is stateful, in that it maintains a reference to a
<code class="literal">ConnectionFactory</code>, but this state is <span class="emphasis"><em>not</em></span> conversational state.</p>
</td></tr></table></div>

</div>
<div class="section" title="23.2.2&nbsp;Connections"><div class="titlepage"><div><div><h3 class="title"><a name="jms-connections"></a>23.2.2&nbsp;Connections</h3></div></div></div>

<p>The <code class="literal">JmsTemplate</code> requires a reference to a <code class="literal">ConnectionFactory</code>. The <code class="literal">ConnectionFactory</code>
is part of the JMS specification and serves as the entry point for working with JMS. It
is used by the client application as a factory to create connections with the JMS
provider and encapsulates various configuration parameters, many of which are vendor
specific such as SSL configuration options.</p>
<p>When using JMS inside an EJB, the vendor provides implementations of the JMS interfaces
so that they can participate in declarative transaction management and perform pooling
of connections and sessions. In order to use this implementation, Java EE containers
typically require that you declare a JMS connection factory as a <code class="literal">resource-ref</code> inside
the EJB or servlet deployment descriptors. To ensure the use of these features with the
<code class="literal">JmsTemplate</code> inside an EJB, the client application should ensure that it references the
managed implementation of the <code class="literal">ConnectionFactory</code>.</p>
<div class="section" title="Caching Messaging Resources"><div class="titlepage"><div><div><h4 class="title"><a name="jms-caching-resources"></a>Caching Messaging Resources</h4></div></div></div>

<p>The standard API involves creating many intermediate objects. To send a message the
following <span class="emphasis"><em>API</em></span> walk is performed</p>

<pre class="literallayout">ConnectionFactory-&gt;Connection-&gt;Session-&gt;MessageProducer-&gt;send</pre>

<p>Between the ConnectionFactory and the Send operation there are three intermediate
objects that are created and destroyed. To optimise the resource usage and increase
performance two implementations of IConnectionFactory are provided.</p>
</div>
<div class="section" title="SingleConnectionFactory"><div class="titlepage"><div><div><h4 class="title"><a name="jms-connection-factory"></a>SingleConnectionFactory</h4></div></div></div>

<p>Spring provides an implementation of the <code class="literal">ConnectionFactory</code> interface,
<code class="literal">SingleConnectionFactory</code>, that will return the same <code class="literal">Connection</code> on all
<code class="literal">createConnection()</code> calls and ignore calls to <code class="literal">close()</code>. This is useful for testing and
standalone environments so that the same connection can be used for multiple
<code class="literal">JmsTemplate</code> calls that may span any number of transactions. <code class="literal">SingleConnectionFactory</code>
takes a reference to a standard <code class="literal">ConnectionFactory</code> that would typically come from JNDI.</p>
</div>
<div class="section" title="CachingConnectionFactory"><div class="titlepage"><div><div><h4 class="title"><a name="jdbc-connection-factory-caching"></a>CachingConnectionFactory</h4></div></div></div>

<p>The <code class="literal">CachingConnectionFactory</code> extends the functionality of <code class="literal">SingleConnectionFactory</code>
and adds the caching of Sessions, MessageProducers, and MessageConsumers. The initial
cache size is set to 1, use the property <code class="literal">SessionCacheSize</code> to increase the number of
cached sessions. Note that the number of actual cached sessions will be more than that
number as sessions are cached based on their acknowledgment mode, so there can be up to
4 cached session instances when <code class="literal">SessionCacheSize</code> is set to one, one for each
AcknowledgementMode. MessageProducers and MessageConsumers are cached within their
owning session and also take into account the unique properties of the producers and
consumers when caching. MessageProducers are cached based on their destination.
MessageConsumers are cached based on a key composed of the destination, selector,
noLocal delivery flag, and the durable subscription name (if creating durable consumers).</p>
</div>
</div>
<div class="section" title="23.2.3&nbsp;Destination Management"><div class="titlepage"><div><div><h3 class="title"><a name="jms-destinations"></a>23.2.3&nbsp;Destination Management</h3></div></div></div>

<p>Destinations, like ConnectionFactories, are JMS administered objects that can be stored
and retrieved in JNDI. When configuring a Spring application context you can use the
JNDI factory class <code class="literal">JndiObjectFactoryBean</code> / <code class="literal">&lt;jee:jndi-lookup&gt;</code> to perform dependency
injection on your object&#8217;s references to JMS destinations. However, often this strategy
is cumbersome if there are a large number of destinations in the application or if there
are advanced destination management features unique to the JMS provider. Examples of
such advanced destination management would be the creation of dynamic destinations or
support for a hierarchical namespace of destinations. The <code class="literal">JmsTemplate</code> delegates the
resolution of a destination name to a JMS destination object to an implementation of the
interface <code class="literal">DestinationResolver</code>. <code class="literal">DynamicDestinationResolver</code> is the default
implementation used by <code class="literal">JmsTemplate</code> and accommodates resolving dynamic destinations. A
<code class="literal">JndiDestinationResolver</code> is also provided that acts as a service locator for
destinations contained in JNDI and optionally falls back to the behavior contained in
<code class="literal">DynamicDestinationResolver</code>.</p>
<p>Quite often the destinations used in a JMS application are only known at runtime and
therefore cannot be administratively created when the application is deployed. This is
often because there is shared application logic between interacting system components
that create destinations at runtime according to a well-known naming convention. Even
though the creation of dynamic destinations is not part of the JMS specification, most
vendors have provided this functionality. Dynamic destinations are created with a name
defined by the user which differentiates them from temporary destinations and are often
not registered in JNDI. The API used to create dynamic destinations varies from provider
to provider since the properties associated with the destination are vendor specific.
However, a simple implementation choice that is sometimes made by vendors is to
disregard the warnings in the JMS specification and to use the <code class="literal">TopicSession</code> method
<code class="literal">createTopic(String topicName)</code> or the <code class="literal">QueueSession</code> method <code class="literal">createQueue(String
queueName)</code> to create a new destination with default destination properties. Depending
on the vendor implementation, <code class="literal">DynamicDestinationResolver</code> may then also create a
physical destination instead of only resolving one.</p>
<p>The boolean property <code class="literal">pubSubDomain</code> is used to configure the <code class="literal">JmsTemplate</code> with
knowledge of what JMS domain is being used. By default the value of this property is
false, indicating that the point-to-point domain, Queues, will be used. This property
used by <code class="literal">JmsTemplate</code> determines the behavior of dynamic destination resolution via
implementations of the <code class="literal">DestinationResolver</code> interface.</p>
<p>You can also configure the <code class="literal">JmsTemplate</code> with a default destination via the property
<code class="literal">defaultDestination</code>. The default destination will be used with send and receive
operations that do not refer to a specific destination.</p>
</div>
<div class="section" title="23.2.4&nbsp;Message Listener Containers"><div class="titlepage"><div><div><h3 class="title"><a name="jms-mdp"></a>23.2.4&nbsp;Message Listener Containers</h3></div></div></div>

<p>One of the most common uses of JMS messages in the EJB world is to drive message-driven
beans (MDBs). Spring offers a solution to create message-driven POJOs (MDPs) in a way
that does not tie a user to an EJB container. (See <a class="xref" href="#jms-asynchronousMessageReception" title="23.4.2&nbsp;Asynchronous Reception - Message-Driven POJOs">Section&nbsp;23.4.2, &#8220;Asynchronous Reception - Message-Driven POJOs&#8221;</a>
for detailed coverage of Spring&#8217;s MDP support.)</p>
<p>A message listener container is used to receive messages from a JMS message queue and
drive the MessageListener that is injected into it. The listener container is
responsible for all threading of message reception and dispatches into the listener for
processing. A message listener container is the intermediary between an MDP and a
messaging provider, and takes care of registering to receive messages, participating in
transactions, resource acquisition and release, exception conversion and suchlike. This
allows you as an application developer to write the (possibly complex) business logic
associated with receiving a message (and possibly responding to it), and delegates
boilerplate JMS infrastructure concerns to the framework.</p>
<p>There are two standard JMS message listener containers packaged with Spring, each with
its specialised feature set.</p>
<div class="section" title="SimpleMessageListenerContainer"><div class="titlepage"><div><div><h4 class="title"><a name="jms-mdp-simple"></a>SimpleMessageListenerContainer</h4></div></div></div>

<p>This message listener container is the simpler of the two standard flavors. It creates a
fixed number of JMS sessions and consumers at startup, registers the listener using the
standard JMS <code class="literal">MessageConsumer.setMessageListener()</code> method, and leaves it up the JMS
provider to perform listener callbacks. This variant does not allow for dynamic adaption
to runtime demands or for participation in externally managed transactions.
Compatibility-wise, it stays very close to the spirit of the standalone JMS
specification - but is generally not compatible with Java EE&#8217;s JMS restrictions.</p>
</div>
<div class="section" title="DefaultMessageListenerContainer"><div class="titlepage"><div><div><h4 class="title"><a name="jms-mdp-default"></a>DefaultMessageListenerContainer</h4></div></div></div>

<p>This message listener container is the one used in most cases. In contrast to
<code class="literal">SimpleMessageListenerContainer</code>, this container variant does allow for dynamic adaption
to runtime demands and is able to participate in externally managed transactions. Each
received message is registered with an XA transaction when configured with a
<code class="literal">JtaTransactionManager</code>; so processing may take advantage of XA transaction semantics.
This listener container strikes a good balance between low requirements on the JMS
provider, advanced functionality such as transaction participation, and compatibility
with Java EE environments.</p>
</div>
</div>
<div class="section" title="23.2.5&nbsp;Transaction management"><div class="titlepage"><div><div><h3 class="title"><a name="jms-tx"></a>23.2.5&nbsp;Transaction management</h3></div></div></div>

<p>Spring provides a <code class="literal">JmsTransactionManager</code> that manages transactions for a single JMS
<code class="literal">ConnectionFactory</code>. This allows JMS applications to leverage the managed transaction
features of Spring as described in <a class="xref" href="#transaction" title="11.&nbsp;Transaction Management">Chapter&nbsp;11, <i>Transaction Management</i></a>. The <code class="literal">JmsTransactionManager</code> performs
local resource transactions, binding a JMS Connection/Session pair from the specified
<code class="literal">ConnectionFactory</code> to the thread. <code class="literal">JmsTemplate</code> automatically detects such
transactional resources and operates on them accordingly.</p>
<p>In a Java EE environment, the <code class="literal">ConnectionFactory</code> will pool Connections and Sessions, so
those resources are efficiently reused across transactions. In a standalone environment,
using Spring&#8217;s <code class="literal">SingleConnectionFactory</code> will result in a shared JMS <code class="literal">Connection</code>, with
each transaction having its own independent <code class="literal">Session</code>. Alternatively, consider the use
of a provider-specific pooling adapter such as ActiveMQ&#8217;s <code class="literal">PooledConnectionFactory</code>
class.</p>
<p><code class="literal">JmsTemplate</code> can also be used with the <code class="literal">JtaTransactionManager</code> and an XA-capable JMS
<code class="literal">ConnectionFactory</code> for performing distributed transactions. Note that this requires the
use of a JTA transaction manager as well as a properly XA-configured ConnectionFactory!
(Check your Java EE server&#8217;s / JMS provider&#8217;s documentation.)</p>
<p>Reusing code across a managed and unmanaged transactional environment can be confusing
when using the JMS API to create a <code class="literal">Session</code> from a <code class="literal">Connection</code>. This is because the
JMS API has only one factory method to create a <code class="literal">Session</code> and it requires values for the
transaction and acknowledgement modes. In a managed environment, setting these values is
the responsibility of the environment&#8217;s transactional infrastructure, so these values
are ignored by the vendor&#8217;s wrapper to the JMS Connection. When using the <code class="literal">JmsTemplate</code>
in an unmanaged environment you can specify these values through the use of the
properties <code class="literal">sessionTransacted</code> and <code class="literal">sessionAcknowledgeMode</code>. When using a
<code class="literal">PlatformTransactionManager</code> with <code class="literal">JmsTemplate</code>, the template will always be given a
transactional JMS <code class="literal">Session</code>.</p>
</div>
</div>
<div class="section" title="23.3&nbsp;Sending a Message"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-sending"></a>23.3&nbsp;Sending a Message</h2></div></div></div>

<p>The <code class="literal">JmsTemplate</code> contains many convenience methods to send a message. There are send
methods that specify the destination using a <code class="literal">javax.jms.Destination</code> object and those
that specify the destination using a string for use in a JNDI lookup. The send method
that takes no destination argument uses the default destination. Here is an example that
sends a message to a queue using the 1.0.2 implementation.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.jms.ConnectionFactory;
<span class="hl-keyword">import</span> javax.jms.JMSException;
<span class="hl-keyword">import</span> javax.jms.Message;
<span class="hl-keyword">import</span> javax.jms.Queue;
<span class="hl-keyword">import</span> javax.jms.Session;

<span class="hl-keyword">import</span> org.springframework.jms.core.MessageCreator;
<span class="hl-keyword">import</span> org.springframework.jms.core.JmsTemplate;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JmsQueueSender {

    <span class="hl-keyword">private</span> JmsTemplate jmsTemplate;
    <span class="hl-keyword">private</span> Queue queue;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setConnectionFactory(ConnectionFactory cf) {
        <span class="hl-keyword">this</span>.jmsTemplate = <span class="hl-keyword">new</span> JmsTemplate(cf);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setQueue(Queue queue) {
        <span class="hl-keyword">this</span>.queue = queue;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> simpleSend() {
        <span class="hl-keyword">this</span>.jmsTemplate.send(<span class="hl-keyword">this</span>.queue, <span class="hl-keyword">new</span> MessageCreator() {
            <span class="hl-keyword">public</span> Message createMessage(Session session) <span class="hl-keyword">throws</span> JMSException {
                <span class="hl-keyword">return</span> session.createTextMessage(<span class="hl-string">"hello queue world"</span>);
            }
        });
    }
}</pre>

<p>This example uses the <code class="literal">MessageCreator</code> callback to create a text message from the
supplied <code class="literal">Session</code> object. The <code class="literal">JmsTemplate</code> is constructed by passing a reference to a
<code class="literal">ConnectionFactory</code>. As an alternative, a zero argument constructor and
<code class="literal">connectionFactory</code> is provided and can be used for constructing the instance in
JavaBean style (using a BeanFactory or plain Java code). Alternatively, consider
deriving from Spring&#8217;s <code class="literal">JmsGatewaySupport</code> convenience base class, which provides
pre-built bean properties for JMS configuration.</p>
<p>The method <code class="literal">send(String destinationName, MessageCreator creator)</code> lets you send a
message using the string name of the destination. If these names are registered in JNDI,
you should set the <code class="literal">destinationResolver</code> property of the template to an instance of
<code class="literal">JndiDestinationResolver</code>.</p>
<p>If you created the <code class="literal">JmsTemplate</code> and specified a default destination, the
<code class="literal">send(MessageCreator c)</code> sends a message to that destination.</p>
<div class="section" title="23.3.1&nbsp;Using Message Converters"><div class="titlepage"><div><div><h3 class="title"><a name="jms-msg-conversion"></a>23.3.1&nbsp;Using Message Converters</h3></div></div></div>

<p>In order to facilitate the sending of domain model objects, the <code class="literal">JmsTemplate</code> has
various send methods that take a Java object as an argument for a message&#8217;s data
content. The overloaded methods <code class="literal">convertAndSend()</code> and <code class="literal">receiveAndConvert()</code> in
<code class="literal">JmsTemplate</code> delegate the conversion process to an instance of the <code class="literal">MessageConverter</code>
interface. This interface defines a simple contract to convert between Java objects and
JMS messages. The default implementation <code class="literal">SimpleMessageConverter</code> supports conversion
between <code class="literal">String</code> and <code class="literal">TextMessage</code>, <code class="literal">byte[]</code> and <code class="literal">BytesMesssage</code>, and <code class="literal">java.util.Map</code>
and <code class="literal">MapMessage</code>. By using the converter, you and your application code can focus on the
business object that is being sent or received via JMS and not be concerned with the
details of how it is represented as a JMS message.</p>
<p>The sandbox currently includes a <code class="literal">MapMessageConverter</code> which uses reflection to convert
between a JavaBean and a <code class="literal">MapMessage</code>. Other popular implementation choices you might
implement yourself are Converters that use an existing XML marshalling package, such as
JAXB, Castor, XMLBeans, or XStream, to create a <code class="literal">TextMessage</code> representing the object.</p>
<p>To accommodate the setting of a message&#8217;s properties, headers, and body that can not be
generically encapsulated inside a converter class, the <code class="literal">MessagePostProcessor</code> interface
gives you access to the message after it has been converted, but before it is sent. The
example below demonstrates how to modify a message header and a property after a
<code class="literal">java.util.Map</code> is converted to a message.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> sendWithConversion() {
    Map map = <span class="hl-keyword">new</span> HashMap();
    map.put(<span class="hl-string">"Name"</span>, <span class="hl-string">"Mark"</span>);
    map.put(<span class="hl-string">"Age"</span>, <span class="hl-keyword">new</span> Integer(<span class="hl-number">47</span>));
    jmsTemplate.convertAndSend(<span class="hl-string">"testQueue"</span>, map, <span class="hl-keyword">new</span> MessagePostProcessor() {
        <span class="hl-keyword">public</span> Message postProcessMessage(Message message) <span class="hl-keyword">throws</span> JMSException {
            message.setIntProperty(<span class="hl-string">"AccountID"</span>, <span class="hl-number">1234</span>);
            message.setJMSCorrelationID(<span class="hl-string">"123-00001"</span>);
            <span class="hl-keyword">return</span> message;
        }
    });
}</pre>

<p>This results in a message of the form:</p>

<pre class="literallayout">MapMessage={
	Header={
		... standard headers ...
		CorrelationID={123-00001}
	}
	Properties={
		AccountID={Integer:1234}
	}
	Fields={
		Name={String:Mark}
		Age={Integer:47}
	}
}</pre>

</div>
<div class="section" title="23.3.2&nbsp;SessionCallback and ProducerCallback"><div class="titlepage"><div><div><h3 class="title"><a name="jms-callbacks"></a>23.3.2&nbsp;SessionCallback and ProducerCallback</h3></div></div></div>

<p>While the send operations cover many common usage scenarios, there are cases when you
want to perform multiple operations on a JMS <code class="literal">Session</code> or <code class="literal">MessageProducer</code>. The
<code class="literal">SessionCallback</code> and <code class="literal">ProducerCallback</code> expose the JMS <code class="literal">Session</code> and <code class="literal">Session</code> /
<code class="literal">MessageProducer</code> pair respectively. The <code class="literal">execute()</code> methods on <code class="literal">JmsTemplate</code> execute
these callback methods.</p>
</div>
</div>
<div class="section" title="23.4&nbsp;Receiving a message"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-receiving"></a>23.4&nbsp;Receiving a message</h2></div></div></div>

<div class="section" title="23.4.1&nbsp;Synchronous Reception"><div class="titlepage"><div><div><h3 class="title"><a name="jms-receiving-sync"></a>23.4.1&nbsp;Synchronous Reception</h3></div></div></div>

<p>While JMS is typically associated with asynchronous processing, it is possible to
consume messages synchronously. The overloaded <code class="literal">receive(..)</code> methods provide this
functionality. During a synchronous receive, the calling thread blocks until a message
becomes available. This can be a dangerous operation since the calling thread can
potentially be blocked indefinitely. The property <code class="literal">receiveTimeout</code> specifies how long
the receiver should wait before giving up waiting for a message.</p>
</div>
<div class="section" title="23.4.2&nbsp;Asynchronous Reception - Message-Driven POJOs"><div class="titlepage"><div><div><h3 class="title"><a name="jms-asynchronousMessageReception"></a>23.4.2&nbsp;Asynchronous Reception - Message-Driven POJOs</h3></div></div></div>

<p>In a fashion similar to a Message-Driven Bean (MDB) in the EJB world, the Message-Driven
POJO (MDP) acts as a receiver for JMS messages. The one restriction (but see also below
for the discussion of the <code class="literal">MessageListenerAdapter</code> class) on an MDP is that it must
implement the <code class="literal">javax.jms.MessageListener</code> interface. Please also be aware that in the
case where your POJO will be receiving messages on multiple threads, it is important to
ensure that your implementation is thread-safe.</p>
<p>Below is a simple implementation of an MDP:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.jms.JMSException;
<span class="hl-keyword">import</span> javax.jms.Message;
<span class="hl-keyword">import</span> javax.jms.MessageListener;
<span class="hl-keyword">import</span> javax.jms.TextMessage;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleListener <span class="hl-keyword">implements</span> MessageListener {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onMessage(Message message) {
        <span class="hl-keyword">if</span> (message <span class="hl-keyword">instanceof</span> TextMessage) {
            <span class="hl-keyword">try</span> {
                System.out.println(((TextMessage) message).getText());
            }
            <span class="hl-keyword">catch</span> (JMSException ex) {
                <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException(ex);
            }
        }
        <span class="hl-keyword">else</span> {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> IllegalArgumentException(<span class="hl-string">"Message must be of type TextMessage"</span>);
        }
    }

}</pre>

<p>Once you&#8217;ve implemented your <code class="literal">MessageListener</code>, it&#8217;s time to create a message listener
container.</p>
<p>Find below an example of how to define and configure one of the message listener
containers that ships with Spring (in this case the <code class="literal">DefaultMessageListenerContainer</code>).</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- this is the Message Driven POJO (MDP) --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageListener"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"jmsexample.ExampleListener"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-comment">&lt;!-- and this is the message listener container --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsContainer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destination"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"destination"</span><span class="hl-tag">/&gt;</span>
    <span class="strong"><strong>&lt;property name="messageListener" ref="messageListener" /&gt;</strong></span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Please refer to the Spring Javadoc of the various message listener containers for a full
description of the features supported by each implementation.</p>
</div>
<div class="section" title="23.4.3&nbsp;the SessionAwareMessageListener interface"><div class="titlepage"><div><div><h3 class="title"><a name="jms-receiving-async-session-aware-message-listener"></a>23.4.3&nbsp;the SessionAwareMessageListener interface</h3></div></div></div>

<p>The <code class="literal">SessionAwareMessageListener</code> interface is a Spring-specific interface that provides
a similar contract to the JMS <code class="literal">MessageListener</code> interface, but also provides the message
handling method with access to the JMS <code class="literal">Session</code> from which the <code class="literal">Message</code> was received.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.jms.listener;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SessionAwareMessageListener {

    <span class="hl-keyword">void</span> onMessage(Message message, Session session) <span class="hl-keyword">throws</span> JMSException;

}</pre>

<p>You can choose to have your MDPs implement this interface (in preference to the standard
JMS <code class="literal">MessageListener</code> interface) if you want your MDPs to be able to respond to any
received messages (using the <code class="literal">Session</code> supplied in the <code class="literal">onMessage(Message, Session)</code>
method). All of the message listener container implementations that ship with Spring
have support for MDPs that implement either the <code class="literal">MessageListener</code> or
<code class="literal">SessionAwareMessageListener</code> interface. Classes that implement the
<code class="literal">SessionAwareMessageListener</code> come with the caveat that they are then tied to Spring
through the interface. The choice of whether or not to use it is left entirely up to you
as an application developer or architect.</p>
<p>Please note that the <code class="literal">'onMessage(..)'</code> method of the <code class="literal">SessionAwareMessageListener</code>
interface throws <code class="literal">JMSException</code>. In contrast to the standard JMS <code class="literal">MessageListener</code>
interface, when using the <code class="literal">SessionAwareMessageListener</code> interface, it is the
responsibility of the client code to handle any exceptions thrown.</p>
</div>
<div class="section" title="23.4.4&nbsp;the MessageListenerAdapter"><div class="titlepage"><div><div><h3 class="title"><a name="jms-receiving-async-message-listener-adapter"></a>23.4.4&nbsp;the MessageListenerAdapter</h3></div></div></div>

<p>The <code class="literal">MessageListenerAdapter</code> class is the final component in Spring&#8217;s asynchronous
messaging support: in a nutshell, it allows you to expose almost <span class="emphasis"><em>any</em></span> class as a MDP
(there are of course some constraints).</p>
<p>Consider the following interface definition. Notice that although the interface extends
neither the <code class="literal">MessageListener</code> nor <code class="literal">SessionAwareMessageListener</code> interfaces, it can still
be used as a MDP via the use of the <code class="literal">MessageListenerAdapter</code> class. Notice also how the
various message handling methods are strongly typed according to the <span class="emphasis"><em>contents</em></span> of the
various <code class="literal">Message</code> types that they can receive and handle.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageDelegate {

    <span class="hl-keyword">void</span> handleMessage(String message);

    <span class="hl-keyword">void</span> handleMessage(Map message);

    <span class="hl-keyword">void</span> handleMessage(<span class="hl-keyword">byte</span>[] message);

    <span class="hl-keyword">void</span> handleMessage(Serializable message);

}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultMessageDelegate <span class="hl-keyword">implements</span> MessageDelegate {
    <span class="hl-comment">// implementation elided for clarity...</span>
}</pre>

<p>In particular, note how the above implementation of the <code class="literal">MessageDelegate</code> interface (the
above <code class="literal">DefaultMessageDelegate</code> class) has <span class="emphasis"><em>no</em></span> JMS dependencies at all. It truly is a
POJO that we will make into an MDP via the following configuration.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- this is the Message Driven POJO (MDP) --&gt;</span>
<span class="strong"><strong>&lt;bean id="messageListener" class="org.springframework.jms.listener.adapter.MessageListenerAdapter"&gt;
    &lt;constructor-arg&gt;
        &lt;bean class="jmsexample.DefaultMessageDelegate"/&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;</strong></span>

<span class="hl-comment">&lt;!-- and this is the message listener container... --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsContainer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destination"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"destination"</span><span class="hl-tag">/&gt;</span>
    <span class="strong"><strong>&lt;property name="messageListener" ref="messageListener" /&gt;</strong></span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Below is an example of another MDP that can only handle the receiving of JMS
<code class="literal">TextMessage</code> messages. Notice how the message handling method is actually called
<code class="literal">'receive'</code> (the name of the message handling method in a <code class="literal">MessageListenerAdapter</code>
defaults to <code class="literal">'handleMessage'</code>), but it is configurable (as you will see below). Notice
also how the <code class="literal">'receive(..)'</code> method is strongly typed to receive and respond only to JMS
<code class="literal">TextMessage</code> messages.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TextMessageDelegate {

    <span class="hl-keyword">void</span> receive(TextMessage message);

}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultTextMessageDelegate <span class="hl-keyword">implements</span> TextMessageDelegate {
    <span class="hl-comment">// implementation elided for clarity...</span>
}</pre>

<p>The configuration of the attendant <code class="literal">MessageListenerAdapter</code> would look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageListener"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.adapter.MessageListenerAdapter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"jmsexample.DefaultTextMessageDelegate"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"defaultListenerMethod"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"receive"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-comment">&lt;!-- we don't want automatic message context extraction --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageConverter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;null/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Please note that if the above <code class="literal">'messageListener'</code> receives a JMS <code class="literal">Message</code> of a type
other than <code class="literal">TextMessage</code>, an <code class="literal">IllegalStateException</code> will be thrown (and subsequently
swallowed). Another of the capabilities of the <code class="literal">MessageListenerAdapter</code> class is the
ability to automatically send back a response <code class="literal">Message</code> if a handler method returns a
non-void value. Consider the interface and class:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ResponsiveTextMessageDelegate {

    <span class="hl-comment">// notice the return type...</span>
    String receive(TextMessage message);

}</pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultResponsiveTextMessageDelegate <span class="hl-keyword">implements</span> ResponsiveTextMessageDelegate {
    <span class="hl-comment">// implementation elided for clarity...</span>
}</pre>

<p>If the above <code class="literal">DefaultResponsiveTextMessageDelegate</code> is used in conjunction with a
<code class="literal">MessageListenerAdapter</code> then any non-null value that is returned from the execution of
the <code class="literal">'receive(..)'</code> method will (in the default configuration) be converted into a
<code class="literal">TextMessage</code>. The resulting <code class="literal">TextMessage</code> will then be sent to the <code class="literal">Destination</code> (if
one exists) defined in the JMS Reply-To property of the original <code class="literal">Message</code>, or the
default <code class="literal">Destination</code> set on the <code class="literal">MessageListenerAdapter</code> (if one has been configured);
if no <code class="literal">Destination</code> is found then an <code class="literal">InvalidDestinationException</code> will be thrown (and
please note that this exception <span class="emphasis"><em>will not</em></span> be swallowed and <span class="emphasis"><em>will</em></span> propagate up the
call stack).</p>
</div>
<div class="section" title="23.4.5&nbsp;Processing messages within transactions"><div class="titlepage"><div><div><h3 class="title"><a name="jms-tx-participation"></a>23.4.5&nbsp;Processing messages within transactions</h3></div></div></div>

<p>Invoking a message listener within a transaction only requires reconfiguration of the
listener container.</p>
<p>Local resource transactions can simply be activated through the <code class="literal">sessionTransacted</code> flag
on the listener container definition. Each message listener invocation will then operate
within an active JMS transaction, with message reception rolled back in case of listener
execution failure. Sending a response message (via <code class="literal">SessionAwareMessageListener</code>) will
be part of the same local transaction, but any other resource operations (such as
database access) will operate independently. This usually requires duplicate message
detection in the listener implementation, covering the case where database processing
has committed but message processing failed to commit.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsContainer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destination"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"destination"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageListener"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageListener"</span><span class="hl-tag">/&gt;</span>
    <span class="strong"><strong>&lt;property name="sessionTransacted" value="true"/&gt;</strong></span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>For participating in an externally managed transaction, you will need to configure a
transaction manager and use a listener container which supports externally managed
transactions: typically <code class="literal">DefaultMessageListenerContainer</code>.</p>
<p>To configure a message listener container for XA transaction participation, you&#8217;ll want
to configure a <code class="literal">JtaTransactionManager</code> (which, by default, delegates to the Java EE
server&#8217;s transaction subsystem). Note that the underlying JMS ConnectionFactory needs to
be XA-capable and properly registered with your JTA transaction coordinator! (Check your
Java EE server&#8217;s configuration of JNDI resources.) This allows message reception as well
as e.g. database access to be part of the same transaction (with unified commit
semantics, at the expense of XA transaction log overhead).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>

<p>Then you just need to add it to our earlier container configuration. The container will
take care of the rest.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsContainer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destination"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"destination"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageListener"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageListener"</span><span class="hl-tag">/&gt;</span>
    <span class="strong"><strong>&lt;property name="transactionManager" ref="transactionManager"/&gt;</strong></span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
</div>
<div class="section" title="23.5&nbsp;Support for JCA Message Endpoints"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-jca-message-endpoint-manager"></a>23.5&nbsp;Support for JCA Message Endpoints</h2></div></div></div>

<p>Beginning with version 2.5, Spring also provides support for a JCA-based
<code class="literal">MessageListener</code> container. The <code class="literal">JmsMessageEndpointManager</code> will attempt to
automatically determine the <code class="literal">ActivationSpec</code> class name from the provider&#8217;s
<code class="literal">ResourceAdapter</code> class name. Therefore, it is typically possible to just provide
Spring&#8217;s generic <code class="literal">JmsActivationSpecConfig</code> as shown in the following example.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.endpoint.JmsMessageEndpointManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceAdapter"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"resourceAdapter"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"activationSpecConfig"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.endpoint.JmsActivationSpecConfig"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destinationName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myQueue"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageListener"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myMessageListener"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Alternatively, you may set up a <code class="literal">JmsMessageEndpointManager</code> with a given
<code class="literal">ActivationSpec</code> object. The <code class="literal">ActivationSpec</code> object may also come from a JNDI lookup
(using <code class="literal">&lt;jee:jndi-lookup&gt;</code>).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.listener.endpoint.JmsMessageEndpointManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceAdapter"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"resourceAdapter"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"activationSpec"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.activemq.ra.ActiveMQActivationSpec"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destination"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myQueue"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destinationType"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"javax.jms.Queue"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageListener"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myMessageListener"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Using Spring&#8217;s <code class="literal">ResourceAdapterFactoryBean</code>, the target <code class="literal">ResourceAdapter</code> may be
configured locally as depicted in the following example.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resourceAdapter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.support.ResourceAdapterFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceAdapter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.activemq.ra.ActiveMQResourceAdapter"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serverUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"tcp://localhost:61616"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"workManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.work.SimpleTaskWorkManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The specified <code class="literal">WorkManager</code> may also point to an environment-specific thread pool -
typically through <code class="literal">SimpleTaskWorkManager's</code> "asyncTaskExecutor" property. Consider
defining a shared thread pool for all your <code class="literal">ResourceAdapter</code> instances if you happen to
use multiple adapters.</p>
<p>In some environments (e.g. WebLogic 9 or above), the entire <code class="literal">ResourceAdapter</code> object may
be obtained from JNDI instead (using <code class="literal">&lt;jee:jndi-lookup&gt;</code>). The Spring-based message
listeners can then interact with the server-hosted <code class="literal">ResourceAdapter</code>, also using the
server&#8217;s built-in <code class="literal">WorkManager</code>.</p>
<p>Please consult the JavaDoc for <code class="literal">JmsMessageEndpointManager</code>, <code class="literal">JmsActivationSpecConfig</code>,
and <code class="literal">ResourceAdapterFactoryBean</code> for more details.</p>
<p>Spring also provides a generic JCA message endpoint manager which is not tied to JMS:
<code class="literal">org.springframework.jca.endpoint.GenericMessageEndpointManager</code>. This component allows
for using any message listener type (e.g. a CCI MessageListener) and any
provider-specific ActivationSpec object. Check out your JCA provider&#8217;s documentation to
find out about the actual capabilities of your connector, and consult
<code class="literal">GenericMessageEndpointManager</code>'s JavaDoc for the Spring-specific configuration details.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>JCA-based message endpoint management is very analogous to EJB 2.1 Message-Driven Beans;
it uses the same underlying resource provider contract. Like with EJB 2.1 MDBs, any
message listener interface supported by your JCA provider can be used in the Spring
context as well. Spring nevertheless provides explicit <span class="emphasis"><em>convenience</em></span> support for JMS,
simply because JMS is the most common endpoint API used with the JCA endpoint management
contract.</p>
</td></tr></table></div>

</div>
<div class="section" title="23.6&nbsp;JMS Namespace Support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-namespace"></a>23.6&nbsp;JMS Namespace Support</h2></div></div></div>

<p>Spring 2.5 introduces an XML namespace for simplifying JMS configuration. To use the JMS
namespace elements you will need to reference the JMS schema:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
        <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="strong"><strong>xmlns:jms="http://www.springframework.org/schema/jms"</strong></span>
        xsi:schemaLocation="
            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
            <span class="strong"><strong>http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms.xsd</strong></span>"&gt;

    <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The namespace consists of two top-level elements: <code class="literal">&lt;listener-container/&gt;</code> and
<code class="literal">&lt;jca-listener-container/&gt;</code> both of which may contain one or more <code class="literal">&lt;listener/&gt;</code> child
elements. Here is an example of a basic configuration for two listeners.</p>
<pre class="programlisting"><span class="hl-tag">&lt;jms:listener-container&gt;</span>

    <span class="hl-tag">&lt;jms:listener</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"queue.orders"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"orderService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"placeOrder"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;jms:listener</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"queue.confirmations"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"confirmationLogger"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"log"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/jms:listener-container&gt;</span></pre>

<p>The example above is equivalent to creating two distinct listener container bean
definitions and two distinct <code class="literal">MessageListenerAdapter</code> bean definitions as demonstrated
in <a class="xref" href="#jms-receiving-async-message-listener-adapter" title="23.4.4&nbsp;the MessageListenerAdapter">Section&nbsp;23.4.4, &#8220;the MessageListenerAdapter&#8221;</a>. In addition to the attributes shown
above, the <code class="literal">listener</code> element may contain several optional ones. The following table
describes all available attributes:</p>
<div class="table"><a name="jms-namespace-listener-tbl"></a><p class="title"><b>Table&nbsp;23.1.&nbsp;Attributes of the JMS &lt;listener&gt; element</b></p><div class="table-contents">

  <table summary="Attributes of the JMS <listener&gt; element" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A bean name for the hosting listener container. If not specified, a bean name will be
  automatically generated.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>destination <span class="emphasis"><em>(required)</em></span></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The destination name for this listener, resolved through the <code class="literal">DestinationResolver</code>
  strategy.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref <span class="emphasis"><em>(required)</em></span></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The bean name of the handler object.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the handler method to invoke. If the <code class="literal">ref</code> points to a <code class="literal">MessageListener</code>
  or Spring <code class="literal">SessionAwareMessageListener</code>, this attribute may be omitted.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>response-destination</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the default response destination to send response messages to. This will
  be applied in case of a request message that does not carry a "JMSReplyTo" field. The
  type of this destination will be determined by the listener-container&#8217;s
  "destination-type" attribute. Note: This only applies to a listener method with a
  return value, for which each result object will be converted into a response message.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>subscription</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the durable subscription, if any.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>selector</p></td><td style="" align="left" valign="top"><p>An optional message selector for this listener.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>The <code class="literal">&lt;listener-container/&gt;</code> element also accepts several optional attributes. This
allows for customization of the various strategies (for example, <code class="literal">taskExecutor</code> and
<code class="literal">destinationResolver</code>) as well as basic JMS settings and resource references. Using
these attributes, it is possible to define highly-customized listener containers while
still benefiting from the convenience of the namespace.</p>
<pre class="programlisting"><span class="hl-tag">&lt;jms:listener-container</span> <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"myConnectionFactory"</span>
        <span class="hl-attribute">task-executor</span>=<span class="hl-value">"myTaskExecutor"</span>
        <span class="hl-attribute">destination-resolver</span>=<span class="hl-value">"myDestinationResolver"</span>
        <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"myTransactionManager"</span>
        <span class="hl-attribute">concurrency</span>=<span class="hl-value">"10"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;jms:listener</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"queue.orders"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"orderService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"placeOrder"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;jms:listener</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"queue.confirmations"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"confirmationLogger"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"log"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/jms:listener-container&gt;</span></pre>

<p>The following table describes all available attributes. Consult the class-level Javadoc
of the <code class="literal">AbstractMessageListenerContainer</code> and its concrete subclasses for more details
on the individual properties. The Javadoc also provides a discussion of transaction
choices and message redelivery scenarios.</p>
<div class="table"><a name="jms-namespace-listener-container-tbl"></a><p class="title"><b>Table&nbsp;23.2.&nbsp;Attributes of the JMS &lt;listener-container&gt; element</b></p><div class="table-contents">

  <table summary="Attributes of the JMS <listener-container&gt; element" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>container-type</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The type of this listener container. Available options are: <code class="literal">default</code>, <code class="literal">simple</code>,
  <code class="literal">default102</code>, or <code class="literal">simple102</code> (the default value is <code class="literal">'default'</code>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>container-class</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A custom listener container implementation class as fully qualified class name.
  Default is Spring&#8217;s standard <code class="literal">DefaultMessageListenerContainer</code> or
  <code class="literal">SimpleMessageListenerContainer</code>, according to the "container-type" attribute.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>connection-factory</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to the JMS <code class="literal">ConnectionFactory</code> bean (the default bean name is
  <code class="literal">'connectionFactory'</code>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>task-executor</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to the Spring <code class="literal">TaskExecutor</code> for the JMS listener invokers.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>destination-resolver</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to the <code class="literal">DestinationResolver</code> strategy for resolving JMS <code class="literal">Destinations</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>message-converter</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to the <code class="literal">MessageConverter</code> strategy for converting JMS Messages to listener
  method arguments. Default is a <code class="literal">SimpleMessageConverter</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>error-handler</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to an <code class="literal">ErrorHandler</code> strategy for handling any uncaught Exceptions that
  may occur during the execution of the <code class="literal">MessageListener</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>destination-type</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The JMS destination type for this listener: <code class="literal">queue</code>, <code class="literal">topic</code> or <code class="literal">durableTopic</code>. The
  default is <code class="literal">queue</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>client-id</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The JMS client id for this listener container. Needs to be specified when using
  durable subscriptions.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cache</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The cache level for JMS resources: <code class="literal">none</code>, <code class="literal">connection</code>, <code class="literal">session</code>, <code class="literal">consumer</code> or
  <code class="literal">auto</code>. By default ( <code class="literal">auto</code>), the cache level will effectively be "consumer", unless
  an external transaction manager has been specified - in which case the effective
  default will be <code class="literal">none</code> (assuming Java EE-style transaction management where the given
  ConnectionFactory is an XA-aware pool).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>acknowledge</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The native JMS acknowledge mode: <code class="literal">auto</code>, <code class="literal">client</code>, <code class="literal">dups-ok</code> or <code class="literal">transacted</code>. A value
  of <code class="literal">transacted</code> activates a locally transacted <code class="literal">Session</code>. As an alternative, specify
  the <code class="literal">transaction-manager</code> attribute described below. Default is <code class="literal">auto</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>transaction-manager</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to an external <code class="literal">PlatformTransactionManager</code> (typically an XA-based
  transaction coordinator, e.g. Spring&#8217;s <code class="literal">JtaTransactionManager</code>). If not specified,
  native acknowledging will be used (see "acknowledge" attribute).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>concurrency</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The number of concurrent sessions/consumers to start for each listener. Can either be
  a simple number indicating the maximum number (e.g. "5") or a range indicating the
  lower as well as the upper limit (e.g. "3-5"). Note that a specified minimum is just a
  hint and might be ignored at runtime. Default is 1; keep concurrency limited to 1 in
  case of a topic listener or if queue ordering is important; consider raising it for
  general queues.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>prefetch</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The maximum number of messages to load into a single session. Note that raising this
  number might lead to starvation of concurrent consumers!</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>receive-timeout</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The timeout to use for receive calls (in milliseconds). The default is <code class="literal">1000</code> ms (1
  sec); <code class="literal">-1</code> indicates no timeout at all.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>recovery-interval</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specify the interval between recovery attempts, in milliseconds. The default is <code class="literal">5000</code>
  ms, that is, 5 seconds.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>phase</p></td><td style="" align="left" valign="top"><p>The lifecycle phase within which this container should start and stop. The lower the
  value the earlier this container will start and the later it will stop. The default is
  <code class="literal">Integer.MAX_VALUE</code> meaning the container will start as late as possible and stop as
  soon as possible.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>Configuring a JCA-based listener container with the "jms" schema support is very similar.</p>
<pre class="programlisting"><span class="hl-tag">&lt;jms:jca-listener-container</span> <span class="hl-attribute">resource-adapter</span>=<span class="hl-value">"myResourceAdapter"</span>
        <span class="hl-attribute">destination-resolver</span>=<span class="hl-value">"myDestinationResolver"</span>
        <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"myTransactionManager"</span>
        <span class="hl-attribute">concurrency</span>=<span class="hl-value">"10"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;jms:listener</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"queue.orders"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myMessageListener"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/jms:jca-listener-container&gt;</span></pre>

<p>The available configuration options for the JCA variant are described in the following
table:</p>
<div class="table"><a name="jms-namespace-jca-listener-container-tbl"></a><p class="title"><b>Table&nbsp;23.3.&nbsp;Attributes of the JMS &lt;jca-listener-container/&gt; element</b></p><div class="table-contents">

  <table summary="Attributes of the JMS <jca-listener-container/&gt; element" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resource-adapter</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to the JCA <code class="literal">ResourceAdapter</code> bean (the default bean name is
  <code class="literal">'resourceAdapter'</code>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>activation-spec-factory</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to the <code class="literal">JmsActivationSpecFactory</code>. The default is to autodetect the JMS
  provider and its <code class="literal">ActivationSpec</code> class (see <code class="literal">DefaultJmsActivationSpecFactory</code>)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>destination-resolver</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to the <code class="literal">DestinationResolver</code> strategy for resolving JMS <code class="literal">Destinations</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>message-converter</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to the <code class="literal">MessageConverter</code> strategy for converting JMS Messages to listener
  method arguments. Default is a <code class="literal">SimpleMessageConverter</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>destination-type</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The JMS destination type for this listener: <code class="literal">queue</code>, <code class="literal">topic</code> or <code class="literal">durableTopic</code>. The
  default is <code class="literal">queue</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>client-id</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The JMS client id for this listener container. Needs to be specified when using
  durable subscriptions.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>acknowledge</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The native JMS acknowledge mode: <code class="literal">auto</code>, <code class="literal">client</code>, <code class="literal">dups-ok</code> or <code class="literal">transacted</code>. A value
  of <code class="literal">transacted</code> activates a locally transacted <code class="literal">Session</code>. As an alternative, specify
  the <code class="literal">transaction-manager</code> attribute described below. Default is <code class="literal">auto</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>transaction-manager</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A reference to a Spring <code class="literal">JtaTransactionManager</code> or a
  <code class="literal">javax.transaction.TransactionManager</code> for kicking off an XA transaction for each
  incoming message. If not specified, native acknowledging will be used (see the
  "acknowledge" attribute).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>concurrency</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The number of concurrent sessions/consumers to start for each listener. Can either be
  a simple number indicating the maximum number (e.g. "5") or a range indicating the
  lower as well as the upper limit (e.g. "3-5"). Note that a specified minimum is just a
  hint and will typically be ignored at runtime when using a JCA listener container.
  Default is 1.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>prefetch</p></td><td style="" align="left" valign="top"><p>The maximum number of messages to load into a single session. Note that raising this
  number might lead to starvation of concurrent consumers!</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
</div>
<div class="chapter" title="24.&nbsp;JMX"><div class="titlepage"><div><div><h2 class="title"><a name="jmx"></a>24.&nbsp;JMX</h2></div></div></div>

<div class="section" title="24.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-introduction"></a>24.1&nbsp;Introduction</h2></div></div></div>

<p>The JMX support in Spring provides you with the features to easily and transparently
integrate your Spring application into a JMX infrastructure.</p>
<div class="sidebar" title="JMX?"><p class="title"><b>JMX?</b></p>

<p>This chapter is not an introduction to JMX&#8230; it doesn&#8217;t try to explain the motivations
of why one might want to use JMX (or indeed what the letters JMX actually stand for). If
you are new to JMX, check out <a class="xref" href="#jmx-resources" title="24.8&nbsp;Further Resources">Section&nbsp;24.8, &#8220;Further Resources&#8221;</a> at the end of this chapter.</p>
</div>

<p>Specifically, Spring&#8217;s JMX support provides four core features:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The automatic registration of <span class="emphasis"><em>any</em></span> Spring bean as a JMX MBean
</li><li class="listitem">
A flexible mechanism for controlling the management interface of your beans
</li><li class="listitem">
The declarative exposure of MBeans over remote, JSR-160 connectors
</li><li class="listitem">
The simple proxying of both local and remote MBean resources
</li></ul></div>

<p>These features are designed to work without coupling your application components to
either Spring or JMX interfaces and classes. Indeed, for the most part your application
classes need not be aware of either Spring or JMX in order to take advantage of the
Spring JMX features.</p>
</div>
<div class="section" title="24.2&nbsp;Exporting your beans to JMX"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-exporting"></a>24.2&nbsp;Exporting your beans to JMX</h2></div></div></div>

<p>The core class in Spring&#8217;s JMX framework is the <code class="literal">MBeanExporter</code>. This class is
responsible for taking your Spring beans and registering them with a JMX <code class="literal">MBeanServer</code>.
For example, consider the following class:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.jmx;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JmxTestBean <span class="hl-keyword">implements</span> IJmxTestBean {

    <span class="hl-keyword">private</span> String name;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> age;
    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> isSuperman;

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getAge() {
        <span class="hl-keyword">return</span> age;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setAge(<span class="hl-keyword">int</span> age) {
        <span class="hl-keyword">this</span>.age = age;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> add(<span class="hl-keyword">int</span> x, <span class="hl-keyword">int</span> y) {
        <span class="hl-keyword">return</span> x + y;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> dontExposeMe() {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException();
    }
}</pre>

<p>To expose the properties and methods of this bean as attributes and operations of an
MBean you simply configure an instance of the <code class="literal">MBeanExporter</code> class in your
configuration file and pass in the bean as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-comment">&lt;!-- this bean must not be lazily initialized if the exporting is to happen --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span> <span class="hl-attribute">lazy-init</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean1"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The pertinent bean definition from the above configuration snippet is the <code class="literal">exporter</code>
bean. The <code class="literal">beans</code> property tells the <code class="literal">MBeanExporter</code> exactly which of your beans must be
exported to the JMX <code class="literal">MBeanServer</code>. In the default configuration, the key of each entry
in the <code class="literal">beans</code> <code class="literal">Map</code> is used as the <code class="literal">ObjectName</code> for the bean referenced by the
corresponding entry value. This behavior can be changed as described in <a class="xref" href="#jmx-naming" title="24.4&nbsp;Controlling the ObjectNames for your beans">Section&nbsp;24.4, &#8220;Controlling the ObjectNames for your beans&#8221;</a>.</p>
<p>With this configuration the <code class="literal">testBean</code> bean is exposed as an MBean under the
<code class="literal">ObjectName</code> <code class="literal">bean:name=testBean1</code>. By default, all <span class="emphasis"><em>public</em></span> properties of the bean
are exposed as attributes and all <span class="emphasis"><em>public</em></span> methods (bar those inherited from the
<code class="literal">Object</code> class) are exposed as operations.</p>
<div class="section" title="24.2.1&nbsp;Creating an MBeanServer"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-exporting-mbeanserver"></a>24.2.1&nbsp;Creating an MBeanServer</h3></div></div></div>

<p>The above configuration assumes that the application is running in an environment that
has one (and only one) <code class="literal">MBeanServer</code> already running. In this case, Spring will attempt
to locate the running <code class="literal">MBeanServer</code> and register your beans with that server (if any).
This behavior is useful when your application is running inside a container such as
Tomcat or IBM WebSphere that has its own <code class="literal">MBeanServer</code>.</p>
<p>However, this approach is of no use in a standalone environment, or when running inside
a container that does not provide an <code class="literal">MBeanServer</code>. To address this you can create an
<code class="literal">MBeanServer</code> instance declaratively by adding an instance of the
<code class="literal">org.springframework.jmx.support.MBeanServerFactoryBean</code> class to your configuration.
You can also ensure that a specific <code class="literal">MBeanServer</code> is used by setting the value of the
<code class="literal">MBeanExporter</code>'s <code class="literal">server</code> property to the <code class="literal">MBeanServer</code> value returned by an
<code class="literal">MBeanServerFactoryBean</code>; for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mbeanServer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.MBeanServerFactoryBean"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!--
    this bean needs to be eagerly pre-instantiated in order for the exporting to occur;
    this means that it must not be marked as lazily initialized
    --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean1"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"server"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mbeanServer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Here an instance of <code class="literal">MBeanServer</code> is created by the <code class="literal">MBeanServerFactoryBean</code> and is
supplied to the <code class="literal">MBeanExporter</code> via the server property. When you supply your own
<code class="literal">MBeanServer</code> instance, the <code class="literal">MBeanExporter</code> will not attempt to locate a running
<code class="literal">MBeanServer</code> and will use the supplied <code class="literal">MBeanServer</code> instance. For this to work
correctly, you must (of course) have a JMX implementation on your classpath.</p>
</div>
<div class="section" title="24.2.2&nbsp;Reusing an existing MBeanServer"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-mbean-server"></a>24.2.2&nbsp;Reusing an existing MBeanServer</h3></div></div></div>

<p>If no server is specified, the <code class="literal">MBeanExporter</code> tries to automatically detect a running
<code class="literal">MBeanServer</code>. This works in most environment where only one <code class="literal">MBeanServer</code> instance is
used, however when multiple instances exist, the exporter might pick the wrong server.
In such cases, one should use the <code class="literal">MBeanServer</code> <code class="literal">agentId</code> to indicate which instance to
be used:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mbeanServer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.MBeanServerFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- indicate to first look for a server --&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"locateExistingServerIfPossible"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-comment">&lt;!-- search for the MBeanServer instance with the given agentId --&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"agentId"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"MBeanServer_instance_agentId&gt;"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"server"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mbeanServer"</span><span class="hl-tag">/&gt;</span>
        ...
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>For platforms/cases where the existing <code class="literal">MBeanServer</code> has a dynamic (or unknown)
<code class="literal">agentId</code> which is retrieved through lookup methods, one should use
<a class="link" href="#beans-factory-class-static-factory-method" title="Instantiation with a static factory method">factory-method</a>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"server"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- Custom MBeanServerLocator --&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"platform.package.MBeanServerLocator"</span> <span class="hl-attribute">factory-method</span>=<span class="hl-value">"locateMBeanServer"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- other beans here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="24.2.3&nbsp;Lazy-initialized MBeans"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-exporting-lazy"></a>24.2.3&nbsp;Lazy-initialized MBeans</h3></div></div></div>

<p>If you configure a bean with the <code class="literal">MBeanExporter</code> that is also configured for lazy
initialization, then the <code class="literal">MBeanExporter</code> will <span class="emphasis"><em>not</em></span> break this contract and will avoid
instantiating the bean. Instead, it will register a proxy with the <code class="literal">MBeanServer</code> and
will defer obtaining the bean from the container until the first invocation on the proxy
occurs.</p>
</div>
<div class="section" title="24.2.4&nbsp;Automatic registration of MBeans"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-exporting-auto"></a>24.2.4&nbsp;Automatic registration of MBeans</h3></div></div></div>

<p>Any beans that are exported through the <code class="literal">MBeanExporter</code> and are already valid MBeans are
registered as-is with the <code class="literal">MBeanServer</code> without further intervention from Spring. MBeans
can be automatically detected by the <code class="literal">MBeanExporter</code> by setting the <code class="literal">autodetect</code>
property to <code class="literal">true</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"autodetect"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"spring:mbean=true"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.TestDynamicMBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>Here, the bean called <code class="literal">spring:mbean=true</code> is already a valid JMX MBean and will be
automatically registered by Spring. By default, beans that are autodetected for JMX
registration have their bean name used as the <code class="literal">ObjectName</code>. This behavior can be
overridden as detailed in <a class="xref" href="#jmx-naming" title="24.4&nbsp;Controlling the ObjectNames for your beans">Section&nbsp;24.4, &#8220;Controlling the ObjectNames for your beans&#8221;</a>.</p>
</div>
<div class="section" title="24.2.5&nbsp;Controlling the registration behavior"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-exporting-registration-behavior"></a>24.2.5&nbsp;Controlling the registration behavior</h3></div></div></div>

<p>Consider the scenario where a Spring <code class="literal">MBeanExporter</code> attempts to register an <code class="literal">MBean</code>
with an <code class="literal">MBeanServer</code> using the <code class="literal">ObjectName</code> <code class="literal">'bean:name=testBean1'</code>. If an <code class="literal">MBean</code>
instance has already been registered under that same <code class="literal">ObjectName</code>, the default behavior
is to fail (and throw an <code class="literal">InstanceAlreadyExistsException</code>).</p>
<p>It is possible to control the behavior of exactly what happens when an <code class="literal">MBean</code> is
registered with an <code class="literal">MBeanServer</code>. Spring&#8217;s JMX support allows for three different
registration behaviors to control the registration behavior when the registration
process finds that an <code class="literal">MBean</code> has already been registered under the same <code class="literal">ObjectName</code>;
these registration behaviors are summarized on the following table:</p>
<div class="table"><a name="jmx-registration-behaviors"></a><p class="title"><b>Table&nbsp;24.1.&nbsp;Registration Behaviors</b></p><div class="table-contents">

  <table summary="Registration Behaviors" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Registration behavior</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Explanation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REGISTRATION_FAIL_ON_EXISTING</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>This is the default registration behavior. If an <code class="literal">MBean</code> instance has already been
  registered under the same <code class="literal">ObjectName</code>, the <code class="literal">MBean</code> that is being registered will not
  be registered and an <code class="literal">InstanceAlreadyExistsException</code> will be thrown. The existing
  <code class="literal">MBean</code> is unaffected.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REGISTRATION_IGNORE_EXISTING</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If an <code class="literal">MBean</code> instance has already been registered under the same <code class="literal">ObjectName</code>, the
  <code class="literal">MBean</code> that is being registered will <span class="emphasis"><em>not</em></span> be registered. The existing <code class="literal">MBean</code> is
  unaffected, and no <code class="literal">Exception</code> will be thrown. This is useful in settings where
  multiple applications want to share a common <code class="literal">MBean</code> in a shared <code class="literal">MBeanServer</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REGISTRATION_REPLACE_EXISTING</code></p></td><td style="" align="left" valign="top"><p>If an <code class="literal">MBean</code> instance has already been registered under the same <code class="literal">ObjectName</code>, the
  existing <code class="literal">MBean</code> that was previously registered will be unregistered and the new
  <code class="literal">MBean</code> will be registered in its place (the new <code class="literal">MBean</code> effectively replaces the
  previous instance).</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>The above values are defined as constants on the <code class="literal">MBeanRegistrationSupport</code> class (the
<code class="literal">MBeanExporter</code> class derives from this superclass). If you want to change the default
registration behavior, you simply need to set the value of the
<code class="literal">registrationBehaviorName</code> property on your <code class="literal">MBeanExporter</code> definition to one of those
values.</p>
<p>The following example illustrates how to effect a change from the default registration
behavior to the <code class="literal">REGISTRATION_REPLACE_EXISTING</code> behavior:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean1"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"registrationBehaviorName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"REGISTRATION_REPLACE_EXISTING"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
</div>
<div class="section" title="24.3&nbsp;Controlling the management interface of your beans"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-interface"></a>24.3&nbsp;Controlling the management interface of your beans</h2></div></div></div>

<p>In the previous example, you had little control over the management interface of your
bean; <span class="emphasis"><em>all</em></span> of the <span class="emphasis"><em>public</em></span> properties and methods of each exported bean was exposed
as JMX attributes and operations respectively. To exercise finer-grained control over
exactly which properties and methods of your exported beans are actually exposed as JMX
attributes and operations, Spring JMX provides a comprehensive and extensible mechanism
for controlling the management interfaces of your beans.</p>
<div class="section" title="24.3.1&nbsp;the MBeanInfoAssembler Interface"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-interface-assembler"></a>24.3.1&nbsp;the MBeanInfoAssembler Interface</h3></div></div></div>

<p>Behind the scenes, the <code class="literal">MBeanExporter</code> delegates to an implementation of the
<code class="literal">org.springframework.jmx.export.assembler.MBeanInfoAssembler</code> interface which is
responsible for defining the management interface of each bean that is being exposed.
The default implementation,
<code class="literal">org.springframework.jmx.export.assembler.SimpleReflectiveMBeanInfoAssembler</code>, simply
defines a management interface that exposes all public properties and methods (as you
saw in the previous examples). Spring provides two additional implementations of the
<code class="literal">MBeanInfoAssembler</code> interface that allow you to control the generated management
interface using either source-level metadata or any arbitrary interface.</p>
</div>
<div class="section" title="24.3.2&nbsp;Using Source-Level Metadata (JDK 5.0 annotations)"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-interface-metadata"></a>24.3.2&nbsp;Using Source-Level Metadata (JDK 5.0 annotations)</h3></div></div></div>

<p>Using the <code class="literal">MetadataMBeanInfoAssembler</code> you can define the management interfaces for your
beans using source level metadata. The reading of metadata is encapsulated by the
<code class="literal">org.springframework.jmx.export.metadata.JmxAttributeSource</code> interface. Spring JMX
provides a default implementation which uses JDK 5.0 annotations, namely
<code class="literal">org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource</code>. The
<code class="literal">MetadataMBeanInfoAssembler</code> <span class="emphasis"><em>must</em></span> be configured with an implementation instance of
the <code class="literal">JmxAttributeSource</code> interface for it to function correctly (there is <span class="emphasis"><em>no</em></span>
default).</p>
<p>To mark a bean for export to JMX, you should annotate the bean class with the
<code class="literal">ManagedResource</code> annotation. Each method you wish to expose as an operation must be
marked with the <code class="literal">ManagedOperation</code> annotation and each property you wish to expose must
be marked with the <code class="literal">ManagedAttribute</code> annotation. When marking properties you can omit
either the annotation of the getter or the setter to create a write-only or read-only
attribute respectively.</p>
<p>The example below shows the annotated version of the <code class="literal">JmxTestBean</code> class that you saw
earlier:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.jmx;

<span class="hl-keyword">import</span> org.springframework.jmx.export.annotation.ManagedResource;
<span class="hl-keyword">import</span> org.springframework.jmx.export.annotation.ManagedOperation;
<span class="hl-keyword">import</span> org.springframework.jmx.export.annotation.ManagedAttribute;

<i><span class="hl-annotation" style="color: gray">@ManagedResource(
        objectName="bean:name=testBean4",
        description="My Managed Bean",
        log=true,
        logFile="jmx.log",
        currencyTimeLimit=15,
        persistPolicy="OnUpdate",
        persistPeriod=200,
        persistLocation="foo",
        persistName="bar")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnnotationTestBean <span class="hl-keyword">implements</span> IJmxTestBean {

    <span class="hl-keyword">private</span> String name;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> age;

    <i><span class="hl-annotation" style="color: gray">@ManagedAttribute(description="The Age Attribute", currencyTimeLimit=15)</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getAge() {
        <span class="hl-keyword">return</span> age;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setAge(<span class="hl-keyword">int</span> age) {
        <span class="hl-keyword">this</span>.age = age;
    }

    <i><span class="hl-annotation" style="color: gray">@ManagedAttribute(description="The Name Attribute",
            currencyTimeLimit=20,
            defaultValue="bar",
            persistPolicy="OnUpdate")</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

    <i><span class="hl-annotation" style="color: gray">@ManagedAttribute(defaultValue="foo", persistPeriod=300)</span></i>
    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> name;
    }

    <i><span class="hl-annotation" style="color: gray">@ManagedOperation(description="Add two numbers")</span></i>
    <i><span class="hl-annotation" style="color: gray">@ManagedOperationParameters({
        @ManagedOperationParameter(name = "x", description = "The first number"),
        @ManagedOperationParameter(name = "y", description = "The second number")})</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> add(<span class="hl-keyword">int</span> x, <span class="hl-keyword">int</span> y) {
        <span class="hl-keyword">return</span> x + y;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> dontExposeMe() {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException();
    }

}</pre>

<p>Here you can see that the <code class="literal">JmxTestBean</code> class is marked with the <code class="literal">ManagedResource</code>
annotation and that this <code class="literal">ManagedResource</code> annotation is configured with a set of
properties. These properties can be used to configure various aspects of the MBean that
is generated by the <code class="literal">MBeanExporter</code>, and are explained in greater detail later in
section entitled <a class="xref" href="#jmx-interface-metadata-types" title="24.3.3&nbsp;Source-Level Metadata Types">Section&nbsp;24.3.3, &#8220;Source-Level Metadata Types&#8221;</a>.</p>
<p>You will also notice that both the <code class="literal">age</code> and <code class="literal">name</code> properties are annotated with the
<code class="literal">ManagedAttribute</code> annotation, but in the case of the <code class="literal">age</code> property, only the getter is
marked. This will cause both of these properties to be included in the management
interface as attributes, but the <code class="literal">age</code> attribute will be read-only.</p>
<p>Finally, you will notice that the <code class="literal">add(int, int)</code> method is marked with the
<code class="literal">ManagedOperation</code> attribute whereas the <code class="literal">dontExposeMe()</code> method is not. This will cause
the management interface to contain only one operation, <code class="literal">add(int, int)</code>, when using the
<code class="literal">MetadataMBeanInfoAssembler</code>.</p>
<p>The configuration below shows how you configure the <code class="literal">MBeanExporter</code> to use the
<code class="literal">MetadataMBeanInfoAssembler</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"assembler"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"assembler"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"namingStrategy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"namingStrategy"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"autodetect"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmxAttributeSource"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-comment">&lt;!-- will create management interface using annotation metadata --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"assembler"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.assembler.MetadataMBeanInfoAssembler"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"attributeSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"jmxAttributeSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- will pick up the ObjectName from the annotation --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"namingStrategy"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.naming.MetadataNamingStrategy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"attributeSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"jmxAttributeSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.AnnotationTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Here you can see that an <code class="literal">MetadataMBeanInfoAssembler</code> bean has been configured with an
instance of the <code class="literal">AnnotationJmxAttributeSource</code> class and passed to the <code class="literal">MBeanExporter</code>
through the assembler property. This is all that is required to take advantage of
metadata-driven management interfaces for your Spring-exposed MBeans.</p>
</div>
<div class="section" title="24.3.3&nbsp;Source-Level Metadata Types"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-interface-metadata-types"></a>24.3.3&nbsp;Source-Level Metadata Types</h3></div></div></div>

<p>The following source level metadata types are available for use in Spring JMX:</p>
<div class="table"><a name="jmx-metadata-types"></a><p class="title"><b>Table&nbsp;24.2.&nbsp;Source-Level Metadata Types</b></p><div class="table-contents">

  <table summary="Source-Level Metadata Types" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Purpose</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Annotation</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Annotation Type</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Mark all instances of a <code class="literal">Class</code> as JMX managed resources</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">@ManagedResource</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Class</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Mark a method as a JMX operation</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">@ManagedOperation</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Method</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Mark a getter or setter as one half of a JMX attribute</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">@ManagedAttribute</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Method (only getters and setters)</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Define descriptions for operation parameters</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">@ManagedOperationParameter</code> and <code class="literal">@ManagedOperationParameters</code></p></td><td style="" align="left" valign="top"><p>Method</p></td></tr></tbody></table>
</div></div><br class="table-break">

<p>The following configuration parameters are available for use on these source-level
metadata types:</p>
<div class="table"><a name="jmx-metadata-parameters"></a><p class="title"><b>Table&nbsp;24.3.&nbsp;Source-Level Metadata Parameters</b></p><div class="table-contents">

  <table summary="Source-Level Metadata Parameters" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Parameter</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Applies to</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ObjectName</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Used by <code class="literal">MetadataNamingStrategy</code> to determine the <code class="literal">ObjectName</code> of a managed resource</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">description</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the friendly description of the resource, attribute or operation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code>, <code class="literal">ManagedAttribute</code>, <code class="literal">ManagedOperation</code>, <code class="literal">ManagedOperationParameter</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">currencyTimeLimit</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the value of the <code class="literal">currencyTimeLimit</code> descriptor field</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code>, <code class="literal">ManagedAttribute</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">defaultValue</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the value of the <code class="literal">defaultValue</code> descriptor field</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedAttribute</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">log</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the value of the <code class="literal">log</code> descriptor field</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">logFile</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the value of the <code class="literal">logFile</code> descriptor field</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">persistPolicy</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the value of the <code class="literal">persistPolicy</code> descriptor field</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">persistPeriod</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the value of the <code class="literal">persistPeriod</code> descriptor field</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">persistLocation</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the value of the <code class="literal">persistLocation</code> descriptor field</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">persistName</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the value of the <code class="literal">persistName</code> descriptor field</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedResource</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">name</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the display name of an operation parameter</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ManagedOperationParameter</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">index</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Sets the index of an operation parameter</p></td><td style="" align="left" valign="top"><p><code class="literal">ManagedOperationParameter</code></p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="24.3.4&nbsp;the AutodetectCapableMBeanInfoAssembler interface"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-interface-autodetect"></a>24.3.4&nbsp;the AutodetectCapableMBeanInfoAssembler interface</h3></div></div></div>

<p>To simplify configuration even further, Spring introduces the
<code class="literal">AutodetectCapableMBeanInfoAssembler</code> interface which extends the <code class="literal">MBeanInfoAssembler</code>
interface to add support for autodetection of MBean resources. If you configure the
<code class="literal">MBeanExporter</code> with an instance of <code class="literal">AutodetectCapableMBeanInfoAssembler</code> then it is
allowed to "vote" on the inclusion of beans for exposure to JMX.</p>
<p>Out of the box, the only implementation of the <code class="literal">AutodetectCapableMBeanInfo</code> interface is
the <code class="literal">MetadataMBeanInfoAssembler</code> which will vote to include any bean which is marked
with the <code class="literal">ManagedResource</code> attribute. The default approach in this case is to use the
bean name as the <code class="literal">ObjectName</code> which results in a configuration like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- notice how no </span><span class="emphasis"><em>beans</em></span> are explicitly configured here --&gt;
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"autodetect"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"assembler"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"assembler"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"assembler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.assembler.MetadataMBeanInfoAssembler"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"attributeSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Notice that in this configuration no beans are passed to the <code class="literal">MBeanExporter</code>; however,
the <code class="literal">JmxTestBean</code> will still be registered since it is marked with the <code class="literal">ManagedResource</code>
attribute and the <code class="literal">MetadataMBeanInfoAssembler</code> detects this and votes to include it. The
only problem with this approach is that the name of the <code class="literal">JmxTestBean</code> now has business
meaning. You can address this issue by changing the default behavior for <code class="literal">ObjectName</code>
creation as defined in <a class="xref" href="#jmx-naming" title="24.4&nbsp;Controlling the ObjectNames for your beans">Section&nbsp;24.4, &#8220;Controlling the ObjectNames for your beans&#8221;</a>.</p>
</div>
<div class="section" title="24.3.5&nbsp;Defining management interfaces using Java interfaces"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-interface-java"></a>24.3.5&nbsp;Defining management interfaces using Java interfaces</h3></div></div></div>

<p>In addition to the <code class="literal">MetadataMBeanInfoAssembler</code>, Spring also includes the
<code class="literal">InterfaceBasedMBeanInfoAssembler</code> which allows you to constrain the methods and
properties that are exposed based on the set of methods defined in a collection of
interfaces.</p>
<p>Although the standard mechanism for exposing MBeans is to use interfaces and a simple
naming scheme, the <code class="literal">InterfaceBasedMBeanInfoAssembler</code> extends this functionality by
removing the need for naming conventions, allowing you to use more than one interface
and removing the need for your beans to implement the MBean interfaces.</p>
<p>Consider this interface that is used to define a management interface for the
<code class="literal">JmxTestBean</code> class that you saw earlier:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IJmxTestBean {

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> add(<span class="hl-keyword">int</span> x, <span class="hl-keyword">int</span> y);

    <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> myOperation();

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getAge();

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setAge(<span class="hl-keyword">int</span> age);

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name);

    <span class="hl-keyword">public</span> String getName();

}</pre>

<p>This interface defines the methods and properties that will be exposed as operations and
attributes on the JMX MBean. The code below shows how to configure Spring JMX to use
this interface as the definition for the management interface:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean5"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"assembler"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.assembler.InterfaceBasedMBeanInfoAssembler"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"managedInterfaces"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;value&gt;</span>org.springframework.jmx.IJmxTestBean<span class="hl-tag">&lt;/value&gt;</span>
                <span class="hl-tag">&lt;/property&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
      <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Here you can see that the <code class="literal">InterfaceBasedMBeanInfoAssembler</code> is configured to use the
<code class="literal">IJmxTestBean</code> interface when constructing the management interface for any bean. It is
important to understand that beans processed by the <code class="literal">InterfaceBasedMBeanInfoAssembler</code>
are <span class="emphasis"><em>not</em></span> required to implement the interface used to generate the JMX management
interface.</p>
<p>In the case above, the <code class="literal">IJmxTestBean</code> interface is used to construct all management
interfaces for all beans. In many cases this is not the desired behavior and you may
want to use different interfaces for different beans. In this case, you can pass
<code class="literal">InterfaceBasedMBeanInfoAssembler</code> a <code class="literal">Properties</code> instance via the <code class="literal">interfaceMappings</code>
property, where the key of each entry is the bean name and the value of each entry is a
comma-separated list of interface names to use for that bean.</p>
<p>If no management interface is specified through either the <code class="literal">managedInterfaces</code> or
<code class="literal">interfaceMappings</code> properties, then the <code class="literal">InterfaceBasedMBeanInfoAssembler</code> will reflect
on the bean and use all of the interfaces implemented by that bean to create the
management interface.</p>
</div>
<div class="section" title="24.3.6&nbsp;Using MethodNameBasedMBeanInfoAssembler"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-interface-methodnames"></a>24.3.6&nbsp;Using MethodNameBasedMBeanInfoAssembler</h3></div></div></div>

<p>The <code class="literal">MethodNameBasedMBeanInfoAssembler</code> allows you to specify a list of method names
that will be exposed to JMX as attributes and operations. The code below shows a sample
configuration for this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean5"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"assembler"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.assembler.MethodNameBasedMBeanInfoAssembler"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"managedMethods"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>add,myOperation,getName,setName,getAge<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Here you can see that the methods <code class="literal">add</code> and <code class="literal">myOperation</code> will be exposed as JMX
operations and <code class="literal">getName()</code>, <code class="literal">setName(String)</code> and <code class="literal">getAge()</code> will be exposed as the
appropriate half of a JMX attribute. In the code above, the method mappings apply to
beans that are exposed to JMX. To control method exposure on a bean-by-bean basis, use
the <code class="literal">methodMappings</code> property of <code class="literal">MethodNameMBeanInfoAssembler</code> to map bean names to
lists of method names.</p>
</div>
</div>
<div class="section" title="24.4&nbsp;Controlling the ObjectNames for your beans"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-naming"></a>24.4&nbsp;Controlling the ObjectNames for your beans</h2></div></div></div>

<p>Behind the scenes, the <code class="literal">MBeanExporter</code> delegates to an implementation of the
<code class="literal">ObjectNamingStrategy</code> to obtain <code class="literal">ObjectName</code> s for each of the beans it is registering.
The default implementation, <code class="literal">KeyNamingStrategy</code>, will, by default, use the key of the
<code class="literal">beans</code> <code class="literal">Map</code> as the <code class="literal">ObjectName</code>. In addition, the <code class="literal">KeyNamingStrategy</code> can map the key
of the <code class="literal">beans</code> <code class="literal">Map</code> to an entry in a <code class="literal">Properties</code> file (or files) to resolve the
<code class="literal">ObjectName</code>. In addition to the <code class="literal">KeyNamingStrategy</code>, Spring provides two additional
<code class="literal">ObjectNamingStrategy</code> implementations: the <code class="literal">IdentityNamingStrategy</code> that builds an
<code class="literal">ObjectName</code> based on the JVM identity of the bean and the <code class="literal">MetadataNamingStrategy</code> that
uses source level metadata to obtain the <code class="literal">ObjectName</code>.</p>
<div class="section" title="24.4.1&nbsp;Reading ObjectNames from Properties"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-naming-properties"></a>24.4.1&nbsp;Reading ObjectNames from Properties</h3></div></div></div>

<p>You can configure your own <code class="literal">KeyNamingStrategy</code> instance and configure it to read
<code class="literal">ObjectName</code> s from a <code class="literal">Properties</code> instance rather than use bean key. The
<code class="literal">KeyNamingStrategy</code> will attempt to locate an entry in the <code class="literal">Properties</code> with a key
corresponding to the bean key. If no entry is found or if the <code class="literal">Properties</code> instance is
<code class="literal">null</code> then the bean key itself is used.</p>
<p>The code below shows a sample configuration for the <code class="literal">KeyNamingStrategy</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"namingStrategy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"namingStrategy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"namingStrategy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.naming.KeyNamingStrategy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappings"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;props&gt;</span>
                <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">&gt;</span>bean:name=testBean1<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;/props&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingLocations"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>names1.properties,names2.properties<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Here an instance of <code class="literal">KeyNamingStrategy</code> is configured with a <code class="literal">Properties</code> instance that
is merged from the <code class="literal">Properties</code> instance defined by the mapping property and the
properties files located in the paths defined by the mappings property. In this
configuration, the <code class="literal">testBean</code> bean will be given the <code class="literal">ObjectName</code> <code class="literal">bean:name=testBean1</code>
since this is the entry in the <code class="literal">Properties</code> instance that has a key corresponding to the
bean key.</p>
<p>If no entry in the <code class="literal">Properties</code> instance can be found then the bean key name is used as
the <code class="literal">ObjectName</code>.</p>
</div>
<div class="section" title="24.4.2&nbsp;Using the MetadataNamingStrategy"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-naming-metadata"></a>24.4.2&nbsp;Using the MetadataNamingStrategy</h3></div></div></div>

<p>The <code class="literal">MetadataNamingStrategy</code> uses the <code class="literal">objectName</code> property of the <code class="literal">ManagedResource</code>
attribute on each bean to create the <code class="literal">ObjectName</code>. The code below shows the
configuration for the <code class="literal">MetadataNamingStrategy</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"namingStrategy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"namingStrategy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"namingStrategy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.naming.MetadataNamingStrategy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"attributeSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"attributeSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"attributeSource"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>If no <code class="literal">objectName</code> has been provided for the <code class="literal">ManagedResource</code> attribute, then an
<code class="literal">ObjectName</code> will be created with the following
format:<span class="emphasis"><em>[fully-qualified-package-name]:type=[short-classname],name=[bean-name]</em></span>. For
example, the generated <code class="literal">ObjectName</code> for the following bean would be:
<span class="emphasis"><em>com.foo:type=MyClass,name=myBean</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.MyClass"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="24.4.3&nbsp;Configuring annotation based MBean export"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-context-mbeanexport"></a>24.4.3&nbsp;Configuring annotation based MBean export</h3></div></div></div>

<p>If you prefer using <a class="link" href="#jmx-interface-metadata" title="24.3.2&nbsp;Using Source-Level Metadata (JDK 5.0 annotations)">the annotation based approach</a> to define
your management interfaces, then a convenience subclass of <code class="literal">MBeanExporter</code> is available:
<code class="literal">AnnotationMBeanExporter</code>. When defining an instance of this subclass, the
<code class="literal">namingStrategy</code>, <code class="literal">assembler</code>, and <code class="literal">attributeSource</code> configuration is no longer needed,
since it will always use standard Java annotation-based metadata (autodetection is
always enabled as well). In fact, rather than defining an <code class="literal">MBeanExporter</code> bean, an even
simpler syntax is supported by the <code class="literal">@EnableMBeanExport</code> <code class="literal">@Configuration</code> annotation.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableMBeanExport</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {

}</pre>

<p>If you prefer XML based configuration the ' <code class="literal">context:mbean-export'</code> element serves the
same purpose.</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:mbean-export/&gt;</span></pre>

<p>You can provide a reference to a particular MBean <code class="literal">server</code> if necessary, and the
<code class="literal">defaultDomain</code> attribute (a property of <code class="literal">AnnotationMBeanExporter</code>) accepts an alternate
value for the generated MBean <code class="literal">ObjectNames</code>' domains. This would be used in place of the
fully qualified package name as described in the previous section on
<a class="link" href="#jmx-naming-metadata" title="24.4.2&nbsp;Using the MetadataNamingStrategy"><code class="literal">MetadataNamingStrategy</code></a>.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@EnableMBeanExport(server="myMBeanServer", defaultDomain="myDomain")</span></i>
<i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
ContextConfiguration {

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;context:mbean-export</span> <span class="hl-attribute">server</span>=<span class="hl-value">"myMBeanServer"</span> <span class="hl-attribute">default-domain</span>=<span class="hl-value">"myDomain"</span><span class="hl-tag">/&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Do not use interface-based AOP proxies in combination with autodetection of JMX
annotations in your bean classes. Interface-based proxies <span class="emphasis"><em>hide</em></span> the target class, which
also hides the JMX managed resource annotations. Hence, use target-class proxies in that
case: through setting the <span class="emphasis"><em>proxy-target-class</em></span> flag on <code class="literal">&lt;aop:config/&gt;</code>,
<code class="literal">&lt;tx:annotation-driven/&gt;</code>, etc. Otherwise, your JMX beans might be silently ignored at
startup&#8230;</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="24.5&nbsp;JSR-160 Connectors"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-jsr160"></a>24.5&nbsp;JSR-160 Connectors</h2></div></div></div>

<p>For remote access, Spring JMX module offers two <code class="literal">FactoryBean</code> implementations inside the
<code class="literal">org.springframework.jmx.support</code> package for creating both server- and client-side
connectors.</p>
<div class="section" title="24.5.1&nbsp;Server-side Connectors"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-jsr160-server"></a>24.5.1&nbsp;Server-side Connectors</h3></div></div></div>

<p>To have Spring JMX create, start and expose a JSR-160 <code class="literal">JMXConnectorServer</code> use the
following configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serverConnector"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.ConnectorServerFactoryBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>By default <code class="literal">ConnectorServerFactoryBean</code> creates a <code class="literal">JMXConnectorServer</code> bound to
<code class="literal">"service:jmx:jmxmp://localhost:9875"</code>. The <code class="literal">serverConnector</code> bean thus exposes the
local <code class="literal">MBeanServer</code> to clients through the JMXMP protocol on localhost, port 9875. Note
that the JMXMP protocol is marked as optional by the JSR 160 specification: currently,
the main open-source JMX implementation, MX4J, and the one provided with J2SE 5.0
do <span class="emphasis"><em>not</em></span> support JMXMP.</p>
<p>To specify another URL and register the <code class="literal">JMXConnectorServer</code> itself with the
<code class="literal">MBeanServer</code> use the <code class="literal">serviceUrl</code> and <code class="literal">ObjectName</code> properties respectively:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serverConnector"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.ConnectorServerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"objectName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"connector:name=rmi"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceUrl"</span>
            <span class="hl-attribute">value</span>=<span class="hl-value">"service:jmx:rmi://localhost/jndi/rmi://localhost:1099/myconnector"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>If the <code class="literal">ObjectName</code> property is set Spring will automatically register your connector
with the <code class="literal">MBeanServer</code> under that <code class="literal">ObjectName</code>. The example below shows the full set of
parameters which you can pass to the <code class="literal">ConnectorServerFactoryBean</code> when creating a
JMXConnector:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serverConnector"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.ConnectorServerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"objectName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"connector:name=iiop"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceUrl"</span>
        <span class="hl-attribute">value</span>=<span class="hl-value">"service:jmx:iiop://localhost/jndi/iiop://localhost:900/myconnector"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"threaded"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"daemon"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"environment"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"someKey"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someValue"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that when using a RMI-based connector you need the lookup service (tnameserv or
rmiregistry) to be started in order for the name registration to complete. If you are
using Spring to export remote services for you via RMI, then Spring will already have
constructed an RMI registry. If not, you can easily start a registry using the following
snippet of configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"registry"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.remoting.rmi.RmiRegistryFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1099"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="24.5.2&nbsp;Client-side Connectors"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-jsr160-client"></a>24.5.2&nbsp;Client-side Connectors</h3></div></div></div>

<p>To create an <code class="literal">MBeanServerConnection</code> to a remote JSR-160 enabled <code class="literal">MBeanServer</code> use the
<code class="literal">MBeanServerConnectionFactoryBean</code> as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientConnector"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.MBeanServerConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"service:jmx:rmi://localhost/jndi/rmi://localhost:1099/jmxrmi"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="24.5.3&nbsp;JMX over Burlap/Hessian/SOAP"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-jsr160-protocols"></a>24.5.3&nbsp;JMX over Burlap/Hessian/SOAP</h3></div></div></div>

<p>JSR-160 permits extensions to the way in which communication is done between the client
and the server. The examples above are using the mandatory RMI-based implementation
required by the JSR-160 specification (IIOP and JRMP) and the (optional) JMXMP. By using
other providers or JMX implementations (such as <a class="ulink" href="http://mx4j.sourceforge.net" target="_top">MX4J</a>) you
can take advantage of protocols like SOAP, Hessian, Burlap over simple HTTP or SSL and
others:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serverConnector"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.ConnectorServerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"objectName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"connector:name=burlap"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"service:jmx:burlap://localhost:9874"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In the case of the above example, MX4J 3.0.0 was used; see the official MX4J
documentation for more information.</p>
</div>
</div>
<div class="section" title="24.6&nbsp;Accessing MBeans via Proxies"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-proxy"></a>24.6&nbsp;Accessing MBeans via Proxies</h2></div></div></div>

<p>Spring JMX allows you to create proxies that re-route calls to MBeans registered in a
local or remote <code class="literal">MBeanServer</code>. These proxies provide you with a standard Java interface
through which you can interact with your MBeans. The code below shows how to configure a
proxy for an MBean running in a local <code class="literal">MBeanServer</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.access.MBeanProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"objectName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bean:name=testBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.jmx.IJmxTestBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Here you can see that a proxy is created for the MBean registered under the
<code class="literal">ObjectName</code>: <code class="literal">bean:name=testBean</code>. The set of interfaces that the proxy will implement
is controlled by the <code class="literal">proxyInterfaces</code> property and the rules for mapping methods and
properties on these interfaces to operations and attributes on the MBean are the same
rules used by the <code class="literal">InterfaceBasedMBeanInfoAssembler</code>.</p>
<p>The <code class="literal">MBeanProxyFactoryBean</code> can create a proxy to any MBean that is accessible via an
<code class="literal">MBeanServerConnection</code>. By default, the local <code class="literal">MBeanServer</code> is located and used, but
you can override this and provide an <code class="literal">MBeanServerConnection</code> pointing to a remote
<code class="literal">MBeanServer</code> to cater for proxies pointing to remote MBeans:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientConnector"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.MBeanServerConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"service:jmx:rmi://remotehost:9875"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.access.MBeanProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"objectName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bean:name=testBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.jmx.IJmxTestBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"server"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"clientConnector"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Here you can see that we create an <code class="literal">MBeanServerConnection</code> pointing to a remote machine
using the <code class="literal">MBeanServerConnectionFactoryBean</code>. This <code class="literal">MBeanServerConnection</code> is then
passed to the <code class="literal">MBeanProxyFactoryBean</code> via the <code class="literal">server</code> property. The proxy that is
created will forward all invocations to the <code class="literal">MBeanServer</code> via this
<code class="literal">MBeanServerConnection</code>.</p>
</div>
<div class="section" title="24.7&nbsp;Notifications"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-notifications"></a>24.7&nbsp;Notifications</h2></div></div></div>

<p>Spring&#8217;s JMX offering includes comprehensive support for JMX notifications.</p>
<div class="section" title="24.7.1&nbsp;Registering Listeners for Notifications"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-notifications-listeners"></a>24.7.1&nbsp;Registering Listeners for Notifications</h3></div></div></div>

<p>Spring&#8217;s JMX support makes it very easy to register any number of
<code class="literal">NotificationListeners</code> with any number of MBeans (this includes MBeans exported by
Spring&#8217;s <code class="literal">MBeanExporter</code> and MBeans registered via some other mechanism). By way of an
example, consider the scenario where one would like to be informed (via a
<code class="literal">Notification</code>) each and every time an attribute of a target MBean changes.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.example;

<span class="hl-keyword">import</span> javax.management.AttributeChangeNotification;
<span class="hl-keyword">import</span> javax.management.Notification;
<span class="hl-keyword">import</span> javax.management.NotificationFilter;
<span class="hl-keyword">import</span> javax.management.NotificationListener;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ConsoleLoggingNotificationListener
        <span class="hl-keyword">implements</span> NotificationListener, NotificationFilter {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleNotification(Notification notification, Object handback) {
        System.out.println(notification);
        System.out.println(handback);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isNotificationEnabled(Notification notification) {
        <span class="hl-keyword">return</span> AttributeChangeNotification.<span class="hl-keyword">class</span>.isAssignableFrom(notification.getClass());
    }

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean1"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"notificationListenerMappings"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean1"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.ConsoleLoggingNotificationListener"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/entry&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>With the above configuration in place, every time a JMX <code class="literal">Notification</code> is broadcast from
the target MBean ( <code class="literal">bean:name=testBean1</code>), the <code class="literal">ConsoleLoggingNotificationListener</code> bean
that was registered as a listener via the <code class="literal">notificationListenerMappings</code> property will
be notified. The <code class="literal">ConsoleLoggingNotificationListener</code> bean can then take whatever action
it deems appropriate in response to the <code class="literal">Notification</code>.</p>
<p>You can also use straight bean names as the link between exported beans and listeners:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean1"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"notificationListenerMappings"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"</span><span class="emphasis"><em>testBean</em></span>"&gt;
                    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.ConsoleLoggingNotificationListener"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/entry&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"</span><span class="emphasis"><em>testBean</em></span>" class="org.springframework.jmx.JmxTestBean"&gt;
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>If one wants to register a single <code class="literal">NotificationListener</code> instance for all of the beans
that the enclosing <code class="literal">MBeanExporter</code> is exporting, one can use the special wildcard <code class="literal">'*'</code>
(sans quotes) as the key for an entry in the <code class="literal">notificationListenerMappings</code> property
map; for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"notificationListenerMappings"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;map&gt;</span>
        <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"*"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.ConsoleLoggingNotificationListener"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/entry&gt;</span>
    <span class="hl-tag">&lt;/map&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span></pre>

<p>If one needs to do the inverse (that is, register a number of distinct listeners against
an MBean), then one has to use the <code class="literal">notificationListeners</code> list property instead (and in
preference to the <code class="literal">notificationListenerMappings</code> property). This time, instead of
configuring simply a <code class="literal">NotificationListener</code> for a single MBean, one configures
<code class="literal">NotificationListenerBean</code> instances&#8230; a <code class="literal">NotificationListenerBean</code> encapsulates a
<code class="literal">NotificationListener</code> and the <code class="literal">ObjectName</code> (or <code class="literal">ObjectNames</code>) that it is to be
registered against in an <code class="literal">MBeanServer</code>. The <code class="literal">NotificationListenerBean</code> also encapsulates
a number of other properties such as a <code class="literal">NotificationFilter</code> and an arbitrary handback
object that can be used in advanced JMX notification scenarios.</p>
<p>The configuration when using <code class="literal">NotificationListenerBean</code> instances is not wildly
different to what was presented previously:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean1"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"notificationListeners"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.NotificationListenerBean"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg&gt;</span>
                        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.ConsoleLoggingNotificationListener"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
                    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappedObjectNames"</span><span class="hl-tag">&gt;</span>
                        <span class="hl-tag">&lt;list&gt;</span>
                            <span class="hl-tag">&lt;value&gt;</span>bean:name=testBean1<span class="hl-tag">&lt;/value&gt;</span>
                        <span class="hl-tag">&lt;/list&gt;</span>
                    <span class="hl-tag">&lt;/property&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The above example is equivalent to the first notification example. Lets assume then that
we want to be given a handback object every time a <code class="literal">Notification</code> is raised, and that
additionally we want to filter out extraneous <code class="literal">Notifications</code> by supplying a
<code class="literal">NotificationFilter</code>. (For a full discussion of just what a handback object is, and
indeed what a <code class="literal">NotificationFilter</code> is, please do consult that section of the JMX
specification (1.2) entitled <span class="emphasis"><em>The JMX Notification Model</em></span>.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exporter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.MBeanExporter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beans"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;map&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean1"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean1"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"bean:name=testBean2"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"testBean2"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/map&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"notificationListeners"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.export.NotificationListenerBean"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customerNotificationListener"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappedObjectNames"</span><span class="hl-tag">&gt;</span>
                        <span class="hl-tag">&lt;list&gt;</span>
                            <span class="hl-comment">&lt;!-- handles notifications from two distinct MBeans --&gt;</span>
                            <span class="hl-tag">&lt;value&gt;</span>bean:name=testBean1<span class="hl-tag">&lt;/value&gt;</span>
                            <span class="hl-tag">&lt;value&gt;</span>bean:name=testBean2<span class="hl-tag">&lt;/value&gt;</span>
                        <span class="hl-tag">&lt;/list&gt;</span>
                    <span class="hl-tag">&lt;/property&gt;</span>
                    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"handback"</span><span class="hl-tag">&gt;</span>
                        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.lang.String"</span><span class="hl-tag">&gt;</span>
                            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"This could be anything..."</span><span class="hl-tag">/&gt;</span>
                        <span class="hl-tag">&lt;/bean&gt;</span>
                    <span class="hl-tag">&lt;/property&gt;</span>
                    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"notificationFilter"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customerNotificationListener"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-comment">&lt;!-- implements both the NotificationListener and NotificationFilter interfaces --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customerNotificationListener"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.ConsoleLoggingNotificationListener"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean1"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean2"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.JmxTestBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ANOTHER TEST"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"200"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="24.7.2&nbsp;Publishing Notifications"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-notifications-publishing"></a>24.7.2&nbsp;Publishing Notifications</h3></div></div></div>

<p>Spring provides support not just for registering to receive <code class="literal">Notifications</code>, but also
for publishing <code class="literal">Notifications</code>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please note that this section is really only relevant to Spring managed beans that have
been exposed as MBeans via an <code class="literal">MBeanExporter</code>; any existing, user-defined MBeans should
use the standard JMX APIs for notification publication.</p>
</td></tr></table></div>

<p>The key interface in Spring&#8217;s JMX notification publication support is the
<code class="literal">NotificationPublisher</code> interface (defined in the
<code class="literal">org.springframework.jmx.export.notification</code> package). Any bean that is going to be
exported as an MBean via an <code class="literal">MBeanExporter</code> instance can implement the related
<code class="literal">NotificationPublisherAware</code> interface to gain access to a <code class="literal">NotificationPublisher</code>
instance. The <code class="literal">NotificationPublisherAware</code> interface simply supplies an instance of a
<code class="literal">NotificationPublisher</code> to the implementing bean via a simple setter method, which the
bean can then use to publish <code class="literal">Notifications</code>.</p>
<p>As stated in the Javadoc for the <code class="literal">NotificationPublisher</code> class, managed beans that are
publishing events via the <code class="literal">NotificationPublisher</code> mechanism are <span class="emphasis"><em>not</em></span> responsible for
the state management of any notification listeners and the like &#8230; Spring&#8217;s JMX support
will take care of handling all the JMX infrastructure issues. All one need do as an
application developer is implement the <code class="literal">NotificationPublisherAware</code> interface and start
publishing events using the supplied <code class="literal">NotificationPublisher</code> instance. Note that the
<code class="literal">NotificationPublisher</code> will be set <span class="emphasis"><em>after</em></span> the managed bean has been registered with
an <code class="literal">MBeanServer</code>.</p>
<p>Using a <code class="literal">NotificationPublisher</code> instance is quite straightforward&#8230; one simply creates
a JMX <code class="literal">Notification</code> instance (or an instance of an appropriate <code class="literal">Notification</code>
subclass), populates the notification with the data pertinent to the event that is to be
published, and one then invokes the <code class="literal">sendNotification(Notification)</code> on the
<code class="literal">NotificationPublisher</code> instance, passing in the <code class="literal">Notification</code>.</p>
<p>Find below a simple example&#8230; in this scenario, exported instances of the <code class="literal">JmxTestBean</code>
are going to publish a <code class="literal">NotificationEvent</code> every time the <code class="literal">add(int, int)</code> operation is
invoked.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.jmx;

<span class="hl-keyword">import</span> org.springframework.jmx.export.notification.NotificationPublisherAware;
<span class="hl-keyword">import</span> org.springframework.jmx.export.notification.NotificationPublisher;
<span class="hl-keyword">import</span> javax.management.Notification;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JmxTestBean <span class="hl-keyword">implements</span> IJmxTestBean, NotificationPublisherAware {

    <span class="hl-keyword">private</span> String name;
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> age;
    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> isSuperman;
    <span class="hl-keyword">private</span> NotificationPublisher publisher;

    <span class="hl-comment">// other getters and setters omitted for clarity</span>

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> add(<span class="hl-keyword">int</span> x, <span class="hl-keyword">int</span> y) {
        <span class="hl-keyword">int</span> answer = x + y;
        <span class="hl-keyword">this</span>.publisher.sendNotification(<span class="hl-keyword">new</span> Notification(<span class="hl-string">"add"</span>, <span class="hl-keyword">this</span>, <span class="hl-number">0</span>));
        <span class="hl-keyword">return</span> answer;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> dontExposeMe() {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException();
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setNotificationPublisher(NotificationPublisher notificationPublisher) {
        <span class="hl-keyword">this</span>.publisher = notificationPublisher;
    }

}</pre>

<p>The <code class="literal">NotificationPublisher</code> interface and the machinery to get it all working is one of
the nicer features of Spring&#8217;s JMX support. It does however come with the price tag of
coupling your classes to both Spring and JMX; as always, the advice here is to be
pragmatic&#8230; if you need the functionality offered by the <code class="literal">NotificationPublisher</code> and
you can accept the coupling to both Spring and JMX, then do so.</p>
</div>
</div>
<div class="section" title="24.8&nbsp;Further Resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-resources"></a>24.8&nbsp;Further Resources</h2></div></div></div>

<p>This section contains links to further resources about JMX.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <a class="ulink" href="http://www.oracle.com/technetwork/java/javase/tech/javamanagement-140525.html" target="_top">JMX
homepage</a> at Oracle
</li><li class="listitem">
The <a class="ulink" href="http://jcp.org/aboutJava/communityprocess/final/jsr003/index3.html" target="_top">JMX
specification</a> (JSR-000003)
</li><li class="listitem">
The <a class="ulink" href="http://jcp.org/aboutJava/communityprocess/final/jsr160/index.html" target="_top">JMX Remote API
specification</a> (JSR-000160)
</li><li class="listitem">
The <a class="ulink" href="http://mx4j.sourceforge.net/" target="_top">MX4J homepage</a> (an Open Source implementation of
various JMX specs)
</li></ul></div>

</div>
</div>
<div class="chapter" title="25.&nbsp;JCA CCI"><div class="titlepage"><div><div><h2 class="title"><a name="cci"></a>25.&nbsp;JCA CCI</h2></div></div></div>

<div class="section" title="25.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cci-introduction"></a>25.1&nbsp;Introduction</h2></div></div></div>

<p>Java EE provides a specification to standardize access to enterprise information systems
(EIS): the JCA (J2EE Connector Architecture). This specification is divided into several
different parts:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
SPI (Service provider interfaces) that the connector provider must implement. These
interfaces constitute a resource adapter which can be deployed on a Java EE
application server. In such a scenario, the server manages connection pooling,
transaction and security (managed mode). The application server is also responsible
for managing the configuration, which is held outside the client application. A
connector can be used without an application server as well; in this case, the
application must configure it directly (non-managed mode).
</li><li class="listitem">
CCI (Common Client Interface) that an application can use to interact with the
connector and thus communicate with an EIS. An API for local transaction demarcation
is provided as well.
</li></ul></div>

<p>The aim of the Spring CCI support is to provide classes to access a CCI connector in
typical Spring style, leveraging the Spring Framework&#8217;s general resource and transaction
management facilities.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The client side of connectors doesn&#8217;t alway use CCI. Some connectors expose their own
APIs, only providing JCA resource adapter to use the system contracts of a Java EE
container (connection pooling, global transactions, security). Spring does not offer
special support for such connector-specific APIs.</p>
</td></tr></table></div>

</div>
<div class="section" title="25.2&nbsp;Configuring CCI"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cci-config"></a>25.2&nbsp;Configuring CCI</h2></div></div></div>

<div class="section" title="25.2.1&nbsp;Connector configuration"><div class="titlepage"><div><div><h3 class="title"><a name="cci-config-connector"></a>25.2.1&nbsp;Connector configuration</h3></div></div></div>

<p>The base resource to use JCA CCI is the <code class="literal">ConnectionFactory</code> interface. The connector
used must provide an implementation of this interface.</p>
<p>To use your connector, you can deploy it on your application server and fetch the
<code class="literal">ConnectionFactory</code> from the server&#8217;s JNDI environment (managed mode). The connector
must be packaged as a RAR file (resource adapter archive) and contain a <code class="literal">ra.xml</code> file to
describe its deployment characteristics. The actual name of the resource is specified
when you deploy it. To access it within Spring, simply use Spring&#8217;s
<code class="literal">JndiObjectFactoryBean</code> / <code class="literal">&lt;jee:jndi-lookup&gt;</code> fetch the factory by its JNDI name.</p>
<p>Another way to use a connector is to embed it in your application (non-managed mode),
not using an application server to deploy and configure it. Spring offers the
possibility to configure a connector as a bean, through a provided <code class="literal">FactoryBean</code> (
<code class="literal">LocalConnectionFactoryBean</code>). In this manner, you only need the connector library in
the classpath (no RAR file and no <code class="literal">ra.xml</code> descriptor needed). The library must be
extracted from the connector&#8217;s RAR file, if necessary.</p>
<p>Once you have got access to your <code class="literal">ConnectionFactory</code> instance, you can inject it into
your components. These components can either be coded against the plain CCI API or
leverage Spring&#8217;s support classes for CCI access (e.g. <code class="literal">CciTemplate</code>).</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When you use a connector in non-managed mode, you can&#8217;t use global transactions because
the resource is never enlisted / delisted in the current global transaction of the
current thread. The resource is simply not aware of any global Java EE transactions that
might be running.</p>
</td></tr></table></div>

</div>
<div class="section" title="25.2.2&nbsp;ConnectionFactory configuration in Spring"><div class="titlepage"><div><div><h3 class="title"><a name="cci-config-connectionfactory"></a>25.2.2&nbsp;ConnectionFactory configuration in Spring</h3></div></div></div>

<p>In order to make connections to the EIS, you need to obtain a <code class="literal">ConnectionFactory</code> from
the application server if you are in a managed mode, or directly from Spring if you are
in a non-managed mode.</p>
<p>In a managed mode, you access a <code class="literal">ConnectionFactory</code> from JNDI; its properties will be
configured in the application server.</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eciConnectionFactory"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"eis/cicseci"</span><span class="hl-tag">/&gt;</span></pre>

<p>In non-managed mode, you must configure the <code class="literal">ConnectionFactory</code> you want to use in the
configuration of Spring as a JavaBean. The <code class="literal">LocalConnectionFactoryBean</code> class offers
this setup style, passing in the <code class="literal">ManagedConnectionFactory</code> implementation of your
connector, exposing the application-level CCI <code class="literal">ConnectionFactory</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eciManagedConnectionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.ibm.connector2.cics.ECIManagedConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serverName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TXSERIES"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionURL"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"tcp://localhost/"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"portNumber"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2006"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eciConnectionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.support.LocalConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"managedConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"eciManagedConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can&#8217;t directly instantiate a specific <code class="literal">ConnectionFactory</code>. You need to go through
the corresponding implementation of the <code class="literal">ManagedConnectionFactory</code> interface for your
connector. This interface is part of the JCA SPI specification.</p>
</td></tr></table></div>

</div>
<div class="section" title="25.2.3&nbsp;Configuring CCI connections"><div class="titlepage"><div><div><h3 class="title"><a name="cci-config-cci-connections"></a>25.2.3&nbsp;Configuring CCI connections</h3></div></div></div>

<p>JCA CCI allow the developer to configure the connections to the EIS using the
<code class="literal">ConnectionSpec</code> implementation of your connector. In order to configure its properties,
you need to wrap the target connection factory with a dedicated adapter,
<code class="literal">ConnectionSpecConnectionFactoryAdapter</code>. So, the dedicated <code class="literal">ConnectionSpec</code> can be
configured with the property <code class="literal">connectionSpec</code> (as an inner bean).</p>
<p>This property is not mandatory because the CCI <code class="literal">ConnectionFactory</code> interface defines two
different methods to obtain a CCI connection. Some of the <code class="literal">ConnectionSpec</code> properties
can often be configured in the application server (in managed mode) or on the
corresponding local <code class="literal">ManagedConnectionFactory</code> implementation.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ConnectionFactory <span class="hl-keyword">implements</span> Serializable, Referenceable {
    ...
    Connection getConnection() <span class="hl-keyword">throws</span> ResourceException;
    Connection getConnection(ConnectionSpec connectionSpec) <span class="hl-keyword">throws</span> ResourceException;
    ...
}</pre>

<p>Spring provides a <code class="literal">ConnectionSpecConnectionFactoryAdapter</code> that allows for specifying a
<code class="literal">ConnectionSpec</code> instance to use for all operations on a given factory. If the adapter&#8217;s
<code class="literal">connectionSpec</code> property is specified, the adapter uses the <code class="literal">getConnection</code> variant
with the <code class="literal">ConnectionSpec</code> argument, otherwise the variant without argument.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"managedConnectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"com.sun.connector.cciblackbox.CciLocalTxManagedConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionURL"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc:hsqldb:hsql://localhost:9001"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.hsqldb.jdbcDriver"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"targetConnectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.support.LocalConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"managedConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"managedConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"connectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.cci.connection.ConnectionSpecConnectionFactoryAdapter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"targetConnectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionSpec"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.sun.connector.cciblackbox.CciConnectionSpec"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"sa"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="25.2.4&nbsp;Using a single CCI connection"><div class="titlepage"><div><div><h3 class="title"><a name="cci-config-single-connection"></a>25.2.4&nbsp;Using a single CCI connection</h3></div></div></div>

<p>If you want to use a single CCI connection, Spring provides a further
<code class="literal">ConnectionFactory</code> adapter to manage this. The <code class="literal">SingleConnectionFactory</code> adapter class
will open a single connection lazily and close it when this bean is destroyed at
application shutdown. This class will expose special <code class="literal">Connection</code> proxies that behave
accordingly, all sharing the same underlying physical connection.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eciManagedConnectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"com.ibm.connector2.cics.ECIManagedConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serverName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TEST"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionURL"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"tcp://localhost/"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"portNumber"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2006"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"targetEciConnectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.support.LocalConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"managedConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"eciManagedConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eciConnectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.cci.connection.SingleConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"targetEciConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This <code class="literal">ConnectionFactory</code> adapter cannot directly be configured with a <code class="literal">ConnectionSpec</code>.
Use an intermediary <code class="literal">ConnectionSpecConnectionFactoryAdapter</code> that the
<code class="literal">SingleConnectionFactory</code> talks to if you require a single connection for a specific
<code class="literal">ConnectionSpec</code>.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="25.3&nbsp;Using Spring&#8217;s CCI access support"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cci-using"></a>25.3&nbsp;Using Spring&#8217;s CCI access support</h2></div></div></div>

<div class="section" title="25.3.1&nbsp;Record conversion"><div class="titlepage"><div><div><h3 class="title"><a name="cci-record-creator"></a>25.3.1&nbsp;Record conversion</h3></div></div></div>

<p>One of the aims of the JCA CCI support is to provide convenient facilities for
manipulating CCI records. The developer can specify the strategy to create records and
extract datas from records, for use with Spring&#8217;s <code class="literal">CciTemplate</code>. The following
interfaces will configure the strategy to use input and output records if you don&#8217;t want
to work with records directly in your application.</p>
<p>In order to create an input <code class="literal">Record</code>, the developer can use a dedicated implementation
of the <code class="literal">RecordCreator</code> interface.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RecordCreator {

    Record createRecord(RecordFactory recordFactory) <span class="hl-keyword">throws</span> ResourceException, DataAccessException;

}</pre>

<p>As you can see, the <code class="literal">createRecord(..)</code> method receives a <code class="literal">RecordFactory</code> instance as
parameter, which corresponds to the <code class="literal">RecordFactory</code> of the <code class="literal">ConnectionFactory</code> used.
This reference can be used to create <code class="literal">IndexedRecord</code> or <code class="literal">MappedRecord</code> instances. The
following sample shows how to use the <code class="literal">RecordCreator</code> interface and indexed/mapped
records.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyRecordCreator <span class="hl-keyword">implements</span> RecordCreator {

    <span class="hl-keyword">public</span> Record createRecord(RecordFactory recordFactory) <span class="hl-keyword">throws</span> ResourceException {
        IndexedRecord input = recordFactory.createIndexedRecord(<span class="hl-string">"input"</span>);
        input.add(<span class="hl-keyword">new</span> Integer(id));
        <span class="hl-keyword">return</span> input;
    }

}</pre>

<p>An output <code class="literal">Record</code> can be used to receive data back from the EIS. Hence, a specific
implementation of the <code class="literal">RecordExtractor</code> interface can be passed to Spring&#8217;s
<code class="literal">CciTemplate</code> for extracting data from the output <code class="literal">Record</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RecordExtractor {

    Object extractData(Record record) <span class="hl-keyword">throws</span> ResourceException, SQLException, DataAccessException;

}</pre>

<p>The following sample shows how to use the <code class="literal">RecordExtractor</code> interface.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyRecordExtractor <span class="hl-keyword">implements</span> RecordExtractor {

    <span class="hl-keyword">public</span> Object extractData(Record record) <span class="hl-keyword">throws</span> ResourceException {
        CommAreaRecord commAreaRecord = (CommAreaRecord) record;
        String str = <span class="hl-keyword">new</span> String(commAreaRecord.toByteArray());
        String field1 = string.substring(<span class="hl-number">0</span>,<span class="hl-number">6</span>);
        String field2 = string.substring(<span class="hl-number">6</span>,<span class="hl-number">1</span>);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> OutputObject(Long.parseLong(field1), field2);
    }

}</pre>

</div>
<div class="section" title="25.3.2&nbsp;the CciTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="cci-using-template"></a>25.3.2&nbsp;the CciTemplate</h3></div></div></div>

<p>The <code class="literal">CciTemplate</code> is the central class of the core CCI support package (
<code class="literal">org.springframework.jca.cci.core</code>). It simplifies the use of CCI since it handles the
creation and release of resources. This helps to avoid common errors like forgetting to
always close the connection. It cares for the lifecycle of connection and interaction
objects, letting application code focus on generating input records from application
data and extracting application data from output records.</p>
<p>The JCA CCI specification defines two distinct methods to call operations on an EIS. The
CCI <code class="literal">Interaction</code> interface provides two execute method signatures:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> javax.resource.cci.Interaction {

    ...

    <span class="hl-keyword">boolean</span> execute(InteractionSpec spec, Record input, Record output) <span class="hl-keyword">throws</span> ResourceException;

    Record execute(InteractionSpec spec, Record input) <span class="hl-keyword">throws</span> ResourceException;

    ...

}</pre>

<p>Depending on the template method called, <code class="literal">CciTemplate</code> will know which <code class="literal">execute</code> method
to call on the interaction. In any case, a correctly initialized <code class="literal">InteractionSpec</code>
instance is mandatory.</p>
<p><code class="literal">CciTemplate.execute(..)</code> can be used in two ways:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
With direct <code class="literal">Record</code> arguments. In this case, you simply need to pass the CCI input
record in, and the returned object be the corresponding CCI output record.
</li><li class="listitem">
With application objects, using record mapping. In this case, you need to provide
corresponding <code class="literal">RecordCreator</code> and <code class="literal">RecordExtractor</code> instances.
</li></ul></div>

<p>With the first approach, the following methods of the template will be used. These
methods directly correspond to those on the <code class="literal">Interaction</code> interface.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CciTemplate <span class="hl-keyword">implements</span> CciOperations {

    <span class="hl-keyword">public</span> Record execute(InteractionSpec spec, Record inputRecord)
            <span class="hl-keyword">throws</span> DataAccessException { ... }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> execute(InteractionSpec spec, Record inputRecord, Record outputRecord)
            <span class="hl-keyword">throws</span> DataAccessException { ... }

}</pre>

<p>With the second approach, we need to specify the record creation and record extraction
strategies as arguments. The interfaces used are those describe in the previous section
on record conversion. The corresponding <code class="literal">CciTemplate</code> methods are the following:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CciTemplate <span class="hl-keyword">implements</span> CciOperations {

    <span class="hl-keyword">public</span> Record execute(InteractionSpec spec,
            RecordCreator inputCreator) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-comment">// ...</span>
    }

    <span class="hl-keyword">public</span> Object execute(InteractionSpec spec, Record inputRecord,
            RecordExtractor outputExtractor) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-comment">// ...</span>
    }

    <span class="hl-keyword">public</span> Object execute(InteractionSpec spec, RecordCreator creator,
            RecordExtractor extractor) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-comment">// ...</span>
    }

}</pre>

<p>Unless the <code class="literal">outputRecordCreator</code> property is set on the template (see the following
section), every method will call the corresponding <code class="literal">execute</code> method of the CCI
<code class="literal">Interaction</code> with two parameters: <code class="literal">InteractionSpec</code> and input <code class="literal">Record</code>, receiving an
output <code class="literal">Record</code> as return value.</p>
<p><code class="literal">CciTemplate</code> also provides methods to create <code class="literal">IndexRecord</code> and <code class="literal">MappedRecord</code> outside a
<code class="literal">RecordCreator</code> implementation, through its <code class="literal">createIndexRecord(..)</code> and
<code class="literal">createMappedRecord(..)</code> methods. This can be used within DAO implementations to create
<code class="literal">Record</code> instances to pass into corresponding <code class="literal">CciTemplate.execute(..)</code> methods.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CciTemplate <span class="hl-keyword">implements</span> CciOperations {

    <span class="hl-keyword">public</span> IndexedRecord createIndexedRecord(String name) <span class="hl-keyword">throws</span> DataAccessException { ... }

    <span class="hl-keyword">public</span> MappedRecord createMappedRecord(String name) <span class="hl-keyword">throws</span> DataAccessException { ... }

}</pre>

</div>
<div class="section" title="25.3.3&nbsp;DAO support"><div class="titlepage"><div><div><h3 class="title"><a name="cci-using-dao"></a>25.3.3&nbsp;DAO support</h3></div></div></div>

<p>Spring&#8217;s CCI support provides a abstract class for DAOs, supporting injection of a
<code class="literal">ConnectionFactory</code> or a <code class="literal">CciTemplate</code> instances. The name of the class is
<code class="literal">CciDaoSupport</code>: It provides simple <code class="literal">setConnectionFactory</code> and <code class="literal">setCciTemplate</code> methods.
Internally, this class will create a <code class="literal">CciTemplate</code> instance for a passed-in
<code class="literal">ConnectionFactory</code>, exposing it to concrete data access implementations in subclasses.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> CciDaoSupport {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setConnectionFactory(ConnectionFactory connectionFactory) {
        <span class="hl-comment">// ...</span>
    }

    <span class="hl-keyword">public</span> ConnectionFactory getConnectionFactory() {
        <span class="hl-comment">// ...</span>
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setCciTemplate(CciTemplate cciTemplate) {
        <span class="hl-comment">// ...</span>
    }

    <span class="hl-keyword">public</span> CciTemplate getCciTemplate() {
        <span class="hl-comment">// ...</span>
    }

}</pre>

</div>
<div class="section" title="25.3.4&nbsp;Automatic output record generation"><div class="titlepage"><div><div><h3 class="title"><a name="automatic-output-generation"></a>25.3.4&nbsp;Automatic output record generation</h3></div></div></div>

<p>If the connector used only supports the <code class="literal">Interaction.execute(..)</code> method with input and
output records as parameters (that is, it requires the desired output record to be
passed in instead of returning an appropriate output record), you can set the
<code class="literal">outputRecordCreator</code> property of the <code class="literal">CciTemplate</code> to automatically generate an output
record to be filled by the JCA connector when the response is received. This record will
be then returned to the caller of the template.</p>
<p>This property simply holds an implementation of the <code class="literal">RecordCreator</code> interface, used for
that purpose. The <code class="literal">RecordCreator</code> interface has already been discussed in
<a class="xref" href="#cci-record-creator" title="25.3.1&nbsp;Record conversion">Section&nbsp;25.3.1, &#8220;Record conversion&#8221;</a>. The <code class="literal">outputRecordCreator</code> property must be directly specified on
the <code class="literal">CciTemplate</code>. This could be done in the application code like so:</p>
<pre class="programlisting">cciTemplate.setOutputRecordCreator(<span class="hl-keyword">new</span> EciOutputRecordCreator());</pre>

<p>Or (recommended) in the Spring configuration, if the <code class="literal">CciTemplate</code> is configured as a
dedicated bean instance:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eciOutputRecordCreator"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"eci.EciOutputRecordCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cciTemplate"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.cci.core.CciTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"eciConnectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputRecordCreator"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"eciOutputRecordCreator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As the <code class="literal">CciTemplate</code> class is thread-safe, it will usually be configured as a shared
instance.</p>
</td></tr></table></div>

</div>
<div class="section" title="25.3.5&nbsp;Summary"><div class="titlepage"><div><div><h3 class="title"><a name="template-summary"></a>25.3.5&nbsp;Summary</h3></div></div></div>

<p>The following table summarizes the mechanisms of the <code class="literal">CciTemplate</code> class and the
corresponding methods called on the CCI <code class="literal">Interaction</code> interface:</p>
<div class="table"><a name="cci-interaction-execute-methods"></a><p class="title"><b>Table&nbsp;25.1.&nbsp;Usage of Interaction execute methods</b></p><div class="table-contents">

  <table summary="Usage of Interaction execute methods" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">CciTemplate method signature</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">CciTemplate outputRecordCreator property</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">execute method called on the CCI Interaction</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>not set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>boolean execute(InteractionSpec, Record, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>void execute(InteractionSpec, Record, Record)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>not set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>void execute(InteractionSpec, Record, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>void execute(InteractionSpec, Record, Record)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>void execute(InteractionSpec, Record, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, RecordCreator)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>not set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, RecordCreator)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>void execute(InteractionSpec, Record, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record, RecordExtractor)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>not set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record, RecordExtractor)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>void execute(InteractionSpec, Record, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, RecordCreator, RecordExtractor)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>not set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, RecordCreator, RecordExtractor)</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>set</p></td><td style="" align="left" valign="top"><p>void execute(InteractionSpec, Record, Record)</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="25.3.6&nbsp;Using a CCI Connection and Interaction directly"><div class="titlepage"><div><div><h3 class="title"><a name="cci-straight"></a>25.3.6&nbsp;Using a CCI Connection and Interaction directly</h3></div></div></div>

<p><code class="literal">CciTemplate</code> also offers the possibility to work directly with CCI connections and
interactions, in the same manner as <code class="literal">JdbcTemplate</code> and <code class="literal">JmsTemplate</code>. This is useful
when you want to perform multiple operations on a CCI connection or interaction, for
example.</p>
<p>The interface <code class="literal">ConnectionCallback</code> provides a CCI <code class="literal">Connection</code> as argument, in order to
perform custom operations on it, plus the CCI <code class="literal">ConnectionFactory</code> which the <code class="literal">Connection</code>
was created with. The latter can be useful for example to get an associated
<code class="literal">RecordFactory</code> instance and create indexed/mapped records, for example.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ConnectionCallback {

    Object doInConnection(Connection connection, ConnectionFactory connectionFactory)
            <span class="hl-keyword">throws</span> ResourceException, SQLException, DataAccessException;

}</pre>

<p>The interface <code class="literal">InteractionCallback</code> provides the CCI <code class="literal">Interaction</code>, in order to perform
custom operations on it, plus the corresponding CCI <code class="literal">ConnectionFactory</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> InteractionCallback {

    Object doInInteraction(Interaction interaction, ConnectionFactory connectionFactory)
        <span class="hl-keyword">throws</span> ResourceException, SQLException, DataAccessException;

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">InteractionSpec</code> objects can either be shared across multiple template calls or newly
created inside every callback method. This is completely up to the DAO implementation.</p>
</td></tr></table></div>

</div>
<div class="section" title="25.3.7&nbsp;Example for CciTemplate usage"><div class="titlepage"><div><div><h3 class="title"><a name="cci-template-example"></a>25.3.7&nbsp;Example for CciTemplate usage</h3></div></div></div>

<p>In this section, the usage of the <code class="literal">CciTemplate</code> will be shown to acces to a CICS with
ECI mode, with the IBM CICS ECI connector.</p>
<p>Firstly, some initializations on the CCI <code class="literal">InteractionSpec</code> must be done to specify which
CICS program to access and how to interact with it.</p>
<pre class="programlisting">ECIInteractionSpec interactionSpec = <span class="hl-keyword">new</span> ECIInteractionSpec();
interactionSpec.setFunctionName(<span class="hl-string">"MYPROG"</span>);
interactionSpec.setInteractionVerb(ECIInteractionSpec.SYNC_SEND_RECEIVE);</pre>

<p>Then the program can use CCI via Spring&#8217;s template and specify mappings between custom
objects and CCI <code class="literal">Records</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyDaoImpl <span class="hl-keyword">extends</span> CciDaoSupport <span class="hl-keyword">implements</span> MyDao {

    <span class="hl-keyword">public</span> OutputObject getData(InputObject input) {
        ECIInteractionSpec interactionSpec = ...;

    OutputObject output = (ObjectOutput) getCciTemplate().execute(interactionSpec,
        <span class="hl-keyword">new</span> RecordCreator() {
            <span class="hl-keyword">public</span> Record createRecord(RecordFactory recordFactory) <span class="hl-keyword">throws</span> ResourceException {
                <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CommAreaRecord(input.toString().getBytes());
            }
        },
        <span class="hl-keyword">new</span> RecordExtractor() {
            <span class="hl-keyword">public</span> Object extractData(Record record) <span class="hl-keyword">throws</span> ResourceException {
                CommAreaRecord commAreaRecord = (CommAreaRecord)record;
                String str = <span class="hl-keyword">new</span> String(commAreaRecord.toByteArray());
                String field1 = string.substring(<span class="hl-number">0</span>,<span class="hl-number">6</span>);
                String field2 = string.substring(<span class="hl-number">6</span>,<span class="hl-number">1</span>);
                <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> OutputObject(Long.parseLong(field1), field2);
            }
        });

        <span class="hl-keyword">return</span> output;
    }
}</pre>

<p>As discussed previously, callbacks can be used to work directly on CCI connections or
interactions.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyDaoImpl <span class="hl-keyword">extends</span> CciDaoSupport <span class="hl-keyword">implements</span> MyDao {

    <span class="hl-keyword">public</span> OutputObject getData(InputObject input) {
        ObjectOutput output = (ObjectOutput) getCciTemplate().execute(
            <span class="hl-keyword">new</span> ConnectionCallback() {
                <span class="hl-keyword">public</span> Object doInConnection(Connection connection,
                        ConnectionFactory factory) <span class="hl-keyword">throws</span> ResourceException {

                    <span class="hl-comment">// do something...</span>

                }
            });
        }
        <span class="hl-keyword">return</span> output;
    }

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>With a <code class="literal">ConnectionCallback</code>, the <code class="literal">Connection</code> used will be managed and closed by the
<code class="literal">CciTemplate</code>, but any interactions created on the connection must be managed by the
callback implementation.</p>
</td></tr></table></div>

<p>For a more specific callback, you can implement an <code class="literal">InteractionCallback</code>. The passed-in
<code class="literal">Interaction</code> will be managed and closed by the <code class="literal">CciTemplate</code> in this case.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyDaoImpl <span class="hl-keyword">extends</span> CciDaoSupport <span class="hl-keyword">implements</span> MyDao {

    <span class="hl-keyword">public</span> String getData(String input) {
        ECIInteractionSpec interactionSpec = ...;
        String output = (String) getCciTemplate().execute(interactionSpec,
            <span class="hl-keyword">new</span> InteractionCallback() {
                <span class="hl-keyword">public</span> Object doInInteraction(Interaction interaction,
                        ConnectionFactory factory) <span class="hl-keyword">throws</span> ResourceException {
                    Record input = <span class="hl-keyword">new</span> CommAreaRecord(inputString.getBytes());
                    Record output = <span class="hl-keyword">new</span> CommAreaRecord();
                    interaction.execute(holder.getInteractionSpec(), input, output);
                    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String(output.toByteArray());
                }
            });
        <span class="hl-keyword">return</span> output;
    }

}</pre>

<p>For the examples above, the corresponding configuration of the involved Spring beans
could look like this in non-managed mode:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"managedConnectionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.ibm.connector2.cics.ECIManagedConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serverName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TXSERIES"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionURL"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"local:"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CICSUSER"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CICS"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.support.LocalConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"managedConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"managedConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"component"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"mypackage.MyDaoImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In managed mode (that is, in a Java EE environment), the configuration could look as
follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"eis/cicseci"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"component"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MyDaoImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
</div>
<div class="section" title="25.4&nbsp;Modeling CCI access as operation objects"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cci-object"></a>25.4&nbsp;Modeling CCI access as operation objects</h2></div></div></div>

<p>The <code class="literal">org.springframework.jca.cci.object</code> package contains support classes that allow you
to access the EIS in a different style: through reusable operation objects, analogous to
Spring&#8217;s JDBC operation objects (see JDBC chapter). This will usually encapsulate the
CCI API: an application-level input object will be passed to the operation object, so it
can construct the input record and then convert the received record data to an
application-level output object and return it.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This approach is internally based on the <code class="literal">CciTemplate</code> class and the
<code class="literal">RecordCreator</code> / <code class="literal">RecordExtractor</code> interfaces, reusing the machinery of Spring&#8217;s core
CCI support.</p>
</td></tr></table></div>

<div class="section" title="25.4.1&nbsp;MappingRecordOperation"><div class="titlepage"><div><div><h3 class="title"><a name="cci-object-mapping-record"></a>25.4.1&nbsp;MappingRecordOperation</h3></div></div></div>

<p><code class="literal">MappingRecordOperation</code> essentially performs the same work as <code class="literal">CciTemplate</code>, but
represents a specific, pre-configured operation as an object. It provides two template
methods to specify how to convert an input object to a input record, and how to convert
an output record to an output object (record mapping):</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">createInputRecord(..)</code> to specify how to convert an input object to an input <code class="literal">Record</code>
</li><li class="listitem">
<code class="literal">extractOutputData(..)</code> to specify how to extract an output object from an output
<code class="literal">Record</code>
</li></ul></div>

<p>Here are the signatures of these methods:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> MappingRecordOperation <span class="hl-keyword">extends</span> EisOperation {

    ...

    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Record createInputRecord(RecordFactory recordFactory,
            Object inputObject) <span class="hl-keyword">throws</span> ResourceException, DataAccessException {
        <span class="hl-comment">// ...</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object extractOutputData(Record outputRecord)
            <span class="hl-keyword">throws</span> ResourceException, SQLException, DataAccessException {
        <span class="hl-comment">// ...</span>
    }

    ...

}</pre>

<p>Thereafter, in order to execute an EIS operation, you need to use a single execute
method, passing in an application-level input object and receiving an application-level
output object as result:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> MappingRecordOperation <span class="hl-keyword">extends</span> EisOperation {

    ...

    <span class="hl-keyword">public</span> Object execute(Object inputObject) <span class="hl-keyword">throws</span> DataAccessException {
    }

    ...
}</pre>

<p>As you can see, contrary to the <code class="literal">CciTemplate</code> class, this <code class="literal">execute(..)</code> method does not
have an <code class="literal">InteractionSpec</code> as argument. Instead, the <code class="literal">InteractionSpec</code> is global to the
operation. The following constructor must be used to instantiate an operation object
with a specific <code class="literal">InteractionSpec</code>:</p>
<pre class="programlisting">InteractionSpec spec = ...;
MyMappingRecordOperation eisOperation = <span class="hl-keyword">new</span> MyMappingRecordOperation(getConnectionFactory(), spec);
...</pre>

</div>
<div class="section" title="25.4.2&nbsp;MappingCommAreaOperation"><div class="titlepage"><div><div><h3 class="title"><a name="cci-object-mapping-comm-area"></a>25.4.2&nbsp;MappingCommAreaOperation</h3></div></div></div>

<p>Some connectors use records based on a COMMAREA which represents an array of bytes
containing parameters to send to the EIS and data returned by it. Spring provides a
special operation class for working directly on COMMAREA rather than on records. The
<code class="literal">MappingCommAreaOperation</code> class extends the <code class="literal">MappingRecordOperation</code> class to provide
such special COMMAREA support. It implicitly uses the <code class="literal">CommAreaRecord</code> class as input
and output record type, and provides two new methods to convert an input object into an
input COMMAREA and the output COMMAREA into an output object.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> MappingCommAreaOperation <span class="hl-keyword">extends</span> MappingRecordOperation {

    ...

    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">byte</span>[] objectToBytes(Object inObject)
            <span class="hl-keyword">throws</span> IOException, DataAccessException;

    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object bytesToObject(<span class="hl-keyword">byte</span>[] bytes)
        <span class="hl-keyword">throws</span> IOException, DataAccessException;

    ...

}</pre>

</div>
<div class="section" title="25.4.3&nbsp;Automatic output record generation"><div class="titlepage"><div><div><h3 class="title"><a name="cci-automatic-record-gen"></a>25.4.3&nbsp;Automatic output record generation</h3></div></div></div>

<p>As every <code class="literal">MappingRecordOperation</code> subclass is based on CciTemplate internally, the same
way to automatically generate output records as with <code class="literal">CciTemplate</code> is available. Every
operation object provides a corresponding <code class="literal">setOutputRecordCreator(..)</code> method. For
further information, see <a class="xref" href="#automatic-output-generation" title="25.3.4&nbsp;Automatic output record generation">Section&nbsp;25.3.4, &#8220;Automatic output record generation&#8221;</a>.</p>
</div>
<div class="section" title="25.4.4&nbsp;Summary"><div class="titlepage"><div><div><h3 class="title"><a name="cci-object-summary"></a>25.4.4&nbsp;Summary</h3></div></div></div>

<p>The operation object approach uses records in the same manner as the <code class="literal">CciTemplate</code> class.</p>
<div class="table"><a name="cci-interaction-methods"></a><p class="title"><b>Table&nbsp;25.2.&nbsp;Usage of Interaction execute methods</b></p><div class="table-contents">

  <table summary="Usage of Interaction execute methods" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">MappingRecordOperation method signature</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">MappingRecordOperation outputRecordCreator property</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">execute method called on the CCI Interaction</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Object execute(Object)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>not set</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Record execute(InteractionSpec, Record)</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Object execute(Object)</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>set</p></td><td style="" align="left" valign="top"><p>boolean execute(InteractionSpec, Record, Record)</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="25.4.5&nbsp;Example for MappingRecordOperation usage"><div class="titlepage"><div><div><h3 class="title"><a name="cci-objects-mappring-record-example"></a>25.4.5&nbsp;Example for MappingRecordOperation usage</h3></div></div></div>

<p>In this section, the usage of the <code class="literal">MappingRecordOperation</code> will be shown to access a
database with the Blackbox CCI connector.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The original version of this connector is provided by the Java EE SDK (version 1.3),
available from Oracle.</p>
</td></tr></table></div>

<p>Firstly, some initializations on the CCI <code class="literal">InteractionSpec</code> must be done to specify which
SQL request to execute. In this sample, we directly define the way to convert the
parameters of the request to a CCI record and the way to convert the CCI result record
to an instance of the <code class="literal">Person</code> class.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PersonMappingOperation <span class="hl-keyword">extends</span> MappingRecordOperation {

    <span class="hl-keyword">public</span> PersonMappingOperation(ConnectionFactory connectionFactory) {
        setConnectionFactory(connectionFactory);
        CciInteractionSpec interactionSpec = <span class="hl-keyword">new</span> CciConnectionSpec();
        interactionSpec.setSql(<span class="hl-string">"select * from person where person_id=?"</span>);
        setInteractionSpec(interactionSpec);
    }

    <span class="hl-keyword">protected</span> Record createInputRecord(RecordFactory recordFactory,
            Object inputObject) <span class="hl-keyword">throws</span> ResourceException {
        Integer id = (Integer) inputObject;
        IndexedRecord input = recordFactory.createIndexedRecord(<span class="hl-string">"input"</span>);
        input.add(<span class="hl-keyword">new</span> Integer(id));
        <span class="hl-keyword">return</span> input;
    }

    <span class="hl-keyword">protected</span> Object extractOutputData(Record outputRecord)
            <span class="hl-keyword">throws</span> ResourceException, SQLException {
        ResultSet rs = (ResultSet) outputRecord;
        Person person = null;
        <span class="hl-keyword">if</span> (rs.next()) {
            Person person = <span class="hl-keyword">new</span> Person();
            person.setId(rs.getInt(<span class="hl-string">"person_id"</span>));
            person.setLastName(rs.getString(<span class="hl-string">"person_last_name"</span>));
            person.setFirstName(rs.getString(<span class="hl-string">"person_first_name"</span>));
        }
        <span class="hl-keyword">return</span> person;
    }
}</pre>

<p>Then the application can execute the operation object, with the person identifier as
argument. Note that operation object could be set up as shared instance, as it is
thread-safe.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyDaoImpl <span class="hl-keyword">extends</span> CciDaoSupport <span class="hl-keyword">implements</span> MyDao {

    <span class="hl-keyword">public</span> Person getPerson(<span class="hl-keyword">int</span> id) {
        PersonMappingOperation query = <span class="hl-keyword">new</span> PersonMappingOperation(getConnectionFactory());
        Person person = (Person) query.execute(<span class="hl-keyword">new</span> Integer(id));
        <span class="hl-keyword">return</span> person;
    }
}</pre>

<p>The corresponding configuration of Spring beans could look as follows in non-managed mode:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"managedConnectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"com.sun.connector.cciblackbox.CciLocalTxManagedConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionURL"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc:hsqldb:hsql://localhost:9001"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.hsqldb.jdbcDriver"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"targetConnectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.support.LocalConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"managedConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"managedConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"connectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.cci.connection.ConnectionSpecConnectionFactoryAdapter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"targetConnectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionSpec"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.sun.connector.cciblackbox.CciConnectionSpec"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"sa"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"component"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MyDaoImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In managed mode (that is, in a Java EE environment), the configuration could look as
follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"targetConnectionFactory"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"eis/blackbox"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"connectionFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.cci.connection.ConnectionSpecConnectionFactoryAdapter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"targetConnectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionSpec"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.sun.connector.cciblackbox.CciConnectionSpec"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"sa"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"component"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MyDaoImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="25.4.6&nbsp;Example for MappingCommAreaOperation usage"><div class="titlepage"><div><div><h3 class="title"><a name="cci-objects-mapping-comm-area-example"></a>25.4.6&nbsp;Example for MappingCommAreaOperation usage</h3></div></div></div>

<p>In this section, the usage of the <code class="literal">MappingCommAreaOperation</code> will be shown: accessing a
CICS with ECI mode with the IBM CICS ECI connector.</p>
<p>Firstly, the CCI <code class="literal">InteractionSpec</code> needs to be initialized to specify which CICS program
to access and how to interact with it.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> EciMappingOperation <span class="hl-keyword">extends</span> MappingCommAreaOperation {

    <span class="hl-keyword">public</span> EciMappingOperation(ConnectionFactory connectionFactory, String programName) {
        setConnectionFactory(connectionFactory);
        ECIInteractionSpec interactionSpec = <span class="hl-keyword">new</span> ECIInteractionSpec(),
        interactionSpec.setFunctionName(programName);
        interactionSpec.setInteractionVerb(ECIInteractionSpec.SYNC_SEND_RECEIVE);
        interactionSpec.setCommareaLength(<span class="hl-number">30</span>);
        setInteractionSpec(interactionSpec);
        setOutputRecordCreator(<span class="hl-keyword">new</span> EciOutputRecordCreator());
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> EciOutputRecordCreator <span class="hl-keyword">implements</span> RecordCreator {
        <span class="hl-keyword">public</span> Record createRecord(RecordFactory recordFactory) <span class="hl-keyword">throws</span> ResourceException {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CommAreaRecord();
        }
    }

}</pre>

<p>The abstract <code class="literal">EciMappingOperation</code> class can then be subclassed to specify mappings
between custom objects and <code class="literal">Records</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyDaoImpl <span class="hl-keyword">extends</span> CciDaoSupport <span class="hl-keyword">implements</span> MyDao {

    <span class="hl-keyword">public</span> OutputObject getData(Integer id) {
        EciMappingOperation query = <span class="hl-keyword">new</span> EciMappingOperation(getConnectionFactory(), <span class="hl-string">"MYPROG"</span>) {

            <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">byte</span>[] objectToBytes(Object inObject) <span class="hl-keyword">throws</span> IOException {
                Integer id = (Integer) inObject;
                <span class="hl-keyword">return</span> String.valueOf(id);
            }

            <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object bytesToObject(<span class="hl-keyword">byte</span>[] bytes) <span class="hl-keyword">throws</span> IOException;
                String str = <span class="hl-keyword">new</span> String(bytes);
                String field1 = str.substring(<span class="hl-number">0</span>,<span class="hl-number">6</span>);
                String field2 = str.substring(<span class="hl-number">6</span>,<span class="hl-number">1</span>);
                String field3 = str.substring(<span class="hl-number">7</span>,<span class="hl-number">1</span>);
                <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> OutputObject(field1, field2, field3);
            }
        });

        <span class="hl-keyword">return</span> (OutputObject) query.execute(<span class="hl-keyword">new</span> Integer(id));
    }

}</pre>

<p>The corresponding configuration of Spring beans could look as follows in non-managed mode:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"managedConnectionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.ibm.connector2.cics.ECIManagedConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serverName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TXSERIES"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionURL"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"local:"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CICSUSER"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CICS"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.support.LocalConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"managedConnectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"managedConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"component"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MyDaoImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In managed mode (that is, in a Java EE environment), the configuration could look as
follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"eis/cicseci"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"component"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"MyDaoImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
</div>
<div class="section" title="25.5&nbsp;Transactions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cci-tx"></a>25.5&nbsp;Transactions</h2></div></div></div>

<p>JCA specifies several levels of transaction support for resource adapters. The kind of
transactions that your resource adapter supports is specified in its <code class="literal">ra.xml</code> file.
There are essentially three options: none (for example with CICS EPI connector), local
transactions (for example with a CICS ECI connector), global transactions (for example
with an IMS connector).</p>
<pre class="programlisting"><span class="hl-tag">&lt;connector&gt;</span>
    <span class="hl-tag">&lt;resourceadapter&gt;</span>
        <span class="hl-comment">&lt;!-- &lt;transaction-support&gt;NoTransaction&lt;/transaction-support&gt; --&gt;</span>
        <span class="hl-comment">&lt;!-- &lt;transaction-support&gt;LocalTransaction&lt;/transaction-support&gt; --&gt;</span>
        <span class="hl-tag">&lt;transaction-support&gt;</span>XATransaction<span class="hl-tag">&lt;/transaction-support&gt;</span>
    <span class="hl-tag">&lt;resourceadapter&gt;</span>
<span class="hl-tag">&lt;connector&gt;</span></pre>

<p>For global transactions, you can use Spring&#8217;s generic transaction infrastructure to
demarcate transactions, with <code class="literal">JtaTransactionManager</code> as backend (delegating to the Java
EE server&#8217;s distributed transaction coordinator underneath).</p>
<p>For local transactions on a single CCI <code class="literal">ConnectionFactory</code>, Spring provides a specific
transaction management strategy for CCI, analogous to the <code class="literal">DataSourceTransactionManager</code>
for JDBC. The CCI API defines a local transaction object and corresponding local
transaction demarcation methods. Spring&#8217;s <code class="literal">CciLocalTransactionManager</code> executes such
local CCI transactions, fully compliant with Spring&#8217;s generic
<code class="literal">PlatformTransactionManager</code> abstraction.</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eciConnectionFactory"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"eis/cicseci"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eciTransactionManager"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jca.cci.connection.CciLocalTransactionManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"eciConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Both transaction strategies can be used with any of Spring&#8217;s transaction demarcation
facilities, be it declarative or programmatic. This is a consequence of Spring&#8217;s generic
<code class="literal">PlatformTransactionManager</code> abstraction, which decouples transaction demarcation from
the actual execution strategy. Simply switch between <code class="literal">JtaTransactionManager</code> and
<code class="literal">CciLocalTransactionManager</code> as needed, keeping your transaction demarcation as-is.</p>
<p>For more information on Spring&#8217;s transaction facilities, see the chapter entitled
<a class="xref" href="#transaction" title="11.&nbsp;Transaction Management">Chapter&nbsp;11, <i>Transaction Management</i></a>.</p>
</div>
</div>
<div class="chapter" title="26.&nbsp;Email"><div class="titlepage"><div><div><h2 class="title"><a name="mail"></a>26.&nbsp;Email</h2></div></div></div>

<div class="section" title="26.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-introduction"></a>26.1&nbsp;Introduction</h2></div></div></div>

<div class="sidebar" title="Library dependencies"><p class="title"><b>Library dependencies</b></p>

<p>The following additional jars to be on the classpath of your application in order to be
able to use the Spring Framework&#8217;s email library.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <a class="ulink" href="https://java.net/projects/javamail/pages/Home" target="_top">JavaMail</a> <code class="literal">mail.jar</code> library
</li><li class="listitem">
The <a class="ulink" href="http://www.oracle.com/technetwork/java/jaf11-139815.html" target="_top">JAF</a>
<code class="literal">activation.jar</code> library
</li></ul></div>

<p>All of these libraries are freely available on the web.</p>
</div>

<p>The Spring Framework provides a helpful utility library for sending email that shields
the user from the specifics of the underlying mailing system and is responsible for low
level resource handling on behalf of the client.</p>
<p>The <code class="literal">org.springframework.mail</code> package is the root level package for the Spring
Framework&#8217;s email support. The central interface for sending emails is the <code class="literal">MailSender</code>
interface; a simple value object encapsulating the properties of a simple mail such as
<span class="emphasis"><em>from</em></span> and <span class="emphasis"><em>to</em></span> (plus many others) is the <code class="literal">SimpleMailMessage</code> class. This package
also contains a hierarchy of checked exceptions which provide a higher level of
abstraction over the lower level mail system exceptions with the root exception being
<code class="literal">MailException</code>. Please refer to the JavaDocs for more information on the rich mail
exception hierarchy.</p>
<p>The <code class="literal">org.springframework.mail.javamail.JavaMailSender</code> interface adds specialized
<span class="emphasis"><em>JavaMail</em></span> features such as MIME message support to the <code class="literal">MailSender</code> interface (from
which it inherits). <code class="literal">JavaMailSender</code> also provides a callback interface for preparation
of JavaMail MIME messages, called
<code class="literal">org.springframework.mail.javamail.MimeMessagePreparator</code></p>
</div>
<div class="section" title="26.2&nbsp;Usage"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-usage"></a>26.2&nbsp;Usage</h2></div></div></div>

<p>Let&#8217;s assume there is a business interface called <code class="literal">OrderManager</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> OrderManager {

    <span class="hl-keyword">void</span> placeOrder(Order order);

}</pre>

<p>Let us also assume that there is a requirement stating that an email message with an
order number needs to be generated and sent to a customer placing the relevant order.</p>
<div class="section" title="26.2.1&nbsp;Basic MailSender and SimpleMailMessage usage"><div class="titlepage"><div><div><h3 class="title"><a name="mail-usage-simple"></a>26.2.1&nbsp;Basic MailSender and SimpleMailMessage usage</h3></div></div></div>

<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.mail.MailException;
<span class="hl-keyword">import</span> org.springframework.mail.MailSender;
<span class="hl-keyword">import</span> org.springframework.mail.SimpleMailMessage;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleOrderManager <span class="hl-keyword">implements</span> OrderManager {

    <span class="hl-keyword">private</span> MailSender mailSender;
    <span class="hl-keyword">private</span> SimpleMailMessage templateMessage;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMailSender(MailSender mailSender) {
        <span class="hl-keyword">this</span>.mailSender = mailSender;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTemplateMessage(SimpleMailMessage templateMessage) {
        <span class="hl-keyword">this</span>.templateMessage = templateMessage;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> placeOrder(Order order) {

        <span class="hl-comment">// Do the business calculations...</span>

        <span class="hl-comment">// Call the collaborators to persist the order...</span>

        <span class="hl-comment">// Create a thread safe "copy" of the template message and customize it</span>
        SimpleMailMessage msg = <span class="hl-keyword">new</span> SimpleMailMessage(<span class="hl-keyword">this</span>.templateMessage);
        msg.setTo(order.getCustomer().getEmailAddress());
        msg.setText(
            <span class="hl-string">"Dear "</span> + order.getCustomer().getFirstName()
                + order.getCustomer().getLastName()
                + <span class="hl-string">", thank you for placing order. Your order number is "</span>
                + order.getOrderNumber());
        <span class="hl-keyword">try</span>{
            <span class="hl-keyword">this</span>.mailSender.send(msg);
        }
        <span class="hl-keyword">catch</span> (MailException ex) {
            <span class="hl-comment">// simply log it and go on...</span>
            System.err.println(ex.getMessage());
        }
    }

}</pre>

<p>Find below the bean definitions for the above code:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mailSender"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.mail.javamail.JavaMailSenderImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"mail.mycompany.com"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-comment">&lt;!-- this is a template message that we can pre-load with default state --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"templateMessage"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.mail.SimpleMailMessage"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"from"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"customerservice@mycompany.com"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"subject"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Your order"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.businessapp.support.SimpleOrderManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mailSender"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mailSender"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"templateMessage"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"templateMessage"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="26.2.2&nbsp;Using the JavaMailSender and the MimeMessagePreparator"><div class="titlepage"><div><div><h3 class="title"><a name="mail-usage-mime"></a>26.2.2&nbsp;Using the JavaMailSender and the MimeMessagePreparator</h3></div></div></div>

<p>Here is another implementation of <code class="literal">OrderManager</code> using the <code class="literal">MimeMessagePreparator</code>
callback interface. Please note in this case that the <code class="literal">mailSender</code> property is of type
<code class="literal">JavaMailSender</code> so that we are able to use the JavaMail <code class="literal">MimeMessage</code> class:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> javax.mail.Message;
<span class="hl-keyword">import</span> javax.mail.MessagingException;
<span class="hl-keyword">import</span> javax.mail.internet.InternetAddress;
<span class="hl-keyword">import</span> javax.mail.internet.MimeMessage;

<span class="hl-keyword">import</span> javax.mail.internet.MimeMessage;
<span class="hl-keyword">import</span> org.springframework.mail.MailException;
<span class="hl-keyword">import</span> org.springframework.mail.javamail.JavaMailSender;
<span class="hl-keyword">import</span> org.springframework.mail.javamail.MimeMessagePreparator;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleOrderManager <span class="hl-keyword">implements</span> OrderManager {

    <span class="hl-keyword">private</span> JavaMailSender mailSender;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMailSender(JavaMailSender mailSender) {
        <span class="hl-keyword">this</span>.mailSender = mailSender;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> placeOrder(<span class="hl-keyword">final</span> Order order) {

        <span class="hl-comment">// Do the business calculations...</span>

        <span class="hl-comment">// Call the collaborators to persist the order...</span>

        MimeMessagePreparator preparator = <span class="hl-keyword">new</span> MimeMessagePreparator() {

            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> prepare(MimeMessage mimeMessage) <span class="hl-keyword">throws</span> Exception {

                mimeMessage.setRecipient(Message.RecipientType.TO,
                        <span class="hl-keyword">new</span> InternetAddress(order.getCustomer().getEmailAddress()));
                mimeMessage.setFrom(<span class="hl-keyword">new</span> InternetAddress(<span class="hl-string">"mail@mycompany.com"</span>));
                mimeMessage.setText(
                        <span class="hl-string">"Dear "</span> + order.getCustomer().getFirstName() + <span class="hl-string">" "</span>
                            + order.getCustomer().getLastName()
                            + <span class="hl-string">", thank you for placing order. Your order number is "</span>
                            + order.getOrderNumber());
            }
        };

        <span class="hl-keyword">try</span> {
            <span class="hl-keyword">this</span>.mailSender.send(preparator);
        }
        <span class="hl-keyword">catch</span> (MailException ex) {
            <span class="hl-comment">// simply log it and go on...</span>
            System.err.println(ex.getMessage());
        }
    }

}</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The mail code is a crosscutting concern and could well be a candidate for refactoring
into a <a class="link" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">custom Spring AOP aspect</a>, which then could be executed at appropriate
joinpoints on the <code class="literal">OrderManager</code> target.</p>
</td></tr></table></div>

<p>The Spring Framework&#8217;s mail support ships with the standard JavaMail implementation.
Please refer to the relevant JavaDocs for more information.</p>
</div>
</div>
<div class="section" title="26.3&nbsp;Using the JavaMail MimeMessageHelper"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-javamail-mime"></a>26.3&nbsp;Using the JavaMail MimeMessageHelper</h2></div></div></div>

<p>A class that comes in pretty handy when dealing with JavaMail messages is the
<code class="literal">org.springframework.mail.javamail.MimeMessageHelper</code> class, which shields you from
having to use the verbose JavaMail API. Using the <code class="literal">MimeMessageHelper</code> it is pretty easy
to create a <code class="literal">MimeMessage</code>:</p>
<pre class="programlisting"><span class="hl-comment">// of course you would use DI in any real-world cases</span>
JavaMailSenderImpl sender = <span class="hl-keyword">new</span> JavaMailSenderImpl();
sender.setHost(<span class="hl-string">"mail.host.com"</span>);

MimeMessage message = sender.createMimeMessage();
MimeMessageHelper helper = <span class="hl-keyword">new</span> MimeMessageHelper(message);
helper.setTo(<span class="hl-string">"test@host.com"</span>);
helper.setText(<span class="hl-string">"Thank you for ordering!"</span>);

sender.send(message);</pre>

<div class="section" title="26.3.1&nbsp;Sending attachments and inline resources"><div class="titlepage"><div><div><h3 class="title"><a name="mail-javamail-mime-attachments"></a>26.3.1&nbsp;Sending attachments and inline resources</h3></div></div></div>

<p>Multipart email messages allow for both attachments and inline resources. Examples of
inline resources would be images or a stylesheet you want to use in your message, but
that you don&#8217;t want displayed as an attachment.</p>
<div class="section" title="Attachments"><div class="titlepage"><div><div><h4 class="title"><a name="mail-javamail-mime-attachments-attachment"></a>Attachments</h4></div></div></div>

<p>The following example shows you how to use the <code class="literal">MimeMessageHelper</code> to send an email
along with a single JPEG image attachment.</p>
<pre class="programlisting">JavaMailSenderImpl sender = <span class="hl-keyword">new</span> JavaMailSenderImpl();
sender.setHost(<span class="hl-string">"mail.host.com"</span>);

MimeMessage message = sender.createMimeMessage();

<span class="hl-comment">// use the true flag to indicate you need a multipart message</span>
MimeMessageHelper helper = <span class="hl-keyword">new</span> MimeMessageHelper(message, true);
helper.setTo(<span class="hl-string">"test@host.com"</span>);

helper.setText(<span class="hl-string">"Check out this image!"</span>);

<span class="hl-comment">// let's attach the infamous windows Sample file (this time copied to c:/)</span>
FileSystemResource file = <span class="hl-keyword">new</span> FileSystemResource(<span class="hl-keyword">new</span> File(<span class="hl-string">"c:/Sample.jpg"</span>));
helper.addAttachment(<span class="hl-string">"CoolImage.jpg"</span>, file);

sender.send(message);</pre>

</div>
<div class="section" title="Inline resources"><div class="titlepage"><div><div><h4 class="title"><a name="mail-javamail-mime-attachments-inline"></a>Inline resources</h4></div></div></div>

<p>The following example shows you how to use the <code class="literal">MimeMessageHelper</code> to send an email
along with an inline image.</p>
<pre class="programlisting">JavaMailSenderImpl sender = <span class="hl-keyword">new</span> JavaMailSenderImpl();
sender.setHost(<span class="hl-string">"mail.host.com"</span>);

MimeMessage message = sender.createMimeMessage();

<span class="hl-comment">// use the true flag to indicate you need a multipart message</span>
MimeMessageHelper helper = <span class="hl-keyword">new</span> MimeMessageHelper(message, true);
helper.setTo(<span class="hl-string">"test@host.com"</span>);

<span class="hl-comment">// use the true flag to indicate the text included is HTML</span>
helper.setText(<span class="hl-string">"&lt;html&gt;&lt;body&gt;&lt;img src=</span><span class="emphasis"><em>cid:identifier1234</em></span>&gt;&lt;/body&gt;&lt;/html&gt;<span class="hl-string">", true);
</span>
<span class="hl-comment">// let's include the infamous windows Sample file (this time copied to c:/)</span>
FileSystemResource res = <span class="hl-keyword">new</span> FileSystemResource(<span class="hl-keyword">new</span> File(<span class="hl-string">"c:/Sample.jpg"</span>));
helper.addInline(<span class="hl-string">"identifier1234"</span>, res);

sender.send(message);</pre>

<div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>Inline resources are added to the mime message using the specified <code class="literal">Content-ID</code> (
<code class="literal">identifier1234</code> in the above example). The order in which you are adding the text and
the resource are <span class="emphasis"><em>very</em></span> important. Be sure to <span class="emphasis"><em>first add the text</em></span> and after that
the resources. If you are doing it the other way around, it won&#8217;t work!</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="26.3.2&nbsp;Creating email content using a templating library"><div class="titlepage"><div><div><h3 class="title"><a name="mail-templates"></a>26.3.2&nbsp;Creating email content using a templating library</h3></div></div></div>

<p>The code in the previous examples explicitly created the content of the email message,
using methods calls such as <code class="literal">message.setText(..)</code>. This is fine for simple cases, and it
is okay in the context of the aforementioned examples, where the intent was to show you
the very basics of the API.</p>
<p>In your typical enterprise application though, you are not going to create the content
of your emails using the above approach for a number of reasons.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Creating HTML-based email content in Java code is tedious and error prone
</li><li class="listitem">
There is no clear separation between display logic and business logic
</li><li class="listitem">
Changing the display structure of the email content requires writing Java code,
recompiling, redeploying&#8230;
</li></ul></div>

<p>Typically the approach taken to address these issues is to use a template library such
as FreeMarker or Velocity to define the display structure of email content. This leaves
your code tasked only with creating the data that is to be rendered in the email
template and sending the email. It is definitely a best practice for when the content of
your emails becomes even moderately complex, and with the Spring Framework&#8217;s support
classes for FreeMarker and Velocity becomes quite easy to do. Find below an example of
using the Velocity template library to create email content.</p>
<div class="section" title="A Velocity-based example"><div class="titlepage"><div><div><h4 class="title"><a name="mail-templates-example"></a>A Velocity-based example</h4></div></div></div>

<p>To use <a class="ulink" href="http://velocity.apache.org" target="_top">Velocity</a> to create your email template(s), you will
need to have the Velocity libraries available on your classpath. You will also need to
create one or more Velocity templates for the email content that your application needs.
Find below the Velocity template that this example will be using. As you can see it is
HTML-based, and since it is plain text it can be created using your favorite HTML or
text editor.</p>
<pre class="programlisting"># in the com/foo/package
<span class="hl-tag">&lt;html&gt;</span>
    <span class="hl-tag">&lt;body&gt;</span>
        <span class="hl-tag">&lt;h3&gt;</span>Hi ${user.userName}, welcome to the Chipping Sodbury On-the-Hill message boards!<span class="hl-tag">&lt;/h3&gt;</span>

        <span class="hl-tag">&lt;div&gt;</span>
            Your email address is <span class="hl-tag">&lt;a</span> <span class="hl-attribute">href</span>=<span class="hl-value">"mailto:${user.emailAddress}"</span><span class="hl-tag">&gt;</span>${user.emailAddress}<span class="hl-tag">&lt;/a&gt;</span>.
        <span class="hl-tag">&lt;/div&gt;</span>
    <span class="hl-tag">&lt;/body&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span></pre>

<p>Find below some simple code and Spring XML configuration that makes use of the above
Velocity template to create email content and send email(s).</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> org.apache.velocity.app.VelocityEngine;
<span class="hl-keyword">import</span> org.springframework.mail.javamail.JavaMailSender;
<span class="hl-keyword">import</span> org.springframework.mail.javamail.MimeMessageHelper;
<span class="hl-keyword">import</span> org.springframework.mail.javamail.MimeMessagePreparator;
<span class="hl-keyword">import</span> org.springframework.ui.velocity.VelocityEngineUtils;

<span class="hl-keyword">import</span> javax.mail.internet.MimeMessage;
<span class="hl-keyword">import</span> java.util.HashMap;
<span class="hl-keyword">import</span> java.util.Map;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleRegistrationService <span class="hl-keyword">implements</span> RegistrationService {

    <span class="hl-keyword">private</span> JavaMailSender mailSender;
    <span class="hl-keyword">private</span> VelocityEngine velocityEngine;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMailSender(JavaMailSender mailSender) {
        <span class="hl-keyword">this</span>.mailSender = mailSender;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setVelocityEngine(VelocityEngine velocityEngine) {
        <span class="hl-keyword">this</span>.velocityEngine = velocityEngine;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> register(User user) {

        <span class="hl-comment">// Do the registration logic...</span>

        sendConfirmationEmail(user);
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">void</span> sendConfirmationEmail(<span class="hl-keyword">final</span> User user) {
        MimeMessagePreparator preparator = <span class="hl-keyword">new</span> MimeMessagePreparator() {
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> prepare(MimeMessage mimeMessage) <span class="hl-keyword">throws</span> Exception {
                MimeMessageHelper message = <span class="hl-keyword">new</span> MimeMessageHelper(mimeMessage);
                message.setTo(user.getEmailAddress());
                message.setFrom(<span class="hl-string">"webmaster@csonth.gov.uk"</span>); <span class="hl-comment">// could be parameterized...</span>
                Map model = <span class="hl-keyword">new</span> HashMap();
                model.put(<span class="hl-string">"user"</span>, user);
                String text = VelocityEngineUtils.mergeTemplateIntoString(
                        velocityEngine, <span class="hl-string">"com/dns/registration-confirmation.vm"</span>, model);
                message.setText(text, true);
            }
        };
        <span class="hl-keyword">this</span>.mailSender.send(preparator);
    }

}</pre>

<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mailSender"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.mail.javamail.JavaMailSenderImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"mail.csonth.gov.uk"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"registrationService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.SimpleRegistrationService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mailSender"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mailSender"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"velocityEngine"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"velocityEngine"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"velocityEngine"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.ui.velocity.VelocityEngineFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"velocityProperties"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>
                resource.loader=class
                class.resource.loader.class=org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader
            <span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
</div>
</div>
</div>
<div class="chapter" title="27.&nbsp;Task Execution and Scheduling"><div class="titlepage"><div><div><h2 class="title"><a name="scheduling"></a>27.&nbsp;Task Execution and Scheduling</h2></div></div></div>

<div class="section" title="27.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scheduling-introduction"></a>27.1&nbsp;Introduction</h2></div></div></div>

<p>The Spring Framework provides abstractions for asynchronous execution and scheduling of
tasks with the <code class="literal">TaskExecutor</code> and <code class="literal">TaskScheduler</code> interfaces, respectively. Spring also
features implementations of those interfaces that support thread pools or delegation to
CommonJ within an application server environment. Ultimately the use of these
implementations behind the common interfaces abstracts away the differences between Java
SE 5, Java SE 6 and Java EE environments.</p>
<p>Spring also features integration classes for supporting scheduling with the <code class="literal">Timer</code>,
part of the JDK since 1.3, and the Quartz Scheduler ( <a class="ulink" href="http://quartz-scheduler.org" target="_top">http://quartz-scheduler.org</a>).
Both of those schedulers are set up using a <code class="literal">FactoryBean</code> with optional references to
<code class="literal">Timer</code> or <code class="literal">Trigger</code> instances, respectively. Furthermore, a convenience class for both
the Quartz Scheduler and the <code class="literal">Timer</code> is available that allows you to invoke a method of
an existing target object (analogous to the normal <code class="literal">MethodInvokingFactoryBean</code>
operation).</p>
</div>
<div class="section" title="27.2&nbsp;The Spring TaskExecutor abstraction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scheduling-task-executor"></a>27.2&nbsp;The Spring TaskExecutor abstraction</h2></div></div></div>

<p>Spring 2.0 introduces a new abstraction for dealing with executors. Executors are the
Java 5 name for the concept of thread pools. The "executor" naming is due to the fact
that there is no guarantee that the underlying implementation is actually a pool; an
executor may be single-threaded or even synchronous. Spring&#8217;s abstraction hides
implementation details between Java SE 1.4, Java SE 5 and Java EE environments.</p>
<p>Spring&#8217;s <code class="literal">TaskExecutor</code> interface is identical to the <code class="literal">java.util.concurrent.Executor</code>
interface. In fact, its primary reason for existence is to abstract away the need for
Java 5 when using thread pools. The interface has a single method <code class="literal">execute(Runnable
task)</code> that accepts a task for execution based on the semantics and configuration of the
thread pool.</p>
<p>The <code class="literal">TaskExecutor</code> was originally created to give other Spring components an abstraction
for thread pooling where needed. Components such as the <code class="literal">ApplicationEventMulticaster</code>,
JMS&#8217;s <code class="literal">AbstractMessageListenerContainer</code>, and Quartz integration all use the
<code class="literal">TaskExecutor</code> abstraction to pool threads. However, if your beans need thread pooling
behavior, it is possible to use this abstraction for your own needs.</p>
<div class="section" title="27.2.1&nbsp;TaskExecutor types"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-task-executor-types"></a>27.2.1&nbsp;TaskExecutor types</h3></div></div></div>

<p>There are a number of pre-built implementations of <code class="literal">TaskExecutor</code> included with the
Spring distribution. In all likelihood, you shouldn&#8217;t ever need to implement your own.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">SimpleAsyncTaskExecutor</code> This implementation does not reuse any threads, rather it
starts up a new thread for each invocation. However, it does support a concurrency
limit which will block any invocations that are over the limit until a slot has been
freed up. If you&#8217;re looking for true pooling, keep scrolling further down the page.
</li><li class="listitem">
<code class="literal">SyncTaskExecutor</code> This implementation doesn&#8217;t execute invocations asynchronously.
Instead, each invocation takes place in the calling thread. It is primarily used in
situations where multithreading isn&#8217;t necessary such as simple test cases.
</li><li class="listitem">
<code class="literal">ConcurrentTaskExecutor</code> This implementation is a wrapper for a Java 5
<code class="literal">java.util.concurrent.Executor</code>. There is an alternative, <code class="literal">ThreadPoolTaskExecutor</code>,
that exposes the <code class="literal">Executor</code> configuration parameters as bean properties. It is rare to
need to use the <code class="literal">ConcurrentTaskExecutor</code> but if the <a class="link" href="#"><code class="literal">ThreadPoolTaskExecutor</code></a> isn&#8217;t robust enough for your needs, the
<code class="literal">ConcurrentTaskExecutor</code> is an alternative.
</li><li class="listitem">
<code class="literal">SimpleThreadPoolTaskExecutor</code> This implementation is actually a subclass of Quartz&#8217;s
<code class="literal">SimpleThreadPool</code> which listens to Spring&#8217;s lifecycle callbacks. This is typically
used when you have a thread pool that may need to be shared by both Quartz and
non-Quartz components.
</li><li class="listitem">
<code class="literal">ThreadPoolTaskExecutor</code>
</li></ul></div>

<p>This implementation can only be used in a Java 5 environment but is also the most
commonly used one in that environment. It exposes bean properties for configuring a
<code class="literal">java.util.concurrent.ThreadPoolExecutor</code> and wraps it in a <code class="literal">TaskExecutor</code>. If you need
something advanced such as a <code class="literal">ScheduledThreadPoolExecutor</code>, it is recommended that you
use a <a class="link" href="#"><code class="literal">ConcurrentTaskExecutor</code></a> instead.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">TimerTaskExecutor</code> This implementation uses a single <code class="literal">TimerTask</code> as its backing
implementation. It&#8217;s different from the <a class="link" href="#"><code class="literal">SyncTaskExecutor</code></a> in
that the method invocations are executed in a separate thread, although they are
synchronous in that thread.
</li><li class="listitem">
<p class="simpara"><code class="literal">WorkManagerTaskExecutor</code></p>
<div class="sidebar"><p class="title"><b></b></p>
<p>CommonJ is a set of specifications jointly developed between BEA and IBM. These
specifications are not Java EE standards, but are standard across BEA&#8217;s and IBM&#8217;s
Application Server implementations.</p>
</div>

<p class="simpara">This implementation uses the CommonJ WorkManager as its backing implementation and is
the central convenience class for setting up a CommonJ WorkManager reference in a Spring
context. Similar to the <a class="link" href="#"><code class="literal">SimpleThreadPoolTaskExecutor</code></a>, this class implements the WorkManager interface and
therefore can be used directly as a WorkManager as well.</p>
</li></ul></div>

</div>
<div class="section" title="27.2.2&nbsp;Using a TaskExecutor"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-task-executor-usage"></a>27.2.2&nbsp;Using a TaskExecutor</h3></div></div></div>

<p>Spring&#8217;s <code class="literal">TaskExecutor</code> implementations are used as simple JavaBeans. In the example
below, we define a bean that uses the <code class="literal">ThreadPoolTaskExecutor</code> to asynchronously print
out a set of messages.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.core.task.TaskExecutor;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TaskExecutorExample {

    <span class="hl-keyword">private</span> <span class="hl-keyword">class</span> MessagePrinterTask <span class="hl-keyword">implements</span> Runnable {

        <span class="hl-keyword">private</span> String message;

        <span class="hl-keyword">public</span> MessagePrinterTask(String message) {
            <span class="hl-keyword">this</span>.message = message;
        }

        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run() {
            System.out.println(message);
        }

    }

    <span class="hl-keyword">private</span> TaskExecutor taskExecutor;

    <span class="hl-keyword">public</span> TaskExecutorExample(TaskExecutor taskExecutor) {
        <span class="hl-keyword">this</span>.taskExecutor = taskExecutor;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> printMessages() {
        <span class="hl-keyword">for</span>(<span class="hl-keyword">int</span> i = <span class="hl-number">0</span>; i &lt; <span class="hl-number">25</span>; i++) {
            taskExecutor.execute(<span class="hl-keyword">new</span> MessagePrinterTask(<span class="hl-string">"Message"</span> + i));
        }
    }

}</pre>

<p>As you can see, rather than retrieving a thread from the pool and executing yourself,
you add your <code class="literal">Runnable</code> to the queue and the <code class="literal">TaskExecutor</code> uses its internal rules to
decide when the task gets executed.</p>
<p>To configure the rules that the <code class="literal">TaskExecutor</code> will use, simple bean properties have
been exposed.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"taskExecutor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"corePoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxPoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queueCapacity"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"25"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"taskExecutorExample"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"TaskExecutorExample"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"taskExecutor"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
</div>
<div class="section" title="27.3&nbsp;The Spring TaskScheduler abstraction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scheduling-task-scheduler"></a>27.3&nbsp;The Spring TaskScheduler abstraction</h2></div></div></div>

<p>In addition to the <code class="literal">TaskExecutor</code> abstraction, Spring 3.0 introduces a <code class="literal">TaskScheduler</code>
with a variety of methods for scheduling tasks to run at some point in the future.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TaskScheduler {

    ScheduledFuture schedule(Runnable task, Trigger trigger);

    ScheduledFuture schedule(Runnable task, Date startTime);

    ScheduledFuture scheduleAtFixedRate(Runnable task, Date startTime, <span class="hl-keyword">long</span> period);

    ScheduledFuture scheduleAtFixedRate(Runnable task, <span class="hl-keyword">long</span> period);

    ScheduledFuture scheduleWithFixedDelay(Runnable task, Date startTime, <span class="hl-keyword">long</span> delay);

    ScheduledFuture scheduleWithFixedDelay(Runnable task, <span class="hl-keyword">long</span> delay);

}</pre>

<p>The simplest method is the one named <span class="emphasis"><em>schedule</em></span> that takes a <code class="literal">Runnable</code> and <code class="literal">Date</code> only.
That will cause the task to run once after the specified time. All of the other methods
are capable of scheduling tasks to run repeatedly. The fixed-rate and fixed-delay
methods are for simple, periodic execution, but the method that accepts a Trigger is
much more flexible.</p>
<div class="section" title="27.3.1&nbsp;the Trigger interface"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-trigger-interface"></a>27.3.1&nbsp;the Trigger interface</h3></div></div></div>

<p>The <code class="literal">Trigger</code> interface is essentially inspired by JSR-236, which, as of Spring 3.0, has
not yet been officially implemented. The basic idea of the <code class="literal">Trigger</code> is that execution
times may be determined based on past execution outcomes or even arbitrary conditions.
If these determinations do take into account the outcome of the preceding execution,
that information is available within a <code class="literal">TriggerContext</code>. The <code class="literal">Trigger</code> interface itself
is quite simple:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Trigger {

    Date nextExecutionTime(TriggerContext triggerContext);

}</pre>

<p>As you can see, the <code class="literal">TriggerContext</code> is the most important part. It encapsulates all of
the relevant data, and is open for extension in the future if necessary. The
<code class="literal">TriggerContext</code> is an interface (a <code class="literal">SimpleTriggerContext</code> implementation is used by
default). Here you can see what methods are available for <code class="literal">Trigger</code> implementations.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TriggerContext {

    Date lastScheduledExecutionTime();

    Date lastActualExecutionTime();

    Date lastCompletionTime();

}</pre>

</div>
<div class="section" title="27.3.2&nbsp;Trigger implementations"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-trigger-implementations"></a>27.3.2&nbsp;Trigger implementations</h3></div></div></div>

<p>Spring provides two implementations of the <code class="literal">Trigger</code> interface. The most interesting one
is the <code class="literal">CronTrigger</code>. It enables the scheduling of tasks based on cron expressions. For
example the following task is being scheduled to run 15 minutes past each hour but only
during the 9-to-5 "business hours" on weekdays.</p>
<pre class="programlisting">scheduler.schedule(task, <span class="hl-keyword">new</span> CronTrigger(<span class="hl-string">"* 15 9-17 * * MON-FRI"</span>));</pre>

<p>The other out-of-the-box implementation is a <code class="literal">PeriodicTrigger</code> that accepts a fixed
period, an optional initial delay value, and a boolean to indicate whether the period
should be interpreted as a fixed-rate or a fixed-delay. Since the <code class="literal">TaskScheduler</code>
interface already defines methods for scheduling tasks at a fixed-rate or with a
fixed-delay, those methods should be used directly whenever possible. The value of the
<code class="literal">PeriodicTrigger</code> implementation is that it can be used within components that rely on
the <code class="literal">Trigger</code> abstraction. For example, it may be convenient to allow periodic triggers,
cron-based triggers, and even custom trigger implementations to be used interchangeably.
Such a component could take advantage of dependency injection so that such <code class="literal">Triggers</code>
could be configured externally.</p>
</div>
<div class="section" title="27.3.3&nbsp;TaskScheduler implementations"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-task-scheduler-implementations"></a>27.3.3&nbsp;TaskScheduler implementations</h3></div></div></div>

<p>As with Spring&#8217;s <code class="literal">TaskExecutor</code> abstraction, the primary benefit of the <code class="literal">TaskScheduler</code>
is that code relying on scheduling behavior need not be coupled to a particular
scheduler implementation. The flexibility this provides is particularly relevant when
running within Application Server environments where threads should not be created
directly by the application itself. For such cases, Spring provides a
<code class="literal">TimerManagerTaskScheduler</code> that delegates to a CommonJ TimerManager instance, typically
configured with a JNDI-lookup.</p>
<p>A simpler alternative, the <code class="literal">ThreadPoolTaskScheduler</code>, can be used whenever external
thread management is not a requirement. Internally, it delegates to a
<code class="literal">ScheduledExecutorService</code> instance. <code class="literal">ThreadPoolTaskScheduler</code> actually implements
Spring&#8217;s <code class="literal">TaskExecutor</code> interface as well, so that a single instance can be used for
asynchronous execution <span class="emphasis"><em>as soon as possible</em></span> as well as scheduled, and potentially
recurring, executions.</p>
</div>
</div>
<div class="section" title="27.4&nbsp;Annotation Support for Scheduling and Asynchronous Execution"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scheduling-annotation-support"></a>27.4&nbsp;Annotation Support for Scheduling and Asynchronous Execution</h2></div></div></div>

<p>Spring provides annotation support for both task scheduling and asynchronous method
execution.</p>
<div class="section" title="27.4.1&nbsp;Enable scheduling annotations"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-enable-annotation-support"></a>27.4.1&nbsp;Enable scheduling annotations</h3></div></div></div>

<p>To enable support for <code class="literal">@Scheduled</code> and <code class="literal">@Async</code> annotations add <code class="literal">@EnableScheduling</code> and
<code class="literal">@EnableAsync</code> to one of your <code class="literal">@Configuration</code> classes:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableAsync</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableScheduling</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {
}</pre>

<p>You are free to pick and choose the relevant annotations for your application. For
example, if you only need support for <code class="literal">@Scheduled</code>, simply omit <code class="literal">@EnableAsync</code>. For more
fine-grained control you can additionally implement the <code class="literal">SchedulingConfigurer</code> and/or
<code class="literal">AsyncConfigurer</code> interfaces. See the Javadoc for full details.</p>
<p>If you prefer XML configuration use the <code class="literal">&lt;task:annotation-driven&gt;</code> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;task:annotation-driven</span> <span class="hl-attribute">executor</span>=<span class="hl-value">"myExecutor"</span> <span class="hl-attribute">scheduler</span>=<span class="hl-value">"myScheduler"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExecutor"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;task:scheduler</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myScheduler"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span></pre>

<p>Notice with the above XML that an executor reference is provided for handling those
tasks that correspond to methods with the <code class="literal">@Async</code> annotation, and the scheduler
reference is provided for managing those methods annotated with <code class="literal">@Scheduled</code>.</p>
</div>
<div class="section" title="27.4.2&nbsp;The @Scheduled Annotation"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-annotation-support-scheduled"></a>27.4.2&nbsp;The @Scheduled Annotation</h3></div></div></div>

<p>The @Scheduled annotation can be added to a method along with trigger metadata. For
example, the following method would be invoked every 5 seconds with a fixed delay,
meaning that the period will be measured from the completion time of each preceding
invocation.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Scheduled(fixedDelay=5000)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doSomething() {
    <span class="hl-comment">// something that should execute periodically</span>
}</pre>

<p>If a fixed rate execution is desired, simply change the property name specified within
the annotation. The following would be executed every 5 seconds measured between the
successive start times of each invocation.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Scheduled(fixedRate=5000)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doSomething() {
    <span class="hl-comment">// something that should execute periodically</span>
}</pre>

<p>For fixed-delay and fixed-rate tasks, an initial delay may be specified indicating the
number of milliseconds to wait before the first execution of the method.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Scheduled(initialDelay=1000, fixedRate=5000)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doSomething() {
    <span class="hl-comment">// something that should execute periodically</span>
}</pre>

<p>If simple periodic scheduling is not expressive enough, then a cron expression may be
provided. For example, the following will only execute on weekdays.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Scheduled(cron="*/5 * * * * MON-FRI")</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doSomething() {
    <span class="hl-comment">// something that should execute on weekdays only</span>
}</pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>You can additionally use the <code class="literal">zone</code> attribute to specify the time zone in which the cron
expression will be resolved.</p>
</td></tr></table></div>

<p>Notice that the methods to be scheduled must have void returns and must not expect any
arguments. If the method needs to interact with other objects from the Application
Context, then those would typically have been provided through dependency injection.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Make sure that you are not initializing multiple instances of the same @Scheduled
annotation class at runtime, unless you do want to schedule callbacks to each such
instance. Related to this, make sure that you do not use @Configurable on bean classes
which are annotated with @Scheduled and registered as regular Spring beans with the
container: You would get double initialization otherwise, once through the container and
once through the @Configurable aspect, with the consequence of each @Scheduled method
being invoked twice.</p>
</td></tr></table></div>

</div>
<div class="section" title="27.4.3&nbsp;The @Async Annotation"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-annotation-support-async"></a>27.4.3&nbsp;The @Async Annotation</h3></div></div></div>

<p>The <code class="literal">@Async</code> annotation can be provided on a method so that invocation of that method
will occur asynchronously. In other words, the caller will return immediately upon
invocation and the actual execution of the method will occur in a task that has been
submitted to a Spring <code class="literal">TaskExecutor</code>. In the simplest case, the annotation may be
applied to a <code class="literal">void</code>-returning method.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Async</span></i>
<span class="hl-keyword">void</span> doSomething() {
    <span class="hl-comment">// this will be executed asynchronously</span>
}</pre>

<p>Unlike the methods annotated with the <code class="literal">@Scheduled</code> annotation, these methods can expect
arguments, because they will be invoked in the "normal" way by callers at runtime rather
than from a scheduled task being managed by the container. For example, the following is
a legitimate application of the <code class="literal">@Async</code> annotation.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Async</span></i>
<span class="hl-keyword">void</span> doSomething(String s) {
    <span class="hl-comment">// this will be executed asynchronously</span>
}</pre>

<p>Even methods that return a value can be invoked asynchronously. However, such methods
are required to have a <code class="literal">Future</code> typed return value. This still provides the benefit of
asynchronous execution so that the caller can perform other tasks prior to calling
<code class="literal">get()</code> on that Future.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Async</span></i>
Future&lt;String&gt; returnSomething(<span class="hl-keyword">int</span> i) {
    <span class="hl-comment">// this will be executed asynchronously</span>
}</pre>

<p><code class="literal">@Async</code> can not be used in conjunction with lifecycle callbacks such as
<code class="literal">@PostConstruct</code>. To asynchronously initialize Spring beans you currently have to use a
separate initializing Spring bean that invokes the <code class="literal">@Async</code> annotated method on the
target then.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SampleBeanImpl <span class="hl-keyword">implements</span> SampleBean {

    <i><span class="hl-annotation" style="color: gray">@Async</span></i>
    <span class="hl-keyword">void</span> doSomething() {
        <span class="hl-comment">// ...</span>
    }

}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SampleBeanInititalizer {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> SampleBean bean;

    <span class="hl-keyword">public</span> SampleBeanInitializer(SampleBean bean) {
        <span class="hl-keyword">this</span>.bean = bean;
    }

    <i><span class="hl-annotation" style="color: gray">@PostConstruct</span></i>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> initialize() {
        bean.doSomething();
    }

}</pre>

</div>
<div class="section" title="27.4.4&nbsp;Executor qualification with @Async"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-annotation-support-qualification"></a>27.4.4&nbsp;Executor qualification with @Async</h3></div></div></div>

<p>By default when specifying <code class="literal">@Async</code> on a method, the executor that will be used is the
one supplied to the <span class="emphasis"><em>annotation-driven</em></span> element as described above. However, the <code class="literal">value</code>
attribute of the <code class="literal">@Async</code> annotation can be used when needing to indicate that an
executor other than the default should be used when executing a given method.</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Async("otherExecutor")</span></i>
<span class="hl-keyword">void</span> doSomething(String s) {
    <span class="hl-comment">// this will be executed asynchronously by "otherExecutor"</span>
}</pre>

<p>In this case, "otherExecutor" may be the name of any <code class="literal">Executor</code> bean in the Spring
container, or may be the name of a <span class="emphasis"><em>qualifier</em></span> associated with any <code class="literal">Executor</code>, e.g. as
specified with the <code class="literal">&lt;qualifier&gt;</code> element or Spring&#8217;s <code class="literal">@Qualifier</code> annotation.</p>
</div>
</div>
<div class="section" title="27.5&nbsp;The Task Namespace"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scheduling-task-namespace"></a>27.5&nbsp;The Task Namespace</h2></div></div></div>

<p>Beginning with Spring 3.0, there is an XML namespace for configuring <code class="literal">TaskExecutor</code> and
<code class="literal">TaskScheduler</code> instances. It also provides a convenient way to configure tasks to be
scheduled with a trigger.</p>
<div class="section" title="27.5.1&nbsp;The scheduler element"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-task-namespace-scheduler"></a>27.5.1&nbsp;The <span class="emphasis"><em>scheduler</em></span> element</h3></div></div></div>

<p>The following element will create a <code class="literal">ThreadPoolTaskScheduler</code> instance with the
specified thread pool size.</p>
<pre class="programlisting"><span class="hl-tag">&lt;task:scheduler</span> <span class="hl-attribute">id</span>=<span class="hl-value">"scheduler"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span></pre>

<p>The value provided for the <span class="emphasis"><em>id</em></span> attribute will be used as the prefix for thread names
within the pool. The <span class="emphasis"><em>scheduler</em></span> element is relatively straightforward. If you do not
provide a <span class="emphasis"><em>pool-size</em></span> attribute, the default thread pool will only have a single thread.
There are no other configuration options for the scheduler.</p>
</div>
<div class="section" title="27.5.2&nbsp;The executor element"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-task-namespace-executor"></a>27.5.2&nbsp;The <span class="emphasis"><em>executor</em></span> element</h3></div></div></div>

<p>The following will create a <code class="literal">ThreadPoolTaskExecutor</code> instance:</p>
<pre class="programlisting"><span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executor"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span></pre>

<p>As with the scheduler above, the value provided for the <span class="emphasis"><em>id</em></span> attribute will be used as
the prefix for thread names within the pool. As far as the pool size is concerned, the
<span class="emphasis"><em>executor</em></span> element supports more configuration options than the <span class="emphasis"><em>scheduler</em></span> element. For
one thing, the thread pool for a <code class="literal">ThreadPoolTaskExecutor</code> is itself more configurable.
Rather than just a single size, an executor&#8217;s thread pool may have different values for
the <span class="emphasis"><em>core</em></span> and the <span class="emphasis"><em>max</em></span> size. If a single value is provided then the executor will
have a fixed-size thread pool (the core and max sizes are the same). However, the
<span class="emphasis"><em>executor</em></span> element&#8217;s <span class="emphasis"><em>pool-size</em></span> attribute also accepts a range in the form of "min-max".</p>
<pre class="programlisting"><span class="hl-tag">&lt;task:executor</span>
        <span class="hl-attribute">id</span>=<span class="hl-value">"executorWithPoolSizeRange"</span>
        <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5-25"</span>
        <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span></pre>

<p>As you can see from that configuration, a <span class="emphasis"><em>queue-capacity</em></span> value has also been provided.
The configuration of the thread pool should also be considered in light of the
executor&#8217;s queue capacity. For the full description of the relationship between pool
size and queue capacity, consult the documentation for
<a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ThreadPoolExecutor.html" target="_top">ThreadPoolExecutor</a>.
The main idea is that when a task is submitted, the executor will first try to use a
free thread if the number of active threads is currently less than the core size. If the
core size has been reached, then the task will be added to the queue as long as its
capacity has not yet been reached. Only then, if the queue&#8217;s capacity <span class="emphasis"><em>has</em></span> been
reached, will the executor create a new thread beyond the core size. If the max size has
also been reached, then the executor will reject the task.</p>
<p>By default, the queue is <span class="emphasis"><em>unbounded</em></span>, but this is rarely the desired configuration,
because it can lead to <code class="literal">OutOfMemoryErrors</code> if enough tasks are added to that queue while
all pool threads are busy. Furthermore, if the queue is unbounded, then the max size has
no effect at all. Since the executor will always try the queue before creating a new
thread beyond the core size, a queue must have a finite capacity for the thread pool to
grow beyond the core size (this is why a <span class="emphasis"><em>fixed size</em></span> pool is the only sensible case
when using an unbounded queue).</p>
<p>In a moment, we will review the effects of the keep-alive setting which adds yet another
factor to consider when providing a pool size configuration. First, let&#8217;s consider the
case, as mentioned above, when a task is rejected. By default, when a task is rejected,
a thread pool executor will throw a <code class="literal">TaskRejectedException</code>. However, the rejection
policy is actually configurable. The exception is thrown when using the default
rejection policy which is the <code class="literal">AbortPolicy</code> implementation. For applications where some
tasks can be skipped under heavy load, either the <code class="literal">DiscardPolicy</code> or
<code class="literal">DiscardOldestPolicy</code> may be configured instead. Another option that works well for
applications that need to throttle the submitted tasks under heavy load is the
<code class="literal">CallerRunsPolicy</code>. Instead of throwing an exception or discarding tasks, that policy
will simply force the thread that is calling the submit method to run the task itself.
The idea is that such a caller will be busy while running that task and not able to
submit other tasks immediately. Therefore it provides a simple way to throttle the
incoming load while maintaining the limits of the thread pool and queue. Typically this
allows the executor to "catch up" on the tasks it is handling and thereby frees up some
capacity on the queue, in the pool, or both. Any of these options can be chosen from an
enumeration of values available for the <span class="emphasis"><em>rejection-policy</em></span> attribute on the <span class="emphasis"><em>executor</em></span>
element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;task:executor</span>
        <span class="hl-attribute">id</span>=<span class="hl-value">"executorWithCallerRunsPolicy"</span>
        <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5-25"</span>
        <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"100"</span>
        <span class="hl-attribute">rejection-policy</span>=<span class="hl-value">"CALLER_RUNS"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="27.5.3&nbsp;The scheduled-tasks element"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-task-namespace-scheduled-tasks"></a>27.5.3&nbsp;The <span class="emphasis"><em>scheduled-tasks</em></span> element</h3></div></div></div>

<p>The most powerful feature of Spring&#8217;s task namespace is the support for configuring
tasks to be scheduled within a Spring Application Context. This follows an approach
similar to other "method-invokers" in Spring, such as that provided by the JMS namespace
for configuring Message-driven POJOs. Basically a "ref" attribute can point to any
Spring-managed object, and the "method" attribute provides the name of a method to be
invoked on that object. Here is a simple example.</p>
<pre class="programlisting"><span class="hl-tag">&lt;task:scheduled-tasks</span> <span class="hl-attribute">scheduler</span>=<span class="hl-value">"myScheduler"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;task:scheduled</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanA"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"methodA"</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/task:scheduled-tasks&gt;</span>

<span class="hl-tag">&lt;task:scheduler</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myScheduler"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span></pre>

<p>As you can see, the scheduler is referenced by the outer element, and each individual
task includes the configuration of its trigger metadata. In the preceding example, that
metadata defines a periodic trigger with a fixed delay indicating the number of
milliseconds to wait after each task execution has completed. Another option is
<span class="emphasis"><em>fixed-rate</em></span>, indicating how often the method should be executed regardless of how long
any previous execution takes. Additionally, for both fixed-delay and fixed-rate tasks an
<span class="emphasis"><em>initial-delay</em></span> parameter may be specified indicating the number of milliseconds to wait
before the first execution of the method. For more control, a "cron" attribute may be
provided instead. Here is an example demonstrating these other options.</p>
<pre class="programlisting"><span class="hl-tag">&lt;task:scheduled-tasks</span> <span class="hl-attribute">scheduler</span>=<span class="hl-value">"myScheduler"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;task:scheduled</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanA"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"methodA"</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"5000"</span> <span class="hl-attribute">initial-delay</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;task:scheduled</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanB"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"methodB"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;task:scheduled</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"beanC"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"methodC"</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"*/5 * * * * MON-FRI"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/task:scheduled-tasks&gt;</span>

<span class="hl-tag">&lt;task:scheduler</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myScheduler"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span></pre>

</div>
</div>
<div class="section" title="27.6&nbsp;Using the Quartz Scheduler"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scheduling-quartz"></a>27.6&nbsp;Using the Quartz Scheduler</h2></div></div></div>

<p>Quartz uses <code class="literal">Trigger</code>, <code class="literal">Job</code> and <code class="literal">JobDetail</code> objects to realize scheduling of all kinds
of jobs. For the basic concepts behind Quartz, have a look at
<a class="ulink" href="http://quartz-scheduler.org" target="_top">http://quartz-scheduler.org</a>. For convenience purposes, Spring offers a couple of
classes that simplify the usage of Quartz within Spring-based applications.</p>
<div class="section" title="27.6.1&nbsp;Using the JobDetailBean"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-quartz-jobdetail"></a>27.6.1&nbsp;Using the JobDetailBean</h3></div></div></div>

<p><code class="literal">JobDetail</code> objects contain all information needed to run a job. The Spring Framework
provides a <code class="literal">JobDetailBean</code> that makes the <code class="literal">JobDetail</code> more of an actual JavaBean with
sensible defaults. Let&#8217;s have a look at an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"exampleJob"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.quartz.JobDetailBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jobClass"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"example.ExampleJob"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jobDataAsMap"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The job detail bean has all information it needs to run the job ( <code class="literal">ExampleJob</code>). The
timeout is specified in the job data map. The job data map is available through the
<code class="literal">JobExecutionContext</code> (passed to you at execution time), but the <code class="literal">JobDetailBean</code> also
maps the properties from the job data map to properties of the actual job. So in this
case, if the <code class="literal">ExampleJob</code> contains a property named <code class="literal">timeout</code>, the <code class="literal">JobDetailBean</code> will
automatically apply it:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> example;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleJob <span class="hl-keyword">extends</span> QuartzJobBean {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> timeout;

    <b class="hl-tag" style="color: blue">/**
     * Setter called after the ExampleJob is instantiated
     * with the value from the JobDetailBean (5)
     */</b>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTimeout(<span class="hl-keyword">int</span> timeout) {
        <span class="hl-keyword">this</span>.timeout = timeout;
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> executeInternal(JobExecutionContext ctx) <span class="hl-keyword">throws</span> JobExecutionException {
        <span class="hl-comment">// do the actual work</span>
    }

}</pre>

<p>All additional settings from the job detail bean are of course available to you as well.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using the <code class="literal">name</code> and <code class="literal">group</code> properties, you can modify the name and the group
of the job, respectively. By default, the name of the job matches the bean name of the
job detail bean (in the example above, this is <code class="literal">exampleJob</code>).</p>
</td></tr></table></div>

</div>
<div class="section" title="27.6.2&nbsp;Using the MethodInvokingJobDetailFactoryBean"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-quartz-method-invoking-job"></a>27.6.2&nbsp;Using the MethodInvokingJobDetailFactoryBean</h3></div></div></div>

<p>Often you just need to invoke a method on a specific object. Using the
<code class="literal">MethodInvokingJobDetailFactoryBean</code> you can do exactly this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jobDetail"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetObject"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleBusinessObject"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetMethod"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"doIt"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above example will result in the <code class="literal">doIt</code> method being called on the
<code class="literal">exampleBusinessObject</code> method (see below):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleBusinessObject {

    <span class="hl-comment">// properties and collaborators</span>

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doIt() {
        <span class="hl-comment">// do the actual work</span>
    }
}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleBusinessObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"examples.ExampleBusinessObject"</span><span class="hl-tag">/&gt;</span></pre>

<p>Using the <code class="literal">MethodInvokingJobDetailFactoryBean</code>, you don&#8217;t need to create one-line jobs
that just invoke a method, and you only need to create the actual business object and
wire up the detail object.</p>
<p>By default, Quartz Jobs are stateless, resulting in the possibility of jobs interfering
with each other. If you specify two triggers for the same <code class="literal">JobDetail</code>, it might be
possible that before the first job has finished, the second one will start. If
<code class="literal">JobDetail</code> classes implement the <code class="literal">Stateful</code> interface, this won&#8217;t happen. The second
job will not start before the first one has finished. To make jobs resulting from the
<code class="literal">MethodInvokingJobDetailFactoryBean</code> non-concurrent, set the <code class="literal">concurrent</code> flag to
<code class="literal">false</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jobDetail"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetObject"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleBusinessObject"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetMethod"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"doIt"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"concurrent"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By default, jobs will run in a concurrent fashion.</p>
</td></tr></table></div>

</div>
<div class="section" title="27.6.3&nbsp;Wiring up jobs using triggers and the SchedulerFactoryBean"><div class="titlepage"><div><div><h3 class="title"><a name="scheduling-quartz-cron"></a>27.6.3&nbsp;Wiring up jobs using triggers and the SchedulerFactoryBean</h3></div></div></div>

<p>We&#8217;ve created job details and jobs. We&#8217;ve also reviewed the convenience bean that allows
you to invoke a method on a specific object. Of course, we still need to schedule the
jobs themselves. This is done using triggers and a <code class="literal">SchedulerFactoryBean</code>. Several
triggers are available within Quartz and Spring offers two Quartz <code class="literal">FactoryBean</code>
implementations with convenient defaults: <code class="literal">CronTriggerFactoryBean</code> and
<code class="literal">SimpleTriggerFactoryBean</code>.</p>
<p>Triggers need to be scheduled. Spring offers a <code class="literal">SchedulerFactoryBean</code> that exposes
triggers to be set as properties. <code class="literal">SchedulerFactoryBean</code> schedules the actual jobs with
those triggers.</p>
<p>Find below a couple of examples:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleTrigger"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.quartz.SimpleTriggerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- see the example of method invoking job above --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jobDetail"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"jobDetail"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-comment">&lt;!-- 10 seconds --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"startDelay"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10000"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-comment">&lt;!-- repeat every 50 seconds --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"repeatInterval"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"50000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cronTrigger"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.quartz.CronTriggerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jobDetail"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleJob"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-comment">&lt;!-- run every morning at 6 AM --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cronExpression"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0 0 6 * * ?"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Now we&#8217;ve set up two triggers, one running every 50 seconds with a starting delay of 10
seconds and one every morning at 6 AM. To finalize everything, we need to set up the
<code class="literal">SchedulerFactoryBean</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"triggers"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"cronTrigger"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"simpleTrigger"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>More properties are available for the <code class="literal">SchedulerFactoryBean</code> for you to set, such as the
calendars used by the job details, properties to customize Quartz with, etc. Have a look
at the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/scheduling/quartz/SchedulerFactoryBean.html" target="_top"><code class="literal">SchedulerFactoryBean
Javadoc</code></a> for more information.</p>
</div>
</div>
</div>
<div class="chapter" title="28.&nbsp;Dynamic language support"><div class="titlepage"><div><div><h2 class="title"><a name="dynamic-language"></a>28.&nbsp;Dynamic language support</h2></div></div></div>

<div class="section" title="28.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dynamic-language-introduction"></a>28.1&nbsp;Introduction</h2></div></div></div>

<p>Spring 2.0 introduces comprehensive support for using classes and objects that have been
defined using a dynamic language (such as JRuby) with Spring. This support allows you to
write any number of classes in a supported dynamic language, and have the Spring
container transparently instantiate, configure and dependency inject the resulting
objects.</p>
<p>The dynamic languages currently supported are:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
JRuby 1.5+
</li><li class="listitem">
Groovy 1.8+
</li><li class="listitem">
BeanShell 2.0
</li></ul></div>

<div class="sidebar" title="Why only these languages?"><p class="title"><b>Why only these languages?</b></p>

<p>The supported languages were chosen because <span class="emphasis"><em>a)</em></span> the languages have a lot of traction in
the Java enterprise community, <span class="emphasis"><em>b)</em></span> no requests were made for other languages at the time
that this support was added, and <span class="emphasis"><em>c)</em></span> the Spring developers were most familiar with
them.</p>
<p>There is nothing stopping the inclusion of further languages though. If you want to see
support for &lt;<span class="emphasis"><em>insert your favourite dynamic language here</em></span>&gt;, you can always raise an
issue on Spring&#8217;s
<a class="ulink" href="http://opensource.atlassian.com/projects/spring/secure/Dashboard.jspa" target="_top">JIRA</a> page (or
implement such support yourself).</p>
</div>

<p>Fully working examples of where this dynamic language support can be immediately useful
are described in <a class="xref" href="#dynamic-language-scenarios" title="28.4&nbsp;Scenarios">Section&nbsp;28.4, &#8220;Scenarios&#8221;</a>.</p>
</div>
<div class="section" title="28.2&nbsp;A first example"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dynamic-language-a-first-example"></a>28.2&nbsp;A first example</h2></div></div></div>

<p>This bulk of this chapter is concerned with describing the dynamic language support in
detail. Before diving into all of the ins and outs of the dynamic language support,
let&#8217;s look at a quick example of a bean defined in a dynamic language. The dynamic
language for this first bean is Groovy (the basis of this example was taken from the
Spring test suite, so if you want to see equivalent examples in any of the other
supported languages, take a look at the source code).</p>
<p>Find below the <code class="literal">Messenger</code> interface that the Groovy bean is going to be implementing,
and note that this interface is defined in plain Java. Dependent objects that are
injected with a reference to the <code class="literal">Messenger</code> won&#8217;t know that the underlying
implementation is a Groovy script.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.scripting;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Messenger {

    String getMessage();

}</pre>

<p>Here is the definition of a class that has a dependency on the <code class="literal">Messenger</code> interface.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.scripting;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultBookingService <span class="hl-keyword">implements</span> BookingService {

    <span class="hl-keyword">private</span> Messenger messenger;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMessenger(Messenger messenger) {
        <span class="hl-keyword">this</span>.messenger = messenger;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> processBooking() {
        <span class="hl-comment">// use the injected Messenger object...</span>
    }

}</pre>

<p>Here is an implementation of the <code class="literal">Messenger</code> interface in Groovy.</p>
<pre class="programlisting"><span class="hl-comment">// from the file </span><span class="emphasis"><em>Messenger.groovy</em></span>
<span class="hl-keyword">package</span> org.springframework.scripting.groovy;

<span class="hl-comment">// import the Messenger interface (written in Java) that is to be implemented</span>
<span class="hl-keyword">import</span> org.springframework.scripting.Messenger

<span class="hl-comment">// define the implementation in Groovy</span>
<span class="hl-keyword">class</span> GroovyMessenger <span class="hl-keyword">implements</span> Messenger {

    String message

}</pre>

<p>Finally, here are the bean definitions that will effect the injection of the
Groovy-defined <code class="literal">Messenger</code> implementation into an instance of the
<code class="literal">DefaultBookingService</code> class.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>To use the custom dynamic language tags to define dynamic-language-backed beans, you
need to have the XML Schema preamble at the top of your Spring XML configuration file.
You also need to be using a Spring <code class="literal">ApplicationContext</code> implementation as your IoC
container. Using the dynamic-language-backed beans with a plain <code class="literal">BeanFactory</code>
implementation is supported, but you have to manage the plumbing of the Spring internals
to do so.</p>
<p>For more information on schema-based configuration, see <a class="xref" href="#xsd-config" title="33.&nbsp;XML Schema-based configuration">Chapter&nbsp;33, <i>XML Schema-based configuration</i></a>.</p>
</td></tr></table></div>

<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span> <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:lang</span>=<span class="hl-value">"http://www.springframework.org/schema/lang"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- this is the bean definition for the Groovy-backed Messenger implementation --&gt;</span>
    <span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messenger"</span> <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:Messenger.groovy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"message"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"I Can Do The Frug"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/lang:groovy&gt;</span>

    <span class="hl-comment">&lt;!-- an otherwise normal bean that will be injected by the Groovy-backed Messenger --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bookingService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.DefaultBookingService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messenger"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messenger"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The <code class="literal">bookingService</code> bean (a <code class="literal">DefaultBookingService</code>) can now use its private
<code class="literal">messenger</code> member variable as normal because the <code class="literal">Messenger</code> instance that was injected
into it <span class="emphasis"><em>is</em></span> a <code class="literal">Messenger</code> instance. There is nothing special going on here, just
plain Java and plain Groovy.</p>
<p>Hopefully the above XML snippet is self-explanatory, but don&#8217;t worry unduly if it isn&#8217;t.
Keep reading for the in-depth detail on the whys and wherefores of the above
configuration.</p>
</div>
<div class="section" title="28.3&nbsp;Defining beans that are backed by dynamic languages"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dynamic-language-beans"></a>28.3&nbsp;Defining beans that are backed by dynamic languages</h2></div></div></div>

<p>This section describes exactly how you define Spring managed beans in any of the
supported dynamic languages.</p>
<p>Please note that this chapter does not attempt to explain the syntax and idioms of the
supported dynamic languages. For example, if you want to use Groovy to write certain of
the classes in your application, then the assumption is that you already know Groovy. If
you need further details about the dynamic languages themselves, please
consult <a class="xref" href="#dynamic-language-resources" title="28.6&nbsp;Further Resources">Section&nbsp;28.6, &#8220;Further Resources&#8221;</a> at the end of this chapter.</p>
<div class="section" title="28.3.1&nbsp;Common concepts"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-language-beans-concepts"></a>28.3.1&nbsp;Common concepts</h3></div></div></div>

<p>The steps involved in using dynamic-language-backed beans are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Write the test for the dynamic language source code (naturally)
</li><li class="listitem">
<span class="emphasis"><em>Then</em></span> write the dynamic language source code itself :)
</li><li class="listitem">
Define your dynamic-language-backed beans using the appropriate <code class="literal">&lt;lang:language/&gt;</code>
element in the XML configuration (you can of course define such beans programmatically
using the Spring API - although you will have to consult the source code for
directions on how to do this as this type of advanced configuration is not covered in
this chapter). Note this is an iterative step. You will need at least one bean
definition per dynamic language source file (although the same dynamic language source
file can of course be referenced by multiple bean definitions).
</li></ul></div>

<p>The first two steps (testing and writing your dynamic language source files) are beyond
the scope of this chapter. Refer to the language specification and / or reference manual
for your chosen dynamic language and crack on with developing your dynamic language
source files. You <span class="emphasis"><em>will</em></span> first want to read the rest of this chapter though, as
Spring&#8217;s dynamic language support does make some (small) assumptions about the contents
of your dynamic language source files.</p>
<div class="section" title="The <lang:language/&gt; element"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-language-beans-concepts-xml-language-element"></a>The &lt;lang:language/&gt; element</h4></div></div></div>

<p>The final step involves defining dynamic-language-backed bean definitions, one for each
bean that you want to configure (this is no different from normal JavaBean
configuration). However, instead of specifying the fully qualified classname of the
class that is to be instantiated and configured by the container, you use the
<code class="literal">&lt;lang:language/&gt;</code> element to define the dynamic language-backed bean.</p>
<p>Each of the supported languages has a corresponding <code class="literal">&lt;lang:language/&gt;</code> element:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">&lt;lang:jruby/&gt;</code> (JRuby)
</li><li class="listitem">
<code class="literal">&lt;lang:groovy/&gt;</code> (Groovy)
</li><li class="listitem">
<code class="literal">&lt;lang:bsh/&gt;</code> (BeanShell)
</li></ul></div>

<p>The exact attributes and child elements that are available for configuration depends on
exactly which language the bean has been defined in (the language-specific sections
below provide the full lowdown on this).</p>
</div>
<div class="section" title="Refreshable beans"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-language-refreshable-beans"></a>Refreshable beans</h4></div></div></div>

<p>One of the (if not <span class="emphasis"><em>the</em></span>) most compelling value adds of the dynamic language support
in Spring is the<span class="emphasis"><em>'refreshable bean'</em></span> feature.</p>
<p>A refreshable bean is a dynamic-language-backed bean that with a small amount of
configuration, a dynamic-language-backed bean can monitor changes in its underlying
source file resource, and then reload itself when the dynamic language source file is
changed (for example when a developer edits and saves changes to the file on the
filesystem).</p>
<p>This allows a developer to deploy any number of dynamic language source files as part of
an application, configure the Spring container to create beans backed by dynamic
language source files (using the mechanisms described in this chapter), and then later,
as requirements change or some other external factor comes into play, simply edit a
dynamic language source file and have any change they make reflected in the bean that is
backed by the changed dynamic language source file. There is no need to shut down a
running application (or redeploy in the case of a web application). The
dynamic-language-backed bean so amended will pick up the new state and logic from the
changed dynamic language source file.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please note that this feature is <span class="emphasis"><em>off</em></span> by default.</p>
</td></tr></table></div>

<p>Let&#8217;s take a look at an example to see just how easy it is to start using refreshable
beans. To <span class="emphasis"><em>turn on</em></span> the refreshable beans feature, you simply have to specify exactly
<span class="emphasis"><em>one</em></span> additional attribute on the <code class="literal">&lt;lang:language/&gt;</code> element of your bean definition.
So if we stick with <a class="link" href="#dynamic-language-a-first-example" title="28.2&nbsp;A first example">the example</a> from earlier in this
chapter, here&#8217;s what we would change in the Spring XML configuration to effect
refreshable beans:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-comment">&lt;!-- this bean is now </span><span class="emphasis"><em>refreshable</em></span> due to the presence of the <span class="emphasis"><em>refresh-check-delay</em></span> attribute --&gt;
    <span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messenger"</span>
            <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"5000"</span> <span class="hl-attribute">&lt;!--</span> <span class="hl-attribute">switches</span> <span class="hl-attribute">refreshing</span> <span class="hl-attribute">on</span> <span class="hl-attribute">with</span> <span class="hl-attribute">5</span> <span class="hl-attribute">seconds</span> <span class="hl-attribute">between</span> <span class="hl-attribute">checks</span> <span class="hl-attribute">--&gt;</span>
            <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:Messenger.groovy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"message"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"I Can Do The Frug"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/lang:groovy&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bookingService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.DefaultBookingService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messenger"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messenger"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>That really is all you have to do. The <code class="literal">'refresh-check-delay'</code> attribute defined on the
<code class="literal">'messenger'</code> bean definition is the number of milliseconds after which the bean will be
refreshed with any changes made to the underlying dynamic language source file. You can
turn off the refresh behavior by assigning a negative value to the
<code class="literal">'refresh-check-delay'</code> attribute. Remember that, by default, the refresh behavior is
disabled. If you don&#8217;t want the refresh behavior, then simply don&#8217;t define the attribute.</p>
<p>If we then run the following application we can exercise the refreshable feature; please
do excuse the <span class="emphasis"><em>'jumping-through-hoops-to-pause-the-execution'</em></span> shenanigans in this
next slice of code. The <code class="literal">System.in.read()</code> call is only there so that the execution of
the program pauses while I (the author) go off and edit the underlying dynamic language
source file so that the refresh will trigger on the dynamic-language-backed bean when
the program resumes execution.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;
<span class="hl-keyword">import</span> org.springframework.scripting.Messenger;

<span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> Boot {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(<span class="hl-keyword">final</span> String[] args) <span class="hl-keyword">throws</span> Exception {
        ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"beans.xml"</span>);
        Messenger messenger = (Messenger) ctx.getBean(<span class="hl-string">"messenger"</span>);
        System.out.println(messenger.getMessage());
        <span class="hl-comment">// pause execution while I go off and make changes to the source file...</span>
        System.in.read();
        System.out.println(messenger.getMessage());
    }
}</pre>

<p>Let&#8217;s assume then, for the purposes of this example, that all calls to the
<code class="literal">getMessage()</code> method of <code class="literal">Messenger</code> implementations have to be changed such that the
message is surrounded by quotes. Below are the changes that I (the author) make to the
<code class="literal">Messenger.groovy</code> source file when the execution of the program is paused.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.scripting

<span class="hl-keyword">class</span> GroovyMessenger <span class="hl-keyword">implements</span> Messenger {

    <span class="hl-keyword">private</span> String message = <span class="hl-string">"Bingo"</span>

    <span class="hl-keyword">public</span> String getMessage() {
        <span class="hl-comment">// change the implementation to surround the message in quotes</span>
        <span class="hl-keyword">return</span> <span class="hl-string">"</span><span class="emphasis"><em>" + this.message + "</em></span><span class="hl-string">"
</span>    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMessage(String message) {
        <span class="hl-keyword">this</span>.message = message
    }
}</pre>

<p>When the program executes, the output before the input pause will be <span class="emphasis"><em>I Can Do The
Frug</em></span>. After the change to the source file is made and saved, and the program resumes
execution, the result of calling the <code class="literal">getMessage()</code> method on the
dynamic-language-backed <code class="literal">Messenger</code> implementation will be <span class="emphasis"><em>'I Can Do The Frug'</em></span>
(notice the inclusion of the additional quotes).</p>
<p>It is important to understand that changes to a script will <span class="emphasis"><em>not</em></span> trigger a refresh if
the changes occur within the window of the <code class="literal">'refresh-check-delay'</code> value. It is equally
important to understand that changes to the script are <span class="emphasis"><em>not</em></span> actually <span class="emphasis"><em>picked up</em></span> until
a method is called on the dynamic-language-backed bean. It is only when a method is
called on a dynamic-language-backed bean that it checks to see if its underlying script
source has changed. Any exceptions relating to refreshing the script (such as
encountering a compilation error, or finding that the script file has been deleted) will
result in a <span class="emphasis"><em>fatal</em></span> exception being propagated to the calling code.</p>
<p>The refreshable bean behavior described above does <span class="emphasis"><em>not</em></span> apply to dynamic language
source files defined using the <code class="literal">&lt;lang:inline-script/&gt;</code> element notation (see
<a class="xref" href="#dynamic-language-beans-inline" title="Inline dynamic language source files">the section called &#8220;Inline dynamic language source files&#8221;</a>). Additionally, it <span class="emphasis"><em>only</em></span> applies to beans where
changes to the underlying source file can actually be detected; for example, by code
that checks the last modified date of a dynamic language source file that exists on the
filesystem.</p>
</div>
<div class="section" title="Inline dynamic language source files"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-language-beans-inline"></a>Inline dynamic language source files</h4></div></div></div>

<p>The dynamic language support can also cater for dynamic language source files that are
embedded directly in Spring bean definitions. More specifically, the
<code class="literal">&lt;lang:inline-script/&gt;</code> element allows you to define dynamic language source immediately
inside a Spring configuration file. An example will perhaps make the inline script
feature crystal clear:</p>
<pre class="programlisting"><span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messenger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;lang:inline-script&gt;</span>

package org.springframework.scripting.groovy;

import org.springframework.scripting.Messenger

class GroovyMessenger implements Messenger {
    String message
}

    <span class="hl-tag">&lt;/lang:inline-script&gt;</span>
    <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"message"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"I Can Do The Frug"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/lang:groovy&gt;</span></pre>

<p>If we put to one side the issues surrounding whether it is good practice to define
dynamic language source inside a Spring configuration file, the <code class="literal">&lt;lang:inline-script/&gt;</code>
element can be useful in some scenarios. For instance, we might want to quickly add a
Spring <code class="literal">Validator</code> implementation to a Spring MVC <code class="literal">Controller</code>. This is but a moment&#8217;s
work using inline source. (See <a class="xref" href="#dynamic-language-scenarios-validators" title="28.4.2&nbsp;Scripted Validators">Section&nbsp;28.4.2, &#8220;Scripted Validators&#8221;</a> for such an
example.)</p>
<p>Find below an example of defining the source for a JRuby-based bean directly in a Spring
XML configuration file using the <code class="literal">inline:</code> notation. (Notice the use of the &lt;
characters to denote a <code class="literal">'&lt;'</code> character. In such a case surrounding the inline source in
a <code class="literal">&lt;![CDATA[]]&gt;</code> region might be better.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;lang:jruby</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messenger"</span> <span class="hl-attribute">script-interfaces</span>=<span class="hl-value">"org.springframework.scripting.Messenger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;lang:inline-script&gt;</span>

require <span class="emphasis"><em>java</em></span>

include_class <span class="emphasis"><em>org.springframework.scripting.Messenger</em></span>

class RubyMessenger &amp;lt; Messenger

    def setMessage(message)
        @@message = message
    end

    def getMessage
        @@message
    end

end

        <span class="hl-tag">&lt;/lang:inline-script&gt;</span>
    <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"message"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Hello World!"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/lang:jruby&gt;</span></pre>

</div>
<div class="section" title="Understanding Constructor Injection in the context of dynamic-language-backed beans"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-language-beans-ctor-injection"></a>Understanding Constructor Injection in the context of dynamic-language-backed beans</h4></div></div></div>

<p>There is one <span class="emphasis"><em>very</em></span> important thing to be aware of with regard to Spring&#8217;s dynamic
language support. Namely, it is not (currently) possible to supply constructor arguments
to dynamic-language-backed beans (and hence constructor-injection is not available for
dynamic-language-backed beans). In the interests of making this special handling of
constructors and properties 100% clear, the following mixture of code and configuration
will <span class="emphasis"><em>not</em></span> work.</p>
<pre class="programlisting"><span class="hl-comment">// from the file </span><span class="emphasis"><em>Messenger.groovy</em></span>
<span class="hl-keyword">package</span> org.springframework.scripting.groovy;

<span class="hl-keyword">import</span> org.springframework.scripting.Messenger

<span class="hl-keyword">class</span> GroovyMessenger <span class="hl-keyword">implements</span> Messenger {

    GroovyMessenger() {}

    <span class="hl-comment">// this constructor is not available for Constructor Injection</span>
    GroovyMessenger(String message) {
        <span class="hl-keyword">this</span>.message = message;
    }

    String message

    String anotherMessage

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"badMessenger"</span>
    <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:Messenger.groovy"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- this next constructor argument will </span><span class="strong"><strong>not</strong></span> be injected into the GroovyMessenger --&gt;
    <span class="hl-comment">&lt;!-- in fact, this isn't even allowed according to the schema --&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"This will </span><span class="strong"><strong>not</strong></span> work" /&gt;

    <span class="hl-comment">&lt;!-- only property values are injected into the dynamic-language-backed object --&gt;</span>
    <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"anotherMessage"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Passed straight through to the dynamic-language-backed object"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;/lang&gt;</span></pre>

<p>In practice this limitation is not as significant as it first appears since setter
injection is the injection style favored by the overwhelming majority of developers
anyway (let&#8217;s leave the discussion as to whether that is a good thing to another day).</p>
</div>
</div>
<div class="section" title="28.3.2&nbsp;JRuby beans"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-language-beans-jruby"></a>28.3.2&nbsp;JRuby beans</h3></div></div></div>

<div class="sidebar" title="The JRuby library dependencies"><p class="title"><b>The JRuby library dependencies</b></p>

<p>The JRuby scripting support in Spring requires the following libraries to be on the
classpath of your application.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">jruby.jar</code>
</li></ul></div>

</div>

<p>From the JRuby homepage&#8230;</p>
<p>"<span class="emphasis"><em>JRuby is an 100% pure-Java implementation of the Ruby programming language.</em></span>"</p>
<p>In keeping with the Spring philosophy of offering choice, Spring&#8217;s dynamic language
support also supports beans defined in the JRuby language. The JRuby language is based
on the quite intuitive Ruby language, and has support for inline regular expressions,
blocks (closures), and a whole host of other features that do make solutions for some
domain problems a whole lot easier to develop.</p>
<p>The implementation of the JRuby dynamic language support in Spring is interesting in
that what happens is this: Spring creates a JDK dynamic proxy implementing all of the
interfaces that are specified in the <code class="literal">'script-interfaces'</code> attribute value of the
<code class="literal">&lt;lang:ruby&gt;</code> element (this is why you <span class="emphasis"><em>must</em></span> supply at least one interface in the
value of the attribute, and (accordingly) program to interfaces when using JRuby-backed
beans).</p>
<p>Let us look at a fully working example of using a JRuby-based bean. Here is the JRuby
implementation of the <code class="literal">Messenger</code> interface that was defined earlier in this chapter
(for your convenience it is repeated below).</p>
<pre class="programlisting">package org.springframework.scripting;

public interface Messenger {

    String getMessage();

}</pre>

<pre class="programlisting">require <span class="emphasis"><em>java</em></span>

<span class="hl-keyword">class</span> RubyMessenger
    include org.springframework.scripting.Messenger

    <span class="hl-keyword">def</span> setMessage(message)
        @@message = message
    <span class="hl-keyword">end</span>

    <span class="hl-keyword">def</span> getMessage
        @@message
    <span class="hl-keyword">end</span>
<span class="hl-keyword">end</span>

<span class="hl-comment"># this last line is not essential (but see below)</span>
RubyMessenger.new</pre>

<p>And here is the Spring XML that defines an instance of the <code class="literal">RubyMessenger</code> JRuby bean.</p>
<pre class="programlisting"><span class="hl-tag">&lt;lang:jruby</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageService"</span>
        <span class="hl-attribute">script-interfaces</span>=<span class="hl-value">"org.springframework.scripting.Messenger"</span>
        <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:RubyMessenger.rb"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"message"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Hello World!"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;/lang:jruby&gt;</span></pre>

<p>Take note of the last line of that JRuby source ( <code class="literal">'RubyMessenger.new'</code>). When using
JRuby in the context of Spring&#8217;s dynamic language support, you are encouraged to
instantiate and return a new instance of the JRuby class that you want to use as a
dynamic-language-backed bean as the result of the execution of your JRuby source. You
can achieve this by simply instantiating a new instance of your JRuby class on the last
line of the source file like so:</p>
<pre class="programlisting">require <span class="emphasis"><em>java</em></span>

include_class <span class="emphasis"><em>org.springframework.scripting.Messenger</em></span>

<span class="hl-comment"># class definition same as above...</span>

<span class="hl-comment"># instantiate and return a new instance of the RubyMessenger class</span>
RubyMessenger.new</pre>

<p>If you forget to do this, it is not the end of the world; this will however result in
Spring having to trawl (reflectively) through the type representation of your JRuby
class looking for a class to instantiate. In the grand scheme of things this will be so
fast that you&#8217;ll never notice it, but it is something that can be avoided by simply
having a line such as the one above as the last line of your JRuby script. If you don&#8217;t
supply such a line, or if Spring cannot find a JRuby class in your script to instantiate
then an opaque <code class="literal">ScriptCompilationException</code> will be thrown immediately after the source
is executed by the JRuby interpreter. The key text that identifies this as the root
cause of an exception can be found immediately below (so if your Spring container throws
the following exception when creating your dynamic-language-backed bean and the
following text is there in the corresponding stacktrace, this will hopefully allow you
to identify and then easily rectify the issue):</p>

<pre class="literallayout">org.springframework.scripting.ScriptCompilationException: Compilation of JRuby script returned ''</pre>

<p>To rectify this, simply instantiate a new instance of whichever class you want to expose
as a JRuby-dynamic-language-backed bean (as shown above). Please also note that you can
actually define as many classes and objects as you want in your JRuby script; what is
important is that the source file as a whole must return an object (for Spring to
configure).</p>
<p>See <a class="xref" href="#dynamic-language-scenarios" title="28.4&nbsp;Scenarios">Section&nbsp;28.4, &#8220;Scenarios&#8221;</a> for some scenarios where you might want to use
JRuby-based beans.</p>
</div>
<div class="section" title="28.3.3&nbsp;Groovy beans"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-language-beans-groovy"></a>28.3.3&nbsp;Groovy beans</h3></div></div></div>

<div class="sidebar" title="The Groovy library dependencies"><p class="title"><b>The Groovy library dependencies</b></p>

<p>The Groovy scripting support in Spring requires the following libraries to be on the
classpath of your application.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">groovy-1.8.jar</code>
</li><li class="listitem">
<code class="literal">asm-3.2.jar</code>
</li><li class="listitem">
<code class="literal">antlr-2.7.7.jar</code>
</li></ul></div>

</div>

<p>From the Groovy homepage&#8230;</p>
<p>"<span class="emphasis"><em>Groovy is an agile dynamic language for the Java 2 Platform that has many of the
features that people like so much in languages like Python, Ruby and Smalltalk, making
them available to Java developers using a Java-like syntax. </em></span>"</p>
<p>If you have read this chapter straight from the top, you will already have
<a class="link" href="#dynamic-language-a-first-example" title="28.2&nbsp;A first example">seen an example</a> of a Groovy-dynamic-language-backed
bean. Let&#8217;s look at another example (again using an example from the Spring test suite).</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.scripting;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Calculator {

    <span class="hl-keyword">int</span> add(<span class="hl-keyword">int</span> x, <span class="hl-keyword">int</span> y);

}</pre>

<p>Here is an implementation of the <code class="literal">Calculator</code> interface in Groovy.</p>
<pre class="programlisting">// from the file <span class="emphasis"><em>calculator.groovy</em></span>
package org.springframework.scripting.groovy

class GroovyCalculator implements Calculator {

    int add(int x, int y) {
        x + y
    }

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;--</span> <span class="hl-attribute">from</span> <span class="hl-attribute">the</span> <span class="hl-attribute">file</span> <span class="emphasis"><em>beans.xml</em></span> --&gt;
<span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"calculator"</span> <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:calculator.groovy"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Lastly, here is a small application to exercise the above configuration.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.scripting;

<span class="hl-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hl-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Main {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> Main(String[] args) {
        ApplicationContext ctx = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"beans.xml"</span>);
        Calculator calc = (Calculator) ctx.getBean(<span class="hl-string">"calculator"</span>);
        System.out.println(calc.add(<span class="hl-number">2</span>, <span class="hl-number">8</span>));
    }
}</pre>

<p>The resulting output from running the above program will be (unsurprisingly) <span class="emphasis"><em>10</em></span>.
(Exciting example, huh? Remember that the intent is to illustrate the concept. Please
consult the dynamic language showcase project for a more complex example, or indeed
<a class="xref" href="#dynamic-language-scenarios" title="28.4&nbsp;Scenarios">Section&nbsp;28.4, &#8220;Scenarios&#8221;</a> later in this chapter).</p>
<p>It is important that you <span class="emphasis"><em>do not</em></span> define more than one class per Groovy source file.
While this is perfectly legal in Groovy, it is (arguably) a bad practice: in the
interests of a consistent approach, you should (in the opinion of this author) respect
the standard Java conventions of one (public) class per source file.</p>
<div class="section" title="Customising Groovy objects via a callback"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-language-beans-groovy-customizer"></a>Customising Groovy objects via a callback</h4></div></div></div>

<p>The <code class="literal">GroovyObjectCustomizer</code> interface is a callback that allows you to hook additional
creation logic into the process of creating a Groovy-backed bean. For example,
implementations of this interface could invoke any required initialization method(s), or
set some default property values, or specify a custom <code class="literal">MetaClass</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> GroovyObjectCustomizer {

    <span class="hl-keyword">void</span> customize(GroovyObject goo);

}</pre>

<p>The Spring Framework will instantiate an instance of your Groovy-backed bean, and will
then pass the created <code class="literal">GroovyObject</code> to the specified <code class="literal">GroovyObjectCustomizer</code> if one
has been defined. You can do whatever you like with the supplied <code class="literal">GroovyObject</code>
reference: it is expected that the setting of a custom <code class="literal">MetaClass</code> is what most folks
will want to do with this callback, and you can see an example of doing that below.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> SimpleMethodTracingCustomizer <span class="hl-keyword">implements</span> GroovyObjectCustomizer {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> customize(GroovyObject goo) {
        DelegatingMetaClass metaClass = <span class="hl-keyword">new</span> DelegatingMetaClass(goo.getMetaClass()) {

            <span class="hl-keyword">public</span> Object invokeMethod(Object object, String methodName, Object[] arguments) {
                System.out.println(<span class="hl-string">"Invoking </span><span class="emphasis"><em>" + methodName + "</em></span>.<span class="hl-string">");
</span>                <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.invokeMethod(object, methodName, arguments);
            }
        };
        metaClass.initialize();
        goo.setMetaClass(metaClass);
    }

}</pre>

<p>A full discussion of meta-programming in Groovy is beyond the scope of the Spring
reference manual. Consult the relevant section of the Groovy reference manual, or do a
search online: there are plenty of articles concerning this topic. Actually making use
of a <code class="literal">GroovyObjectCustomizer</code> is easy if you are using the Spring namespace support.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- define the GroovyObjectCustomizer just like any other bean --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"tracingCustomizer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMethodTracingCustomizer"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-comment">&lt;!-- ... and plug it into the desired Groovy bean via the </span><span class="emphasis"><em>customizer-ref</em></span> attribute --&gt;
    <span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"calculator"</span>
        <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:org/springframework/scripting/groovy/Calculator.groovy"</span>
        <span class="hl-attribute">customizer-ref</span>=<span class="hl-value">"tracingCustomizer"</span><span class="hl-tag"> /&gt;</span></pre>

<p>If you are not using the Spring namespace support, you can still use the
<code class="literal">GroovyObjectCustomizer</code> functionality.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"calculator"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scripting.groovy.GroovyScriptFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:org/springframework/scripting/groovy/Calculator.groovy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-comment">&lt;!-- define the GroovyObjectCustomizer (as an inner bean) --&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"tracingCustomizer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SimpleMethodTracingCustomizer"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scripting.support.ScriptFactoryPostProcessor"</span><span class="hl-tag">/&gt;</span></pre>

</div>
</div>
<div class="section" title="28.3.4&nbsp;BeanShell beans"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-language-beans-bsh"></a>28.3.4&nbsp;BeanShell beans</h3></div></div></div>

<div class="sidebar" title="The BeanShell library dependencies"><p class="title"><b>The BeanShell library dependencies</b></p>

<p>The BeanShell scripting support in Spring requires the following libraries to be on the
classpath of your application.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">bsh-2.0b4.jar</code>
</li></ul></div>

</div>

<p>From the BeanShell homepage&#8230;</p>
<p>"<span class="emphasis"><em>BeanShell is a small, free, embeddable Java source interpreter with dynamic language
features, written in Java. BeanShell dynamically executes standard Java syntax and
extends it with common scripting conveniences such as loose types, commands, and method
closures like those in Perl and JavaScript.</em></span>"</p>
<p>In contrast to Groovy, BeanShell-backed bean definitions require some (small) additional
configuration. The implementation of the BeanShell dynamic language support in Spring is
interesting in that what happens is this: Spring creates a JDK dynamic proxy
implementing all of the interfaces that are specified in the <code class="literal">'script-interfaces'</code>
attribute value of the <code class="literal">&lt;lang:bsh&gt;</code> element (this is why you <span class="emphasis"><em>must</em></span> supply at least
one interface in the value of the attribute, and (accordingly) program to interfaces
when using BeanShell-backed beans). This means that every method call on a
BeanShell-backed object is going through the JDK dynamic proxy invocation mechanism.</p>
<p>Let&#8217;s look at a fully working example of using a BeanShell-based bean that implements
the <code class="literal">Messenger</code> interface that was defined earlier in this chapter (repeated below for
your convenience).</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.scripting;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Messenger {

    String getMessage();

}</pre>

<p>Here is the BeanShell <span class="emphasis"><em>implementation</em></span> (the term is used loosely here) of the
<code class="literal">Messenger</code> interface.</p>
<pre class="programlisting">String message;

String getMessage() {
    <span class="hl-keyword">return</span> message;
}

<span class="hl-keyword">void</span> setMessage(String aMessage) {
    message = aMessage;
}</pre>

<p>And here is the Spring XML that defines an <span class="emphasis"><em>instance</em></span> of the above <span class="emphasis"><em>class</em></span> (again, the
term is used very loosely here).</p>
<pre class="programlisting"><span class="hl-tag">&lt;lang:bsh</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageService"</span> <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:BshMessenger.bsh"</span>
    <span class="hl-attribute">script-interfaces</span>=<span class="hl-value">"org.springframework.scripting.Messenger"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"message"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Hello World!"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/lang:bsh&gt;</span></pre>

<p>See <a class="xref" href="#dynamic-language-scenarios" title="28.4&nbsp;Scenarios">Section&nbsp;28.4, &#8220;Scenarios&#8221;</a> for some scenarios where you might want to use
BeanShell-based beans.</p>
</div>
</div>
<div class="section" title="28.4&nbsp;Scenarios"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dynamic-language-scenarios"></a>28.4&nbsp;Scenarios</h2></div></div></div>

<p>The possible scenarios where defining Spring managed beans in a scripting language would
be beneficial are, of course, many and varied. This section describes two possible use
cases for the dynamic language support in Spring.</p>
<div class="section" title="28.4.1&nbsp;Scripted Spring MVC Controllers"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-language-scenarios-controllers"></a>28.4.1&nbsp;Scripted Spring MVC Controllers</h3></div></div></div>

<p>One group of classes that may benefit from using dynamic-language-backed beans is that
of Spring MVC controllers. In pure Spring MVC applications, the navigational flow
through a web application is to a large extent determined by code encapsulated within
your Spring MVC controllers. As the navigational flow and other presentation layer logic
of a web application needs to be updated to respond to support issues or changing
business requirements, it may well be easier to effect any such required changes by
editing one or more dynamic language source files and seeing those changes being
immediately reflected in the state of a running application.</p>
<p>Remember that in the lightweight architectural model espoused by projects such as
Spring, you are typically aiming to have a really <span class="emphasis"><em>thin</em></span> presentation layer, with all
the meaty business logic of an application being contained in the domain and service
layer classes. Developing Spring MVC controllers as dynamic-language-backed beans allows
you to change presentation layer logic by simply editing and saving text files; any
changes to such dynamic language source files will (depending on the configuration)
automatically be reflected in the beans that are backed by dynamic language source files.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In order to effect this automatic <span class="emphasis"><em>pickup</em></span> of any changes to dynamic-language-backed
beans, you will have had to enable the <span class="emphasis"><em>refreshable beans</em></span> functionality. See
<a class="xref" href="#dynamic-language-refreshable-beans" title="Refreshable beans">the section called &#8220;Refreshable beans&#8221;</a> for a full treatment of this feature.</p>
</td></tr></table></div>

<p>Find below an example of an <code class="literal">org.springframework.web.servlet.mvc.Controller</code> implemented
using the Groovy dynamic language.</p>
<pre class="programlisting"><span class="hl-comment">// from the file </span><span class="emphasis"><em>/WEB-INF/groovy/FortuneController.groovy</em></span>
<span class="hl-keyword">package</span> org.springframework.showcase.fortune.web

<span class="hl-keyword">import</span> org.springframework.showcase.fortune.service.FortuneService
<span class="hl-keyword">import</span> org.springframework.showcase.fortune.domain.Fortune
<span class="hl-keyword">import</span> org.springframework.web.servlet.ModelAndView
<span class="hl-keyword">import</span> org.springframework.web.servlet.mvc.Controller

<span class="hl-keyword">import</span> javax.servlet.http.HttpServletRequest
<span class="hl-keyword">import</span> javax.servlet.http.HttpServletResponse

<span class="hl-keyword">class</span> FortuneController <span class="hl-keyword">implements</span> Controller {

    <i><span class="hl-annotation" style="color: gray">@Property</span></i> FortuneService fortuneService

    ModelAndView handleRequest(HttpServletRequest request,
            HttpServletResponse httpServletResponse) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ModelAndView(<span class="hl-string">"tell"</span>, <span class="hl-string">"fortune"</span>, <span class="hl-keyword">this</span>.fortuneService.tellFortune())
    }

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fortune"</span>
        <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"3000"</span>
        <span class="hl-attribute">script-source</span>=<span class="hl-value">"/WEB-INF/groovy/FortuneController.groovy"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fortuneService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"fortuneService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/lang:groovy&gt;</span></pre>

</div>
<div class="section" title="28.4.2&nbsp;Scripted Validators"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-language-scenarios-validators"></a>28.4.2&nbsp;Scripted Validators</h3></div></div></div>

<p>Another area of application development with Spring that may benefit from the
flexibility afforded by dynamic-language-backed beans is that of validation. It <span class="emphasis"><em>may</em></span>
be easier to express complex validation logic using a loosely typed dynamic language
(that may also have support for inline regular expressions) as opposed to regular Java.</p>
<p>Again, developing validators as dynamic-language-backed beans allows you to change
validation logic by simply editing and saving a simple text file; any such changes will
(depending on the configuration) automatically be reflected in the execution of a
running application and would not require the restart of an application.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please note that in order to effect the automatic <span class="emphasis"><em>pickup</em></span> of any changes to
dynamic-language-backed beans, you will have had to enable the <span class="emphasis"><em>refreshable beans</em></span>
feature. See <a class="xref" href="#dynamic-language-refreshable-beans" title="Refreshable beans">the section called &#8220;Refreshable beans&#8221;</a> for a full and detailed treatment of
this feature.</p>
</td></tr></table></div>

<p>Find below an example of a Spring <code class="literal">org.springframework.validation.Validator</code> implemented
using the Groovy dynamic language. (See <a class="xref" href="#validator" title="6.2&nbsp;Validation using Spring&#8217;s Validator interface">Section&nbsp;6.2, &#8220;Validation using Spring&#8217;s Validator interface&#8221;</a> for a discussion of the
<code class="literal">Validator</code> interface.)</p>
<pre class="programlisting">import org.springframework.validation.Validator
import org.springframework.validation.Errors
import org.springframework.beans.TestBean

class TestBeanValidator implements Validator {

    boolean supports(Class clazz) {
        return TestBean.class.isAssignableFrom(clazz)
    }

    void validate(Object bean, Errors errors) {
        if(bean.name?.trim()?.size() &gt; 0) {
            return
        }
        errors.reject("whitespace", "Cannot be composed wholly of whitespace.")
    }

}</pre>

</div>
</div>
<div class="section" title="28.5&nbsp;Bits and bobs"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dynamic-language-final-notes"></a>28.5&nbsp;Bits and bobs</h2></div></div></div>

<p>This last section contains some bits and bobs related to the dynamic language support.</p>
<div class="section" title="28.5.1&nbsp;AOP - advising scripted beans"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-language-final-notes-aop"></a>28.5.1&nbsp;AOP - advising scripted beans</h3></div></div></div>

<p>It is possible to use the Spring AOP framework to advise scripted beans. The Spring AOP
framework actually is unaware that a bean that is being advised might be a scripted
bean, so all of the AOP use cases and functionality that you may be using or aim to use
will work with scripted beans. There is just one (small) thing that you need to be aware
of when advising scripted beans&#8230; you cannot use class-based proxies, you must
use <a class="link" href="#aop-proxying" title="8.6&nbsp;Proxying mechanisms">interface-based proxies</a>.</p>
<p>You are of course not just limited to advising scripted beans&#8230; you can also write
aspects themselves in a supported dynamic language and use such beans to advise other
Spring beans. This really would be an advanced use of the dynamic language support
though.</p>
</div>
<div class="section" title="28.5.2&nbsp;Scoping"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-language-final-notes-scopes"></a>28.5.2&nbsp;Scoping</h3></div></div></div>

<p>In case it is not immediately obvious, scripted beans can of course be scoped just like
any other bean. The <code class="literal">scope</code> attribute on the various <code class="literal">&lt;lang:language/&gt;</code> elements allows
you to control the scope of the underlying scripted bean, just as it does with a regular
bean. (The default scope is <a class="link" href="#beans-factory-scopes-singleton" title="4.5.1&nbsp;The singleton scope">singleton</a>, just as it is
with <span class="emphasis"><em>regular</em></span> beans.)</p>
<p>Find below an example of using the <code class="literal">scope</code> attribute to define a Groovy bean scoped as
a <a class="link" href="#beans-factory-scopes-prototype" title="4.5.2&nbsp;The prototype scope">prototype</a>.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span> <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:lang</span>=<span class="hl-value">"http://www.springframework.org/schema/lang"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;lang:groovy</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messenger"</span> <span class="hl-attribute">script-source</span>=<span class="hl-value">"classpath:Messenger.groovy"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;lang:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"message"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"I Can Do The RoboCop"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/lang:groovy&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bookingService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.DefaultBookingService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messenger"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messenger"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>See <a class="xref" href="#beans-factory-scopes" title="4.5&nbsp;Bean scopes">Section&nbsp;4.5, &#8220;Bean scopes&#8221;</a> in <a class="xref" href="#beans" title="4.&nbsp;The IoC container">Chapter&nbsp;4, <i>The IoC container</i></a> for a fuller discussion of the scoping support
in the Spring Framework.</p>
</div>
</div>
<div class="section" title="28.6&nbsp;Further Resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dynamic-language-resources"></a>28.6&nbsp;Further Resources</h2></div></div></div>

<p>Find below links to further resources about the various dynamic languages described in
this chapter.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <a class="ulink" href="http://jruby.codehaus.org/" target="_top">JRuby</a> homepage
</li><li class="listitem">
The <a class="ulink" href="http://groovy.codehaus.org/" target="_top">Groovy</a> homepage
</li><li class="listitem">
The <a class="ulink" href="http://www.beanshell.org/" target="_top">BeanShell</a> homepage
</li></ul></div>

<p>Some of the more active members of the Spring community have also added support for a
number of additional dynamic languages above and beyond the ones covered in this
chapter. While it is possible that such third party contributions may be added to the
list of languages supported by the main Spring distribution, your best bet for seeing if
your favourite scripting language is supported is the
<a class="ulink" href="https://springmodules.dev.java.net/" target="_top">Spring Modules project</a>.</p>
</div>
</div>
<div class="chapter" title="29.&nbsp;Cache Abstraction"><div class="titlepage"><div><div><h2 class="title"><a name="cache"></a>29.&nbsp;Cache Abstraction</h2></div></div></div>

<div class="section" title="29.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cache-introduction"></a>29.1&nbsp;Introduction</h2></div></div></div>

<p>Since version 3.1, Spring Framework provides support for transparently adding caching
into an existing Spring application. Similar to the <a class="link" href="#transaction" title="11.&nbsp;Transaction Management">transaction</a> support,
the caching abstraction allows consistent use of various caching solutions with minimal
impact on the code.</p>
</div>
<div class="section" title="29.2&nbsp;Understanding the cache abstraction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cache-strategies"></a>29.2&nbsp;Understanding the cache abstraction</h2></div></div></div>

<div class="sidebar" title="Cache vs Buffer"><p class="title"><b>Cache vs Buffer</b></p>

<p>The terms "buffer" and "cache" tend to be used interchangeably; note however they
represent different things. A buffer is used traditionally as an intermediate temporary
store for data between a fast and a slow entity. As one party would have to <span class="emphasis"><em>wait</em></span> for
the other affecting performance, the buffer alleviates this by allowing entire blocks of
data to move at once rather then in small chunks. The data is written and read only once
from the buffer. Furthermore, the buffers are <span class="emphasis"><em>visible</em></span> to at least one party which is
aware of it.</p>
<p>A cache on the other hand by definition is hidden and neither party is aware that
caching occurs.It as well improves performance but does that by allowing the same data
to be read multiple times in a fast fashion.</p>
<p>A further explanation of the differences between two can be found
<a class="ulink" href="http://en.wikipedia.org/wiki/Cache#The_difference_between_buffer_and_cache" target="_top">here</a>.</p>
</div>

<p>At its core, the abstraction applies caching to Java methods, reducing thus the number
of executions based on the information available in the cache. That is, each time a
<span class="emphasis"><em>targeted</em></span> method is invoked, the abstraction will apply a caching behavior checking
whether the method has been already executed for the given arguments. If it has, then
the cached result is returned without having to execute the actual method; if it has
not, then method is executed, the result cached and returned to the user so that, the
next time the method is invoked, the cached result is returned. This way, expensive
methods (whether CPU or IO bound) can be executed only once for a given set of
parameters and the result reused without having to actually execute the method again.
The caching logic is applied transparently without any interference to the invoker.</p>
<div class="important" title="Important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Obviously this approach works only for methods that are guaranteed to return the same
output (result) for a given input (or arguments) no matter how many times it is being
executed.</p>
</td></tr></table></div>

<p>To use the cache abstraction, the developer needs to take care of two aspects:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
caching declaration - identify the methods that need to be cached and their policy
</li><li class="listitem">
cache configuration - the backing cache where the data is stored and read from
</li></ul></div>

<p>Note that just like other services in Spring Framework, the caching service is an
abstraction (not a cache implementation) and requires the use of an actual storage to
store the cache data - that is, the abstraction frees the developer from having to write
the caching logic but does not provide the actual stores. There are two integrations
available out of the box, for JDK <code class="literal">java.util.concurrent.ConcurrentMap</code> and
<a class="ulink" href="http://ehcache.org/" target="_top">EhCache</a> - see <a class="xref" href="#cache-plug" title="29.6&nbsp;Plugging-in different back-end caches">Section&nbsp;29.6, &#8220;Plugging-in different back-end caches&#8221;</a> for more information on plugging in
other cache stores/providers.</p>
</div>
<div class="section" title="29.3&nbsp;Declarative annotation-based caching"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cache-annotations"></a>29.3&nbsp;Declarative annotation-based caching</h2></div></div></div>

<p>For caching declaration, the abstraction provides two Java annotations: <code class="literal">@Cacheable</code> and
<code class="literal">@CacheEvict</code> which allow methods to trigger cache population or cache eviction. Let us
take a closer look at each annotation:</p>
<div class="section" title="29.3.1&nbsp;@Cacheable annotation"><div class="titlepage"><div><div><h3 class="title"><a name="cache-annotations-cacheable"></a>29.3.1&nbsp;@Cacheable annotation</h3></div></div></div>

<p>As the name implies, <code class="literal">@Cacheable</code> is used to demarcate methods that are cacheable - that
is, methods for whom the result is stored into the cache so on subsequent invocations
(with the same arguments), the value in the cache is returned without having to actually
execute the method. In its simplest form, the annotation declaration requires the name
of the cache associated with the annotated method:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Cacheable("books")</span></i>
<span class="hl-keyword">public</span> Book findBook(ISBN isbn) {...}</pre>

<p>In the snippet above, the method <code class="literal">findBook</code> is associated with the cache named <code class="literal">books</code>.
Each time the method is called, the cache is checked to see whether the invocation has
been already executed and does not have to be repeated. While in most cases, only one
cache is declared, the annotation allows multiple names to be specified so that more
then one cache are being used. In this case, each of the caches will be checked before
executing the method - if at least one cache is hit, then the associated value will be
returned:</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>All the other caches that do not contain the method will be updated as well even though
the cached method was not actually executed.</p>
</td></tr></table></div>

<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Cacheable({ "books", "isbns" })</span></i>
<span class="hl-keyword">public</span> Book findBook(ISBN isbn) {...}</pre>

<div class="section" title="Default Key Generation"><div class="titlepage"><div><div><h4 class="title"><a name="cache-annotations-cacheable-default-key"></a>Default Key Generation</h4></div></div></div>

<p>Since caches are essentially key-value stores, each invocation of a cached method needs
to be translated into a suitable key for cache access. Out of the box, the caching
abstraction uses a simple <code class="literal">KeyGenerator</code> based on the following algorithm:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
If no params are given, return <code class="literal">SimpleKey.EMPTY</code>.
</li><li class="listitem">
If only one param is given, return that instance.
</li><li class="listitem">
If more the one param is given, return a <code class="literal">SimpleKey</code> containing all parameters.
</li></ul></div>

<p>This approach works well for most use-cases; As long as parameters have <span class="emphasis"><em>natural keys</em></span>
and implement valid <code class="literal">hashCode()</code> and <code class="literal">equals()</code> methods. If that is not the case the the
strategy needs to be changed.</p>
<p>To provide a different <span class="emphasis"><em>default</em></span> key generator, one needs to implement the
<code class="literal">org.springframework.cache.KeyGenerator</code> interface. Once configured, the generator will
be used for each declaration that does not specify its own key generation strategy (see
below).</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The default key generation strategy changed with the release of Spring 4.0. Earlier
versions of Spring used a key generation strategy that, for multiple key parameters,
only considered the <code class="literal">hashCode()</code> of parameters and not <code class="literal">equals()</code>; this could cause
unexpected key collisions (see <a class="ulink" href="https://jira.springsource.org/browse/SPR-10237" target="_top">SPR-10237</a>
for background). The new <span class="emphasis"><em>SimpleKeyGenerator</em></span> uses a compound key for such scenarios.</p>
<p>If you want to keep using the previous key strategy, you can configure the deprecated
<code class="literal">org.springframework.cache.interceptor.DefaultKeyGenerator</code> class or create a custom
hash-based <span class="emphasis"><em>KeyGenerator</em></span> implementation.</p>
</td></tr></table></div>

</div>
<div class="section" title="Custom Key Generation Declaration"><div class="titlepage"><div><div><h4 class="title"><a name="cache-annotations-cacheable-key"></a>Custom Key Generation Declaration</h4></div></div></div>

<p>Since caching is generic, it is quite likely the target methods have various signatures
that cannot be simply mapped on top of the cache structure. This tends to become obvious
when the target method has multiple arguments out of which only some are suitable for
caching (while the rest are used only by the method logic). For example:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Cacheable("books")</span></i>
<span class="hl-keyword">public</span> Book findBook(ISBN isbn, <span class="hl-keyword">boolean</span> checkWarehouse, <span class="hl-keyword">boolean</span> includeUsed)</pre>

<p>At first glance, while the two <code class="literal">boolean</code> arguments influence the way the book is found,
they are no use for the cache. Further more what if only one of the two is important
while the other is not?</p>
<p>For such cases, the <code class="literal">@Cacheable</code> annotation allows the user to specify how the key is
generated through its <code class="literal">key</code> attribute. The developer can use <a class="link" href="#expressions" title="7.&nbsp;Spring Expression Language (SpEL)">SpEL</a> to
pick the arguments of interest (or their nested properties), perform operations or even
invoke arbitrary methods without having to write any code or implement any interface.
This is the recommended approach over the
<a class="link" href="#cache-annotations-cacheable-default-key" title="Default Key Generation">default</a> generator since methods tend to be
quite different in signatures as the code base grows; while the default strategy might
work for some methods, it rarely does for all methods.</p>
<p>Below are some examples of various SpEL declarations - if you are not familiar with it,
do yourself a favour and read <a class="xref" href="#expressions" title="7.&nbsp;Spring Expression Language (SpEL)">Chapter&nbsp;7, <i>Spring Expression Language (SpEL)</i></a>:</p>
<pre class="programlisting">@Cacheable(value=<span class="hl-string">"books"</span>, <span class="strong"><strong>key="#isbn"</strong></span>)
<span class="hl-keyword">public</span> Book findBook(ISBN isbn, <span class="hl-keyword">boolean</span> checkWarehouse, <span class="hl-keyword">boolean</span> includeUsed)

@Cacheable(value=<span class="hl-string">"books"</span>, <span class="strong"><strong>key="#isbn.rawNumber"</strong></span>)
<span class="hl-keyword">public</span> Book findBook(ISBN isbn, <span class="hl-keyword">boolean</span> checkWarehouse, <span class="hl-keyword">boolean</span> includeUsed)

@Cacheable(value=<span class="hl-string">"books"</span>, <span class="strong"><strong>key="T(someType).hash(#isbn)"</strong></span>)
<span class="hl-keyword">public</span> Book findBook(ISBN isbn, <span class="hl-keyword">boolean</span> checkWarehouse, <span class="hl-keyword">boolean</span> includeUsed)</pre>

<p>The snippets above show how easy it is to select a certain argument, one of its
properties or even an arbitrary (static) method.</p>
</div>
<div class="section" title="Conditional caching"><div class="titlepage"><div><div><h4 class="title"><a name="cache-annotations-cacheable-condition"></a>Conditional caching</h4></div></div></div>

<p>Sometimes, a method might not be suitable for caching all the time (for example, it
might depend on the given arguments). The cache annotations support such functionality
through the <code class="literal">conditional</code> parameter which takes a <code class="literal">SpEL</code> expression that is evaluated to
either <code class="literal">true</code> or <code class="literal">false</code>. If <code class="literal">true</code>, the method is cached - if not, it behaves as if the
method is not cached, that is executed every since time no matter what values are in the
cache or what arguments are used. A quick example - the following method will be cached
only if the argument <code class="literal">name</code> has a length shorter than 32:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Cacheable(value="book", condition="#name.length &lt; 32")</span></i>
<span class="hl-keyword">public</span> Book findBook(String name)</pre>

<p>In addition the <code class="literal">conditional</code> parameter, the <code class="literal">unless</code> parameter can be used to veto the
adding of a value to the cache. Unlike <code class="literal">conditional</code>, <code class="literal">unless</code> expressions are evaluated
<span class="emphasis"><em>after</em></span> the method has been called. Expanding on the previous example - perhaps we
only want to cache paperback books:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Cacheable(value="book", condition="#name.length &lt; 32", unless="#result.hardback")</span></i>
<span class="hl-keyword">public</span> Book findBook(String name)</pre>

</div>
<div class="section" title="Available caching SpEL evaluation context"><div class="titlepage"><div><div><h4 class="title"><a name="cache-spel-context"></a>Available caching SpEL evaluation context</h4></div></div></div>

<p>Each <code class="literal">SpEL</code> expression evaluates again a dedicated
<a class="link" href="#expressions-language-ref" title="7.5&nbsp;Language Reference"><code class="literal">context</code></a>. In addition to the build in parameters, the
framework provides dedicated caching related metadata such as the argument names. The
next table lists the items made available to the context so one can use them for key and
conditional (see next section) computations:</p>
<div class="table"><a name="cache-spel-context-tbl"></a><p class="title"><b>Table&nbsp;29.1.&nbsp;Cache SpEL available metadata</b></p><div class="table-contents">

  <table summary="Cache SpEL available metadata" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Location</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Example</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>methodName</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>root object</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the method being invoked</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">#root.methodName</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>root object</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The method being invoked</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">#root.method.name</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>target</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>root object</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The target object being invoked</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">#root.target</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>targetClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>root object</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The class of the target being invoked</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">#root.targetClass</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>args</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>root object</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The arguments (as array) used for invoking the target</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">#root.args[0]</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>caches</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>root object</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Collection of caches against which the current method is executed</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">#root.caches[0].name</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="emphasis"><em>argument name</em></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluation context</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of any of the method argument. If for some reason the names are not available
  (ex: no debug information), the argument names are also available under the <code class="literal">a&lt;#arg&gt;</code>
  where <span class="emphasis"><em>#arg</em></span> stands for the argument index (starting from 0).</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">iban</code> or <code class="literal">a0</code> (one can also use <code class="literal">p0</code> or <code class="literal">p&lt;#arg&gt;</code> notation as an alias).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>result</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>evaluation context</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>The result of the method call (the value to be cached). Only available in ' <code class="literal">unless</code>'
  expressions and ' <code class="literal">cache evict</code>' expression (when <code class="literal">beforeInvocation</code> is <code class="literal">false</code>).</p></td><td style="" align="left" valign="top"><p><code class="literal">#result</code></p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
</div>
<div class="section" title="29.3.2&nbsp;@CachePut annotation"><div class="titlepage"><div><div><h3 class="title"><a name="cache-annotations-put"></a>29.3.2&nbsp;@CachePut annotation</h3></div></div></div>

<p>For cases where the cache needs to be updated without interfering with the method
execution, one can use the <code class="literal">@CachePut</code> annotation. That is, the method will always be
executed and its result placed into the cache (according to the <code class="literal">@CachePut</code> options). It
supports the same options as <code class="literal">@Cacheable</code> and should be used for cache population rather
then method flow optimization.</p>
<p>Note that using <code class="literal">@CachePut</code> and <code class="literal">@Cacheable</code> annotations on the same method is generally
discouraged because they have different behaviors. While the latter causes the method
execution to be skipped by using the cache, the former forces the execution in order to
execute a cache update. This leads to unexpected behavior and with the exception of
specific corner-cases (such as annotations having conditions that exclude them from each
other), such declarations should be avoided.</p>
</div>
<div class="section" title="29.3.3&nbsp;@CacheEvict annotation"><div class="titlepage"><div><div><h3 class="title"><a name="cache-annotations-evict"></a>29.3.3&nbsp;@CacheEvict annotation</h3></div></div></div>

<p>The cache abstraction allows not just population of a cache store but also eviction.
This process is useful for removing stale or unused data from the cache. Opposed to
<code class="literal">@Cacheable</code>, annotation <code class="literal">@CacheEvict</code> demarcates methods that perform cache
<span class="emphasis"><em>eviction</em></span>, that is methods that act as triggers for removing data from the cache.
Just like its sibling, <code class="literal">@CacheEvict</code> requires specifying one (or multiple) caches
that are affected by the action, allows a key or a condition to be specified but in
addition, features an extra parameter <code class="literal">allEntries</code> which indicates whether a cache-wide
eviction needs to be performed rather then just an entry one (based on the key):</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@CacheEvict(value = "books", allEntries=true)</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> loadBooks(InputStream batch)</pre>

<p>This option comes in handy when an entire cache region needs to be cleared out - rather
then evicting each entry (which would take a long time since it is inefficient), all the
entires are removed in one operation as shown above. Note that the framework will ignore
any key specified in this scenario as it does not apply (the entire cache is evicted not
just one entry).</p>
<p>One can also indicate whether the eviction should occur after (the default) or before
the method executes through the <code class="literal">beforeInvocation</code> attribute. The former provides the
same semantics as the rest of the annotations - once the method completes successfully,
an action (in this case eviction) on the cache is executed. If the method does not
execute (as it might be cached) or an exception is thrown, the eviction does not occur.
The latter ( <code class="literal">beforeInvocation=true</code>) causes the eviction to occur always, before the
method is invoked - this is useful in cases where the eviction does not need to be tied
to the method outcome.</p>
<p>It is important to note that void methods can be used with <code class="literal">@CacheEvict</code> - as the
methods act as triggers, the return values are ignored (as they don&#8217;t interact with the
cache) - this is not the case with <code class="literal">@Cacheable</code> which adds/updates data into the cache
and thus requires a result.</p>
</div>
<div class="section" title="29.3.4&nbsp;@Caching annotation"><div class="titlepage"><div><div><h3 class="title"><a name="cache-annotations-caching"></a>29.3.4&nbsp;@Caching annotation</h3></div></div></div>

<p>There are cases when multiple annotations of the same type, such as <code class="literal">@CacheEvict</code> or
<code class="literal">@CachePut</code> need to be specified, for example because the condition or the key
expression is different between different caches. Unfortunately Java does not support
such declarations however there is a workaround - using an <span class="emphasis"><em>enclosing</em></span> annotation, in
this case, <code class="literal">@Caching</code>. <code class="literal">@Caching</code> allows multiple nested <code class="literal">@Cacheable</code>, <code class="literal">@CachePut</code> and
<code class="literal">@CacheEvict</code> to be used on the same method:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Caching(evict = { @CacheEvict("primary"), @CacheEvict(value = "secondary", key = "#p0") })</span></i>
<span class="hl-keyword">public</span> Book importBooks(String deposit, Date date)</pre>

</div>
<div class="section" title="29.3.5&nbsp;Enable caching annotations"><div class="titlepage"><div><div><h3 class="title"><a name="cache-annotation-enable"></a>29.3.5&nbsp;Enable caching annotations</h3></div></div></div>

<p>It is important to note that even though declaring the cache annotations does not
automatically trigger their actions - like many things in Spring, the feature has to be
declaratively enabled (which means if you ever suspect caching is to blame, you can
disable it by removing only one configuration line rather then all the annotations in
your code).</p>
<p>To enable caching annotations add the annotation <code class="literal">@EnableCaching</code> to one of your
<code class="literal">@Configuration</code> classes:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Configuration</span></i>
<i><span class="hl-annotation" style="color: gray">@EnableCaching</span></i>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AppConfig {
}</pre>

<p>Alternatively for XML configuration use the <code class="literal">cache:annotation-driven</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:cache</span>=<span class="hl-value">"http://www.springframework.org/schema/cache"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd"</span><span class="hl-tag">&gt;</span>

        <span class="hl-tag">&lt;cache:annotation-driven /&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Both the <code class="literal">cache:annotation-driven</code> element and <code class="literal">@EnableCaching</code> annotation allow various
options to be specified that influence the way the caching behavior is added to the
application through AOP. The configuration is intentionally similar with that of
<a class="link" href="#tx-annotation-driven-settings" title="Table&nbsp;11.2.&nbsp;Annotation driven transaction settings"><code class="literal">@Transactional</code></a>:</p>
<div class="table"><a name="cache-annotation-driven-settings"></a><p class="title"><b>Table&nbsp;29.2.&nbsp;Cache annotation settings</b></p><div class="table-contents">

  <table summary="Cache annotation settings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">XML Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Annotation Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Default</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">cache-manager</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A (See <code class="literal">CachingConfigurer</code> Javadoc)</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cacheManager</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of cache manager to use. Only required if the name of the cache manager is not
  <code class="literal">cacheManager</code>, as in the example above.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">mode</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">mode</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>proxy</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The default mode "proxy" processes annotated beans to be proxied using Spring&#8217;s AOP
  framework (following proxy semantics, as discussed above, applying to method calls
  coming in through the proxy only). The alternative mode "aspectj" instead weaves the
  affected classes with Spring&#8217;s AspectJ caching aspect, modifying the target class byte
  code to apply to any kind of method call. AspectJ weaving requires spring-aspects.jar
  in the classpath as well as load-time weaving (or compile-time weaving) enabled. (See
  <a class="xref" href="#aop-aj-ltw-spring" title="Spring configuration">the section called &#8220;Spring configuration&#8221;</a> for details on how to set up load-time weaving.)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">proxy-target-class</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">proxyTargetClass</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Applies to proxy mode only. Controls what type of caching proxies are created for
  classes annotated with the <code class="literal">@Cacheable</code> or <code class="literal">@CacheEvict</code> annotations. If the
  <code class="literal">proxy-target-class</code> attribute is set to <code class="literal">true</code>, then class-based proxies are created.
  If <code class="literal">proxy-target-class</code> is <code class="literal">false</code> or if the attribute is omitted, then standard JDK
  interface-based proxies are created. (See <a class="xref" href="#aop-proxying" title="8.6&nbsp;Proxying mechanisms">Section&nbsp;8.6, &#8220;Proxying mechanisms&#8221;</a> for a detailed examination
  of the different proxy types.)</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">order</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">order</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Ordered.LOWEST_PRECEDENCE</p></td><td style="" align="left" valign="top"><p>Defines the order of the cache advice that is applied to beans annotated with
  <code class="literal">@Cacheable</code> or <code class="literal">@CacheEvict</code>. (For more information about the rules related to
  ordering of AOP advice, see <a class="xref" href="#aop-ataspectj-advice-ordering" title="Advice ordering">the section called &#8220;Advice ordering&#8221;</a>.) No specified ordering
  means that the AOP subsystem determines the order of the advice.</p></td></tr></tbody></table>
</div></div><br class="table-break">

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">&lt;cache:annotation-driven/&gt;</code> only looks for <code class="literal">@Cacheable/@CacheEvict</code> on beans in the
same application context it is defined in. This means that, if you put
<code class="literal">&lt;cache:annotation-driven/&gt;</code> in a <code class="literal">WebApplicationContext</code> for a <code class="literal">DispatcherServlet</code>, it
only checks for <code class="literal">@Cacheable/@CacheEvict</code> beans in your controllers, and not your
services. See <a class="xref" href="#mvc-servlet" title="16.2&nbsp;The DispatcherServlet">Section&nbsp;16.2, &#8220;The DispatcherServlet&#8221;</a> for more information.</p>
</td></tr></table></div>

<div class="sidebar" title="Method visibility and @Cacheable / @CachePut / @CacheEvict"><p class="title"><b>Method visibility and @Cacheable / @CachePut / @CacheEvict</b></p>

<p>When using proxies, you should apply the <code class="literal">@Cache*</code> annotations only to methods with
<span class="emphasis"><em>public</em></span> visibility. If you do annotate protected, private or package-visible methods
with these annotations, no error is raised, but the annotated method does not exhibit
the configured caching settings. Consider the use of AspectJ (see below) if you need to
annotate non-public methods as it changes the bytecode itself.</p>
</div>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Spring recommends that you only annotate concrete classes (and methods of concrete
classes) with the <code class="literal">@Cache*</code> annotation, as opposed to annotating interfaces. You
certainly can place the <code class="literal">@Cache*</code> annotation on an interface (or an interface method),
but this works only as you would expect it to if you are using interface-based proxies.
The fact that Java annotations are <span class="emphasis"><em>not inherited from interfaces</em></span> means that if you
are using class-based proxies ( <code class="literal">proxy-target-class="true"</code>) or the weaving-based aspect
( <code class="literal">mode="aspectj"</code>), then the caching settings are not recognized by the proxying and
weaving infrastructure, and the object will not be wrapped in a caching proxy, which
would be decidedly <span class="emphasis"><em>bad</em></span>.</p>
</td></tr></table></div>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In proxy mode (which is the default), only external method calls coming in through the
proxy are intercepted. This means that self-invocation, in effect, a method within the
target object calling another method of the target object, will not lead to an actual
caching at runtime even if the invoked method is marked with <code class="literal">@Cacheable</code> - considering
using the aspectj mode in this case.</p>
</td></tr></table></div>

</div>
<div class="section" title="29.3.6&nbsp;Using custom annotations"><div class="titlepage"><div><div><h3 class="title"><a name="cache-annotation-stereotype"></a>29.3.6&nbsp;Using custom annotations</h3></div></div></div>

<p>The caching abstraction allows you to use your own annotations to identify what method
trigger cache population or eviction. This is quite handy as a template mechanism as it
eliminates the need to duplicate cache annotation declarations (especially useful if the
key or condition are specified) or if the foreign imports (<code class="literal">org.springframework</code>) are
not allowed in your code base. Similar to the rest of the
<a class="link" href="#beans-stereotype-annotations" title="4.10.1&nbsp;@Component and further stereotype annotations">stereotype</a> annotations, both <code class="literal">@Cacheable</code> and
<code class="literal">@CacheEvict</code> can be used as <a class="link" href="#beans-meta-annotations" title="4.10.2&nbsp;Meta-annotations">meta-annotations</a>, that is
annotations that can annotate other annotations. To wit, let us replace a common
<code class="literal">@Cacheable</code> declaration with our own, custom annotation:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></i>
<i><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD})</span></i>
<i><span class="hl-annotation" style="color: gray">@Cacheable(value="books", key="#isbn")</span></i>
<span class="hl-keyword">public</span> <i><span class="hl-annotation" style="color: gray">@interface</span></i> SlowService {
}</pre>

<p>Above, we have defined our own <code class="literal">SlowService</code> annotation which itself is annotated with
<code class="literal">@Cacheable</code> - now we can replace the following code:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@Cacheable(value="books", key="#isbn")</span></i>
<span class="hl-keyword">public</span> Book findBook(ISBN isbn, <span class="hl-keyword">boolean</span> checkWarehouse, <span class="hl-keyword">boolean</span> includeUsed)</pre>

<p>with:</p>
<pre class="programlisting"><i><span class="hl-annotation" style="color: gray">@SlowService</span></i>
<span class="hl-keyword">public</span> Book findBook(ISBN isbn, <span class="hl-keyword">boolean</span> checkWarehouse, <span class="hl-keyword">boolean</span> includeUsed)</pre>

<p>Even though <code class="literal">@SlowService</code> is not a Spring annotation, the container automatically picks
up its declaration at runtime and understands its meaning. Note that as mentioned
<a class="link" href="#cache-annotation-enable" title="29.3.5&nbsp;Enable caching annotations">above</a>, the annotation-driven behavior needs to be enabled.</p>
</div>
</div>
<div class="section" title="29.4&nbsp;Declarative XML-based caching"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cache-declarative-xml"></a>29.4&nbsp;Declarative XML-based caching</h2></div></div></div>

<p>If annotations are not an option (no access to the sources or no external code), one can
use XML for declarative caching. So instead of annotating the methods for caching, one
specifies the target method and the caching directives externally (similar to the
declarative transaction management <a class="link" href="#transaction-declarative-first-example" title="11.5.2&nbsp;Example of declarative transaction implementation">advice</a>).
The previous example can be translated into:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- the service we want to make cacheable --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bookService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.service.DefaultBookService"</span><span class="hl-tag">/&gt;</span>

<span class="hl-comment">&lt;!-- cache definitions --&gt;</span>
<span class="hl-tag">&lt;cache:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cacheAdvice"</span> <span class="hl-attribute">cache-manager</span>=<span class="hl-value">"cacheManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;cache:caching</span> <span class="hl-attribute">cache</span>=<span class="hl-value">"books"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;cache:cacheable</span> <span class="hl-attribute">method</span>=<span class="hl-value">"findBook"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"#isbn"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;cache:cache-evict</span> <span class="hl-attribute">method</span>=<span class="hl-value">"loadBooks"</span> <span class="hl-attribute">all-entries</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/cache:caching&gt;</span>
<span class="hl-tag">&lt;/cache:advice&gt;</span>

<span class="hl-comment">&lt;!-- apply the cacheable behavior to all BookService interfaces --&gt;</span>
<span class="hl-tag">&lt;aop:config&gt;</span>
    <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"cacheAdvice"</span> <span class="hl-attribute">pointcut</span>=<span class="hl-value">"execution(* x.y.BookService.*(..))"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-comment">&lt;!-- cache manager definition omitted --&gt;</span></pre>

<p>In the configuration above, the <code class="literal">bookService</code> is made cacheable. The caching semantics
to apply are encapsulated in the <code class="literal">cache:advice</code> definition which instructs method
<code class="literal">findBooks</code> to be used for putting data into the cache while method <code class="literal">loadBooks</code> for
evicting data. Both definitions are working against the <code class="literal">books</code> cache.</p>
<p>The <code class="literal">aop:config</code> definition applies the cache advice to the appropriate points in the
program by using the AspectJ pointcut expression (more information is available in
<a class="xref" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">Chapter&nbsp;8, <i>Aspect Oriented Programming with Spring</i></a>). In the example above, all methods from the <code class="literal">BookService</code> are considered and
the cache advice applied to them.</p>
<p>The declarative XML caching supports all of the annotation-based model so moving between
the two should be fairly easy - further more both can be used inside the same
application. The XML based approach does not touch the target code however it is
inherently more verbose; when dealing with classes with overloaded methods that are
targeted for caching, identifying the proper methods does take an extra effort since the
<code class="literal">method</code> argument is not a good discriminator - in these cases, the AspectJ pointcut can
be used to cherry pick the target methods and apply the appropriate caching
functionality. However through XML, it is easier to apply a package/group/interface-wide
caching (again due to the AspectJ pointcut) and to create template-like definitions (as
we did in the example above by defining the target cache through the <code class="literal">cache:definitions</code>
<code class="literal">cache</code> attribute).</p>
</div>
<div class="section" title="29.5&nbsp;Configuring the cache storage"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cache-store-configuration"></a>29.5&nbsp;Configuring the cache storage</h2></div></div></div>

<p>Out of the box, the cache abstraction provides integration with two storages - one on
top of the JDK <code class="literal">ConcurrentMap</code> and one for <a class="ulink" href="http://ehcache.org/" target="_top">EhCache</a> library. To use
them, one needs to simply declare an appropriate <code class="literal">CacheManager</code> - an entity that
controls and manages <code class="literal">Cache</code> s and can be used to retrieve these for storage.</p>
<div class="section" title="29.5.1&nbsp;JDK ConcurrentMap-based Cache"><div class="titlepage"><div><div><h3 class="title"><a name="cache-store-configuration-jdk"></a>29.5.1&nbsp;JDK ConcurrentMap-based Cache</h3></div></div></div>

<p>The JDK-based <code class="literal">Cache</code> implementation resides under
<code class="literal">org.springframework.cache.concurrent</code> package. It allows one to use <code class="literal">ConcurrentHashMap</code>
as a backing <code class="literal">Cache</code> store.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- generic cache manager --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cacheManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.cache.support.SimpleCacheManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"caches"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;set&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean"</span> <span class="hl-attribute">p:name</span>=<span class="hl-value">"default"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean"</span> <span class="hl-attribute">p:name</span>=<span class="hl-value">"books"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/set&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The snippet above uses the <code class="literal">SimpleCacheManager</code> to create a <code class="literal">CacheManager</code> for the two
nested <code class="literal">ConcurrentMapCache</code> instances named <span class="emphasis"><em>default</em></span> and <span class="emphasis"><em>books</em></span>. Note that the
names are configured directly for each cache.</p>
<p>As the cache is created by the application, it is bound to its lifecycle, making it
suitable for basic use cases, tests or simple applications. The cache scales well and is
very fast but it does not provide any management or persistence capabilities nor
eviction contracts.</p>
</div>
<div class="section" title="29.5.2&nbsp;EhCache-based Cache"><div class="titlepage"><div><div><h3 class="title"><a name="cache-store-configuration-ehcache"></a>29.5.2&nbsp;EhCache-based Cache</h3></div></div></div>

<p>The EhCache implementation is located under <code class="literal">org.springframework.cache.ehcache</code> package.
Again, to use it, one simply needs to declare the appropriate <code class="literal">CacheManager</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cacheManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.cache.ehcache.EhCacheCacheManager"</span> <span class="hl-attribute">p:cache-manager-ref</span>=<span class="hl-value">"ehcache"</span><span class="hl-tag">/&gt;</span>

<span class="hl-comment">&lt;!-- EhCache library setup --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ehcache"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.cache.ehcache.EhCacheManagerFactoryBean"</span> <span class="hl-attribute">p:config-location</span>=<span class="hl-value">"ehcache.xml"</span><span class="hl-tag">/&gt;</span></pre>

<p>This setup bootstraps ehcache library inside Spring IoC (through bean <code class="literal">ehcache</code>) which
is then wired into the dedicated <code class="literal">CacheManager</code> implementation. Note the entire
ehcache-specific configuration is read from the resource <code class="literal">ehcache.xml</code>.</p>
</div>
<div class="section" title="29.5.3&nbsp;GemFire-based Cache"><div class="titlepage"><div><div><h3 class="title"><a name="cache-store-configuration-gemfire"></a>29.5.3&nbsp;GemFire-based Cache</h3></div></div></div>

<p>GemFire is a memory-oriented/disk-backed, elastically scalable, continuously available,
active (with built-in pattern-based subscription notifications), globally replicated
database and provides fully-featured edge caching. For further information on how to use
GemFire as a CacheManager (and more), please refer to the
<a class="ulink" href="http://docs.spring.io/spring-gemfire/docs/current/reference/htmlsingle/" target="_top">Spring GemFire
reference documentation</a>.</p>
</div>
<div class="section" title="29.5.4&nbsp;Dealing with caches without a backing store"><div class="titlepage"><div><div><h3 class="title"><a name="cache-store-configuration-noop"></a>29.5.4&nbsp;Dealing with caches without a backing store</h3></div></div></div>

<p>Sometimes when switching environments or doing testing, one might have cache
declarations without an actual backing cache configured. As this is an invalid
configuration, at runtime an exception will be thrown since the caching infrastructure
is unable to find a suitable store. In situations like this, rather then removing the
cache declarations (which can prove tedious), one can wire in a simple, dummy cache that
performs no caching - that is, forces the cached methods to be executed every time:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cacheManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.cache.support.CompositeCacheManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheManagers"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"jdkCache"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"gemfireCache"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fallbackToNoOpCache"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">CompositeCacheManager</code> above chains multiple <code class="literal">CacheManager</code> s and additionally,
through the <code class="literal">fallbackToNoOpCache</code> flag, adds a <span class="emphasis"><em>no op</em></span> cache that for all the
definitions not handled by the configured cache managers. That is, every cache
definition not found in either <code class="literal">jdkCache</code> or <code class="literal">gemfireCache</code> (configured above) will be
handled by the no op cache, which will not store any information causing the target
method to be executed every time.</p>
</div>
</div>
<div class="section" title="29.6&nbsp;Plugging-in different back-end caches"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cache-plug"></a>29.6&nbsp;Plugging-in different back-end caches</h2></div></div></div>

<p>Clearly there are plenty of caching products out there that can be used as a backing
store. To plug them in, one needs to provide a <code class="literal">CacheManager</code> and <code class="literal">Cache</code> implementation
since unfortunately there is no available standard that we can use instead. This may
sound harder then it is since in practice, the classes tend to be simple
<a class="ulink" href="http://en.wikipedia.org/wiki/Adapter_pattern" target="_top">adapter</a>s that map the caching abstraction
framework on top of the storage API as the <code class="literal">ehcache</code> classes can show. Most
<code class="literal">CacheManager</code> classes can use the classes in <code class="literal">org.springframework.cache.support</code>
package, such as <code class="literal">AbstractCacheManager</code> which takes care of the boiler-plate code
leaving only the actual <span class="emphasis"><em>mapping</em></span> to be completed. We hope that in time, the libraries
that provide integration with Spring can fill in this small configuration gap.</p>
</div>
<div class="section" title="29.7&nbsp;How can I set the TTL/TTI/Eviction policy/XXX feature?"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cache-specific-config"></a>29.7&nbsp;How can I set the TTL/TTI/Eviction policy/XXX feature?</h2></div></div></div>

<p>Directly through your cache provider. The cache abstraction is&#8230; well, an abstraction
not a cache implementation. The solution you are using might support various data
policies and different topologies which other solutions do not (take for example the JDK
<code class="literal">ConcurrentHashMap</code>) - exposing that in the cache abstraction would be useless simply
because there would no backing support. Such functionality should be controlled directly
through the backing cache, when configuring it or through its native API.</p>
</div>
</div>
</div>
<div class="part" title="Part&nbsp;VII.&nbsp;Appendices"><div class="titlepage"><div><div><h1 class="title"><a name="spring-appendices"></a>Part&nbsp;VII.&nbsp;Appendices</h1></div></div></div>

<div class="chapter" title="30.&nbsp;Migrating to Spring Framework 4.0"><div class="titlepage"><div><div><h2 class="title"><a name="migration-4.0"></a>30.&nbsp;Migrating to Spring Framework 4.0</h2></div></div></div>

<p>Migration guides for upgrading from previous releases of the Spring Framework are now
provided as a Wiki page. For details please refer to
<a class="ulink" href="https://github.com/spring-projects/spring-framework/wiki/Migrating-from-earlier-versions-of-the-spring-framework" target="_top">https://github.com/spring-projects/spring-framework/wiki/Migrating-from-earlier-versions-of-the-spring-framework</a></p>
</div>
<div class="chapter" title="31.&nbsp;Classic Spring Usage"><div class="titlepage"><div><div><h2 class="title"><a name="classic-spring"></a>31.&nbsp;Classic Spring Usage</h2></div></div></div>

<p>This appendix discusses some classic Spring usage patterns as a reference for developers
maintaining legacy Spring applications. These usage patterns no longer reflect the
recommended way of using these features and the current recommended usage is covered in
the respective sections of the reference manual.</p>
<div class="section" title="31.1&nbsp;Classic ORM usage"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-spring-orm"></a>31.1&nbsp;Classic ORM usage</h2></div></div></div>

<p>This section documents the classic usage patterns that you might encounter in a legacy
Spring application. For the currently recommended usage patterns, please refer to the
<a class="xref" href="#orm" title="14.&nbsp;Object Relational Mapping (ORM) Data Access">Chapter&nbsp;14, <i>Object Relational Mapping (ORM) Data Access</i></a> chapter.</p>
<div class="section" title="31.1.1&nbsp;Hibernate"><div class="titlepage"><div><div><h3 class="title"><a name="classic-spring-hibernate"></a>31.1.1&nbsp;Hibernate</h3></div></div></div>

<p>For the currently recommended usage patterns for Hibernate see <a class="xref" href="#orm-hibernate" title="14.3&nbsp;Hibernate">Section&nbsp;14.3, &#8220;Hibernate&#8221;</a></p>
<div class="section" title="the HibernateTemplate"><div class="titlepage"><div><div><h4 class="title"><a name="orm-hibernate-template"></a>the HibernateTemplate</h4></div></div></div>

<p>The basic programming model for templating looks as follows, for methods that can be
part of any custom data access object or business service. There are no restrictions on
the implementation of the surrounding object at all, it just needs to provide a
Hibernate <code class="literal">SessionFactory</code>. It can get the latter from anywhere, but preferably as bean
reference from a Spring IoC container - via a simple <code class="literal">setSessionFactory(..)</code> bean
property setter. The following snippets show a DAO definition in a Spring container,
referencing the above defined <code class="literal">SessionFactory</code>, and an example for a DAO method
implementation.</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> HibernateTemplate hibernateTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSessionFactory(SessionFactory sessionFactory) {
        <span class="hl-keyword">this</span>.hibernateTemplate = <span class="hl-keyword">new</span> HibernateTemplate(sessionFactory);
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.hibernateTemplate.find(<span class="hl-string">"from test.Product product where product.category=?"</span>, category);
    }
}</pre>

<p>The <code class="literal">HibernateTemplate</code> class provides many methods that mirror the methods exposed on
the Hibernate <code class="literal">Session</code> interface, in addition to a number of convenience methods such
as the one shown above. If you need access to the <code class="literal">Session</code> to invoke methods that are
not exposed on the <code class="literal">HibernateTemplate</code>, you can always drop down to a callback-based
approach like so.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> HibernateTemplate hibernateTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSessionFactory(SessionFactory sessionFactory) {
        <span class="hl-keyword">this</span>.hibernateTemplate = <span class="hl-keyword">new</span> HibernateTemplate(sessionFactory);
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(<span class="hl-keyword">final</span> String category) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.hibernateTemplate.execute(<span class="hl-keyword">new</span> HibernateCallback() {
            <span class="hl-keyword">public</span> Object doInHibernate(Session session) {
                Criteria criteria = session.createCriteria(Product.<span class="hl-keyword">class</span>);
                criteria.add(Expression.eq(<span class="hl-string">"category"</span>, category));
                criteria.setMaxResults(<span class="hl-number">6</span>);
                <span class="hl-keyword">return</span> criteria.list();
            }
        };
    }

}</pre>

<p>A callback implementation effectively can be used for any Hibernate data access.
<code class="literal">HibernateTemplate</code> will ensure that <code class="literal">Session</code> instances are properly opened and closed,
and automatically participate in transactions. The template instances are thread-safe
and reusable, they can thus be kept as instance variables of the surrounding class. For
simple single step actions like a single find, load, saveOrUpdate, or delete call,
<code class="literal">HibernateTemplate</code> offers alternative convenience methods that can replace such one
line callback implementations. Furthermore, Spring provides a convenient
<code class="literal">HibernateDaoSupport</code> base class that provides a <code class="literal">setSessionFactory(..)</code> method for
receiving a <code class="literal">SessionFactory</code>, and <code class="literal">getSessionFactory()</code> and <code class="literal">getHibernateTemplate()</code> for
use by subclasses. In combination, this allows for very simple DAO implementations for
typical requirements:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">extends</span> HibernateDaoSupport <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.getHibernateTemplate().find(
            <span class="hl-string">"from test.Product product where product.category=?"</span>, category);
    }

}</pre>

</div>
<div class="section" title="Implementing Spring-based DAOs without callbacks"><div class="titlepage"><div><div><h4 class="title"><a name="orm-hibernate-daos"></a>Implementing Spring-based DAOs without callbacks</h4></div></div></div>

<p>As alternative to using Spring&#8217;s <code class="literal">HibernateTemplate</code> to implement DAOs, data access code
can also be written in a more traditional fashion, without wrapping the Hibernate access
code in a callback, while still respecting and participating in Spring&#8217;s generic
<code class="literal">DataAccessException</code> hierarchy. The <code class="literal">HibernateDaoSupport</code> base class offers methods to
access the current transactional <code class="literal">Session</code> and to convert exceptions in such a scenario;
similar methods are also available as static helpers on the <code class="literal">SessionFactoryUtils</code> class.
Note that such code will usually pass ' <code class="literal">false</code>' as the value of the <code class="literal">getSession(..)</code>
methods ' <code class="literal">allowCreate</code>' argument, to enforce running within a transaction (which avoids
the need to close the returned <code class="literal">Session</code>, as its lifecycle is managed by the
transaction).</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateProductDao <span class="hl-keyword">extends</span> HibernateDaoSupport <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) <span class="hl-keyword">throws</span> DataAccessException, MyException {
        Session session = getSession(false);
        <span class="hl-keyword">try</span> {
            Query query = session.createQuery(<span class="hl-string">"from test.Product product where product.category=?"</span>);
            query.setString(<span class="hl-number">0</span>, category);
            List result = query.list();
            <span class="hl-keyword">if</span> (result == null) {
                <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> MyException(<span class="hl-string">"No search results."</span>);
            }
            <span class="hl-keyword">return</span> result;
        }
        <span class="hl-keyword">catch</span> (HibernateException ex) {
            <span class="hl-keyword">throw</span> convertHibernateAccessException(ex);
        }
    }
}</pre>

<p>The advantage of such direct Hibernate access code is that it allows <span class="emphasis"><em>any</em></span> checked
application exception to be thrown within the data access code; contrast this to the
<code class="literal">HibernateTemplate</code> class which is restricted to throwing only unchecked exceptions
within the callback. Note that you can often defer the corresponding checks and the
throwing of application exceptions to after the callback, which still allows working
with <code class="literal">HibernateTemplate</code>. In general, the <code class="literal">HibernateTemplate</code> class' convenience methods
are simpler and more convenient for many scenarios.</p>
</div>
</div>
<div class="section" title="31.1.2&nbsp;JDO"><div class="titlepage"><div><div><h3 class="title"><a name="classic-spring-jdo"></a>31.1.2&nbsp;JDO</h3></div></div></div>

<p>For the currently recommended usage patterns for JDO see <a class="xref" href="#orm-jdo" title="14.4&nbsp;JDO">Section&nbsp;14.4, &#8220;JDO&#8221;</a></p>
<div class="section" title="JdoTemplate and JdoDaoSupport"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jdo-template"></a>JdoTemplate and <code class="literal">JdoDaoSupport</code></h4></div></div></div>

<p>Each JDO-based DAO will then receive the <code class="literal">PersistenceManagerFactory</code> through dependency
injection. Such a DAO could be coded against plain JDO API, working with the given
<code class="literal">PersistenceManagerFactory</code>, but will usually rather be used with the Spring Framework&#8217;s
<code class="literal">JdoTemplate</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> JdoTemplate jdoTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPersistenceManagerFactory(PersistenceManagerFactory pmf) {
        <span class="hl-keyword">this</span>.jdoTemplate = <span class="hl-keyword">new</span> JdoTemplate(pmf);
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(<span class="hl-keyword">final</span> String category) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-keyword">return</span> (Collection) <span class="hl-keyword">this</span>.jdoTemplate.execute(<span class="hl-keyword">new</span> JdoCallback() {
            <span class="hl-keyword">public</span> Object doInJdo(PersistenceManager pm) <span class="hl-keyword">throws</span> JDOException {
                Query query = pm.newQuery(Product.<span class="hl-keyword">class</span>, <span class="hl-string">"category = pCategory"</span>);
                query.declareParameters(<span class="hl-string">"String pCategory"</span>);
                List result = query.execute(category);
                <span class="hl-comment">// do some further stuff with the result list</span>
                <span class="hl-keyword">return</span> result;
            }
        });
    }

}</pre>

<p>A callback implementation can effectively be used for any JDO data access. <code class="literal">JdoTemplate</code>
will ensure that <code class="literal">PersistenceManager</code> s are properly opened and closed, and
automatically participate in transactions. The template instances are thread-safe and
reusable, they can thus be kept as instance variables of the surrounding class. For
simple single-step actions such as a single <code class="literal">find</code>, <code class="literal">load</code>, <code class="literal">makePersistent</code>, or
<code class="literal">delete</code> call, <code class="literal">JdoTemplate</code> offers alternative convenience methods that can replace
such one line callback implementations. Furthermore, Spring provides a convenient
<code class="literal">JdoDaoSupport</code> base class that provides a <code class="literal">setPersistenceManagerFactory(..)</code> method for
receiving a <code class="literal">PersistenceManagerFactory</code>, and <code class="literal">getPersistenceManagerFactory()</code> and
<code class="literal">getJdoTemplate()</code> for use by subclasses. In combination, this allows for very simple
DAO implementations for typical requirements:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">extends</span> JdoDaoSupport <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-keyword">return</span> getJdoTemplate().find(Product.<span class="hl-keyword">class</span>,
                <span class="hl-string">"category = pCategory"</span>, <span class="hl-string">"String category"</span>, <span class="hl-keyword">new</span> Object[] {category});
    }

}</pre>

<p>As alternative to working with Spring&#8217;s <code class="literal">JdoTemplate</code>, you can also code Spring-based
DAOs at the JDO API level, explicitly opening and closing a <code class="literal">PersistenceManager</code>. As
elaborated in the corresponding Hibernate section, the main advantage of this approach
is that your data access code is able to throw checked exceptions. <code class="literal">JdoDaoSupport</code>
offers a variety of support methods for this scenario, for fetching and releasing a
transactional <code class="literal">PersistenceManager</code> as well as for converting exceptions.</p>
</div>
</div>
<div class="section" title="31.1.3&nbsp;JPA"><div class="titlepage"><div><div><h3 class="title"><a name="classic-spring-jpa"></a>31.1.3&nbsp;JPA</h3></div></div></div>

<p>For the currently recommended usage patterns for JPA see <a class="xref" href="#orm-jpa" title="14.5&nbsp;JPA">Section&nbsp;14.5, &#8220;JPA&#8221;</a></p>
<div class="section" title="JpaTemplate and JpaDaoSupport"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-template"></a>JpaTemplate and <code class="literal">JpaDaoSupport</code></h4></div></div></div>

<p>Each JPA-based DAO will then receive a <code class="literal">EntityManagerFactory</code> via dependency injection.
Such a DAO can be coded against plain JPA and work with the given <code class="literal">EntityManagerFactory</code>
or through Spring&#8217;s <code class="literal">JpaTemplate</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"entityManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myEmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaProductDao <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> JpaTemplate jpaTemplate;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setEntityManagerFactory(EntityManagerFactory emf) {
        <span class="hl-keyword">this</span>.jpaTemplate = <span class="hl-keyword">new</span> JpaTemplate(emf);
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(<span class="hl-keyword">final</span> String category) <span class="hl-keyword">throws</span> DataAccessException {
        <span class="hl-keyword">return</span> (Collection) <span class="hl-keyword">this</span>.jpaTemplate.execute(<span class="hl-keyword">new</span> JpaCallback() {
            <span class="hl-keyword">public</span> Object doInJpa(EntityManager em) <span class="hl-keyword">throws</span> PersistenceException {
                Query query = em.createQuery(<span class="hl-string">"from Product as p where p.category = :category"</span>);
                query.setParameter(<span class="hl-string">"category"</span>, category);
                List result = query.getResultList();
                <span class="hl-comment">// do some further processing with the result list</span>
                <span class="hl-keyword">return</span> result;
            }
        });
    }

}</pre>

<p>The <code class="literal">JpaCallback</code> implementation allows any type of JPA data access. The <code class="literal">JpaTemplate</code>
will ensure that <code class="literal">EntityManager</code> s are properly opened and closed and automatically
participate in transactions. Moreover, the <code class="literal">JpaTemplate</code> properly handles exceptions,
making sure resources are cleaned up and the appropriate transactions rolled back. The
template instances are thread-safe and reusable and they can be kept as instance
variable of the enclosing class. Note that <code class="literal">JpaTemplate</code> offers single-step actions such
as find, load, merge, etc along with alternative convenience methods that can replace
one line callback implementations.</p>
<p>Furthermore, Spring provides a convenient <code class="literal">JpaDaoSupport</code> base class that provides the
<code class="literal">get/setEntityManagerFactory</code> and <code class="literal">getJpaTemplate()</code> to be used by subclasses:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">extends</span> JpaDaoSupport <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) <span class="hl-keyword">throws</span> DataAccessException {
        Map&lt;String, String&gt; params = <span class="hl-keyword">new</span> HashMap&lt;String, String&gt;();
        params.put(<span class="hl-string">"category"</span>, category);
        <span class="hl-keyword">return</span> getJpaTemplate().findByNamedParams(<span class="hl-string">"from Product as p where p.category = :category"</span>, params);
    }

}</pre>

<p>Besides working with Spring&#8217;s <code class="literal">JpaTemplate</code>, one can also code Spring-based DAOs against
the JPA, doing one&#8217;s own explicit <code class="literal">EntityManager</code> handling. As also elaborated in the
corresponding Hibernate section, the main advantage of this approach is that your data
access code is able to throw checked exceptions. <code class="literal">JpaDaoSupport</code> offers a variety of
support methods for this scenario, for retrieving and releasing a transaction
<code class="literal">EntityManager</code>, as well as for converting exceptions.</p>
<p><span class="emphasis"><em>JpaTemplate mainly exists as a sibling of JdoTemplate and HibernateTemplate, offering
the same style for people used to it.</em></span></p>
</div>
</div>
</div>
<div class="section" title="31.2&nbsp;Classic Spring MVC"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="clasic-spring-mvc"></a>31.2&nbsp;Classic Spring MVC</h2></div></div></div>

<p>&#8230;</p>
</div>
<div class="section" title="31.3&nbsp;JMS Usage"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-spring-jms"></a>31.3&nbsp;JMS Usage</h2></div></div></div>

<p>One of the benefits of Spring&#8217;s JMS support is to shield the user from differences
between the JMS 1.0.2 and 1.1 APIs. (For a description of the differences between the
two APIs see sidebar on Domain Unification). Since it is now common to encounter only
the JMS 1.1 API the use of classes that are based on the JMS 1.0.2 API has been
deprecated in Spring 3.0. This section describes Spring JMS support for the JMS 1.0.2
deprecated classes.</p>
<div class="sidebar" title="Domain Unification"><p class="title"><b>Domain Unification</b></p>

<p>There are two major releases of the JMS specification, 1.0.2 and 1.1.</p>
<p>JMS 1.0.2 defined two types of messaging domains, point-to-point (Queues) and
publish/subscribe (Topics). The 1.0.2 API reflected these two messaging domains by
providing a parallel class hierarchy for each domain. As a result, a client application
became domain specific in its use of the JMS API. JMS 1.1 introduced the concept of
domain unification that minimized both the functional differences and client API
differences between the two domains. As an example of a functional difference that was
removed, if you use a JMS 1.1 provider you can transactionally consume a message from
one domain and produce a message on the other using the same <code class="literal">Session</code>.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The JMS 1.1 specification was released in April 2002 and incorporated as part of J2EE
1.4 in November 2003. As a result, common J2EE 1.3 application servers which are still
in widespread use (such as BEA WebLogic 8.1 and IBM WebSphere 5.1) are based on JMS
1.0.2.</p>
</td></tr></table></div>

</div>

<div class="section" title="31.3.1&nbsp;JmsTemplate"><div class="titlepage"><div><div><h3 class="title"><a name="classic-spring-jms-template"></a>31.3.1&nbsp;JmsTemplate</h3></div></div></div>

<p>Located in the package <code class="literal">org.springframework.jms.core</code> the class <code class="literal">JmsTemplate102</code>
provides all of the features of the <code class="literal">JmsTemplate</code> described the JMS chapter, but is
based on the JMS 1.0.2 API instead of the JMS 1.1 API. As a consequence, if you are
using JmsTemplate102 you need to set the boolean property <code class="literal">pubSubDomain</code> to configure
the <code class="literal">JmsTemplate</code> with knowledge of what JMS domain is being used. By default the value
of this property is false, indicating that the point-to-point domain, Queues, will be
used.</p>
</div>
<div class="section" title="31.3.2&nbsp;Asynchronous Message Reception"><div class="titlepage"><div><div><h3 class="title"><a name="classic-spring-aysnc-messages"></a>31.3.2&nbsp;Asynchronous Message Reception</h3></div></div></div>

<p><a class="link" href="#jms-receiving-async-message-listener-adapter" title="23.4.4&nbsp;the MessageListenerAdapter">MessageListenerAdapter&#8217;s</a> are used in
conjunction with Spring&#8217;s <a class="link" href="#jms-mdp" title="23.2.4&nbsp;Message Listener Containers">message listener containers</a> to support
asynchronous message reception by exposing almost any class as a Message-driven POJO. If
you are using the JMS 1.0.2 API, you will want to use the 1.0.2 specific classes such as
<code class="literal">MessageListenerAdapter102</code>, <code class="literal">SimpleMessageListenerContainer102</code>, and
<code class="literal">DefaultMessageListenerContainer102</code>. These classes provide the same functionality as
the JMS 1.1 based counterparts but rely only on the JMS 1.0.2 API.</p>
</div>
<div class="section" title="31.3.3&nbsp;Connections"><div class="titlepage"><div><div><h3 class="title"><a name="classic-spring-jms-connections"></a>31.3.3&nbsp;Connections</h3></div></div></div>

<p>The <code class="literal">ConnectionFactory</code> interface is part of the JMS specification and serves as the
entry point for working with JMS. Spring provides an implementation of the
<code class="literal">ConnectionFactory</code> interface, <code class="literal">SingleConnectionFactory102</code>, based on the JMS 1.0.2 API
that will return the same <code class="literal">Connection</code> on all <code class="literal">createConnection()</code> calls and ignore
calls to <code class="literal">close()</code>. You will need to set the boolean property <code class="literal">pubSubDomain</code> to indicate
which messaging domain is used as <code class="literal">SingleConnectionFactory102</code> will always explicitly
differentiate between a <code class="literal">javax.jms.QueueConnection</code> and a <code class="literal">javax.jmsTopicConnection</code>.</p>
</div>
<div class="section" title="31.3.4&nbsp;Transaction Management"><div class="titlepage"><div><div><h3 class="title"><a name="classic-spring-jms-tx-management"></a>31.3.4&nbsp;Transaction Management</h3></div></div></div>

<p>In a JMS 1.0.2 environment the class <code class="literal">JmsTransactionManager102</code> provides support for
managing JMS transactions for a single Connection Factory. Please refer to the reference
documentation on <a class="link" href="#jms-tx" title="23.2.5&nbsp;Transaction management">JMS Transaction Management</a> for more information on this
functionality.</p>
</div>
</div>
</div>
<div class="chapter" title="32.&nbsp;Classic Spring AOP Usage"><div class="titlepage"><div><div><h2 class="title"><a name="classic-aop-spring"></a>32.&nbsp;Classic Spring AOP Usage</h2></div></div></div>

<p>In this appendix we discuss the lower-level Spring AOP APIs and the AOP support used in
Spring 1.2 applications. For new applications, we recommend the use of the Spring 2.0
AOP support described in the <a class="link" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">AOP</a> chapter, but when working with existing
applications, or when reading books and articles, you may come across Spring 1.2 style
examples. Spring 2.0 is fully backwards compatible with Spring 1.2 and everything
described in this appendix is fully supported in Spring 2.0.</p>
<div class="section" title="32.1&nbsp;Pointcut API in Spring"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-api-pointcuts"></a>32.1&nbsp;Pointcut API in Spring</h2></div></div></div>

<p>Let&#8217;s look at how Spring handles the crucial pointcut concept.</p>
<div class="section" title="32.1.1&nbsp;Concepts"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-concepts"></a>32.1.1&nbsp;Concepts</h3></div></div></div>

<p>Spring&#8217;s pointcut model enables pointcut reuse independent of advice types. It&#8217;s
possible to target different advice using the same pointcut.</p>
<p>The <code class="literal">org.springframework.aop.Pointcut</code> interface is the central interface, used to
target advices to particular classes and methods. The complete interface is shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Pointcut {

    ClassFilter getClassFilter();

    MethodMatcher getMethodMatcher();

}</pre>

<p>Splitting the <code class="literal">Pointcut</code> interface into two parts allows reuse of class and method
matching parts, and fine-grained composition operations (such as performing a "union"
with another method matcher).</p>
<p>The <code class="literal">ClassFilter</code> interface is used to restrict the pointcut to a given set of target
classes. If the <code class="literal">matches()</code> method always returns true, all target classes will be
matched:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ClassFilter {

    <span class="hl-keyword">boolean</span> matches(Class clazz);

}</pre>

<p>The <code class="literal">MethodMatcher</code> interface is normally more important. The complete interface is
shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodMatcher {

    <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass);

    <span class="hl-keyword">boolean</span> isRuntime();

    <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass, Object[] args);

}</pre>

<p>The <code class="literal">matches(Method, Class)</code> method is used to test whether this pointcut will ever
match a given method on a target class. This evaluation can be performed when an AOP
proxy is created, to avoid the need for a test on every method invocation. If the
2-argument matches method returns true for a given method, and the <code class="literal">isRuntime()</code> method
for the MethodMatcher returns true, the 3-argument matches method will be invoked on
every method invocation. This enables a pointcut to look at the arguments passed to the
method invocation immediately before the target advice is to execute.</p>
<p>Most MethodMatchers are static, meaning that their <code class="literal">isRuntime()</code> method returns false.
In this case, the 3-argument matches method will never be invoked.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If possible, try to make pointcuts static, allowing the AOP framework to cache the
results of pointcut evaluation when an AOP proxy is created.</p>
</td></tr></table></div>

</div>
<div class="section" title="32.1.2&nbsp;Operations on pointcuts"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-pointcut-ops"></a>32.1.2&nbsp;Operations on pointcuts</h3></div></div></div>

<p>Spring supports operations on pointcuts: notably, <span class="emphasis"><em>union</em></span> and <span class="emphasis"><em>intersection</em></span>.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Union means the methods that either pointcut matches.
</li><li class="listitem">
Intersection means the methods that both pointcuts match.
</li><li class="listitem">
Union is usually more useful.
</li><li class="listitem">
Pointcuts can be composed using the static methods in the
<span class="emphasis"><em>org.springframework.aop.support.Pointcuts</em></span> class, or using the
<span class="emphasis"><em>ComposablePointcut</em></span> class in the same package. However, using AspectJ pointcut
expressions is usually a simpler approach.
</li></ul></div>

</div>
<div class="section" title="32.1.3&nbsp;AspectJ expression pointcuts"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-pointcuts-aspectj"></a>32.1.3&nbsp;AspectJ expression pointcuts</h3></div></div></div>

<p>Since 2.0, the most important type of pointcut used by Spring is
<code class="literal">org.springframework.aop.aspectj.AspectJExpressionPointcut</code>. This is a pointcut that
uses an AspectJ supplied library to parse an AspectJ pointcut expression string.</p>
<p>See the previous chapter for a discussion of supported AspectJ pointcut primitives.</p>
</div>
<div class="section" title="32.1.4&nbsp;Convenience pointcut implementations"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-pointcuts-impls"></a>32.1.4&nbsp;Convenience pointcut implementations</h3></div></div></div>

<p>Spring provides several convenient pointcut implementations. Some can be used out of the
box; others are intended to be subclassed in application-specific pointcuts.</p>
<div class="section" title="Static pointcuts"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-pointcuts-static"></a>Static pointcuts</h4></div></div></div>

<p>Static pointcuts are based on method and target class, and cannot take into account the
method&#8217;s arguments. Static pointcuts are sufficient - <span class="emphasis"><em>and best</em></span> - for most usages.
It&#8217;s possible for Spring to evaluate a static pointcut only once, when a method is first
invoked: after that, there is no need to evaluate the pointcut again with each method
invocation.</p>
<p>Let&#8217;s consider some static pointcut implementations included with Spring.</p>
<div class="section" title="Regular expression pointcuts"><div class="titlepage"><div><div><h5 class="title"><a name="classic-aop-api-pointcuts-regex"></a>Regular expression pointcuts</h5></div></div></div>

<p>One obvious way to specify static pointcuts is regular expressions. Several AOP
frameworks besides Spring make this possible.
<code class="literal">org.springframework.aop.support.Perl5RegexpMethodPointcut</code> is a generic regular
expression pointcut, using Perl 5 regular expression syntax. The
<code class="literal">Perl5RegexpMethodPointcut</code> class depends on Jakarta ORO for regular expression
matching. Spring also provides the <code class="literal">JdkRegexpMethodPointcut</code> class that uses the regular
expression support in JDK 1.4+.</p>
<p>Using the <code class="literal">Perl5RegexpMethodPointcut</code> class, you can provide a list of pattern Strings.
If any of these is a match, the pointcut will evaluate to true. (So the result is
effectively the union of these pointcuts.)</p>
<p>The usage is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"settersAndAbsquatulatePointcut"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.Perl5RegexpMethodPointcut"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.<span class="strong"><strong>set.</strong></span><span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*absquatulate<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Spring provides a convenience class, <code class="literal">RegexpMethodPointcutAdvisor</code>, that allows us to
also reference an Advice (remember that an Advice can be an interceptor, before advice,
throws advice etc.). Behind the scenes, Spring will use a <code class="literal">JdkRegexpMethodPointcut</code>.
Using <code class="literal">RegexpMethodPointcutAdvisor</code> simplifies wiring, as the one bean encapsulates both
pointcut and advice, as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"settersAndAbsquatulateAdvisor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.RegexpMethodPointcutAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"advice"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"beanNameOfAopAllianceInterceptor"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.<span class="strong"><strong>set.</strong></span><span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*absquatulate<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p><span class="emphasis"><em>RegexpMethodPointcutAdvisor</em></span> can be used with any Advice type.</p>
</div>
<div class="section" title="Attribute-driven pointcuts"><div class="titlepage"><div><div><h5 class="title"><a name="classic-aop-api-pointcuts-attribute-driven"></a>Attribute-driven pointcuts</h5></div></div></div>

<p>An important type of static pointcut is a <span class="emphasis"><em>metadata-driven</em></span> pointcut. This uses the
values of metadata attributes: typically, source-level metadata.</p>
</div>
</div>
<div class="section" title="Dynamic pointcuts"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-pointcuts-dynamic"></a>Dynamic pointcuts</h4></div></div></div>

<p>Dynamic pointcuts are costlier to evaluate than static pointcuts. They take into account
method<span class="emphasis"><em>arguments</em></span>, as well as static information. This means that they must be
evaluated with every method invocation; the result cannot be cached, as arguments will
vary.</p>
<p>The main example is the <code class="literal">control flow</code> pointcut.</p>
<div class="section" title="Control flow pointcuts"><div class="titlepage"><div><div><h5 class="title"><a name="classic-aop-api-pointcuts-cflow"></a>Control flow pointcuts</h5></div></div></div>

<p>Spring control flow pointcuts are conceptually similar to AspectJ <span class="emphasis"><em>cflow</em></span> pointcuts,
although less powerful. (There is currently no way to specify that a pointcut executes
below a join point matched by another pointcut.) A control flow pointcut matches the
current call stack. For example, it might fire if the join point was invoked by a method
in the <code class="literal">com.mycompany.web</code> package, or by the <code class="literal">SomeCaller</code> class. Control flow pointcuts
are specified using the <code class="literal">org.springframework.aop.support.ControlFlowPointcut</code> class.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Control flow pointcuts are significantly more expensive to evaluate at runtime than even
other dynamic pointcuts. In Java 1.4, the cost is about 5 times that of other dynamic
pointcuts.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section" title="32.1.5&nbsp;Pointcut superclasses"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-pointcuts-superclasses"></a>32.1.5&nbsp;Pointcut superclasses</h3></div></div></div>

<p>Spring provides useful pointcut superclasses to help you to implement your own pointcuts.</p>
<p>Because static pointcuts are most useful, you&#8217;ll probably subclass
StaticMethodMatcherPointcut, as shown below. This requires implementing just one
abstract method (although it&#8217;s possible to override other methods to customize behavior):</p>
<pre class="programlisting"><span class="hl-keyword">class</span> TestStaticPointcut <span class="hl-keyword">extends</span> StaticMethodMatcherPointcut {

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass) {
        <span class="hl-comment">// return true if custom criteria match</span>
    }

}</pre>

<p>There are also superclasses for dynamic pointcuts.</p>
<p>You can use custom pointcuts with any advice type in Spring 1.0 RC2 and above.</p>
</div>
<div class="section" title="32.1.6&nbsp;Custom pointcuts"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-pointcuts-custom"></a>32.1.6&nbsp;Custom pointcuts</h3></div></div></div>

<p>Because pointcuts in Spring AOP are Java classes, rather than language features (as in
AspectJ) it&#8217;s possible to declare custom pointcuts, whether static or dynamic. Custom
pointcuts in Spring can be arbitrarily complex. However, using the AspectJ pointcut
expression language is recommended if possible.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Later versions of Spring may offer support for "semantic pointcuts" as offered by JAC:
for example, "all methods that change instance variables in the target object."</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="32.2&nbsp;Advice API in Spring"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-api-advice"></a>32.2&nbsp;Advice API in Spring</h2></div></div></div>

<p>Let&#8217;s now look at how Spring AOP handles advice.</p>
<div class="section" title="32.2.1&nbsp;Advice lifecycles"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-advice-lifecycle"></a>32.2.1&nbsp;Advice lifecycles</h3></div></div></div>

<p>Each advice is a Spring bean. An advice instance can be shared across all advised
objects, or unique to each advised object. This corresponds to <span class="emphasis"><em>per-class</em></span> or
<span class="emphasis"><em>per-instance</em></span> advice.</p>
<p>Per-class advice is used most often. It is appropriate for generic advice such as
transaction advisors. These do not depend on the state of the proxied object or add new
state; they merely act on the method and arguments.</p>
<p>Per-instance advice is appropriate for introductions, to support mixins. In this case,
the advice adds state to the proxied object.</p>
<p>It&#8217;s possible to use a mix of shared and per-instance advice in the same AOP proxy.</p>
</div>
<div class="section" title="32.2.2&nbsp;Advice types in Spring"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-advice-types"></a>32.2.2&nbsp;Advice types in Spring</h3></div></div></div>

<p>Spring provides several advice types out of the box, and is extensible to support
arbitrary advice types. Let us look at the basic concepts and standard advice types.</p>
<div class="section" title="Interception around advice"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-advice-around"></a>Interception around advice</h4></div></div></div>

<p>The most fundamental advice type in Spring is <span class="emphasis"><em>interception around advice</em></span>.</p>
<p>Spring is compliant with the AOP Alliance interface for around advice using method
interception. MethodInterceptors implementing around advice should implement the
following interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodInterceptor <span class="hl-keyword">extends</span> Interceptor {

    Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable;

}</pre>

<p>The <code class="literal">MethodInvocation</code> argument to the <code class="literal">invoke()</code> method exposes the method being
invoked; the target join point; the AOP proxy; and the arguments to the method. The
<code class="literal">invoke()</code> method should return the invocation&#8217;s result: the return value of the join
point.</p>
<p>A simple <code class="literal">MethodInterceptor</code> implementation looks as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DebugInterceptor <span class="hl-keyword">implements</span> MethodInterceptor {

    <span class="hl-keyword">public</span> Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable {
        System.out.println(<span class="hl-string">"Before: invocation=["</span> + invocation + <span class="hl-string">"]"</span>);
        Object rval = invocation.proceed();
        System.out.println(<span class="hl-string">"Invocation returned"</span>);
        <span class="hl-keyword">return</span> rval;
    }

}</pre>

<p>Note the call to the MethodInvocation&#8217;s <code class="literal">proceed()</code> method. This proceeds down the
interceptor chain towards the join point. Most interceptors will invoke this method, and
return its return value. However, a MethodInterceptor, like any around advice, can
return a different value or throw an exception rather than invoke the proceed method.
However, you don&#8217;t want to do this without good reason!</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>MethodInterceptors offer interoperability with other AOP Alliance-compliant AOP
implementations. The other advice types discussed in the remainder of this section
implement common AOP concepts, but in a Spring-specific way. While there is an advantage
in using the most specific advice type, stick with MethodInterceptor around advice if
you are likely to want to run the aspect in another AOP framework. Note that pointcuts
are not currently interoperable between frameworks, and the AOP Alliance does not
currently define pointcut interfaces.</p>
</td></tr></table></div>

</div>
<div class="section" title="Before advice"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-advice-before"></a>Before advice</h4></div></div></div>

<p>A simpler advice type is a <span class="emphasis"><em>before advice</em></span>. This does not need a <code class="literal">MethodInvocation</code>
object, since it will only be called before entering the method.</p>
<p>The main advantage of a before advice is that there is no need to invoke the <code class="literal">proceed()</code>
method, and therefore no possibility of inadvertently failing to proceed down the
interceptor chain.</p>
<p>The <code class="literal">MethodBeforeAdvice</code> interface is shown below. (Spring&#8217;s API design would allow for
field before advice, although the usual objects apply to field interception and it&#8217;s
unlikely that Spring will ever implement it).</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodBeforeAdvice <span class="hl-keyword">extends</span> BeforeAdvice {

    <span class="hl-keyword">void</span> before(Method m, Object[] args, Object target) <span class="hl-keyword">throws</span> Throwable;

}</pre>

<p>Note the return type is <code class="literal">void</code>. Before advice can insert custom behavior before the join
point executes, but cannot change the return value. If a before advice throws an
exception, this will abort further execution of the interceptor chain. The exception
will propagate back up the interceptor chain. If it is unchecked, or on the signature of
the invoked method, it will be passed directly to the client; otherwise it will be
wrapped in an unchecked exception by the AOP proxy.</p>
<p>An example of a before advice in Spring, which counts all method invocations:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingBeforeAdvice <span class="hl-keyword">implements</span> MethodBeforeAdvice {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> before(Method m, Object[] args, Object target) <span class="hl-keyword">throws</span> Throwable {
        ++count;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> count;
    }
}</pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Before advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section" title="Throws advice"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-advice-throws"></a>Throws advice</h4></div></div></div>

<p><span class="emphasis"><em>Throws advice</em></span> is invoked after the return of the join point if the join point threw
an exception. Spring offers typed throws advice. Note that this means that the
<code class="literal">org.springframework.aop.ThrowsAdvice</code> interface does not contain any methods: It is a
tag interface identifying that the given object implements one or more typed throws
advice methods. These should be in the form of:</p>
<pre class="programlisting">afterThrowing([Method, args, target], subclassOfThrowable)</pre>

<p>Only the last argument is required. The method signatures may have either one or four
arguments, depending on whether the advice method is interested in the method and
arguments. The following classes are examples of throws advice.</p>
<p>The advice below is invoked if a <code class="literal">RemoteException</code> is thrown (including subclasses):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RemoteThrowsAdvice <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(RemoteException ex) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// Do something with remote exception</span>
    }

}</pre>

<p>The following advice is invoked if a <code class="literal">ServletException</code> is thrown. Unlike the above
advice, it declares 4 arguments, so that it has access to the invoked method, method
arguments and target object:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ServletThrowsAdviceWithArguments <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(Method m, Object[] args, Object target, ServletException ex) {
        <span class="hl-comment">// Do something with all arguments</span>
    }

}</pre>

<p>The final example illustrates how these two methods could be used in a single class,
which handles both <code class="literal">RemoteException</code> and <code class="literal">ServletException</code>. Any number of throws advice
methods can be combined in a single class.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> CombinedThrowsAdvice <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(RemoteException ex) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// Do something with remote exception</span>
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(Method m, Object[] args, Object target, ServletException ex) {
        <span class="hl-comment">// Do something with all arguments</span>
    }
}</pre>

<p><span class="emphasis"><em>Note:</em></span> If a throws-advice method throws an exception itself, it will override the
original exception (i.e. change the exception thrown to the user). The overriding
exception will typically be a RuntimeException; this is compatible with any method
signature. However, if a throws-advice method throws a checked exception, it will have
to match the declared exceptions of the target method and is hence to some degree
coupled to specific target method signatures. <span class="emphasis"><em>Do not throw an undeclared checked
exception that is incompatible with the target method&#8217;s signature!</em></span></p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Throws advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section" title="After Returning advice"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-advice-after-returning"></a>After Returning advice</h4></div></div></div>

<p>An after returning advice in Spring must implement the
<span class="emphasis"><em>org.springframework.aop.AfterReturningAdvice</em></span> interface, shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AfterReturningAdvice <span class="hl-keyword">extends</span> Advice {

    <span class="hl-keyword">void</span> afterReturning(Object returnValue, Method m, Object[] args,
            Object target) <span class="hl-keyword">throws</span> Throwable;

}</pre>

<p>An after returning advice has access to the return value (which it cannot modify),
invoked method, methods arguments and target.</p>
<p>The following after returning advice counts all successful method invocations that have
not thrown exceptions:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingAfterReturningAdvice <span class="hl-keyword">implements</span> AfterReturningAdvice {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterReturning(Object returnValue, Method m, Object[] args,
            Object target) <span class="hl-keyword">throws</span> Throwable {
        ++count;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> count;
    }

}</pre>

<p>This advice doesn&#8217;t change the execution path. If it throws an exception, this will be
thrown up the interceptor chain instead of the return value.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>After returning advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section" title="Introduction advice"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-advice-introduction"></a>Introduction advice</h4></div></div></div>

<p>Spring treats introduction advice as a special kind of interception advice.</p>
<p>Introduction requires an <code class="literal">IntroductionAdvisor</code>, and an <code class="literal">IntroductionInterceptor</code>,
implementing the following interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionInterceptor <span class="hl-keyword">extends</span> MethodInterceptor {

    <span class="hl-keyword">boolean</span> implementsInterface(Class intf);

}</pre>

<p>The <code class="literal">invoke()</code> method inherited from the AOP Alliance <code class="literal">MethodInterceptor</code> interface must
implement the introduction: that is, if the invoked method is on an introduced
interface, the introduction interceptor is responsible for handling the method call - it
cannot invoke <code class="literal">proceed()</code>.</p>
<p>Introduction advice cannot be used with any pointcut, as it applies only at class,
rather than method, level. You can only use introduction advice with the
<code class="literal">IntroductionAdvisor</code>, which has the following methods:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionAdvisor <span class="hl-keyword">extends</span> Advisor, IntroductionInfo {

    ClassFilter getClassFilter();

    <span class="hl-keyword">void</span> validateInterfaces() <span class="hl-keyword">throws</span> IllegalArgumentException;

}

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionInfo {

    Class[] getInterfaces();

}</pre>

<p>There is no <code class="literal">MethodMatcher</code>, and hence no <code class="literal">Pointcut</code>, associated with introduction
advice. Only class filtering is logical.</p>
<p>The <code class="literal">getInterfaces()</code> method returns the interfaces introduced by this advisor.</p>
<p>The <code class="literal">validateInterfaces()</code> method is used internally to see whether or not the
introduced interfaces can be implemented by the configured <code class="literal">IntroductionInterceptor</code>.</p>
<p>Let&#8217;s look at a simple example from the Spring test suite. Let&#8217;s suppose we want to
introduce the following interface to one or more objects:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Lockable {

    <span class="hl-keyword">void</span> lock();

    <span class="hl-keyword">void</span> unlock();

    <span class="hl-keyword">boolean</span> locked();

}</pre>

<p>This illustrates a <span class="emphasis"><em>mixin</em></span>. We want to be able to cast advised objects to Lockable,
whatever their type, and call lock and unlock methods. If we call the lock() method, we
want all setter methods to throw a <code class="literal">LockedException</code>. Thus we can add an aspect that
provides the ability to make objects immutable, without them having any knowledge of it:
a good example of AOP.</p>
<p>Firstly, we&#8217;ll need an <code class="literal">IntroductionInterceptor</code> that does the heavy lifting. In this
case, we extend the <code class="literal">org.springframework.aop.support.DelegatingIntroductionInterceptor</code>
convenience class. We could implement IntroductionInterceptor directly, but using
<code class="literal">DelegatingIntroductionInterceptor</code> is best for most cases.</p>
<p>The <code class="literal">DelegatingIntroductionInterceptor</code> is designed to delegate an introduction to an
actual implementation of the introduced interface(s), concealing the use of interception
to do so. The delegate can be set to any object using a constructor argument; the
default delegate (when the no-arg constructor is used) is this. Thus in the example
below, the delegate is the <code class="literal">LockMixin</code> subclass of <code class="literal">DelegatingIntroductionInterceptor</code>.
Given a delegate (by default itself), a <code class="literal">DelegatingIntroductionInterceptor</code> instance
looks for all interfaces implemented by the delegate (other than
IntroductionInterceptor), and will support introductions against any of them. It&#8217;s
possible for subclasses such as <code class="literal">LockMixin</code> to call the <code class="literal">suppressInterface(Class intf)</code>
method to suppress interfaces that should not be exposed. However, no matter how many
interfaces an <code class="literal">IntroductionInterceptor</code> is prepared to support, the
<code class="literal">IntroductionAdvisor</code> used will control which interfaces are actually exposed. An
introduced interface will conceal any implementation of the same interface by the target.</p>
<p>Thus LockMixin subclasses <code class="literal">DelegatingIntroductionInterceptor</code> and implements Lockable
itself. The superclass automatically picks up that Lockable can be supported for
introduction, so we don&#8217;t need to specify that. We could introduce any number of
interfaces in this way.</p>
<p>Note the use of the <code class="literal">locked</code> instance variable. This effectively adds additional state
to that held in the target object.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LockMixin <span class="hl-keyword">extends</span> DelegatingIntroductionInterceptor <span class="hl-keyword">implements</span> Lockable {

    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> locked;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> lock() {
        <span class="hl-keyword">this</span>.locked = true;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> unlock() {
        <span class="hl-keyword">this</span>.locked = false;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> locked() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.locked;
    }

    <span class="hl-keyword">public</span> Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-keyword">if</span> (locked() &amp;&amp; invocation.getMethod().getName().indexOf(<span class="hl-string">"set"</span>) == <span class="hl-number">0</span>) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> LockedException();
        }
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.invoke(invocation);
    }

}</pre>

<p>Often it isn&#8217;t necessary to override the <code class="literal">invoke()</code> method: the
<code class="literal">DelegatingIntroductionInterceptor</code> implementation - which calls the delegate method if
the method is introduced, otherwise proceeds towards the join point - is usually
sufficient. In the present case, we need to add a check: no setter method can be invoked
if in locked mode.</p>
<p>The introduction advisor required is simple. All it needs to do is hold a distinct
<code class="literal">LockMixin</code> instance, and specify the introduced interfaces - in this case, just
<code class="literal">Lockable</code>. A more complex example might take a reference to the introduction
interceptor (which would be defined as a prototype): in this case, there&#8217;s no
configuration relevant for a <code class="literal">LockMixin</code>, so we simply create it using <code class="literal">new</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LockMixinAdvisor <span class="hl-keyword">extends</span> DefaultIntroductionAdvisor {

    <span class="hl-keyword">public</span> LockMixinAdvisor() {
        <span class="hl-keyword">super</span>(<span class="hl-keyword">new</span> LockMixin(), Lockable.<span class="hl-keyword">class</span>);
    }

}</pre>

<p>We can apply this advisor very simply: it requires no configuration. (However, it <span class="emphasis"><em>is</em></span>
necessary: It&#8217;s impossible to use an <code class="literal">IntroductionInterceptor</code> without an
<span class="emphasis"><em>IntroductionAdvisor</em></span>.) As usual with introductions, the advisor must be per-instance,
as it is stateful. We need a different instance of <code class="literal">LockMixinAdvisor</code>, and hence
<code class="literal">LockMixin</code>, for each advised object. The advisor comprises part of the advised object&#8217;s
state.</p>
<p>We can apply this advisor programmatically, using the <code class="literal">Advised.addAdvisor()</code> method, or
(the recommended way) in XML configuration, like any other advisor. All proxy creation
choices discussed below, including "auto proxy creators," correctly handle introductions
and stateful mixins.</p>
</div>
</div>
</div>
<div class="section" title="32.3&nbsp;Advisor API in Spring"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-api-advisor"></a>32.3&nbsp;Advisor API in Spring</h2></div></div></div>

<p>In Spring, an Advisor is an aspect that contains just a single advice object associated
with a pointcut expression.</p>
<p>Apart from the special case of introductions, any advisor can be used with any advice.
<code class="literal">org.springframework.aop.support.DefaultPointcutAdvisor</code> is the most commonly used
advisor class. For example, it can be used with a <code class="literal">MethodInterceptor</code>, <code class="literal">BeforeAdvice</code> or
<code class="literal">ThrowsAdvice</code>.</p>
<p>It is possible to mix advisor and advice types in Spring in the same AOP proxy. For
example, you could use a interception around advice, throws advice and before advice in
one proxy configuration: Spring will automatically create the necessary interceptor
chain.</p>
</div>
<div class="section" title="32.4&nbsp;Using the ProxyFactoryBean to create AOP proxies"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-pfb"></a>32.4&nbsp;Using the ProxyFactoryBean to create AOP proxies</h2></div></div></div>

<p>If you&#8217;re using the Spring IoC container (an ApplicationContext or BeanFactory) for your
business objects - and you should be! - you will want to use one of Spring&#8217;s AOP
FactoryBeans. (Remember that a factory bean introduces a layer of indirection, enabling
it to create objects of a different type.)</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Spring 2.0 AOP support also uses factory beans under the covers.</p>
</td></tr></table></div>

<p>The basic way to create an AOP proxy in Spring is to use the
<span class="emphasis"><em>org.springframework.aop.framework.ProxyFactoryBean</em></span>. This gives complete control over
the pointcuts and advice that will apply, and their ordering. However, there are simpler
options that are preferable if you don&#8217;t need such control.</p>
<div class="section" title="32.4.1&nbsp;Basics"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-pfb-1"></a>32.4.1&nbsp;Basics</h3></div></div></div>

<p>The <code class="literal">ProxyFactoryBean</code>, like other Spring <code class="literal">FactoryBean</code> implementations, introduces a
level of indirection. If you define a <code class="literal">ProxyFactoryBean</code> with name <code class="literal">foo</code>, what objects
referencing <code class="literal">foo</code> see is not the <code class="literal">ProxyFactoryBean</code> instance itself, but an object
created by the <code class="literal">ProxyFactoryBean</code>'s implementation of the <code class="literal">getObject()</code> method. This
method will create an AOP proxy wrapping a target object.</p>
<p>One of the most important benefits of using a <code class="literal">ProxyFactoryBean</code> or another IoC-aware
class to create AOP proxies, is that it means that advices and pointcuts can also be
managed by IoC. This is a powerful feature, enabling certain approaches that are hard to
achieve with other AOP frameworks. For example, an advice may itself reference
application objects (besides the target, which should be available in any AOP
framework), benefiting from all the pluggability provided by Dependency Injection.</p>
</div>
<div class="section" title="32.4.2&nbsp;JavaBean properties"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-pfb-2"></a>32.4.2&nbsp;JavaBean properties</h3></div></div></div>

<p>In common with most <code class="literal">FactoryBean</code> implementations provided with Spring, the
<code class="literal">ProxyFactoryBean</code> class is itself a JavaBean. Its properties are used to:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Specify the target you want to proxy.
</li><li class="listitem">
Specify whether to use CGLIB (see below and also <a class="xref" href="#aop-pfb-proxy-types" title="9.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;9.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li></ul></div>

<p>Some key properties are inherited from <code class="literal">org.springframework.aop.framework.ProxyConfig</code>
(the superclass for all AOP proxy factories in Spring). These key properties include:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">proxyTargetClass</code>: <code class="literal">true</code> if the target class is to be proxied, rather than the
target class' interfaces. If this property value is set to <code class="literal">true</code>, then CGLIB proxies
will be created (but see also below <a class="xref" href="#aop-pfb-proxy-types" title="9.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;9.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li><li class="listitem">
<code class="literal">optimize</code>: controls whether or not aggressive optimizations are applied to proxies
<span class="emphasis"><em>created via CGLIB</em></span>. One should not blithely use this setting unless one fully
understands how the relevant AOP proxy handles optimization. This is currently used
only for CGLIB proxies; it has no effect with JDK dynamic proxies.
</li><li class="listitem">
<code class="literal">frozen</code>: if a proxy configuration is <code class="literal">frozen</code>, then changes to the configuration are
no longer allowed. This is useful both as a slight optimization and for those cases
when you don&#8217;t want callers to be able to manipulate the proxy (via the <code class="literal">Advised</code>
interface) after the proxy has been created. The default value of this property is
<code class="literal">false</code>, so changes such as adding additional advice are allowed.
</li><li class="listitem">
<code class="literal">exposeProxy</code>: determines whether or not the current proxy should be exposed in a
<code class="literal">ThreadLocal</code> so that it can be accessed by the target. If a target needs to obtain
the proxy and the <code class="literal">exposeProxy</code> property is set to <code class="literal">true</code>, the target can use the
<code class="literal">AopContext.currentProxy()</code> method.
</li><li class="listitem">
<code class="literal">aopProxyFactory</code>: the implementation of <code class="literal">AopProxyFactory</code> to use. Offers a way of
customizing whether to use dynamic proxies, CGLIB or any other proxy strategy. The
default implementation will choose dynamic proxies or CGLIB appropriately. There
should be no need to use this property; it is intended to allow the addition of new
proxy types in Spring 1.1.
</li></ul></div>

<p>Other properties specific to <code class="literal">ProxyFactoryBean</code> include:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">proxyInterfaces</code>: array of String interface names. If this isn&#8217;t supplied, a CGLIB
proxy for the target class will be used (but see also below <a class="xref" href="#aop-pfb-proxy-types" title="9.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;9.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li><li class="listitem">
<code class="literal">interceptorNames</code>: String array of <code class="literal">Advisor</code>, interceptor or other advice names to
apply. Ordering is significant, on a first come-first served basis. That is to say
that the first interceptor in the list will be the first to be able to intercept the
invocation.
</li></ul></div>

<p>The names are bean names in the current factory, including bean names from ancestor
factories. You can&#8217;t mention bean references here since doing so would result in the
<code class="literal">ProxyFactoryBean</code> ignoring the singleton setting of the advice.</p>
<p>You can append an interceptor name with an asterisk ( <code class="literal">*</code>). This will result in the
application of all advisor beans with names starting with the part before the asterisk
to be applied. An example of using this feature can be found in <a class="xref" href="#aop-global-advisors" title="9.5.6&nbsp;Using global advisors">Section&nbsp;9.5.6, &#8220;Using <span class="emphasis"><em>global</em></span> advisors&#8221;</a>.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
singleton: whether or not the factory should return a single object, no matter how
often the <code class="literal">getObject()</code> method is called. Several <code class="literal">FactoryBean</code> implementations offer
such a method. The default value is <code class="literal">true</code>. If you    want to use stateful advice - for
example, for stateful mixins - use    prototype advices along with a singleton value of
<code class="literal">false</code>.
</li></ul></div>

</div>
<div class="section" title="32.4.3&nbsp;JDK- and CGLIB-based proxies"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-pfb-proxy-types"></a>32.4.3&nbsp;JDK- and CGLIB-based proxies</h3></div></div></div>

<p>This section serves as the definitive documentation on how the <code class="literal">ProxyFactoryBean</code>
chooses to create one of either a JDK- and CGLIB-based proxy for a particular target
object (that is to be proxied).</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The behavior of the <code class="literal">ProxyFactoryBean</code> with regard to creating JDK- or CGLIB-based
proxies changed between versions 1.2.x and 2.0 of Spring. The <code class="literal">ProxyFactoryBean</code> now
exhibits similar semantics with regard to auto-detecting interfaces as those of the
<code class="literal">TransactionProxyFactoryBean</code> class.</p>
</td></tr></table></div>

<p>If the class of a target object that is to be proxied (hereafter simply referred to as
the target class) doesn&#8217;t implement any interfaces, then a CGLIB-based proxy will be
created. This is the easiest scenario, because JDK proxies are interface based, and no
interfaces means JDK proxying isn&#8217;t even possible. One simply plugs in the target bean,
and specifies the list of interceptors via the <code class="literal">interceptorNames</code> property. Note that a
CGLIB-based proxy will be created even if the <code class="literal">proxyTargetClass</code> property of the
<code class="literal">ProxyFactoryBean</code> has been set to <code class="literal">false</code>. (Obviously this makes no sense, and is best
removed from the bean definition because it is at best redundant, and at worst
confusing.)</p>
<p>If the target class implements one (or more) interfaces, then the type of proxy that is
created depends on the configuration of the <code class="literal">ProxyFactoryBean</code>.</p>
<p>If the <code class="literal">proxyTargetClass</code> property of the <code class="literal">ProxyFactoryBean</code> has been set to <code class="literal">true</code>,
then a CGLIB-based proxy will be created. This makes sense, and is in keeping with the
principle of least surprise. Even if the <code class="literal">proxyInterfaces</code> property of the
<code class="literal">ProxyFactoryBean</code> has been set to one or more fully qualified interface names, the fact
that the <code class="literal">proxyTargetClass</code> property is set to <code class="literal">true</code> <span class="emphasis"><em>will</em></span> cause CGLIB-based
proxying to be in effect.</p>
<p>If the <code class="literal">proxyInterfaces</code> property of the <code class="literal">ProxyFactoryBean</code> has been set to one or more
fully qualified interface names, then a JDK-based proxy will be created. The created
proxy will implement all of the interfaces that were specified in the <code class="literal">proxyInterfaces</code>
property; if the target class happens to implement a whole lot more interfaces than
those specified in the <code class="literal">proxyInterfaces</code> property, that is all well and good but those
additional interfaces will not be implemented by the returned proxy.</p>
<p>If the <code class="literal">proxyInterfaces</code> property of the <code class="literal">ProxyFactoryBean</code> has <span class="emphasis"><em>not</em></span> been set, but
the target class <span class="emphasis"><em>does implement one (or more)</em></span> interfaces, then the
<code class="literal">ProxyFactoryBean</code> will auto-detect the fact that the target class does actually
implement at least one interface, and a JDK-based proxy will be created. The interfaces
that are actually proxied will be <span class="emphasis"><em>all</em></span> of the interfaces that the target class
implements; in effect, this is the same as simply supplying a list of each and every
interface that the target class implements to the <code class="literal">proxyInterfaces</code> property. However,
it is significantly less work, and less prone to typos.</p>
</div>
<div class="section" title="32.4.4&nbsp;Proxying interfaces"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-proxying-intf"></a>32.4.4&nbsp;Proxying interfaces</h3></div></div></div>

<p>Let&#8217;s look at a simple example of <code class="literal">ProxyFactoryBean</code> in action. This example involves:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
A <span class="emphasis"><em>target bean</em></span> that will be proxied. This is the "personTarget" bean definition in
the example below.
</li><li class="listitem">
An Advisor and an Interceptor used to provide advice.
</li><li class="listitem">
An AOP proxy bean definition specifying the target object (the personTarget bean) and
the interfaces to proxy, along with the advices to apply.
</li></ul></div>

<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"personTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>Tony<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>51<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someProperty"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>Custom string property value<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"debugInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterfaces"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>com.mycompany.Person<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"personTarget"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myAdvisor<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>debugInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the <code class="literal">interceptorNames</code> property takes a list of String: the bean names of the
interceptor or advisors in the current factory. Advisors, interceptors, before, after
returning and throws advice objects can be used. The ordering of advisors is significant.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You might be wondering why the list doesn&#8217;t hold bean references. The reason for this is
that if the ProxyFactoryBean&#8217;s singleton property is set to false, it must be able to
return independent proxy instances. If any of the advisors is itself a prototype, an
independent instance would need to be returned, so it&#8217;s necessary to be able to obtain
an instance of the prototype from the factory; holding a reference isn&#8217;t sufficient.</p>
</td></tr></table></div>

<p>The "person" bean definition above can be used in place of a Person implementation, as
follows:</p>
<pre class="programlisting">Person person = (Person) factory.getBean(<span class="hl-string">"person"</span>);</pre>

<p>Other beans in the same IoC context can express a strongly typed dependency on it, as
with an ordinary Java object:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"personUser"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonUser"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"person"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"person"</span><span class="hl-tag"> /&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">PersonUser</code> class in this example would expose a property of type Person. As far as
it&#8217;s concerned, the AOP proxy can be used transparently in place of a "real" person
implementation. However, its class would be a dynamic proxy class. It would be possible
to cast it to the <code class="literal">Advised</code> interface (discussed below).</p>
<p>It&#8217;s possible to conceal the distinction between target and proxy using an anonymous
<span class="emphasis"><em>inner bean</em></span>, as follows. Only the <code class="literal">ProxyFactoryBean</code> definition is different; the
advice is included only for completeness:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someProperty"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>Custom string property value<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"debugInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterfaces"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>com.mycompany.Person<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-comment">&lt;!-- Use inner bean, not local reference to target --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonImpl"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>Tony<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>51<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myAdvisor<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>debugInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This has the advantage that there&#8217;s only one object of type <code class="literal">Person</code>: useful if we want
to prevent users of the application context from obtaining a reference to the un-advised
object, or need to avoid any ambiguity with Spring IoC <span class="emphasis"><em>autowiring</em></span>. There&#8217;s also
arguably an advantage in that the ProxyFactoryBean definition is self-contained.
However, there are times when being able to obtain the un-advised target from the
factory might actually be an <span class="emphasis"><em>advantage</em></span>: for example, in certain test scenarios.</p>
</div>
<div class="section" title="32.4.5&nbsp;Proxying classes"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-api-proxying-class"></a>32.4.5&nbsp;Proxying classes</h3></div></div></div>

<p>What if you need to proxy a class, rather than one or more interfaces?</p>
<p>Imagine that in our example above, there was no <code class="literal">Person</code> interface: we needed to advise
a class called <code class="literal">Person</code> that didn&#8217;t implement any business interface. In this case, you
can configure Spring to use CGLIB proxying, rather than dynamic proxies. Simply set the
<code class="literal">proxyTargetClass</code> property on the ProxyFactoryBean above to true. While it&#8217;s best to
program to interfaces, rather than classes, the ability to advise classes that don&#8217;t
implement interfaces can be useful when working with legacy code. (In general, Spring
isn&#8217;t prescriptive. While it makes it easy to apply good practices, it avoids forcing a
particular approach.)</p>
<p>If you want to, you can force the use of CGLIB in any case, even if you do have
interfaces.</p>
<p>CGLIB proxying works by generating a subclass of the target class at runtime. Spring
configures this generated subclass to delegate method calls to the original target: the
subclass is used to implement the <span class="emphasis"><em>Decorator</em></span> pattern, weaving in the advice.</p>
<p>CGLIB proxying should generally be transparent to users. However, there are some issues
to consider:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">Final</code> methods can&#8217;t be advised, as they can&#8217;t be overridden.
</li><li class="listitem">
As of Spring 3.2 it is no longer required to add CGLIB to your project classpath.
CGLIB classes have been repackaged under org.springframework and included directly in
the spring-core JAR. This is both for user convenience as well as to avoid potential
conflicts with other projects that have dependence on a differing version of CGLIB.
</li></ul></div>

<p>There&#8217;s little performance difference between CGLIB proxying and dynamic proxies. As of
Spring 1.0, dynamic proxies are slightly faster. However, this may change in the future.
Performance should not be a decisive consideration in this case.</p>
</div>
<div class="section" title="32.4.6&nbsp;Using global advisors"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-global-advisors"></a>32.4.6&nbsp;Using <span class="emphasis"><em>global</em></span> advisors</h3></div></div></div>

<p>By appending an asterisk to an interceptor name, all advisors with bean names matching
the part before the asterisk, will be added to the advisor chain. This can come in handy
if you need to add a standard set of <span class="emphasis"><em>global</em></span> advisors:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>global*<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"global_debug"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"global_performance"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.PerformanceMonitorInterceptor"</span><span class="hl-tag">/&gt;</span></pre>

</div>
</div>
<div class="section" title="32.5&nbsp;Concise proxy definitions"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-concise-proxy"></a>32.5&nbsp;Concise proxy definitions</h2></div></div></div>

<p>Especially when defining transactional proxies, you may end up with many similar proxy
definitions. The use of parent and child bean definitions, along with inner bean
definitions, can result in much cleaner and more concise proxy definitions.</p>
<p>First a parent, <span class="emphasis"><em>template</em></span>, bean definition is created for the proxy:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txProxyTemplate"</span> <span class="hl-attribute">abstract</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This will never be instantiated itself, so may actually be incomplete. Then each proxy
which needs to be created is just a child bean definition, which wraps the target of the
proxy as an inner bean definition, since the target will never be used on its own anyway.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myService"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"txProxyTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MyServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>It is of course possible to override properties from the parent template, such as in
this case, the transaction propagation settings:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySpecialService"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"txProxyTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MySpecialServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"get*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"find*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"load*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"store*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that in the example above, we have explicitly marked the parent bean definition as
<span class="emphasis"><em>abstract</em></span> by using the <span class="emphasis"><em>abstract</em></span> attribute, as described
<a class="link" href="#beans-child-bean-definitions" title="4.7&nbsp;Bean definition inheritance">previously</a>, so that it may not actually ever be
instantiated. Application contexts (but not simple bean factories) will by default
pre-instantiate all singletons. It is therefore important (at least for singleton beans)
that if you have a (parent) bean definition which you intend to use only as a template,
and this definition specifies a class, you must make sure to set the<span class="emphasis"><em>abstract</em></span>
attribute to <span class="emphasis"><em>true</em></span>, otherwise the application context will actually try to
pre-instantiate it.</p>
</div>
<div class="section" title="32.6&nbsp;Creating AOP proxies programmatically with the ProxyFactory"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-prog"></a>32.6&nbsp;Creating AOP proxies programmatically with the ProxyFactory</h2></div></div></div>

<p>It&#8217;s easy to create AOP proxies programmatically using Spring. This enables you to use
Spring AOP without dependency on Spring IoC.</p>
<p>The following listing shows creation of a proxy for a target object, with one
interceptor and one advisor. The interfaces implemented by the target object will
automatically be proxied:</p>
<pre class="programlisting">ProxyFactory factory = <span class="hl-keyword">new</span> ProxyFactory(myBusinessInterfaceImpl);
factory.addInterceptor(myMethodInterceptor);
factory.addAdvisor(myAdvisor);
MyBusinessInterface tb = (MyBusinessInterface) factory.getProxy();</pre>

<p>The first step is to construct an object of type
<code class="literal">org.springframework.aop.framework.ProxyFactory</code>. You can create this with a target
object, as in the above example, or specify the interfaces to be proxied in an alternate
constructor.</p>
<p>You can add interceptors or advisors, and manipulate them for the life of the
ProxyFactory. If you add an IntroductionInterceptionAroundAdvisor you can cause the
proxy to implement additional interfaces.</p>
<p>There are also convenience methods on ProxyFactory (inherited from <code class="literal">AdvisedSupport</code>)
which allow you to add other advice types such as before and throws advice.
AdvisedSupport is the superclass of both ProxyFactory and ProxyFactoryBean.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Integrating AOP proxy creation with the IoC framework is best practice in most
applications. We recommend that you externalize configuration from Java code with AOP,
as in general.</p>
</td></tr></table></div>

</div>
<div class="section" title="32.7&nbsp;Manipulating advised objects"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-api-advised"></a>32.7&nbsp;Manipulating advised objects</h2></div></div></div>

<p>However you create AOP proxies, you can manipulate them using the
<code class="literal">org.springframework.aop.framework.Advised</code> interface. Any AOP proxy can be cast to this
interface, whichever other interfaces it implements. This interface includes the
following methods:</p>
<pre class="programlisting">Advisor[] getAdvisors();

<span class="hl-keyword">void</span> addAdvice(Advice advice) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvice(<span class="hl-keyword">int</span> pos, Advice advice) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvisor(Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvisor(<span class="hl-keyword">int</span> pos, Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">int</span> indexOf(Advisor advisor);

<span class="hl-keyword">boolean</span> removeAdvisor(Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> removeAdvisor(<span class="hl-keyword">int</span> index) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">boolean</span> replaceAdvisor(Advisor a, Advisor b) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">boolean</span> isFrozen();</pre>

<p>The <code class="literal">getAdvisors()</code> method will return an Advisor for every advisor, interceptor or
other advice type that has been added to the factory. If you added an Advisor, the
returned advisor at this index will be the object that you added. If you added an
interceptor or other advice type, Spring will have wrapped this in an advisor with a
pointcut that always returns true. Thus if you added a <code class="literal">MethodInterceptor</code>, the advisor
returned for this index will be an <code class="literal">DefaultPointcutAdvisor</code> returning your
<code class="literal">MethodInterceptor</code> and a pointcut that matches all classes and methods.</p>
<p>The <code class="literal">addAdvisor()</code> methods can be used to add any Advisor. Usually the advisor holding
pointcut and advice will be the generic <code class="literal">DefaultPointcutAdvisor</code>, which can be used with
any advice or pointcut (but not for introductions).</p>
<p>By default, it&#8217;s possible to add or remove advisors or interceptors even once a proxy
has been created. The only restriction is that it&#8217;s impossible to add or remove an
introduction advisor, as existing proxies from the factory will not show the interface
change. (You can obtain a new proxy from the factory to avoid this problem.)</p>
<p>A simple example of casting an AOP proxy to the <code class="literal">Advised</code> interface and examining and
manipulating its advice:</p>
<pre class="programlisting">Advised advised = (Advised) myObject;
Advisor[] advisors = advised.getAdvisors();
<span class="hl-keyword">int</span> oldAdvisorCount = advisors.length;
System.out.println(oldAdvisorCount + <span class="hl-string">" advisors"</span>);

<span class="hl-comment">// Add an advice like an interceptor without a pointcut</span>
<span class="hl-comment">// Will match all proxied methods</span>
<span class="hl-comment">// Can use for interceptors, before, after returning or throws advice</span>
advised.addAdvice(<span class="hl-keyword">new</span> DebugInterceptor());

<span class="hl-comment">// Add selective advice using a pointcut</span>
advised.addAdvisor(<span class="hl-keyword">new</span> DefaultPointcutAdvisor(mySpecialPointcut, myAdvice));

assertEquals(<span class="hl-string">"Added two advisors"</span>, oldAdvisorCount + <span class="hl-number">2</span>, advised.getAdvisors().length);</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It&#8217;s questionable whether it&#8217;s advisable (no pun intended) to modify advice on a
business object in production, although there are no doubt legitimate usage cases.
However, it can be very useful in development: for example, in tests. I have sometimes
found it very useful to be able to add test code in the form of an interceptor or other
advice, getting inside a method invocation I want to test. (For example, the advice can
get inside a transaction created for that method: for example, to run SQL to check that
a database was correctly updated, before marking the transaction for roll back.)</p>
</td></tr></table></div>

<p>Depending on how you created the proxy, you can usually set a <code class="literal">frozen</code> flag, in which
case the <code class="literal">Advised</code> <code class="literal">isFrozen()</code> method will return true, and any attempts to modify
advice through addition or removal will result in an <code class="literal">AopConfigException</code>. The ability
to freeze the state of an advised object is useful in some cases, for example, to
prevent calling code removing a security interceptor. It may also be used in Spring 1.1
to allow aggressive optimization if runtime advice modification is known not to be
required.</p>
</div>
<div class="section" title="32.8&nbsp;Using the &#34;autoproxy&#34; facility"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-autoproxy"></a>32.8&nbsp;Using the "autoproxy" facility</h2></div></div></div>

<p>So far we&#8217;ve considered explicit creation of AOP proxies using a <code class="literal">ProxyFactoryBean</code> or
similar factory bean.</p>
<p>Spring also allows us to use "autoproxy" bean definitions, which can automatically proxy
selected bean definitions. This is built on Spring "bean post processor" infrastructure,
which enables modification of any bean definition as the container loads.</p>
<p>In this model, you set up some special bean definitions in your XML bean definition file
to configure the auto proxy infrastructure. This allows you just to declare the targets
eligible for autoproxying: you don&#8217;t need to use <code class="literal">ProxyFactoryBean</code>.</p>
<p>There are two ways to do this:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Using an autoproxy creator that refers to specific beans in the current context.
</li><li class="listitem">
A special case of autoproxy creation that deserves to be considered separately;
autoproxy creation driven by source-level metadata attributes.
</li></ul></div>

<div class="section" title="32.8.1&nbsp;Autoproxy bean definitions"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-autoproxy-choices"></a>32.8.1&nbsp;Autoproxy bean definitions</h3></div></div></div>

<p>The <code class="literal">org.springframework.aop.framework.autoproxy</code> package provides the following
standard autoproxy creators.</p>
<div class="section" title="BeanNameAutoProxyCreator"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-autoproxy"></a>BeanNameAutoProxyCreator</h4></div></div></div>

<p>The <code class="literal">BeanNameAutoProxyCreator</code> class is a <code class="literal">BeanPostProcessor</code> that automatically creates
AOP proxies for beans with names matching literal values or wildcards.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beanNames"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;value&gt;</span>jdk*,onlyJdk<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>As with <code class="literal">ProxyFactoryBean</code>, there is an <code class="literal">interceptorNames</code> property rather than a list
of interceptors, to allow correct behavior for prototype advisors. Named "interceptors"
can be advisors or any advice type.</p>
<p>As with auto proxying in general, the main point of using <code class="literal">BeanNameAutoProxyCreator</code> is
to apply the same configuration consistently to multiple objects, with minimal volume of
configuration. It is a popular choice for applying declarative transactions to multiple
objects.</p>
<p>Bean definitions whose names match, such as "jdkMyBean" and "onlyJdk" in the above
example, are plain old bean definitions with the target class. An AOP proxy will be
created automatically by the <code class="literal">BeanNameAutoProxyCreator</code>. The same advice will be applied
to all matching beans. Note that if advisors are used (rather than the interceptor in
the above example), the pointcuts may apply differently to different beans.</p>
</div>
<div class="section" title="DefaultAdvisorAutoProxyCreator"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-autoproxy-default"></a>DefaultAdvisorAutoProxyCreator</h4></div></div></div>

<p>A more general and extremely powerful auto proxy creator is
<code class="literal">DefaultAdvisorAutoProxyCreator</code>. This will automagically apply eligible advisors in the
current context, without the need to include specific bean names in the autoproxy
advisor&#8217;s bean definition. It offers the same merit of consistent configuration and
avoidance of duplication as <code class="literal">BeanNameAutoProxyCreator</code>.</p>
<p>Using this mechanism involves:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Specifying a <code class="literal">DefaultAdvisorAutoProxyCreator</code> bean definition.
</li><li class="listitem">
Specifying any number of Advisors in the same or related contexts. Note that these
<span class="emphasis"><em>must</em></span> be Advisors, not just interceptors or other advices. This is necessary
because there must be a pointcut to evaluate, to check the eligibility of each advice
to candidate bean definitions.
</li></ul></div>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> will automatically evaluate the pointcut contained
in each advisor, to see what (if any) advice it should apply to each business object
(such as "businessObject1" and "businessObject2" in the example).</p>
<p>This means that any number of advisors can be applied automatically to each business
object. If no pointcut in any of the advisors matches any method in a business object,
the object will not be proxied. As bean definitions are added for new business objects,
they will automatically be proxied if necessary.</p>
<p>Autoproxying in general has the advantage of making it impossible for callers or
dependencies to obtain an un-advised object. Calling getBean("businessObject1") on this
ApplicationContext will return an AOP proxy, not the target business object. (The "inner
bean" idiom shown earlier also offers this benefit.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject1"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.BusinessObject1"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- Properties omitted --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject2"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.BusinessObject2"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> is very useful if you want to apply the same advice
consistently to many business objects. Once the infrastructure definitions are in place,
you can simply add new business objects without including specific proxy configuration.
You can also drop in additional aspects very easily - for example, tracing or
performance monitoring aspects - with minimal change to configuration.</p>
<p>The DefaultAdvisorAutoProxyCreator offers support for filtering (using a naming
convention so that only certain advisors are evaluated, allowing use of multiple,
differently configured, AdvisorAutoProxyCreators in the same factory) and ordering.
Advisors can implement the <code class="literal">org.springframework.core.Ordered</code> interface to ensure
correct ordering if this is an issue. The TransactionAttributeSourceAdvisor used in the
above example has a configurable order value; the default setting is unordered.</p>
</div>
<div class="section" title="AbstractAdvisorAutoProxyCreator"><div class="titlepage"><div><div><h4 class="title"><a name="classic-aop-api-autoproxy-abstract"></a>AbstractAdvisorAutoProxyCreator</h4></div></div></div>

<p>This is the superclass of DefaultAdvisorAutoProxyCreator. You can create your own
autoproxy creators by subclassing this class, in the unlikely event that advisor
definitions offer insufficient customization to the behavior of the framework
<code class="literal">DefaultAdvisorAutoProxyCreator</code>.</p>
</div>
</div>
<div class="section" title="32.8.2&nbsp;Using metadata-driven auto-proxying"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-autoproxy-metadata"></a>32.8.2&nbsp;Using metadata-driven auto-proxying</h3></div></div></div>

<p>A particularly important type of autoproxying is driven by metadata. This produces a
similar programming model to .NET <code class="literal">ServicedComponents</code>. Instead of using XML deployment
descriptors as in EJB, configuration for transaction management and other enterprise
services is held in source-level attributes.</p>
<p>In this case, you use the <code class="literal">DefaultAdvisorAutoProxyCreator</code>, in combination with Advisors
that understand metadata attributes. The metadata specifics are held in the pointcut
part of the candidate advisors, rather than in the autoproxy creation class itself.</p>
<p>This is really a special case of the <code class="literal">DefaultAdvisorAutoProxyCreator</code>, but deserves
consideration on its own. (The metadata-aware code is in the pointcuts contained in the
advisors, not the AOP framework itself.)</p>
<p>The <code class="literal">/attributes</code> directory of the JPetStore sample application shows the use of
attribute-driven autoproxying. In this case, there&#8217;s no need to use the
<code class="literal">TransactionProxyFactoryBean</code>. Simply defining transactional attributes on business
objects is sufficient, because of the use of metadata-aware pointcuts. The bean
definitions include the following code, in <code class="literal">/WEB-INF/declarativeServices.xml</code>. Note that
this is generic, and can be used outside the JPetStore:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributeSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.AttributesTransactionAttributeSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"attributes"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"attributes"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"attributes"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.metadata.commons.CommonsAttributes"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> bean definition (the name is not significant, hence
it can even be omitted) will pick up all eligible pointcuts in the current application
context. In this case, the "transactionAdvisor" bean definition, of type
<code class="literal">TransactionAttributeSourceAdvisor</code>, will apply to classes or methods carrying a
transaction attribute. The TransactionAttributeSourceAdvisor depends on a
TransactionInterceptor, via constructor dependency. The example resolves this via
autowiring. The <code class="literal">AttributesTransactionAttributeSource</code> depends on an implementation of
the <code class="literal">org.springframework.metadata.Attributes</code> interface. In this fragment, the
"attributes" bean satisfies this, using the Jakarta Commons Attributes API to obtain
attribute information. (The application code must have been compiled using the Commons
Attributes compilation task.)</p>
<p>The <code class="literal">/annotation</code> directory of the JPetStore sample application contains an analogous
example for auto-proxying driven by JDK 1.5+ annotations. The following configuration
enables automatic detection of Spring&#8217;s <code class="literal">Transactional</code> annotation, leading to implicit
proxies for beans containing that annotation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributeSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">TransactionInterceptor</code> defined here depends on a <code class="literal">PlatformTransactionManager</code>
definition, which is not included in this generic file (although it could be) because it
will be specific to the application&#8217;s transaction requirements (typically JTA, as in
this example, or Hibernate, JDO or JDBC):</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>

<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you require only declarative transaction management, using these generic XML
definitions will result in Spring automatically proxying all classes or methods with
transaction attributes. You won&#8217;t need to work directly with AOP, and the programming
model is similar to that of .NET ServicedComponents.</p>
</td></tr></table></div>

<p>This mechanism is extensible. It&#8217;s possible to do autoproxying based on custom
attributes. You need to:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Define your custom attribute.
</li><li class="listitem">
Specify an Advisor with the necessary advice, including a pointcut that is triggered
by the presence of the custom attribute on a class or method. You may be able to use
an existing advice, merely implementing a static pointcut that picks up the custom
attribute.
</li></ul></div>

<p>It&#8217;s possible for such advisors to be unique to each advised class (for example,
mixins): they simply need to be defined as prototype, rather than singleton, bean
definitions. For example, the <code class="literal">LockMixin</code> introduction interceptor from the Spring test
suite, shown above, could be used in conjunction with an attribute-driven pointcut to
target a mixin, as shown here. We use the generic <code class="literal">DefaultPointcutAdvisor</code>, configured
using JavaBean properties:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lockMixin"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.LockMixin"</span>
        <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lockableAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.DefaultPointcutAdvisor"</span>
        <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"pointcut"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myAttributeAwarePointcut"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"advice"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"lockMixin"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"anyclass"</span> <span class="hl-attribute">...</span></pre>

<p>If the attribute aware pointcut matches any methods in the <code class="literal">anyBean</code> or other bean
definitions, the mixin will be applied. Note that both <code class="literal">lockMixin</code> and <code class="literal">lockableAdvisor</code>
definitions are prototypes. The <code class="literal">myAttributeAwarePointcut</code> pointcut can be a singleton
definition, as it doesn&#8217;t hold state for individual advised objects.</p>
</div>
</div>
<div class="section" title="32.9&nbsp;Using TargetSources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-targetsource"></a>32.9&nbsp;Using TargetSources</h2></div></div></div>

<p>Spring offers the concept of a <span class="emphasis"><em>TargetSource</em></span>, expressed in the
<code class="literal">org.springframework.aop.TargetSource</code> interface. This interface is responsible for
returning the "target object" implementing the join point. The <code class="literal">TargetSource</code>
implementation is asked for a target instance each time the AOP proxy handles a method
invocation.</p>
<p>Developers using Spring AOP don&#8217;t normally need to work directly with TargetSources, but
this provides a powerful means of supporting pooling, hot swappable and other
sophisticated targets. For example, a pooling TargetSource can return a different target
instance for each invocation, using a pool to manage instances.</p>
<p>If you do not specify a TargetSource, a default implementation is used that wraps a
local object. The same target is returned for each invocation (as you would expect).</p>
<p>Let&#8217;s look at the standard target sources provided with Spring, and how you can use them.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When using a custom target source, your target will usually need to be a prototype
rather than a singleton bean definition. This allows Spring to create a new target
instance when required.</p>
</td></tr></table></div>

<div class="section" title="32.9.1&nbsp;Hot swappable target sources"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-ts-swap"></a>32.9.1&nbsp;Hot swappable target sources</h3></div></div></div>

<p>The <code class="literal">org.springframework.aop.target.HotSwappableTargetSource</code> exists to allow the target
of an AOP proxy to be switched while allowing callers to keep their references to it.</p>
<p>Changing the target source&#8217;s target takes effect immediately. The
<code class="literal">HotSwappableTargetSource</code> is threadsafe.</p>
<p>You can change the target via the <code class="literal">swap()</code> method on HotSwappableTargetSource as follows:</p>
<pre class="programlisting">HotSwappableTargetSource swapper = (HotSwappableTargetSource) beanFactory.getBean(<span class="hl-string">"swapper"</span>);
Object oldTarget = swapper.swap(newTarget);</pre>

<p>The XML definitions required look as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"initialTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"mycompany.OldTarget"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"swapper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.HotSwappableTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"initialTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"swappable"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"swapper"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above <code class="literal">swap()</code> call changes the target of the swappable bean. Clients who hold a
reference to that bean will be unaware of the change, but will immediately start hitting
the new target.</p>
<p>Although this example doesn&#8217;t add any advice - and it&#8217;s not necessary to add advice to
use a <code class="literal">TargetSource</code> - of course any <code class="literal">TargetSource</code> can be used in conjunction with
arbitrary advice.</p>
</div>
<div class="section" title="32.9.2&nbsp;Pooling target sources"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-ts-pool"></a>32.9.2&nbsp;Pooling target sources</h3></div></div></div>

<p>Using a pooling target source provides a similar programming model to stateless session
EJBs, in which a pool of identical instances is maintained, with method invocations
going to free objects in the pool.</p>
<p>A crucial difference between Spring pooling and SLSB pooling is that Spring pooling can
be applied to any POJO. As with Spring in general, this service can be applied in a
non-invasive way.</p>
<p>Spring provides out-of-the-box support for Jakarta Commons Pool 1.3, which provides a
fairly efficient pooling implementation. You&#8217;ll need the commons-pool Jar on your
application&#8217;s classpath to use this feature. It&#8217;s also possible to subclass
<code class="literal">org.springframework.aop.target.AbstractPoolingTargetSource</code> to support any other
pooling API.</p>
<p>Sample configuration is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObjectTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyBusinessObject"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    ... properties omitted
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poolTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.CommonsPoolTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"25"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"poolTargetSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the target object - "businessObjectTarget" in the example - <span class="emphasis"><em>must</em></span> be a
prototype. This allows the <code class="literal">PoolingTargetSource</code> implementation to create new instances
of the target to grow the pool as necessary. See the Javadoc for
<code class="literal">AbstractPoolingTargetSource</code> and the concrete subclass you wish to use for information
about its properties: "maxSize" is the most basic, and always guaranteed to be present.</p>
<p>In this case, "myInterceptor" is the name of an interceptor that would need to be
defined in the same IoC context. However, it isn&#8217;t necessary to specify interceptors to
use pooling. If you want only pooling, and no other advice, don&#8217;t set the
interceptorNames property at all.</p>
<p>It&#8217;s possible to configure Spring so as to be able to cast any pooled object to the
<code class="literal">org.springframework.aop.target.PoolingConfig</code> interface, which exposes information
about the configuration and current size of the pool through an introduction. You&#8217;ll
need to define an advisor like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poolConfigAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.MethodInvokingFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetObject"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"poolTargetSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetMethod"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"getPoolingConfigMixin"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This advisor is obtained by calling a convenience method on the
<code class="literal">AbstractPoolingTargetSource</code> class, hence the use of MethodInvokingFactoryBean. This
advisor&#8217;s name ("poolConfigAdvisor" here) must be in the list of interceptors names in
the ProxyFactoryBean exposing the pooled object.</p>
<p>The cast will look as follows:</p>
<pre class="programlisting">PoolingConfig conf = (PoolingConfig) beanFactory.getBean(<span class="hl-string">"businessObject"</span>);
System.out.println(<span class="hl-string">"Max pool size is "</span> + conf.getMaxSize());</pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Pooling stateless service objects is not usually necessary. We don&#8217;t believe it should
be the default choice, as most stateless objects are naturally thread safe, and instance
pooling is problematic if resources are cached.</p>
</td></tr></table></div>

<p>Simpler pooling is available using autoproxying. It&#8217;s possible to set the TargetSources
used by any autoproxy creator.</p>
</div>
<div class="section" title="32.9.3&nbsp;Prototype target sources"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-ts-prototype"></a>32.9.3&nbsp;Prototype target sources</h3></div></div></div>

<p>Setting up a "prototype" target source is similar to a pooling TargetSource. In this
case, a new instance of the target will be created on every method invocation. Although
the cost of creating a new object isn&#8217;t high in a modern JVM, the cost of wiring up the
new object (satisfying its IoC dependencies) may be more expensive. Thus you shouldn&#8217;t
use this approach without very good reason.</p>
<p>To do this, you could modify the <code class="literal">poolTargetSource</code> definition shown above as follows.
(I&#8217;ve also changed the name, for clarity.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"prototypeTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.PrototypeTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>There&#8217;s only one property: the name of the target bean. Inheritance is used in the
TargetSource implementations to ensure consistent naming. As with the pooling target
source, the target bean must be a prototype bean definition.</p>
</div>
<div class="section" title="32.9.4&nbsp;ThreadLocal target sources"><div class="titlepage"><div><div><h3 class="title"><a name="classic-aop-ts-threadlocal"></a>32.9.4&nbsp;ThreadLocal target sources</h3></div></div></div>

<p><code class="literal">ThreadLocal</code> target sources are useful if you need an object to be created for each
incoming request (per thread that is). The concept of a <code class="literal">ThreadLocal</code> provide a JDK-wide
facility to transparently store resource alongside a thread. Setting up a
<code class="literal">ThreadLocalTargetSource</code> is pretty much the same as was explained for the other types
of target source:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"threadlocalTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.ThreadLocalTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>ThreadLocals come with serious issues (potentially resulting in memory leaks) when
incorrectly using them in a multi-threaded and multi-classloader environments. One
should always consider wrapping a threadlocal in some other class and never directly use
the <code class="literal">ThreadLocal</code> itself (except of course in the wrapper class). Also, one should
always remember to correctly set and unset (where the latter simply involved a call to
<code class="literal">ThreadLocal.set(null)</code>) the resource local to the thread. Unsetting should be done in
any case since not unsetting it might result in problematic behavior. Spring&#8217;s
ThreadLocal support does this for you and should always be considered in favor of using
ThreadLocals without other proper handling code.</p>
</td></tr></table></div>

</div>
</div>
<div class="section" title="32.10&nbsp;Defining new Advice types"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-extensibility"></a>32.10&nbsp;Defining new Advice types</h2></div></div></div>

<p>Spring AOP is designed to be extensible. While the interception implementation strategy
is presently used internally, it is possible to support arbitrary advice types in
addition to the out-of-the-box interception around advice, before, throws advice and
after returning advice.</p>
<p>The <code class="literal">org.springframework.aop.framework.adapter</code> package is an SPI package allowing
support for new custom advice types to be added without changing the core framework. The
only constraint on a custom <code class="literal">Advice</code> type is that it must implement the
<code class="literal">org.aopalliance.aop.Advice</code> tag interface.</p>
<p>Please refer to the <code class="literal">org.springframework.aop.framework.adapter</code> package&#8217;s Javadocs for
further information.</p>
</div>
<div class="section" title="32.11&nbsp;Further resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="classic-aop-api-resources"></a>32.11&nbsp;Further resources</h2></div></div></div>

<p>Please refer to the Spring sample applications for further examples of Spring AOP:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The JPetStore&#8217;s default configuration illustrates the use of the
<code class="literal">TransactionProxyFactoryBean</code> for declarative transaction management.
</li><li class="listitem">
The <code class="literal">/attributes</code> directory of the JPetStore illustrates the use of attribute-driven
declarative transaction management.
</li></ul></div>

</div>
</div>
<div class="chapter" title="33.&nbsp;XML Schema-based configuration"><div class="titlepage"><div><div><h2 class="title"><a name="xsd-config"></a>33.&nbsp;XML Schema-based configuration</h2></div></div></div>

<div class="section" title="33.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xsd-config-introduction"></a>33.1&nbsp;Introduction</h2></div></div></div>

<p>This appendix details the XML Schema-based configuration introduced in Spring 2.0 and
enhanced and extended in Spring 2.5 and 3.0.</p>
<div class="sidebar" title="DTD support?"><p class="title"><b>DTD support?</b></p>

<p>Authoring Spring configuration files using the older DTD style is still fully supported.</p>
<p>Nothing will break if you forego the use of the new XML Schema-based approach to
authoring Spring XML configuration files. All that you lose out on is the opportunity to
have more succinct and clearer configuration. Regardless of whether the XML
configuration is DTD- or Schema-based, in the end it all boils down to the same object
model in the container (namely one or more <code class="literal">BeanDefinition</code> instances).</p>
</div>

<p>The central motivation for moving to XML Schema based configuration files was to make
Spring XML configuration easier. The <span class="emphasis"><em>'classic'</em></span> <code class="literal">&lt;bean/&gt;</code>-based approach is good, but
its generic-nature comes with a price in terms of configuration overhead.</p>
<p>From the Spring IoC containers point-of-view, <span class="emphasis"><em>everything</em></span> is a bean. That&#8217;s great
news for the Spring IoC container, because if everything is a bean then everything can
be treated in the exact same fashion. The same, however, is not true from a developer&#8217;s
point-of-view. The objects defined in a Spring XML configuration file are not all
generic, vanilla beans. Usually, each bean requires some degree of specific
configuration.</p>
<p>Spring 2.0&#8217;s new XML Schema-based configuration addresses this issue. The <code class="literal">&lt;bean/&gt;</code>
element is still present, and if you wanted to, you could continue to write the <span class="emphasis"><em>exact
same</em></span> style of Spring XML configuration using only <code class="literal">&lt;bean/&gt;</code> elements. The new XML
Schema-based configuration does, however, make Spring XML configuration files
substantially clearer to read. In addition, it allows you to express the intent of a
bean definition.</p>
<p>The key thing to remember is that the new custom tags work best for infrastructure or
integration beans: for example, AOP, collections, transactions, integration with
3rd-party frameworks such as Mule, etc., while the existing bean tags are best suited to
application-specific beans, such as DAOs, service layer objects, validators, etc.</p>
<p>The examples included below will hopefully convince you that the inclusion of XML Schema
support in Spring 2.0 was a good idea. The reception in the community has been
encouraging; also, please note the fact that this new configuration mechanism is totally
customisable and extensible. This means you can write your own domain-specific
configuration tags that would better represent your application&#8217;s domain; the process
involved in doing so is covered in the appendix entitled <a class="xref" href="#extensible-xml" title="34.&nbsp;Extensible XML authoring">Chapter&nbsp;34, <i>Extensible XML authoring</i></a>.</p>
</div>
<div class="section" title="33.2&nbsp;XML Schema-based configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xsd-config-body"></a>33.2&nbsp;XML Schema-based configuration</h2></div></div></div>

<div class="section" title="33.2.1&nbsp;Referencing the schemas"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-referencing"></a>33.2.1&nbsp;Referencing the schemas</h3></div></div></div>

<p>To switch over from the DTD-style to the new XML Schema-style, you need to make the
following change.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<b class="hl-tag" style="color: blue">&lt;!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN 2.0//EN"
        "http://www.springframework.org/dtd/spring-beans-2.0.dtd"&gt;</b>

<span class="hl-tag">&lt;beans&gt;</span>

<span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The equivalent file in the XML Schema-style would be&#8230;</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">'xsi:schemaLocation'</code> fragment is not actually required, but can be included to
reference a local copy of a schema (which can be useful during development).</p>
</td></tr></table></div>

<p>The above Spring XML configuration fragment is boilerplate that you can copy and paste
(!) and then plug <code class="literal">&lt;bean/&gt;</code> definitions into like you have always done. However, the
entire point of switching over is to take advantage of the new Spring 2.0 XML tags since
they make configuration easier. The section entitled <a class="xref" href="#xsd-config-body-schemas-util" title="33.2.2&nbsp;the util schema">Section&nbsp;33.2.2, &#8220;the util schema&#8221;</a>
demonstrates how you can start immediately by using some of the more common utility tags.</p>
<p>The rest of this chapter is devoted to showing examples of the new Spring XML Schema
based configuration, with at least one example for every new tag. The format follows a
before and after style, with a <span class="emphasis"><em>before</em></span> snippet of XML showing the old (but still 100%
legal and supported) style, followed immediately by an <span class="emphasis"><em>after</em></span> example showing the
equivalent in the new XML Schema-based style.</p>
</div>
<div class="section" title="33.2.2&nbsp;the util schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-util"></a>33.2.2&nbsp;the util schema</h3></div></div></div>

<p>First up is coverage of the <code class="literal">util</code> tags. As the name implies, the <code class="literal">util</code> tags deal with
common, <span class="emphasis"><em>utility</em></span> configuration issues, such as configuring collections, referencing
constants, and suchlike.</p>
<p>To use the tags in the <code class="literal">util</code> schema, you need to have the following preamble at the top
of your Spring XML configuration file; the text in the snippet below references the
correct schema so that the tags in the <code class="literal">util</code> namespace are available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="emphasis"><em>xmlns:util="http://www.springframework.org/schema/util"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"</em></span>&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="section" title="<util:constant/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-util-constant"></a>&lt;util:constant/&gt;</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"..."</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"isolation"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"java.sql.Connection.TRANSACTION_SERIALIZABLE"</span>
                <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.FieldRetrievingFactoryBean"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above configuration uses a Spring <code class="literal">FactoryBean</code> implementation, the
<code class="literal">FieldRetrievingFactoryBean</code>, to set the value of the <code class="literal">'isolation'</code> property on a bean
to the value of the <code class="literal">'java.sql.Connection.TRANSACTION_SERIALIZABLE'</code> constant. This is
all well and good, but it is a tad verbose and (unnecessarily) exposes Spring&#8217;s internal
plumbing to the end user.</p>
<p>The following XML Schema-based version is more concise and clearly expresses the
developer&#8217;s intent (<span class="emphasis"><em>'inject this constant value'</em></span>), and it just reads better.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"..."</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"isolation"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;util:constant</span> <span class="hl-attribute">static-field</span>=<span class="hl-value">"java.sql.Connection.TRANSACTION_SERIALIZABLE"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="section" title="Setting a bean property or constructor arg from a field value"><div class="titlepage"><div><div><h5 class="title"><a name="xsd-config-body-schemas-util-frfb"></a>Setting a bean property or constructor arg from a field value</h5></div></div></div>

<p><a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/config/FieldRetrievingFactoryBean.html" target="_top"><code class="literal">FieldRetrievingFactoryBean</code></a>
is a <code class="literal">FactoryBean</code> which retrieves a <code class="literal">static</code> or non-static field value. It is typically
used for retrieving <code class="literal">public</code> <code class="literal">static</code> <code class="literal">final</code> constants, which may then be used to set a
property value or constructor arg for another bean.</p>
<p>Find below an example which shows how a <code class="literal">static</code> field is exposed, by using the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/config/FieldRetrievingFactoryBean.html#setStaticField(java.lang.String)" target="_top"><code class="literal">staticField</code></a>
property:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myField"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.FieldRetrievingFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"staticField"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"java.sql.Connection.TRANSACTION_SERIALIZABLE"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>There is also a convenience usage form where the <code class="literal">static</code> field is specified as the bean
name:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"java.sql.Connection.TRANSACTION_SERIALIZABLE"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.FieldRetrievingFactoryBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>This does mean that there is no longer any choice in what the bean id is (so any other
bean that refers to it will also have to use this longer name), but this form is very
concise to define, and very convenient to use as an inner bean since the id doesn&#8217;t have
to be specified for the bean reference:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"..."</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"isolation"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"java.sql.Connection.TRANSACTION_SERIALIZABLE"</span>
                <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.FieldRetrievingFactoryBean"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>It is also possible to access a non-static (instance) field of another bean, as
described in the API documentation for the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/config/FieldRetrievingFactoryBean.html" target="_top"><code class="literal">FieldRetrievingFactoryBean</code></a>
class.</p>
<p>Injecting enum values into beans as either property or constructor arguments is very
easy to do in Spring, in that you don&#8217;t actually have to <span class="emphasis"><em>do</em></span> anything or know
anything about the Spring internals (or even about classes such as the
<code class="literal">FieldRetrievingFactoryBean</code>). Let&#8217;s look at an example to see how easy injecting an
enum value is; consider this JDK 5 enum:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> javax.persistence;

<span class="hl-keyword">public</span> enum PersistenceContextType {

    TRANSACTION,
    EXTENDED

}</pre>

<p>Now consider a setter of type <code class="literal">PersistenceContextType</code>:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> example;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Client {

    <span class="hl-keyword">private</span> PersistenceContextType persistenceContextType;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPersistenceContextType(PersistenceContextType type) {
        <span class="hl-keyword">this</span>.persistenceContextType = type;
    }

}</pre>

<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
and the corresponding bean definition:
</li></ol></div>

<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.Client"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceContextType"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TRANSACTION"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This works for classic type-safe emulated enums (on JDK 1.4 and JDK 1.3) as well; Spring
will automatically attempt to match the string property value to a constant on the enum
class.</p>
</div>
</div>
<div class="section" title="<util:property-path/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-util-property-path"></a>&lt;util:property-path/&gt;</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- target bean to be referenced by name --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.TestBean"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"spouse"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.TestBean"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"11"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-comment">&lt;!-- will result in 10, which is the value of property </span><span class="emphasis"><em>age</em></span> of bean <span class="emphasis"><em>testBean</em></span> --&gt;
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean.age"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertyPathFactoryBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>The above configuration uses a Spring <code class="literal">FactoryBean</code> implementation, the
<code class="literal">PropertyPathFactoryBean</code>, to create a bean (of type <code class="literal">int</code>) called <code class="literal">'testBean.age'</code> that
has a value equal to the <code class="literal">'age'</code> property of the <code class="literal">'testBean'</code> bean.</p>
<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- target bean to be referenced by name --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.TestBean"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"spouse"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.TestBean"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"11"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-comment">&lt;!-- will result in 10, which is the value of property </span><span class="emphasis"><em>age</em></span> of bean <span class="emphasis"><em>testBean</em></span> --&gt;
<span class="hl-tag">&lt;util:property-path</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">path</span>=<span class="hl-value">"testBean.age"</span><span class="hl-tag">/&gt;</span></pre>

<p>The value of the <code class="literal">'path'</code> attribute of the <code class="literal">&lt;property-path/&gt;</code> tag follows the form
<code class="literal">'beanName.beanProperty'</code>.</p>
<div class="section" title="Using <util:property-path/&gt; to set a bean property or constructor-argument"><div class="titlepage"><div><div><h5 class="title"><a name="xsd-config-body-schemas-util-property-path-dependency"></a>Using &lt;util:property-path/&gt; to set a bean property or constructor-argument</h5></div></div></div>

<p><code class="literal">PropertyPathFactoryBean</code> is a <code class="literal">FactoryBean</code> that evaluates a property path on a given
target object. The target object can be specified directly or via a bean name. This
value may then be used in another bean definition as a property value or constructor
argument.</p>
<p>Here&#8217;s an example where a path is used against another bean, by name:</p>
<pre class="programlisting">// target bean to be referenced by name
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.TestBean"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"spouse"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.TestBean"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"11"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

// will result in 11, which is the value of property <span class="emphasis"><em>spouse.age</em></span> of bean <span class="emphasis"><em>person</em></span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"theAge"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertyPathFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"person"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"propertyPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"spouse.age"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>In this example, a path is evaluated against an inner bean:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- will result in 12, which is the value of property </span><span class="emphasis"><em>age</em></span> of the inner bean --&gt;
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"theAge"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertyPathFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetObject"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.TestBean"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"12"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"propertyPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"age"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>There is also a shortcut form, where the bean name is the property path.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- will result in 10, which is the value of property </span><span class="emphasis"><em>age</em></span> of bean <span class="emphasis"><em>person</em></span> --&gt;
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person.age"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertyPathFactoryBean"</span><span class="hl-tag">/&gt;</span></pre>

<p>This form does mean that there is no choice in the name of the bean. Any reference to it
will also have to use the same id, which is the path. Of course, if used as an inner
bean, there is no need to refer to it at all:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"..."</span> <span class="hl-attribute">class</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person.age"</span>
                <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertyPathFactoryBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The result type may be specifically set in the actual definition. This is not necessary
for most use cases, but can be of use for some. Please see the Javadocs for more info on
this feature.</p>
</div>
</div>
<div class="section" title="<util:properties/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-util-properties"></a>&lt;util:properties/&gt;</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- creates a java.util.Properties instance with values loaded from the supplied location --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jdbcConfiguration"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.PropertiesFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"location"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:com/foo/jdbc-production.properties"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above configuration uses a Spring <code class="literal">FactoryBean</code> implementation, the
<code class="literal">PropertiesFactoryBean</code>, to instantiate a <code class="literal">java.util.Properties</code> instance with values
loaded from the supplied <a class="link" href="#resources" title="5.&nbsp;Resources"><code class="literal">Resource</code></a> location).</p>
<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- creates a java.util.Properties instance with values loaded from the supplied location --&gt;</span>
<span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jdbcConfiguration"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/foo/jdbc-production.properties"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="<util:list/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-util-list"></a>&lt;util:list/&gt;</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- creates a java.util.List instance with values loaded from the supplied </span><span class="emphasis"><em>sourceList</em></span> --&gt;
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.ListFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sourceList"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>pechorin@hero.org<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>raskolnikov@slums.org<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>stavrogin@gov.org<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>porfiry@gov.org<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above configuration uses a Spring <code class="literal">FactoryBean</code> implementation, the
<code class="literal">ListFactoryBean</code>, to create a <code class="literal">java.util.List</code> instance initialized with values taken
from the supplied <code class="literal">'sourceList'</code>.</p>
<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- creates a java.util.List instance with the supplied values --&gt;</span>
<span class="hl-tag">&lt;util:list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>pechorin@hero.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>raskolnikov@slums.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>stavrogin@gov.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>porfiry@gov.org<span class="hl-tag">&lt;/value&gt;</span>
<span class="hl-tag">&lt;/util:list&gt;</span></pre>

<p>You can also explicitly control the exact type of <code class="literal">List</code> that will be instantiated and
populated via the use of the <code class="literal">'list-class'</code> attribute on the <code class="literal">&lt;util:list/&gt;</code> element. For
example, if we really need a <code class="literal">java.util.LinkedList</code> to be instantiated, we could use the
following configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;util:list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span> <span class="hl-attribute">list-class</span>=<span class="hl-value">"java.util.LinkedList"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>jackshaftoe@vagabond.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>eliza@thinkingmanscrumpet.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>vanhoek@pirate.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>d'Arcachon@nemesis.org<span class="hl-tag">&lt;/value&gt;</span>
<span class="hl-tag">&lt;/util:list&gt;</span></pre>

<p>If no <code class="literal">'list-class'</code> attribute is supplied, a <code class="literal">List</code> implementation will be chosen by
the container.</p>
</div>
<div class="section" title="<util:map/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-util-map"></a>&lt;util:map/&gt;</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- creates a java.util.Map instance with values loaded from the supplied </span><span class="emphasis"><em>sourceMap</em></span> --&gt;
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.MapFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sourceMap"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"pechorin"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"pechorin@hero.org"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"raskolnikov"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"raskolnikov@slums.org"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"stavrogin"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"stavrogin@gov.org"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"porfiry"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"porfiry@gov.org"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above configuration uses a Spring <code class="literal">FactoryBean</code> implementation, the
<code class="literal">MapFactoryBean</code>, to create a <code class="literal">java.util.Map</code> instance initialized with key-value pairs
taken from the supplied <code class="literal">'sourceMap'</code>.</p>
<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- creates a java.util.Map instance with the supplied key-value pairs --&gt;</span>
<span class="hl-tag">&lt;util:map</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"pechorin"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"pechorin@hero.org"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"raskolnikov"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"raskolnikov@slums.org"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"stavrogin"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"stavrogin@gov.org"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"porfiry"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"porfiry@gov.org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/util:map&gt;</span></pre>

<p>You can also explicitly control the exact type of <code class="literal">Map</code> that will be instantiated and
populated via the use of the <code class="literal">'map-class'</code> attribute on the <code class="literal">&lt;util:map/&gt;</code> element. For
example, if we really need a <code class="literal">java.util.TreeMap</code> to be instantiated, we could use the
following configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;util:map</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span> <span class="hl-attribute">map-class</span>=<span class="hl-value">"java.util.TreeMap"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"pechorin"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"pechorin@hero.org"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"raskolnikov"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"raskolnikov@slums.org"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"stavrogin"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"stavrogin@gov.org"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"porfiry"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"porfiry@gov.org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/util:map&gt;</span></pre>

<p>If no <code class="literal">'map-class'</code> attribute is supplied, a <code class="literal">Map</code> implementation will be chosen by the
container.</p>
</div>
<div class="section" title="<util:set/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-util-set"></a>&lt;util:set/&gt;</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- creates a java.util.Set instance with values loaded from the supplied </span><span class="emphasis"><em>sourceSet</em></span> --&gt;
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.SetFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sourceSet"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;set&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>pechorin@hero.org<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>raskolnikov@slums.org<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>stavrogin@gov.org<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>porfiry@gov.org<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/set&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above configuration uses a Spring <code class="literal">FactoryBean</code> implementation, the
<code class="literal">SetFactoryBean</code>, to create a <code class="literal">java.util.Set</code> instance initialized with values taken
from the supplied <code class="literal">'sourceSet'</code>.</p>
<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- creates a java.util.Set instance with the supplied values --&gt;</span>
<span class="hl-tag">&lt;util:set</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>pechorin@hero.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>raskolnikov@slums.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>stavrogin@gov.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>porfiry@gov.org<span class="hl-tag">&lt;/value&gt;</span>
<span class="hl-tag">&lt;/util:set&gt;</span></pre>

<p>You can also explicitly control the exact type of <code class="literal">Set</code> that will be instantiated and
populated via the use of the <code class="literal">'set-class'</code> attribute on the <code class="literal">&lt;util:set/&gt;</code> element. For
example, if we really need a <code class="literal">java.util.TreeSet</code> to be instantiated, we could use the
following configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;util:set</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emails"</span> <span class="hl-attribute">set-class</span>=<span class="hl-value">"java.util.TreeSet"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>pechorin@hero.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>raskolnikov@slums.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>stavrogin@gov.org<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>porfiry@gov.org<span class="hl-tag">&lt;/value&gt;</span>
<span class="hl-tag">&lt;/util:set&gt;</span></pre>

<p>If no <code class="literal">'set-class'</code> attribute is supplied, a <code class="literal">Set</code> implementation will be chosen by the
container.</p>
</div>
</div>
<div class="section" title="33.2.3&nbsp;the jee schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-jee"></a>33.2.3&nbsp;the jee schema</h3></div></div></div>

<p>The <code class="literal">jee</code> tags deal with Java EE (Java Enterprise Edition)-related configuration issues,
such as looking up a JNDI object and defining EJB references.</p>
<p>To use the tags in the <code class="literal">jee</code> schema, you need to have the following preamble at the top
of your Spring XML configuration file; the text in the following snippet references the
correct schema so that the tags in the <code class="literal">jee</code> namespace are available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="emphasis"><em>xmlns:jee="http://www.springframework.org/schema/jee"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee.xsd"</em></span>&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="section" title="<jee:jndi-lookup/&gt; (simple)"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-jee-jndi-lookup"></a>&lt;jee:jndi-lookup/&gt; (simple)</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"</span><span class="strong"><strong>dataSource</strong></span>" class="org.springframework.jndi.JndiObjectFactoryBean"&gt;
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc/MyDataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.JdbcUserDao"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- Spring will do the cast automatically (as usual) --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"</span><span class="strong"><strong>dataSource</strong></span>"/&gt;
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"</span><span class="strong"><strong>dataSource</strong></span>" jndi-name="jdbc/MyDataSource"/&gt;

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.JdbcUserDao"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- Spring will do the cast automatically (as usual) --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"</span><span class="strong"><strong>dataSource</strong></span>"/&gt;
<span class="hl-tag">&lt;/bean&gt;</span></pre>

</div>
<div class="section" title="<jee:jndi-lookup/&gt; (with single JNDI environment setting)"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-jee-jndi-lookup-environment-single"></a>&lt;jee:jndi-lookup/&gt; (with single JNDI environment setting)</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simple"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jndi.JndiObjectFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc/MyDataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiEnvironment"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"foo"</span><span class="hl-tag">&gt;</span>bar<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simple"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"jdbc/MyDataSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;jee:environment&gt;</span>foo=bar<span class="hl-tag">&lt;/jee:environment&gt;</span>
<span class="hl-tag">&lt;/jee:jndi-lookup&gt;</span></pre>

</div>
<div class="section" title="<jee:jndi-lookup/&gt; (with multiple JNDI environment settings)"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-jee-jndi-lookup-evironment-multiple"></a>&lt;jee:jndi-lookup/&gt; (with multiple JNDI environment settings)</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simple"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jndi.JndiObjectFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc/MyDataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiEnvironment"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"foo"</span><span class="hl-tag">&gt;</span>bar<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ping"</span><span class="hl-tag">&gt;</span>pong<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simple"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"jdbc/MyDataSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- newline-separated, key-value pairs for the environment (standard Properties format) --&gt;</span>
    <span class="hl-tag">&lt;jee:environment&gt;</span>
        foo=bar
        ping=pong
    <span class="hl-tag">&lt;/jee:environment&gt;</span>
<span class="hl-tag">&lt;/jee:jndi-lookup&gt;</span></pre>

</div>
<div class="section" title="<jee:jndi-lookup/&gt; (complex)"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-jee-jndi-lookup-complex"></a>&lt;jee:jndi-lookup/&gt; (complex)</h4></div></div></div>

<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simple"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jndi.JndiObjectFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc/MyDataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cache"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceRef"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lookupOnStartup"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"expectedType"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.myapp.DefaultFoo"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.myapp.Foo"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simple"</span>
        <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"jdbc/MyDataSource"</span>
        <span class="hl-attribute">cache</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">resource-ref</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">lookup-on-startup</span>=<span class="hl-value">"false"</span>
        <span class="hl-attribute">expected-type</span>=<span class="hl-value">"com.myapp.DefaultFoo"</span>
        <span class="hl-attribute">proxy-interface</span>=<span class="hl-value">"com.myapp.Foo"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="<jee:local-slsb/&gt; (simple)"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-jee-local-slsb"></a>&lt;jee:local-slsb/&gt; (simple)</h4></div></div></div>

<p>The <code class="literal">&lt;jee:local-slsb/&gt;</code> tag configures a reference to an EJB Stateless SessionBean.</p>
<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simple"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.ejb.access.LocalStatelessSessionProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ejb/RentalServiceBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"businessInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.foo.service.RentalService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:local-slsb</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleSlsb"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"ejb/RentalServiceBean"</span>
        <span class="hl-attribute">business-interface</span>=<span class="hl-value">"com.foo.service.RentalService"</span><span class="hl-tag">/&gt;</span></pre>

</div>
<div class="section" title="<jee:local-slsb/&gt; (complex)"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-jee-local-slsb-complex"></a>&lt;jee:local-slsb/&gt; (complex)</h4></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"complexLocalEjb"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.ejb.access.LocalStatelessSessionProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ejb/RentalServiceBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"businessInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.foo.service.RentalService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheHome"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lookupHomeOnStartup"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceRef"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:local-slsb</span> <span class="hl-attribute">id</span>=<span class="hl-value">"complexLocalEjb"</span>
        <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"ejb/RentalServiceBean"</span>
        <span class="hl-attribute">business-interface</span>=<span class="hl-value">"com.foo.service.RentalService"</span>
        <span class="hl-attribute">cache-home</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">lookup-home-on-startup</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">resource-ref</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span></pre>

</div>
<div class="section" title="<jee:remote-slsb/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-jee-remote-slsb"></a>&lt;jee:remote-slsb/&gt;</h4></div></div></div>

<p>The <code class="literal">&lt;jee:remote-slsb/&gt;</code> tag configures a reference to a <code class="literal">remote</code> EJB Stateless
SessionBean.</p>
<p>Before&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"complexRemoteEjb"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.ejb.access.SimpleRemoteStatelessSessionProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jndiName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ejb/MyRemoteBean"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"businessInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.foo.service.RentalService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheHome"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lookupHomeOnStartup"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceRef"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"homeInterface"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.foo.service.RentalService"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"refreshHomeOnConnectFailure"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>After&#8230;</p>
<pre class="programlisting"><span class="hl-tag">&lt;jee:remote-slsb</span> <span class="hl-attribute">id</span>=<span class="hl-value">"complexRemoteEjb"</span>
        <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"ejb/MyRemoteBean"</span>
        <span class="hl-attribute">business-interface</span>=<span class="hl-value">"com.foo.service.RentalService"</span>
        <span class="hl-attribute">cache-home</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">lookup-home-on-startup</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">resource-ref</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">home-interface</span>=<span class="hl-value">"com.foo.service.RentalService"</span>
        <span class="hl-attribute">refresh-home-on-connect-failure</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span></pre>

</div>
</div>
<div class="section" title="33.2.4&nbsp;the lang schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-lang"></a>33.2.4&nbsp;the lang schema</h3></div></div></div>

<p>The <code class="literal">lang</code> tags deal with exposing objects that have been written in a dynamic language
such as JRuby or Groovy as beans in the Spring container.</p>
<p>These tags (and the dynamic language support) are comprehensively covered in the chapter
entitled <a class="xref" href="#dynamic-language" title="28.&nbsp;Dynamic language support">Chapter&nbsp;28, <i>Dynamic language support</i></a>. Please do consult that chapter for full details on this
support and the <code class="literal">lang</code> tags themselves.</p>
<p>In the interest of completeness, to use the tags in the <code class="literal">lang</code> schema, you need to have
the following preamble at the top of your Spring XML configuration file; the text in the
following snippet references the correct schema so that the tags in the <code class="literal">lang</code> namespace
are available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="emphasis"><em>xmlns:lang="http://www.springframework.org/schema/lang"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang.xsd"</em></span>&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="33.2.5&nbsp;the jms schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-jms"></a>33.2.5&nbsp;the jms schema</h3></div></div></div>

<p>The <code class="literal">jms</code> tags deal with configuring JMS-related beans such as Spring&#8217;s
<a class="link" href="#jms-mdp" title="23.2.4&nbsp;Message Listener Containers">MessageListenerContainers</a>. These tags are detailed in the section of the
<a class="link" href="#jms" title="23.&nbsp;JMS (Java Message Service)">JMS chapter</a> entitled <a class="xref" href="#jms-namespace" title="23.6&nbsp;JMS Namespace Support">Section&nbsp;23.6, &#8220;JMS Namespace Support&#8221;</a>. Please do consult that chapter for full
details on this support and the <code class="literal">jms</code> tags themselves.</p>
<p>In the interest of completeness, to use the tags in the <code class="literal">jms</code> schema, you need to have
the following preamble at the top of your Spring XML configuration file; the text in the
following snippet references the correct schema so that the tags in the <code class="literal">jms</code> namespace
are available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="emphasis"><em>xmlns:jms="http://www.springframework.org/schema/jms"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms.xsd"</em></span>&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="33.2.6&nbsp;the tx (transaction) schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-tx"></a>33.2.6&nbsp;the tx (transaction) schema</h3></div></div></div>

<p>The <code class="literal">tx</code> tags deal with configuring all of those beans in Spring&#8217;s comprehensive support
for transactions. These tags are covered in the chapter entitled <a class="xref" href="#transaction" title="11.&nbsp;Transaction Management">Chapter&nbsp;11, <i>Transaction Management</i></a>.</p>
<div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>You are strongly encouraged to look at the <code class="literal">'spring-tx.xsd'</code> file that ships with the
Spring distribution. This file is (of course), the XML Schema for Spring&#8217;s transaction
configuration, and covers all of the various tags in the <code class="literal">tx</code> namespace, including
attribute defaults and suchlike. This file is documented inline, and thus the
information is not repeated here in the interests of adhering to the DRY (Don&#8217;t Repeat
Yourself) principle.</p>
</td></tr></table></div>

<p>In the interest of completeness, to use the tags in the <code class="literal">tx</code> schema, you need to have
the following preamble at the top of your Spring XML configuration file; the text in the
following snippet references the correct schema so that the tags in the <code class="literal">tx</code> namespace
are available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
        <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
        <span class="emphasis"><em>xmlns:tx="http://www.springframework.org/schema/tx"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd</em></span>
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd"&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Often when using the tags in the <code class="literal">tx</code> namespace you will also be using the tags from the
<code class="literal">aop</code> namespace (since the declarative transaction support in Spring is implemented
using AOP). The above XML snippet contains the relevant lines needed to reference the
<code class="literal">aop</code> schema so that the tags in the <code class="literal">aop</code> namespace are available to you.</p>
</td></tr></table></div>

</div>
<div class="section" title="33.2.7&nbsp;the aop schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-aop"></a>33.2.7&nbsp;the aop schema</h3></div></div></div>

<p>The <code class="literal">aop</code> tags deal with configuring all things AOP in Spring: this includes Spring&#8217;s
own proxy-based AOP framework and Spring&#8217;s integration with the AspectJ AOP framework.
These tags are comprehensively covered in the chapter entitled <a class="xref" href="#aop" title="8.&nbsp;Aspect Oriented Programming with Spring">Chapter&nbsp;8, <i>Aspect Oriented Programming with Spring</i></a>.</p>
<p>In the interest of completeness, to use the tags in the <code class="literal">aop</code> schema, you need to have
the following preamble at the top of your Spring XML configuration file; the text in the
following snippet references the correct schema so that the tags in the <code class="literal">aop</code> namespace
are available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="emphasis"><em>xmlns:aop="http://www.springframework.org/schema/aop"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd"</em></span>&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="33.2.8&nbsp;the context schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-context"></a>33.2.8&nbsp;the context schema</h3></div></div></div>

<p>The <code class="literal">context</code> tags deal with <code class="literal">ApplicationContext</code> configuration that relates to plumbing
- that is, not usually beans that are important to an end-user but rather beans that do
a lot of grunt work in Spring, such as <code class="literal">BeanfactoryPostProcessors</code>. The following
snippet references the correct schema so that the tags in the <code class="literal">context</code> namespace are
available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="emphasis"><em>xmlns:context="http://www.springframework.org/schema/context"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"</em></span>&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">context</code> schema was only introduced in Spring 2.5.</p>
</td></tr></table></div>

<div class="section" title="<property-placeholder/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-context-pphc"></a>&lt;property-placeholder/&gt;</h4></div></div></div>

<p>This element activates the replacement of <code class="literal">${...}</code> placeholders, resolved against the
specified properties file (as a <a class="link" href="#resources" title="5.&nbsp;Resources">Spring resource location</a>). This element is
a convenience mechanism that sets up a<a class="link" href="#beans-factory-placeholderconfigurer" title="Example: the Class name substitution PropertyPlaceholderConfigurer"><code class="literal">PropertyPlaceholderConfigurer</code></a> for you; if you need more control over the
<code class="literal">PropertyPlaceholderConfigurer</code>, just define one yourself explicitly.</p>
</div>
<div class="section" title="<annotation-config/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-context-ac"></a>&lt;annotation-config/&gt;</h4></div></div></div>

<p>Activates the Spring infrastructure for various annotations to be detected in bean
classes: Spring&#8217;s <a class="link" href="#beans-required-annotation" title="4.9.1&nbsp;@Required"><code class="literal">@Required</code></a> and
<a class="link" href="#beans-annotation-config" title="4.9&nbsp;Annotation-based container configuration"><code class="literal">@Autowired</code></a>, as well as JSR 250&#8217;s <code class="literal">@PostConstruct</code>,
<code class="literal">@PreDestroy</code> and <code class="literal">@Resource</code> (if available), and JPA&#8217;s <code class="literal">@PersistenceContext</code> and
<code class="literal">@PersistenceUnit</code> (if available). Alternatively, you can choose to activate the
individual <code class="literal">BeanPostProcessors</code> for those annotations explicitly.</p>
<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This element does <span class="emphasis"><em>not</em></span> activate processing of Spring&#8217;s
<a class="link" href="#transaction-declarative-annotations" title="11.5.6&nbsp;Using @Transactional"><code class="literal">@Transactional</code></a> annotation. Use the
<a class="link" href="#tx-decl-explained" title="11.5.1&nbsp;Understanding the Spring Framework&#8217;s declarative transaction implementation"><code class="literal">&lt;tx:annotation-driven/&gt;</code></a> element for that purpose.</p>
</td></tr></table></div>

</div>
<div class="section" title="<component-scan/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-context-component-scan"></a>&lt;component-scan/&gt;</h4></div></div></div>

<p>This element is detailed in <a class="xref" href="#beans-annotation-config" title="4.9&nbsp;Annotation-based container configuration">Section&nbsp;4.9, &#8220;Annotation-based container configuration&#8221;</a>.</p>
</div>
<div class="section" title="<load-time-weaver/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-context-ltw"></a>&lt;load-time-weaver/&gt;</h4></div></div></div>

<p>This element is detailed in <a class="xref" href="#aop-aj-ltw" title="8.8.4&nbsp;Load-time weaving with AspectJ in the Spring Framework">Section&nbsp;8.8.4, &#8220;Load-time weaving with AspectJ in the Spring Framework&#8221;</a>.</p>
</div>
<div class="section" title="<spring-configured/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-context-sc"></a>&lt;spring-configured/&gt;</h4></div></div></div>

<p>This element is detailed in <a class="xref" href="#aop-atconfigurable" title="8.8.1&nbsp;Using AspectJ to dependency inject domain objects with Spring">Section&nbsp;8.8.1, &#8220;Using AspectJ to dependency inject domain objects with Spring&#8221;</a>.</p>
</div>
<div class="section" title="<mbean-export/&gt;"><div class="titlepage"><div><div><h4 class="title"><a name="xsd-config-body-schemas-context-mbe"></a>&lt;mbean-export/&gt;</h4></div></div></div>

<p>This element is detailed in <a class="xref" href="#jmx-context-mbeanexport" title="24.4.3&nbsp;Configuring annotation based MBean export">Section&nbsp;24.4.3, &#8220;Configuring annotation based MBean export&#8221;</a>.</p>
</div>
</div>
<div class="section" title="33.2.9&nbsp;the tool schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-tool"></a>33.2.9&nbsp;the tool schema</h3></div></div></div>

<p>The <code class="literal">tool</code> tags are for use when you want to add tooling-specific metadata to your
custom configuration elements. This metadata can then be consumed by tools that are
aware of this metadata, and the tools can then do pretty much whatever they want with it
(validation, etc.).</p>
<p>The <code class="literal">tool</code> tags are not documented in this release of Spring as they are currently
undergoing review. If you are a third party tool vendor and you would like to contribute
to this review process, then do mail the Spring mailing list. The currently supported
<code class="literal">tool</code> tags can be found in the file <code class="literal">'spring-tool.xsd'</code> in the
<code class="literal">'src/org/springframework/beans/factory/xml'</code> directory of the Spring source
distribution.</p>
</div>
<div class="section" title="33.2.10&nbsp;the jdbc schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-jdbc"></a>33.2.10&nbsp;the jdbc schema</h3></div></div></div>

<p>The <code class="literal">jdbc</code> tags allow you to quickly configure an embedded database or initialize an
existing data source. These tags are documented in <a class="xref" href="#jdbc-embedded-database-support" title="13.8&nbsp;Embedded database support">Section&nbsp;13.8, &#8220;Embedded database support&#8221;</a>
and <a class="xref" href="#jdbc-intializing-datasource" title="13.9&nbsp;Initializing a DataSource">Section&nbsp;13.9, &#8220;Initializing a DataSource&#8221;</a> respectively.</p>
<p>To use the tags in the <code class="literal">jdbc</code> schema, you need to have the following preamble at the top
of your Spring XML configuration file; the text in the following snippet references the
correct schema so that the tags in the <code class="literal">jdbc</code> namespace are available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="emphasis"><em>xmlns:jdbc="http://www.springframework.org/schema/jdbc"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd"</em></span>&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="33.2.11&nbsp;the cache schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-cache"></a>33.2.11&nbsp;the cache schema</h3></div></div></div>

<p>The <code class="literal">cache</code> tags can be used to enable support for Spring&#8217;s <code class="literal">@CacheEvict</code>, <code class="literal">@CachePut</code>
and <code class="literal">@Caching</code> annotations. It it also supports declarative XML-based caching. See
<a class="xref" href="#cache-annotation-enable" title="29.3.5&nbsp;Enable caching annotations">Section&nbsp;29.3.5, &#8220;Enable caching annotations&#8221;</a> and <a class="xref" href="#cache-declarative-xml" title="29.4&nbsp;Declarative XML-based caching">Section&nbsp;29.4, &#8220;Declarative XML-based caching&#8221;</a> for details.</p>
<p>To use the tags in the <code class="literal">cache</code> schema, you need to have the following preamble at the
top of your Spring XML configuration file; the text in the following snippet references
the correct schema so that the tags in the <code class="literal">cache</code> namespace are available to you.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="emphasis"><em>xmlns:jdbc="http://www.springframework.org/schema/cache"</em></span> xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        <span class="emphasis"><em>http://www.springframework.org/schema/cache http://www.springframework.org/schema/jdbc/spring-cache.xsd"</em></span>&gt; <span class="hl-comment">&lt;!-- bean definitions here --&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="33.2.12&nbsp;the beans schema"><div class="titlepage"><div><div><h3 class="title"><a name="xsd-config-body-schemas-beans"></a>33.2.12&nbsp;the beans schema</h3></div></div></div>

<p>Last but not least we have the tags in the <code class="literal">beans</code> schema. These are the same tags that
have been in Spring since the very dawn of the framework. Examples of the various tags
in the <code class="literal">beans</code> schema are not shown here because they are quite comprehensively covered
in <a class="xref" href="#beans-factory-properties-detailed" title="4.4.2&nbsp;Dependencies and configuration in detail">Section&nbsp;4.4.2, &#8220;Dependencies and configuration in detail&#8221;</a> (and indeed in that entire <a class="link" href="#beans" title="4.&nbsp;The IoC container">chapter</a>).</p>
<p>One thing that is new to the beans tags themselves in Spring 2.0 is the idea of
arbitrary bean metadata. In Spring 2.0 it is now possible to add zero or more key /
value pairs to <code class="literal">&lt;bean/&gt;</code> XML definitions. What, if anything, is done with this extra
metadata is totally up to your own custom logic (and so is typically only of use if you
are writing your own custom tags as described in the appendix entitled
<a class="xref" href="#extensible-xml" title="34.&nbsp;Extensible XML authoring">Chapter&nbsp;34, <i>Extensible XML authoring</i></a>).</p>
<p>Find below an example of the <code class="literal">&lt;meta/&gt;</code> tag in the context of a surrounding <code class="literal">&lt;bean/&gt;</code>
(please note that without any logic to interpret it the metadata is effectively useless
as-is).</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x.y.Foo"</span><span class="hl-tag">&gt;</span>
        <span class="emphasis"><em>&lt;meta key="cacheName" value="foo"/&gt;</em></span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Rick"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>In the case of the above example, you would assume that there is some logic that will
consume the bean definition and set up some caching infrastructure using the supplied
metadata.</p>
</div>
</div>
</div>
<div class="chapter" title="34.&nbsp;Extensible XML authoring"><div class="titlepage"><div><div><h2 class="title"><a name="extensible-xml"></a>34.&nbsp;Extensible XML authoring</h2></div></div></div>

<div class="section" title="34.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extensible-xml-introduction"></a>34.1&nbsp;Introduction</h2></div></div></div>

<p>Since version 2.0, Spring has featured a mechanism for schema-based extensions to the
basic Spring XML format for defining and configuring beans. This section is devoted to
detailing how you would go about writing your own custom XML bean definition parsers and
integrating such parsers into the Spring IoC container.</p>
<p>To facilitate the authoring of configuration files using a schema-aware XML editor,
Spring&#8217;s extensible XML configuration mechanism is based on XML Schema. If you are not
familiar with Spring&#8217;s current XML configuration extensions that come with the standard
Spring distribution, please first read the appendix entitled<a class="xref" href="#xsd-config" title="33.&nbsp;XML Schema-based configuration">Chapter&nbsp;33, <i>XML Schema-based configuration</i></a>.</p>
<p>Creating new XML configuration extensions can be done by following these (relatively)
simple steps:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="link" href="#extensible-xml-schema" title="34.2&nbsp;Authoring the schema">Authoring</a> an XML schema to describe your custom element(s).
</li><li class="listitem">
<a class="link" href="#extensible-xml-namespacehandler" title="34.3&nbsp;Coding a NamespaceHandler">Coding</a> a custom <code class="literal">NamespaceHandler</code> implementation
(this is an easy step, don&#8217;t worry).
</li><li class="listitem">
<a class="link" href="#extensible-xml-parser" title="34.4&nbsp;nDefinitionParser">Coding</a> one or more <code class="literal">BeanDefinitionParser</code> implementations
(this is where the real work is done).
</li><li class="listitem">
<a class="link" href="#extensible-xml-registration" title="34.5&nbsp;Registering the handler and the schema">Registering</a> the above artifacts with Spring (this too
is an easy step).
</li></ul></div>

<p>What follows is a description of each of these steps. For the example, we will create an
XML extension (a custom XML element) that allows us to configure objects of the type
<code class="literal">SimpleDateFormat</code> (from the <code class="literal">java.text</code> package) in an easy manner. When we are done,
we will be able to define bean definitions of type <code class="literal">SimpleDateFormat</code> like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;myns:dateformat</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dateFormat"</span>
    <span class="hl-attribute">pattern</span>=<span class="hl-value">"yyyy-MM-dd HH:mm"</span>
    <span class="hl-attribute">lenient</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>

<p><span class="emphasis"><em>(Don&#8217;t worry about the fact that this example is very simple; much more detailed
examples follow afterwards. The intent in this first simple example is to walk you
through the basic steps involved.)</em></span></p>
</div>
<div class="section" title="34.2&nbsp;Authoring the schema"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extensible-xml-schema"></a>34.2&nbsp;Authoring the schema</h2></div></div></div>

<p>Creating an XML configuration extension for use with Spring&#8217;s IoC container starts with
authoring an XML Schema to describe the extension. What follows is the schema we&#8217;ll use
to configure <code class="literal">SimpleDateFormat</code> objects.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- myns.xsd (inside package org/springframework/samples/xml) --&gt;</span>

<span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;xsd:schema</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.mycompany.com/schema/myns"</span>
        <span class="hl-attribute">xmlns:xsd</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema"</span>
        <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
        <span class="hl-attribute">targetNamespace</span>=<span class="hl-value">"http://www.mycompany.com/schema/myns"</span>
        <span class="hl-attribute">elementFormDefault</span>=<span class="hl-value">"qualified"</span>
        <span class="hl-attribute">attributeFormDefault</span>=<span class="hl-value">"unqualified"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;xsd:import</span> <span class="hl-attribute">namespace</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;xsd:element</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dateformat"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;xsd:complexType&gt;</span>
            <span class="hl-tag">&lt;xsd:complexContent&gt;</span>
                <span class="hl-tag">&lt;xsd:extension</span> <span class="hl-attribute">base</span>=<span class="hl-value">"beans:identifiedType"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;xsd:attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lenient"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"xsd:boolean"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;xsd:attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"pattern"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"xsd:string"</span> <span class="hl-attribute">use</span>=<span class="hl-value">"required"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/xsd:extension&gt;</span>
            <span class="hl-tag">&lt;/xsd:complexContent&gt;</span>
        <span class="hl-tag">&lt;/xsd:complexType&gt;</span>
    <span class="hl-tag">&lt;/xsd:element&gt;</span>
<span class="hl-tag">&lt;/xsd:schema&gt;</span></pre>

<p>(The emphasized line contains an extension base for all tags that will be identifiable
(meaning they have an <code class="literal">id</code> attribute that will be used as the bean identifier in the
container). We are able to use this attribute because we imported the Spring-provided
<code class="literal">'beans'</code> namespace.)</p>
<p>The above schema will be used to configure <code class="literal">SimpleDateFormat</code> objects, directly in an
XML application context file using the <code class="literal">&lt;myns:dateformat/&gt;</code> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;myns:dateformat</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dateFormat"</span>
    <span class="hl-attribute">pattern</span>=<span class="hl-value">"yyyy-MM-dd HH:mm"</span>
    <span class="hl-attribute">lenient</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>

<p>Note that after we&#8217;ve created the infrastructure classes, the above snippet of XML will
essentially be exactly the same as the following XML snippet. In other words, we&#8217;re just
creating a bean in the container, identified by the name <code class="literal">'dateFormat'</code> of type
<code class="literal">SimpleDateFormat</code>, with a couple of properties set.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dateFormat"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.text.SimpleDateFormat"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"yyyy-HH-dd HH:mm"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lenient"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The schema-based approach to creating configuration format allows for tight integration
with an IDE that has a schema-aware XML editor. Using a properly authored schema, you
can use autocompletion to have a user choose between several configuration options
defined in the enumeration.</p>
</td></tr></table></div>

</div>
<div class="section" title="34.3&nbsp;Coding a NamespaceHandler"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extensible-xml-namespacehandler"></a>34.3&nbsp;Coding a NamespaceHandler</h2></div></div></div>

<p>In addition to the schema, we need a <code class="literal">NamespaceHandler</code> that will parse all elements of
this specific namespace Spring encounters while parsing configuration files. The
<code class="literal">NamespaceHandler</code> should in our case take care of the parsing of the <code class="literal">myns:dateformat</code>
element.</p>
<p>The <code class="literal">NamespaceHandler</code> interface is pretty simple in that it features just three methods:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">init()</code> - allows for initialization of the <code class="literal">NamespaceHandler</code> and will be called by
Spring before the handler is used
</li><li class="listitem">
<code class="literal">BeanDefinition parse(Element, ParserContext)</code> - called when Spring encounters a
top-level element (not nested inside a bean definition or a different namespace). This
method can register bean definitions itself and/or return a bean definition.
</li><li class="listitem">
<code class="literal">BeanDefinitionHolder decorate(Node, BeanDefinitionHolder, ParserContext)</code> - called
when Spring encounters an attribute or nested element of a different namespace. The
decoration of one or more bean definitions is used for example with
the<a class="link" href="#beans-factory-scopes" title="4.5&nbsp;Bean scopes">out-of-the-box    scopes Spring 2.0 supports</a>. We&#8217;ll start by
highlighting a simple example, without using decoration, after which we will    show
decoration in a somewhat more advanced example.
</li></ul></div>

<p>Although it is perfectly possible to code your own <code class="literal">NamespaceHandler</code> for the entire
namespace (and hence provide code that parses each and every element in the namespace),
it is often the case that each top-level XML element in a Spring XML configuration file
results in a single bean definition (as in our case, where a single <code class="literal">&lt;myns:dateformat/&gt;</code>
element results in a single <code class="literal">SimpleDateFormat</code> bean definition). Spring features a
number of convenience classes that support this scenario. In this example, we&#8217;ll make
use the <code class="literal">NamespaceHandlerSupport</code> class:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.samples.xml;

<span class="hl-keyword">import</span> org.springframework.beans.factory.xml.NamespaceHandlerSupport;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyNamespaceHandler <span class="hl-keyword">extends</span> NamespaceHandlerSupport {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() {
        <span class="strong"><strong>registerBeanDefinitionParser("dateformat", new SimpleDateFormatBeanDefinitionParser());</strong></span>
    }

}</pre>

<p>The observant reader will notice that there isn&#8217;t actually a whole lot of parsing logic
in this class. Indeed&#8230; the <code class="literal">NamespaceHandlerSupport</code> class has a built in notion of
delegation. It supports the registration of any number of <code class="literal">BeanDefinitionParser</code>
instances, to which it will delegate to when it needs to parse an element in its
namespace. This clean separation of concerns allows a <code class="literal">NamespaceHandler</code> to handle the
orchestration of the parsing of <span class="emphasis"><em>all</em></span> of the custom elements in its namespace, while
delegating to <code class="literal">BeanDefinitionParsers</code> to do the grunt work of the XML parsing; this
means that each <code class="literal">BeanDefinitionParser</code> will contain just the logic for parsing a single
custom element, as we can see in the next step</p>
</div>
<div class="section" title="34.4&nbsp;nDefinitionParser"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extensible-xml-parser"></a>34.4&nbsp;nDefinitionParser</h2></div></div></div>

<p>A <code class="literal">BeanDefinitionParser</code> will be used if the <code class="literal">NamespaceHandler</code> encounters an XML
element of the type that has been mapped to the specific bean definition parser (which
is <code class="literal">'dateformat'</code> in this case). In other words, the <code class="literal">BeanDefinitionParser</code> is
responsible for parsing <span class="emphasis"><em>one</em></span> distinct top-level XML element defined in the schema. In
the parser, we&#8217;ll have access to the XML element (and thus its subelements too) so that
we can parse our custom XML content, as can be seen in the following example:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.samples.xml;

<span class="hl-keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;
<span class="hl-keyword">import</span> org.springframework.beans.factory.xml.AbstractSingleBeanDefinitionParser;
<span class="hl-keyword">import</span> org.springframework.util.StringUtils;
<span class="hl-keyword">import</span> org.w3c.dom.Element;

<span class="hl-keyword">import</span> java.text.SimpleDateFormat;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleDateFormatBeanDefinitionParser <span class="hl-keyword">extends</span> AbstractSingleBeanDefinitionParser { <a name="CO1-1"></a><img src="images/callouts/1.png" alt="1" border="0">

    <span class="hl-keyword">protected</span> Class getBeanClass(Element element) {
        <span class="hl-keyword">return</span> SimpleDateFormat.<span class="hl-keyword">class</span>; <a name="CO1-2"></a><img src="images/callouts/2.png" alt="2" border="0">
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> doParse(Element element, BeanDefinitionBuilder bean) {
        <span class="hl-comment">// this will never be null since the schema explicitly requires that a value be supplied</span>
        String pattern = element.getAttribute(<span class="hl-string">"pattern"</span>);
        bean.addConstructorArg(pattern);

        <span class="hl-comment">// this however is an optional property</span>
        String lenient = element.getAttribute(<span class="hl-string">"lenient"</span>);
        <span class="hl-keyword">if</span> (StringUtils.hasText(lenient)) {
            bean.addPropertyValue(<span class="hl-string">"lenient"</span>, Boolean.valueOf(lenient));
        }
    }

}</pre>

<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-1"><img src="images/callouts/1.png" alt="1" border="0"></a> </p></td><td valign="top" align="left">
    <p>We use the Spring-provided <code class="literal">AbstractSingleBeanDefinitionParser</code> to handle a lot of
the basic grunt work of creating a <span class="emphasis"><em>single</em></span> <code class="literal">BeanDefinition</code>.</p>
  </td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-2"><img src="images/callouts/2.png" alt="2" border="0"></a> </p></td><td valign="top" align="left">
    <p>We supply the <code class="literal">AbstractSingleBeanDefinitionParser</code> superclass with the type that our
single <code class="literal">BeanDefinition</code> will represent.</p>
  </td></tr></table></div>

<p>In this simple case, this is all that we need to do. The creation of our single
<code class="literal">BeanDefinition</code> is handled by the <code class="literal">AbstractSingleBeanDefinitionParser</code> superclass, as
is the extraction and setting of the bean definition&#8217;s unique identifier.</p>
</div>
<div class="section" title="34.5&nbsp;Registering the handler and the schema"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extensible-xml-registration"></a>34.5&nbsp;Registering the handler and the schema</h2></div></div></div>

<p>The coding is finished! All that remains to be done is to somehow make the Spring XML
parsing infrastructure aware of our custom element; we do this by registering our custom
<code class="literal">namespaceHandler</code> and custom XSD file in two special purpose properties files. These
properties files are both placed in a <code class="literal">'META-INF'</code> directory in your application, and
can, for example, be distributed alongside your binary classes in a JAR file. The Spring
XML parsing infrastructure will automatically pick up your new extension by consuming
these special properties files, the formats of which are detailed below.</p>
<div class="section" title="34.5.1&nbsp;META-INF/spring.handlers"><div class="titlepage"><div><div><h3 class="title"><a name="extensible-xml-registration-spring-handlers"></a>34.5.1&nbsp;<span class="emphasis"><em>META-INF/spring.handlers</em></span></h3></div></div></div>

<p>The properties file called <code class="literal">'spring.handlers'</code> contains a mapping of XML Schema URIs to
namespace handler classes. So for our example, we need to write the following:</p>

<pre class="literallayout">http\://www.mycompany.com/schema/myns=org.springframework.samples.xml.MyNamespaceHandler</pre>

<p><span class="emphasis"><em>(The <code class="literal">':'</code> character is a valid delimiter in the Java properties format, and so the
<code class="literal">':'</code> character in the URI needs to be escaped with a backslash.)</em></span></p>
<p>The first part (the key) of the key-value pair is the URI associated with your custom
namespace extension, and needs to <span class="emphasis"><em>match exactly</em></span> the value of the <code class="literal">'targetNamespace'</code>
attribute as specified in your custom XSD schema.</p>
</div>
<div class="section" title="34.5.2&nbsp;META-INF/spring.schemas"><div class="titlepage"><div><div><h3 class="title"><a name="extensible-xml-registration-spring-schemas"></a>34.5.2&nbsp;<span class="emphasis"><em>META-INF/spring.schemas</em></span></h3></div></div></div>

<p>The properties file called <code class="literal">'spring.schemas'</code> contains a mapping of XML Schema locations
(referred to along with the schema declaration in XML files that use the schema as part
of the <code class="literal">'xsi:schemaLocation'</code> attribute) to <span class="emphasis"><em>classpath</em></span> resources. This file is needed
to prevent Spring from absolutely having to use a default <code class="literal">EntityResolver</code> that requires
Internet access to retrieve the schema file. If you specify the mapping in this
properties file, Spring will search for the schema on the classpath (in this case
<code class="literal">'myns.xsd'</code> in the <code class="literal">'org.springframework.samples.xml'</code> package):</p>

<pre class="literallayout">http\://www.mycompany.com/schema/myns/myns.xsd=org/springframework/samples/xml/myns.xsd</pre>

<p>The upshot of this is that you are encouraged to deploy your XSD file(s) right alongside
the <code class="literal">NamespaceHandler</code> and <code class="literal">BeanDefinitionParser</code> classes on the classpath.</p>
</div>
</div>
<div class="section" title="34.6&nbsp;Using a custom extension in your Spring XML configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extensible-xml-using"></a>34.6&nbsp;Using a custom extension in your Spring XML configuration</h2></div></div></div>

<p>Using a custom extension that you yourself have implemented is no different from using
one of the <span class="emphasis"><em>custom</em></span> extensions that Spring provides straight out of the box. Find below
an example of using the custom <code class="literal">&lt;dateformat/&gt;</code> element developed in the previous steps
in a Spring XML configuration file.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:myns</span>=<span class="hl-value">"http://www.mycompany.com/schema/myns"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.mycompany.com/schema/myns http://www.mycompany.com/schema/myns/myns.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- as a top-level bean --&gt;</span>
    <span class="hl-tag">&lt;myns:dateformat</span> <span class="hl-attribute">id</span>=<span class="hl-value">"defaultDateFormat"</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"yyyy-MM-dd HH:mm"</span> <span class="hl-attribute">lenient</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jobDetailTemplate"</span> <span class="hl-attribute">abstract</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dateFormat"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- as an inner bean --&gt;</span>
            <span class="hl-tag">&lt;myns:dateformat</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"HH:mm MM-dd-yyyy"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section" title="34.7&nbsp;Meatier examples"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extensible-xml-meat"></a>34.7&nbsp;Meatier examples</h2></div></div></div>

<p>Find below some much meatier examples of custom XML extensions.</p>
<div class="section" title="34.7.1&nbsp;Nesting custom tags within custom tags"><div class="titlepage"><div><div><h3 class="title"><a name="extensible-xml-custom-nested"></a>34.7.1&nbsp;Nesting custom tags within custom tags</h3></div></div></div>

<p>This example illustrates how you might go about writing the various artifacts required
to satisfy a target of the following configuration:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:foo</span>=<span class="hl-value">"http://www.foo.com/schema/component"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.foo.com/schema/component http://www.foo.com/schema/component/component.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;foo:component</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bionic-family"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Bionic-1"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;foo:component</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Mother-1"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;foo:component</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Karate-1"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;foo:component</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Sport-1"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/foo:component&gt;</span>
        <span class="hl-tag">&lt;foo:component</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Rock-1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/foo:component&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>The above configuration actually nests custom extensions within each other. The class
that is actually configured by the above <code class="literal">&lt;foo:component/&gt;</code> element is the <code class="literal">Component</code>
class (shown directly below). Notice how the <code class="literal">Component</code> class does <span class="emphasis"><em>not</em></span> expose a
setter method for the <code class="literal">'components'</code> property; this makes it hard (or rather impossible)
to configure a bean definition for the <code class="literal">Component</code> class using setter injection.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> java.util.ArrayList;
<span class="hl-keyword">import</span> java.util.List;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Component {

    <span class="hl-keyword">private</span> String name;
    <span class="hl-keyword">private</span> List&lt;Component&gt; components = <span class="hl-keyword">new</span> ArrayList&lt;Component&gt; ();

    <span class="hl-comment">// mmm, there is no setter method for the </span><span class="emphasis"><em>components</em></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addComponent(Component component) {
        <span class="hl-keyword">this</span>.components.add(component);
    }

    <span class="hl-keyword">public</span> List&lt;Component&gt; getComponents() {
        <span class="hl-keyword">return</span> components;
    }

    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

}</pre>

<p>The typical solution to this issue is to create a custom <code class="literal">FactoryBean</code> that exposes a
setter property for the <code class="literal">'components'</code> property.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> org.springframework.beans.factory.FactoryBean;

<span class="hl-keyword">import</span> java.util.List;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ComponentFactoryBean <span class="hl-keyword">implements</span> FactoryBean&lt;Component&gt; {

    <span class="hl-keyword">private</span> Component parent;
    <span class="hl-keyword">private</span> List&lt;Component&gt; children;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setParent(Component parent) {
        <span class="hl-keyword">this</span>.parent = parent;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setChildren(List&lt;Component&gt; children) {
        <span class="hl-keyword">this</span>.children = children;
    }

    <span class="hl-keyword">public</span> Component getObject() <span class="hl-keyword">throws</span> Exception {
        <span class="hl-keyword">if</span> (<span class="hl-keyword">this</span>.children != null &amp;&amp; <span class="hl-keyword">this</span>.children.size() &gt; <span class="hl-number">0</span>) {
            <span class="hl-keyword">for</span> (Component child : children) {
                <span class="hl-keyword">this</span>.parent.addComponent(child);
            }
        }
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.parent;
    }

    <span class="hl-keyword">public</span> Class&lt;Component&gt; getObjectType() {
        <span class="hl-keyword">return</span> Component.<span class="hl-keyword">class</span>;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isSingleton() {
        <span class="hl-keyword">return</span> true;
    }

}</pre>

<p>This is all very well, and does work nicely, but exposes a lot of Spring plumbing to the
end user. What we are going to do is write a custom extension that hides away all of
this Spring plumbing. If we stick to <a class="link" href="#extensible-xml-introduction" title="34.1&nbsp;Introduction">the steps described
previously</a>, we&#8217;ll start off by creating the XSD schema to define the structure of our
custom tag.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>

<span class="hl-tag">&lt;xsd:schema</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.foo.com/schema/component"</span>
        <span class="hl-attribute">xmlns:xsd</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema"</span>
        <span class="hl-attribute">targetNamespace</span>=<span class="hl-value">"http://www.foo.com/schema/component"</span>
        <span class="hl-attribute">elementFormDefault</span>=<span class="hl-value">"qualified"</span>
        <span class="hl-attribute">attributeFormDefault</span>=<span class="hl-value">"unqualified"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;xsd:element</span> <span class="hl-attribute">name</span>=<span class="hl-value">"component"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;xsd:complexType&gt;</span>
            <span class="hl-tag">&lt;xsd:choice</span> <span class="hl-attribute">minOccurs</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">maxOccurs</span>=<span class="hl-value">"unbounded"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;xsd:element</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"component"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/xsd:choice&gt;</span>
            <span class="hl-tag">&lt;xsd:attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"id"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"xsd:ID"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;xsd:attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">use</span>=<span class="hl-value">"required"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"xsd:string"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/xsd:complexType&gt;</span>
    <span class="hl-tag">&lt;/xsd:element&gt;</span>

<span class="hl-tag">&lt;/xsd:schema&gt;</span></pre>

<p>We&#8217;ll then create a custom <code class="literal">NamespaceHandler</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> org.springframework.beans.factory.xml.NamespaceHandlerSupport;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ComponentNamespaceHandler <span class="hl-keyword">extends</span> NamespaceHandlerSupport {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() {
        registerBeanDefinitionParser(<span class="hl-string">"component"</span>, <span class="hl-keyword">new</span> ComponentBeanDefinitionParser());
    }

}</pre>

<p>Next up is the custom <code class="literal">BeanDefinitionParser</code>. Remember that what we are creating is a
<code class="literal">BeanDefinition</code> describing a <code class="literal">ComponentFactoryBean</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> org.springframework.beans.factory.config.BeanDefinition;
<span class="hl-keyword">import</span> org.springframework.beans.factory.support.AbstractBeanDefinition;
<span class="hl-keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;
<span class="hl-keyword">import</span> org.springframework.beans.factory.support.ManagedList;
<span class="hl-keyword">import</span> org.springframework.beans.factory.xml.AbstractBeanDefinitionParser;
<span class="hl-keyword">import</span> org.springframework.beans.factory.xml.ParserContext;
<span class="hl-keyword">import</span> org.springframework.util.xml.DomUtils;
<span class="hl-keyword">import</span> org.w3c.dom.Element;

<span class="hl-keyword">import</span> java.util.List;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ComponentBeanDefinitionParser <span class="hl-keyword">extends</span> AbstractBeanDefinitionParser {

    <span class="hl-keyword">protected</span> AbstractBeanDefinition parseInternal(Element element, ParserContext parserContext) {
        <span class="hl-keyword">return</span> parseComponentElement(element);
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> AbstractBeanDefinition parseComponentElement(Element element) {
        BeanDefinitionBuilder factory = BeanDefinitionBuilder.rootBeanDefinition(ComponentFactoryBean.<span class="hl-keyword">class</span>);
        factory.addPropertyValue(<span class="hl-string">"parent"</span>, parseComponent(element));

        List&lt;Element&gt; childElements = DomUtils.getChildElementsByTagName(element, <span class="hl-string">"component"</span>);
        <span class="hl-keyword">if</span> (childElements != null &amp;&amp; childElements.size() &gt; <span class="hl-number">0</span>) {
            parseChildComponents(childElements, factory);
        }

        <span class="hl-keyword">return</span> factory.getBeanDefinition();
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> BeanDefinition parseComponent(Element element) {
        BeanDefinitionBuilder component = BeanDefinitionBuilder.rootBeanDefinition(Component.<span class="hl-keyword">class</span>);
        component.addPropertyValue(<span class="hl-string">"name"</span>, element.getAttribute(<span class="hl-string">"name"</span>));
        <span class="hl-keyword">return</span> component.getBeanDefinition();
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> parseChildComponents(List&lt;Element&gt; childElements, BeanDefinitionBuilder factory) {
        ManagedList&lt;BeanDefinition&gt; children = <span class="hl-keyword">new</span> ManagedList&lt;BeanDefinition&gt;(childElements.size());
        <span class="hl-keyword">for</span> (Element element : childElements) {
            children.add(parseComponentElement(element));
        }
        factory.addPropertyValue(<span class="hl-string">"children"</span>, children);
    }

}</pre>

<p>Lastly, the various artifacts need to be registered with the Spring XML infrastructure.</p>

<pre class="literallayout"># in <span class="emphasis"><em>META-INF/spring.handlers</em></span>
http\://www.foo.com/schema/component=com.foo.ComponentNamespaceHandler</pre>


<pre class="literallayout"># in <span class="emphasis"><em>META-INF/spring.schemas</em></span>
http\://www.foo.com/schema/component/component.xsd=com/foo/component.xsd</pre>

</div>
<div class="section" title="34.7.2&nbsp;Custom attributes on normal elements"><div class="titlepage"><div><div><h3 class="title"><a name="extensible-xml-custom-just-attributes"></a>34.7.2&nbsp;Custom attributes on <span class="emphasis"><em>normal</em></span> elements</h3></div></div></div>

<p>Writing your own custom parser and the associated artifacts isn&#8217;t hard, but sometimes it
is not the right thing to do. Consider the scenario where you need to add metadata to
already existing bean definitions. In this case you certainly don&#8217;t want to have to go
off and write your own entire custom extension; rather you just want to add an
additional attribute to the existing bean definition element.</p>
<p>By way of another example, let&#8217;s say that the service class that you are defining a bean
definition for a service object that will (unknown to it) be accessing a clustered
<a class="ulink" href="http://jcp.org/en/jsr/detail?id=107" target="_top">JCache</a>, and you want to ensure that the named
JCache instance is eagerly started within the surrounding cluster:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkingAccountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.DefaultCheckingAccountService"</span>
        <span class="hl-attribute">jcache:cache-name</span>=<span class="hl-value">"checking.account"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- other dependencies here... --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>What we are going to do here is create another <code class="literal">BeanDefinition</code> when the
<code class="literal">'jcache:cache-name'</code> attribute is parsed; this <code class="literal">BeanDefinition</code> will then initialize
the named JCache for us. We will also modify the existing <code class="literal">BeanDefinition</code> for the
<code class="literal">'checkingAccountService'</code> so that it will have a dependency on this new
JCache-initializing <code class="literal">BeanDefinition</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JCacheInitializer {

    <span class="hl-keyword">private</span> String name;

    <span class="hl-keyword">public</span> JCacheInitializer(String name) {
        <span class="hl-keyword">this</span>.name = name;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> initialize() {
        <span class="hl-comment">// lots of JCache API calls to initialize the named cache...</span>
    }

}</pre>

<p>Now onto the custom extension. Firstly, the authoring of the XSD schema describing the
custom attribute (quite easy in this case).</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>

<span class="hl-tag">&lt;xsd:schema</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.foo.com/schema/jcache"</span>
        <span class="hl-attribute">xmlns:xsd</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema"</span>
        <span class="hl-attribute">targetNamespace</span>=<span class="hl-value">"http://www.foo.com/schema/jcache"</span>
        <span class="hl-attribute">elementFormDefault</span>=<span class="hl-value">"qualified"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;xsd:attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cache-name"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"xsd:string"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/xsd:schema&gt;</span></pre>

<p>Next, the associated <code class="literal">NamespaceHandler</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> org.springframework.beans.factory.xml.NamespaceHandlerSupport;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JCacheNamespaceHandler <span class="hl-keyword">extends</span> NamespaceHandlerSupport {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() {
        <span class="hl-keyword">super</span>.registerBeanDefinitionDecoratorForAttribute(<span class="hl-string">"cache-name"</span>,
            <span class="hl-keyword">new</span> JCacheInitializingBeanDefinitionDecorator());
    }

}</pre>

<p>Next, the parser. Note that in this case, because we are going to be parsing an XML
attribute, we write a <code class="literal">BeanDefinitionDecorator</code> rather than a <code class="literal">BeanDefinitionParser</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.foo;

<span class="hl-keyword">import</span> org.springframework.beans.factory.config.BeanDefinitionHolder;
<span class="hl-keyword">import</span> org.springframework.beans.factory.support.AbstractBeanDefinition;
<span class="hl-keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;
<span class="hl-keyword">import</span> org.springframework.beans.factory.xml.BeanDefinitionDecorator;
<span class="hl-keyword">import</span> org.springframework.beans.factory.xml.ParserContext;
<span class="hl-keyword">import</span> org.w3c.dom.Attr;
<span class="hl-keyword">import</span> org.w3c.dom.Node;

<span class="hl-keyword">import</span> java.util.ArrayList;
<span class="hl-keyword">import</span> java.util.Arrays;
<span class="hl-keyword">import</span> java.util.List;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JCacheInitializingBeanDefinitionDecorator <span class="hl-keyword">implements</span> BeanDefinitionDecorator {

    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String[] EMPTY_STRING_ARRAY = <span class="hl-keyword">new</span> String[<span class="hl-number">0</span>];

    <span class="hl-keyword">public</span> BeanDefinitionHolder decorate(Node source, BeanDefinitionHolder holder,
            ParserContext ctx) {
        String initializerBeanName = registerJCacheInitializer(source, ctx);
        createDependencyOnJCacheInitializer(holder, initializerBeanName);
        <span class="hl-keyword">return</span> holder;
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">void</span> createDependencyOnJCacheInitializer(BeanDefinitionHolder holder,
            String initializerBeanName) {
        AbstractBeanDefinition definition = ((AbstractBeanDefinition) holder.getBeanDefinition());
        String[] dependsOn = definition.getDependsOn();
        <span class="hl-keyword">if</span> (dependsOn == null) {
            dependsOn = <span class="hl-keyword">new</span> String[]{initializerBeanName};
        } <span class="hl-keyword">else</span> {
            List dependencies = <span class="hl-keyword">new</span> ArrayList(Arrays.asList(dependsOn));
            dependencies.add(initializerBeanName);
            dependsOn = (String[]) dependencies.toArray(EMPTY_STRING_ARRAY);
        }
        definition.setDependsOn(dependsOn);
    }

    <span class="hl-keyword">private</span> String registerJCacheInitializer(Node source, ParserContext ctx) {
        String cacheName = ((Attr) source).getValue();
        String beanName = cacheName + <span class="hl-string">"-initializer"</span>;
        <span class="hl-keyword">if</span> (!ctx.getRegistry().containsBeanDefinition(beanName)) {
            BeanDefinitionBuilder initializer = BeanDefinitionBuilder.rootBeanDefinition(JCacheInitializer.<span class="hl-keyword">class</span>);
            initializer.addConstructorArg(cacheName);
            ctx.getRegistry().registerBeanDefinition(beanName, initializer.getBeanDefinition());
        }
        <span class="hl-keyword">return</span> beanName;
    }

}</pre>

<p>Lastly, the various artifacts need to be registered with the Spring XML infrastructure.</p>

<pre class="literallayout"># in <span class="emphasis"><em>META-INF/spring.handlers</em></span>
http\://www.foo.com/schema/jcache=com.foo.JCacheNamespaceHandler</pre>


<pre class="literallayout"># in <span class="emphasis"><em>META-INF/spring.schemas</em></span>
http\://www.foo.com/schema/jcache/jcache.xsd=com/foo/jcache.xsd</pre>

</div>
</div>
<div class="section" title="34.8&nbsp;Further Resources"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="extensible-xml-resources"></a>34.8&nbsp;Further Resources</h2></div></div></div>

<p>Find below links to further resources concerning XML Schema and the extensible XML
support described in this chapter.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <a class="ulink" href="http://www.w3.org/TR/2004/REC-xmlschema-1-20041028/" target="_top">XML Schema Part 1: Structures
Second Edition</a>
</li><li class="listitem">
The <a class="ulink" href="http://www.w3.org/TR/2004/REC-xmlschema-2-20041028/" target="_top">XML Schema Part 2: Datatypes
Second Edition</a>
</li></ul></div>

</div>
</div>
<div class="chapter" title="35.&nbsp;spring.tld"><div class="titlepage"><div><div><h2 class="title"><a name="spring.tld"></a>35.&nbsp;spring.tld</h2></div></div></div>

<div class="section" title="35.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld-intro"></a>35.1&nbsp;Introduction</h2></div></div></div>

<p>One of the view technologies you can use with the Spring Framework is Java Server Pages
(JSPs). To help you implement views using Java Server Pages the Spring Framework
provides you with some tags for evaluating errors, setting themes and outputting
internationalized messages.</p>
<p>Please note that the various tags generated by this form tag library are compliant with
the <a class="ulink" href="http://www.w3.org/TR/xhtml1/" target="_top">XHTML-1.0-Strict specification</a> and attendant
<a class="ulink" href="http://www.w3.org/TR/xhtml1/dtds.html#a_dtd_XHTML-1.0-Strict" target="_top">DTD</a>.</p>
<p>This appendix describes the <code class="literal">spring.tld</code> tag library.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#spring.tld.bind" title="35.2&nbsp;the bind tag">Section&nbsp;35.2, &#8220;the bind tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.escapeBody" title="35.3&nbsp;the escapeBody tag">Section&nbsp;35.3, &#8220;the escapeBody tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.hasBindErrors" title="35.4&nbsp;the hasBindErrors tag">Section&nbsp;35.4, &#8220;the hasBindErrors tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.htmlEscape" title="35.5&nbsp;the htmlEscape tag">Section&nbsp;35.5, &#8220;the htmlEscape tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.message" title="35.6&nbsp;the message tag">Section&nbsp;35.6, &#8220;the message tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.nestedPath" title="35.7&nbsp;the nestedPath tag">Section&nbsp;35.7, &#8220;the nestedPath tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.theme" title="35.8&nbsp;the theme tag">Section&nbsp;35.8, &#8220;the theme tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.transform" title="35.9&nbsp;the transform tag">Section&nbsp;35.9, &#8220;the transform tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.url" title="35.10&nbsp;the url tag">Section&nbsp;35.10, &#8220;the url tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring.tld.eval" title="35.11&nbsp;the eval tag">Section&nbsp;35.11, &#8220;the eval tag&#8221;</a>
</li></ul></div>

</div>
<div class="section" title="35.2&nbsp;the bind tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.bind"></a>35.2&nbsp;the bind tag</h2></div></div></div>

<p>Provides BindStatus object for the given bind path. The HTML escaping flag participates
in a page-wide or application-wide setting (i.e. by HtmlEscapeTag or a
"defaultHtmlEscape" context-param in web.xml).</p>
<div class="table"><a name="spring.tld.bind.table"></a><p class="title"><b>Table&nbsp;35.1.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set HTML escaping for this tag, as boolean value. Overrides the default HTML escaping
  setting for the current page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignoreNestedPath</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set whether to ignore a nested path, if any. Default is to not ignore.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>The path to the bean or bean property to bind status information for. For instance
  account.name, company.address.zipCode or just employee. The status object will
  exported to the page scope, specifically for this bean or bean property</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.3&nbsp;the escapeBody tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.escapeBody"></a>35.3&nbsp;the escapeBody tag</h2></div></div></div>

<p>Escapes its enclosed body content, applying HTML escaping and/or JavaScript escaping.
The HTML escaping flag participates in a page-wide or application-wide setting (i.e. by
HtmlEscapeTag or a "defaultHtmlEscape" context-param in web.xml).</p>
<div class="table"><a name="spring.tld.escapeBody.table"></a><p class="title"><b>Table&nbsp;35.2.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set HTML escaping for this tag, as boolean value. Overrides the default HTML escaping
  setting for the current page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>javaScriptEscape</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>Set JavaScript escaping for this tag, as boolean value. Default is false.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.4&nbsp;the hasBindErrors tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.hasBindErrors"></a>35.4&nbsp;the hasBindErrors tag</h2></div></div></div>

<p>Provides Errors instance in case of bind errors. The HTML escaping flag participates in
a page-wide or application-wide setting (i.e. by HtmlEscapeTag or a "defaultHtmlEscape"
context-param in web.xml).</p>
<div class="table"><a name="spring.tld.hasBindErrors.table"></a><p class="title"><b>Table&nbsp;35.3.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set HTML escaping for this tag, as boolean value. Overrides the default HTML escaping
  setting for the current page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>name</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>The name of the bean in the request, that needs to be inspected for errors. If errors
  are available for this bean, they will be bound under the <span class="emphasis"><em>errors</em></span> key.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.5&nbsp;the htmlEscape tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.htmlEscape"></a>35.5&nbsp;the htmlEscape tag</h2></div></div></div>

<p>Sets default HTML escape value for the current page. Overrides a "defaultHtmlEscape"
context-param in web.xml, if any.</p>
<div class="table"><a name="spring.tld.htmlEscape.table"></a><p class="title"><b>Table&nbsp;35.4.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>defaultHtmlEscape</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>Set the default value for HTML escaping, to be put into the current PageContext.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.6&nbsp;the message tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.message"></a>35.6&nbsp;the message tag</h2></div></div></div>

<p>Retrieves the message with the given code, or text if code isn&#8217;t resolvable. The HTML
escaping flag participates in a page-wide or application-wide setting (i.e. by
HtmlEscapeTag or a "defaultHtmlEscape" context-param in web.xml).</p>
<div class="table"><a name="spring.tld.message.table"></a><p class="title"><b>Table&nbsp;35.5.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>arguments</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set optional message arguments for this tag, as a (comma-)delimited String (each
  String argument can contain JSP EL), an Object array (used as argument array), or a
  single Object (used as single argument).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>argumentSeparator</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The separator character to be used for splitting the arguments string value; defaults
  to a <span class="emphasis"><em>comma</em></span> (<span class="emphasis"><em>,</em></span>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>code</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The code (key) to use when looking up the message. If code is not provided, the text
  attribute will be used.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set HTML escaping for this tag, as boolean value. Overrides the default HTML escaping
  setting for the current page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>javaScriptEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set JavaScript escaping for this tag, as boolean value. Default is false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>message</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A MessageSourceResolvable argument (direct or through JSP EL). Fits nicely when used
  in conjunction with Spring&#8217;s own validation error classes which all implement the
  MessageSourceResolvable interface. For example, this allows you to iterate over all of
  the errors in a form, passing each error (using a runtime expression) as the value of
  this <span class="emphasis"><em>message</em></span> attribute, thus effecting the easy display of such error messages.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scope</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The scope to use when exporting the result to a variable. This attribute is only used
  when var is also set. Possible values are page, request, session and application.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>text</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Default text to output when a message for the given code could not be found. If both
  text and code are not set, the tag will output null.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>var</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>The string to use when binding the result to the page, request, session or application
  scope. If not specified, the result gets outputted to the writer (i.e. typically
  directly to the JSP).</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.7&nbsp;the nestedPath tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.nestedPath"></a>35.7&nbsp;the nestedPath tag</h2></div></div></div>

<p>Sets a nested path to be used by the bind tag&#8217;s path.</p>
<div class="table"><a name="spring.tld.nestedPath.table"></a><p class="title"><b>Table&nbsp;35.6.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>Set the path that this tag should apply. E.g. <span class="emphasis"><em>customer</em></span> to allow bind paths like
  <span class="emphasis"><em>address.street</em></span> rather than <span class="emphasis"><em>customer.address.street</em></span>.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.8&nbsp;the theme tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.theme"></a>35.8&nbsp;the theme tag</h2></div></div></div>

<p>Retrieves the theme message with the given code, or text if code isn&#8217;t resolvable. The
HTML escaping flag participates in a page-wide or application-wide setting (i.e. by
HtmlEscapeTag or a "defaultHtmlEscape" context-param in web.xml).</p>
<div class="table"><a name="spring.tld.theme.table"></a><p class="title"><b>Table&nbsp;35.7.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>arguments</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set optional message arguments for this tag, as a (comma-)delimited String (each
  String argument can contain JSP EL), an Object array (used as argument array), or a
  single Object (used as single argument).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>argumentSeparator</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The separator character to be used for splitting the arguments string value; defaults
  to a <span class="emphasis"><em>comma</em></span> (<span class="emphasis"><em>,</em></span>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>code</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The code (key) to use when looking up the message. If code is not provided, the text
  attribute will be used.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set HTML escaping for this tag, as boolean value. Overrides the default HTML escaping
  setting for the current page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>javaScriptEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set JavaScript escaping for this tag, as boolean value. Default is false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>message</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A MessageSourceResolvable argument (direct or through JSP EL).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scope</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The scope to use when exporting the result to a variable. This attribute is only used
  when var is also set. Possible values are page, request, session and application.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>text</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Default text to output when a message for the given code could not be found. If both
  text and code are not set, the tag will output null.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>var</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>The string to use when binding the result to the page, request, session or application
  scope. If not specified, the result gets outputted to the writer (i.e. typically
  directly to the JSP).</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.9&nbsp;the transform tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.transform"></a>35.9&nbsp;the transform tag</h2></div></div></div>

<p>Provides transformation of variables to Strings, using an appropriate custom
PropertyEditor from BindTag (can only be used inside BindTag). The HTML escaping flag
participates in a page-wide or application-wide setting (i.e. by HtmlEscapeTag or a
<span class="emphasis"><em>defaultHtmlEscape</em></span> context-param in web.xml).</p>
<div class="table"><a name="spring.tld.transform.table"></a><p class="title"><b>Table&nbsp;35.8.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set HTML escaping for this tag, as boolean value. Overrides the default HTML escaping
  setting for the current page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scope</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The scope to use when exported the result to a variable. This attribute is only used
  when var is also set. Possible values are page, request, session and application.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>value</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The value to transform. This is the actual object you want to have transformed (for
  instance a Date). Using the PropertyEditor that is currently in use by the
  <span class="emphasis"><em>spring:bind</em></span> tag.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>var</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>The string to use when binding the result to the page, request, session or application
  scope. If not specified, the result gets outputted to the writer (i.e. typically
  directly to the JSP).</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.10&nbsp;the url tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.url"></a>35.10&nbsp;the url tag</h2></div></div></div>

<p>Creates URLs with support for URI template variables, HTML/XML escaping, and Javascript
escaping. Modeled after the JSTL c:url tag with backwards compatibility in mind.</p>
<div class="table"><a name="spring.tld.url.table"></a><p class="title"><b>Table&nbsp;35.9.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>url</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The URL to build. This value can include template {placeholders} that are replaced
  with the URL encoded value of the named parameter. Parameters must be defined using
  the param tag inside the body of this tag.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>context</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies a remote application context path. The default is the current application
  context path.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>var</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the variable to export the URL value to. If not specified the URL is
  written as output.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scope</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The scope for the var. <span class="emphasis"><em>application</em></span>, <span class="emphasis"><em>session</em></span>, <span class="emphasis"><em>request</em></span> and <span class="emphasis"><em>page</em></span> scopes are
  supported. Defaults to page scope. This attribute has no effect unless the var
  attribute is also defined.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set HTML escaping for this tag, as a boolean value. Overrides the default HTML
  escaping setting for the current page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>javaScriptEscape</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>Set JavaScript escaping for this tag, as a boolean value. Default is false.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="35.11&nbsp;the eval tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring.tld.eval"></a>35.11&nbsp;the eval tag</h2></div></div></div>

<p>Evaluates a Spring expression (SpEL) and either prints the result or assigns it to a
variable.</p>
<div class="table"><a name="spring.tld.eval.table"></a><p class="title"><b>Table&nbsp;35.10.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The expression to evaluate.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>var</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The name of the variable to export the evaluation result to. If not specified the
  evaluation result is converted to a String and written as output.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>scope</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The scope for the var. <span class="emphasis"><em>application</em></span>, <span class="emphasis"><em>session</em></span>, <span class="emphasis"><em>request</em></span> and <span class="emphasis"><em>page</em></span> scopes are
  supported. Defaults to page scope. This attribute has no effect unless the var
  attribute is also defined.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set HTML escaping for this tag, as a boolean value. Overrides the default HTML
  escaping setting for the current page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>javaScriptEscape</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>Set JavaScript escaping for this tag, as a boolean value. Default is false.</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
</div>
<div class="chapter" title="36.&nbsp;spring-form.tld"><div class="titlepage"><div><div><h2 class="title"><a name="spring-form.tld"></a>36.&nbsp;spring-form.tld</h2></div></div></div>

<div class="section" title="36.1&nbsp;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld-intro"></a>36.1&nbsp;Introduction</h2></div></div></div>

<p>One of the view technologies you can use with the Spring Framework is Java Server Pages
(JSPs). To help you implement views using Java Server Pages the Spring Framework
provides you with some tags for evaluating errors, setting themes and outputting
internationalized messages.</p>
<p>Please note that the various tags generated by this form tag library are compliant with
the <a class="ulink" href="http://www.w3.org/TR/xhtml1/" target="_top">XHTML-1.0-Strict specification</a> and attendant
<a class="ulink" href="http://www.w3.org/TR/xhtml1/dtds.html#a_dtd_XHTML-1.0-Strict" target="_top">DTD</a>.</p>
<p>This appendix describes the <code class="literal">spring-form.tld</code> tag library.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#spring-form.tld.checkbox" title="36.2&nbsp;the checkbox tag">Section&nbsp;36.2, &#8220;the checkbox tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.checkboxes" title="36.3&nbsp;the checkboxes tag">Section&nbsp;36.3, &#8220;the checkboxes tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.errors" title="36.4&nbsp;the errors tag">Section&nbsp;36.4, &#8220;the errors tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.form" title="36.5&nbsp;the form tag">Section&nbsp;36.5, &#8220;the form tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.hidden" title="36.6&nbsp;the hidden tag">Section&nbsp;36.6, &#8220;the hidden tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.input" title="36.7&nbsp;the input tag">Section&nbsp;36.7, &#8220;the input tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.label" title="36.8&nbsp;the label tag">Section&nbsp;36.8, &#8220;the label tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.option" title="36.9&nbsp;the option tag">Section&nbsp;36.9, &#8220;the option tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.options" title="36.10&nbsp;the options tag">Section&nbsp;36.10, &#8220;the options tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.password" title="36.11&nbsp;the password tag">Section&nbsp;36.11, &#8220;the password tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.radiobutton" title="36.12&nbsp;the radiobutton tag">Section&nbsp;36.12, &#8220;the radiobutton tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.radiobuttons" title="36.13&nbsp;the radiobuttons tag">Section&nbsp;36.13, &#8220;the radiobuttons tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.select" title="36.14&nbsp;the select tag">Section&nbsp;36.14, &#8220;the select tag&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#spring-form.tld.textarea" title="36.15&nbsp;the textarea tag">Section&nbsp;36.15, &#8220;the textarea tag&#8221;</a>
</li></ul></div>

</div>
<div class="section" title="36.2&nbsp;the checkbox tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.checkbox"></a>36.2&nbsp;the checkbox tag</h2></div></div></div>

<p>Renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>checkbox</em></span>.</p>
<div class="table"><a name="spring-form.tld.checkbox.attrs.tbl"></a><p class="title"><b>Table&nbsp;36.1.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>accesskey</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>label</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Value to be displayed as part of the tag</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onblur</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onchange</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onfocus</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to property for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>value</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Optional Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.3&nbsp;the checkboxes tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.checkboxes"></a>36.3&nbsp;the checkboxes tag</h2></div></div></div>

<p>Renders multiple HTML <span class="emphasis"><em>input</em></span> tags with type <span class="emphasis"><em>checkbox</em></span>.</p>
<div class="table"><a name="spring-form.tld.checkboxes.table"></a><p class="title"><b>Table&nbsp;36.2.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>accesskey</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>delimiter</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Delimiter to use between each <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>checkbox</em></span>. There is no delimiter
  by default.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>element</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies the HTML element that is used to enclose each <span class="emphasis"><em>input</em></span> tag with type
  <span class="emphasis"><em>checkbox</em></span>. Defaults to <span class="emphasis"><em>span</em></span>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>itemLabel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Value to be displayed as part of the <span class="emphasis"><em>input</em></span> tags with type <span class="emphasis"><em>checkbox</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>items</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The Collection, Map or array of objects used to generate the <span class="emphasis"><em>input</em></span> tags with type
  <span class="emphasis"><em>checkbox</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>itemValue</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the property mapped to <span class="emphasis"><em>value</em></span> attribute of the <span class="emphasis"><em>input</em></span> tags with type
  <span class="emphasis"><em>checkbox</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onblur</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onchange</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onfocus</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to property for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.4&nbsp;the errors tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.errors"></a>36.4&nbsp;the errors tag</h2></div></div></div>

<p>Renders field errors in an HTML <span class="emphasis"><em>span</em></span> tag.</p>
<div class="table"><a name="spring-form.tld.errors.table"></a><p class="title"><b>Table&nbsp;36.3.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>delimiter</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Delimiter for displaying multiple error messages. Defaults to the br tag.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>element</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies the HTML element that is used to render the enclosing errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to errors object for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.5&nbsp;the form tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.form"></a>36.5&nbsp;the form tag</h2></div></div></div>

<p>Renders an HTML <span class="emphasis"><em>form</em></span> tag and exposes a binding path to inner tags for binding.</p>
<div class="table"><a name="spring-form.tld.form.table"></a><p class="title"><b>Table&nbsp;36.4.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>acceptCharset</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies the list of character encodings for input data that is accepted by the
  server processing this form. The value is a space- and/or comma-delimited list of
  charset values. The client must interpret this list as an exclusive-or list, i.e., the
  server is able to accept any single character encoding per entity received.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>action</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Required Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>commandName</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the model attribute under which the form object is exposed. Defaults to
  <span class="emphasis"><em>command</em></span>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>enctype</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>modelAttribute</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the model attribute under which the form object is exposed. Defaults to
  <span class="emphasis"><em>command</em></span>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute - added for backwards compatibility cases</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onreset</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onsubmit</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>target</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.6&nbsp;the hidden tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.hidden"></a>36.6&nbsp;the hidden tag</h2></div></div></div>

<p>Renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>hidden</em></span> using the bound value.</p>
<div class="table"><a name="spring-form.tld.hidden.table"></a><p class="title"><b>Table&nbsp;36.5.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>Path to property for data binding</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.7&nbsp;the input tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.input"></a>36.7&nbsp;the input tag</h2></div></div></div>

<p>Renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>text</em></span> using the bound value.</p>
<div class="table"><a name="spring-form.tld.input.table"></a><p class="title"><b>Table&nbsp;36.6.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>accesskey</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>alt</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>autocomplete</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Common Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>maxlength</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onblur</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onchange</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onfocus</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onselect</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to property for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>readonly</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will make the HTML element readonly.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.8&nbsp;the label tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.label"></a>36.8&nbsp;the label tag</h2></div></div></div>

<p>Renders a form field label in an HTML <span class="emphasis"><em>label</em></span> tag.</p>
<div class="table"><a name="spring-form.tld.label.table"></a><p class="title"><b>Table&nbsp;36.7.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used only when errors are present.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>for</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to errors object for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.9&nbsp;the option tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.option"></a>36.9&nbsp;the option tag</h2></div></div></div>

<p>Renders a single HTML <span class="emphasis"><em>option</em></span>. Sets <span class="emphasis"><em>selected</em></span> as appropriate based on bound value.</p>
<div class="table"><a name="spring-form.tld.option.table"></a><p class="title"><b>Table&nbsp;36.8.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>label</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>value</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Optional Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.10&nbsp;the options tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.options"></a>36.10&nbsp;the options tag</h2></div></div></div>

<p>Renders a list of HTML <span class="emphasis"><em>option</em></span> tags. Sets <span class="emphasis"><em>selected</em></span> as appropriate based on bound value.</p>
<div class="table"><a name="spring-form.tld.options.table"></a><p class="title"><b>Table&nbsp;36.9.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>itemLabel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the property mapped to the inner text of the <span class="emphasis"><em>option</em></span> tag</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>items</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The Collection, Map or array of objects used to generate the inner <span class="emphasis"><em>option</em></span> tags</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>itemValue</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the property mapped to <span class="emphasis"><em>value</em></span> attribute of the <span class="emphasis"><em>option</em></span> tag</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.11&nbsp;the password tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.password"></a>36.11&nbsp;the password tag</h2></div></div></div>

<p>Renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>password</em></span> using the bound value.</p>
<div class="table"><a name="spring-form.tld.password.table"></a><p class="title"><b>Table&nbsp;36.10.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>accesskey</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>alt</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>autocomplete</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Common Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>maxlength</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onblur</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onchange</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onfocus</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onselect</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to property for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>readonly</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will make the HTML element readonly.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>showPassword</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Is the password value to be shown? Defaults to false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.12&nbsp;the radiobutton tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.radiobutton"></a>36.12&nbsp;the radiobutton tag</h2></div></div></div>

<p>Renders an HTML <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>radio</em></span>.</p>
<div class="table"><a name="spring-form.tld.radiobutton.table"></a><p class="title"><b>Table&nbsp;36.11.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>accesskey</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>label</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Value to be displayed as part of the tag</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onblur</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onchange</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onfocus</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to property for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>value</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Optional Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.13&nbsp;the radiobuttons tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.radiobuttons"></a>36.13&nbsp;the radiobuttons tag</h2></div></div></div>

<p>Renders multiple HTML <span class="emphasis"><em>input</em></span> tags with type <span class="emphasis"><em>radio</em></span>.</p>
<div class="table"><a name="spring-form.tld.radiobuttons.table"></a><p class="title"><b>Table&nbsp;36.12.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>accesskey</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>delimiter</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Delimiter to use between each <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>radio</em></span>. There is no delimiter by
  default.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>element</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies the HTML element that is used to enclose each <span class="emphasis"><em>input</em></span> tag with type <span class="emphasis"><em>radio</em></span>.
  Defaults to <span class="emphasis"><em>span</em></span>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>itemLabel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Value to be displayed as part of the <span class="emphasis"><em>input</em></span> tags with type <span class="emphasis"><em>radio</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>items</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The Collection, Map or array of objects used to generate the <span class="emphasis"><em>input</em></span> tags with type
  <span class="emphasis"><em>radio</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>itemValue</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the property mapped to <span class="emphasis"><em>value</em></span> attribute of the <span class="emphasis"><em>input</em></span> tags with type <span class="emphasis"><em>radio</em></span></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onblur</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onchange</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onfocus</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to property for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.14&nbsp;the select tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.select"></a>36.14&nbsp;the select tag</h2></div></div></div>

<p>Renders an HTML <span class="emphasis"><em>select</em></span> element. Supports databinding to the selected option.</p>
<div class="table"><a name="spring-form.tld.select.table"></a><p class="title"><b>Table&nbsp;36.13.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>accesskey</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>itemLabel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the property mapped to the inner text of the <span class="emphasis"><em>option</em></span> tag</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>items</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The Collection, Map or array of objects used to generate the inner <span class="emphasis"><em>option</em></span> tags</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>itemValue</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Name of the property mapped to <span class="emphasis"><em>value</em></span> attribute of the <span class="emphasis"><em>option</em></span> tag</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>multiple</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onblur</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onchange</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onfocus</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to property for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
<div class="section" title="36.15&nbsp;the textarea tag"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-form.tld.textarea"></a>36.15&nbsp;the textarea tag</h2></div></div></div>

<p>Renders an HTML <span class="emphasis"><em>textarea</em></span>.</p>
<div class="table"><a name="spring-form.tld.textarea.table"></a><p class="title"><b>Table&nbsp;36.14.&nbsp;Attributes</b></p><div class="table-contents">

  <table summary="Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Required?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Runtime Expression?</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>accesskey</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cols</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Required Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssErrorClass</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "class" - HTML Optional Attribute. Used when the bound field has errors.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cssStyle</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Equivalent to "style" - HTML Optional Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>dir</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>disabled</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will disable the HTML element.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>htmlEscape</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Enable/disable HTML escaping of rendered values.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lang</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onblur</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onchange</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ondblclick</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onfocus</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeydown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeypress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onkeyup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousedown</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmousemove</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseover</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onmouseup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>onselect</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Event Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>path</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Path to property for data binding</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>readonly</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Optional Attribute. Setting the value of this attribute to <span class="emphasis"><em>true</em></span> (without the
  quotes) will make the HTML element readonly.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>rows</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Required Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tabindex</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HTML Standard Attribute</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>title</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>false</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>true</p></td><td style="" align="left" valign="top"><p>HTML Standard Attribute</p></td></tr></tbody></table>
</div></div><br class="table-break">

</div>
</div>
</div>
</div></body></html>